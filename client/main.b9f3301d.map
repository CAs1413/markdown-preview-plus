{"version":3,"sources":["util.ts","mathjax-helper.ts","update-preview.ts","../src/util-common.ts","main.ts"],"names":["Object","defineProperty","exports","value","getMedia","document","querySelectorAll"],"mappings":"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","file":"main.b9f3301d.map","sourceRoot":"../src-client","sourcesContent":["export function handlePromise(promise: Promise<any>): void {\n  if (!promise) return\n  promise.catch((error: Error) => {\n    console.error(error)\n  })\n}\nimport { lstatSync, existsSync } from 'fs'\nexport function isFileSync(filePath: string) {\n  if (!existsSync(filePath)) return false\n  return lstatSync(filePath).isFile()\n}\n\nexport function resolveElement(\n  root: Element,\n  pathToToken: Array<{ tag: string; index: number }>,\n): Element | undefined {\n  let element = root\n  for (const token of pathToToken) {\n    const candidateElement: HTMLElement | null = element\n      .querySelectorAll(`:scope > ${token.tag}`)\n      .item(token.index) as HTMLElement\n    if (candidateElement) {\n      element = candidateElement\n    } else {\n      break\n    }\n  }\n\n  if (element === root) return undefined // Do not jump to the top of the preview for bad syncs\n  return element\n}\n","//\n// mathjax-helper\n//\n// This module will handle loading the MathJax environment and provide a wrapper\n// for calls to MathJax to process LaTeX equations.\n//\n\nimport path = require('path')\nimport CSON = require('season')\nimport fs = require('fs')\nimport { isFileSync } from './util'\n\nconst mjSrc = `${global.require.resolve(\n  'mathjax',\n)}?delayStartupUntil=configured`\nconst defaultRenderer: MathJaxRenderer = 'HTML-CSS'\n\n//\n// Process DOM elements for LaTeX equations with MathJax\n//\n// @param domElements An array of DOM elements to be processed by MathJax. See\n//   [element](https://developer.mozilla.org/en-US/docs/Web/API/element) for\n//   details on DOM elements.\n//\nexport async function mathProcessor(\n  domElement: Node,\n  renderer: MathJaxRenderer,\n) {\n  await loadMathJax()\n  await queueTypeset(domElement, renderer)\n}\n\n//\n// Process maths in HTML fragment with MathJax\n//\n// @param html A HTML fragment string\n// @param callback A callback method that accepts a single parameter, a HTML\n//   fragment string that is the result of html processed by MathJax\n//\nexport async function processHTMLString(element: Element) {\n  await mathProcessor(element, 'SVG')\n\n  const msvgh = document.getElementById('MathJax_SVG_Hidden')\n  const svgGlyphs = msvgh && msvgh.parentNode!.cloneNode(true)\n  if (svgGlyphs !== null) {\n    element.insertBefore(svgGlyphs, element.firstChild)\n  }\n  return element.innerHTML\n}\n\n//\n// Load MathJax environment\n//\n// @param listener method to call when the MathJax script was been\n//   loaded to the window. The method is passed no arguments.\n//\nlet mjPromise: Promise<void> | undefined\nasync function loadMathJax(): Promise<void> {\n  if (mjPromise) return mjPromise\n  mjPromise = attachMathJax()\n  return mjPromise\n}\n\n// for testing\nexport function unloadMathJax(): void {\n  mjPromise = undefined\n  const script = document.head.querySelector(`script[src='${mjSrc}']`)\n  if (script) script.remove()\n}\n\n// private\n\nasync function getUserMacrosPath(): Promise<string> {\n  const home = await window.atomVars.home\n  const userMacrosPath: string | undefined | null = CSON.resolve(\n    path.join(home, 'markdown-preview-plus'),\n  )\n  return userMacrosPath != null\n    ? userMacrosPath\n    : path.join(home, 'markdown-preview-plus.cson')\n}\n\nfunction loadMacrosFile(filePath: string): object {\n  if (!CSON.isObjectPath(filePath)) {\n    return {}\n  }\n  return CSON.readFileSync(filePath, function(error?: Error, object?: object) {\n    if (object === undefined) {\n      object = {}\n    }\n    if (error !== undefined) {\n      console.warn(\n        `Error reading Latex Macros file '${filePath}': ${\n          error.stack !== undefined ? error.stack : error\n        }`,\n      )\n      console.error(`Failed to load Latex Macros from '${filePath}'`, {\n        detail: error.message,\n        dismissable: true,\n      })\n    }\n    return object\n  })\n}\n\nasync function loadUserMacros() {\n  const userMacrosPath = await getUserMacrosPath()\n  if (isFileSync(userMacrosPath)) {\n    return loadMacrosFile(userMacrosPath)\n  } else {\n    console.debug(\n      'Creating markdown-preview-plus.cson, this is a one-time operation.',\n    )\n    createMacrosTemplate(userMacrosPath)\n    return loadMacrosFile(userMacrosPath)\n  }\n}\n\nfunction createMacrosTemplate(filePath: string) {\n  const templatePath = path.join(__dirname, '../assets/macros-template.cson')\n  const templateFile = fs.readFileSync(templatePath, 'utf8')\n  fs.writeFileSync(filePath, templateFile)\n}\n\nfunction checkMacros(macrosObject: object) {\n  const namePattern = /^[^a-zA-Z\\d\\s]$|^[a-zA-Z]*$/ // letters, but no numerals.\n  for (const name in macrosObject) {\n    const value = macrosObject[name]\n    if (!name.match(namePattern) || !valueMatchesPattern(value)) {\n      delete macrosObject[name]\n      console.error(\n        `Failed to load LaTeX macro named '${name}'. Please see the [LaTeX guide](https://github.com/atom-community/markdown-preview-plus/blob/master/docs/math.md#macro-names)`,\n      )\n    }\n  }\n  return macrosObject\n}\n\nfunction valueMatchesPattern(value: any) {\n  // Different check based on whether value is string or array\n  if (Array.isArray(value)) {\n    const macroDefinition = value[0]\n    const numberOfArgs = value[1]\n    if (typeof numberOfArgs === 'number') {\n      return numberOfArgs % 1 === 0 && typeof macroDefinition === 'string'\n    } else {\n      return false\n    }\n  } else if (typeof value === 'string') {\n    return true\n  } else {\n    return false\n  }\n}\n\n// Configure MathJax environment. Similar to the TeX-AMS_HTML configuration with\n// a few unnecessary features stripped away\n//\nasync function configureMathJax() {\n  let userMacros = await loadUserMacros()\n  if (userMacros) {\n    userMacros = checkMacros(userMacros)\n  } else {\n    userMacros = {}\n  }\n\n  jaxConfigure(userMacros, await window.atomVars.numberEqns)\n\n  // Notify user MathJax has loaded\n  console.log('Loaded maths rendering engine MathJax')\n}\n\n//\n// Attach main MathJax script to the document\n//\nasync function attachMathJax(): Promise<void> {\n  console.log('Loading maths rendering engine MathJax')\n\n  // Attach MathJax script\n  await Promise.all([injectScript(mjSrc)])\n  await configureMathJax()\n}\n\nexport async function injectScript(scriptSrc: string) {\n  const script = document.createElement('script')\n  script.src = scriptSrc\n  script.type = 'text/javascript'\n  document.head.appendChild(script)\n  return new Promise<void>((resolve) => {\n    script.addEventListener('load', () => resolve())\n  })\n}\n\nfunction jaxConfigure(userMacros: object, numberEqns: boolean) {\n  MathJax.Hub.Config({\n    jax: ['input/TeX', `output/${defaultRenderer}`],\n    extensions: [],\n    TeX: {\n      extensions: [\n        'AMSmath.js',\n        'AMSsymbols.js',\n        'noErrors.js',\n        'noUndefined.js',\n      ],\n      Macros: userMacros,\n      equationNumbers: numberEqns\n        ? {\n            autoNumber: 'AMS',\n            useLabelIds: false,\n          }\n        : {},\n    },\n    'HTML-CSS': {\n      availableFonts: [],\n      webFont: 'TeX',\n    },\n    messageStyle: 'none',\n    showMathMenu: false,\n    skipStartupTypeset: true,\n  })\n  MathJax.Hub.Configured()\n}\n\nasync function queueTypeset(domElement: Node, renderer: MathJaxRenderer) {\n  const hasUnprocessedMath = Array.from(\n    document.querySelectorAll('script[type^=\"math/tex\"]'),\n  ).some((x) => !x.id)\n  if (!hasUnprocessedMath) return\n  const numberEqns = await window.atomVars.numberEqns\n  return new Promise<void>((resolve) => {\n    if (MathJax.InputJax.TeX) {\n      MathJax.Hub.Queue(['resetEquationNumbers', MathJax.InputJax.TeX])\n      if (numberEqns) {\n        MathJax.Hub.Queue(['PreProcess', MathJax.Hub])\n        MathJax.Hub.Queue(['Reprocess', MathJax.Hub])\n      }\n    }\n\n    MathJax.Hub.Queue(['setRenderer', MathJax.Hub, renderer])\n    MathJax.Hub.Queue(['Typeset', MathJax.Hub, domElement])\n    MathJax.Hub.Queue(['setRenderer', MathJax.Hub, defaultRenderer])\n    MathJax.Hub.Queue([resolve])\n  })\n}\n","// This file incorporates code from [markmon](https://github.com/yyjhao/markmon)\n// covered by the following terms:\n//\n// Copyright (c) 2014, Yao Yujian, http://yjyao.com\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\nimport morph = require('morphdom')\nimport MathJaxHelper = require('./mathjax-helper')\nimport { handlePromise } from './util'\n\nexport class UpdatePreview {\n  private cachedMJRenderer?: MathJaxRenderer\n  constructor(private dom: HTMLElement) {\n    /* no-op */\n  }\n\n  public update(\n    domFragment: DocumentFragment,\n    renderLaTeX: boolean,\n    mjrenderer: MathJaxRenderer,\n  ) {\n    const lastMJRenderer = this.cachedMJRenderer\n    this.cachedMJRenderer = mjrenderer\n    const newDom = domFragment.cloneNode(true) as DocumentFragment\n\n    for (const m of Array.from(newDom.querySelectorAll('span.math'))) {\n      const mscr = m.firstElementChild as HTMLScriptElement | null\n      if (!mscr || mscr.nodeName !== 'SCRIPT') continue\n      m.isSameNode = function(target: Node) {\n        if (lastMJRenderer !== mjrenderer) return false\n        if (target.nodeName !== 'SPAN') return false\n        const el = target as HTMLSpanElement\n        if (!el.classList.contains('math')) return false\n        const scr = el.querySelector('script')\n        if (!scr) return false\n        return mscr.innerHTML === scr.innerHTML\n      }\n    }\n\n    morph(this.dom, newDom, { childrenOnly: true })\n    if (renderLaTeX) {\n      handlePromise(MathJaxHelper.mathProcessor(this.dom, mjrenderer))\n    }\n  }\n}\n","\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nfunction getMedia(document) {\n    return document.querySelectorAll('img[src],audio[src],video[src]');\n}\nexports.getMedia = getMedia;\n//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbC1jb21tb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdXRpbC1jb21tb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxrQkFBeUIsUUFBc0I7SUFDN0MsT0FBTyxRQUFRLENBQUMsZ0JBQWdCLENBQzlCLGdDQUFnQyxDQUNxQyxDQUFBO0FBQ3pFLENBQUM7QUFKRCw0QkFJQyIsInNvdXJjZXNDb250ZW50IjpbImV4cG9ydCBmdW5jdGlvbiBnZXRNZWRpYShkb2N1bWVudDogSFRNTERvY3VtZW50KSB7XG4gIHJldHVybiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKFxuICAgICdpbWdbc3JjXSxhdWRpb1tzcmNdLHZpZGVvW3NyY10nLFxuICApIGFzIE5vZGVMaXN0T2Y8SFRNTEltYWdlRWxlbWVudCB8IEhUTUxBdWRpb0VsZW1lbnQgfCBIVE1MVmlkZW9FbGVtZW50PlxufVxuIl19","import { ipcRenderer } from 'electron'\nimport { UpdatePreview } from './update-preview'\nimport { processHTMLString } from './mathjax-helper'\nimport * as util from './util'\nimport { getMedia } from '../src/util-common'\n\nfunction mkResPromise<T>(): ResolvablePromise<T> {\n  let resFn: (value?: T | PromiseLike<T> | undefined) => void\n  const p = new Promise<T>((resolve) => (resFn = resolve)) as ResolvablePromise<\n    T\n  >\n  p.resolve = resFn!\n  return p\n}\n\nwindow.atomVars = {\n  home: mkResPromise(),\n  numberEqns: mkResPromise(),\n  sourceLineMap: new Map(),\n  revSourceMap: new WeakMap(),\n}\n\nipcRenderer.on<'set-atom-home'>('set-atom-home', (_evt, { home }) => {\n  window.atomVars.home.resolve(home)\n})\n\nipcRenderer.on<'set-number-eqns'>('set-number-eqns', (_evt, { numberEqns }) => {\n  window.atomVars.numberEqns.resolve(numberEqns)\n})\n\nipcRenderer.on<'set-source-map'>('set-source-map', (_evt, { map }) => {\n  const root = document.querySelector('div.update-preview')\n  if (!root) throw new Error('No root element!')\n  const slsm = new Map<number, Element>()\n  const rsm = new WeakMap<Element, number[]>()\n  for (const lineS of Object.keys(map)) {\n    const line = parseInt(lineS, 10)\n    const path = map[line]\n    const elem = util.resolveElement(root, path)\n    if (elem) {\n      slsm.set(line, elem)\n      const rsmel = rsm.get(elem)\n      if (rsmel) rsmel.push(line)\n      else rsm.set(elem, [line])\n    }\n  }\n  window.atomVars.sourceLineMap = slsm\n  window.atomVars.revSourceMap = rsm\n})\n\nipcRenderer.on<'scroll-sync'>(\n  'scroll-sync',\n  (_evt, { firstLine, lastLine }) => {\n    const mean = Math.floor(0.5 * (firstLine + lastLine))\n    const slm = window.atomVars.sourceLineMap\n    let topLine\n    let topBound\n    for (topLine = mean; topLine >= 0; topLine -= 1) {\n      topBound = slm.get(topLine)\n      if (topBound) break\n    }\n    if (!topBound) return\n\n    const max = Math.max(...Array.from(slm.keys()))\n    let bottomLine\n    let bottomBound\n    for (bottomLine = mean + 1; bottomLine < max; bottomLine += 1) {\n      bottomBound = slm.get(bottomLine)\n      if (bottomBound) break\n    }\n    if (!bottomBound) return\n    const topScroll = topBound.getBoundingClientRect().top\n    const bottomScroll = bottomBound.getBoundingClientRect().top\n    const frac = (mean - firstLine) / (lastLine - firstLine)\n    const offset = document.documentElement.scrollTop\n    const clientHeight = document.documentElement.clientHeight\n    const top =\n      offset - clientHeight / 2 + topScroll + frac * (bottomScroll - topScroll)\n    window.scroll({ top })\n  },\n)\n\nipcRenderer.on<'style'>('style', (_event, { styles }) => {\n  let styleElem = document.head.querySelector('style#atom-styles')\n  if (!styleElem) {\n    styleElem = document.createElement('style')\n    styleElem.id = 'atom-styles'\n    document.head.appendChild(styleElem)\n  }\n  styleElem.innerHTML = styles.join('\\n')\n})\n\nipcRenderer.on<'update-images'>('update-images', (_event, { oldsrc, v }) => {\n  const imgs = getMedia(document)\n  for (const img of Array.from(imgs)) {\n    let ovs: string | undefined\n    let ov: number | undefined\n    let src = img.getAttribute('src')!\n    const match = src.match(/^(.*)\\?v=(\\d+)$/)\n    if (match) [, src, ovs] = match\n    if (src === oldsrc) {\n      if (ovs !== undefined) ov = parseInt(ovs, 10)\n      if (v !== ov) img.src = v ? `${src}?v=${v}` : `${src}`\n    }\n  }\n})\n\nipcRenderer.on<'sync'>('sync', (_event, { line }) => {\n  const root = document.querySelector('div.update-preview')\n  if (!root) return\n\n  let element = window.atomVars.sourceLineMap.get(line)\n\n  if (!element) {\n    for (let i = line - 1; i >= 0; i -= 1) {\n      element = window.atomVars.sourceLineMap.get(line)\n      if (element) break\n    }\n  }\n\n  if (!element) return\n\n  element.scrollIntoViewIfNeeded(true)\n\n  element.classList.add('flash')\n  setTimeout(() => element!.classList.remove('flash'), 1000)\n})\n\nipcRenderer.on<'use-github-style'>('use-github-style', (_event, { value }) => {\n  const elem = document.querySelector('markdown-preview-plus-view')\n  if (!elem) throw new Error(`Can't find MPP-view`)\n  if (value) {\n    elem.setAttribute('data-use-github-style', '')\n  } else {\n    elem.removeAttribute('data-use-github-style')\n  }\n})\n\nlet updatePreview: UpdatePreview | undefined\n\nipcRenderer.on<'update-preview'>(\n  'update-preview',\n  (_event, { html, renderLaTeX, mjrenderer }) => {\n    // div.update-preview created after constructor st UpdatePreview cannot\n    // be instanced in the constructor\n    const preview = document.querySelector('div.update-preview')\n    if (!preview) return\n    if (!updatePreview) {\n      updatePreview = new UpdatePreview(preview as HTMLElement)\n    }\n    const parser = new DOMParser()\n    const domDocument = parser.parseFromString(html, 'text/html')\n    const domFragment = document.createDocumentFragment()\n    for (const elem of Array.from(domDocument.body.childNodes)) {\n      domFragment.appendChild(elem)\n    }\n    updatePreview.update(domFragment, renderLaTeX, mjrenderer)\n    const doc = document\n    if (doc && domDocument.head.hasChildNodes) {\n      let container = doc.head.querySelector('original-elements')\n      if (!container) {\n        container = doc.createElement('original-elements')\n        doc.head.appendChild(container)\n      }\n      container.innerHTML = ''\n      for (const headElement of Array.from(domDocument.head.childNodes)) {\n        container.appendChild(headElement.cloneNode(true))\n      }\n    }\n  },\n)\n\nconst baseElement = document.createElement('base')\ndocument.head.appendChild(baseElement)\n\nipcRenderer.on<'set-base-path'>('set-base-path', (_evt, { path }) => {\n  if (path) baseElement.href = path\n  else baseElement.href = ''\n})\n\nipcRenderer.on<'error'>('error', (_evt, { msg }) => {\n  const preview = document.querySelector('div.update-preview')\n  if (!preview) return\n  const errorDiv = document.createElement('div')\n  errorDiv.innerHTML = `<h2>Previewing Markdown Failed</h2><h3>${msg}</h3>`\n  preview.appendChild(errorDiv)\n})\n\ndocument.addEventListener('mousewheel', (event) => {\n  if (event.ctrlKey) {\n    if (event.wheelDeltaY > 0) {\n      ipcRenderer.sendToHost<'zoom-in'>('zoom-in', undefined)\n    } else if (event.wheelDeltaY < 0) {\n      ipcRenderer.sendToHost<'zoom-out'>('zoom-out', undefined)\n    }\n    event.preventDefault()\n    event.stopPropagation()\n  }\n})\n\ndocument.addEventListener('scroll', (_event) => {\n  const el = document.documentElement\n  const height = el.clientHeight\n  const visible = Array.from(window.atomVars.sourceLineMap.entries())\n    .filter(([_line, elem]) => {\n      const { top, bottom } = elem.getBoundingClientRect()\n      return top > 0 && bottom < height\n    })\n    .map(([line, _elem]) => line)\n  ipcRenderer.sendToHost<'did-scroll-preview'>('did-scroll-preview', {\n    max: Math.max(...visible),\n    min: Math.min(...visible),\n  })\n})\n\nlet lastContextMenuTarget: HTMLElement\ndocument.addEventListener('contextmenu', (e) => {\n  lastContextMenuTarget = e.target as HTMLElement\n})\n\nipcRenderer.on<'sync-source'>('sync-source', () => {\n  let element = lastContextMenuTarget\n  const rsm = window.atomVars.revSourceMap\n  let lines = rsm.get(element)\n\n  while (!lines && element.parentElement) {\n    element = element.parentElement\n    lines = rsm.get(element)\n  }\n  if (!lines) return\n\n  ipcRenderer.sendToHost<'open-source'>('open-source', {\n    initialLine: Math.min(...lines),\n  })\n})\n\nipcRenderer.on<'get-html-svg'>('get-html-svg', async () => {\n  const el = document.querySelector('markdown-preview-plus-view > div')\n  if (!el) {\n    ipcRenderer.sendToHost<'html-svg-result'>('html-svg-result', undefined)\n    return\n  }\n  const res = await processHTMLString(el)\n  ipcRenderer.sendToHost<'html-svg-result'>('html-svg-result', res)\n})\n\nlet allowNavigate = false\n\nipcRenderer.on<'reload'>('reload', () => {\n  allowNavigate = true\n  ipcRenderer.sendToHost<'reload'>('reload', undefined)\n})\n\nwindow.addEventListener('beforeunload', function() {\n  return allowNavigate\n})\n"]}