{"version":3,"sources":["util.ts","mathjax-stub.ts","mathjax-helper.ts","update-preview.ts","main.ts"],"names":[],"mappings":"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3FA,AFMA,IFqFA,GErFA,MFqFA,EErFA,CFqFA,GI3FA,EFMA,CAAA,GFqFA,EI3FA,CHmB0B,iBGnB1B,CAAA;AACA,AFMA,ADNuB,IGAvB,AFMA,KDNI,ECMJ,QAAA,IENA,IFMA,CAAA,GENA,kBAAA,CAAA;AACA,AFMA,ADaI,IGnBJ,AFMA,KAAA,EENA,KHmBY,CCbZ,EDaI,CAAY,CCbhB,CAAA,EENA,MHmBI,EGnBJ,QAAA,CAAA,CAAA;AAEA,AFKA,ADaG,ICbH,CDV2B,MGK3B,EFKA,QAAA,CELA,CAAY,EAAZ,CAAwB,GFKxB,CAAA,GELA,EAAiC,UAAC,MAAD,EAAS,EAAT,EAAmB;AFQpD,ADYQ,ICZJ,IERwC,SAAA,CHoBxB,EGpBwB,IFQpB,KAAxB,WDYqB,WAAD,EAAoB;AGnBtC,AFQF,IAAM,IERA,IFQW,OAAO,CERN,MFQD,CAAe,EERL,IAAT,CAAc,AFQf,CACf,SADe,GERC,CAA4B,AFU7C,mBEViB,CAAhB,WFQF;AEPE,AFWF,QEXM,CAAC,SAAL,EAAgB;AACd,AFWJ,ADOI,oBGlBY,QHkBA,CGlBS,MHkBrB,CAAoB,MGlBR,CAAuB,GHkBd,IGlBT,AHkBQ,CGlBpB,CHkByB;AGjBzB,AFWJ,ADOM,kBGlBQ,EAAV,GAAe,KHkBL,GAAR,CAAY,IGlBd,CHkBE,CAAkB,CAAC,SAAD,EAAY,QAAQ,GAApB,EAAyB,IAAzB,CAAlB;AGjBF,AFWJ,ADOK,iBGlBQ,AHgBT,IGhBA,CAAc,WAAd,CAA0B,SAA1B;AACD,AFWH,ADOI,uBAAA,CAAA,CAAA,CAAA,UAAA,EAAO,IAAI,OAAJ,CAAY,UAAC,OAAD,EAAQ;AGjB7B,AFWF,ADOM,cGlBM,SAAV,GAAsB,EHkBV,GAAR,CAAY,CGlBa,IAAP,AHkBlB,CGlB8B,AHkBZ,CAAC,GGlBD,CAAtB,GHkBsB,CAAlB;AGjBL,AFWD,ADOK,CG1BL,gBHwBW,CAAP,CAAA;AGdJ,AFUA,SAAA,EEVA,WAAA,AFUA,CEVY,AFWV,EEXF,CAAgC,QFUhC,EAEE,KEZF,EAAiD,CFUjD,EAE2B,OEZuB,MAAD,EAAS,EAAT,EAAsB;QAAX,SAAA,GAAA;AHi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","file":"main.b9f3301d.map","sourcesContent":["export function handlePromise(promise: Promise<any>): void {\n  if (!promise) return\n  promise.catch((error: Error) => {\n    console.error(error)\n  })\n}\nimport { lstatSync, existsSync } from 'fs'\nexport function isFileSync(filePath: string) {\n  if (!existsSync(filePath)) return false\n  return lstatSync(filePath).isFile()\n}\n\nexport function isElement(node: Node): node is Element {\n  return node.nodeType === Node.ELEMENT_NODE\n}\n\n//\n// Determine path to a target element from a container `markdown-preview-plus-view`.\n//\n// @param {HTMLElement} element Target HTMLElement.\n// @return {(tag: <tag>, index: <index>)[]} Array of tokens representing a path\n//   to `element` from `markdown-preview-plus-view`. The root `markdown-preview-plus-view`\n//   element is the first elements in the array and the target element\n//   `element` at the highest index. Each element consists of a `tag` and\n//   `index` representing its index amongst its sibling elements of the same\n//   `tag`.\n//\nexport function getPathToElement(\n  element: HTMLElement,\n): Array<{ tag: string; index: number }> {\n  if (element.tagName.toLowerCase() === 'markdown-preview-plus-view') {\n    return [\n      {\n        tag: 'div',\n        index: 0,\n      },\n    ]\n  }\n\n  element = bubbleToContainerElement(element)\n  const tag = encodeTag(element)\n  const siblings = element.parentElement!.children\n  let siblingsCount = 0\n\n  for (const sibling of Array.from(siblings)) {\n    const siblingTag =\n      sibling.nodeType === 1 ? encodeTag(sibling as HTMLElement) : null\n    if (sibling === element) {\n      const pathToElement = getPathToElement(element.parentElement!)\n      pathToElement.push({\n        tag,\n        index: siblingsCount,\n      })\n      return pathToElement\n    } else if (siblingTag === tag) {\n      siblingsCount++\n    }\n  }\n  throw new Error('failure in getPathToElement')\n}\n\n//\n// Find the closest ancestor of an element that is not a decendant of either\n// `span.math` or `span.atom-text-editor`.\n//\n// @param {HTMLElement} element The element from which the search for a\n//   closest ancestor begins.\n// @return {HTMLElement} The closest ancestor to `element` that does not\n//   contain either `span.math` or `span.atom-text-editor`.\n//\nexport function bubbleToContainerElement(element: HTMLElement): HTMLElement {\n  let testElement = element\n  for (;;) {\n    const parent = testElement.parentElement\n    if (!parent) break\n    if (parent.classList.contains('MathJax_Display')) {\n      return parent.parentElement!\n    }\n    if (parent.classList.contains('atom-text-editor')) {\n      return parent\n    }\n    testElement = parent\n  }\n  return element\n}\n\n//\n// Encode tags for markdown-it.\n//\n// @param {HTMLElement} element Encode the tag of element.\n// @return {string} Encoded tag.\n//\nexport function encodeTag(element: HTMLElement): string {\n  if (element.classList.contains('math')) {\n    return 'math'\n  }\n  if (element.classList.contains('atom-text-editor')) {\n    return 'code'\n  } // only token.type is `fence` code blocks should ever be found in the first level of the tokens array\n  return element.tagName.toLowerCase()\n}\n","export const mathJaxStub = {\n  jaxConfigure(userMacros: object, renderer: MathJaxRenderer) {\n    MathJax.Hub.Config({\n      jax: ['input/TeX', `output/${renderer}`],\n      extensions: [],\n      TeX: {\n        extensions: [\n          'AMSmath.js',\n          'AMSsymbols.js',\n          'noErrors.js',\n          'noUndefined.js',\n        ],\n        Macros: userMacros,\n      },\n      'HTML-CSS': {\n        availableFonts: [],\n        webFont: 'TeX',\n      },\n      messageStyle: 'none',\n      showMathMenu: false,\n      skipStartupTypeset: true,\n    })\n    MathJax.Hub.Configured()\n  },\n\n  async queueTypeset(domElements: Node[]) {\n    domElements.forEach((elem) => {\n      MathJax.Hub.Queue(['Typeset', MathJax.Hub, elem])\n    })\n    return new Promise((resolve) => {\n      MathJax.Hub.Queue([resolve])\n    })\n  },\n}\n\nexport type MathJaxStub = typeof mathJaxStub\n","//\n// mathjax-helper\n//\n// This module will handle loading the MathJax environment and provide a wrapper\n// for calls to MathJax to process LaTeX equations.\n//\n\nimport path = require('path')\nimport CSON = require('season')\nimport fs = require('fs')\nimport { isFileSync } from './util'\nimport { MathJaxStub } from './mathjax-stub'\n\nlet isMathJaxDisabled = false\nconst mjSrc = `${global.require.resolve(\n  'mathjax',\n)}?delayStartupUntil=configured`\n\n//\n// Process DOM elements for LaTeX equations with MathJax\n//\n// @param domElements An array of DOM elements to be processed by MathJax. See\n//   [element](https://developer.mozilla.org/en-US/docs/Web/API/element) for\n//   details on DOM elements.\n//\nexport async function mathProcessor(\n  domElements: Node[],\n  renderer: MathJaxRenderer,\n) {\n  if (isMathJaxDisabled) return\n  const jax = await loadMathJax(renderer)\n  await jax.queueTypeset(domElements)\n}\n\n//\n// Process maths in HTML fragment with MathJax\n//\n// @param html A HTML fragment string\n// @param callback A callback method that accepts a single parameter, a HTML\n//   fragment string that is the result of html processed by MathJax\n//\nexport async function processHTMLString(element: Element) {\n  if (isMathJaxDisabled) {\n    return element.innerHTML\n  }\n  const jax = await loadMathJax('SVG')\n  await jax.queueTypeset([element])\n\n  const msvgh = document.getElementById('MathJax_SVG_Hidden')\n  const svgGlyphs = msvgh && msvgh.parentNode!.cloneNode(true)\n  if (svgGlyphs !== null) {\n    element.insertBefore(svgGlyphs, element.firstChild)\n  }\n  return element.innerHTML\n}\n\n// For testing\nfunction disableMathJax(disable: boolean) {\n  isMathJaxDisabled = disable\n}\n\n//\n// Load MathJax environment\n//\n// @param listener method to call when the MathJax script was been\n//   loaded to the window. The method is passed no arguments.\n//\nlet mjPromise: Promise<MathJaxStub> | undefined\nasync function loadMathJax(renderer: MathJaxRenderer): Promise<MathJaxStub> {\n  if (mjPromise) return mjPromise\n  mjPromise = attachMathJax(renderer)\n  return mjPromise\n}\n\nfunction unloadMathJax(): void {\n  mjPromise = undefined\n  const script = document.head.querySelector(`script[src='${mjSrc}']`)\n  if (script) script.remove()\n}\n\nexport const testing = {\n  loadMathJax,\n  disableMathJax,\n  unloadMathJax,\n}\n\n// private\n\nasync function getUserMacrosPath(): Promise<string> {\n  const home = await window.atomHome\n  const userMacrosPath: string | undefined | null = CSON.resolve(\n    path.join(home, 'markdown-preview-plus'),\n  )\n  return userMacrosPath != null\n    ? userMacrosPath\n    : path.join(home, 'markdown-preview-plus.cson')\n}\n\nfunction loadMacrosFile(filePath: string): object {\n  if (!CSON.isObjectPath(filePath)) {\n    return {}\n  }\n  return CSON.readFileSync(filePath, function(error?: Error, object?: object) {\n    if (object === undefined) {\n      object = {}\n    }\n    if (error !== undefined) {\n      console.warn(\n        `Error reading Latex Macros file '${filePath}': ${\n          error.stack !== undefined ? error.stack : error\n        }`,\n      )\n      console.error(`Failed to load Latex Macros from '${filePath}'`, {\n        detail: error.message,\n        dismissable: true,\n      })\n    }\n    return object\n  })\n}\n\nasync function loadUserMacros() {\n  const userMacrosPath = await getUserMacrosPath()\n  if (isFileSync(userMacrosPath)) {\n    return loadMacrosFile(userMacrosPath)\n  } else {\n    console.debug(\n      'Creating markdown-preview-plus.cson, this is a one-time operation.',\n    )\n    createMacrosTemplate(userMacrosPath)\n    return loadMacrosFile(userMacrosPath)\n  }\n}\n\nfunction createMacrosTemplate(filePath: string) {\n  const templatePath = path.join(__dirname, '../assets/macros-template.cson')\n  const templateFile = fs.readFileSync(templatePath, 'utf8')\n  fs.writeFileSync(filePath, templateFile)\n}\n\nfunction checkMacros(macrosObject: object) {\n  const namePattern = /^[^a-zA-Z\\d\\s]$|^[a-zA-Z]*$/ // letters, but no numerals.\n  for (const name in macrosObject) {\n    const value = macrosObject[name]\n    if (!name.match(namePattern) || !valueMatchesPattern(value)) {\n      delete macrosObject[name]\n      console.error(\n        `Failed to load LaTeX macro named '${name}'. Please see the [LaTeX guide](https://github.com/atom-community/markdown-preview-plus/blob/master/docs/math.md#macro-names)`,\n      )\n    }\n  }\n  return macrosObject\n}\n\nfunction valueMatchesPattern(value: any) {\n  // Different check based on whether value is string or array\n  if (Array.isArray(value)) {\n    const macroDefinition = value[0]\n    const numberOfArgs = value[1]\n    if (typeof numberOfArgs === 'number') {\n      return numberOfArgs % 1 === 0 && typeof macroDefinition === 'string'\n    } else {\n      return false\n    }\n  } else if (typeof value === 'string') {\n    return true\n  } else {\n    return false\n  }\n}\n\n// Configure MathJax environment. Similar to the TeX-AMS_HTML configuration with\n// a few unnecessary features stripped away\n//\nasync function configureMathJax(jax: MathJaxStub, renderer: MathJaxRenderer) {\n  let userMacros = await loadUserMacros()\n  if (userMacros) {\n    userMacros = checkMacros(userMacros)\n  } else {\n    userMacros = {}\n  }\n\n  jax.jaxConfigure(userMacros, renderer)\n\n  // Notify user MathJax has loaded\n  console.log('Loaded maths rendering engine MathJax')\n}\n\n//\n// Attach main MathJax script to the document\n//\nasync function attachMathJax(renderer: MathJaxRenderer): Promise<MathJaxStub> {\n  console.log('Loading maths rendering engine MathJax')\n\n  // Attach MathJax script\n  await Promise.all([injectScript(mjSrc)])\n  const { mathJaxStub } = await import('./mathjax-stub')\n  await configureMathJax(mathJaxStub, renderer)\n  return mathJaxStub\n}\n\nexport async function injectScript(scriptSrc: string) {\n  const script = document.createElement('script')\n  script.src = scriptSrc\n  script.type = 'text/javascript'\n  document.head.appendChild(script)\n  return new Promise<void>((resolve) => {\n    script.addEventListener('load', () => resolve())\n  })\n}\n","// This file incorporates code from [markmon](https://github.com/yyjhao/markmon)\n// covered by the following terms:\n//\n// Copyright (c) 2014, Yao Yujian, http://yjyao.com\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\nimport morph = require('morphdom')\nimport MathJaxHelper = require('./mathjax-helper')\nimport { handlePromise } from './util'\n\nexport class UpdatePreview {\n  constructor(private dom: HTMLElement) {\n    /* no-op */\n  }\n\n  public update(\n    domFragment: DocumentFragment,\n    renderLaTeX: boolean,\n    mjrenderer: MathJaxRenderer,\n  ) {\n    const newDom = domFragment.cloneNode(true) as DocumentFragment\n\n    for (const m of Array.from(newDom.querySelectorAll('span.math'))) {\n      const mscr = m.firstElementChild as HTMLScriptElement | null\n      if (!mscr || mscr.nodeName !== 'SCRIPT') continue\n      m.isSameNode = function(target: Node) {\n        if (target.nodeName !== 'SPAN') return false\n        const el = target as HTMLSpanElement\n        if (!el.classList.contains('math')) return false\n        const scr = el.querySelector('script')\n        if (!scr) return false\n        return mscr.innerHTML === scr.innerHTML\n      }\n    }\n\n    morph(this.dom, newDom, { childrenOnly: true })\n    if (renderLaTeX) {\n      handlePromise(MathJaxHelper.mathProcessor([this.dom], mjrenderer))\n    }\n  }\n}\n","import { ipcRenderer } from 'electron'\nimport { UpdatePreview } from './update-preview'\nimport { processHTMLString } from './mathjax-helper'\nimport * as util from './util'\n\nipcRenderer.on<'style'>('style', (_event, { styles }) => {\n  let styleElem = document.head.querySelector('style#atom-styles')\n  if (!styleElem) {\n    styleElem = document.createElement('style')\n    styleElem.id = 'atom-styles'\n    document.head.appendChild(styleElem)\n  }\n  styleElem.innerHTML = styles.join('\\n')\n})\n\nipcRenderer.on<'update-images'>('update-images', (_event, { oldsrc, v }) => {\n  const imgs = document.querySelectorAll('img[src]') as NodeListOf<\n    HTMLImageElement\n  >\n  for (const img of Array.from(imgs)) {\n    let ovs: string | undefined\n    let ov: number | undefined\n    let src = img.getAttribute('src')!\n    const match = src.match(/^(.*)\\?v=(\\d+)$/)\n    if (match) [, src, ovs] = match\n    if (src === oldsrc) {\n      if (ovs !== undefined) ov = parseInt(ovs, 10)\n      if (v !== ov) img.src = v ? `${src}?v=${v}` : `${src}`\n    }\n  }\n})\n\nipcRenderer.on<'sync'>('sync', (_event, { pathToToken }) => {\n  let element = document.querySelector('div.update-preview')\n  if (!element) return\n\n  for (const token of pathToToken) {\n    const candidateElement: HTMLElement | null = element\n      .querySelectorAll(`:scope > ${token.tag}`)\n      .item(token.index) as HTMLElement\n    if (candidateElement) {\n      element = candidateElement\n    } else {\n      break\n    }\n  }\n\n  if (element.classList.contains('update-preview')) {\n    return\n  } // Do not jump to the top of the preview for bad syncs\n\n  if (!element.classList.contains('update-preview')) {\n    element.scrollIntoView()\n  }\n  const maxScrollTop = document.body.scrollHeight - document.body.clientHeight\n  if (!(document.body.scrollTop >= maxScrollTop)) {\n    document.body.scrollTop -= document.body.clientHeight / 4\n  }\n\n  element.classList.add('flash')\n  setTimeout(() => element!.classList.remove('flash'), 1000)\n})\n\nipcRenderer.on<'use-github-style'>('use-github-style', (_event, { value }) => {\n  const elem = document.querySelector('markdown-preview-plus-view')\n  if (!elem) throw new Error(`Can't find MPP-view`)\n  if (value) {\n    elem.setAttribute('data-use-github-style', '')\n  } else {\n    elem.removeAttribute('data-use-github-style')\n  }\n})\n\nlet updatePreview: UpdatePreview | undefined\n\nipcRenderer.on<'update-preview'>(\n  'update-preview',\n  (_event, { html, renderLaTeX, mjrenderer }) => {\n    // div.update-preview created after constructor st UpdatePreview cannot\n    // be instanced in the constructor\n    const preview = document.querySelector('div.update-preview')\n    if (!preview) return\n    if (!updatePreview) {\n      updatePreview = new UpdatePreview(preview as HTMLElement)\n    }\n    const parser = new DOMParser()\n    const domDocument = parser.parseFromString(html, 'text/html')\n    const domFragment = document.createDocumentFragment()\n    for (const elem of Array.from(domDocument.body.childNodes)) {\n      domFragment.appendChild(elem)\n    }\n    updatePreview.update(domFragment, renderLaTeX, mjrenderer)\n    const doc = document\n    if (doc && domDocument.head.hasChildNodes) {\n      let container = doc.head.querySelector('original-elements')\n      if (!container) {\n        container = doc.createElement('original-elements')\n        doc.head.appendChild(container)\n      }\n      container.innerHTML = ''\n      for (const headElement of Array.from(domDocument.head.childNodes)) {\n        container.appendChild(headElement.cloneNode(true))\n      }\n    }\n  },\n)\n\ndeclare global {\n  interface Window {\n    atomHome: Promise<string>\n    resolveAtomHome(home: string): void\n  }\n}\n\nwindow.atomHome = new Promise((resolve) => (window.resolveAtomHome = resolve))\n\nipcRenderer.on<'set-atom-home'>('set-atom-home', (_evt, { home }) => {\n  window.resolveAtomHome(home)\n})\n\nconst baseElement = document.createElement('base')\ndocument.head.appendChild(baseElement)\n\nipcRenderer.on<'set-base-path'>('set-base-path', (_evt, { path }) => {\n  if (path) baseElement.href = path\n  else baseElement.href = ''\n})\n\nipcRenderer.on<'error'>('error', (_evt, { msg }) => {\n  const preview = document.querySelector('div.update-preview')\n  if (!preview) return\n  const errorDiv = document.createElement('div')\n  errorDiv.innerHTML = `<h2>Previewing Markdown Failed</h2><h3>${msg}</h3>`\n  preview.appendChild(errorDiv)\n})\n\ndocument.addEventListener('mousewheel', (event) => {\n  if (event.ctrlKey) {\n    if (event.wheelDeltaY > 0) {\n      ipcRenderer.sendToHost<'zoom-in'>('zoom-in', undefined)\n    } else if (event.wheelDeltaY < 0) {\n      ipcRenderer.sendToHost<'zoom-out'>('zoom-out', undefined)\n    }\n    event.preventDefault()\n    event.stopPropagation()\n  }\n})\n\nlet lastContextMenuTarget: HTMLElement\ndocument.addEventListener('contextmenu', (e) => {\n  lastContextMenuTarget = e.target as HTMLElement\n})\n\nipcRenderer.on<'sync-source'>('sync-source', (_evt: any, { tokens }) => {\n  const element = lastContextMenuTarget\n  const pathToElement = util.getPathToElement(element)\n  pathToElement.shift() // remove markdown-preview-plus-view\n  pathToElement.shift() // remove div.update-preview\n  if (!pathToElement.length) {\n    return null\n  }\n\n  let finalToken = null\n  let level = 0\n\n  for (const token of tokens) {\n    if (token.level < level) {\n      break\n    }\n    if (token.hidden) {\n      continue\n    }\n    if (token.tag === pathToElement[0].tag && token.level === level) {\n      if (token.nesting === 1) {\n        if (pathToElement[0].index === 0) {\n          // tslint:disable-next-line:strict-type-predicates // TODO: complain on DT\n          if (token.map != null) {\n            finalToken = token\n          }\n          pathToElement.shift()\n          level++\n        } else {\n          pathToElement[0].index--\n        }\n      } else if (\n        token.nesting === 0 &&\n        ['math', 'code', 'hr'].includes(token.tag)\n      ) {\n        if (pathToElement[0].index === 0) {\n          finalToken = token\n          break\n        } else {\n          pathToElement[0].index--\n        }\n      }\n    }\n    if (pathToElement.length === 0) {\n      break\n    }\n  }\n\n  if (finalToken !== null) {\n    ipcRenderer.sendToHost<'open-source'>('open-source', {\n      initialLine: finalToken.map[0],\n    })\n    return finalToken.map[0]\n  } else {\n    return null\n  }\n})\n\nipcRenderer.on<'get-html-svg'>('get-html-svg', async () => {\n  const el = document.querySelector('markdown-preview-plus-view > div')\n  if (!el) return\n  const res = await processHTMLString(el)\n  ipcRenderer.sendToHost<'html-svg-result'>('html-svg-result', res)\n})\n\nwindow.onbeforeunload = function() {\n  return false\n}\n"]}