"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const electron_1 = require("electron");
const update_preview_1 = require("./update-preview");
electron_1.ipcRenderer.on('style', (_event, style) => {
    let styleElem = document.head.querySelector('style#atom-styles');
    if (!styleElem) {
        styleElem = document.createElement('style');
        styleElem.id = 'atom-styles';
        document.head.appendChild(styleElem);
    }
    styleElem.innerHTML = style.join('\n');
});
electron_1.ipcRenderer.on('update-images', (_event, oldsrc, v) => {
    const imgs = document.querySelectorAll('img[src]');
    for (const img of Array.from(imgs)) {
        let ovs;
        let ov;
        let src = img.getAttribute('src');
        const match = src.match(/^(.*)\?v=(\d+)$/);
        if (match)
            [, src, ovs] = match;
        if (src === oldsrc) {
            if (ovs !== undefined)
                ov = parseInt(ovs, 10);
            if (v !== ov)
                img.src = v ? `${src}?v=${v}` : `${src}`;
        }
    }
});
electron_1.ipcRenderer.on('sync', (_event, pathToToken) => {
    let element = document.querySelector('div.update-preview');
    if (!element)
        return;
    for (const token of pathToToken) {
        const candidateElement = element
            .querySelectorAll(`:scope > ${token.tag}`)
            .item(token.index);
        if (candidateElement) {
            element = candidateElement;
        }
        else {
            break;
        }
    }
    if (element.classList.contains('update-preview')) {
        return;
    }
    if (!element.classList.contains('update-preview')) {
        element.scrollIntoView();
    }
    const maxScrollTop = document.body.scrollHeight - document.body.clientHeight;
    if (!(document.body.scrollTop >= maxScrollTop)) {
        document.body.scrollTop -= document.body.clientHeight / 4;
    }
    element.classList.add('flash');
    setTimeout(() => element.classList.remove('flash'), 1000);
});
electron_1.ipcRenderer.on('use-github-style', (_event, value) => {
    const elem = document.querySelector('markdown-preview-plus-view');
    if (!elem)
        throw new Error(`Can't find MPP-view`);
    if (value) {
        elem.setAttribute('data-use-github-style', '');
    }
    else {
        elem.removeAttribute('data-use-github-style');
    }
});
let updatePreview;
electron_1.ipcRenderer.on('update-preview', (_event, html, renderLaTeX, mjrenderer) => {
    const preview = document.querySelector('div.update-preview');
    if (!preview)
        return;
    if (!updatePreview) {
        updatePreview = new update_preview_1.UpdatePreview(preview);
    }
    const parser = new DOMParser();
    const domDocument = parser.parseFromString(html, 'text/html');
    const domFragment = document.createDocumentFragment();
    for (const elem of Array.from(domDocument.body.childNodes)) {
        domFragment.appendChild(elem);
    }
    updatePreview.update(document, domFragment, renderLaTeX, mjrenderer);
    const doc = document;
    if (doc && domDocument.head.hasChildNodes) {
        let container = doc.head.querySelector('original-elements');
        if (!container) {
            container = doc.createElement('original-elements');
            doc.head.appendChild(container);
        }
        container.innerHTML = '';
        for (const headElement of Array.from(domDocument.head.childNodes)) {
            container.appendChild(headElement.cloneNode(true));
        }
    }
});
electron_1.ipcRenderer.on('error', (_evt, msg) => {
    const preview = document.querySelector('div.update-preview');
    if (!preview)
        return;
    const errorDiv = document.createElement('div');
    errorDiv.innerHTML = `<h2>Previewing Markdown Failed</h2><h3>${msg}</h3>`;
    preview.appendChild(errorDiv);
});
document.addEventListener('mousewheel', (event) => {
    if (event.ctrlKey) {
        if (event.wheelDeltaY > 0) {
            electron_1.ipcRenderer.sendToHost('zoom-in');
        }
        else if (event.wheelDeltaY < 0) {
            electron_1.ipcRenderer.sendToHost('zoom-out');
        }
        event.preventDefault();
        event.stopPropagation();
    }
});
function getText() {
    const el = document.querySelector('markdown-preview-plus-view > div');
    if (!el)
        return '';
    return el.textContent;
}
exports.getText = getText;
function getHTML() {
    const el = document.querySelector('markdown-preview-plus-view > div');
    if (!el)
        return '';
    return el.innerHTML;
}
exports.getHTML = getHTML;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy1jbGllbnQvbWFpbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHVDQUFzQztBQUN0QyxxREFBZ0Q7QUFFaEQsc0JBQVcsQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsTUFBVyxFQUFFLEtBQWUsRUFBRSxFQUFFO0lBQ3ZELElBQUksU0FBUyxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLG1CQUFtQixDQUFDLENBQUE7SUFDaEUsRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO1FBQ2YsU0FBUyxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUE7UUFDM0MsU0FBUyxDQUFDLEVBQUUsR0FBRyxhQUFhLENBQUE7UUFDNUIsUUFBUSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUE7SUFDdEMsQ0FBQztJQUNELFNBQVMsQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQTtBQUN4QyxDQUFDLENBQUMsQ0FBQTtBQUVGLHNCQUFXLENBQUMsRUFBRSxDQUNaLGVBQWUsRUFDZixDQUFDLE1BQVcsRUFBRSxNQUFjLEVBQUUsQ0FBaUIsRUFBRSxFQUFFO0lBQ2pELE1BQU0sSUFBSSxHQUFHLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVLENBRWhELENBQUE7SUFDRCxHQUFHLENBQUMsQ0FBQyxNQUFNLEdBQUcsSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNuQyxJQUFJLEdBQXVCLENBQUE7UUFDM0IsSUFBSSxFQUFzQixDQUFBO1FBQzFCLElBQUksR0FBRyxHQUFHLEdBQUcsQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFFLENBQUE7UUFDbEMsTUFBTSxLQUFLLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxDQUFBO1FBQzFDLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQztZQUFDLENBQUMsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFBO1FBQy9CLEVBQUUsQ0FBQyxDQUFDLEdBQUcsS0FBSyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ25CLEVBQUUsQ0FBQyxDQUFDLEdBQUcsS0FBSyxTQUFTLENBQUM7Z0JBQUMsRUFBRSxHQUFHLFFBQVEsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUE7WUFDN0MsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztnQkFBQyxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxFQUFFLENBQUE7UUFDeEQsQ0FBQztJQUNILENBQUM7QUFDSCxDQUFDLENBQ0YsQ0FBQTtBQUVELHNCQUFXLENBQUMsRUFBRSxDQUNaLE1BQU0sRUFDTixDQUFDLE1BQVcsRUFBRSxXQUFrRCxFQUFFLEVBQUU7SUFDbEUsSUFBSSxPQUFPLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFBO0lBQzFELEVBQUUsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDO1FBQUMsTUFBTSxDQUFBO0lBRXBCLEdBQUcsQ0FBQyxDQUFDLE1BQU0sS0FBSyxJQUFJLFdBQVcsQ0FBQyxDQUFDLENBQUM7UUFDaEMsTUFBTSxnQkFBZ0IsR0FBdUIsT0FBTzthQUNqRCxnQkFBZ0IsQ0FBQyxZQUFZLEtBQUssQ0FBQyxHQUFHLEVBQUUsQ0FBQzthQUN6QyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBZ0IsQ0FBQTtRQUNuQyxFQUFFLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUM7WUFDckIsT0FBTyxHQUFHLGdCQUFnQixDQUFBO1FBQzVCLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLEtBQUssQ0FBQTtRQUNQLENBQUM7SUFDSCxDQUFDO0lBRUQsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDakQsTUFBTSxDQUFBO0lBQ1IsQ0FBQztJQUVELEVBQUUsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbEQsT0FBTyxDQUFDLGNBQWMsRUFBRSxDQUFBO0lBQzFCLENBQUM7SUFDRCxNQUFNLFlBQVksR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLFlBQVksR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQTtJQUM1RSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxTQUFTLElBQUksWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQy9DLFFBQVEsQ0FBQyxJQUFJLENBQUMsU0FBUyxJQUFJLFFBQVEsQ0FBQyxJQUFJLENBQUMsWUFBWSxHQUFHLENBQUMsQ0FBQTtJQUMzRCxDQUFDO0lBRUQsT0FBTyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUE7SUFDOUIsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDLE9BQVEsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFBO0FBQzVELENBQUMsQ0FDRixDQUFBO0FBRUQsc0JBQVcsQ0FBQyxFQUFFLENBQUMsa0JBQWtCLEVBQUUsQ0FBQyxNQUFXLEVBQUUsS0FBYyxFQUFFLEVBQUU7SUFDakUsTUFBTSxJQUFJLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyw0QkFBNEIsQ0FBQyxDQUFBO0lBQ2pFLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO1FBQUMsTUFBTSxJQUFJLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxDQUFBO0lBQ2pELEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFDVixJQUFJLENBQUMsWUFBWSxDQUFDLHVCQUF1QixFQUFFLEVBQUUsQ0FBQyxDQUFBO0lBQ2hELENBQUM7SUFBQyxJQUFJLENBQUMsQ0FBQztRQUNOLElBQUksQ0FBQyxlQUFlLENBQUMsdUJBQXVCLENBQUMsQ0FBQTtJQUMvQyxDQUFDO0FBQ0gsQ0FBQyxDQUFDLENBQUE7QUFFRixJQUFJLGFBQXdDLENBQUE7QUFFNUMsc0JBQVcsQ0FBQyxFQUFFLENBQ1osZ0JBQWdCLEVBQ2hCLENBQ0UsTUFBVyxFQUNYLElBQVksRUFDWixXQUFvQixFQUNwQixVQUEyQixFQUMzQixFQUFFO0lBR0YsTUFBTSxPQUFPLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFBO0lBQzVELEVBQUUsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDO1FBQUMsTUFBTSxDQUFBO0lBQ3BCLEVBQUUsQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztRQUNuQixhQUFhLEdBQUcsSUFBSSw4QkFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFBO0lBQzVDLENBQUM7SUFDRCxNQUFNLE1BQU0sR0FBRyxJQUFJLFNBQVMsRUFBRSxDQUFBO0lBQzlCLE1BQU0sV0FBVyxHQUFHLE1BQU0sQ0FBQyxlQUFlLENBQUMsSUFBSSxFQUFFLFdBQVcsQ0FBQyxDQUFBO0lBQzdELE1BQU0sV0FBVyxHQUFHLFFBQVEsQ0FBQyxzQkFBc0IsRUFBRSxDQUFBO0lBQ3JELEdBQUcsQ0FBQyxDQUFDLE1BQU0sSUFBSSxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDM0QsV0FBVyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUMvQixDQUFDO0lBQ0QsYUFBYSxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsV0FBVyxFQUFFLFdBQVcsRUFBRSxVQUFVLENBQUMsQ0FBQTtJQUNwRSxNQUFNLEdBQUcsR0FBRyxRQUFRLENBQUE7SUFDcEIsRUFBRSxDQUFDLENBQUMsR0FBRyxJQUFJLFdBQVcsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztRQUMxQyxJQUFJLFNBQVMsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFBO1FBQzNELEVBQUUsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztZQUNmLFNBQVMsR0FBRyxHQUFHLENBQUMsYUFBYSxDQUFDLG1CQUFtQixDQUFDLENBQUE7WUFDbEQsR0FBRyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUE7UUFDakMsQ0FBQztRQUNELFNBQVMsQ0FBQyxTQUFTLEdBQUcsRUFBRSxDQUFBO1FBQ3hCLEdBQUcsQ0FBQyxDQUFDLE1BQU0sV0FBVyxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbEUsU0FBUyxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUE7UUFDcEQsQ0FBQztJQUNILENBQUM7QUFDSCxDQUFDLENBQ0YsQ0FBQTtBQUVELHNCQUFXLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDLElBQVMsRUFBRSxHQUFXLEVBQUUsRUFBRTtJQUNqRCxNQUFNLE9BQU8sR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLG9CQUFvQixDQUFDLENBQUE7SUFDNUQsRUFBRSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUM7UUFBQyxNQUFNLENBQUE7SUFDcEIsTUFBTSxRQUFRLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQTtJQUM5QyxRQUFRLENBQUMsU0FBUyxHQUFHLDBDQUEwQyxHQUFHLE9BQU8sQ0FBQTtJQUN6RSxPQUFPLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFBO0FBQy9CLENBQUMsQ0FBQyxDQUFBO0FBRUYsUUFBUSxDQUFDLGdCQUFnQixDQUFDLFlBQVksRUFBRSxDQUFDLEtBQUssRUFBRSxFQUFFO0lBQ2hELEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1FBQ2xCLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxXQUFXLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMxQixzQkFBVyxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsQ0FBQTtRQUNuQyxDQUFDO1FBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxXQUFXLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNqQyxzQkFBVyxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsQ0FBQTtRQUNwQyxDQUFDO1FBQ0QsS0FBSyxDQUFDLGNBQWMsRUFBRSxDQUFBO1FBQ3RCLEtBQUssQ0FBQyxlQUFlLEVBQUUsQ0FBQTtJQUN6QixDQUFDO0FBQ0gsQ0FBQyxDQUFDLENBQUE7QUFFRjtJQUNFLE1BQU0sRUFBRSxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsa0NBQWtDLENBQUMsQ0FBQTtJQUNyRSxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztRQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUE7SUFDbEIsTUFBTSxDQUFDLEVBQUUsQ0FBQyxXQUFXLENBQUE7QUFDdkIsQ0FBQztBQUpELDBCQUlDO0FBRUQ7SUFDRSxNQUFNLEVBQUUsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLGtDQUFrQyxDQUFDLENBQUE7SUFDckUsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFBQyxNQUFNLENBQUMsRUFBRSxDQUFBO0lBQ2xCLE1BQU0sQ0FBQyxFQUFFLENBQUMsU0FBUyxDQUFBO0FBQ3JCLENBQUM7QUFKRCwwQkFJQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGlwY1JlbmRlcmVyIH0gZnJvbSAnZWxlY3Ryb24nXG5pbXBvcnQgeyBVcGRhdGVQcmV2aWV3IH0gZnJvbSAnLi91cGRhdGUtcHJldmlldydcblxuaXBjUmVuZGVyZXIub24oJ3N0eWxlJywgKF9ldmVudDogYW55LCBzdHlsZTogc3RyaW5nW10pID0+IHtcbiAgbGV0IHN0eWxlRWxlbSA9IGRvY3VtZW50LmhlYWQucXVlcnlTZWxlY3Rvcignc3R5bGUjYXRvbS1zdHlsZXMnKVxuICBpZiAoIXN0eWxlRWxlbSkge1xuICAgIHN0eWxlRWxlbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N0eWxlJylcbiAgICBzdHlsZUVsZW0uaWQgPSAnYXRvbS1zdHlsZXMnXG4gICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzdHlsZUVsZW0pXG4gIH1cbiAgc3R5bGVFbGVtLmlubmVySFRNTCA9IHN0eWxlLmpvaW4oJ1xcbicpXG59KVxuXG5pcGNSZW5kZXJlci5vbihcbiAgJ3VwZGF0ZS1pbWFnZXMnLFxuICAoX2V2ZW50OiBhbnksIG9sZHNyYzogc3RyaW5nLCB2OiBudW1iZXIgfCBmYWxzZSkgPT4ge1xuICAgIGNvbnN0IGltZ3MgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdpbWdbc3JjXScpIGFzIE5vZGVMaXN0T2Y8XG4gICAgICBIVE1MSW1hZ2VFbGVtZW50XG4gICAgPlxuICAgIGZvciAoY29uc3QgaW1nIG9mIEFycmF5LmZyb20oaW1ncykpIHtcbiAgICAgIGxldCBvdnM6IHN0cmluZyB8IHVuZGVmaW5lZFxuICAgICAgbGV0IG92OiBudW1iZXIgfCB1bmRlZmluZWRcbiAgICAgIGxldCBzcmMgPSBpbWcuZ2V0QXR0cmlidXRlKCdzcmMnKSFcbiAgICAgIGNvbnN0IG1hdGNoID0gc3JjLm1hdGNoKC9eKC4qKVxcP3Y9KFxcZCspJC8pXG4gICAgICBpZiAobWF0Y2gpIFssIHNyYywgb3ZzXSA9IG1hdGNoXG4gICAgICBpZiAoc3JjID09PSBvbGRzcmMpIHtcbiAgICAgICAgaWYgKG92cyAhPT0gdW5kZWZpbmVkKSBvdiA9IHBhcnNlSW50KG92cywgMTApXG4gICAgICAgIGlmICh2ICE9PSBvdikgaW1nLnNyYyA9IHYgPyBgJHtzcmN9P3Y9JHt2fWAgOiBgJHtzcmN9YFxuICAgICAgfVxuICAgIH1cbiAgfSxcbilcblxuaXBjUmVuZGVyZXIub24oXG4gICdzeW5jJyxcbiAgKF9ldmVudDogYW55LCBwYXRoVG9Ub2tlbjogQXJyYXk8eyB0YWc6IHN0cmluZzsgaW5kZXg6IG51bWJlciB9PikgPT4ge1xuICAgIGxldCBlbGVtZW50ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignZGl2LnVwZGF0ZS1wcmV2aWV3JylcbiAgICBpZiAoIWVsZW1lbnQpIHJldHVyblxuXG4gICAgZm9yIChjb25zdCB0b2tlbiBvZiBwYXRoVG9Ub2tlbikge1xuICAgICAgY29uc3QgY2FuZGlkYXRlRWxlbWVudDogSFRNTEVsZW1lbnQgfCBudWxsID0gZWxlbWVudFxuICAgICAgICAucXVlcnlTZWxlY3RvckFsbChgOnNjb3BlID4gJHt0b2tlbi50YWd9YClcbiAgICAgICAgLml0ZW0odG9rZW4uaW5kZXgpIGFzIEhUTUxFbGVtZW50XG4gICAgICBpZiAoY2FuZGlkYXRlRWxlbWVudCkge1xuICAgICAgICBlbGVtZW50ID0gY2FuZGlkYXRlRWxlbWVudFxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYnJlYWtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoZWxlbWVudC5jbGFzc0xpc3QuY29udGFpbnMoJ3VwZGF0ZS1wcmV2aWV3JykpIHtcbiAgICAgIHJldHVyblxuICAgIH0gLy8gRG8gbm90IGp1bXAgdG8gdGhlIHRvcCBvZiB0aGUgcHJldmlldyBmb3IgYmFkIHN5bmNzXG5cbiAgICBpZiAoIWVsZW1lbnQuY2xhc3NMaXN0LmNvbnRhaW5zKCd1cGRhdGUtcHJldmlldycpKSB7XG4gICAgICBlbGVtZW50LnNjcm9sbEludG9WaWV3KClcbiAgICB9XG4gICAgY29uc3QgbWF4U2Nyb2xsVG9wID0gZG9jdW1lbnQuYm9keS5zY3JvbGxIZWlnaHQgLSBkb2N1bWVudC5ib2R5LmNsaWVudEhlaWdodFxuICAgIGlmICghKGRvY3VtZW50LmJvZHkuc2Nyb2xsVG9wID49IG1heFNjcm9sbFRvcCkpIHtcbiAgICAgIGRvY3VtZW50LmJvZHkuc2Nyb2xsVG9wIC09IGRvY3VtZW50LmJvZHkuY2xpZW50SGVpZ2h0IC8gNFxuICAgIH1cblxuICAgIGVsZW1lbnQuY2xhc3NMaXN0LmFkZCgnZmxhc2gnKVxuICAgIHNldFRpbWVvdXQoKCkgPT4gZWxlbWVudCEuY2xhc3NMaXN0LnJlbW92ZSgnZmxhc2gnKSwgMTAwMClcbiAgfSxcbilcblxuaXBjUmVuZGVyZXIub24oJ3VzZS1naXRodWItc3R5bGUnLCAoX2V2ZW50OiBhbnksIHZhbHVlOiBib29sZWFuKSA9PiB7XG4gIGNvbnN0IGVsZW0gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdtYXJrZG93bi1wcmV2aWV3LXBsdXMtdmlldycpXG4gIGlmICghZWxlbSkgdGhyb3cgbmV3IEVycm9yKGBDYW4ndCBmaW5kIE1QUC12aWV3YClcbiAgaWYgKHZhbHVlKSB7XG4gICAgZWxlbS5zZXRBdHRyaWJ1dGUoJ2RhdGEtdXNlLWdpdGh1Yi1zdHlsZScsICcnKVxuICB9IGVsc2Uge1xuICAgIGVsZW0ucmVtb3ZlQXR0cmlidXRlKCdkYXRhLXVzZS1naXRodWItc3R5bGUnKVxuICB9XG59KVxuXG5sZXQgdXBkYXRlUHJldmlldzogVXBkYXRlUHJldmlldyB8IHVuZGVmaW5lZFxuXG5pcGNSZW5kZXJlci5vbihcbiAgJ3VwZGF0ZS1wcmV2aWV3JyxcbiAgKFxuICAgIF9ldmVudDogYW55LFxuICAgIGh0bWw6IHN0cmluZyxcbiAgICByZW5kZXJMYVRlWDogYm9vbGVhbixcbiAgICBtanJlbmRlcmVyOiBNYXRoSmF4UmVuZGVyZXIsXG4gICkgPT4ge1xuICAgIC8vIGRpdi51cGRhdGUtcHJldmlldyBjcmVhdGVkIGFmdGVyIGNvbnN0cnVjdG9yIHN0IFVwZGF0ZVByZXZpZXcgY2Fubm90XG4gICAgLy8gYmUgaW5zdGFuY2VkIGluIHRoZSBjb25zdHJ1Y3RvclxuICAgIGNvbnN0IHByZXZpZXcgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdkaXYudXBkYXRlLXByZXZpZXcnKVxuICAgIGlmICghcHJldmlldykgcmV0dXJuXG4gICAgaWYgKCF1cGRhdGVQcmV2aWV3KSB7XG4gICAgICB1cGRhdGVQcmV2aWV3ID0gbmV3IFVwZGF0ZVByZXZpZXcocHJldmlldylcbiAgICB9XG4gICAgY29uc3QgcGFyc2VyID0gbmV3IERPTVBhcnNlcigpXG4gICAgY29uc3QgZG9tRG9jdW1lbnQgPSBwYXJzZXIucGFyc2VGcm9tU3RyaW5nKGh0bWwsICd0ZXh0L2h0bWwnKVxuICAgIGNvbnN0IGRvbUZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpXG4gICAgZm9yIChjb25zdCBlbGVtIG9mIEFycmF5LmZyb20oZG9tRG9jdW1lbnQuYm9keS5jaGlsZE5vZGVzKSkge1xuICAgICAgZG9tRnJhZ21lbnQuYXBwZW5kQ2hpbGQoZWxlbSlcbiAgICB9XG4gICAgdXBkYXRlUHJldmlldy51cGRhdGUoZG9jdW1lbnQsIGRvbUZyYWdtZW50LCByZW5kZXJMYVRlWCwgbWpyZW5kZXJlcilcbiAgICBjb25zdCBkb2MgPSBkb2N1bWVudFxuICAgIGlmIChkb2MgJiYgZG9tRG9jdW1lbnQuaGVhZC5oYXNDaGlsZE5vZGVzKSB7XG4gICAgICBsZXQgY29udGFpbmVyID0gZG9jLmhlYWQucXVlcnlTZWxlY3Rvcignb3JpZ2luYWwtZWxlbWVudHMnKVxuICAgICAgaWYgKCFjb250YWluZXIpIHtcbiAgICAgICAgY29udGFpbmVyID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ29yaWdpbmFsLWVsZW1lbnRzJylcbiAgICAgICAgZG9jLmhlYWQuYXBwZW5kQ2hpbGQoY29udGFpbmVyKVxuICAgICAgfVxuICAgICAgY29udGFpbmVyLmlubmVySFRNTCA9ICcnXG4gICAgICBmb3IgKGNvbnN0IGhlYWRFbGVtZW50IG9mIEFycmF5LmZyb20oZG9tRG9jdW1lbnQuaGVhZC5jaGlsZE5vZGVzKSkge1xuICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoaGVhZEVsZW1lbnQuY2xvbmVOb2RlKHRydWUpKVxuICAgICAgfVxuICAgIH1cbiAgfSxcbilcblxuaXBjUmVuZGVyZXIub24oJ2Vycm9yJywgKF9ldnQ6IGFueSwgbXNnOiBzdHJpbmcpID0+IHtcbiAgY29uc3QgcHJldmlldyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2Rpdi51cGRhdGUtcHJldmlldycpXG4gIGlmICghcHJldmlldykgcmV0dXJuXG4gIGNvbnN0IGVycm9yRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JylcbiAgZXJyb3JEaXYuaW5uZXJIVE1MID0gYDxoMj5QcmV2aWV3aW5nIE1hcmtkb3duIEZhaWxlZDwvaDI+PGgzPiR7bXNnfTwvaDM+YFxuICBwcmV2aWV3LmFwcGVuZENoaWxkKGVycm9yRGl2KVxufSlcblxuZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V3aGVlbCcsIChldmVudCkgPT4ge1xuICBpZiAoZXZlbnQuY3RybEtleSkge1xuICAgIGlmIChldmVudC53aGVlbERlbHRhWSA+IDApIHtcbiAgICAgIGlwY1JlbmRlcmVyLnNlbmRUb0hvc3QoJ3pvb20taW4nKVxuICAgIH0gZWxzZSBpZiAoZXZlbnQud2hlZWxEZWx0YVkgPCAwKSB7XG4gICAgICBpcGNSZW5kZXJlci5zZW5kVG9Ib3N0KCd6b29tLW91dCcpXG4gICAgfVxuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KClcbiAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKVxuICB9XG59KVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0VGV4dCgpIHtcbiAgY29uc3QgZWwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdtYXJrZG93bi1wcmV2aWV3LXBsdXMtdmlldyA+IGRpdicpXG4gIGlmICghZWwpIHJldHVybiAnJ1xuICByZXR1cm4gZWwudGV4dENvbnRlbnRcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldEhUTUwoKSB7XG4gIGNvbnN0IGVsID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignbWFya2Rvd24tcHJldmlldy1wbHVzLXZpZXcgPiBkaXYnKVxuICBpZiAoIWVsKSByZXR1cm4gJydcbiAgcmV0dXJuIGVsLmlubmVySFRNTFxufVxuIl19