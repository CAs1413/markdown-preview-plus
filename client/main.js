"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const electron_1 = require("electron");
const update_preview_1 = require("./update-preview");
const mathjax_helper_1 = require("./mathjax-helper");
const util = require("./util");
electron_1.ipcRenderer.on('style', (_event, { styles }) => {
    let styleElem = document.head.querySelector('style#atom-styles');
    if (!styleElem) {
        styleElem = document.createElement('style');
        styleElem.id = 'atom-styles';
        document.head.appendChild(styleElem);
    }
    styleElem.innerHTML = styles.join('\n');
});
electron_1.ipcRenderer.on('update-images', (_event, { oldsrc, v }) => {
    const imgs = document.querySelectorAll('img[src]');
    for (const img of Array.from(imgs)) {
        let ovs;
        let ov;
        let src = img.getAttribute('src');
        const match = src.match(/^(.*)\?v=(\d+)$/);
        if (match)
            [, src, ovs] = match;
        if (src === oldsrc) {
            if (ovs !== undefined)
                ov = parseInt(ovs, 10);
            if (v !== ov)
                img.src = v ? `${src}?v=${v}` : `${src}`;
        }
    }
});
electron_1.ipcRenderer.on('sync', (_event, { pathToToken }) => {
    let element = document.querySelector('div.update-preview');
    if (!element)
        return;
    for (const token of pathToToken) {
        const candidateElement = element
            .querySelectorAll(`:scope > ${token.tag}`)
            .item(token.index);
        if (candidateElement) {
            element = candidateElement;
        }
        else {
            break;
        }
    }
    if (element.classList.contains('update-preview')) {
        return;
    }
    if (!element.classList.contains('update-preview')) {
        element.scrollIntoView();
    }
    const maxScrollTop = document.body.scrollHeight - document.body.clientHeight;
    if (!(document.body.scrollTop >= maxScrollTop)) {
        document.body.scrollTop -= document.body.clientHeight / 4;
    }
    element.classList.add('flash');
    setTimeout(() => element.classList.remove('flash'), 1000);
});
electron_1.ipcRenderer.on('use-github-style', (_event, { value }) => {
    const elem = document.querySelector('markdown-preview-plus-view');
    if (!elem)
        throw new Error(`Can't find MPP-view`);
    if (value) {
        elem.setAttribute('data-use-github-style', '');
    }
    else {
        elem.removeAttribute('data-use-github-style');
    }
});
let updatePreview;
electron_1.ipcRenderer.on('update-preview', (_event, { html, renderLaTeX, mjrenderer }) => {
    const preview = document.querySelector('div.update-preview');
    if (!preview)
        return;
    if (!updatePreview) {
        updatePreview = new update_preview_1.UpdatePreview(preview);
    }
    const parser = new DOMParser();
    const domDocument = parser.parseFromString(html, 'text/html');
    const domFragment = document.createDocumentFragment();
    for (const elem of Array.from(domDocument.body.childNodes)) {
        domFragment.appendChild(elem);
    }
    updatePreview.update(document, domFragment, renderLaTeX, mjrenderer);
    const doc = document;
    if (doc && domDocument.head.hasChildNodes) {
        let container = doc.head.querySelector('original-elements');
        if (!container) {
            container = doc.createElement('original-elements');
            doc.head.appendChild(container);
        }
        container.innerHTML = '';
        for (const headElement of Array.from(domDocument.head.childNodes)) {
            container.appendChild(headElement.cloneNode(true));
        }
    }
});
electron_1.ipcRenderer.on('set-atom-home', (_evt, { home }) => {
    window.resolveAtomHome(home);
});
electron_1.ipcRenderer.on('error', (_evt, { msg }) => {
    const preview = document.querySelector('div.update-preview');
    if (!preview)
        return;
    const errorDiv = document.createElement('div');
    errorDiv.innerHTML = `<h2>Previewing Markdown Failed</h2><h3>${msg}</h3>`;
    preview.appendChild(errorDiv);
});
document.addEventListener('mousewheel', (event) => {
    if (event.ctrlKey) {
        if (event.wheelDeltaY > 0) {
            electron_1.ipcRenderer.sendToHost('zoom-in', undefined);
        }
        else if (event.wheelDeltaY < 0) {
            electron_1.ipcRenderer.sendToHost('zoom-out', undefined);
        }
        event.preventDefault();
        event.stopPropagation();
    }
});
let lastContextMenuTarget;
document.addEventListener('contextmenu', (e) => {
    lastContextMenuTarget = e.target;
});
electron_1.ipcRenderer.on('sync-source', (_evt, { tokens }) => {
    const element = lastContextMenuTarget;
    const pathToElement = util.getPathToElement(element);
    pathToElement.shift();
    pathToElement.shift();
    if (!pathToElement.length) {
        return null;
    }
    let finalToken = null;
    let level = 0;
    for (const token of tokens) {
        if (token.level < level) {
            break;
        }
        if (token.hidden) {
            continue;
        }
        if (token.tag === pathToElement[0].tag && token.level === level) {
            if (token.nesting === 1) {
                if (pathToElement[0].index === 0) {
                    if (token.map != null) {
                        finalToken = token;
                    }
                    pathToElement.shift();
                    level++;
                }
                else {
                    pathToElement[0].index--;
                }
            }
            else if (token.nesting === 0 &&
                ['math', 'code', 'hr'].includes(token.tag)) {
                if (pathToElement[0].index === 0) {
                    finalToken = token;
                    break;
                }
                else {
                    pathToElement[0].index--;
                }
            }
        }
        if (pathToElement.length === 0) {
            break;
        }
    }
    if (finalToken !== null) {
        electron_1.ipcRenderer.sendToHost('open-source', {
            initialLine: finalToken.map[0],
        });
        return finalToken.map[0];
    }
    else {
        return null;
    }
});
electron_1.ipcRenderer.on('get-html-svg', async () => {
    const el = document.querySelector('markdown-preview-plus-view > div');
    if (!el)
        return;
    const res = await mathjax_helper_1.processHTMLString(el);
    electron_1.ipcRenderer.sendToHost('html-svg-result', res);
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy1jbGllbnQvbWFpbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHVDQUFzQztBQUN0QyxxREFBZ0Q7QUFDaEQscURBQW9EO0FBQ3BELCtCQUE4QjtBQUU5QixzQkFBVyxDQUFDLEVBQUUsQ0FBVSxPQUFPLEVBQUUsQ0FBQyxNQUFNLEVBQUUsRUFBRSxNQUFNLEVBQUUsRUFBRSxFQUFFO0lBQ3RELElBQUksU0FBUyxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLG1CQUFtQixDQUFDLENBQUE7SUFDaEUsRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO1FBQ2YsU0FBUyxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUE7UUFDM0MsU0FBUyxDQUFDLEVBQUUsR0FBRyxhQUFhLENBQUE7UUFDNUIsUUFBUSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUE7SUFDdEMsQ0FBQztJQUNELFNBQVMsQ0FBQyxTQUFTLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQTtBQUN6QyxDQUFDLENBQUMsQ0FBQTtBQUVGLHNCQUFXLENBQUMsRUFBRSxDQUFrQixlQUFlLEVBQUUsQ0FBQyxNQUFNLEVBQUUsRUFBRSxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUUsRUFBRTtJQUN6RSxNQUFNLElBQUksR0FBRyxRQUFRLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxDQUVoRCxDQUFBO0lBQ0QsR0FBRyxDQUFDLENBQUMsTUFBTSxHQUFHLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbkMsSUFBSSxHQUF1QixDQUFBO1FBQzNCLElBQUksRUFBc0IsQ0FBQTtRQUMxQixJQUFJLEdBQUcsR0FBRyxHQUFHLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBRSxD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LEtBQUssSUFBSSxFQUFFO0lBQ3hELE1BQU0sRUFBRSxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsa0NBQWtDLENBQUMsQ0FBQTtJQUNyRSxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztRQUFDLE1BQU0sQ0FBQTtJQUNmLE1BQU0sR0FBRyxHQUFHLE1BQU0sa0NBQWlCLENBQUMsRUFBRSxDQUFDLENBQUE7SUFDdkMsc0JBQVcsQ0FBQyxVQUFVLENBQW9CLGlCQUFpQixFQUFFLEdBQUcsQ0FBQyxDQUFBO0FBQ25FLENBQUMsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaXBjUmVuZGVyZXIgfSBmcm9tICdlbGVjdHJvbidcbmltcG9ydCB7IFVwZGF0ZVByZXZpZXcgfSBmcm9tICcuL3VwZGF0ZS1wcmV2aWV3J1xuaW1wb3J0IHsgcHJvY2Vzc0hUTUxTdHJpbmcgfSBmcm9tICcuL21hdGhqYXgtaGVscGVyJ1xuaW1wb3J0ICogYXMgdXRpbCBmcm9tICcuL3V0aWwnXG5cbmlwY1JlbmRlcmVyLm9uPCdzdHlsZSc+KCdzdHlsZScsIChfZXZlbnQsIHsgc3R5bGVzIH0pID0+IHtcbiAgbGV0IHN0eWxlRWxlbSA9IGRvY3VtZW50LmhlYWQucXVlcnlTZWxlY3Rvcignc3R5bGUjYXRvbS1zdHlsZXMnKVxuICBpZiAoIXN0eWxlRWxlbSkge1xuICAgIHN0eWxlRWxlbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N0eWxlJylcbiAgICBzdHlsZUVsZW0uaWQgPSAnYXRvbS1zdHlsZXMnXG4gICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzdHlsZUVsZW0pXG4gIH1cbiAgc3R5bGVFbGVtLmlubmVySFRNTCA9IHN0eWxlcy5qb2luKCdcXG4nKVxufSlcblxuaXBjUmVuZGVyZXIub248J3VwZGF0ZS1pbWFnZXMnPigndXBkYXRlLWltYWdlcycsIChfZXZlbnQsIHsgb2xkc3JjLCB2IH0pID0+IHtcbiAgY29uc3QgaW1ncyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ2ltZ1tzcmNdJykgYXMgTm9kZUxpc3RPZjxcbiAgICBIVE1MSW1hZ2VFbGVtZW50XG4gID5cbiAgZm9yIChjb25zdCBpbWcgb2YgQXJyYXkuZnJvbShpbWdzKSkge1xuICAgIGxldCBvdnM6IHN0cmluZyB8IHVuZGVmaW5lZFxuICAgIGxldCBvdjogbnVtYmVyIHwgdW5kZWZpbmVkXG4gICAgbGV0IHNyYyA9IGltZy5nZXRBdHRyaWJ1dGUoJ3NyYycpIVxuICAgIGNvbnN0IG1hdGNoID0gc3JjLm1hdGNoKC9eKC4qKVxcP3Y9KFxcZCspJC8pXG4gICAgaWYgKG1hdGNoKSBbLCBzcmMsIG92c10gPSBtYXRjaFxuICAgIGlmIChzcmMgPT09IG9sZHNyYykge1xuICAgICAgaWYgKG92cyAhPT0gdW5kZWZpbmVkKSBvdiA9IHBhcnNlSW50KG92cywgMTApXG4gICAgICBpZiAodiAhPT0gb3YpIGltZy5zcmMgPSB2ID8gYCR7c3JjfT92PSR7dn1gIDogYCR7c3JjfWBcbiAgICB9XG4gIH1cbn0pXG5cbmlwY1JlbmRlcmVyLm9uPCdzeW5jJz4oJ3N5bmMnLCAoX2V2ZW50LCB7IHBhdGhUb1Rva2VuIH0pID0+IHtcbiAgbGV0IGVsZW1lbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdkaXYudXBkYXRlLXByZXZpZXcnKVxuICBpZiAoIWVsZW1lbnQpIHJldHVyblxuXG4gIGZvciAoY29uc3QgdG9rZW4gb2YgcGF0aFRvVG9rZW4pIHtcbiAgICBjb25zdCBjYW5kaWRhdGVFbGVtZW50OiBIVE1MRWxlbWVudCB8IG51bGwgPSBlbGVtZW50XG4gICAgICAucXVlcnlTZWxlY3RvckFsbChgOnNjb3BlID4gJHt0b2tlbi50YWd9YClcbiAgICAgIC5pdGVtKHRva2VuLmluZGV4KSBhcyBIVE1MRWxlbWVudFxuICAgIGlmIChjYW5kaWRhdGVFbGVtZW50KSB7XG4gICAgICBlbGVtZW50ID0gY2FuZGlkYXRlRWxlbWVudFxuICAgIH0gZWxzZSB7XG4gICAgICBicmVha1xuICAgIH1cbiAgfVxuXG4gIGlmIChlbGVtZW50LmNsYXNzTGlzdC5jb250YWlucygndXBkYXRlLXByZXZpZXcnKSkge1xuICAgIHJldHVyblxuICB9IC8vIERvIG5vdCBqdW1wIHRvIHRoZSB0b3Agb2YgdGhlIHByZXZpZXcgZm9yIGJhZCBzeW5jc1xuXG4gIGlmICghZWxlbWVudC5jbGFzc0xpc3QuY29udGFpbnMoJ3VwZGF0ZS1wcmV2aWV3JykpIHtcbiAgICBlbGVtZW50LnNjcm9sbEludG9WaWV3KClcbiAgfVxuICBjb25zdCBtYXhTY3JvbGxUb3AgPSBkb2N1bWVudC5ib2R5LnNjcm9sbEhlaWdodCAtIGRvY3VtZW50LmJvZHkuY2xpZW50SGVpZ2h0XG4gIGlmICghKGRvY3VtZW50LmJvZHkuc2Nyb2xsVG9wID49IG1heFNjcm9sbFRvcCkpIHtcbiAgICBkb2N1bWVudC5ib2R5LnNjcm9sbFRvcCAtPSBkb2N1bWVudC5ib2R5LmNsaWVudEhlaWdodCAvIDRcbiAgfVxuXG4gIGVsZW1lbnQuY2xhc3NMaXN0LmFkZCgnZmxhc2gnKVxuICBzZXRUaW1lb3V0KCgpID0+IGVsZW1lbnQhLmNsYXNzTGlzdC5yZW1vdmUoJ2ZsYXNoJyksIDEwMDApXG59KVxuXG5pcGNSZW5kZXJlci5vbjwndXNlLWdpdGh1Yi1zdHlsZSc+KCd1c2UtZ2l0aHViLXN0eWxlJywgKF9ldmVudCwgeyB2YWx1ZSB9KSA9PiB7XG4gIGNvbnN0IGVsZW0gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdtYXJrZG93bi1wcmV2aWV3LXBsdXMtdmlldycpXG4gIGlmICghZWxlbSkgdGhyb3cgbmV3IEVycm9yKGBDYW4ndCBmaW5kIE1QUC12aWV3YClcbiAgaWYgKHZhbHVlKSB7XG4gICAgZWxlbS5zZXRBdHRyaWJ1dGUoJ2RhdGEtdXNlLWdpdGh1Yi1zdHlsZScsICcnKVxuICB9IGVsc2Uge1xuICAgIGVsZW0ucmVtb3ZlQXR0cmlidXRlKCdkYXRhLXVzZS1naXRodWItc3R5bGUnKVxuICB9XG59KVxuXG5sZXQgdXBkYXRlUHJldmlldzogVXBkYXRlUHJldmlldyB8IHVuZGVmaW5lZFxuXG5pcGNSZW5kZXJlci5vbjwndXBkYXRlLXByZXZpZXcnPihcbiAgJ3VwZGF0ZS1wcmV2aWV3JyxcbiAgKF9ldmVudCwgeyBodG1sLCByZW5kZXJMYVRlWCwgbWpyZW5kZXJlciB9KSA9PiB7XG4gICAgLy8gZGl2LnVwZGF0ZS1wcmV2aWV3IGNyZWF0ZWQgYWZ0ZXIgY29uc3RydWN0b3Igc3QgVXBkYXRlUHJldmlldyBjYW5ub3RcbiAgICAvLyBiZSBpbnN0YW5jZWQgaW4gdGhlIGNvbnN0cnVjdG9yXG4gICAgY29uc3QgcHJldmlldyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2Rpdi51cGRhdGUtcHJldmlldycpXG4gICAgaWYgKCFwcmV2aWV3KSByZXR1cm5cbiAgICBpZiAoIXVwZGF0ZVByZXZpZXcpIHtcbiAgICAgIHVwZGF0ZVByZXZpZXcgPSBuZXcgVXBkYXRlUHJldmlldyhwcmV2aWV3KVxuICAgIH1cbiAgICBjb25zdCBwYXJzZXIgPSBuZXcgRE9NUGFyc2VyKClcbiAgICBjb25zdCBkb21Eb2N1bWVudCA9IHBhcnNlci5wYXJzZUZyb21TdHJpbmcoaHRtbCwgJ3RleHQvaHRtbCcpXG4gICAgY29uc3QgZG9tRnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KClcbiAgICBmb3IgKGNvbnN0IGVsZW0gb2YgQXJyYXkuZnJvbShkb21Eb2N1bWVudC5ib2R5LmNoaWxkTm9kZXMpKSB7XG4gICAgICBkb21GcmFnbWVudC5hcHBlbmRDaGlsZChlbGVtKVxuICAgIH1cbiAgICB1cGRhdGVQcmV2aWV3LnVwZGF0ZShkb2N1bWVudCwgZG9tRnJhZ21lbnQsIHJlbmRlckxhVGVYLCBtanJlbmRlcmVyKVxuICAgIGNvbnN0IGRvYyA9IGRvY3VtZW50XG4gICAgaWYgKGRvYyAmJiBkb21Eb2N1bWVudC5oZWFkLmhhc0NoaWxkTm9kZXMpIHtcbiAgICAgIGxldCBjb250YWluZXIgPSBkb2MuaGVhZC5xdWVyeVNlbGVjdG9yKCdvcmlnaW5hbC1lbGVtZW50cycpXG4gICAgICBpZiAoIWNvbnRhaW5lcikge1xuICAgICAgICBjb250YWluZXIgPSBkb2MuY3JlYXRlRWxlbWVudCgnb3JpZ2luYWwtZWxlbWVudHMnKVxuICAgICAgICBkb2MuaGVhZC5hcHBlbmRDaGlsZChjb250YWluZXIpXG4gICAgICB9XG4gICAgICBjb250YWluZXIuaW5uZXJIVE1MID0gJydcbiAgICAgIGZvciAoY29uc3QgaGVhZEVsZW1lbnQgb2YgQXJyYXkuZnJvbShkb21Eb2N1bWVudC5oZWFkLmNoaWxkTm9kZXMpKSB7XG4gICAgICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChoZWFkRWxlbWVudC5jbG9uZU5vZGUodHJ1ZSkpXG4gICAgICB9XG4gICAgfVxuICB9LFxuKVxuXG5kZWNsYXJlIGdsb2JhbCB7XG4gIGludGVyZmFjZSBXaW5kb3cge1xuICAgIHJlc29sdmVBdG9tSG9tZShob21lOiBzdHJpbmcpOiB2b2lkXG4gICAgYXRvbUhvbWU6IFByb21pc2U8c3RyaW5nPlxuICB9XG59XG5cbmlwY1JlbmRlcmVyLm9uPCdzZXQtYXRvbS1ob21lJz4oJ3NldC1hdG9tLWhvbWUnLCAoX2V2dCwgeyBob21lIH0pID0+IHtcbiAgd2luZG93LnJlc29sdmVBdG9tSG9tZShob21lKVxufSlcblxuaXBjUmVuZGVyZXIub248J2Vycm9yJz4oJ2Vycm9yJywgKF9ldnQsIHsgbXNnIH0pID0+IHtcbiAgY29uc3QgcHJldmlldyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2Rpdi51cGRhdGUtcHJldmlldycpXG4gIGlmICghcHJldmlldykgcmV0dXJuXG4gIGNvbnN0IGVycm9yRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JylcbiAgZXJyb3JEaXYuaW5uZXJIVE1MID0gYDxoMj5QcmV2aWV3aW5nIE1hcmtkb3duIEZhaWxlZDwvaDI+PGgzPiR7bXNnfTwvaDM+YFxuICBwcmV2aWV3LmFwcGVuZENoaWxkKGVycm9yRGl2KVxufSlcblxuZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V3aGVlbCcsIChldmVudCkgPT4ge1xuICBpZiAoZXZlbnQuY3RybEtleSkge1xuICAgIGlmIChldmVudC53aGVlbERlbHRhWSA+IDApIHtcbiAgICAgIGlwY1JlbmRlcmVyLnNlbmRUb0hvc3Q8J3pvb20taW4nPignem9vbS1pbicsIHVuZGVmaW5lZClcbiAgICB9IGVsc2UgaWYgKGV2ZW50LndoZWVsRGVsdGFZIDwgMCkge1xuICAgICAgaXBjUmVuZGVyZXIuc2VuZFRvSG9zdDwnem9vbS1vdXQnPignem9vbS1vdXQnLCB1bmRlZmluZWQpXG4gICAgfVxuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KClcbiAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKVxuICB9XG59KVxuXG5sZXQgbGFzdENvbnRleHRNZW51VGFyZ2V0OiBIVE1MRWxlbWVudFxuZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY29udGV4dG1lbnUnLCAoZSkgPT4ge1xuICBsYXN0Q29udGV4dE1lbnVUYXJnZXQgPSBlLnRhcmdldCBhcyBIVE1MRWxlbWVudFxufSlcblxuaXBjUmVuZGVyZXIub248J3N5bmMtc291cmNlJz4oJ3N5bmMtc291cmNlJywgKF9ldnQ6IGFueSwgeyB0b2tlbnMgfSkgPT4ge1xuICBjb25zdCBlbGVtZW50ID0gbGFzdENvbnRleHRNZW51VGFyZ2V0XG4gIGNvbnN0IHBhdGhUb0VsZW1lbnQgPSB1dGlsLmdldFBhdGhUb0VsZW1lbnQoZWxlbWVudClcbiAgcGF0aFRvRWxlbWVudC5zaGlmdCgpIC8vIHJlbW92ZSBtYXJrZG93bi1wcmV2aWV3LXBsdXMtdmlld1xuICBwYXRoVG9FbGVtZW50LnNoaWZ0KCkgLy8gcmVtb3ZlIGRpdi51cGRhdGUtcHJldmlld1xuICBpZiAoIXBhdGhUb0VsZW1lbnQubGVuZ3RoKSB7XG4gICAgcmV0dXJuIG51bGxcbiAgfVxuXG4gIGxldCBmaW5hbFRva2VuID0gbnVsbFxuICBsZXQgbGV2ZWwgPSAwXG5cbiAgZm9yIChjb25zdCB0b2tlbiBvZiB0b2tlbnMpIHtcbiAgICBpZiAodG9rZW4ubGV2ZWwgPCBsZXZlbCkge1xuICAgICAgYnJlYWtcbiAgICB9XG4gICAgaWYgKHRva2VuLmhpZGRlbikge1xuICAgICAgY29udGludWVcbiAgICB9XG4gICAgaWYgKHRva2VuLnRhZyA9PT0gcGF0aFRvRWxlbWVudFswXS50YWcgJiYgdG9rZW4ubGV2ZWwgPT09IGxldmVsKSB7XG4gICAgICBpZiAodG9rZW4ubmVzdGluZyA9PT0gMSkge1xuICAgICAgICBpZiAocGF0aFRvRWxlbWVudFswXS5pbmRleCA9PT0gMCkge1xuICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpzdHJpY3QtdHlwZS1wcmVkaWNhdGVzIC8vIFRPRE86IGNvbXBsYWluIG9uIERUXG4gICAgICAgICAgaWYgKHRva2VuLm1hcCAhPSBudWxsKSB7XG4gICAgICAgICAgICBmaW5hbFRva2VuID0gdG9rZW5cbiAgICAgICAgICB9XG4gICAgICAgICAgcGF0aFRvRWxlbWVudC5zaGlmdCgpXG4gICAgICAgICAgbGV2ZWwrK1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHBhdGhUb0VsZW1lbnRbMF0uaW5kZXgtLVxuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKFxuICAgICAgICB0b2tlbi5uZXN0aW5nID09PSAwICYmXG4gICAgICAgIFsnbWF0aCcsICdjb2RlJywgJ2hyJ10uaW5jbHVkZXModG9rZW4udGFnKVxuICAgICAgKSB7XG4gICAgICAgIGlmIChwYXRoVG9FbGVtZW50WzBdLmluZGV4ID09PSAwKSB7XG4gICAgICAgICAgZmluYWxUb2tlbiA9IHRva2VuXG4gICAgICAgICAgYnJlYWtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBwYXRoVG9FbGVtZW50WzBdLmluZGV4LS1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBpZiAocGF0aFRvRWxlbWVudC5sZW5ndGggPT09IDApIHtcbiAgICAgIGJyZWFrXG4gICAgfVxuICB9XG5cbiAgaWYgKGZpbmFsVG9rZW4gIT09IG51bGwpIHtcbiAgICBpcGNSZW5kZXJlci5zZW5kVG9Ib3N0PCdvcGVuLXNvdXJjZSc+KCdvcGVuLXNvdXJjZScsIHtcbiAgICAgIGluaXRpYWxMaW5lOiBmaW5hbFRva2VuLm1hcFswXSxcbiAgICB9KVxuICAgIHJldHVybiBmaW5hbFRva2VuLm1hcFswXVxuICB9IGVsc2Uge1xuICAgIHJldHVybiBudWxsXG4gIH1cbn0pXG5cbmlwY1JlbmRlcmVyLm9uPCdnZXQtaHRtbC1zdmcnPignZ2V0LWh0bWwtc3ZnJywgYXN5bmMgKCkgPT4ge1xuICBjb25zdCBlbCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ21hcmtkb3duLXByZXZpZXctcGx1cy12aWV3ID4gZGl2JylcbiAgaWYgKCFlbCkgcmV0dXJuXG4gIGNvbnN0IHJlcyA9IGF3YWl0IHByb2Nlc3NIVE1MU3RyaW5nKGVsKVxuICBpcGNSZW5kZXJlci5zZW5kVG9Ib3N0PCdodG1sLXN2Zy1yZXN1bHQnPignaHRtbC1zdmctcmVzdWx0JywgcmVzKVxufSlcbiJdfQ==