"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const electron_1 = require("electron");
const update_preview_1 = require("./update-preview");
const mathjax_helper_1 = require("./mathjax-helper");
const util = require("./util");
electron_1.ipcRenderer.on('style', (_event, { styles }) => {
    let styleElem = document.head.querySelector('style#atom-styles');
    if (!styleElem) {
        styleElem = document.createElement('style');
        styleElem.id = 'atom-styles';
        document.head.appendChild(styleElem);
    }
    styleElem.innerHTML = styles.join('\n');
});
electron_1.ipcRenderer.on('update-images', (_event, { oldsrc, v }) => {
    const imgs = document.querySelectorAll('img[src]');
    for (const img of Array.from(imgs)) {
        let ovs;
        let ov;
        let src = img.getAttribute('src');
        const match = src.match(/^(.*)\?v=(\d+)$/);
        if (match)
            [, src, ovs] = match;
        if (src === oldsrc) {
            if (ovs !== undefined)
                ov = parseInt(ovs, 10);
            if (v !== ov)
                img.src = v ? `${src}?v=${v}` : `${src}`;
        }
    }
});
electron_1.ipcRenderer.on('sync', (_event, { pathToToken }) => {
    let element = document.querySelector('div.update-preview');
    if (!element)
        return;
    for (const token of pathToToken) {
        const candidateElement = element
            .querySelectorAll(`:scope > ${token.tag}`)
            .item(token.index);
        if (candidateElement) {
            element = candidateElement;
        }
        else {
            break;
        }
    }
    if (element.classList.contains('update-preview')) {
        return;
    }
    if (!element.classList.contains('update-preview')) {
        element.scrollIntoView();
    }
    const maxScrollTop = document.body.scrollHeight - document.body.clientHeight;
    if (!(document.body.scrollTop >= maxScrollTop)) {
        document.body.scrollTop -= document.body.clientHeight / 4;
    }
    element.classList.add('flash');
    setTimeout(() => element.classList.remove('flash'), 1000);
});
electron_1.ipcRenderer.on('use-github-style', (_event, { value }) => {
    const elem = document.querySelector('markdown-preview-plus-view');
    if (!elem)
        throw new Error(`Can't find MPP-view`);
    if (value) {
        elem.setAttribute('data-use-github-style', '');
    }
    else {
        elem.removeAttribute('data-use-github-style');
    }
});
let updatePreview;
electron_1.ipcRenderer.on('update-preview', (_event, { html, renderLaTeX, mjrenderer }) => {
    const preview = document.querySelector('div.update-preview');
    if (!preview)
        return;
    if (!updatePreview) {
        updatePreview = new update_preview_1.UpdatePreview(preview);
    }
    const parser = new DOMParser();
    const domDocument = parser.parseFromString(html, 'text/html');
    const domFragment = document.createDocumentFragment();
    for (const elem of Array.from(domDocument.body.childNodes)) {
        domFragment.appendChild(elem);
    }
    updatePreview.update(domFragment, renderLaTeX, mjrenderer);
    const doc = document;
    if (doc && domDocument.head.hasChildNodes) {
        let container = doc.head.querySelector('original-elements');
        if (!container) {
            container = doc.createElement('original-elements');
            doc.head.appendChild(container);
        }
        container.innerHTML = '';
        for (const headElement of Array.from(domDocument.head.childNodes)) {
            container.appendChild(headElement.cloneNode(true));
        }
    }
});
electron_1.ipcRenderer.on('set-atom-home', (_evt, { home }) => {
    window.resolveAtomHome(home);
});
const baseElement = document.createElement('base');
document.head.appendChild(baseElement);
electron_1.ipcRenderer.on('set-base-path', (_evt, { path }) => {
    if (path)
        baseElement.href = path;
    else
        baseElement.href = '';
});
electron_1.ipcRenderer.on('error', (_evt, { msg }) => {
    const preview = document.querySelector('div.update-preview');
    if (!preview)
        return;
    const errorDiv = document.createElement('div');
    errorDiv.innerHTML = `<h2>Previewing Markdown Failed</h2><h3>${msg}</h3>`;
    preview.appendChild(errorDiv);
});
document.addEventListener('mousewheel', (event) => {
    if (event.ctrlKey) {
        if (event.wheelDeltaY > 0) {
            electron_1.ipcRenderer.sendToHost('zoom-in', undefined);
        }
        else if (event.wheelDeltaY < 0) {
            electron_1.ipcRenderer.sendToHost('zoom-out', undefined);
        }
        event.preventDefault();
        event.stopPropagation();
    }
});
let lastContextMenuTarget;
document.addEventListener('contextmenu', (e) => {
    lastContextMenuTarget = e.target;
});
electron_1.ipcRenderer.on('sync-source', (_evt, { tokens }) => {
    const element = lastContextMenuTarget;
    const pathToElement = util.getPathToElement(element);
    pathToElement.shift();
    pathToElement.shift();
    if (!pathToElement.length) {
        return null;
    }
    let finalToken = null;
    let level = 0;
    for (const token of tokens) {
        if (token.level < level) {
            break;
        }
        if (token.hidden) {
            continue;
        }
        if (token.tag === pathToElement[0].tag && token.level === level) {
            if (token.nesting === 1) {
                if (pathToElement[0].index === 0) {
                    if (token.map != null) {
                        finalToken = token;
                    }
                    pathToElement.shift();
                    level++;
                }
                else {
                    pathToElement[0].index--;
                }
            }
            else if (token.nesting === 0 &&
                ['math', 'code', 'hr'].includes(token.tag)) {
                if (pathToElement[0].index === 0) {
                    finalToken = token;
                    break;
                }
                else {
                    pathToElement[0].index--;
                }
            }
        }
        if (pathToElement.length === 0) {
            break;
        }
    }
    if (finalToken !== null) {
        electron_1.ipcRenderer.sendToHost('open-source', {
            initialLine: finalToken.map[0],
        });
        return finalToken.map[0];
    }
    else {
        return null;
    }
});
electron_1.ipcRenderer.on('get-html-svg', async () => {
    const el = document.querySelector('markdown-preview-plus-view > div');
    if (!el)
        return;
    const res = await mathjax_helper_1.processHTMLString(el);
    electron_1.ipcRenderer.sendToHost('html-svg-result', res);
});
window.onbeforeunload = function () {
    return false;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy1jbGllbnQvbWFpbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHVDQUFzQztBQUN0QyxxREFBZ0Q7QUFDaEQscURBQW9EO0FBQ3BELCtCQUE4QjtBQUU5QixzQkFBVyxDQUFDLEVBQUUsQ0FBVSxPQUFPLEVBQUUsQ0FBQyxNQUFNLEVBQUUsRUFBRSxNQUFNLEVBQUUsRUFBRSxFQUFFO0lBQ3RELElBQUksU0FBUyxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLG1CQUFtQixDQUFDLENBQUE7SUFDaEUsRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO1FBQ2YsU0FBUyxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUE7UUFDM0MsU0FBUyxDQUFDLEVBQUUsR0FBRyxhQUFhLENBQUE7UUFDNUIsUUFBUSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUE7SUFDdEMsQ0FBQztJQUNELFNBQVMsQ0FBQyxTQUFTLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQTtBQUN6QyxDQUFDLENBQUMsQ0FBQTtBQUVGLHNCQUFXLENBQUMsRUFBRSxDQUFrQixlQUFlLEVBQUUsQ0FBQyxNQUFNLEVBQUUsRUFBRSxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUUsRUFBRTtJQUN6RSxNQUFNLElBQUksR0FBRyxRQUFRLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxDQUVoRCxDQUFBO0lBQ0QsR0FBRyxDQUFDLENBQUMsTUFBTSxHQUFHLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbkMsSUFBSSxHQUF1QixDQUFBO1FBQzNCLElBQUksRUFBc0IsQ0FBQTtRQUMxQixJQUFJLEdBQUcsR0FBRyxHQUFHLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBRSxD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LENBQUMsVUFBVSxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDeEIsc0JBQVcsQ0FBQyxVQUFVLENBQWdCLGFBQWEsRUFBRTtZQUNuRCxXQUFXLEVBQUUsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7U0FDL0IsQ0FBQyxDQUFBO1FBQ0YsTUFBTSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDMUIsQ0FBQztJQUFDLElBQUksQ0FBQyxDQUFDO1FBQ04sTUFBTSxDQUFDLElBQUksQ0FBQTtJQUNiLENBQUM7QUFDSCxDQUFDLENBQUMsQ0FBQTtBQUVGLHNCQUFXLENBQUMsRUFBRSxDQUFpQixjQUFjLEVBQUUsS0FBSyxJQUFJLEVBQUU7SUFDeEQsTUFBTSxFQUFFLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxrQ0FBa0MsQ0FBQyxDQUFBO0lBQ3JFLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO1FBQUMsTUFBTSxDQUFBO0lBQ2YsTUFBTSxHQUFHLEdBQUcsTUFBTSxrQ0FBaUIsQ0FBQyxFQUFFLENBQUMsQ0FBQTtJQUN2QyxzQkFBVyxDQUFDLFVBQVUsQ0FBb0IsaUJBQWlCLEVBQUUsR0FBRyxDQUFDLENBQUE7QUFDbkUsQ0FBQyxDQUFDLENBQUE7QUFFRixNQUFNLENBQUMsY0FBYyxHQUFHO0lBQ3RCLE1BQU0sQ0FBQyxLQUFLLENBQUE7QUFDZCxDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBpcGNSZW5kZXJlciB9IGZyb20gJ2VsZWN0cm9uJ1xuaW1wb3J0IHsgVXBkYXRlUHJldmlldyB9IGZyb20gJy4vdXBkYXRlLXByZXZpZXcnXG5pbXBvcnQgeyBwcm9jZXNzSFRNTFN0cmluZyB9IGZyb20gJy4vbWF0aGpheC1oZWxwZXInXG5pbXBvcnQgKiBhcyB1dGlsIGZyb20gJy4vdXRpbCdcblxuaXBjUmVuZGVyZXIub248J3N0eWxlJz4oJ3N0eWxlJywgKF9ldmVudCwgeyBzdHlsZXMgfSkgPT4ge1xuICBsZXQgc3R5bGVFbGVtID0gZG9jdW1lbnQuaGVhZC5xdWVyeVNlbGVjdG9yKCdzdHlsZSNhdG9tLXN0eWxlcycpXG4gIGlmICghc3R5bGVFbGVtKSB7XG4gICAgc3R5bGVFbGVtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3R5bGUnKVxuICAgIHN0eWxlRWxlbS5pZCA9ICdhdG9tLXN0eWxlcydcbiAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHN0eWxlRWxlbSlcbiAgfVxuICBzdHlsZUVsZW0uaW5uZXJIVE1MID0gc3R5bGVzLmpvaW4oJ1xcbicpXG59KVxuXG5pcGNSZW5kZXJlci5vbjwndXBkYXRlLWltYWdlcyc+KCd1cGRhdGUtaW1hZ2VzJywgKF9ldmVudCwgeyBvbGRzcmMsIHYgfSkgPT4ge1xuICBjb25zdCBpbWdzID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnaW1nW3NyY10nKSBhcyBOb2RlTGlzdE9mPFxuICAgIEhUTUxJbWFnZUVsZW1lbnRcbiAgPlxuICBmb3IgKGNvbnN0IGltZyBvZiBBcnJheS5mcm9tKGltZ3MpKSB7XG4gICAgbGV0IG92czogc3RyaW5nIHwgdW5kZWZpbmVkXG4gICAgbGV0IG92OiBudW1iZXIgfCB1bmRlZmluZWRcbiAgICBsZXQgc3JjID0gaW1nLmdldEF0dHJpYnV0ZSgnc3JjJykhXG4gICAgY29uc3QgbWF0Y2ggPSBzcmMubWF0Y2goL14oLiopXFw/dj0oXFxkKykkLylcbiAgICBpZiAobWF0Y2gpIFssIHNyYywgb3ZzXSA9IG1hdGNoXG4gICAgaWYgKHNyYyA9PT0gb2xkc3JjKSB7XG4gICAgICBpZiAob3ZzICE9PSB1bmRlZmluZWQpIG92ID0gcGFyc2VJbnQob3ZzLCAxMClcbiAgICAgIGlmICh2ICE9PSBvdikgaW1nLnNyYyA9IHYgPyBgJHtzcmN9P3Y9JHt2fWAgOiBgJHtzcmN9YFxuICAgIH1cbiAgfVxufSlcblxuaXBjUmVuZGVyZXIub248J3N5bmMnPignc3luYycsIChfZXZlbnQsIHsgcGF0aFRvVG9rZW4gfSkgPT4ge1xuICBsZXQgZWxlbWVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2Rpdi51cGRhdGUtcHJldmlldycpXG4gIGlmICghZWxlbWVudCkgcmV0dXJuXG5cbiAgZm9yIChjb25zdCB0b2tlbiBvZiBwYXRoVG9Ub2tlbikge1xuICAgIGNvbnN0IGNhbmRpZGF0ZUVsZW1lbnQ6IEhUTUxFbGVtZW50IHwgbnVsbCA9IGVsZW1lbnRcbiAgICAgIC5xdWVyeVNlbGVjdG9yQWxsKGA6c2NvcGUgPiAke3Rva2VuLnRhZ31gKVxuICAgICAgLml0ZW0odG9rZW4uaW5kZXgpIGFzIEhUTUxFbGVtZW50XG4gICAgaWYgKGNhbmRpZGF0ZUVsZW1lbnQpIHtcbiAgICAgIGVsZW1lbnQgPSBjYW5kaWRhdGVFbGVtZW50XG4gICAgfSBlbHNlIHtcbiAgICAgIGJyZWFrXG4gICAgfVxuICB9XG5cbiAgaWYgKGVsZW1lbnQuY2xhc3NMaXN0LmNvbnRhaW5zKCd1cGRhdGUtcHJldmlldycpKSB7XG4gICAgcmV0dXJuXG4gIH0gLy8gRG8gbm90IGp1bXAgdG8gdGhlIHRvcCBvZiB0aGUgcHJldmlldyBmb3IgYmFkIHN5bmNzXG5cbiAgaWYgKCFlbGVtZW50LmNsYXNzTGlzdC5jb250YWlucygndXBkYXRlLXByZXZpZXcnKSkge1xuICAgIGVsZW1lbnQuc2Nyb2xsSW50b1ZpZXcoKVxuICB9XG4gIGNvbnN0IG1heFNjcm9sbFRvcCA9IGRvY3VtZW50LmJvZHkuc2Nyb2xsSGVpZ2h0IC0gZG9jdW1lbnQuYm9keS5jbGllbnRIZWlnaHRcbiAgaWYgKCEoZG9jdW1lbnQuYm9keS5zY3JvbGxUb3AgPj0gbWF4U2Nyb2xsVG9wKSkge1xuICAgIGRvY3VtZW50LmJvZHkuc2Nyb2xsVG9wIC09IGRvY3VtZW50LmJvZHkuY2xpZW50SGVpZ2h0IC8gNFxuICB9XG5cbiAgZWxlbWVudC5jbGFzc0xpc3QuYWRkKCdmbGFzaCcpXG4gIHNldFRpbWVvdXQoKCkgPT4gZWxlbWVudCEuY2xhc3NMaXN0LnJlbW92ZSgnZmxhc2gnKSwgMTAwMClcbn0pXG5cbmlwY1JlbmRlcmVyLm9uPCd1c2UtZ2l0aHViLXN0eWxlJz4oJ3VzZS1naXRodWItc3R5bGUnLCAoX2V2ZW50LCB7IHZhbHVlIH0pID0+IHtcbiAgY29uc3QgZWxlbSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ21hcmtkb3duLXByZXZpZXctcGx1cy12aWV3JylcbiAgaWYgKCFlbGVtKSB0aHJvdyBuZXcgRXJyb3IoYENhbid0IGZpbmQgTVBQLXZpZXdgKVxuICBpZiAodmFsdWUpIHtcbiAgICBlbGVtLnNldEF0dHJpYnV0ZSgnZGF0YS11c2UtZ2l0aHViLXN0eWxlJywgJycpXG4gIH0gZWxzZSB7XG4gICAgZWxlbS5yZW1vdmVBdHRyaWJ1dGUoJ2RhdGEtdXNlLWdpdGh1Yi1zdHlsZScpXG4gIH1cbn0pXG5cbmxldCB1cGRhdGVQcmV2aWV3OiBVcGRhdGVQcmV2aWV3IHwgdW5kZWZpbmVkXG5cbmlwY1JlbmRlcmVyLm9uPCd1cGRhdGUtcHJldmlldyc+KFxuICAndXBkYXRlLXByZXZpZXcnLFxuICAoX2V2ZW50LCB7IGh0bWwsIHJlbmRlckxhVGVYLCBtanJlbmRlcmVyIH0pID0+IHtcbiAgICAvLyBkaXYudXBkYXRlLXByZXZpZXcgY3JlYXRlZCBhZnRlciBjb25zdHJ1Y3RvciBzdCBVcGRhdGVQcmV2aWV3IGNhbm5vdFxuICAgIC8vIGJlIGluc3RhbmNlZCBpbiB0aGUgY29uc3RydWN0b3JcbiAgICBjb25zdCBwcmV2aWV3ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignZGl2LnVwZGF0ZS1wcmV2aWV3JylcbiAgICBpZiAoIXByZXZpZXcpIHJldHVyblxuICAgIGlmICghdXBkYXRlUHJldmlldykge1xuICAgICAgdXBkYXRlUHJldmlldyA9IG5ldyBVcGRhdGVQcmV2aWV3KHByZXZpZXcgYXMgSFRNTEVsZW1lbnQpXG4gICAgfVxuICAgIGNvbnN0IHBhcnNlciA9IG5ldyBET01QYXJzZXIoKVxuICAgIGNvbnN0IGRvbURvY3VtZW50ID0gcGFyc2VyLnBhcnNlRnJvbVN0cmluZyhodG1sLCAndGV4dC9odG1sJylcbiAgICBjb25zdCBkb21GcmFnbWVudCA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKVxuICAgIGZvciAoY29uc3QgZWxlbSBvZiBBcnJheS5mcm9tKGRvbURvY3VtZW50LmJvZHkuY2hpbGROb2RlcykpIHtcbiAgICAgIGRvbUZyYWdtZW50LmFwcGVuZENoaWxkKGVsZW0pXG4gICAgfVxuICAgIHVwZGF0ZVByZXZpZXcudXBkYXRlKGRvbUZyYWdtZW50LCByZW5kZXJMYVRlWCwgbWpyZW5kZXJlcilcbiAgICBjb25zdCBkb2MgPSBkb2N1bWVudFxuICAgIGlmIChkb2MgJiYgZG9tRG9jdW1lbnQuaGVhZC5oYXNDaGlsZE5vZGVzKSB7XG4gICAgICBsZXQgY29udGFpbmVyID0gZG9jLmhlYWQucXVlcnlTZWxlY3Rvcignb3JpZ2luYWwtZWxlbWVudHMnKVxuICAgICAgaWYgKCFjb250YWluZXIpIHtcbiAgICAgICAgY29udGFpbmVyID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ29yaWdpbmFsLWVsZW1lbnRzJylcbiAgICAgICAgZG9jLmhlYWQuYXBwZW5kQ2hpbGQoY29udGFpbmVyKVxuICAgICAgfVxuICAgICAgY29udGFpbmVyLmlubmVySFRNTCA9ICcnXG4gICAgICBmb3IgKGNvbnN0IGhlYWRFbGVtZW50IG9mIEFycmF5LmZyb20oZG9tRG9jdW1lbnQuaGVhZC5jaGlsZE5vZGVzKSkge1xuICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoaGVhZEVsZW1lbnQuY2xvbmVOb2RlKHRydWUpKVxuICAgICAgfVxuICAgIH1cbiAgfSxcbilcblxuZGVjbGFyZSBnbG9iYWwge1xuICBpbnRlcmZhY2UgV2luZG93IHtcbiAgICBhdG9tSG9tZTogUHJvbWlzZTxzdHJpbmc+XG4gICAgcmVzb2x2ZUF0b21Ib21lKGhvbWU6IHN0cmluZyk6IHZvaWRcbiAgfVxufVxuXG5pcGNSZW5kZXJlci5vbjwnc2V0LWF0b20taG9tZSc+KCdzZXQtYXRvbS1ob21lJywgKF9ldnQsIHsgaG9tZSB9KSA9PiB7XG4gIHdpbmRvdy5yZXNvbHZlQXRvbUhvbWUoaG9tZSlcbn0pXG5cbmNvbnN0IGJhc2VFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYmFzZScpXG5kb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKGJhc2VFbGVtZW50KVxuXG5pcGNSZW5kZXJlci5vbjwnc2V0LWJhc2UtcGF0aCc+KCdzZXQtYmFzZS1wYXRoJywgKF9ldnQsIHsgcGF0aCB9KSA9PiB7XG4gIGlmIChwYXRoKSBiYXNlRWxlbWVudC5ocmVmID0gcGF0aFxuICBlbHNlIGJhc2VFbGVtZW50LmhyZWYgPSAnJ1xufSlcblxuaXBjUmVuZGVyZXIub248J2Vycm9yJz4oJ2Vycm9yJywgKF9ldnQsIHsgbXNnIH0pID0+IHtcbiAgY29uc3QgcHJldmlldyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2Rpdi51cGRhdGUtcHJldmlldycpXG4gIGlmICghcHJldmlldykgcmV0dXJuXG4gIGNvbnN0IGVycm9yRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JylcbiAgZXJyb3JEaXYuaW5uZXJIVE1MID0gYDxoMj5QcmV2aWV3aW5nIE1hcmtkb3duIEZhaWxlZDwvaDI+PGgzPiR7bXNnfTwvaDM+YFxuICBwcmV2aWV3LmFwcGVuZENoaWxkKGVycm9yRGl2KVxufSlcblxuZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V3aGVlbCcsIChldmVudCkgPT4ge1xuICBpZiAoZXZlbnQuY3RybEtleSkge1xuICAgIGlmIChldmVudC53aGVlbERlbHRhWSA+IDApIHtcbiAgICAgIGlwY1JlbmRlcmVyLnNlbmRUb0hvc3Q8J3pvb20taW4nPignem9vbS1pbicsIHVuZGVmaW5lZClcbiAgICB9IGVsc2UgaWYgKGV2ZW50LndoZWVsRGVsdGFZIDwgMCkge1xuICAgICAgaXBjUmVuZGVyZXIuc2VuZFRvSG9zdDwnem9vbS1vdXQnPignem9vbS1vdXQnLCB1bmRlZmluZWQpXG4gICAgfVxuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KClcbiAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKVxuICB9XG59KVxuXG5sZXQgbGFzdENvbnRleHRNZW51VGFyZ2V0OiBIVE1MRWxlbWVudFxuZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY29udGV4dG1lbnUnLCAoZSkgPT4ge1xuICBsYXN0Q29udGV4dE1lbnVUYXJnZXQgPSBlLnRhcmdldCBhcyBIVE1MRWxlbWVudFxufSlcblxuaXBjUmVuZGVyZXIub248J3N5bmMtc291cmNlJz4oJ3N5bmMtc291cmNlJywgKF9ldnQ6IGFueSwgeyB0b2tlbnMgfSkgPT4ge1xuICBjb25zdCBlbGVtZW50ID0gbGFzdENvbnRleHRNZW51VGFyZ2V0XG4gIGNvbnN0IHBhdGhUb0VsZW1lbnQgPSB1dGlsLmdldFBhdGhUb0VsZW1lbnQoZWxlbWVudClcbiAgcGF0aFRvRWxlbWVudC5zaGlmdCgpIC8vIHJlbW92ZSBtYXJrZG93bi1wcmV2aWV3LXBsdXMtdmlld1xuICBwYXRoVG9FbGVtZW50LnNoaWZ0KCkgLy8gcmVtb3ZlIGRpdi51cGRhdGUtcHJldmlld1xuICBpZiAoIXBhdGhUb0VsZW1lbnQubGVuZ3RoKSB7XG4gICAgcmV0dXJuIG51bGxcbiAgfVxuXG4gIGxldCBmaW5hbFRva2VuID0gbnVsbFxuICBsZXQgbGV2ZWwgPSAwXG5cbiAgZm9yIChjb25zdCB0b2tlbiBvZiB0b2tlbnMpIHtcbiAgICBpZiAodG9rZW4ubGV2ZWwgPCBsZXZlbCkge1xuICAgICAgYnJlYWtcbiAgICB9XG4gICAgaWYgKHRva2VuLmhpZGRlbikge1xuICAgICAgY29udGludWVcbiAgICB9XG4gICAgaWYgKHRva2VuLnRhZyA9PT0gcGF0aFRvRWxlbWVudFswXS50YWcgJiYgdG9rZW4ubGV2ZWwgPT09IGxldmVsKSB7XG4gICAgICBpZiAodG9rZW4ubmVzdGluZyA9PT0gMSkge1xuICAgICAgICBpZiAocGF0aFRvRWxlbWVudFswXS5pbmRleCA9PT0gMCkge1xuICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpzdHJpY3QtdHlwZS1wcmVkaWNhdGVzIC8vIFRPRE86IGNvbXBsYWluIG9uIERUXG4gICAgICAgICAgaWYgKHRva2VuLm1hcCAhPSBudWxsKSB7XG4gICAgICAgICAgICBmaW5hbFRva2VuID0gdG9rZW5cbiAgICAgICAgICB9XG4gICAgICAgICAgcGF0aFRvRWxlbWVudC5zaGlmdCgpXG4gICAgICAgICAgbGV2ZWwrK1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHBhdGhUb0VsZW1lbnRbMF0uaW5kZXgtLVxuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKFxuICAgICAgICB0b2tlbi5uZXN0aW5nID09PSAwICYmXG4gICAgICAgIFsnbWF0aCcsICdjb2RlJywgJ2hyJ10uaW5jbHVkZXModG9rZW4udGFnKVxuICAgICAgKSB7XG4gICAgICAgIGlmIChwYXRoVG9FbGVtZW50WzBdLmluZGV4ID09PSAwKSB7XG4gICAgICAgICAgZmluYWxUb2tlbiA9IHRva2VuXG4gICAgICAgICAgYnJlYWtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBwYXRoVG9FbGVtZW50WzBdLmluZGV4LS1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBpZiAocGF0aFRvRWxlbWVudC5sZW5ndGggPT09IDApIHtcbiAgICAgIGJyZWFrXG4gICAgfVxuICB9XG5cbiAgaWYgKGZpbmFsVG9rZW4gIT09IG51bGwpIHtcbiAgICBpcGNSZW5kZXJlci5zZW5kVG9Ib3N0PCdvcGVuLXNvdXJjZSc+KCdvcGVuLXNvdXJjZScsIHtcbiAgICAgIGluaXRpYWxMaW5lOiBmaW5hbFRva2VuLm1hcFswXSxcbiAgICB9KVxuICAgIHJldHVybiBmaW5hbFRva2VuLm1hcFswXVxuICB9IGVsc2Uge1xuICAgIHJldHVybiBudWxsXG4gIH1cbn0pXG5cbmlwY1JlbmRlcmVyLm9uPCdnZXQtaHRtbC1zdmcnPignZ2V0LWh0bWwtc3ZnJywgYXN5bmMgKCkgPT4ge1xuICBjb25zdCBlbCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ21hcmtkb3duLXByZXZpZXctcGx1cy12aWV3ID4gZGl2JylcbiAgaWYgKCFlbCkgcmV0dXJuXG4gIGNvbnN0IHJlcyA9IGF3YWl0IHByb2Nlc3NIVE1MU3RyaW5nKGVsKVxuICBpcGNSZW5kZXJlci5zZW5kVG9Ib3N0PCdodG1sLXN2Zy1yZXN1bHQnPignaHRtbC1zdmctcmVzdWx0JywgcmVzKVxufSlcblxud2luZG93Lm9uYmVmb3JldW5sb2FkID0gZnVuY3Rpb24oKSB7XG4gIHJldHVybiBmYWxzZVxufVxuIl19