"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const electron_1 = require("electron");
const update_preview_1 = require("./update-preview");
const mathjax_helper_1 = require("./mathjax-helper");
electron_1.ipcRenderer.on('style', (_event, { styles }) => {
    let styleElem = document.head.querySelector('style#atom-styles');
    if (!styleElem) {
        styleElem = document.createElement('style');
        styleElem.id = 'atom-styles';
        document.head.appendChild(styleElem);
    }
    styleElem.innerHTML = styles.join('\n');
});
electron_1.ipcRenderer.on('update-images', (_event, { oldsrc, v }) => {
    const imgs = document.querySelectorAll('img[src]');
    for (const img of Array.from(imgs)) {
        let ovs;
        let ov;
        let src = img.getAttribute('src');
        const match = src.match(/^(.*)\?v=(\d+)$/);
        if (match)
            [, src, ovs] = match;
        if (src === oldsrc) {
            if (ovs !== undefined)
                ov = parseInt(ovs, 10);
            if (v !== ov)
                img.src = v ? `${src}?v=${v}` : `${src}`;
        }
    }
});
electron_1.ipcRenderer.on('sync', (_event, { pathToToken }) => {
    let element = document.querySelector('div.update-preview');
    if (!element)
        return;
    for (const token of pathToToken) {
        const candidateElement = element
            .querySelectorAll(`:scope > ${token.tag}`)
            .item(token.index);
        if (candidateElement) {
            element = candidateElement;
        }
        else {
            break;
        }
    }
    if (element.classList.contains('update-preview')) {
        return;
    }
    if (!element.classList.contains('update-preview')) {
        element.scrollIntoView();
    }
    const maxScrollTop = document.body.scrollHeight - document.body.clientHeight;
    if (!(document.body.scrollTop >= maxScrollTop)) {
        document.body.scrollTop -= document.body.clientHeight / 4;
    }
    element.classList.add('flash');
    setTimeout(() => element.classList.remove('flash'), 1000);
});
electron_1.ipcRenderer.on('use-github-style', (_event, { value }) => {
    const elem = document.querySelector('markdown-preview-plus-view');
    if (!elem)
        throw new Error(`Can't find MPP-view`);
    if (value) {
        elem.setAttribute('data-use-github-style', '');
    }
    else {
        elem.removeAttribute('data-use-github-style');
    }
});
let updatePreview;
electron_1.ipcRenderer.on('update-preview', (_event, { html, renderLaTeX, mjrenderer }) => {
    const preview = document.querySelector('div.update-preview');
    if (!preview)
        return;
    if (!updatePreview) {
        updatePreview = new update_preview_1.UpdatePreview(preview);
    }
    const parser = new DOMParser();
    const domDocument = parser.parseFromString(html, 'text/html');
    const domFragment = document.createDocumentFragment();
    for (const elem of Array.from(domDocument.body.childNodes)) {
        domFragment.appendChild(elem);
    }
    updatePreview.update(document, domFragment, renderLaTeX, mjrenderer);
    const doc = document;
    if (doc && domDocument.head.hasChildNodes) {
        let container = doc.head.querySelector('original-elements');
        if (!container) {
            container = doc.createElement('original-elements');
            doc.head.appendChild(container);
        }
        container.innerHTML = '';
        for (const headElement of Array.from(domDocument.head.childNodes)) {
            container.appendChild(headElement.cloneNode(true));
        }
    }
});
electron_1.ipcRenderer.on('set-atom-home', (_evt, { home }) => {
    window.resolveAtomHome(home);
});
electron_1.ipcRenderer.on('error', (_evt, { msg }) => {
    const preview = document.querySelector('div.update-preview');
    if (!preview)
        return;
    const errorDiv = document.createElement('div');
    errorDiv.innerHTML = `<h2>Previewing Markdown Failed</h2><h3>${msg}</h3>`;
    preview.appendChild(errorDiv);
});
document.addEventListener('mousewheel', (event) => {
    if (event.ctrlKey) {
        if (event.wheelDeltaY > 0) {
            electron_1.ipcRenderer.sendToHost('zoom-in', undefined);
        }
        else if (event.wheelDeltaY < 0) {
            electron_1.ipcRenderer.sendToHost('zoom-out', undefined);
        }
        event.preventDefault();
        event.stopPropagation();
    }
});
document.addEventListener('contextmenu', (e) => {
    console.log(e);
});
electron_1.ipcRenderer.on('get-html-svg', async () => {
    const el = document.querySelector('markdown-preview-plus-view > div');
    if (!el)
        return;
    const res = await mathjax_helper_1.processHTMLString(el);
    electron_1.ipcRenderer.sendToHost('html-svg-result', res);
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy1jbGllbnQvbWFpbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHVDQUFzQztBQUN0QyxxREFBZ0Q7QUFDaEQscURBQW9EO0FBRXBELHNCQUFXLENBQUMsRUFBRSxDQUFVLE9BQU8sRUFBRSxDQUFDLE1BQU0sRUFBRSxFQUFFLE1BQU0sRUFBRSxFQUFFLEVBQUU7SUFDdEQsSUFBSSxTQUFTLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsbUJBQW1CLENBQUMsQ0FBQTtJQUNoRSxFQUFFLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7UUFDZixTQUFTLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQTtRQUMzQyxTQUFTLENBQUMsRUFBRSxHQUFHLGFBQWEsQ0FBQTtRQUM1QixRQUFRLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQTtJQUN0QyxDQUFDO0lBQ0QsU0FBUyxDQUFDLFNBQVMsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO0FBQ3pDLENBQUMsQ0FBQyxDQUFBO0FBRUYsc0JBQVcsQ0FBQyxFQUFFLENBQWtCLGVBQWUsRUFBRSxDQUFDLE1BQU0sRUFBRSxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxFQUFFO0lBQ3pFLE1BQU0sSUFBSSxHQUFHLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVLENBRWhELENBQUE7SUFDRCxHQUFHLENBQUMsQ0FBQyxNQUFNLEdBQUcsSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNuQyxJQUFJLEdBQXVCLENBQUE7UUFDM0IsSUFBSSxFQUFzQixDQUFBO1FBQzFCLElBQUksR0FBRyxHQUFHLEdBQUcsQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFFLENBQUE7UUFDbEMsTUFB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QUUsQ0FBQztRQUFDLE1BQU0sQ0FBQTtJQUNmLE1BQU0sR0FBRyxHQUFHLE1BQU0sa0NBQWlCLENBQUMsRUFBRSxDQUFDLENBQUE7SUFDdkMsc0JBQVcsQ0FBQyxVQUFVLENBQW9CLGlCQUFpQixFQUFFLEdBQUcsQ0FBQyxDQUFBO0FBQ25FLENBQUMsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaXBjUmVuZGVyZXIgfSBmcm9tICdlbGVjdHJvbidcbmltcG9ydCB7IFVwZGF0ZVByZXZpZXcgfSBmcm9tICcuL3VwZGF0ZS1wcmV2aWV3J1xuaW1wb3J0IHsgcHJvY2Vzc0hUTUxTdHJpbmcgfSBmcm9tICcuL21hdGhqYXgtaGVscGVyJ1xuXG5pcGNSZW5kZXJlci5vbjwnc3R5bGUnPignc3R5bGUnLCAoX2V2ZW50LCB7IHN0eWxlcyB9KSA9PiB7XG4gIGxldCBzdHlsZUVsZW0gPSBkb2N1bWVudC5oZWFkLnF1ZXJ5U2VsZWN0b3IoJ3N0eWxlI2F0b20tc3R5bGVzJylcbiAgaWYgKCFzdHlsZUVsZW0pIHtcbiAgICBzdHlsZUVsZW0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzdHlsZScpXG4gICAgc3R5bGVFbGVtLmlkID0gJ2F0b20tc3R5bGVzJ1xuICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoc3R5bGVFbGVtKVxuICB9XG4gIHN0eWxlRWxlbS5pbm5lckhUTUwgPSBzdHlsZXMuam9pbignXFxuJylcbn0pXG5cbmlwY1JlbmRlcmVyLm9uPCd1cGRhdGUtaW1hZ2VzJz4oJ3VwZGF0ZS1pbWFnZXMnLCAoX2V2ZW50LCB7IG9sZHNyYywgdiB9KSA9PiB7XG4gIGNvbnN0IGltZ3MgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdpbWdbc3JjXScpIGFzIE5vZGVMaXN0T2Y8XG4gICAgSFRNTEltYWdlRWxlbWVudFxuICA+XG4gIGZvciAoY29uc3QgaW1nIG9mIEFycmF5LmZyb20oaW1ncykpIHtcbiAgICBsZXQgb3ZzOiBzdHJpbmcgfCB1bmRlZmluZWRcbiAgICBsZXQgb3Y6IG51bWJlciB8IHVuZGVmaW5lZFxuICAgIGxldCBzcmMgPSBpbWcuZ2V0QXR0cmlidXRlKCdzcmMnKSFcbiAgICBjb25zdCBtYXRjaCA9IHNyYy5tYXRjaCgvXiguKilcXD92PShcXGQrKSQvKVxuICAgIGlmIChtYXRjaCkgWywgc3JjLCBvdnNdID0gbWF0Y2hcbiAgICBpZiAoc3JjID09PSBvbGRzcmMpIHtcbiAgICAgIGlmIChvdnMgIT09IHVuZGVmaW5lZCkgb3YgPSBwYXJzZUludChvdnMsIDEwKVxuICAgICAgaWYgKHYgIT09IG92KSBpbWcuc3JjID0gdiA/IGAke3NyY30/dj0ke3Z9YCA6IGAke3NyY31gXG4gICAgfVxuICB9XG59KVxuXG5pcGNSZW5kZXJlci5vbjwnc3luYyc+KCdzeW5jJywgKF9ldmVudCwgeyBwYXRoVG9Ub2tlbiB9KSA9PiB7XG4gIGxldCBlbGVtZW50ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignZGl2LnVwZGF0ZS1wcmV2aWV3JylcbiAgaWYgKCFlbGVtZW50KSByZXR1cm5cblxuICBmb3IgKGNvbnN0IHRva2VuIG9mIHBhdGhUb1Rva2VuKSB7XG4gICAgY29uc3QgY2FuZGlkYXRlRWxlbWVudDogSFRNTEVsZW1lbnQgfCBudWxsID0gZWxlbWVudFxuICAgICAgLnF1ZXJ5U2VsZWN0b3JBbGwoYDpzY29wZSA+ICR7dG9rZW4udGFnfWApXG4gICAgICAuaXRlbSh0b2tlbi5pbmRleCkgYXMgSFRNTEVsZW1lbnRcbiAgICBpZiAoY2FuZGlkYXRlRWxlbWVudCkge1xuICAgICAgZWxlbWVudCA9IGNhbmRpZGF0ZUVsZW1lbnRcbiAgICB9IGVsc2Uge1xuICAgICAgYnJlYWtcbiAgICB9XG4gIH1cblxuICBpZiAoZWxlbWVudC5jbGFzc0xpc3QuY29udGFpbnMoJ3VwZGF0ZS1wcmV2aWV3JykpIHtcbiAgICByZXR1cm5cbiAgfSAvLyBEbyBub3QganVtcCB0byB0aGUgdG9wIG9mIHRoZSBwcmV2aWV3IGZvciBiYWQgc3luY3NcblxuICBpZiAoIWVsZW1lbnQuY2xhc3NMaXN0LmNvbnRhaW5zKCd1cGRhdGUtcHJldmlldycpKSB7XG4gICAgZWxlbWVudC5zY3JvbGxJbnRvVmlldygpXG4gIH1cbiAgY29uc3QgbWF4U2Nyb2xsVG9wID0gZG9jdW1lbnQuYm9keS5zY3JvbGxIZWlnaHQgLSBkb2N1bWVudC5ib2R5LmNsaWVudEhlaWdodFxuICBpZiAoIShkb2N1bWVudC5ib2R5LnNjcm9sbFRvcCA+PSBtYXhTY3JvbGxUb3ApKSB7XG4gICAgZG9jdW1lbnQuYm9keS5zY3JvbGxUb3AgLT0gZG9jdW1lbnQuYm9keS5jbGllbnRIZWlnaHQgLyA0XG4gIH1cblxuICBlbGVtZW50LmNsYXNzTGlzdC5hZGQoJ2ZsYXNoJylcbiAgc2V0VGltZW91dCgoKSA9PiBlbGVtZW50IS5jbGFzc0xpc3QucmVtb3ZlKCdmbGFzaCcpLCAxMDAwKVxufSlcblxuaXBjUmVuZGVyZXIub248J3VzZS1naXRodWItc3R5bGUnPigndXNlLWdpdGh1Yi1zdHlsZScsIChfZXZlbnQsIHsgdmFsdWUgfSkgPT4ge1xuICBjb25zdCBlbGVtID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignbWFya2Rvd24tcHJldmlldy1wbHVzLXZpZXcnKVxuICBpZiAoIWVsZW0pIHRocm93IG5ldyBFcnJvcihgQ2FuJ3QgZmluZCBNUFAtdmlld2ApXG4gIGlmICh2YWx1ZSkge1xuICAgIGVsZW0uc2V0QXR0cmlidXRlKCdkYXRhLXVzZS1naXRodWItc3R5bGUnLCAnJylcbiAgfSBlbHNlIHtcbiAgICBlbGVtLnJlbW92ZUF0dHJpYnV0ZSgnZGF0YS11c2UtZ2l0aHViLXN0eWxlJylcbiAgfVxufSlcblxubGV0IHVwZGF0ZVByZXZpZXc6IFVwZGF0ZVByZXZpZXcgfCB1bmRlZmluZWRcblxuaXBjUmVuZGVyZXIub248J3VwZGF0ZS1wcmV2aWV3Jz4oXG4gICd1cGRhdGUtcHJldmlldycsXG4gIChfZXZlbnQsIHsgaHRtbCwgcmVuZGVyTGFUZVgsIG1qcmVuZGVyZXIgfSkgPT4ge1xuICAgIC8vIGRpdi51cGRhdGUtcHJldmlldyBjcmVhdGVkIGFmdGVyIGNvbnN0cnVjdG9yIHN0IFVwZGF0ZVByZXZpZXcgY2Fubm90XG4gICAgLy8gYmUgaW5zdGFuY2VkIGluIHRoZSBjb25zdHJ1Y3RvclxuICAgIGNvbnN0IHByZXZpZXcgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdkaXYudXBkYXRlLXByZXZpZXcnKVxuICAgIGlmICghcHJldmlldykgcmV0dXJuXG4gICAgaWYgKCF1cGRhdGVQcmV2aWV3KSB7XG4gICAgICB1cGRhdGVQcmV2aWV3ID0gbmV3IFVwZGF0ZVByZXZpZXcocHJldmlldylcbiAgICB9XG4gICAgY29uc3QgcGFyc2VyID0gbmV3IERPTVBhcnNlcigpXG4gICAgY29uc3QgZG9tRG9jdW1lbnQgPSBwYXJzZXIucGFyc2VGcm9tU3RyaW5nKGh0bWwsICd0ZXh0L2h0bWwnKVxuICAgIGNvbnN0IGRvbUZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpXG4gICAgZm9yIChjb25zdCBlbGVtIG9mIEFycmF5LmZyb20oZG9tRG9jdW1lbnQuYm9keS5jaGlsZE5vZGVzKSkge1xuICAgICAgZG9tRnJhZ21lbnQuYXBwZW5kQ2hpbGQoZWxlbSlcbiAgICB9XG4gICAgdXBkYXRlUHJldmlldy51cGRhdGUoZG9jdW1lbnQsIGRvbUZyYWdtZW50LCByZW5kZXJMYVRlWCwgbWpyZW5kZXJlcilcbiAgICBjb25zdCBkb2MgPSBkb2N1bWVudFxuICAgIGlmIChkb2MgJiYgZG9tRG9jdW1lbnQuaGVhZC5oYXNDaGlsZE5vZGVzKSB7XG4gICAgICBsZXQgY29udGFpbmVyID0gZG9jLmhlYWQucXVlcnlTZWxlY3Rvcignb3JpZ2luYWwtZWxlbWVudHMnKVxuICAgICAgaWYgKCFjb250YWluZXIpIHtcbiAgICAgICAgY29udGFpbmVyID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ29yaWdpbmFsLWVsZW1lbnRzJylcbiAgICAgICAgZG9jLmhlYWQuYXBwZW5kQ2hpbGQoY29udGFpbmVyKVxuICAgICAgfVxuICAgICAgY29udGFpbmVyLmlubmVySFRNTCA9ICcnXG4gICAgICBmb3IgKGNvbnN0IGhlYWRFbGVtZW50IG9mIEFycmF5LmZyb20oZG9tRG9jdW1lbnQuaGVhZC5jaGlsZE5vZGVzKSkge1xuICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoaGVhZEVsZW1lbnQuY2xvbmVOb2RlKHRydWUpKVxuICAgICAgfVxuICAgIH1cbiAgfSxcbilcblxuZGVjbGFyZSBnbG9iYWwge1xuICBpbnRlcmZhY2UgV2luZG93IHtcbiAgICByZXNvbHZlQXRvbUhvbWUoaG9tZTogc3RyaW5nKTogdm9pZFxuICAgIGF0b21Ib21lOiBQcm9taXNlPHN0cmluZz5cbiAgfVxufVxuXG5pcGNSZW5kZXJlci5vbjwnc2V0LWF0b20taG9tZSc+KCdzZXQtYXRvbS1ob21lJywgKF9ldnQsIHsgaG9tZSB9KSA9PiB7XG4gIHdpbmRvdy5yZXNvbHZlQXRvbUhvbWUoaG9tZSlcbn0pXG5cbmlwY1JlbmRlcmVyLm9uPCdlcnJvcic+KCdlcnJvcicsIChfZXZ0LCB7IG1zZyB9KSA9PiB7XG4gIGNvbnN0IHByZXZpZXcgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdkaXYudXBkYXRlLXByZXZpZXcnKVxuICBpZiAoIXByZXZpZXcpIHJldHVyblxuICBjb25zdCBlcnJvckRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpXG4gIGVycm9yRGl2LmlubmVySFRNTCA9IGA8aDI+UHJldmlld2luZyBNYXJrZG93biBGYWlsZWQ8L2gyPjxoMz4ke21zZ308L2gzPmBcbiAgcHJldmlldy5hcHBlbmRDaGlsZChlcnJvckRpdilcbn0pXG5cbmRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNld2hlZWwnLCAoZXZlbnQpID0+IHtcbiAgaWYgKGV2ZW50LmN0cmxLZXkpIHtcbiAgICBpZiAoZXZlbnQud2hlZWxEZWx0YVkgPiAwKSB7XG4gICAgICBpcGNSZW5kZXJlci5zZW5kVG9Ib3N0PCd6b29tLWluJz4oJ3pvb20taW4nLCB1bmRlZmluZWQpXG4gICAgfSBlbHNlIGlmIChldmVudC53aGVlbERlbHRhWSA8IDApIHtcbiAgICAgIGlwY1JlbmRlcmVyLnNlbmRUb0hvc3Q8J3pvb20tb3V0Jz4oJ3pvb20tb3V0JywgdW5kZWZpbmVkKVxuICAgIH1cbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpXG4gICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKClcbiAgfVxufSlcblxuZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY29udGV4dG1lbnUnLCAoZSkgPT4ge1xuICBjb25zb2xlLmxvZyhlKVxufSlcblxuaXBjUmVuZGVyZXIub248J2dldC1odG1sLXN2Zyc+KCdnZXQtaHRtbC1zdmcnLCBhc3luYyAoKSA9PiB7XG4gIGNvbnN0IGVsID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignbWFya2Rvd24tcHJldmlldy1wbHVzLXZpZXcgPiBkaXYnKVxuICBpZiAoIWVsKSByZXR1cm5cbiAgY29uc3QgcmVzID0gYXdhaXQgcHJvY2Vzc0hUTUxTdHJpbmcoZWwpXG4gIGlwY1JlbmRlcmVyLnNlbmRUb0hvc3Q8J2h0bWwtc3ZnLXJlc3VsdCc+KCdodG1sLXN2Zy1yZXN1bHQnLCByZXMpXG59KVxuIl19