"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const CSON = require("season");
const fs = require("fs");
const util_1 = require("./util");
let isMathJaxDisabled = false;
async function mathProcessor(domElements, renderer) {
    if (isMathJaxDisabled)
        return;
    const jax = await loadMathJax(renderer);
    await jax.queueTypeset(domElements);
}
exports.mathProcessor = mathProcessor;
async function processHTMLString(frame, element) {
    if (isMathJaxDisabled) {
        return element.innerHTML;
    }
    const jax = await loadMathJax('SVG');
    await jax.queueTypeset([element]);
    const msvgh = await new Promise((resolve) => frame.executeJavaScript(`return document.getElementById('MathJax_SVG_Hidden')`, false, resolve));
    const svgGlyphs = msvgh && msvgh.parentNode.cloneNode(true);
    if (svgGlyphs !== null) {
        element.insertBefore(svgGlyphs, element.firstChild);
    }
    return element.innerHTML;
}
exports.processHTMLString = processHTMLString;
function disableMathJax(disable) {
    isMathJaxDisabled = disable;
}
async function loadMathJax(renderer) {
    if (window.mathJaxStub)
        return window.mathJaxStub;
    return attachMathJax(renderer);
}
exports.testing = {
    loadMathJax,
    disableMathJax,
};
function getUserMacrosPath() {
    return path.join(process.env.HOME, 'markdown-preview-plus.cson');
}
function loadMacrosFile(filePath) {
    if (!CSON.isObjectPath(filePath)) {
        return {};
    }
    return CSON.readFileSync(filePath, function (error, object) {
        if (object === undefined) {
            object = {};
        }
        if (error !== undefined) {
            console.warn(`Error reading Latex Macros file '${filePath}': ${error.stack !== undefined ? error.stack : error}`);
            console.error(`Failed to load Latex Macros from '${filePath}'`, {
                detail: error.message,
                dismissable: true,
            });
        }
        return object;
    });
}
function loadUserMacros() {
    const userMacrosPath = getUserMacrosPath();
    if (util_1.isFileSync(userMacrosPath)) {
        return loadMacrosFile(userMacrosPath);
    }
    else {
        console.debug('Creating markdown-preview-plus.cson, this is a one-time operation.');
        createMacrosTemplate(userMacrosPath);
        return loadMacrosFile(userMacrosPath);
    }
}
function createMacrosTemplate(filePath) {
    const templatePath = path.join(__dirname, '../assets/macros-template.cson');
    const templateFile = fs.readFileSync(templatePath, 'utf8');
    fs.writeFileSync(filePath, templateFile);
}
function checkMacros(macrosObject) {
    const namePattern = /^[^a-zA-Z\d\s]$|^[a-zA-Z]*$/;
    for (const name in macrosObject) {
        const value = macrosObject[name];
        if (!name.match(namePattern) || !valueMatchesPattern(value)) {
            delete macrosObject[name];
            console.error(`Failed to load LaTeX macro named '${name}'. Please see the [LaTeX guide](https://github.com/atom-community/markdown-preview-plus/blob/master/docs/math.md#macro-names)`);
        }
    }
    return macrosObject;
}
function valueMatchesPattern(value) {
    if (Array.isArray(value)) {
        const macroDefinition = value[0];
        const numberOfArgs = value[1];
        if (typeof numberOfArgs === 'number') {
            return numberOfArgs % 1 === 0 && typeof macroDefinition === 'string';
        }
        else {
            return false;
        }
    }
    else if (typeof value === 'string') {
        return true;
    }
    else {
        return false;
    }
}
const configureMathJax = function (jax, renderer) {
    let userMacros = loadUserMacros();
    if (userMacros) {
        userMacros = checkMacros(userMacros);
    }
    else {
        userMacros = {};
    }
    jax.jaxConfigure(userMacros, renderer);
    console.log('Loaded maths rendering engine MathJax');
};
async function attachMathJax(renderer) {
    console.log('Loading maths rendering engine MathJax');
    await Promise.all([
        injectScript(`${require.resolve('mathjax')}?delayStartupUntil=configured`),
        injectScript(require.resolve('./mathjax-stub')),
    ]);
    configureMathJax(window.mathJaxStub, renderer);
    return window.mathJaxStub;
}
async function injectScript(scriptSrc) {
    const script = document.createElement('script');
    script.src = scriptSrc;
    script.type = 'text/javascript';
    document.head.appendChild(script);
    return new Promise((resolve) => {
        script.addEventListener('load', () => resolve());
    });
}
exports.injectScript = injectScript;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWF0aGpheC1oZWxwZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMtY2xpZW50L21hdGhqYXgtaGVscGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBT0EsNkJBQTZCO0FBQzdCLCtCQUErQjtBQUMvQix5QkFBeUI7QUFDekIsaUNBQW1DO0FBRW5DLElBQUksaUJBQWlCLEdBQUcsS0FBSyxDQUFBO0FBU3RCLEtBQUssd0JBQ1YsV0FBbUIsRUFDbkIsUUFBeUI7SUFFekIsRUFBRSxDQUFDLENBQUMsaUJBQWlCLENBQUM7UUFBQyxNQUFNLENBQUE7SUFDN0IsTUFBTSxHQUFHLEdBQUcsTUFBTSxXQUFXLENBQUMsUUFBUSxDQUFDLENBQUE7SUFDdkMsTUFBTSxHQUFHLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxDQUFBO0FBQ3JDLENBQUM7QUFQRCxzQ0FPQztBQVNNLEtBQUssNEJBQ1YsS0FBMEIsRUFDMUIsT0FBb0I7SUFFcEIsRUFBRSxDQUFDLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxDQUFDO1FBQ3RCLE1BQU0sQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFBO0lBQzFCLENBQUM7SUFDRCxNQUFNLEdBQUcsR0FBRyxNQUFNLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQTtJQUNwQyxNQUFNLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFBO0lBRWpDLE1BQU0sS0FBSyxHQUFHLE1BQU0sSUFBSSxPQUFPLENBQWMsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUN2RCxLQUFLLENBQUMsaUJBQWlCLENBQ3JCLHNEQUFzRCxFQUN0RCxLQUFLLEVBQ0wsT0FBTyxDQUNSLENBQ0YsQ0FBQTtJQUNELE1BQU0sU0FBUyxHQUFHLEtBQUssSUFBSSxLQUFLLENBQUMsVUFBVyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUM1RCxFQUFFLENBQUMsQ0FBQyxTQUFTLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FB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bEQsQ0FBQyxDQUFDLENBQUE7QUFDSixDQUFDO0FBUkQsb0NBUUMiLCJzb3VyY2VzQ29udGVudCI6WyIvL1xuLy8gbWF0aGpheC1oZWxwZXJcbi8vXG4vLyBUaGlzIG1vZHVsZSB3aWxsIGhhbmRsZSBsb2FkaW5nIHRoZSBNYXRoSmF4IGVudmlyb25tZW50IGFuZCBwcm92aWRlIGEgd3JhcHBlclxuLy8gZm9yIGNhbGxzIHRvIE1hdGhKYXggdG8gcHJvY2VzcyBMYVRlWCBlcXVhdGlvbnMuXG4vL1xuXG5pbXBvcnQgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKVxuaW1wb3J0IENTT04gPSByZXF1aXJlKCdzZWFzb24nKVxuaW1wb3J0IGZzID0gcmVxdWlyZSgnZnMnKVxuaW1wb3J0IHsgaXNGaWxlU3luYyB9IGZyb20gJy4vdXRpbCdcblxubGV0IGlzTWF0aEpheERpc2FibGVkID0gZmFsc2VcblxuLy9cbi8vIFByb2Nlc3MgRE9NIGVsZW1lbnRzIGZvciBMYVRlWCBlcXVhdGlvbnMgd2l0aCBNYXRoSmF4XG4vL1xuLy8gQHBhcmFtIGRvbUVsZW1lbnRzIEFuIGFycmF5IG9mIERPTSBlbGVtZW50cyB0byBiZSBwcm9jZXNzZWQgYnkgTWF0aEpheC4gU2VlXG4vLyAgIFtlbGVtZW50XShodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvZWxlbWVudCkgZm9yXG4vLyAgIGRldGFpbHMgb24gRE9NIGVsZW1lbnRzLlxuLy9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBtYXRoUHJvY2Vzc29yKFxuICBkb21FbGVtZW50czogTm9kZVtdLFxuICByZW5kZXJlcjogTWF0aEpheFJlbmRlcmVyLFxuKSB7XG4gIGlmIChpc01hdGhKYXhEaXNhYmxlZCkgcmV0dXJuXG4gIGNvbnN0IGpheCA9IGF3YWl0IGxvYWRNYXRoSmF4KHJlbmRlcmVyKVxuICBhd2FpdCBqYXgucXVldWVUeXBlc2V0KGRvbUVsZW1lbnRzKVxufVxuXG4vL1xuLy8gUHJvY2VzcyBtYXRocyBpbiBIVE1MIGZyYWdtZW50IHdpdGggTWF0aEpheFxuLy9cbi8vIEBwYXJhbSBodG1sIEEgSFRNTCBmcmFnbWVudCBzdHJpbmdcbi8vIEBwYXJhbSBjYWxsYmFjayBBIGNhbGxiYWNrIG1ldGhvZCB0aGF0IGFjY2VwdHMgYSBzaW5nbGUgcGFyYW1ldGVyLCBhIEhUTUxcbi8vICAgZnJhZ21lbnQgc3RyaW5nIHRoYXQgaXMgdGhlIHJlc3VsdCBvZiBodG1sIHByb2Nlc3NlZCBieSBNYXRoSmF4XG4vL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHByb2Nlc3NIVE1MU3RyaW5nKFxuICBmcmFtZTogRWxlY3Ryb24uV2Vidmlld1RhZyxcbiAgZWxlbWVudDogSFRNTEVsZW1lbnQsXG4pIHtcbiAgaWYgKGlzTWF0aEpheERpc2FibGVkKSB7XG4gICAgcmV0dXJuIGVsZW1lbnQuaW5uZXJIVE1MXG4gIH1cbiAgY29uc3QgamF4ID0gYXdhaXQgbG9hZE1hdGhKYXgoJ1NWRycpXG4gIGF3YWl0IGpheC5xdWV1ZVR5cGVzZXQoW2VsZW1lbnRdKVxuXG4gIGNvbnN0IG1zdmdoID0gYXdhaXQgbmV3IFByb21pc2U8SFRNTEVsZW1lbnQ+KChyZXNvbHZlKSA9PlxuICAgIGZyYW1lLmV4ZWN1dGVKYXZhU2NyaXB0KFxuICAgICAgYHJldHVybiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnTWF0aEpheF9TVkdfSGlkZGVuJylgLFxuICAgICAgZmFsc2UsXG4gICAgICByZXNvbHZlLFxuICAgICksXG4gIClcbiAgY29uc3Qgc3ZnR2x5cGhzID0gbXN2Z2ggJiYgbXN2Z2gucGFyZW50Tm9kZSEuY2xvbmVOb2RlKHRydWUpXG4gIGlmIChzdmdHbHlwaHMgIT09IG51bGwpIHtcbiAgICBlbGVtZW50Lmluc2VydEJlZm9yZShzdmdHbHlwaHMsIGVsZW1lbnQuZmlyc3RDaGlsZClcbiAgfVxuICByZXR1cm4gZWxlbWVudC5pbm5lckhUTUxcbn1cblxuLy8gRm9yIHRlc3RpbmdcbmZ1bmN0aW9uIGRpc2FibGVNYXRoSmF4KGRpc2FibGU6IGJvb2xlYW4pIHtcbiAgaXNNYXRoSmF4RGlzYWJsZWQgPSBkaXNhYmxlXG59XG5cbi8vXG4vLyBMb2FkIE1hdGhKYXggZW52aXJvbm1lbnRcbi8vXG4vLyBAcGFyYW0gbGlzdGVuZXIgbWV0aG9kIHRvIGNhbGwgd2hlbiB0aGUgTWF0aEpheCBzY3JpcHQgd2FzIGJlZW5cbi8vICAgbG9hZGVkIHRvIHRoZSB3aW5kb3cuIFRoZSBtZXRob2QgaXMgcGFzc2VkIG5vIGFyZ3VtZW50cy5cbi8vXG5hc3luYyBmdW5jdGlvbiBsb2FkTWF0aEpheChyZW5kZXJlcjogTWF0aEpheFJlbmRlcmVyKTogUHJvbWlzZTxNYXRoSmF4U3R1Yj4ge1xuICBpZiAod2luZG93Lm1hdGhKYXhTdHViKSByZXR1cm4gd2luZG93Lm1hdGhKYXhTdHViXG5cbiAgcmV0dXJuIGF0dGFjaE1hdGhKYXgocmVuZGVyZXIpXG59XG5cbmV4cG9ydCBjb25zdCB0ZXN0aW5nID0ge1xuICBsb2FkTWF0aEpheCxcbiAgZGlzYWJsZU1hdGhKYXgsXG59XG5cbi8vIHByaXZhdGVcblxuZnVuY3Rpb24gZ2V0VXNlck1hY3Jvc1BhdGgoKTogc3RyaW5nIHtcbiAgLy8gVE9ETyFcbiAgcmV0dXJuIHBhdGguam9pbihwcm9jZXNzLmVudi5IT01FLCAnbWFya2Rvd24tcHJldmlldy1wbHVzLmNzb24nKVxuICAvLyBjb25zdCB1c2VyTWFjcm9zUGF0aDogc3RyaW5nIHwgdW5kZWZpbmVkIHwgbnVsbCA9IENTT04ucmVzb2x2ZShcbiAgLy8gICBwYXRoLmpvaW4oYXRvbS5nZXRDb25maWdEaXJQYXRoKCksICdtYXJrZG93bi1wcmV2aWV3LXBsdXMnKSxcbiAgLy8gKVxuICAvLyByZXR1cm4gdXNlck1hY3Jvc1BhdGggIT0gbnVsbFxuICAvLyAgID8gdXNlck1hY3Jvc1BhdGhcbiAgLy8gICA6IHBhdGguam9pbihhdG9tLmdldENvbmZpZ0RpclBhdGgoKSwgJ21hcmtkb3duLXByZXZpZXctcGx1cy5jc29uJylcbn1cblxuZnVuY3Rpb24gbG9hZE1hY3Jvc0ZpbGUoZmlsZVBhdGg6IHN0cmluZyk6IG9iamVjdCB7XG4gIGlmICghQ1NPTi5pc09iamVjdFBhdGgoZmlsZVBhdGgpKSB7XG4gICAgcmV0dXJuIHt9XG4gIH1cbiAgcmV0dXJuIENTT04ucmVhZEZpbGVTeW5jKGZpbGVQYXRoLCBmdW5jdGlvbihlcnJvcj86IEVycm9yLCBvYmplY3Q/OiBvYmplY3QpIHtcbiAgICBpZiAob2JqZWN0ID09PSB1bmRlZmluZWQpIHtcbiAgICAgIG9iamVjdCA9IHt9XG4gICAgfVxuICAgIGlmIChlcnJvciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBjb25zb2xlLndhcm4oXG4gICAgICAgIGBFcnJvciByZWFkaW5nIExhdGV4IE1hY3JvcyBmaWxlICcke2ZpbGVQYXRofSc6ICR7XG4gICAgICAgICAgZXJyb3Iuc3RhY2sgIT09IHVuZGVmaW5lZCA/IGVycm9yLnN0YWNrIDogZXJyb3JcbiAgICAgICAgfWAsXG4gICAgICApXG4gICAgICBjb25zb2xlLmVycm9yKGBGYWlsZWQgdG8gbG9hZCBMYXRleCBNYWNyb3MgZnJvbSAnJHtmaWxlUGF0aH0nYCwge1xuICAgICAgICBkZXRhaWw6IGVycm9yLm1lc3NhZ2UsXG4gICAgICAgIGRpc21pc3NhYmxlOiB0cnVlLFxuICAgICAgfSlcbiAgICB9XG4gICAgcmV0dXJuIG9iamVjdFxuICB9KVxufVxuXG5mdW5jdGlvbiBsb2FkVXNlck1hY3JvcygpIHtcbiAgY29uc3QgdXNlck1hY3Jvc1BhdGggPSBnZXRVc2VyTWFjcm9zUGF0aCgpXG4gIGlmIChpc0ZpbGVTeW5jKHVzZXJNYWNyb3NQYXRoKSkge1xuICAgIHJldHVybiBsb2FkTWFjcm9zRmlsZSh1c2VyTWFjcm9zUGF0aClcbiAgfSBlbHNlIHtcbiAgICBjb25zb2xlLmRlYnVnKFxuICAgICAgJ0NyZWF0aW5nIG1hcmtkb3duLXByZXZpZXctcGx1cy5jc29uLCB0aGlzIGlzIGEgb25lLXRpbWUgb3BlcmF0aW9uLicsXG4gICAgKVxuICAgIGNyZWF0ZU1hY3Jvc1RlbXBsYXRlKHVzZXJNYWNyb3NQYXRoKVxuICAgIHJldHVybiBsb2FkTWFjcm9zRmlsZSh1c2VyTWFjcm9zUGF0aClcbiAgfVxufVxuXG5mdW5jdGlvbiBjcmVhdGVNYWNyb3NUZW1wbGF0ZShmaWxlUGF0aDogc3RyaW5nKSB7XG4gIGNvbnN0IHRlbXBsYXRlUGF0aCA9IHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi9hc3NldHMvbWFjcm9zLXRlbXBsYXRlLmNzb24nKVxuICBjb25zdCB0ZW1wbGF0ZUZpbGUgPSBmcy5yZWFkRmlsZVN5bmModGVtcGxhdGVQYXRoLCAndXRmOCcpXG4gIGZzLndyaXRlRmlsZVN5bmMoZmlsZVBhdGgsIHRlbXBsYXRlRmlsZSlcbn1cblxuZnVuY3Rpb24gY2hlY2tNYWNyb3MobWFjcm9zT2JqZWN0OiBvYmplY3QpIHtcbiAgY29uc3QgbmFtZVBhdHRlcm4gPSAvXlteYS16QS1aXFxkXFxzXSR8XlthLXpBLVpdKiQvIC8vIGxldHRlcnMsIGJ1dCBubyBudW1lcmFscy5cbiAgZm9yIChjb25zdCBuYW1lIGluIG1hY3Jvc09iamVjdCkge1xuICAgIGNvbnN0IHZhbHVlID0gbWFjcm9zT2JqZWN0W25hbWVdXG4gICAgaWYgKCFuYW1lLm1hdGNoKG5hbWVQYXR0ZXJuKSB8fCAhdmFsdWVNYXRjaGVzUGF0dGVybih2YWx1ZSkpIHtcbiAgICAgIGRlbGV0ZSBtYWNyb3NPYmplY3RbbmFtZV1cbiAgICAgIGNvbnNvbGUuZXJyb3IoXG4gICAgICAgIGBGYWlsZWQgdG8gbG9hZCBMYVRlWCBtYWNybyBuYW1lZCAnJHtuYW1lfScuIFBsZWFzZSBzZWUgdGhlIFtMYVRlWCBndWlkZV0oaHR0cHM6Ly9naXRodWIuY29tL2F0b20tY29tbXVuaXR5L21hcmtkb3duLXByZXZpZXctcGx1cy9ibG9iL21hc3Rlci9kb2NzL21hdGgubWQjbWFjcm8tbmFtZXMpYCxcbiAgICAgIClcbiAgICB9XG4gIH1cbiAgcmV0dXJuIG1hY3Jvc09iamVjdFxufVxuXG5mdW5jdGlvbiB2YWx1ZU1hdGNoZXNQYXR0ZXJuKHZhbHVlOiBhbnkpIHtcbiAgLy8gRGlmZmVyZW50IGNoZWNrIGJhc2VkIG9uIHdoZXRoZXIgdmFsdWUgaXMgc3RyaW5nIG9yIGFycmF5XG4gIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkge1xuICAgIGNvbnN0IG1hY3JvRGVmaW5pdGlvbiA9IHZhbHVlWzBdXG4gICAgY29uc3QgbnVtYmVyT2ZBcmdzID0gdmFsdWVbMV1cbiAgICBpZiAodHlwZW9mIG51bWJlck9mQXJncyA9PT0gJ251bWJlcicpIHtcbiAgICAgIHJldHVybiBudW1iZXJPZkFyZ3MgJSAxID09PSAwICYmIHR5cGVvZiBtYWNyb0RlZmluaXRpb24gPT09ICdzdHJpbmcnXG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBmYWxzZVxuICAgIH1cbiAgfSBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSB7XG4gICAgcmV0dXJuIHRydWVcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gZmFsc2VcbiAgfVxufVxuXG4vLyBDb25maWd1cmUgTWF0aEpheCBlbnZpcm9ubWVudC4gU2ltaWxhciB0byB0aGUgVGVYLUFNU19IVE1MIGNvbmZpZ3VyYXRpb24gd2l0aFxuLy8gYSBmZXcgdW5uZWNlc3NhcnkgZmVhdHVyZXMgc3RyaXBwZWQgYXdheVxuLy9cbmNvbnN0IGNvbmZpZ3VyZU1hdGhKYXggPSBmdW5jdGlvbihqYXg6IE1hdGhKYXhTdHViLCByZW5kZXJlcjogTWF0aEpheFJlbmRlcmVyKSB7XG4gIGxldCB1c2VyTWFjcm9zID0gbG9hZFVzZXJNYWNyb3MoKVxuICBpZiAodXNlck1hY3Jvcykge1xuICAgIHVzZXJNYWNyb3MgPSBjaGVja01hY3Jvcyh1c2VyTWFjcm9zKVxuICB9IGVsc2Uge1xuICAgIHVzZXJNYWNyb3MgPSB7fVxuICB9XG5cbiAgamF4LmpheENvbmZpZ3VyZSh1c2VyTWFjcm9zLCByZW5kZXJlcilcblxuICAvLyBOb3RpZnkgdXNlciBNYXRoSmF4IGhhcyBsb2FkZWRcbiAgY29uc29sZS5sb2coJ0xvYWRlZCBtYXRocyByZW5kZXJpbmcgZW5naW5lIE1hdGhKYXgnKVxufVxuXG4vL1xuLy8gQXR0YWNoIG1haW4gTWF0aEpheCBzY3JpcHQgdG8gdGhlIGRvY3VtZW50XG4vL1xuYXN5bmMgZnVuY3Rpb24gYXR0YWNoTWF0aEpheChyZW5kZXJlcjogTWF0aEpheFJlbmRlcmVyKTogUHJvbWlzZTxNYXRoSmF4U3R1Yj4ge1xuICBjb25zb2xlLmxvZygnTG9hZGluZyBtYXRocyByZW5kZXJpbmcgZW5naW5lIE1hdGhKYXgnKVxuXG4gIC8vIEF0dGFjaCBNYXRoSmF4IHNjcmlwdFxuICBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgaW5qZWN0U2NyaXB0KGAke3JlcXVpcmUucmVzb2x2ZSgnbWF0aGpheCcpfT9kZWxheVN0YXJ0dXBVbnRpbD1jb25maWd1cmVkYCksXG4gICAgaW5qZWN0U2NyaXB0KHJlcXVpcmUucmVzb2x2ZSgnLi9tYXRoamF4LXN0dWInKSksXG4gIF0pXG4gIGNvbmZpZ3VyZU1hdGhKYXgod2luZG93Lm1hdGhKYXhTdHViLCByZW5kZXJlcilcbiAgcmV0dXJuIHdpbmRvdy5tYXRoSmF4U3R1YlxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gaW5qZWN0U2NyaXB0KHNjcmlwdFNyYzogc3RyaW5nKSB7XG4gIGNvbnN0IHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpXG4gIHNjcmlwdC5zcmMgPSBzY3JpcHRTcmNcbiAgc2NyaXB0LnR5cGUgPSAndGV4dC9qYXZhc2NyaXB0J1xuICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHNjcmlwdClcbiAgcmV0dXJuIG5ldyBQcm9taXNlPHZvaWQ+KChyZXNvbHZlKSA9PiB7XG4gICAgc2NyaXB0LmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCAoKSA9PiByZXNvbHZlKCkpXG4gIH0pXG59XG4iXX0=