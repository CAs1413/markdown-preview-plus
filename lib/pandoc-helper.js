"use strict";
const _ = require('lodash');
const CP = require('child_process');
let fs = null;
let path = null;
const atomConfig = () => atom.config.get('markdown-preview-plus');
const getMathJaxPath = (function () {
    let cached = null;
    return function () {
        if (cached != null) {
            return cached;
        }
        try {
            return cached = require.resolve('MathJax');
        }
        catch (e) {
            return '';
        }
    };
})();
var findFileRecursive = function (filePath, fileName) {
    if (fs == null) {
        fs = require('fs');
    }
    if (path == null) {
        path = require('path');
    }
    const bibFile = path.join(filePath, '../', fileName);
    if (fs.existsSync(bibFile)) {
        return bibFile;
    }
    else {
        const newPath = path.join(bibFile, '..');
        if ((newPath !== filePath) && !_.includes(atom.project.getPaths(), newPath)) {
            return findFileRecursive(newPath, fileName);
        }
        else {
            return false;
        }
    }
};
const setPandocOptions = function (filePath, renderMath) {
    const args = {
        from: atomConfig().pandocMarkdownFlavor,
        to: 'html'
    };
    const opts = { maxBuffer: Infinity };
    if (path == null) {
        path = require('path');
    }
    if (filePath != null) {
        opts.cwd = path.dirname(filePath);
    }
    const mathjaxPath = getMathJaxPath();
    args.mathjax = renderMath ? mathjaxPath : undefined;
    args.filter = atomConfig().pandocFilters;
    if (atomConfig().pandocBibliography) {
        args.filter.push('pandoc-citeproc');
        let bibFile = findFileRecursive(filePath, atomConfig().pandocBIBFile);
        if (!bibFile) {
            bibFile = atomConfig().pandocBIBFileFallback;
        }
        args.bibliography = bibFile ? bibFile : undefined;
        let cslFile = findFileRecursive(filePath, atomConfig().pandocCSLFile);
        if (!cslFile) {
            cslFile = atomConfig().pandocCSLFileFallback;
        }
        args.csl = cslFile ? cslFile : undefined;
    }
    return { args, opts };
};
const handleError = function (error, html, renderMath) {
    const message = _.uniq(error.split('\n'))
        .join('<br>');
    html = `<h1>Pandoc Error:</h1><pre>${error}</pre><hr>${html}`;
    return handleSuccess(html, renderMath);
};
const handleMath = function (html) {
    const doc = document.createElement('div');
    doc.innerHTML = html;
    doc.querySelectorAll('.math').forEach(function (elem) {
        let math = elem.innerText;
        const mode = math.indexOf('\\[') > -1 ? '; mode=display' : '';
        math = math.replace(/\\[[()\]]/g, '');
        return elem.outerHTML =
            '<span class="math">' +
                `<script type='math/tex${mode}'>${math}</script>` +
                '</span>';
    });
    return doc.innerHTML;
};
const removeReferences = function (html) {
    const doc = document.createElement('div');
    doc.innerHTML = html;
    doc.querySelectorAll('.references').forEach(elem => elem.remove());
    return doc.innerHTML;
};
var handleSuccess = function (html, renderMath) {
    if (renderMath) {
        html = handleMath(html);
    }
    if (atomConfig().pandocRemoveReferences) {
        html = removeReferences(html);
    }
    return [null, html];
};
const handleResponse = function (error, html, renderMath) {
    if (error) {
        return handleError(error, html, renderMath);
    }
    else {
        return handleSuccess(html, renderMath);
    }
};
const renderPandoc = function (text, filePath, renderMath, cb) {
    const { args, opts } = setPandocOptions(filePath, renderMath);
    const cp = CP.execFile(atomConfig().pandocPath, getArguments(args), opts, function (error, stdout, stderr) {
        if (error) {
            atom.notifications.addError(error.toString(), {
                stack: error.stack,
                dismissable: true
            });
        }
        const cbargs = handleResponse((stderr != null ? stderr : ''), (stdout != null ? stdout : ''), renderMath);
        return cb(...Array.from(cbargs || []));
    });
    cp.stdin.write(text);
    return cp.stdin.end();
};
var getArguments = function (args) {
    args = _.reduce(args, function (res, val, key) {
        if (!_.isEmpty(val)) {
            val = _.flatten([val]);
            _.forEach(val, function (v) {
                if (!_.isEmpty(v)) {
                    return res.push(`--${key}=${v}`);
                }
            });
        }
        return res;
    }, []);
    args = _.union(args, atom.config.get('markdown-preview-plus.pandocArguments'));
    args = _.map(args, function (val) {
        val = val.replace(/^(--[\w\-]+)\s(.+)$/i, "$1=$2");
        if (val.substr(0, 1) !== '-') {
            return undefined;
        }
        else {
            return val;
        }
    });
    return _.reject(args, _.isEmpty);
};
module.exports = {
    renderPandoc,
    __testing__: {
        findFileRecursive,
        setPandocOptions,
        getArguments
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFuZG9jLWhlbHBlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9wYW5kb2MtaGVscGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFPQSxNQUFNLENBQUMsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDNUIsTUFBTSxFQUFFLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0FBQ3BDLElBQUksRUFBRSxHQUFHLElBQUksQ0FBQztBQUNkLElBQUksSUFBSSxHQUFHLElBQUksQ0FBQztBQUVoQixNQUFNLFVBQVUsR0FBRyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO0FBS2xFLE1BQU0sY0FBYyxHQUFHLENBQUM7SUFDdEIsSUFBSSxNQUFNLEdBQUcsSUFBSSxDQUFDO0lBQ2xCLE1BQU0sQ0FBQztRQUNMLEVBQUUsQ0FBQyxDQUFDLE1BQU0sSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQztRQUFDLENBQUM7UUFDdEMsSUFBSSxDQUFDO1lBQ0gsTUFBTSxDQUFDLE1BQU0sR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQzdDLENBQUM7UUFBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ1gsTUFBTSxDQUFDLEVBQUUsQ0FBQztRQUNaLENBQUM7SUFDSCxDQUFDLENBQUM7QUFDSixDQUFDLENBQUMsRUFBRSxDQUFDO0FBRUwsSUFBSSxpQkFBaUIsR0FBRyxVQUFTLFFBQVEsRUFBRSxRQUFRO0lBQ2pELEVBQUUsQ0FBQyxDQUFDLEVBQUUsSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQUMsRUFBRSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUFDLENBQUM7SUFDdkMsRUFBRSxDQUFDLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUM7UUFBQyxJQUFJLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQUMsQ0FBQztJQUM3QyxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxLQUFLLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDckQsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDM0IsTUFBTSxDQUFDLE9BQU8sQ0FBQztJQUNqQixDQUFDO0lBQUMsSUFBSSxDQUFDLENBQUM7UUFDTixNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQztRQUN6QyxFQUFFLENBQUMsQ0FBQyxDQUFDLE9BQU8sS0FBSyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDNUUsTUFBTSxDQUFDLGlCQUFpQixDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUMsQ0FBQztRQUM5QyxDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDTixNQUFNLENBQUMsS0FBSyxDQUFDO1FBQ2YsQ0FBQztJQUNILENBQUM7QUFDSCxDQUFDLENBQUM7QUFPRixNQUFNLGdCQUFnQixHQUFHLFVBQVMsUUFBUSxFQUFFLFVBQVU7SUFDcEQsTUFBTSxJQUFJLEdBQUc7UUFDWCxJQUFJLEVBQUUsVUFBVSxFQUFFLENBQUMsb0JBQW9CO1FBQ3ZDLEVBQUUsRUFBRSxNQUFNO0tBQ1gsQ0FBQztJQUNGLE1BQU0sSUFBSSxHQUFHLEVBQUMsU0FBUyxFQUFFLFFBQVEsRUFBQyxDQUFDO0lBQ25DLEVBQUUsQ0FBQyxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQUMsSUFBSSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUFDLENBQUM7SUFDN0MsRUFBRSxDQUFDLENBQUMsUUFBUSxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUM7UUFBQyxJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7SUFBQyxDQUFDO0lBQzVELE1BQU0sV0FBVyxHQUFHLGNBQWMsRUFBRSxDQUFDO0lBQ3JDLElBQUksQ0FBQyxPQUFPLEdBQUcsVUFBVSxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQztJQUNwRCxJQUFJLENBQUMsTUFBTSxHQUFHLFVBQVUsRUFBRSxDQUFDLGFBQWEsQ0FBQztJQUN6QyxFQUFFLENBQUMsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLENBQUM7UUFDcEMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQztRQUNwQyxJQUFJLE9BQU8sR0FBRyxpQkFBaUIsQ0FBQyxRQUFRLEVBQUUsVUFBVSxFQUFFLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDdEUsRUFBRSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1lBQUMsT0FBTyxHQUFHLFVBQVUsRUFBRSxDQUFDLHFCQUFxQixDQUFDO1FBQUMsQ0FBQztRQUMvRCxJQUFJLENBQUMsWUFBWSxHQUFHLE9BQU8sQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7UUFDbEQsSUFBSSxPQUFPLEdBQUcsaUJBQWlCLENBQUMsUUFBUSxFQUFFLFVBQVUsRUFBRSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ3RFLEVBQUUsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztZQUFDLE9BQU8sR0FBRyxVQUFVLEVBQUUsQ0FBQyxxQkFBcUIsQ0FBQztRQUFDLENBQUM7UUFDL0QsSUFBSSxDQUFDLEdBQUcsR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO0lBQzNDLENBQUM7SUFDRCxNQUFNLENBQUMsRUFBQyxJQUFJLEVBQUUsSUFBSSxFQUFDLENBQUM7QUFDdEIsQ0FBQyxDQUFDO0FBUUYsTUFBTSxXQUFXLEdBQUcsVUFBUyxLQUFLLEVBQUUsSUFBSSxFQUFFLFVBQVU7SUFDbEQsTUFBTSxPQUFPLEdBQ1gsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ3hCLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNoQixJQUFJLEdBQUcsOEJBQThCLEtBQUssYUFBYSxJQUFJLEVBQUUsQ0FBQztJQUM5RCxNQUFNLENBQUMsYUFBYSxDQUFDLElBQUksRUFBRSxVQUFVLENBQUMsQ0FBQztBQUN6QyxDQUFDLENBQUM7QUFPRixNQUFNLFVBQVUsR0FBRyxVQUFTLElBQUk7SUFDOUIsTUFBTSxHQUFHLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUMxQyxHQUFHLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQztJQUNyQixHQUFHLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQVMsSUFBSTtRQUNqRCxJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDO1FBRTFCLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUUsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFHL0QsSUFBSSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQ3RDLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUztZQUNuQixxQkFBcUI7Z0JBQ3JCLHlCQUF5QixJQUFJLEtBQUssSUFBSSxXQUFXO2dCQUNqRCxTQUFTLENBQUM7SUFDZCxDQUFDLENBQUMsQ0FBQztJQUVILE1BQU0sQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDO0FBQ3ZCLENBQUMsQ0FBQztBQUVGLE1BQU0sZ0JBQWdCLEdBQUcsVUFBUyxJQUFJO0lBQ3BDLE1BQU0sR0FBRyxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDMUMsR0FBRyxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUM7SUFDckIsR0FBRyxDQUFDLGdCQUFnQixDQUFDLGFBQWEsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDO0lBQ25FLE1BQU0sQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDO0FBQ3ZCLENBQUMsQ0FBQztBQU9GLElBQUksYUFBYSxHQUFHLFVBQVMsSUFBSSxFQUFFLFVBQVU7SUFDM0MsRUFBRSxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztRQUFDLElBQUksR0FBRyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7SUFBQyxDQUFDO0lBQzVDLEVBQUUsQ0FBQyxDQUFDLFVBQVUsRUFBRSxDQUFDLHNCQUFzQixDQUFDLENBQUMsQ0FBQztRQUFDLElBQUksR0FBRyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUFDLENBQUM7SUFDM0UsTUFBTSxDQUFDLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO0FBQ3RCLENBQUMsQ0FBQztBQU9GLE1BQU0sY0FBYyxHQUFHLFVBQVMsS0FBSyxFQUFFLElBQUksRUFBRSxVQUFVO0lBQ3JELEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFBQyxNQUFNLENBQUMsV0FBVyxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsVUFBVSxDQUFDLENBQUM7SUFBQyxDQUFDO0lBQUMsSUFBSSxDQUFDLENBQUM7UUFBQyxNQUFNLENBQUMsYUFBYSxDQUFDLElBQUksRUFBRSxVQUFVLENBQUMsQ0FBQztJQUFDLENBQUM7QUFDOUcsQ0FBQyxDQUFDO0FBUUYsTUFBTSxZQUFZLEdBQUcsVUFBUyxJQUFJLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBRSxFQUFFO0lBQzFELE1BQU0sRUFBQyxJQUFJLEVBQUUsSUFBSSxFQUFDLEdBQUcsZ0JBQWdCLENBQUMsUUFBUSxFQUFFLFVBQVUsQ0FBQyxDQUFDO0lBQzVELE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FBQyxRQUFRLENBQUMsVUFBVSxFQUFFLENBQUMsVUFBVSxFQUFFLFlBQVksQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLEVBQUUsVUFBUyxLQUFLLEVBQUUsTUFBTSxFQUFFLE1BQU07UUFDdEcsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUNWLElBQUksQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUUsRUFBRTtnQkFDNUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxLQUFLO2dCQUNsQixXQUFXLEVBQUUsSUFBSTthQUNsQixDQUNBLENBQUM7UUFDSixDQUFDO1FBQ0QsTUFBTSxNQUFNLEdBQUcsY0FBYyxDQUFDLENBQUMsTUFBTSxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLE1BQU0sSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsVUFBVSxDQUFDLENBQUM7UUFDMUcsTUFBTSxDQUFDLEVBQUUsQ0FBQyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDekMsQ0FBQyxDQUFDLENBQUM7SUFDSCxFQUFFLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNyQixNQUFNLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsQ0FBQztBQUN4QixDQUFDLENBQUM7QUFFRixJQUFJLFlBQVksR0FBRyxVQUFTLElBQUk7SUFDOUIsSUFBSSxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUNsQixVQUFTLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRztRQUNwQixFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3BCLEdBQUcsR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUN2QixDQUFDLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxVQUFTLENBQUM7Z0JBQ3ZCLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFBQyxDQUFDO1lBQzFELENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUNELE1BQU0sQ0FBQyxHQUFHLENBQUM7SUFDYixDQUFDLEVBQ0MsRUFBRSxDQUFDLENBQUM7SUFDUixJQUFJLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsdUNBQXVDLENBQUMsQ0FBQyxDQUFDO0lBQy9FLElBQUksR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksRUFDZixVQUFTLEdBQUc7UUFDVixHQUFHLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxzQkFBc0IsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUNuRCxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQztRQUFDLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUM7UUFBQyxDQUFDO0lBQzVFLENBQUMsQ0FBQyxDQUFDO0lBQ0gsTUFBTSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUNuQyxDQUFDLENBQUM7QUFFRixNQUFNLENBQUMsT0FBTyxHQUFHO0lBQ2YsWUFBWTtJQUNaLFdBQVcsRUFBRTtRQUNYLGlCQUFpQjtRQUNqQixnQkFBZ0I7UUFDaEIsWUFBWTtLQUNiO0NBQ0YsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBkZWNhZmZlaW5hdGUgc3VnZ2VzdGlvbnM6XG4gKiBEUzEwMTogUmVtb3ZlIHVubmVjZXNzYXJ5IHVzZSBvZiBBcnJheS5mcm9tXG4gKiBEUzEwMjogUmVtb3ZlIHVubmVjZXNzYXJ5IGNvZGUgY3JlYXRlZCBiZWNhdXNlIG9mIGltcGxpY2l0IHJldHVybnNcbiAqIERTMjA3OiBDb25zaWRlciBzaG9ydGVyIHZhcmlhdGlvbnMgb2YgbnVsbCBjaGVja3NcbiAqIEZ1bGwgZG9jczogaHR0cHM6Ly9naXRodWIuY29tL2RlY2FmZmVpbmF0ZS9kZWNhZmZlaW5hdGUvYmxvYi9tYXN0ZXIvZG9jcy9zdWdnZXN0aW9ucy5tZFxuICovXG5jb25zdCBfID0gcmVxdWlyZSgnbG9kYXNoJyk7XG5jb25zdCBDUCA9IHJlcXVpcmUoJ2NoaWxkX3Byb2Nlc3MnKTtcbmxldCBmcyA9IG51bGw7XG5sZXQgcGF0aCA9IG51bGw7XG5cbmNvbnN0IGF0b21Db25maWcgPSAoKSA9PiBhdG9tLmNvbmZpZy5nZXQoJ21hcmtkb3duLXByZXZpZXctcGx1cycpO1xuXG4vKipcbiAqIFNldHMgbG9jYWwgbWF0aGpheFBhdGggaWYgYXZhaWxhYmxlXG4gKi9cbmNvbnN0IGdldE1hdGhKYXhQYXRoID0gKGZ1bmN0aW9uKCkge1xuICBsZXQgY2FjaGVkID0gbnVsbDtcbiAgcmV0dXJuIGZ1bmN0aW9uKCkge1xuICAgIGlmIChjYWNoZWQgIT0gbnVsbCkgeyByZXR1cm4gY2FjaGVkOyB9XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBjYWNoZWQgPSByZXF1aXJlLnJlc29sdmUoJ01hdGhKYXgnKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICByZXR1cm4gJyc7XG4gICAgfVxuICB9O1xufSkoKTtcblxudmFyIGZpbmRGaWxlUmVjdXJzaXZlID0gZnVuY3Rpb24oZmlsZVBhdGgsIGZpbGVOYW1lKSB7XG4gIGlmIChmcyA9PSBudWxsKSB7IGZzID0gcmVxdWlyZSgnZnMnKTsgfVxuICBpZiAocGF0aCA9PSBudWxsKSB7IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7IH1cbiAgY29uc3QgYmliRmlsZSA9IHBhdGguam9pbihmaWxlUGF0aCwgJy4uLycsIGZpbGVOYW1lKTtcbiAgaWYgKGZzLmV4aXN0c1N5bmMoYmliRmlsZSkpIHtcbiAgICByZXR1cm4gYmliRmlsZTtcbiAgfSBlbHNlIHtcbiAgICBjb25zdCBuZXdQYXRoID0gcGF0aC5qb2luKGJpYkZpbGUsICcuLicpO1xuICAgIGlmICgobmV3UGF0aCAhPT0gZmlsZVBhdGgpICYmICFfLmluY2x1ZGVzKGF0b20ucHJvamVjdC5nZXRQYXRocygpLCBuZXdQYXRoKSkge1xuICAgICAgcmV0dXJuIGZpbmRGaWxlUmVjdXJzaXZlKG5ld1BhdGgsIGZpbGVOYW1lKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfVxufTtcblxuLyoqXG4gKiBTZXRzIGxvY2FsIHZhcmlhYmxlcyBuZWVkZWQgZm9yIGV2ZXJ5dGhpbmdcbiAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoIHRvIG1hcmtkb3duIGZpbGVcbiAqXG4gKi9cbmNvbnN0IHNldFBhbmRvY09wdGlvbnMgPSBmdW5jdGlvbihmaWxlUGF0aCwgcmVuZGVyTWF0aCkge1xuICBjb25zdCBhcmdzID0ge1xuICAgIGZyb206IGF0b21Db25maWcoKS5wYW5kb2NNYXJrZG93bkZsYXZvcixcbiAgICB0bzogJ2h0bWwnXG4gIH07XG4gIGNvbnN0IG9wdHMgPSB7bWF4QnVmZmVyOiBJbmZpbml0eX07IC8vIHNlZSBodHRwczovL2dpdGh1Yi5jb20vYXRvbS1jb21tdW5pdHkvbWFya2Rvd24tcHJldmlldy1wbHVzL2lzc3Vlcy8zMTZcbiAgaWYgKHBhdGggPT0gbnVsbCkgeyBwYXRoID0gcmVxdWlyZSgncGF0aCcpOyB9XG4gIGlmIChmaWxlUGF0aCAhPSBudWxsKSB7IG9wdHMuY3dkID0gcGF0aC5kaXJuYW1lKGZpbGVQYXRoKTsgfVxuICBjb25zdCBtYXRoamF4UGF0aCA9IGdldE1hdGhKYXhQYXRoKCk7XG4gIGFyZ3MubWF0aGpheCA9IHJlbmRlck1hdGggPyBtYXRoamF4UGF0aCA6IHVuZGVmaW5lZDtcbiAgYXJncy5maWx0ZXIgPSBhdG9tQ29uZmlnKCkucGFuZG9jRmlsdGVycztcbiAgaWYgKGF0b21Db25maWcoKS5wYW5kb2NCaWJsaW9ncmFwaHkpIHtcbiAgICBhcmdzLmZpbHRlci5wdXNoKCdwYW5kb2MtY2l0ZXByb2MnKTtcbiAgICBsZXQgYmliRmlsZSA9IGZpbmRGaWxlUmVjdXJzaXZlKGZpbGVQYXRoLCBhdG9tQ29uZmlnKCkucGFuZG9jQklCRmlsZSk7XG4gICAgaWYgKCFiaWJGaWxlKSB7IGJpYkZpbGUgPSBhdG9tQ29uZmlnKCkucGFuZG9jQklCRmlsZUZhbGxiYWNrOyB9XG4gICAgYXJncy5iaWJsaW9ncmFwaHkgPSBiaWJGaWxlID8gYmliRmlsZSA6IHVuZGVmaW5lZDtcbiAgICBsZXQgY3NsRmlsZSA9IGZpbmRGaWxlUmVjdXJzaXZlKGZpbGVQYXRoLCBhdG9tQ29uZmlnKCkucGFuZG9jQ1NMRmlsZSk7XG4gICAgaWYgKCFjc2xGaWxlKSB7IGNzbEZpbGUgPSBhdG9tQ29uZmlnKCkucGFuZG9jQ1NMRmlsZUZhbGxiYWNrOyB9XG4gICAgYXJncy5jc2wgPSBjc2xGaWxlID8gY3NsRmlsZSA6IHVuZGVmaW5lZDtcbiAgfVxuICByZXR1cm4ge2FyZ3MsIG9wdHN9O1xufTtcblxuLyoqXG4gKiBIYW5kbGUgZXJyb3IgcmVzcG9uc2UgZnJvbSBQYW5kb2NcbiAqIEBwYXJhbSB7ZXJyb3J9IFJldHVybmVkIGVycm9yXG4gKiBAcGFyYW0ge3N0cmluZ30gUmV0dXJuZWQgSFRNTFxuICogQHJldHVybiB7YXJyYXl9IHdpdGggQXJndW1lbnRzIGZvciBjYWxsYmFja0Z1bmN0aW9uIChlcnJvciBzZXQgdG8gbnVsbClcbiAqL1xuY29uc3QgaGFuZGxlRXJyb3IgPSBmdW5jdGlvbihlcnJvciwgaHRtbCwgcmVuZGVyTWF0aCkge1xuICBjb25zdCBtZXNzYWdlID1cbiAgICBfLnVuaXEoZXJyb3Iuc3BsaXQoJ1xcbicpKVxuICAgIC5qb2luKCc8YnI+Jyk7XG4gIGh0bWwgPSBgPGgxPlBhbmRvYyBFcnJvcjo8L2gxPjxwcmU+JHtlcnJvcn08L3ByZT48aHI+JHtodG1sfWA7XG4gIHJldHVybiBoYW5kbGVTdWNjZXNzKGh0bWwsIHJlbmRlck1hdGgpO1xufTtcblxuLyoqXG4gKiBBZGp1c3RzIGFsbCBtYXRoIGVudmlyb25tZW50cyBpbiBIVE1MXG4gKiBAcGFyYW0ge3N0cmluZ30gSFRNTCB0byBiZSBhZGp1c3RlZFxuICogQHJldHVybiB7c3RyaW5nfSBIVE1MIHdpdGggYWRqdXN0ZWQgbWF0aCBlbnZpcm9ubWVudHNcbiAqL1xuY29uc3QgaGFuZGxlTWF0aCA9IGZ1bmN0aW9uKGh0bWwpIHtcbiAgY29uc3QgZG9jID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gIGRvYy5pbm5lckhUTUwgPSBodG1sO1xuICBkb2MucXVlcnlTZWxlY3RvckFsbCgnLm1hdGgnKS5mb3JFYWNoKGZ1bmN0aW9uKGVsZW0pIHtcbiAgICBsZXQgbWF0aCA9IGVsZW0uaW5uZXJUZXh0O1xuICAgIC8vIFNldCBtb2RlIGlmIGl0IGlzIGJsb2NrIG1hdGhcbiAgICBjb25zdCBtb2RlID0gbWF0aC5pbmRleE9mKCdcXFxcWycpID4gLTEgID8gJzsgbW9kZT1kaXNwbGF5JyA6ICcnO1xuXG4gICAgLy8gUmVtb3ZlIHNvdXJyb3VuZGluZyBcXFsgXFxdIGFuZCBcXCggXFwpXG4gICAgbWF0aCA9IG1hdGgucmVwbGFjZSgvXFxcXFtbKClcXF1dL2csICcnKTtcbiAgICByZXR1cm4gZWxlbS5vdXRlckhUTUwgPVxuICAgICAgJzxzcGFuIGNsYXNzPVwibWF0aFwiPicgK1xuICAgICAgYDxzY3JpcHQgdHlwZT0nbWF0aC90ZXgke21vZGV9Jz4ke21hdGh9PC9zY3JpcHQ+YCArXG4gICAgICAnPC9zcGFuPic7XG4gIH0pO1xuXG4gIHJldHVybiBkb2MuaW5uZXJIVE1MO1xufTtcblxuY29uc3QgcmVtb3ZlUmVmZXJlbmNlcyA9IGZ1bmN0aW9uKGh0bWwpIHtcbiAgY29uc3QgZG9jID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gIGRvYy5pbm5lckhUTUwgPSBodG1sO1xuICBkb2MucXVlcnlTZWxlY3RvckFsbCgnLnJlZmVyZW5jZXMnKS5mb3JFYWNoKGVsZW0gPT4gZWxlbS5yZW1vdmUoKSk7XG4gIHJldHVybiBkb2MuaW5uZXJIVE1MO1xufTtcblxuLyoqXG4gKiBIYW5kbGUgc3VjY2Vzc2Z1bCByZXNwb25zZSBmcm9tIFBhbmRvY1xuICogQHBhcmFtIHtzdHJpbmd9IFJldHVybmVkIEhUTUxcbiAqIEByZXR1cm4ge2FycmF5fSB3aXRoIEFyZ3VtZW50cyBmb3IgY2FsbGJhY2tGdW5jdGlvbiAoZXJyb3Igc2V0IHRvIG51bGwpXG4gKi9cbnZhciBoYW5kbGVTdWNjZXNzID0gZnVuY3Rpb24oaHRtbCwgcmVuZGVyTWF0aCkge1xuICBpZiAocmVuZGVyTWF0aCkgeyBodG1sID0gaGFuZGxlTWF0aChodG1sKTsgfVxuICBpZiAoYXRvbUNvbmZpZygpLnBhbmRvY1JlbW92ZVJlZmVyZW5jZXMpIHsgaHRtbCA9IHJlbW92ZVJlZmVyZW5jZXMoaHRtbCk7IH1cbiAgcmV0dXJuIFtudWxsLCBodG1sXTtcbn07XG5cbi8qKlxuICogSGFuZGxlIHJlc3BvbnNlIGZyb20gUGFuZG9jXG4gKiBAcGFyYW0ge09iamVjdH0gZXJyb3IgaWYgdGhyb3duXG4gKiBAcGFyYW0ge3N0cmluZ30gUmV0dXJuZWQgSFRNTFxuICovXG5jb25zdCBoYW5kbGVSZXNwb25zZSA9IGZ1bmN0aW9uKGVycm9yLCBodG1sLCByZW5kZXJNYXRoKSB7XG4gIGlmIChlcnJvcikgeyByZXR1cm4gaGFuZGxlRXJyb3IoZXJyb3IsIGh0bWwsIHJlbmRlck1hdGgpOyB9IGVsc2UgeyByZXR1cm4gaGFuZGxlU3VjY2VzcyhodG1sLCByZW5kZXJNYXRoKTsgfVxufTtcblxuLyoqXG4gKiBSZW5kZXJzIG1hcmtkb3duIHdpdGggcGFuZG9jXG4gKiBAcGFyYW0ge3N0cmluZ30gZG9jdW1lbnQgaW4gbWFya2Rvd25cbiAqIEBwYXJhbSB7Ym9vbGVhbn0gd2hldGhlciB0byByZW5kZXIgdGhlIG1hdGggd2l0aCBtYXRoamF4XG4gKiBAcGFyYW0ge2Z1bmN0aW9ufSBjYWxsYmFja0Z1bmN0aW9uXG4gKi9cbmNvbnN0IHJlbmRlclBhbmRvYyA9IGZ1bmN0aW9uKHRleHQsIGZpbGVQYXRoLCByZW5kZXJNYXRoLCBjYikge1xuICBjb25zdCB7YXJncywgb3B0c30gPSBzZXRQYW5kb2NPcHRpb25zKGZpbGVQYXRoLCByZW5kZXJNYXRoKTtcbiAgY29uc3QgY3AgPSBDUC5leGVjRmlsZShhdG9tQ29uZmlnKCkucGFuZG9jUGF0aCwgZ2V0QXJndW1lbnRzKGFyZ3MpLCBvcHRzLCBmdW5jdGlvbihlcnJvciwgc3Rkb3V0LCBzdGRlcnIpIHtcbiAgICBpZiAoZXJyb3IpIHtcbiAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRFcnJvcihlcnJvci50b1N0cmluZygpLCB7XG4gICAgICAgIHN0YWNrOiBlcnJvci5zdGFjayxcbiAgICAgICAgZGlzbWlzc2FibGU6IHRydWVcbiAgICAgIH1cbiAgICAgICk7XG4gICAgfVxuICAgIGNvbnN0IGNiYXJncyA9IGhhbmRsZVJlc3BvbnNlKChzdGRlcnIgIT0gbnVsbCA/IHN0ZGVyciA6ICcnKSwgKHN0ZG91dCAhPSBudWxsID8gc3Rkb3V0IDogJycpLCByZW5kZXJNYXRoKTtcbiAgICByZXR1cm4gY2IoLi4uQXJyYXkuZnJvbShjYmFyZ3MgfHwgW10pKTtcbiAgfSk7XG4gIGNwLnN0ZGluLndyaXRlKHRleHQpO1xuICByZXR1cm4gY3Auc3RkaW4uZW5kKCk7XG59O1xuXG52YXIgZ2V0QXJndW1lbnRzID0gZnVuY3Rpb24oYXJncykge1xuICBhcmdzID0gXy5yZWR1Y2UoYXJncyxcbiAgICBmdW5jdGlvbihyZXMsIHZhbCwga2V5KSB7XG4gICAgICBpZiAoIV8uaXNFbXB0eSh2YWwpKSB7XG4gICAgICAgIHZhbCA9IF8uZmxhdHRlbihbdmFsXSk7XG4gICAgICAgIF8uZm9yRWFjaCh2YWwsIGZ1bmN0aW9uKHYpIHtcbiAgICAgICAgICBpZiAoIV8uaXNFbXB0eSh2KSkgeyByZXR1cm4gcmVzLnB1c2goYC0tJHtrZXl9PSR7dn1gKTsgfVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIHJldHVybiByZXM7XG4gICAgfVxuICAgICwgW10pO1xuICBhcmdzID0gXy51bmlvbihhcmdzLCBhdG9tLmNvbmZpZy5nZXQoJ21hcmtkb3duLXByZXZpZXctcGx1cy5wYW5kb2NBcmd1bWVudHMnKSk7XG4gIGFyZ3MgPSBfLm1hcChhcmdzLFxuICAgIGZ1bmN0aW9uKHZhbCkge1xuICAgICAgdmFsID0gdmFsLnJlcGxhY2UoL14oLS1bXFx3XFwtXSspXFxzKC4rKSQvaSwgXCIkMT0kMlwiKTtcbiAgICAgIGlmICh2YWwuc3Vic3RyKDAsIDEpICE9PSAnLScpIHsgcmV0dXJuIHVuZGVmaW5lZDsgfSBlbHNlIHsgcmV0dXJuIHZhbDsgfVxuICB9KTtcbiAgcmV0dXJuIF8ucmVqZWN0KGFyZ3MsIF8uaXNFbXB0eSk7XG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IHtcbiAgcmVuZGVyUGFuZG9jLFxuICBfX3Rlc3RpbmdfXzoge1xuICAgIGZpbmRGaWxlUmVjdXJzaXZlLFxuICAgIHNldFBhbmRvY09wdGlvbnMsXG4gICAgZ2V0QXJndW1lbnRzXG4gIH1cbn07XG4iXX0=