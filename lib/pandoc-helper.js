"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const _ = require("lodash");
const CP = require("child_process");
const fs = require("fs");
const path = require("path");
const atomConfig = () => atom.config.get('markdown-preview-plus');
const getMathJaxPath = (function () {
    let cached = null;
    return function () {
        if (cached !== null) {
            return cached;
        }
        try {
            return (cached = require.resolve('MathJax'));
        }
        catch (e) {
            return '';
        }
    };
})();
function findFileRecursive(filePath, fileName) {
    const bibFile = path.join(filePath, '../', fileName);
    if (fs.existsSync(bibFile)) {
        return bibFile;
    }
    else {
        const newPath = path.join(bibFile, '..');
        if (newPath !== filePath && !_.includes(atom.project.getPaths(), newPath)) {
            return findFileRecursive(newPath, fileName);
        }
        else {
            return false;
        }
    }
}
exports.findFileRecursive = findFileRecursive;
function setPandocOptions(filePath, renderMath) {
    const opts = { maxBuffer: Infinity };
    if (filePath !== undefined) {
        opts.cwd = path.dirname(filePath);
    }
    const mathjaxPath = getMathJaxPath();
    const args = {
        from: atomConfig().pandocMarkdownFlavor,
        to: 'html',
        mathjax: renderMath ? mathjaxPath : undefined,
        filter: atomConfig().pandocFilters,
    };
    if (atomConfig().pandocBibliography) {
        args.filter.push('pandoc-citeproc');
        let bibFile = filePath && findFileRecursive(filePath, atomConfig().pandocBIBFile);
        if (!bibFile) {
            bibFile = atomConfig().pandocBIBFileFallback;
        }
        args.bibliography = bibFile ? bibFile : undefined;
        let cslFile = filePath && findFileRecursive(filePath, atomConfig().pandocCSLFile);
        if (!cslFile) {
            cslFile = atomConfig().pandocCSLFileFallback;
        }
        args.csl = cslFile ? cslFile : undefined;
    }
    return { args, opts };
}
exports.setPandocOptions = setPandocOptions;
function handleError(error, html, renderMath) {
    html = `<h1>Pandoc Error:</h1><pre>${error}</pre><hr>${html}`;
    return handleSuccess(html, renderMath);
}
function handleMath(html) {
    const doc = document.createElement('div');
    doc.innerHTML = html;
    doc.querySelectorAll('.math').forEach(function (elem) {
        let math = elem.innerText;
        const mode = math.indexOf('\\[') > -1 ? '; mode=display' : '';
        math = math.replace(/\\[[()\]]/g, '');
        return (elem.outerHTML =
            '<span class="math">' +
                `<script type='math/tex${mode}'>${math}</script>` +
                '</span>');
    });
    return doc.innerHTML;
}
function removeReferences(html) {
    const doc = document.createElement('div');
    doc.innerHTML = html;
    doc.querySelectorAll('.references').forEach((elem) => {
        elem.remove();
    });
    return doc.innerHTML;
}
function handleSuccess(html, renderMath) {
    if (renderMath) {
        html = handleMath(html);
    }
    if (atomConfig().pandocRemoveReferences) {
        html = removeReferences(html);
    }
    return html;
}
function handleResponse(error, html, renderMath) {
    if (error) {
        return handleError(error, html, renderMath);
    }
    else {
        return handleSuccess(html, renderMath);
    }
}
async function renderPandoc(text, filePath, renderMath, cb) {
    const { args, opts } = setPandocOptions(filePath, renderMath);
    return new Promise((resolve, reject) => {
        const cp = CP.execFile(atomConfig().pandocPath, getArguments(args), opts, function (error, stdout, stderr) {
            if (error) {
                atom.notifications.addError(error.toString(), {
                    stack: error.stack,
                    dismissable: true,
                });
                reject(error);
            }
            const result = handleResponse(stderr || '', stdout || '', renderMath);
            resolve(cb(null, result));
        });
        cp.stdin.write(text);
        cp.stdin.end();
    });
}
exports.renderPandoc = renderPandoc;
function getArguments(iargs) {
    const args = _.reduce(iargs, function (res, val, key) {
        if (val && !_.isEmpty(val)) {
            const nval = _.flatten([val]);
            _.forEach(nval, function (v) {
                if (!_.isEmpty(v)) {
                    res.push(`--${key}=${v}`);
                }
            });
        }
        return res;
    }, []);
    const res = [];
    for (const val of [
        ...args,
        ...atom.config.get('markdown-preview-plus.pandocArguments'),
    ]) {
        const newval = val.replace(/^(--[\w\-]+)\s(.+)$/i, '$1=$2');
        if (newval.substr(0, 1) === '-') {
            res.push(newval);
        }
    }
    return res;
}
exports.getArguments = getArguments;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFuZG9jLWhlbHBlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9wYW5kb2MtaGVscGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBTUEsNEJBQTRCO0FBQzVCLG9DQUFvQztBQUNwQyx5QkFBeUI7QUFDekIsNkJBQTZCO0FBRTdCLE1BQU0sVUFBVSxHQUFHLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLHVCQUF1QixDQUFFLENBQUE7QUFLbEUsTUFBTSxjQUFjLEdBQUcsQ0FBQztJQUN0QixJQUFJLE1BQU0sR0FBa0IsSUFBSSxDQUFBO0lBQ2hDLE1BQU0sQ0FBQztRQUNMLEVBQUUsQ0FBQyxDQUFDLE1BQU0sS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ3BCLE1BQU0sQ0FBQyxNQUFNLENBQUE7UUFDZixDQUFDO1FBQ0QsSUFBSSxDQUFDO1lBQ0gsTUFBTSxDQUFDLENBQUMsTUFBTSxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQTtRQUM5QyxDQUFDO1FBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNYLE1BQU0sQ0FBQyxFQUFFLENBQUE7UUFDWCxDQUFDO0lBQ0gsQ0FBQyxDQUFBO0FBQ0gsQ0FBQyxDQUFDLEVBQUUsQ0FBQTtBQUVKLDJCQUNFLFFBQWdCLEVBQ2hCLFFBQWdCO0lBRWhCLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLEtBQUssRUFBRSxRQUFRLENBQUMsQ0FBQTtJQUNwRCxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMzQixNQUFNLENBQUMsT0FBTyxDQUFBO0lBQ2hCLENBQUM7SUFBQyxJQUFJLENBQUMsQ0FBQztRQUNOLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFBO1FBQ3hDLEVBQUUsQ0FBQyxDQUFDLE9BQU8sS0FBSyxRQUFRLElBQUksQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzFFLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLEVBQUUsUUFBUSxDQUFDLENBQUE7UUFDN0MsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ04sTUFBTSxDQUFDLEtBQUssQ0FBQTtRQUNkLENBQUM7SUFDSCxDQUFDO0FBQ0gsQ0FBQztBQWZELDhDQWVDO0FBV0QsMEJBQ0UsUUFBNEIsRUFDNUIsVUFBbUI7SUFHbkIsTUFBTSxJQUFJLEdBQXVCLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxDQUFBO0lBQ3hELEVBQUUsQ0FBQyxDQUFDLFFBQVEsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDO1FBQzNCLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQTtJQUNuQyxDQUFDO0lBQ0QsTUFBTSxXQUFXLEdBQUcsY0FBYyxFQUFFLENBQUE7SUFDcEMsTUFBTSxJQUFJLEdBQVM7UUFDakIsSUFBSSxFQUFFLFVBQVUsRUFBRSxDQUFDLG9CQUFvQjtRQUN2QyxFQUFFLEVBQUUsTUFBTTtRQUNWLE9BQU8sRUFBRSxVQUFVLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsU0FBUztRQUM3QyxNQUFNLEVBQUUsVUFBVSxFQUFFLENBQUMsYUFBYTtLQUNuQyxDQUFBO0lBQ0QsRUFBRSxDQUFDLENBQUMsVUFBVSxFQUFFLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDO1FBQ3BDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUE7UUFDbkMsSUFBSSxPQUFPLEdBQ1QsUUFBUSxJQUFJLGlCQUFpQixDQUFDLFFBQVEsRUFBRSxVQUFVLEVBQUUsQ0FBQyxhQUFhLENBQUMsQ0FBQTtRQUNyRSxFQUFFLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7WUFDYixPQUFPLEdBQUcsVUFBVSxFQUFFLENBQUMscUJBQXFCLENBQUE7UUFDOUMsQ0FBQztRQUNELElBQUksQ0FBQyxZQUFZLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQTtRQUNqRCxJQUFJLE9BQU8sR0FDVCxRQUFRLElBQUksaUJBQWlCLENBQUMsUUFBUSxFQUFFLFVBQVUsRUFBRSxDQUFDLGFBQWEsQ0FBQyxDQUFBO1FBQ3JFLEVBQUUsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztZQUNiLE9BQU8sR0FBRyxVQUFVLEVBQUUsQ0FBQyxxQkFBcUIsQ0FBQTtRQUM5QyxDQUFDO1FBQ0QsSUFBSSxDQUFDLEdBQUcsR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFBO0lBQzFDLENBQUM7SUFDRCxNQUFNLENBQUMsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLENBQUE7QUFDdkIsQ0FBQztBQWhDRCw0Q0FnQ0M7QUFRRCxxQkFBcUIsS0FBYSxFQUFFLElBQVksRUFBRSxVQUFtQjtJQUNuRSxJQUFJLEdBQUcsOEJBQThCLEtBQUssYUFBYSxJQUFJLEVBQUUsQ0FBQTtJQUM3RCxNQUFNLENBQUMsYUFBYSxDQUFDLElBQUksRUFBRSxVQUFVLENBQUMsQ0FBQTtBQUN4QyxDQUFDO0FBT0Qsb0JBQW9CLElBQVk7SUFDOUIsTUFBTSxHQUFHLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQTtJQUN6QyxHQUFHLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQTtJQUNwQixHQUFHLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQVMsSUFBSTtRQUNqRCxJQUFJLElBQUksR0FBSSxJQUFvQixDQUFDLFNBQVMsQ0FBQTtRQUUxQyxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFBO1FBRzdELElBQUksR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksRUFBRSxFQUFFLENBQUMsQ0FBQTtRQUNyQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUztZQUNwQixxQkFBcUI7Z0JBQ3JCLHlCQUF5QixJQUFJLEtBQUssSUFBSSxXQUFXO2dCQUNqRCxTQUFTLENBQUMsQ0FBQTtJQUNkLENBQUMsQ0FBQyxDQUFBO0lBRUYsTUFBTSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUE7QUFDdEIsQ0FBQztBQUVELDBCQUEwQixJQUFZO0lBQ3BDLE1BQU0sR0FBRyxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUE7SUFDekMsR0FBRyxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUE7SUFDcEIsR0FBRyxDQUFDLGdCQUFnQixDQUFDLGFBQWEsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFO1FBQ25ELElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQTtJQUNmLENBQUMsQ0FBQyxDQUFBO0lBQ0YsTUFBTSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUE7QUFDdEIsQ0FBQztBQU9ELHVCQUF1QixJQUFZLEVBQUUsVUFBbUI7SUFDdEQsRUFBRSxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztRQUNmLElBQUksR0FBRyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUE7SUFDekIsQ0FBQztJQUNELEVBQUUsQ0FBQyxDQUFDLFVBQVUsRUFBRSxDQUFDLHNCQUFzQixDQUFDLENBQUMsQ0FBQztRQUN4QyxJQUFJLEdBQUcsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLENBQUE7SUFDL0IsQ0FBQztJQUNELE1BQU0sQ0FBQyxJQUFJLENBQUE7QUFDYixDQUFDO0FBT0Qsd0JBQXdCLEtBQWEsRUFBRSxJQUFZLEVBQUUsVUFBbUI7SUFDdEUsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUNWLE1BQU0sQ0FBQyxXQUFXLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxVQUFVLENBQUMsQ0FBQTtJQUM3QyxDQUFDO0lBQUMsSUFBSSxDQUFDLENBQUM7UUFDTixNQUFNLENBQUMsYUFBYSxDQUFDLElBQUksRUFBRSxVQUFVLENBQUMsQ0FBQTtJQUN4QyxDQUFDO0FBQ0gsQ0FBQztBQVFNLEtBQUssdUJBQ1YsSUFBWSxFQUNaLFFBQTRCLEVBQzVCLFVBQW1CLEVBQ25CLEVBQTRDO0lBRTVDLE1BQU0sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEdBQUcsZ0JBQWdCLENBQUMsUUFBUSxFQUFFLFVBQVUsQ0FBQyxDQUFBO0lBQzdELE1BQU0sQ0FBQyxJQUFJLE9BQU8sQ0FBSSxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtRQUN4QyxNQUFNLEVBQUUsR0FBRyxFQUFFLENBQUMsUUFBUSxDQUNwQixVQUFVLEVBQUUsQ0FBQyxVQUFVLEVBQ3ZCLFlBQVksQ0FBQyxJQUFJLENBQUMsRUFDbEIsSUFBSSxFQUNKLFVBQVMsS0FBSyxFQUFFLE1BQU0sRUFBRSxNQUFNO1lBQzVCLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7Z0JBQ1YsSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxFQUFFO29CQUM1QyxLQUFLLEVBQUUsS0FBSyxDQUFDLEtBQUs7b0JBQ2xCLFdBQVcsRUFBRSxJQUFJO2lCQUNsQixDQUFDLENBQUE7Z0JBQ0YsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFBO1lBQ2YsQ0FBQztZQUNELE1BQU0sTUFBTSxHQUFHLGNBQWMsQ0FBQyxNQUFNLElBQUksRUFBRSxFQUFFLE1BQU0sSUFBSSxFQUFFLEVBQUUsVUFBVSxDQUFDLENBQUE7WUFDckUsT0FBTyxDQUFDLEVBQUUsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQTtRQUMzQixDQUFDLENBQ0YsQ0FBQTtRQUNELEVBQUUsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQ3BCLEVBQUUsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUE7SUFDaEIsQ0FBQyxDQUFDLENBQUE7QUFDSixDQUFDO0FBM0JELG9DQTJCQztBQUVELHNCQUE2QixLQUFXO0lBQ3RDLE1BQU0sSUFBSSxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQ25CLEtBQUssRUFDTCxVQUFTLEdBQWEsRUFBRSxHQUFHLEVBQUUsR0FBRztRQUM5QixFQUFFLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMzQixNQUFNLElBQUksR0FBYSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQTtZQUN2QyxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxVQUFTLENBQVM7Z0JBQ2hDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ2xCLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQTtnQkFDM0IsQ0FBQztZQUNILENBQUMsQ0FBQyxDQUFBO1FBQ0osQ0FBQztRQUNELE1BQU0sQ0FBQyxHQUFHLENBQUE7SUFDWixDQUFDLEVBQ0QsRUFBRSxDQUNILENBQUE7SUFDRCxNQUFNLEdBQUcsR0FBYSxFQUFFLENBQUE7SUFDeEIsR0FBRyxDQUFDLENBQUMsTUFBTSxHQUFHLElBQUk7UUFDaEIsR0FBRyxJQUFJO1FBQ1AsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyx1Q0FBdUMsQ0FBRTtLQUM3RCxDQUFDLENBQUMsQ0FBQztRQUNGLE1BQU0sTUFBTSxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsc0JBQXNCLEVBQUUsT0FBTyxDQUFDLENBQUE7UUFDM0QsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQztZQUNoQyxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBQ2xCLENBQUM7SUFDSCxDQUFDO0lBQ0QsTUFBTSxDQUFDLEdBQUcsQ0FBQTtBQUNaLENBQUM7QUEzQkQsb0NBMkJDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIGRlY2FmZmVpbmF0ZSBzdWdnZXN0aW9uczpcbiAqIERTMTAyOiBSZW1vdmUgdW5uZWNlc3NhcnkgY29kZSBjcmVhdGVkIGJlY2F1c2Ugb2YgaW1wbGljaXQgcmV0dXJuc1xuICogRFMyMDc6IENvbnNpZGVyIHNob3J0ZXIgdmFyaWF0aW9ucyBvZiBudWxsIGNoZWNrc1xuICogRnVsbCBkb2NzOiBodHRwczovL2dpdGh1Yi5jb20vZGVjYWZmZWluYXRlL2RlY2FmZmVpbmF0ZS9ibG9iL21hc3Rlci9kb2NzL3N1Z2dlc3Rpb25zLm1kXG4gKi9cbmltcG9ydCBfID0gcmVxdWlyZSgnbG9kYXNoJylcbmltcG9ydCBDUCA9IHJlcXVpcmUoJ2NoaWxkX3Byb2Nlc3MnKVxuaW1wb3J0IGZzID0gcmVxdWlyZSgnZnMnKVxuaW1wb3J0IHBhdGggPSByZXF1aXJlKCdwYXRoJylcblxuY29uc3QgYXRvbUNvbmZpZyA9ICgpID0+IGF0b20uY29uZmlnLmdldCgnbWFya2Rvd24tcHJldmlldy1wbHVzJykhXG5cbi8qKlxuICogU2V0cyBsb2NhbCBtYXRoamF4UGF0aCBpZiBhdmFpbGFibGVcbiAqL1xuY29uc3QgZ2V0TWF0aEpheFBhdGggPSAoZnVuY3Rpb24oKSB7XG4gIGxldCBjYWNoZWQ6IHN0cmluZyB8IG51bGwgPSBudWxsXG4gIHJldHVybiBmdW5jdGlvbigpIHtcbiAgICBpZiAoY2FjaGVkICE9PSBudWxsKSB7XG4gICAgICByZXR1cm4gY2FjaGVkXG4gICAgfVxuICAgIHRyeSB7XG4gICAgICByZXR1cm4gKGNhY2hlZCA9IHJlcXVpcmUucmVzb2x2ZSgnTWF0aEpheCcpKVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHJldHVybiAnJ1xuICAgIH1cbiAgfVxufSkoKVxuXG5leHBvcnQgZnVuY3Rpb24gZmluZEZpbGVSZWN1cnNpdmUoXG4gIGZpbGVQYXRoOiBzdHJpbmcsXG4gIGZpbGVOYW1lOiBzdHJpbmcsXG4pOiBzdHJpbmcgfCBmYWxzZSB7XG4gIGNvbnN0IGJpYkZpbGUgPSBwYXRoLmpvaW4oZmlsZVBhdGgsICcuLi8nLCBmaWxlTmFtZSlcbiAgaWYgKGZzLmV4aXN0c1N5bmMoYmliRmlsZSkpIHtcbiAgICByZXR1cm4gYmliRmlsZVxuICB9IGVsc2Uge1xuICAgIGNvbnN0IG5ld1BhdGggPSBwYXRoLmpvaW4oYmliRmlsZSwgJy4uJylcbiAgICBpZiAobmV3UGF0aCAhPT0gZmlsZVBhdGggJiYgIV8uaW5jbHVkZXMoYXRvbS5wcm9qZWN0LmdldFBhdGhzKCksIG5ld1BhdGgpKSB7XG4gICAgICByZXR1cm4gZmluZEZpbGVSZWN1cnNpdmUobmV3UGF0aCwgZmlsZU5hbWUpXG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBmYWxzZVxuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFyZ3Mge1xuICBmcm9tOiBzdHJpbmdcbiAgdG86ICdodG1sJ1xuICBtYXRoamF4Pzogc3RyaW5nXG4gIGZpbHRlcjogc3RyaW5nW11cbiAgYmlibGlvZ3JhcGh5Pzogc3RyaW5nXG4gIGNzbD86IHN0cmluZ1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc2V0UGFuZG9jT3B0aW9ucyhcbiAgZmlsZVBhdGg6IHN0cmluZyB8IHVuZGVmaW5lZCxcbiAgcmVuZGVyTWF0aDogYm9vbGVhbixcbikge1xuICAvLyBzZWUgaHR0cHM6Ly9naXRodWIuY29tL2F0b20tY29tbXVuaXR5L21hcmtkb3duLXByZXZpZXctcGx1cy9pc3N1ZXMvMzE2XG4gIGNvbnN0IG9wdHM6IENQLkV4ZWNGaWxlT3B0aW9ucyA9IHsgbWF4QnVmZmVyOiBJbmZpbml0eSB9XG4gIGlmIChmaWxlUGF0aCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgb3B0cy5jd2QgPSBwYXRoLmRpcm5hbWUoZmlsZVBhdGgpXG4gIH1cbiAgY29uc3QgbWF0aGpheFBhdGggPSBnZXRNYXRoSmF4UGF0aCgpXG4gIGNvbnN0IGFyZ3M6IEFyZ3MgPSB7XG4gICAgZnJvbTogYXRvbUNvbmZpZygpLnBhbmRvY01hcmtkb3duRmxhdm9yLFxuICAgIHRvOiAnaHRtbCcsXG4gICAgbWF0aGpheDogcmVuZGVyTWF0aCA/IG1hdGhqYXhQYXRoIDogdW5kZWZpbmVkLFxuICAgIGZpbHRlcjogYXRvbUNvbmZpZygpLnBhbmRvY0ZpbHRlcnMsXG4gIH1cbiAgaWYgKGF0b21Db25maWcoKS5wYW5kb2NCaWJsaW9ncmFwaHkpIHtcbiAgICBhcmdzLmZpbHRlci5wdXNoKCdwYW5kb2MtY2l0ZXByb2MnKVxuICAgIGxldCBiaWJGaWxlID1cbiAgICAgIGZpbGVQYXRoICYmIGZpbmRGaWxlUmVjdXJzaXZlKGZpbGVQYXRoLCBhdG9tQ29uZmlnKCkucGFuZG9jQklCRmlsZSlcbiAgICBpZiAoIWJpYkZpbGUpIHtcbiAgICAgIGJpYkZpbGUgPSBhdG9tQ29uZmlnKCkucGFuZG9jQklCRmlsZUZhbGxiYWNrXG4gICAgfVxuICAgIGFyZ3MuYmlibGlvZ3JhcGh5ID0gYmliRmlsZSA/IGJpYkZpbGUgOiB1bmRlZmluZWRcbiAgICBsZXQgY3NsRmlsZSA9XG4gICAgICBmaWxlUGF0aCAmJiBmaW5kRmlsZVJlY3Vyc2l2ZShmaWxlUGF0aCwgYXRvbUNvbmZpZygpLnBhbmRvY0NTTEZpbGUpXG4gICAgaWYgKCFjc2xGaWxlKSB7XG4gICAgICBjc2xGaWxlID0gYXRvbUNvbmZpZygpLnBhbmRvY0NTTEZpbGVGYWxsYmFja1xuICAgIH1cbiAgICBhcmdzLmNzbCA9IGNzbEZpbGUgPyBjc2xGaWxlIDogdW5kZWZpbmVkXG4gIH1cbiAgcmV0dXJuIHsgYXJncywgb3B0cyB9XG59XG5cbi8qKlxuICogSGFuZGxlIGVycm9yIHJlc3BvbnNlIGZyb20gUGFuZG9jXG4gKiBAcGFyYW0ge2Vycm9yfSBSZXR1cm5lZCBlcnJvclxuICogQHBhcmFtIHtzdHJpbmd9IFJldHVybmVkIEhUTUxcbiAqIEByZXR1cm4ge2FycmF5fSB3aXRoIEFyZ3VtZW50cyBmb3IgY2FsbGJhY2tGdW5jdGlvbiAoZXJyb3Igc2V0IHRvIG51bGwpXG4gKi9cbmZ1bmN0aW9uIGhhbmRsZUVycm9yKGVycm9yOiBzdHJpbmcsIGh0bWw6IHN0cmluZywgcmVuZGVyTWF0aDogYm9vbGVhbikge1xuICBodG1sID0gYDxoMT5QYW5kb2MgRXJyb3I6PC9oMT48cHJlPiR7ZXJyb3J9PC9wcmU+PGhyPiR7aHRtbH1gXG4gIHJldHVybiBoYW5kbGVTdWNjZXNzKGh0bWwsIHJlbmRlck1hdGgpXG59XG5cbi8qKlxuICogQWRqdXN0cyBhbGwgbWF0aCBlbnZpcm9ubWVudHMgaW4gSFRNTFxuICogQHBhcmFtIHtzdHJpbmd9IEhUTUwgdG8gYmUgYWRqdXN0ZWRcbiAqIEByZXR1cm4ge3N0cmluZ30gSFRNTCB3aXRoIGFkanVzdGVkIG1hdGggZW52aXJvbm1lbnRzXG4gKi9cbmZ1bmN0aW9uIGhhbmRsZU1hdGgoaHRtbDogc3RyaW5nKSB7XG4gIGNvbnN0IGRvYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpXG4gIGRvYy5pbm5lckhUTUwgPSBodG1sXG4gIGRvYy5xdWVyeVNlbGVjdG9yQWxsKCcubWF0aCcpLmZvckVhY2goZnVuY3Rpb24oZWxlbSkge1xuICAgIGxldCBtYXRoID0gKGVsZW0gYXMgSFRNTEVsZW1lbnQpLmlubmVyVGV4dFxuICAgIC8vIFNldCBtb2RlIGlmIGl0IGlzIGJsb2NrIG1hdGhcbiAgICBjb25zdCBtb2RlID0gbWF0aC5pbmRleE9mKCdcXFxcWycpID4gLTEgPyAnOyBtb2RlPWRpc3BsYXknIDogJydcblxuICAgIC8vIFJlbW92ZSBzb3Vycm91bmRpbmcgXFxbIFxcXSBhbmQgXFwoIFxcKVxuICAgIG1hdGggPSBtYXRoLnJlcGxhY2UoL1xcXFxbWygpXFxdXS9nLCAnJylcbiAgICByZXR1cm4gKGVsZW0ub3V0ZXJIVE1MID1cbiAgICAgICc8c3BhbiBjbGFzcz1cIm1hdGhcIj4nICtcbiAgICAgIGA8c2NyaXB0IHR5cGU9J21hdGgvdGV4JHttb2RlfSc+JHttYXRofTwvc2NyaXB0PmAgK1xuICAgICAgJzwvc3Bhbj4nKVxuICB9KVxuXG4gIHJldHVybiBkb2MuaW5uZXJIVE1MXG59XG5cbmZ1bmN0aW9uIHJlbW92ZVJlZmVyZW5jZXMoaHRtbDogc3RyaW5nKSB7XG4gIGNvbnN0IGRvYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpXG4gIGRvYy5pbm5lckhUTUwgPSBodG1sXG4gIGRvYy5xdWVyeVNlbGVjdG9yQWxsKCcucmVmZXJlbmNlcycpLmZvckVhY2goKGVsZW0pID0+IHtcbiAgICBlbGVtLnJlbW92ZSgpXG4gIH0pXG4gIHJldHVybiBkb2MuaW5uZXJIVE1MXG59XG5cbi8qKlxuICogSGFuZGxlIHN1Y2Nlc3NmdWwgcmVzcG9uc2UgZnJvbSBQYW5kb2NcbiAqIEBwYXJhbSB7c3RyaW5nfSBSZXR1cm5lZCBIVE1MXG4gKiBAcmV0dXJuIHthcnJheX0gd2l0aCBBcmd1bWVudHMgZm9yIGNhbGxiYWNrRnVuY3Rpb24gKGVycm9yIHNldCB0byBudWxsKVxuICovXG5mdW5jdGlvbiBoYW5kbGVTdWNjZXNzKGh0bWw6IHN0cmluZywgcmVuZGVyTWF0aDogYm9vbGVhbikge1xuICBpZiAocmVuZGVyTWF0aCkge1xuICAgIGh0bWwgPSBoYW5kbGVNYXRoKGh0bWwpXG4gIH1cbiAgaWYgKGF0b21Db25maWcoKS5wYW5kb2NSZW1vdmVSZWZlcmVuY2VzKSB7XG4gICAgaHRtbCA9IHJlbW92ZVJlZmVyZW5jZXMoaHRtbClcbiAgfVxuICByZXR1cm4gaHRtbFxufVxuXG4vKipcbiAqIEhhbmRsZSByZXNwb25zZSBmcm9tIFBhbmRvY1xuICogQHBhcmFtIHtPYmplY3R9IGVycm9yIGlmIHRocm93blxuICogQHBhcmFtIHtzdHJpbmd9IFJldHVybmVkIEhUTUxcbiAqL1xuZnVuY3Rpb24gaGFuZGxlUmVzcG9uc2UoZXJyb3I6IHN0cmluZywgaHRtbDogc3RyaW5nLCByZW5kZXJNYXRoOiBib29sZWFuKSB7XG4gIGlmIChlcnJvcikge1xuICAgIHJldHVybiBoYW5kbGVFcnJvcihlcnJvciwgaHRtbCwgcmVuZGVyTWF0aClcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gaGFuZGxlU3VjY2VzcyhodG1sLCByZW5kZXJNYXRoKVxuICB9XG59XG5cbi8qKlxuICogUmVuZGVycyBtYXJrZG93biB3aXRoIHBhbmRvY1xuICogQHBhcmFtIHtzdHJpbmd9IGRvY3VtZW50IGluIG1hcmtkb3duXG4gKiBAcGFyYW0ge2Jvb2xlYW59IHdoZXRoZXIgdG8gcmVuZGVyIHRoZSBtYXRoIHdpdGggbWF0aGpheFxuICogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2tGdW5jdGlvblxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcmVuZGVyUGFuZG9jPFQ+KFxuICB0ZXh0OiBzdHJpbmcsXG4gIGZpbGVQYXRoOiBzdHJpbmcgfCB1bmRlZmluZWQsXG4gIHJlbmRlck1hdGg6IGJvb2xlYW4sXG4gIGNiOiAoZXJyOiBFcnJvciB8IG51bGwsIHJlc3VsdDogc3RyaW5nKSA9PiBULFxuKTogUHJvbWlzZTxUPiB7XG4gIGNvbnN0IHsgYXJncywgb3B0cyB9ID0gc2V0UGFuZG9jT3B0aW9ucyhmaWxlUGF0aCwgcmVuZGVyTWF0aClcbiAgcmV0dXJuIG5ldyBQcm9taXNlPFQ+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBjb25zdCBjcCA9IENQLmV4ZWNGaWxlKFxuICAgICAgYXRvbUNvbmZpZygpLnBhbmRvY1BhdGgsXG4gICAgICBnZXRBcmd1bWVudHMoYXJncyksXG4gICAgICBvcHRzLFxuICAgICAgZnVuY3Rpb24oZXJyb3IsIHN0ZG91dCwgc3RkZXJyKSB7XG4gICAgICAgIGlmIChlcnJvcikge1xuICAgICAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRFcnJvcihlcnJvci50b1N0cmluZygpLCB7XG4gICAgICAgICAgICBzdGFjazogZXJyb3Iuc3RhY2ssXG4gICAgICAgICAgICBkaXNtaXNzYWJsZTogdHJ1ZSxcbiAgICAgICAgICB9KVxuICAgICAgICAgIHJlamVjdChlcnJvcilcbiAgICAgICAgfVxuICAgICAgICBjb25zdCByZXN1bHQgPSBoYW5kbGVSZXNwb25zZShzdGRlcnIgfHwgJycsIHN0ZG91dCB8fCAnJywgcmVuZGVyTWF0aClcbiAgICAgICAgcmVzb2x2ZShjYihudWxsLCByZXN1bHQpKVxuICAgICAgfSxcbiAgICApXG4gICAgY3Auc3RkaW4ud3JpdGUodGV4dClcbiAgICBjcC5zdGRpbi5lbmQoKVxuICB9KVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0QXJndW1lbnRzKGlhcmdzOiBBcmdzKSB7XG4gIGNvbnN0IGFyZ3MgPSBfLnJlZHVjZShcbiAgICBpYXJncyxcbiAgICBmdW5jdGlvbihyZXM6IHN0cmluZ1tdLCB2YWwsIGtleSkge1xuICAgICAgaWYgKHZhbCAmJiAhXy5pc0VtcHR5KHZhbCkpIHtcbiAgICAgICAgY29uc3QgbnZhbDogc3RyaW5nW10gPSBfLmZsYXR0ZW4oW3ZhbF0pXG4gICAgICAgIF8uZm9yRWFjaChudmFsLCBmdW5jdGlvbih2OiBzdHJpbmcpIHtcbiAgICAgICAgICBpZiAoIV8uaXNFbXB0eSh2KSkge1xuICAgICAgICAgICAgcmVzLnB1c2goYC0tJHtrZXl9PSR7dn1gKVxuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICAgIHJldHVybiByZXNcbiAgICB9LFxuICAgIFtdLFxuICApXG4gIGNvbnN0IHJlczogc3RyaW5nW10gPSBbXVxuICBmb3IgKGNvbnN0IHZhbCBvZiBbXG4gICAgLi4uYXJncyxcbiAgICAuLi5hdG9tLmNvbmZpZy5nZXQoJ21hcmtkb3duLXByZXZpZXctcGx1cy5wYW5kb2NBcmd1bWVudHMnKSEsXG4gIF0pIHtcbiAgICBjb25zdCBuZXd2YWwgPSB2YWwucmVwbGFjZSgvXigtLVtcXHdcXC1dKylcXHMoLispJC9pLCAnJDE9JDInKVxuICAgIGlmIChuZXd2YWwuc3Vic3RyKDAsIDEpID09PSAnLScpIHtcbiAgICAgIHJlcy5wdXNoKG5ld3ZhbClcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHJlc1xufVxuIl19