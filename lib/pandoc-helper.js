"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const _ = require("lodash");
const CP = require("child_process");
const fs = require("fs");
const path = require("path");
const atomConfig = () => atom.config.get('markdown-preview-plus');
const getMathJaxPath = (function () {
    let cached = null;
    return function () {
        if (cached !== null) {
            return cached;
        }
        try {
            return (cached = require.resolve('mathjax'));
        }
        catch (e) {
            return '';
        }
    };
})();
function findFileRecursive(filePath, fileName) {
    const bibFile = path.join(filePath, '../', fileName);
    if (fs.existsSync(bibFile)) {
        return bibFile;
    }
    else {
        const newPath = path.join(bibFile, '..');
        if (newPath !== filePath && !_.includes(atom.project.getPaths(), newPath)) {
            return findFileRecursive(newPath, fileName);
        }
        else {
            return false;
        }
    }
}
function setPandocOptions(filePath, renderMath) {
    const opts = { maxBuffer: Infinity };
    if (filePath !== undefined) {
        opts.cwd = path.dirname(filePath);
    }
    const mathjaxPath = getMathJaxPath();
    const args = {
        from: atomConfig().pandocMarkdownFlavor,
        to: 'html',
        mathjax: renderMath ? mathjaxPath : undefined,
        filter: atomConfig().pandocFilters,
    };
    if (atomConfig().pandocBibliography) {
        args.filter.push('pandoc-citeproc');
        let bibFile = filePath && findFileRecursive(filePath, atomConfig().pandocBIBFile);
        if (!bibFile) {
            bibFile = atomConfig().pandocBIBFileFallback;
        }
        args.bibliography = bibFile ? bibFile : undefined;
        let cslFile = filePath && findFileRecursive(filePath, atomConfig().pandocCSLFile);
        if (!cslFile) {
            cslFile = atomConfig().pandocCSLFileFallback;
        }
        args.csl = cslFile ? cslFile : undefined;
    }
    return { args, opts };
}
function handleError(error, html, renderMath) {
    const err = new Error(error);
    err.html = handleSuccess(html, renderMath);
    throw err;
}
function handleMath(html) {
    const doc = document.createElement('div');
    doc.innerHTML = html;
    doc.querySelectorAll('.math').forEach(function (elem) {
        let math = elem.innerText;
        const mode = math.indexOf('\\[') > -1 ? '; mode=display' : '';
        math = math.replace(/\\[[()\]]/g, '');
        return (elem.outerHTML =
            '<span class="math">' +
                `<script type='math/tex${mode}'>${math}</script>` +
                '</span>');
    });
    return doc.innerHTML;
}
function removeReferences(html) {
    const doc = document.createElement('div');
    doc.innerHTML = html;
    doc.querySelectorAll('.references').forEach((elem) => {
        elem.remove();
    });
    return doc.innerHTML;
}
function handleSuccess(html, renderMath) {
    if (renderMath) {
        html = handleMath(html);
    }
    if (atomConfig().pandocRemoveReferences) {
        html = removeReferences(html);
    }
    return html;
}
function handleResponse(error, html, renderMath) {
    if (error) {
        return handleError(error, html, renderMath);
    }
    else {
        return handleSuccess(html, renderMath);
    }
}
async function renderPandoc(text, filePath, renderMath) {
    const { args, opts } = setPandocOptions(filePath, renderMath);
    return new Promise((resolve, reject) => {
        const cp = CP.execFile(atomConfig().pandocPath, getArguments(args), opts, function (error, stdout, stderr) {
            if (error) {
                atom.notifications.addError(error.toString(), {
                    stack: error.stack,
                    dismissable: true,
                });
                reject(error);
            }
            try {
                const result = handleResponse(stderr || '', stdout || '', renderMath);
                resolve(result);
            }
            catch (e) {
                reject(e);
            }
        });
        cp.stdin.write(text);
        cp.stdin.end();
    });
}
exports.renderPandoc = renderPandoc;
function getArguments(iargs) {
    const args = _.reduce(iargs, function (res, val, key) {
        if (val && !_.isEmpty(val)) {
            const nval = _.flatten([val]);
            _.forEach(nval, function (v) {
                if (!_.isEmpty(v)) {
                    res.push(`--${key}=${v}`);
                }
            });
        }
        return res;
    }, []);
    const res = [];
    for (const val of [
        ...args,
        ...atom.config.get('markdown-preview-plus.pandocArguments'),
    ]) {
        const newval = val.replace(/^(--[\w\-]+)\s(.+)$/i, '$1=$2');
        if (newval.substr(0, 1) === '-') {
            res.push(newval);
        }
    }
    return res;
}
exports.testing = {
    setPandocOptions,
    getArguments,
    findFileRecursive,
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFuZG9jLWhlbHBlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9wYW5kb2MtaGVscGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsNEJBQTRCO0FBQzVCLG9DQUFvQztBQUNwQyx5QkFBeUI7QUFDekIsNkJBQTZCO0FBRTdCLE1BQU0sVUFBVSxHQUFHLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLHVCQUF1QixDQUFFLENBQUE7QUFLbEUsTUFBTSxjQUFjLEdBQUcsQ0FBQztJQUN0QixJQUFJLE1BQU0sR0FBa0IsSUFBSSxDQUFBO0lBQ2hDLE9BQU87UUFDTCxJQUFJLE1BQU0sS0FBSyxJQUFJLEVBQUU7WUFDbkIsT0FBTyxNQUFNLENBQUE7U0FDZDtRQUNELElBQUk7WUFDRixPQUFPLENBQUMsTUFBTSxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQTtTQUM3QztRQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ1YsT0FBTyxFQUFFLENBQUE7U0FDVjtJQUNILENBQUMsQ0FBQTtBQUNILENBQUMsQ0FBQyxFQUFFLENBQUE7QUFFSiwyQkFBMkIsUUFBZ0IsRUFBRSxRQUFnQjtJQUMzRCxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxLQUFLLEVBQUUsUUFBUSxDQUFDLENBQUE7SUFDcEQsSUFBSSxFQUFFLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxFQUFFO1FBQzFCLE9BQU8sT0FBTyxDQUFBO0tBQ2Y7U0FBTTtRQUNMLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFBO1FBQ3hDLElBQUksT0FBTyxLQUFLLFFBQVEsSUFBSSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsRUFBRSxPQUFPLENBQUMsRUFBRTtZQUN6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TyxDQUFDLElBQUksRUFBRSxVQUFTLENBQVM7Z0JBQ2hDLElBQUksQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFO29CQUNqQixHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUE7aUJBQzFCO1lBQ0gsQ0FBQyxDQUFDLENBQUE7U0FDSDtRQUNELE9BQU8sR0FBRyxDQUFBO0lBQ1osQ0FBQyxFQUNELEVBQUUsQ0FDSCxDQUFBO0lBQ0QsTUFBTSxHQUFHLEdBQWEsRUFBRSxDQUFBO0lBQ3hCLEtBQUssTUFBTSxHQUFHLElBQUk7UUFDaEIsR0FBRyxJQUFJO1FBQ1AsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyx1Q0FBdUMsQ0FBRTtLQUM3RCxFQUFFO1FBQ0QsTUFBTSxNQUFNLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxzQkFBc0IsRUFBRSxPQUFPLENBQUMsQ0FBQTtRQUMzRCxJQUFJLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxLQUFLLEdBQUcsRUFBRTtZQUMvQixHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1NBQ2pCO0tBQ0Y7SUFDRCxPQUFPLEdBQUcsQ0FBQTtBQUNaLENBQUM7QUFFWSxRQUFBLE9BQU8sR0FBRztJQUNyQixnQkFBZ0I7SUFDaEIsWUFBWTtJQUNaLGlCQUFpQjtDQUNsQixDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gPSByZXF1aXJlKCdsb2Rhc2gnKVxuaW1wb3J0IENQID0gcmVxdWlyZSgnY2hpbGRfcHJvY2VzcycpXG5pbXBvcnQgZnMgPSByZXF1aXJlKCdmcycpXG5pbXBvcnQgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKVxuXG5jb25zdCBhdG9tQ29uZmlnID0gKCkgPT4gYXRvbS5jb25maWcuZ2V0KCdtYXJrZG93bi1wcmV2aWV3LXBsdXMnKSFcblxuLyoqXG4gKiBTZXRzIGxvY2FsIG1hdGhqYXhQYXRoIGlmIGF2YWlsYWJsZVxuICovXG5jb25zdCBnZXRNYXRoSmF4UGF0aCA9IChmdW5jdGlvbigpIHtcbiAgbGV0IGNhY2hlZDogc3RyaW5nIHwgbnVsbCA9IG51bGxcbiAgcmV0dXJuIGZ1bmN0aW9uKCkge1xuICAgIGlmIChjYWNoZWQgIT09IG51bGwpIHtcbiAgICAgIHJldHVybiBjYWNoZWRcbiAgICB9XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiAoY2FjaGVkID0gcmVxdWlyZS5yZXNvbHZlKCdtYXRoamF4JykpXG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgcmV0dXJuICcnXG4gICAgfVxuICB9XG59KSgpXG5cbmZ1bmN0aW9uIGZpbmRGaWxlUmVjdXJzaXZlKGZpbGVQYXRoOiBzdHJpbmcsIGZpbGVOYW1lOiBzdHJpbmcpOiBzdHJpbmcgfCBmYWxzZSB7XG4gIGNvbnN0IGJpYkZpbGUgPSBwYXRoLmpvaW4oZmlsZVBhdGgsICcuLi8nLCBmaWxlTmFtZSlcbiAgaWYgKGZzLmV4aXN0c1N5bmMoYmliRmlsZSkpIHtcbiAgICByZXR1cm4gYmliRmlsZVxuICB9IGVsc2Uge1xuICAgIGNvbnN0IG5ld1BhdGggPSBwYXRoLmpvaW4oYmliRmlsZSwgJy4uJylcbiAgICBpZiAobmV3UGF0aCAhPT0gZmlsZVBhdGggJiYgIV8uaW5jbHVkZXMoYXRvbS5wcm9qZWN0LmdldFBhdGhzKCksIG5ld1BhdGgpKSB7XG4gICAgICByZXR1cm4gZmluZEZpbGVSZWN1cnNpdmUobmV3UGF0aCwgZmlsZU5hbWUpXG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBmYWxzZVxuICAgIH1cbiAgfVxufVxuXG4vLyBleHBvcnRlZCBmb3IgdGVzdHNcbmV4cG9ydCBpbnRlcmZhY2UgQXJncyB7XG4gIGZyb206IHN0cmluZ1xuICB0bzogJ2h0bWwnXG4gIG1hdGhqYXg/OiBzdHJpbmdcbiAgZmlsdGVyOiBzdHJpbmdbXVxuICBiaWJsaW9ncmFwaHk/OiBzdHJpbmdcbiAgY3NsPzogc3RyaW5nXG59XG5cbmZ1bmN0aW9uIHNldFBhbmRvY09wdGlvbnMoZmlsZVBhdGg6IHN0cmluZyB8IHVuZGVmaW5lZCwgcmVuZGVyTWF0aDogYm9vbGVhbikge1xuICAvLyBzZWUgaHR0cHM6Ly9naXRodWIuY29tL2F0b20tY29tbXVuaXR5L21hcmtkb3duLXByZXZpZXctcGx1cy9pc3N1ZXMvMzE2XG4gIGNvbnN0IG9wdHM6IENQLkV4ZWNGaWxlT3B0aW9ucyA9IHsgbWF4QnVmZmVyOiBJbmZpbml0eSB9XG4gIGlmIChmaWxlUGF0aCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgb3B0cy5jd2QgPSBwYXRoLmRpcm5hbWUoZmlsZVBhdGgpXG4gIH1cbiAgY29uc3QgbWF0aGpheFBhdGggPSBnZXRNYXRoSmF4UGF0aCgpXG4gIGNvbnN0IGFyZ3M6IEFyZ3MgPSB7XG4gICAgZnJvbTogYXRvbUNvbmZpZygpLnBhbmRvY01hcmtkb3duRmxhdm9yLFxuICAgIHRvOiAnaHRtbCcsXG4gICAgbWF0aGpheDogcmVuZGVyTWF0aCA/IG1hdGhqYXhQYXRoIDogdW5kZWZpbmVkLFxuICAgIGZpbHRlcjogYXRvbUNvbmZpZygpLnBhbmRvY0ZpbHRlcnMsXG4gIH1cbiAgaWYgKGF0b21Db25maWcoKS5wYW5kb2NCaWJsaW9ncmFwaHkpIHtcbiAgICBhcmdzLmZpbHRlci5wdXNoKCdwYW5kb2MtY2l0ZXByb2MnKVxuICAgIGxldCBiaWJGaWxlID1cbiAgICAgIGZpbGVQYXRoICYmIGZpbmRGaWxlUmVjdXJzaXZlKGZpbGVQYXRoLCBhdG9tQ29uZmlnKCkucGFuZG9jQklCRmlsZSlcbiAgICBpZiAoIWJpYkZpbGUpIHtcbiAgICAgIGJpYkZpbGUgPSBhdG9tQ29uZmlnKCkucGFuZG9jQklCRmlsZUZhbGxiYWNrXG4gICAgfVxuICAgIGFyZ3MuYmlibGlvZ3JhcGh5ID0gYmliRmlsZSA/IGJpYkZpbGUgOiB1bmRlZmluZWRcbiAgICBsZXQgY3NsRmlsZSA9XG4gICAgICBmaWxlUGF0aCAmJiBmaW5kRmlsZVJlY3Vyc2l2ZShmaWxlUGF0aCwgYXRvbUNvbmZpZygpLnBhbmRvY0NTTEZpbGUpXG4gICAgaWYgKCFjc2xGaWxlKSB7XG4gICAgICBjc2xGaWxlID0gYXRvbUNvbmZpZygpLnBhbmRvY0NTTEZpbGVGYWxsYmFja1xuICAgIH1cbiAgICBhcmdzLmNzbCA9IGNzbEZpbGUgPyBjc2xGaWxlIDogdW5kZWZpbmVkXG4gIH1cbiAgcmV0dXJuIHsgYXJncywgb3B0cyB9XG59XG5cbi8qKlxuICogSGFuZGxlIGVycm9yIHJlc3BvbnNlIGZyb20gUGFuZG9jXG4gKiBAcGFyYW0ge2Vycm9yfSBSZXR1cm5lZCBlcnJvclxuICogQHBhcmFtIHtzdHJpbmd9IFJldHVybmVkIEhUTUxcbiAqIEByZXR1cm4ge2FycmF5fSB3aXRoIEFyZ3VtZW50cyBmb3IgY2FsbGJhY2tGdW5jdGlvbiAoZXJyb3Igc2V0IHRvIG51bGwpXG4gKi9cbmZ1bmN0aW9uIGhhbmRsZUVycm9yKGVycm9yOiBzdHJpbmcsIGh0bWw6IHN0cmluZywgcmVuZGVyTWF0aDogYm9vbGVhbik6IG5ldmVyIHtcbiAgY29uc3QgZXJyID0gbmV3IEVycm9yKGVycm9yKSBhcyBFcnJvciAmIHsgaHRtbDogc3RyaW5nIH1cbiAgZXJyLmh0bWwgPSBoYW5kbGVTdWNjZXNzKGh0bWwsIHJlbmRlck1hdGgpXG4gIHRocm93IGVyclxufVxuXG4vKipcbiAqIEFkanVzdHMgYWxsIG1hdGggZW52aXJvbm1lbnRzIGluIEhUTUxcbiAqIEBwYXJhbSB7c3RyaW5nfSBIVE1MIHRvIGJlIGFkanVzdGVkXG4gKiBAcmV0dXJuIHtzdHJpbmd9IEhUTUwgd2l0aCBhZGp1c3RlZCBtYXRoIGVudmlyb25tZW50c1xuICovXG5mdW5jdGlvbiBoYW5kbGVNYXRoKGh0bWw6IHN0cmluZyk6IHN0cmluZyB7XG4gIGNvbnN0IGRvYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpXG4gIGRvYy5pbm5lckhUTUwgPSBodG1sXG4gIGRvYy5xdWVyeVNlbGVjdG9yQWxsKCcubWF0aCcpLmZvckVhY2goZnVuY3Rpb24oZWxlbSkge1xuICAgIGxldCBtYXRoID0gKGVsZW0gYXMgSFRNTEVsZW1lbnQpLmlubmVyVGV4dFxuICAgIC8vIFNldCBtb2RlIGlmIGl0IGlzIGJsb2NrIG1hdGhcbiAgICBjb25zdCBtb2RlID0gbWF0aC5pbmRleE9mKCdcXFxcWycpID4gLTEgPyAnOyBtb2RlPWRpc3BsYXknIDogJydcblxuICAgIC8vIFJlbW92ZSBzb3Vycm91bmRpbmcgXFxbIFxcXSBhbmQgXFwoIFxcKVxuICAgIG1hdGggPSBtYXRoLnJlcGxhY2UoL1xcXFxbWygpXFxdXS9nLCAnJylcbiAgICByZXR1cm4gKGVsZW0ub3V0ZXJIVE1MID1cbiAgICAgICc8c3BhbiBjbGFzcz1cIm1hdGhcIj4nICtcbiAgICAgIGA8c2NyaXB0IHR5cGU9J21hdGgvdGV4JHttb2RlfSc+JHttYXRofTwvc2NyaXB0PmAgK1xuICAgICAgJzwvc3Bhbj4nKVxuICB9KVxuXG4gIHJldHVybiBkb2MuaW5uZXJIVE1MXG59XG5cbmZ1bmN0aW9uIHJlbW92ZVJlZmVyZW5jZXMoaHRtbDogc3RyaW5nKSB7XG4gIGNvbnN0IGRvYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpXG4gIGRvYy5pbm5lckhUTUwgPSBodG1sXG4gIGRvYy5xdWVyeVNlbGVjdG9yQWxsKCcucmVmZXJlbmNlcycpLmZvckVhY2goKGVsZW0pID0+IHtcbiAgICBlbGVtLnJlbW92ZSgpXG4gIH0pXG4gIHJldHVybiBkb2MuaW5uZXJIVE1MXG59XG5cbi8qKlxuICogSGFuZGxlIHN1Y2Nlc3NmdWwgcmVzcG9uc2UgZnJvbSBQYW5kb2NcbiAqIEBwYXJhbSBSZXR1cm5lZCBIVE1MXG4gKiBAcmV0dXJuIFBvc3NpYmx5IG1vZGlmaWVkIHJldHVybmVkIEhUTUxcbiAqL1xuZnVuY3Rpb24gaGFuZGxlU3VjY2VzcyhodG1sOiBzdHJpbmcsIHJlbmRlck1hdGg6IGJvb2xlYW4pOiBzdHJpbmcge1xuICBpZiAocmVuZGVyTWF0aCkge1xuICAgIGh0bWwgPSBoYW5kbGVNYXRoKGh0bWwpXG4gIH1cbiAgaWYgKGF0b21Db25maWcoKS5wYW5kb2NSZW1vdmVSZWZlcmVuY2VzKSB7XG4gICAgaHRtbCA9IHJlbW92ZVJlZmVyZW5jZXMoaHRtbClcbiAgfVxuICByZXR1cm4gaHRtbFxufVxuXG4vKipcbiAqIEhhbmRsZSByZXNwb25zZSBmcm9tIFBhbmRvY1xuICogQHBhcmFtIHtPYmplY3R9IGVycm9yIGlmIHRocm93blxuICogQHBhcmFtIHtzdHJpbmd9IFJldHVybmVkIEhUTUxcbiAqL1xuZnVuY3Rpb24gaGFuZGxlUmVzcG9uc2UoZXJyb3I6IHN0cmluZywgaHRtbDogc3RyaW5nLCByZW5kZXJNYXRoOiBib29sZWFuKSB7XG4gIGlmIChlcnJvcikge1xuICAgIHJldHVybiBoYW5kbGVFcnJvcihlcnJvciwgaHRtbCwgcmVuZGVyTWF0aClcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gaGFuZGxlU3VjY2VzcyhodG1sLCByZW5kZXJNYXRoKVxuICB9XG59XG5cbi8qKlxuICogUmVuZGVycyBtYXJrZG93biB3aXRoIHBhbmRvY1xuICogQHBhcmFtIHtzdHJpbmd9IGRvY3VtZW50IGluIG1hcmtkb3duXG4gKiBAcGFyYW0ge2Jvb2xlYW59IHdoZXRoZXIgdG8gcmVuZGVyIHRoZSBtYXRoIHdpdGggbWF0aGpheFxuICogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2tGdW5jdGlvblxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcmVuZGVyUGFuZG9jKFxuICB0ZXh0OiBzdHJpbmcsXG4gIGZpbGVQYXRoOiBzdHJpbmcgfCB1bmRlZmluZWQsXG4gIHJlbmRlck1hdGg6IGJvb2xlYW4sXG4pOiBQcm9taXNlPHN0cmluZz4ge1xuICBjb25zdCB7IGFyZ3MsIG9wdHMgfSA9IHNldFBhbmRvY09wdGlvbnMoZmlsZVBhdGgsIHJlbmRlck1hdGgpXG4gIHJldHVybiBuZXcgUHJvbWlzZTxzdHJpbmc+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBjb25zdCBjcCA9IENQLmV4ZWNGaWxlKFxuICAgICAgYXRvbUNvbmZpZygpLnBhbmRvY1BhdGgsXG4gICAgICBnZXRBcmd1bWVudHMoYXJncyksXG4gICAgICBvcHRzLFxuICAgICAgZnVuY3Rpb24oZXJyb3IsIHN0ZG91dCwgc3RkZXJyKSB7XG4gICAgICAgIGlmIChlcnJvcikge1xuICAgICAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRFcnJvcihlcnJvci50b1N0cmluZygpLCB7XG4gICAgICAgICAgICBzdGFjazogZXJyb3Iuc3RhY2ssXG4gICAgICAgICAgICBkaXNtaXNzYWJsZTogdHJ1ZSxcbiAgICAgICAgICB9KVxuICAgICAgICAgIHJlamVjdChlcnJvcilcbiAgICAgICAgfVxuICAgICAgICB0cnkge1xuICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGhhbmRsZVJlc3BvbnNlKHN0ZGVyciB8fCAnJywgc3Rkb3V0IHx8ICcnLCByZW5kZXJNYXRoKVxuICAgICAgICAgIHJlc29sdmUocmVzdWx0KVxuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgcmVqZWN0KGUpXG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgKVxuICAgIGNwLnN0ZGluLndyaXRlKHRleHQpXG4gICAgY3Auc3RkaW4uZW5kKClcbiAgfSlcbn1cblxuZnVuY3Rpb24gZ2V0QXJndW1lbnRzKGlhcmdzOiBBcmdzKSB7XG4gIGNvbnN0IGFyZ3MgPSBfLnJlZHVjZShcbiAgICBpYXJncyxcbiAgICBmdW5jdGlvbihyZXM6IHN0cmluZ1tdLCB2YWwsIGtleSkge1xuICAgICAgaWYgKHZhbCAmJiAhXy5pc0VtcHR5KHZhbCkpIHtcbiAgICAgICAgY29uc3QgbnZhbDogc3RyaW5nW10gPSBfLmZsYXR0ZW4oW3ZhbF0pXG4gICAgICAgIF8uZm9yRWFjaChudmFsLCBmdW5jdGlvbih2OiBzdHJpbmcpIHtcbiAgICAgICAgICBpZiAoIV8uaXNFbXB0eSh2KSkge1xuICAgICAgICAgICAgcmVzLnB1c2goYC0tJHtrZXl9PSR7dn1gKVxuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICAgIHJldHVybiByZXNcbiAgICB9LFxuICAgIFtdLFxuICApXG4gIGNvbnN0IHJlczogc3RyaW5nW10gPSBbXVxuICBmb3IgKGNvbnN0IHZhbCBvZiBbXG4gICAgLi4uYXJncyxcbiAgICAuLi5hdG9tLmNvbmZpZy5nZXQoJ21hcmtkb3duLXByZXZpZXctcGx1cy5wYW5kb2NBcmd1bWVudHMnKSEsXG4gIF0pIHtcbiAgICBjb25zdCBuZXd2YWwgPSB2YWwucmVwbGFjZSgvXigtLVtcXHdcXC1dKylcXHMoLispJC9pLCAnJDE9JDInKVxuICAgIGlmIChuZXd2YWwuc3Vic3RyKDAsIDEpID09PSAnLScpIHtcbiAgICAgIHJlcy5wdXNoKG5ld3ZhbClcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHJlc1xufVxuXG5leHBvcnQgY29uc3QgdGVzdGluZyA9IHtcbiAgc2V0UGFuZG9jT3B0aW9ucyxcbiAgZ2V0QXJndW1lbnRzLFxuICBmaW5kRmlsZVJlY3Vyc2l2ZSxcbn1cbiJdfQ==