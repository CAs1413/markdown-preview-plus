"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const _ = require("lodash");
const CP = require("child_process");
const fs = require("fs");
const path = require("path");
const atomConfig = () => atom.config.get('markdown-preview-plus');
const getMathJaxPath = (function () {
    let cached = null;
    return function () {
        if (cached !== null) {
            return cached;
        }
        try {
            return (cached = require.resolve('MathJax'));
        }
        catch (e) {
            return '';
        }
    };
})();
function findFileRecursive(filePath, fileName) {
    const bibFile = path.join(filePath, '../', fileName);
    if (fs.existsSync(bibFile)) {
        return bibFile;
    }
    else {
        const newPath = path.join(bibFile, '..');
        if (newPath !== filePath && !_.includes(atom.project.getPaths(), newPath)) {
            return findFileRecursive(newPath, fileName);
        }
        else {
            return false;
        }
    }
}
exports.findFileRecursive = findFileRecursive;
function setPandocOptions(filePath, renderMath) {
    const opts = { maxBuffer: Infinity };
    if (filePath !== undefined) {
        opts.cwd = path.dirname(filePath);
    }
    const mathjaxPath = getMathJaxPath();
    const args = {
        from: atomConfig().pandocMarkdownFlavor,
        to: 'html',
        mathjax: renderMath ? mathjaxPath : undefined,
        filter: atomConfig().pandocFilters,
    };
    if (atomConfig().pandocBibliography) {
        args.filter.push('pandoc-citeproc');
        let bibFile = filePath && findFileRecursive(filePath, atomConfig().pandocBIBFile);
        if (!bibFile) {
            bibFile = atomConfig().pandocBIBFileFallback;
        }
        args.bibliography = bibFile ? bibFile : undefined;
        let cslFile = filePath && findFileRecursive(filePath, atomConfig().pandocCSLFile);
        if (!cslFile) {
            cslFile = atomConfig().pandocCSLFileFallback;
        }
        args.csl = cslFile ? cslFile : undefined;
    }
    return { args, opts };
}
exports.setPandocOptions = setPandocOptions;
function handleError(error, html, renderMath) {
    html = `<h1>Pandoc Error:</h1><pre>${error}</pre><hr>${html}`;
    return handleSuccess(html, renderMath);
}
function handleMath(html) {
    const doc = document.createElement('div');
    doc.innerHTML = html;
    doc.querySelectorAll('.math').forEach(function (elem) {
        let math = elem.innerText;
        const mode = math.indexOf('\\[') > -1 ? '; mode=display' : '';
        math = math.replace(/\\[[()\]]/g, '');
        return (elem.outerHTML =
            '<span class="math">' +
                `<script type='math/tex${mode}'>${math}</script>` +
                '</span>');
    });
    return doc.innerHTML;
}
function removeReferences(html) {
    const doc = document.createElement('div');
    doc.innerHTML = html;
    doc.querySelectorAll('.references').forEach((elem) => {
        elem.remove();
    });
    return doc.innerHTML;
}
function handleSuccess(html, renderMath) {
    if (renderMath) {
        html = handleMath(html);
    }
    if (atomConfig().pandocRemoveReferences) {
        html = removeReferences(html);
    }
    return html;
}
function handleResponse(error, html, renderMath) {
    if (error) {
        return handleError(error, html, renderMath);
    }
    else {
        return handleSuccess(html, renderMath);
    }
}
async function renderPandoc(text, filePath, renderMath) {
    const { args, opts } = setPandocOptions(filePath, renderMath);
    return new Promise((resolve, reject) => {
        const cp = CP.execFile(atomConfig().pandocPath, getArguments(args), opts, function (error, stdout, stderr) {
            if (error) {
                atom.notifications.addError(error.toString(), {
                    stack: error.stack,
                    dismissable: true,
                });
                reject(error);
            }
            const result = handleResponse(stderr || '', stdout || '', renderMath);
            resolve(result);
        });
        cp.stdin.write(text);
        cp.stdin.end();
    });
}
exports.renderPandoc = renderPandoc;
function getArguments(iargs) {
    const args = _.reduce(iargs, function (res, val, key) {
        if (val && !_.isEmpty(val)) {
            const nval = _.flatten([val]);
            _.forEach(nval, function (v) {
                if (!_.isEmpty(v)) {
                    res.push(`--${key}=${v}`);
                }
            });
        }
        return res;
    }, []);
    const res = [];
    for (const val of [
        ...args,
        ...atom.config.get('markdown-preview-plus.pandocArguments'),
    ]) {
        const newval = val.replace(/^(--[\w\-]+)\s(.+)$/i, '$1=$2');
        if (newval.substr(0, 1) === '-') {
            res.push(newval);
        }
    }
    return res;
}
exports.getArguments = getArguments;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFuZG9jLWhlbHBlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9wYW5kb2MtaGVscGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsNEJBQTRCO0FBQzVCLG9DQUFvQztBQUNwQyx5QkFBeUI7QUFDekIsNkJBQTZCO0FBRTdCLE1BQU0sVUFBVSxHQUFHLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLHVCQUF1QixDQUFFLENBQUE7QUFLbEUsTUFBTSxjQUFjLEdBQUcsQ0FBQztJQUN0QixJQUFJLE1BQU0sR0FBa0IsSUFBSSxDQUFBO0lBQ2hDLE1BQU0sQ0FBQztRQUNMLEVBQUUsQ0FBQyxDQUFDLE1BQU0sS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ3BCLE1BQU0sQ0FBQyxNQUFNLENBQUE7UUFDZixDQUFDO1FBQ0QsSUFBSSxDQUFDO1lBQ0gsTUFBTSxDQUFDLENBQUMsTUFBTSxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQTtRQUM5QyxDQUFDO1FBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNYLE1BQU0sQ0FBQyxFQUFFLENBQUE7UUFDWCxDQUFDO0lBQ0gsQ0FBQyxDQUFBO0FBQ0gsQ0FBQyxDQUFDLEVBQUUsQ0FBQTtBQUVKLDJCQUNFLFFBQWdCLEVBQ2hCLFFBQWdCO0lBRWhCLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLEtBQUssRUFBRSxRQUFRLENBQUMsQ0FBQTtJQUNwRCxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMzQixNQUFNLENBQUMsT0FBTyxDQUFBO0lBQ2hCLENBQUM7SUFBQyxJQUFJLENBQUMsQ0FBQztRQUNOLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFF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QUFDLENBQUMsRUFBRSxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ2hDLEdBQUcsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUE7UUFDbEIsQ0FBQztJQUNILENBQUM7SUFDRCxNQUFNLENBQUMsR0FBRyxDQUFBO0FBQ1osQ0FBQztBQTNCRCxvQ0EyQkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpXG5pbXBvcnQgQ1AgPSByZXF1aXJlKCdjaGlsZF9wcm9jZXNzJylcbmltcG9ydCBmcyA9IHJlcXVpcmUoJ2ZzJylcbmltcG9ydCBwYXRoID0gcmVxdWlyZSgncGF0aCcpXG5cbmNvbnN0IGF0b21Db25maWcgPSAoKSA9PiBhdG9tLmNvbmZpZy5nZXQoJ21hcmtkb3duLXByZXZpZXctcGx1cycpIVxuXG4vKipcbiAqIFNldHMgbG9jYWwgbWF0aGpheFBhdGggaWYgYXZhaWxhYmxlXG4gKi9cbmNvbnN0IGdldE1hdGhKYXhQYXRoID0gKGZ1bmN0aW9uKCkge1xuICBsZXQgY2FjaGVkOiBzdHJpbmcgfCBudWxsID0gbnVsbFxuICByZXR1cm4gZnVuY3Rpb24oKSB7XG4gICAgaWYgKGNhY2hlZCAhPT0gbnVsbCkge1xuICAgICAgcmV0dXJuIGNhY2hlZFxuICAgIH1cbiAgICB0cnkge1xuICAgICAgcmV0dXJuIChjYWNoZWQgPSByZXF1aXJlLnJlc29sdmUoJ01hdGhKYXgnKSlcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICByZXR1cm4gJydcbiAgICB9XG4gIH1cbn0pKClcblxuZXhwb3J0IGZ1bmN0aW9uIGZpbmRGaWxlUmVjdXJzaXZlKFxuICBmaWxlUGF0aDogc3RyaW5nLFxuICBmaWxlTmFtZTogc3RyaW5nLFxuKTogc3RyaW5nIHwgZmFsc2Uge1xuICBjb25zdCBiaWJGaWxlID0gcGF0aC5qb2luKGZpbGVQYXRoLCAnLi4vJywgZmlsZU5hbWUpXG4gIGlmIChmcy5leGlzdHNTeW5jKGJpYkZpbGUpKSB7XG4gICAgcmV0dXJuIGJpYkZpbGVcbiAgfSBlbHNlIHtcbiAgICBjb25zdCBuZXdQYXRoID0gcGF0aC5qb2luKGJpYkZpbGUsICcuLicpXG4gICAgaWYgKG5ld1BhdGggIT09IGZpbGVQYXRoICYmICFfLmluY2x1ZGVzKGF0b20ucHJvamVjdC5nZXRQYXRocygpLCBuZXdQYXRoKSkge1xuICAgICAgcmV0dXJuIGZpbmRGaWxlUmVjdXJzaXZlKG5ld1BhdGgsIGZpbGVOYW1lKVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGludGVyZmFjZSBBcmdzIHtcbiAgZnJvbTogc3RyaW5nXG4gIHRvOiAnaHRtbCdcbiAgbWF0aGpheD86IHN0cmluZ1xuICBmaWx0ZXI6IHN0cmluZ1tdXG4gIGJpYmxpb2dyYXBoeT86IHN0cmluZ1xuICBjc2w/OiBzdHJpbmdcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNldFBhbmRvY09wdGlvbnMoXG4gIGZpbGVQYXRoOiBzdHJpbmcgfCB1bmRlZmluZWQsXG4gIHJlbmRlck1hdGg6IGJvb2xlYW4sXG4pIHtcbiAgLy8gc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9hdG9tLWNvbW11bml0eS9tYXJrZG93bi1wcmV2aWV3LXBsdXMvaXNzdWVzLzMxNlxuICBjb25zdCBvcHRzOiBDUC5FeGVjRmlsZU9wdGlvbnMgPSB7IG1heEJ1ZmZlcjogSW5maW5pdHkgfVxuICBpZiAoZmlsZVBhdGggIT09IHVuZGVmaW5lZCkge1xuICAgIG9wdHMuY3dkID0gcGF0aC5kaXJuYW1lKGZpbGVQYXRoKVxuICB9XG4gIGNvbnN0IG1hdGhqYXhQYXRoID0gZ2V0TWF0aEpheFBhdGgoKVxuICBjb25zdCBhcmdzOiBBcmdzID0ge1xuICAgIGZyb206IGF0b21Db25maWcoKS5wYW5kb2NNYXJrZG93bkZsYXZvcixcbiAgICB0bzogJ2h0bWwnLFxuICAgIG1hdGhqYXg6IHJlbmRlck1hdGggPyBtYXRoamF4UGF0aCA6IHVuZGVmaW5lZCxcbiAgICBmaWx0ZXI6IGF0b21Db25maWcoKS5wYW5kb2NGaWx0ZXJzLFxuICB9XG4gIGlmIChhdG9tQ29uZmlnKCkucGFuZG9jQmlibGlvZ3JhcGh5KSB7XG4gICAgYXJncy5maWx0ZXIucHVzaCgncGFuZG9jLWNpdGVwcm9jJylcbiAgICBsZXQgYmliRmlsZSA9XG4gICAgICBmaWxlUGF0aCAmJiBmaW5kRmlsZVJlY3Vyc2l2ZShmaWxlUGF0aCwgYXRvbUNvbmZpZygpLnBhbmRvY0JJQkZpbGUpXG4gICAgaWYgKCFiaWJGaWxlKSB7XG4gICAgICBiaWJGaWxlID0gYXRvbUNvbmZpZygpLnBhbmRvY0JJQkZpbGVGYWxsYmFja1xuICAgIH1cbiAgICBhcmdzLmJpYmxpb2dyYXBoeSA9IGJpYkZpbGUgPyBiaWJGaWxlIDogdW5kZWZpbmVkXG4gICAgbGV0IGNzbEZpbGUgPVxuICAgICAgZmlsZVBhdGggJiYgZmluZEZpbGVSZWN1cnNpdmUoZmlsZVBhdGgsIGF0b21Db25maWcoKS5wYW5kb2NDU0xGaWxlKVxuICAgIGlmICghY3NsRmlsZSkge1xuICAgICAgY3NsRmlsZSA9IGF0b21Db25maWcoKS5wYW5kb2NDU0xGaWxlRmFsbGJhY2tcbiAgICB9XG4gICAgYXJncy5jc2wgPSBjc2xGaWxlID8gY3NsRmlsZSA6IHVuZGVmaW5lZFxuICB9XG4gIHJldHVybiB7IGFyZ3MsIG9wdHMgfVxufVxuXG4vKipcbiAqIEhhbmRsZSBlcnJvciByZXNwb25zZSBmcm9tIFBhbmRvY1xuICogQHBhcmFtIHtlcnJvcn0gUmV0dXJuZWQgZXJyb3JcbiAqIEBwYXJhbSB7c3RyaW5nfSBSZXR1cm5lZCBIVE1MXG4gKiBAcmV0dXJuIHthcnJheX0gd2l0aCBBcmd1bWVudHMgZm9yIGNhbGxiYWNrRnVuY3Rpb24gKGVycm9yIHNldCB0byBudWxsKVxuICovXG5mdW5jdGlvbiBoYW5kbGVFcnJvcihlcnJvcjogc3RyaW5nLCBodG1sOiBzdHJpbmcsIHJlbmRlck1hdGg6IGJvb2xlYW4pIHtcbiAgaHRtbCA9IGA8aDE+UGFuZG9jIEVycm9yOjwvaDE+PHByZT4ke2Vycm9yfTwvcHJlPjxocj4ke2h0bWx9YFxuICByZXR1cm4gaGFuZGxlU3VjY2VzcyhodG1sLCByZW5kZXJNYXRoKVxufVxuXG4vKipcbiAqIEFkanVzdHMgYWxsIG1hdGggZW52aXJvbm1lbnRzIGluIEhUTUxcbiAqIEBwYXJhbSB7c3RyaW5nfSBIVE1MIHRvIGJlIGFkanVzdGVkXG4gKiBAcmV0dXJuIHtzdHJpbmd9IEhUTUwgd2l0aCBhZGp1c3RlZCBtYXRoIGVudmlyb25tZW50c1xuICovXG5mdW5jdGlvbiBoYW5kbGVNYXRoKGh0bWw6IHN0cmluZykge1xuICBjb25zdCBkb2MgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKVxuICBkb2MuaW5uZXJIVE1MID0gaHRtbFxuICBkb2MucXVlcnlTZWxlY3RvckFsbCgnLm1hdGgnKS5mb3JFYWNoKGZ1bmN0aW9uKGVsZW0pIHtcbiAgICBsZXQgbWF0aCA9IChlbGVtIGFzIEhUTUxFbGVtZW50KS5pbm5lclRleHRcbiAgICAvLyBTZXQgbW9kZSBpZiBpdCBpcyBibG9jayBtYXRoXG4gICAgY29uc3QgbW9kZSA9IG1hdGguaW5kZXhPZignXFxcXFsnKSA+IC0xID8gJzsgbW9kZT1kaXNwbGF5JyA6ICcnXG5cbiAgICAvLyBSZW1vdmUgc291cnJvdW5kaW5nIFxcWyBcXF0gYW5kIFxcKCBcXClcbiAgICBtYXRoID0gbWF0aC5yZXBsYWNlKC9cXFxcW1soKVxcXV0vZywgJycpXG4gICAgcmV0dXJuIChlbGVtLm91dGVySFRNTCA9XG4gICAgICAnPHNwYW4gY2xhc3M9XCJtYXRoXCI+JyArXG4gICAgICBgPHNjcmlwdCB0eXBlPSdtYXRoL3RleCR7bW9kZX0nPiR7bWF0aH08L3NjcmlwdD5gICtcbiAgICAgICc8L3NwYW4+JylcbiAgfSlcblxuICByZXR1cm4gZG9jLmlubmVySFRNTFxufVxuXG5mdW5jdGlvbiByZW1vdmVSZWZlcmVuY2VzKGh0bWw6IHN0cmluZykge1xuICBjb25zdCBkb2MgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKVxuICBkb2MuaW5uZXJIVE1MID0gaHRtbFxuICBkb2MucXVlcnlTZWxlY3RvckFsbCgnLnJlZmVyZW5jZXMnKS5mb3JFYWNoKChlbGVtKSA9PiB7XG4gICAgZWxlbS5yZW1vdmUoKVxuICB9KVxuICByZXR1cm4gZG9jLmlubmVySFRNTFxufVxuXG4vKipcbiAqIEhhbmRsZSBzdWNjZXNzZnVsIHJlc3BvbnNlIGZyb20gUGFuZG9jXG4gKiBAcGFyYW0ge3N0cmluZ30gUmV0dXJuZWQgSFRNTFxuICogQHJldHVybiB7YXJyYXl9IHdpdGggQXJndW1lbnRzIGZvciBjYWxsYmFja0Z1bmN0aW9uIChlcnJvciBzZXQgdG8gbnVsbClcbiAqL1xuZnVuY3Rpb24gaGFuZGxlU3VjY2VzcyhodG1sOiBzdHJpbmcsIHJlbmRlck1hdGg6IGJvb2xlYW4pIHtcbiAgaWYgKHJlbmRlck1hdGgpIHtcbiAgICBodG1sID0gaGFuZGxlTWF0aChodG1sKVxuICB9XG4gIGlmIChhdG9tQ29uZmlnKCkucGFuZG9jUmVtb3ZlUmVmZXJlbmNlcykge1xuICAgIGh0bWwgPSByZW1vdmVSZWZlcmVuY2VzKGh0bWwpXG4gIH1cbiAgcmV0dXJuIGh0bWxcbn1cblxuLyoqXG4gKiBIYW5kbGUgcmVzcG9uc2UgZnJvbSBQYW5kb2NcbiAqIEBwYXJhbSB7T2JqZWN0fSBlcnJvciBpZiB0aHJvd25cbiAqIEBwYXJhbSB7c3RyaW5nfSBSZXR1cm5lZCBIVE1MXG4gKi9cbmZ1bmN0aW9uIGhhbmRsZVJlc3BvbnNlKGVycm9yOiBzdHJpbmcsIGh0bWw6IHN0cmluZywgcmVuZGVyTWF0aDogYm9vbGVhbikge1xuICBpZiAoZXJyb3IpIHtcbiAgICByZXR1cm4gaGFuZGxlRXJyb3IoZXJyb3IsIGh0bWwsIHJlbmRlck1hdGgpXG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGhhbmRsZVN1Y2Nlc3MoaHRtbCwgcmVuZGVyTWF0aClcbiAgfVxufVxuXG4vKipcbiAqIFJlbmRlcnMgbWFya2Rvd24gd2l0aCBwYW5kb2NcbiAqIEBwYXJhbSB7c3RyaW5nfSBkb2N1bWVudCBpbiBtYXJrZG93blxuICogQHBhcmFtIHtib29sZWFufSB3aGV0aGVyIHRvIHJlbmRlciB0aGUgbWF0aCB3aXRoIG1hdGhqYXhcbiAqIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrRnVuY3Rpb25cbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJlbmRlclBhbmRvYyhcbiAgdGV4dDogc3RyaW5nLFxuICBmaWxlUGF0aDogc3RyaW5nIHwgdW5kZWZpbmVkLFxuICByZW5kZXJNYXRoOiBib29sZWFuLFxuKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgY29uc3QgeyBhcmdzLCBvcHRzIH0gPSBzZXRQYW5kb2NPcHRpb25zKGZpbGVQYXRoLCByZW5kZXJNYXRoKVxuICByZXR1cm4gbmV3IFByb21pc2U8c3RyaW5nPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgY29uc3QgY3AgPSBDUC5leGVjRmlsZShcbiAgICAgIGF0b21Db25maWcoKS5wYW5kb2NQYXRoLFxuICAgICAgZ2V0QXJndW1lbnRzKGFyZ3MpLFxuICAgICAgb3B0cyxcbiAgICAgIGZ1bmN0aW9uKGVycm9yLCBzdGRvdXQsIHN0ZGVycikge1xuICAgICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkRXJyb3IoZXJyb3IudG9TdHJpbmcoKSwge1xuICAgICAgICAgICAgc3RhY2s6IGVycm9yLnN0YWNrLFxuICAgICAgICAgICAgZGlzbWlzc2FibGU6IHRydWUsXG4gICAgICAgICAgfSlcbiAgICAgICAgICByZWplY3QoZXJyb3IpXG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgcmVzdWx0ID0gaGFuZGxlUmVzcG9uc2Uoc3RkZXJyIHx8ICcnLCBzdGRvdXQgfHwgJycsIHJlbmRlck1hdGgpXG4gICAgICAgIHJlc29sdmUocmVzdWx0KVxuICAgICAgfSxcbiAgICApXG4gICAgY3Auc3RkaW4ud3JpdGUodGV4dClcbiAgICBjcC5zdGRpbi5lbmQoKVxuICB9KVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0QXJndW1lbnRzKGlhcmdzOiBBcmdzKSB7XG4gIGNvbnN0IGFyZ3MgPSBfLnJlZHVjZShcbiAgICBpYXJncyxcbiAgICBmdW5jdGlvbihyZXM6IHN0cmluZ1tdLCB2YWwsIGtleSkge1xuICAgICAgaWYgKHZhbCAmJiAhXy5pc0VtcHR5KHZhbCkpIHtcbiAgICAgICAgY29uc3QgbnZhbDogc3RyaW5nW10gPSBfLmZsYXR0ZW4oW3ZhbF0pXG4gICAgICAgIF8uZm9yRWFjaChudmFsLCBmdW5jdGlvbih2OiBzdHJpbmcpIHtcbiAgICAgICAgICBpZiAoIV8uaXNFbXB0eSh2KSkge1xuICAgICAgICAgICAgcmVzLnB1c2goYC0tJHtrZXl9PSR7dn1gKVxuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICAgIHJldHVybiByZXNcbiAgICB9LFxuICAgIFtdLFxuICApXG4gIGNvbnN0IHJlczogc3RyaW5nW10gPSBbXVxuICBmb3IgKGNvbnN0IHZhbCBvZiBbXG4gICAgLi4uYXJncyxcbiAgICAuLi5hdG9tLmNvbmZpZy5nZXQoJ21hcmtkb3duLXByZXZpZXctcGx1cy5wYW5kb2NBcmd1bWVudHMnKSEsXG4gIF0pIHtcbiAgICBjb25zdCBuZXd2YWwgPSB2YWwucmVwbGFjZSgvXigtLVtcXHdcXC1dKylcXHMoLispJC9pLCAnJDE9JDInKVxuICAgIGlmIChuZXd2YWwuc3Vic3RyKDAsIDEpID09PSAnLScpIHtcbiAgICAgIHJlcy5wdXNoKG5ld3ZhbClcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHJlc1xufVxuIl19