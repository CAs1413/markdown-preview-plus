"use strict";
const _ = require('lodash');
const CP = require('child_process');
let fs = null;
let path = null;
const atomConfig = () => atom.config.get('markdown-preview-plus');
const getMathJaxPath = (function () {
    let cached = null;
    return function () {
        if (cached != null) {
            return cached;
        }
        try {
            return (cached = require.resolve('MathJax'));
        }
        catch (e) {
            return '';
        }
    };
})();
var findFileRecursive = function (filePath, fileName) {
    if (fs == null) {
        fs = require('fs');
    }
    if (path == null) {
        path = require('path');
    }
    const bibFile = path.join(filePath, '../', fileName);
    if (fs.existsSync(bibFile)) {
        return bibFile;
    }
    else {
        const newPath = path.join(bibFile, '..');
        if (newPath !== filePath && !_.includes(atom.project.getPaths(), newPath)) {
            return findFileRecursive(newPath, fileName);
        }
        else {
            return false;
        }
    }
};
const setPandocOptions = function (filePath, renderMath) {
    const args = {
        from: atomConfig().pandocMarkdownFlavor,
        to: 'html',
    };
    const opts = { maxBuffer: Infinity };
    if (path == null) {
        path = require('path');
    }
    if (filePath != null) {
        opts.cwd = path.dirname(filePath);
    }
    const mathjaxPath = getMathJaxPath();
    args.mathjax = renderMath ? mathjaxPath : undefined;
    args.filter = atomConfig().pandocFilters;
    if (atomConfig().pandocBibliography) {
        args.filter.push('pandoc-citeproc');
        let bibFile = findFileRecursive(filePath, atomConfig().pandocBIBFile);
        if (!bibFile) {
            bibFile = atomConfig().pandocBIBFileFallback;
        }
        args.bibliography = bibFile ? bibFile : undefined;
        let cslFile = findFileRecursive(filePath, atomConfig().pandocCSLFile);
        if (!cslFile) {
            cslFile = atomConfig().pandocCSLFileFallback;
        }
        args.csl = cslFile ? cslFile : undefined;
    }
    return { args, opts };
};
const handleError = function (error, html, renderMath) {
    const message = _.uniq(error.split('\n')).join('<br>');
    html = `<h1>Pandoc Error:</h1><pre>${error}</pre><hr>${html}`;
    return handleSuccess(html, renderMath);
};
const handleMath = function (html) {
    const doc = document.createElement('div');
    doc.innerHTML = html;
    doc.querySelectorAll('.math').forEach(function (elem) {
        let math = elem.innerText;
        const mode = math.indexOf('\\[') > -1 ? '; mode=display' : '';
        math = math.replace(/\\[[()\]]/g, '');
        return (elem.outerHTML =
            '<span class="math">' +
                `<script type='math/tex${mode}'>${math}</script>` +
                '</span>');
    });
    return doc.innerHTML;
};
const removeReferences = function (html) {
    const doc = document.createElement('div');
    doc.innerHTML = html;
    doc.querySelectorAll('.references').forEach((elem) => elem.remove());
    return doc.innerHTML;
};
var handleSuccess = function (html, renderMath) {
    if (renderMath) {
        html = handleMath(html);
    }
    if (atomConfig().pandocRemoveReferences) {
        html = removeReferences(html);
    }
    return [null, html];
};
const handleResponse = function (error, html, renderMath) {
    if (error) {
        return handleError(error, html, renderMath);
    }
    else {
        return handleSuccess(html, renderMath);
    }
};
const renderPandoc = function (text, filePath, renderMath, cb) {
    const { args, opts } = setPandocOptions(filePath, renderMath);
    const cp = CP.execFile(atomConfig().pandocPath, getArguments(args), opts, function (error, stdout, stderr) {
        if (error) {
            atom.notifications.addError(error.toString(), {
                stack: error.stack,
                dismissable: true,
            });
        }
        const cbargs = handleResponse(stderr != null ? stderr : '', stdout != null ? stdout : '', renderMath);
        return cb(...Array.from(cbargs || []));
    });
    cp.stdin.write(text);
    return cp.stdin.end();
};
var getArguments = function (args) {
    args = _.reduce(args, function (res, val, key) {
        if (!_.isEmpty(val)) {
            val = _.flatten([val]);
            _.forEach(val, function (v) {
                if (!_.isEmpty(v)) {
                    return res.push(`--${key}=${v}`);
                }
            });
        }
        return res;
    }, []);
    args = _.union(args, atom.config.get('markdown-preview-plus.pandocArguments'));
    args = _.map(args, function (val) {
        val = val.replace(/^(--[\w\-]+)\s(.+)$/i, '$1=$2');
        if (val.substr(0, 1) !== '-') {
            return undefined;
        }
        else {
            return val;
        }
    });
    return _.reject(args, _.isEmpty);
};
module.exports = {
    renderPandoc,
    __testing__: {
        findFileRecursive,
        setPandocOptions,
        getArguments,
    },
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFuZG9jLWhlbHBlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9wYW5kb2MtaGVscGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFPQSxNQUFNLENBQUMsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUE7QUFDM0IsTUFBTSxFQUFFLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFBO0FBQ25DLElBQUksRUFBRSxHQUFHLElBQUksQ0FBQTtBQUNiLElBQUksSUFBSSxHQUFHLElBQUksQ0FBQTtBQUVmLE1BQU0sVUFBVSxHQUFHLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLHVCQUF1QixDQUFDLENBQUE7QUFLakUsTUFBTSxjQUFjLEdBQUcsQ0FBQztJQUN0QixJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUE7SUFDakIsTUFBTSxDQUFDO1FBQ0wsRUFBRSxDQUFDLENBQUMsTUFBTSxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDbkIsTUFBTSxDQUFDLE1BQU0sQ0FBQTtRQUNmLENBQUM7UUFDRCxJQUFJLENBQUM7WUFDSCxNQUFNLENBQUMsQ0FBQyxNQUFNLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFBO1FBQzlDLENBQUM7UUFBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ1gsTUFBTSxDQUFDLEVBQUUsQ0FBQTtRQUNYLENBQUM7SUFDSCxDQUFDLENBQUE7QUFDSCxDQUFDLENBQUMsRUFBRSxDQUFBO0FBRUosSUFBSSxpQkFBaUIsR0FBRyxVQUFTLFFBQVEsRUFBRSxRQUFRO0lBQ2pELEVBQUUsQ0FBQyxDQUFDLEVBQUUsSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ2YsRUFBRSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUNwQixDQUFDO0lBQ0QsRUFBRSxDQUFDLENBQUMsSUFBSSxJQUFJLElBQUks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QTtBQUVELGlCQUFTO0lBQ1AsWUFBWTtJQUNaLFdBQVcsRUFBRTtRQUNYLGlCQUFpQjtRQUNqQixnQkFBZ0I7UUFDaEIsWUFBWTtLQUNiO0NBQ0YsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBkZWNhZmZlaW5hdGUgc3VnZ2VzdGlvbnM6XG4gKiBEUzEwMTogUmVtb3ZlIHVubmVjZXNzYXJ5IHVzZSBvZiBBcnJheS5mcm9tXG4gKiBEUzEwMjogUmVtb3ZlIHVubmVjZXNzYXJ5IGNvZGUgY3JlYXRlZCBiZWNhdXNlIG9mIGltcGxpY2l0IHJldHVybnNcbiAqIERTMjA3OiBDb25zaWRlciBzaG9ydGVyIHZhcmlhdGlvbnMgb2YgbnVsbCBjaGVja3NcbiAqIEZ1bGwgZG9jczogaHR0cHM6Ly9naXRodWIuY29tL2RlY2FmZmVpbmF0ZS9kZWNhZmZlaW5hdGUvYmxvYi9tYXN0ZXIvZG9jcy9zdWdnZXN0aW9ucy5tZFxuICovXG5jb25zdCBfID0gcmVxdWlyZSgnbG9kYXNoJylcbmNvbnN0IENQID0gcmVxdWlyZSgnY2hpbGRfcHJvY2VzcycpXG5sZXQgZnMgPSBudWxsXG5sZXQgcGF0aCA9IG51bGxcblxuY29uc3QgYXRvbUNvbmZpZyA9ICgpID0+IGF0b20uY29uZmlnLmdldCgnbWFya2Rvd24tcHJldmlldy1wbHVzJylcblxuLyoqXG4gKiBTZXRzIGxvY2FsIG1hdGhqYXhQYXRoIGlmIGF2YWlsYWJsZVxuICovXG5jb25zdCBnZXRNYXRoSmF4UGF0aCA9IChmdW5jdGlvbigpIHtcbiAgbGV0IGNhY2hlZCA9IG51bGxcbiAgcmV0dXJuIGZ1bmN0aW9uKCkge1xuICAgIGlmIChjYWNoZWQgIT0gbnVsbCkge1xuICAgICAgcmV0dXJuIGNhY2hlZFxuICAgIH1cbiAgICB0cnkge1xuICAgICAgcmV0dXJuIChjYWNoZWQgPSByZXF1aXJlLnJlc29sdmUoJ01hdGhKYXgnKSlcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICByZXR1cm4gJydcbiAgICB9XG4gIH1cbn0pKClcblxudmFyIGZpbmRGaWxlUmVjdXJzaXZlID0gZnVuY3Rpb24oZmlsZVBhdGgsIGZpbGVOYW1lKSB7XG4gIGlmIChmcyA9PSBudWxsKSB7XG4gICAgZnMgPSByZXF1aXJlKCdmcycpXG4gIH1cbiAgaWYgKHBhdGggPT0gbnVsbCkge1xuICAgIHBhdGggPSByZXF1aXJlKCdwYXRoJylcbiAgfVxuICBjb25zdCBiaWJGaWxlID0gcGF0aC5qb2luKGZpbGVQYXRoLCAnLi4vJywgZmlsZU5hbWUpXG4gIGlmIChmcy5leGlzdHNTeW5jKGJpYkZpbGUpKSB7XG4gICAgcmV0dXJuIGJpYkZpbGVcbiAgfSBlbHNlIHtcbiAgICBjb25zdCBuZXdQYXRoID0gcGF0aC5qb2luKGJpYkZpbGUsICcuLicpXG4gICAgaWYgKG5ld1BhdGggIT09IGZpbGVQYXRoICYmICFfLmluY2x1ZGVzKGF0b20ucHJvamVjdC5nZXRQYXRocygpLCBuZXdQYXRoKSkge1xuICAgICAgcmV0dXJuIGZpbmRGaWxlUmVjdXJzaXZlKG5ld1BhdGgsIGZpbGVOYW1lKVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG4gIH1cbn1cblxuLyoqXG4gKiBTZXRzIGxvY2FsIHZhcmlhYmxlcyBuZWVkZWQgZm9yIGV2ZXJ5dGhpbmdcbiAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoIHRvIG1hcmtkb3duIGZpbGVcbiAqXG4gKi9cbmNvbnN0IHNldFBhbmRvY09wdGlvbnMgPSBmdW5jdGlvbihmaWxlUGF0aCwgcmVuZGVyTWF0aCkge1xuICBjb25zdCBhcmdzID0ge1xuICAgIGZyb206IGF0b21Db25maWcoKS5wYW5kb2NNYXJrZG93bkZsYXZvcixcbiAgICB0bzogJ2h0bWwnLFxuICB9XG4gIGNvbnN0IG9wdHMgPSB7IG1heEJ1ZmZlcjogSW5maW5pdHkgfSAvLyBzZWUgaHR0cHM6Ly9naXRodWIuY29tL2F0b20tY29tbXVuaXR5L21hcmtkb3duLXByZXZpZXctcGx1cy9pc3N1ZXMvMzE2XG4gIGlmIChwYXRoID09IG51bGwpIHtcbiAgICBwYXRoID0gcmVxdWlyZSgncGF0aCcpXG4gIH1cbiAgaWYgKGZpbGVQYXRoICE9IG51bGwpIHtcbiAgICBvcHRzLmN3ZCA9IHBhdGguZGlybmFtZShmaWxlUGF0aClcbiAgfVxuICBjb25zdCBtYXRoamF4UGF0aCA9IGdldE1hdGhKYXhQYXRoKClcbiAgYXJncy5tYXRoamF4ID0gcmVuZGVyTWF0aCA/IG1hdGhqYXhQYXRoIDogdW5kZWZpbmVkXG4gIGFyZ3MuZmlsdGVyID0gYXRvbUNvbmZpZygpLnBhbmRvY0ZpbHRlcnNcbiAgaWYgKGF0b21Db25maWcoKS5wYW5kb2NCaWJsaW9ncmFwaHkpIHtcbiAgICBhcmdzLmZpbHRlci5wdXNoKCdwYW5kb2MtY2l0ZXByb2MnKVxuICAgIGxldCBiaWJGaWxlID0gZmluZEZpbGVSZWN1cnNpdmUoZmlsZVBhdGgsIGF0b21Db25maWcoKS5wYW5kb2NCSUJGaWxlKVxuICAgIGlmICghYmliRmlsZSkge1xuICAgICAgYmliRmlsZSA9IGF0b21Db25maWcoKS5wYW5kb2NCSUJGaWxlRmFsbGJhY2tcbiAgICB9XG4gICAgYXJncy5iaWJsaW9ncmFwaHkgPSBiaWJGaWxlID8gYmliRmlsZSA6IHVuZGVmaW5lZFxuICAgIGxldCBjc2xGaWxlID0gZmluZEZpbGVSZWN1cnNpdmUoZmlsZVBhdGgsIGF0b21Db25maWcoKS5wYW5kb2NDU0xGaWxlKVxuICAgIGlmICghY3NsRmlsZSkge1xuICAgICAgY3NsRmlsZSA9IGF0b21Db25maWcoKS5wYW5kb2NDU0xGaWxlRmFsbGJhY2tcbiAgICB9XG4gICAgYXJncy5jc2wgPSBjc2xGaWxlID8gY3NsRmlsZSA6IHVuZGVmaW5lZFxuICB9XG4gIHJldHVybiB7IGFyZ3MsIG9wdHMgfVxufVxuXG4vKipcbiAqIEhhbmRsZSBlcnJvciByZXNwb25zZSBmcm9tIFBhbmRvY1xuICogQHBhcmFtIHtlcnJvcn0gUmV0dXJuZWQgZXJyb3JcbiAqIEBwYXJhbSB7c3RyaW5nfSBSZXR1cm5lZCBIVE1MXG4gKiBAcmV0dXJuIHthcnJheX0gd2l0aCBBcmd1bWVudHMgZm9yIGNhbGxiYWNrRnVuY3Rpb24gKGVycm9yIHNldCB0byBudWxsKVxuICovXG5jb25zdCBoYW5kbGVFcnJvciA9IGZ1bmN0aW9uKGVycm9yLCBodG1sLCByZW5kZXJNYXRoKSB7XG4gIGNvbnN0IG1lc3NhZ2UgPSBfLnVuaXEoZXJyb3Iuc3BsaXQoJ1xcbicpKS5qb2luKCc8YnI+JylcbiAgaHRtbCA9IGA8aDE+UGFuZG9jIEVycm9yOjwvaDE+PHByZT4ke2Vycm9yfTwvcHJlPjxocj4ke2h0bWx9YFxuICByZXR1cm4gaGFuZGxlU3VjY2VzcyhodG1sLCByZW5kZXJNYXRoKVxufVxuXG4vKipcbiAqIEFkanVzdHMgYWxsIG1hdGggZW52aXJvbm1lbnRzIGluIEhUTUxcbiAqIEBwYXJhbSB7c3RyaW5nfSBIVE1MIHRvIGJlIGFkanVzdGVkXG4gKiBAcmV0dXJuIHtzdHJpbmd9IEhUTUwgd2l0aCBhZGp1c3RlZCBtYXRoIGVudmlyb25tZW50c1xuICovXG5jb25zdCBoYW5kbGVNYXRoID0gZnVuY3Rpb24oaHRtbCkge1xuICBjb25zdCBkb2MgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKVxuICBkb2MuaW5uZXJIVE1MID0gaHRtbFxuICBkb2MucXVlcnlTZWxlY3RvckFsbCgnLm1hdGgnKS5mb3JFYWNoKGZ1bmN0aW9uKGVsZW0pIHtcbiAgICBsZXQgbWF0aCA9IGVsZW0uaW5uZXJUZXh0XG4gICAgLy8gU2V0IG1vZGUgaWYgaXQgaXMgYmxvY2sgbWF0aFxuICAgIGNvbnN0IG1vZGUgPSBtYXRoLmluZGV4T2YoJ1xcXFxbJykgPiAtMSA/ICc7IG1vZGU9ZGlzcGxheScgOiAnJ1xuXG4gICAgLy8gUmVtb3ZlIHNvdXJyb3VuZGluZyBcXFsgXFxdIGFuZCBcXCggXFwpXG4gICAgbWF0aCA9IG1hdGgucmVwbGFjZSgvXFxcXFtbKClcXF1dL2csICcnKVxuICAgIHJldHVybiAoZWxlbS5vdXRlckhUTUwgPVxuICAgICAgJzxzcGFuIGNsYXNzPVwibWF0aFwiPicgK1xuICAgICAgYDxzY3JpcHQgdHlwZT0nbWF0aC90ZXgke21vZGV9Jz4ke21hdGh9PC9zY3JpcHQ+YCArXG4gICAgICAnPC9zcGFuPicpXG4gIH0pXG5cbiAgcmV0dXJuIGRvYy5pbm5lckhUTUxcbn1cblxuY29uc3QgcmVtb3ZlUmVmZXJlbmNlcyA9IGZ1bmN0aW9uKGh0bWwpIHtcbiAgY29uc3QgZG9jID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JylcbiAgZG9jLmlubmVySFRNTCA9IGh0bWxcbiAgZG9jLnF1ZXJ5U2VsZWN0b3JBbGwoJy5yZWZlcmVuY2VzJykuZm9yRWFjaCgoZWxlbSkgPT4gZWxlbS5yZW1vdmUoKSlcbiAgcmV0dXJuIGRvYy5pbm5lckhUTUxcbn1cblxuLyoqXG4gKiBIYW5kbGUgc3VjY2Vzc2Z1bCByZXNwb25zZSBmcm9tIFBhbmRvY1xuICogQHBhcmFtIHtzdHJpbmd9IFJldHVybmVkIEhUTUxcbiAqIEByZXR1cm4ge2FycmF5fSB3aXRoIEFyZ3VtZW50cyBmb3IgY2FsbGJhY2tGdW5jdGlvbiAoZXJyb3Igc2V0IHRvIG51bGwpXG4gKi9cbnZhciBoYW5kbGVTdWNjZXNzID0gZnVuY3Rpb24oaHRtbCwgcmVuZGVyTWF0aCkge1xuICBpZiAocmVuZGVyTWF0aCkge1xuICAgIGh0bWwgPSBoYW5kbGVNYXRoKGh0bWwpXG4gIH1cbiAgaWYgKGF0b21Db25maWcoKS5wYW5kb2NSZW1vdmVSZWZlcmVuY2VzKSB7XG4gICAgaHRtbCA9IHJlbW92ZVJlZmVyZW5jZXMoaHRtbClcbiAgfVxuICByZXR1cm4gW251bGwsIGh0bWxdXG59XG5cbi8qKlxuICogSGFuZGxlIHJlc3BvbnNlIGZyb20gUGFuZG9jXG4gKiBAcGFyYW0ge09iamVjdH0gZXJyb3IgaWYgdGhyb3duXG4gKiBAcGFyYW0ge3N0cmluZ30gUmV0dXJuZWQgSFRNTFxuICovXG5jb25zdCBoYW5kbGVSZXNwb25zZSA9IGZ1bmN0aW9uKGVycm9yLCBodG1sLCByZW5kZXJNYXRoKSB7XG4gIGlmIChlcnJvcikge1xuICAgIHJldHVybiBoYW5kbGVFcnJvcihlcnJvciwgaHRtbCwgcmVuZGVyTWF0aClcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gaGFuZGxlU3VjY2VzcyhodG1sLCByZW5kZXJNYXRoKVxuICB9XG59XG5cbi8qKlxuICogUmVuZGVycyBtYXJrZG93biB3aXRoIHBhbmRvY1xuICogQHBhcmFtIHtzdHJpbmd9IGRvY3VtZW50IGluIG1hcmtkb3duXG4gKiBAcGFyYW0ge2Jvb2xlYW59IHdoZXRoZXIgdG8gcmVuZGVyIHRoZSBtYXRoIHdpdGggbWF0aGpheFxuICogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2tGdW5jdGlvblxuICovXG5jb25zdCByZW5kZXJQYW5kb2MgPSBmdW5jdGlvbih0ZXh0LCBmaWxlUGF0aCwgcmVuZGVyTWF0aCwgY2IpIHtcbiAgY29uc3QgeyBhcmdzLCBvcHRzIH0gPSBzZXRQYW5kb2NPcHRpb25zKGZpbGVQYXRoLCByZW5kZXJNYXRoKVxuICBjb25zdCBjcCA9IENQLmV4ZWNGaWxlKFxuICAgIGF0b21Db25maWcoKS5wYW5kb2NQYXRoLFxuICAgIGdldEFyZ3VtZW50cyhhcmdzKSxcbiAgICBvcHRzLFxuICAgIGZ1bmN0aW9uKGVycm9yLCBzdGRvdXQsIHN0ZGVycikge1xuICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRFcnJvcihlcnJvci50b1N0cmluZygpLCB7XG4gICAgICAgICAgc3RhY2s6IGVycm9yLnN0YWNrLFxuICAgICAgICAgIGRpc21pc3NhYmxlOiB0cnVlLFxuICAgICAgICB9KVxuICAgICAgfVxuICAgICAgY29uc3QgY2JhcmdzID0gaGFuZGxlUmVzcG9uc2UoXG4gICAgICAgIHN0ZGVyciAhPSBudWxsID8gc3RkZXJyIDogJycsXG4gICAgICAgIHN0ZG91dCAhPSBudWxsID8gc3Rkb3V0IDogJycsXG4gICAgICAgIHJlbmRlck1hdGgsXG4gICAgICApXG4gICAgICByZXR1cm4gY2IoLi4uQXJyYXkuZnJvbShjYmFyZ3MgfHwgW10pKVxuICAgIH0sXG4gIClcbiAgY3Auc3RkaW4ud3JpdGUodGV4dClcbiAgcmV0dXJuIGNwLnN0ZGluLmVuZCgpXG59XG5cbnZhciBnZXRBcmd1bWVudHMgPSBmdW5jdGlvbihhcmdzKSB7XG4gIGFyZ3MgPSBfLnJlZHVjZShcbiAgICBhcmdzLFxuICAgIGZ1bmN0aW9uKHJlcywgdmFsLCBrZXkpIHtcbiAgICAgIGlmICghXy5pc0VtcHR5KHZhbCkpIHtcbiAgICAgICAgdmFsID0gXy5mbGF0dGVuKFt2YWxdKVxuICAgICAgICBfLmZvckVhY2godmFsLCBmdW5jdGlvbih2KSB7XG4gICAgICAgICAgaWYgKCFfLmlzRW1wdHkodikpIHtcbiAgICAgICAgICAgIHJldHVybiByZXMucHVzaChgLS0ke2tleX09JHt2fWApXG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgfVxuICAgICAgcmV0dXJuIHJlc1xuICAgIH0sXG4gICAgW10sXG4gIClcbiAgYXJncyA9IF8udW5pb24oYXJncywgYXRvbS5jb25maWcuZ2V0KCdtYXJrZG93bi1wcmV2aWV3LXBsdXMucGFuZG9jQXJndW1lbnRzJykpXG4gIGFyZ3MgPSBfLm1hcChhcmdzLCBmdW5jdGlvbih2YWwpIHtcbiAgICB2YWwgPSB2YWwucmVwbGFjZSgvXigtLVtcXHdcXC1dKylcXHMoLispJC9pLCAnJDE9JDInKVxuICAgIGlmICh2YWwuc3Vic3RyKDAsIDEpICE9PSAnLScpIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWRcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHZhbFxuICAgIH1cbiAgfSlcbiAgcmV0dXJuIF8ucmVqZWN0KGFyZ3MsIF8uaXNFbXB0eSlcbn1cblxuZXhwb3J0ID0ge1xuICByZW5kZXJQYW5kb2MsXG4gIF9fdGVzdGluZ19fOiB7XG4gICAgZmluZEZpbGVSZWN1cnNpdmUsXG4gICAgc2V0UGFuZG9jT3B0aW9ucyxcbiAgICBnZXRBcmd1bWVudHMsXG4gIH0sXG59XG4iXX0=