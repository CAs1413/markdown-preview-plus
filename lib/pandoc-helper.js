"use strict";
const _ = require("lodash");
const CP = require("child_process");
const fs = require("fs");
const path = require("path");
const atomConfig = () => atom.config.get('markdown-preview-plus');
const getMathJaxPath = (function () {
    let cached = null;
    return function () {
        if (cached != null) {
            return cached;
        }
        try {
            return (cached = require.resolve('MathJax'));
        }
        catch (e) {
            return '';
        }
    };
})();
function findFileRecursive(filePath, fileName) {
    const bibFile = path.join(filePath, '../', fileName);
    if (fs.existsSync(bibFile)) {
        return bibFile;
    }
    else {
        const newPath = path.join(bibFile, '..');
        if (newPath !== filePath && !_.includes(atom.project.getPaths(), newPath)) {
            return findFileRecursive(newPath, fileName);
        }
        else {
            return false;
        }
    }
}
function setPandocOptions(filePath, renderMath) {
    const opts = { maxBuffer: Infinity };
    if (filePath != null) {
        opts.cwd = path.dirname(filePath);
    }
    const mathjaxPath = getMathJaxPath();
    const args = {
        from: atomConfig().pandocMarkdownFlavor,
        to: 'html',
        mathjax: renderMath ? mathjaxPath : undefined,
        filter: atomConfig().pandocFilters,
    };
    if (atomConfig().pandocBibliography) {
        args.filter.push('pandoc-citeproc');
        let bibFile = filePath && findFileRecursive(filePath, atomConfig().pandocBIBFile);
        if (!bibFile) {
            bibFile = atomConfig().pandocBIBFileFallback;
        }
        args.bibliography = bibFile ? bibFile : undefined;
        let cslFile = filePath && findFileRecursive(filePath, atomConfig().pandocCSLFile);
        if (!cslFile) {
            cslFile = atomConfig().pandocCSLFileFallback;
        }
        args.csl = cslFile ? cslFile : undefined;
    }
    return { args, opts };
}
function handleError(error, html, renderMath) {
    html = `<h1>Pandoc Error:</h1><pre>${error}</pre><hr>${html}`;
    return handleSuccess(html, renderMath);
}
function handleMath(html) {
    const doc = document.createElement('div');
    doc.innerHTML = html;
    doc.querySelectorAll('.math').forEach(function (elem) {
        let math = elem.innerText;
        const mode = math.indexOf('\\[') > -1 ? '; mode=display' : '';
        math = math.replace(/\\[[()\]]/g, '');
        return (elem.outerHTML =
            '<span class="math">' +
                `<script type='math/tex${mode}'>${math}</script>` +
                '</span>');
    });
    return doc.innerHTML;
}
function removeReferences(html) {
    const doc = document.createElement('div');
    doc.innerHTML = html;
    doc.querySelectorAll('.references').forEach((elem) => elem.remove());
    return doc.innerHTML;
}
function handleSuccess(html, renderMath) {
    if (renderMath) {
        html = handleMath(html);
    }
    if (atomConfig().pandocRemoveReferences) {
        html = removeReferences(html);
    }
    return html;
}
function handleResponse(error, html, renderMath) {
    if (error) {
        return handleError(error, html, renderMath);
    }
    else {
        return handleSuccess(html, renderMath);
    }
}
function renderPandoc(text, filePath, renderMath, cb) {
    const { args, opts } = setPandocOptions(filePath, renderMath);
    const cp = CP.execFile(atomConfig().pandocPath, getArguments(args), opts, function (error, stdout, stderr) {
        if (error) {
            atom.notifications.addError(error.toString(), {
                stack: error.stack,
                dismissable: true,
            });
        }
        const result = handleResponse(stderr || '', stdout || '', renderMath);
        return cb(null, result);
    });
    cp.stdin.write(text);
    cp.stdin.end();
}
function getArguments(iargs) {
    const args = _.reduce(iargs, function (res, val, key) {
        if (val && !_.isEmpty(val)) {
            const nval = _.flatten([val]);
            _.forEach(nval, function (v) {
                if (!_.isEmpty(v)) {
                    res.push(`--${key}=${v}`);
                }
            });
        }
        return res;
    }, []);
    const res = [];
    for (const val of [
        ...args,
        ...atom.config.get('markdown-preview-plus.pandocArguments'),
    ]) {
        const newval = val.replace(/^(--[\w\-]+)\s(.+)$/i, '$1=$2');
        if (newval.substr(0, 1) === '-') {
            res.push(newval);
        }
    }
    console.warn(res);
    return res;
}
module.exports = {
    renderPandoc,
    __testing__: {
        findFileRecursive,
        setPandocOptions,
        getArguments,
    },
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFuZG9jLWhlbHBlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9wYW5kb2MtaGVscGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFPQSw0QkFBNEI7QUFDNUIsb0NBQW9DO0FBQ3BDLHlCQUF5QjtBQUN6Qiw2QkFBNkI7QUFFN0IsTUFBTSxVQUFVLEdBQUcsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsdUJBQXVCLENBQUUsQ0FBQTtBQUtsRSxNQUFNLGNBQWMsR0FBRyxDQUFDO0lBQ3RCLElBQUksTUFBTSxHQUFrQixJQUFJLENBQUE7SUFDaEMsTUFBTSxDQUFDO1FBQ0wsRUFBRSxDQUFDLENBQUMsTUFBTSxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDbkIsTUFBTSxDQUFDLE1BQU0sQ0FBQTtRQUNmLENBQUM7UUFDRCxJQUFJLENBQUM7WUFDSCxNQUFNLENBQUMsQ0FBQyxNQUFNLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFBO1FBQzlDLENBQUM7UUFBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ1gsTUFBTSxDQUFDLEVBQUUsQ0FBQTtRQUNYLENBQUM7SUFDSCxDQUFDLENBQUE7QUFDSCxDQUFDLENBQUMsRUFBRSxDQUFBO0FBRUosMkJBQTJCLFFBQWdCLEVBQUUsUUFBZ0I7SUFDM0QsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsS0FBSyxFQUFFLFFBQVEsQ0FBQyxDQUFBO0lBQ3BELEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzNCLE1BQU0sQ0FBQyxPQUFPLENBQUE7SUFDaEIsQ0FBQztJQUFDLElBQUksQ0FBQyxDQUFDO1FBQ04sTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUs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LENBQUMsQ0FBQTtJQUNqQixNQUFNLENBQUMsR0FBRyxDQUFBO0FBQ1osQ0FBQztBQUVELGlCQUFTO0lBQ1AsWUFBWTtJQUNaLFdBQVcsRUFBRTtRQUNYLGlCQUFpQjtRQUNqQixnQkFBZ0I7UUFDaEIsWUFBWTtLQUNiO0NBQ0YsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBkZWNhZmZlaW5hdGUgc3VnZ2VzdGlvbnM6XG4gKiBEUzEwMTogUmVtb3ZlIHVubmVjZXNzYXJ5IHVzZSBvZiBBcnJheS5mcm9tXG4gKiBEUzEwMjogUmVtb3ZlIHVubmVjZXNzYXJ5IGNvZGUgY3JlYXRlZCBiZWNhdXNlIG9mIGltcGxpY2l0IHJldHVybnNcbiAqIERTMjA3OiBDb25zaWRlciBzaG9ydGVyIHZhcmlhdGlvbnMgb2YgbnVsbCBjaGVja3NcbiAqIEZ1bGwgZG9jczogaHR0cHM6Ly9naXRodWIuY29tL2RlY2FmZmVpbmF0ZS9kZWNhZmZlaW5hdGUvYmxvYi9tYXN0ZXIvZG9jcy9zdWdnZXN0aW9ucy5tZFxuICovXG5pbXBvcnQgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpXG5pbXBvcnQgQ1AgPSByZXF1aXJlKCdjaGlsZF9wcm9jZXNzJylcbmltcG9ydCBmcyA9IHJlcXVpcmUoJ2ZzJylcbmltcG9ydCBwYXRoID0gcmVxdWlyZSgncGF0aCcpXG5cbmNvbnN0IGF0b21Db25maWcgPSAoKSA9PiBhdG9tLmNvbmZpZy5nZXQoJ21hcmtkb3duLXByZXZpZXctcGx1cycpIVxuXG4vKipcbiAqIFNldHMgbG9jYWwgbWF0aGpheFBhdGggaWYgYXZhaWxhYmxlXG4gKi9cbmNvbnN0IGdldE1hdGhKYXhQYXRoID0gKGZ1bmN0aW9uKCkge1xuICBsZXQgY2FjaGVkOiBzdHJpbmcgfCBudWxsID0gbnVsbFxuICByZXR1cm4gZnVuY3Rpb24oKSB7XG4gICAgaWYgKGNhY2hlZCAhPSBudWxsKSB7XG4gICAgICByZXR1cm4gY2FjaGVkXG4gICAgfVxuICAgIHRyeSB7XG4gICAgICByZXR1cm4gKGNhY2hlZCA9IHJlcXVpcmUucmVzb2x2ZSgnTWF0aEpheCcpKVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHJldHVybiAnJ1xuICAgIH1cbiAgfVxufSkoKVxuXG5mdW5jdGlvbiBmaW5kRmlsZVJlY3Vyc2l2ZShmaWxlUGF0aDogc3RyaW5nLCBmaWxlTmFtZTogc3RyaW5nKTogc3RyaW5nIHwgZmFsc2Uge1xuICBjb25zdCBiaWJGaWxlID0gcGF0aC5qb2luKGZpbGVQYXRoLCAnLi4vJywgZmlsZU5hbWUpXG4gIGlmIChmcy5leGlzdHNTeW5jKGJpYkZpbGUpKSB7XG4gICAgcmV0dXJuIGJpYkZpbGVcbiAgfSBlbHNlIHtcbiAgICBjb25zdCBuZXdQYXRoID0gcGF0aC5qb2luKGJpYkZpbGUsICcuLicpXG4gICAgaWYgKG5ld1BhdGggIT09IGZpbGVQYXRoICYmICFfLmluY2x1ZGVzKGF0b20ucHJvamVjdC5nZXRQYXRocygpLCBuZXdQYXRoKSkge1xuICAgICAgcmV0dXJuIGZpbmRGaWxlUmVjdXJzaXZlKG5ld1BhdGgsIGZpbGVOYW1lKVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG4gIH1cbn1cblxuaW50ZXJmYWNlIEFyZ3Mge1xuICBmcm9tOiBzdHJpbmdcbiAgdG86ICdodG1sJ1xuICBtYXRoamF4Pzogc3RyaW5nXG4gIGZpbHRlcjogc3RyaW5nW11cbiAgYmlibGlvZ3JhcGh5Pzogc3RyaW5nXG4gIGNzbD86IHN0cmluZ1xufVxuXG5mdW5jdGlvbiBzZXRQYW5kb2NPcHRpb25zKGZpbGVQYXRoOiBzdHJpbmcgfCB1bmRlZmluZWQsIHJlbmRlck1hdGg6IGJvb2xlYW4pIHtcbiAgLy8gc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9hdG9tLWNvbW11bml0eS9tYXJrZG93bi1wcmV2aWV3LXBsdXMvaXNzdWVzLzMxNlxuICBjb25zdCBvcHRzOiBDUC5FeGVjRmlsZU9wdGlvbnMgPSB7IG1heEJ1ZmZlcjogSW5maW5pdHkgfVxuICBpZiAoZmlsZVBhdGggIT0gbnVsbCkge1xuICAgIG9wdHMuY3dkID0gcGF0aC5kaXJuYW1lKGZpbGVQYXRoKVxuICB9XG4gIGNvbnN0IG1hdGhqYXhQYXRoID0gZ2V0TWF0aEpheFBhdGgoKVxuICBjb25zdCBhcmdzOiBBcmdzID0ge1xuICAgIGZyb206IGF0b21Db25maWcoKS5wYW5kb2NNYXJrZG93bkZsYXZvcixcbiAgICB0bzogJ2h0bWwnLFxuICAgIG1hdGhqYXg6IHJlbmRlck1hdGggPyBtYXRoamF4UGF0aCA6IHVuZGVmaW5lZCxcbiAgICBmaWx0ZXI6IGF0b21Db25maWcoKS5wYW5kb2NGaWx0ZXJzLFxuICB9XG4gIGlmIChhdG9tQ29uZmlnKCkucGFuZG9jQmlibGlvZ3JhcGh5KSB7XG4gICAgYXJncy5maWx0ZXIucHVzaCgncGFuZG9jLWNpdGVwcm9jJylcbiAgICBsZXQgYmliRmlsZSA9IGZpbGVQYXRoICYmIGZpbmRGaWxlUmVjdXJzaXZlKGZpbGVQYXRoLCBhdG9tQ29uZmlnKCkucGFuZG9jQklCRmlsZSlcbiAgICBpZiAoIWJpYkZpbGUpIHtcbiAgICAgIGJpYkZpbGUgPSBhdG9tQ29uZmlnKCkucGFuZG9jQklCRmlsZUZhbGxiYWNrXG4gICAgfVxuICAgIGFyZ3MuYmlibGlvZ3JhcGh5ID0gYmliRmlsZSA/IGJpYkZpbGUgOiB1bmRlZmluZWRcbiAgICBsZXQgY3NsRmlsZSA9IGZpbGVQYXRoICYmIGZpbmRGaWxlUmVjdXJzaXZlKGZpbGVQYXRoLCBhdG9tQ29uZmlnKCkucGFuZG9jQ1NMRmlsZSlcbiAgICBpZiAoIWNzbEZpbGUpIHtcbiAgICAgIGNzbEZpbGUgPSBhdG9tQ29uZmlnKCkucGFuZG9jQ1NMRmlsZUZhbGxiYWNrXG4gICAgfVxuICAgIGFyZ3MuY3NsID0gY3NsRmlsZSA/IGNzbEZpbGUgOiB1bmRlZmluZWRcbiAgfVxuICByZXR1cm4geyBhcmdzLCBvcHRzIH1cbn1cblxuLyoqXG4gKiBIYW5kbGUgZXJyb3IgcmVzcG9uc2UgZnJvbSBQYW5kb2NcbiAqIEBwYXJhbSB7ZXJyb3J9IFJldHVybmVkIGVycm9yXG4gKiBAcGFyYW0ge3N0cmluZ30gUmV0dXJuZWQgSFRNTFxuICogQHJldHVybiB7YXJyYXl9IHdpdGggQXJndW1lbnRzIGZvciBjYWxsYmFja0Z1bmN0aW9uIChlcnJvciBzZXQgdG8gbnVsbClcbiAqL1xuZnVuY3Rpb24gaGFuZGxlRXJyb3IoZXJyb3I6IHN0cmluZywgaHRtbDogc3RyaW5nLCByZW5kZXJNYXRoOiBib29sZWFuKSB7XG4gIGh0bWwgPSBgPGgxPlBhbmRvYyBFcnJvcjo8L2gxPjxwcmU+JHtlcnJvcn08L3ByZT48aHI+JHtodG1sfWBcbiAgcmV0dXJuIGhhbmRsZVN1Y2Nlc3MoaHRtbCwgcmVuZGVyTWF0aClcbn1cblxuLyoqXG4gKiBBZGp1c3RzIGFsbCBtYXRoIGVudmlyb25tZW50cyBpbiBIVE1MXG4gKiBAcGFyYW0ge3N0cmluZ30gSFRNTCB0byBiZSBhZGp1c3RlZFxuICogQHJldHVybiB7c3RyaW5nfSBIVE1MIHdpdGggYWRqdXN0ZWQgbWF0aCBlbnZpcm9ubWVudHNcbiAqL1xuZnVuY3Rpb24gaGFuZGxlTWF0aChodG1sOiBzdHJpbmcpIHtcbiAgY29uc3QgZG9jID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JylcbiAgZG9jLmlubmVySFRNTCA9IGh0bWxcbiAgZG9jLnF1ZXJ5U2VsZWN0b3JBbGwoJy5tYXRoJykuZm9yRWFjaChmdW5jdGlvbihlbGVtKSB7XG4gICAgbGV0IG1hdGggPSAoZWxlbSBhcyBIVE1MRWxlbWVudCkuaW5uZXJUZXh0XG4gICAgLy8gU2V0IG1vZGUgaWYgaXQgaXMgYmxvY2sgbWF0aFxuICAgIGNvbnN0IG1vZGUgPSBtYXRoLmluZGV4T2YoJ1xcXFxbJykgPiAtMSA/ICc7IG1vZGU9ZGlzcGxheScgOiAnJ1xuXG4gICAgLy8gUmVtb3ZlIHNvdXJyb3VuZGluZyBcXFsgXFxdIGFuZCBcXCggXFwpXG4gICAgbWF0aCA9IG1hdGgucmVwbGFjZSgvXFxcXFtbKClcXF1dL2csICcnKVxuICAgIHJldHVybiAoZWxlbS5vdXRlckhUTUwgPVxuICAgICAgJzxzcGFuIGNsYXNzPVwibWF0aFwiPicgK1xuICAgICAgYDxzY3JpcHQgdHlwZT0nbWF0aC90ZXgke21vZGV9Jz4ke21hdGh9PC9zY3JpcHQ+YCArXG4gICAgICAnPC9zcGFuPicpXG4gIH0pXG5cbiAgcmV0dXJuIGRvYy5pbm5lckhUTUxcbn1cblxuZnVuY3Rpb24gcmVtb3ZlUmVmZXJlbmNlcyhodG1sOiBzdHJpbmcpIHtcbiAgY29uc3QgZG9jID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JylcbiAgZG9jLmlubmVySFRNTCA9IGh0bWxcbiAgZG9jLnF1ZXJ5U2VsZWN0b3JBbGwoJy5yZWZlcmVuY2VzJykuZm9yRWFjaCgoZWxlbSkgPT4gZWxlbS5yZW1vdmUoKSlcbiAgcmV0dXJuIGRvYy5pbm5lckhUTUxcbn1cblxuLyoqXG4gKiBIYW5kbGUgc3VjY2Vzc2Z1bCByZXNwb25zZSBmcm9tIFBhbmRvY1xuICogQHBhcmFtIHtzdHJpbmd9IFJldHVybmVkIEhUTUxcbiAqIEByZXR1cm4ge2FycmF5fSB3aXRoIEFyZ3VtZW50cyBmb3IgY2FsbGJhY2tGdW5jdGlvbiAoZXJyb3Igc2V0IHRvIG51bGwpXG4gKi9cbmZ1bmN0aW9uIGhhbmRsZVN1Y2Nlc3MoaHRtbDogc3RyaW5nLCByZW5kZXJNYXRoOiBib29sZWFuKSB7XG4gIGlmIChyZW5kZXJNYXRoKSB7XG4gICAgaHRtbCA9IGhhbmRsZU1hdGgoaHRtbClcbiAgfVxuICBpZiAoYXRvbUNvbmZpZygpLnBhbmRvY1JlbW92ZVJlZmVyZW5jZXMpIHtcbiAgICBodG1sID0gcmVtb3ZlUmVmZXJlbmNlcyhodG1sKVxuICB9XG4gIHJldHVybiBodG1sXG59XG5cbi8qKlxuICogSGFuZGxlIHJlc3BvbnNlIGZyb20gUGFuZG9jXG4gKiBAcGFyYW0ge09iamVjdH0gZXJyb3IgaWYgdGhyb3duXG4gKiBAcGFyYW0ge3N0cmluZ30gUmV0dXJuZWQgSFRNTFxuICovXG5mdW5jdGlvbiBoYW5kbGVSZXNwb25zZShlcnJvcjogc3RyaW5nLCBodG1sOiBzdHJpbmcsIHJlbmRlck1hdGg6IGJvb2xlYW4pIHtcbiAgaWYgKGVycm9yKSB7XG4gICAgcmV0dXJuIGhhbmRsZUVycm9yKGVycm9yLCBodG1sLCByZW5kZXJNYXRoKVxuICB9IGVsc2Uge1xuICAgIHJldHVybiBoYW5kbGVTdWNjZXNzKGh0bWwsIHJlbmRlck1hdGgpXG4gIH1cbn1cblxuLyoqXG4gKiBSZW5kZXJzIG1hcmtkb3duIHdpdGggcGFuZG9jXG4gKiBAcGFyYW0ge3N0cmluZ30gZG9jdW1lbnQgaW4gbWFya2Rvd25cbiAqIEBwYXJhbSB7Ym9vbGVhbn0gd2hldGhlciB0byByZW5kZXIgdGhlIG1hdGggd2l0aCBtYXRoamF4XG4gKiBAcGFyYW0ge2Z1bmN0aW9ufSBjYWxsYmFja0Z1bmN0aW9uXG4gKi9cbmZ1bmN0aW9uIHJlbmRlclBhbmRvYyhcbiAgdGV4dDogc3RyaW5nLFxuICBmaWxlUGF0aDogc3RyaW5nIHwgdW5kZWZpbmVkLFxuICByZW5kZXJNYXRoOiBib29sZWFuLFxuICBjYjogKGVycjogRXJyb3IgfCBudWxsLCByZXN1bHQ6IHN0cmluZykgPT4gdm9pZCxcbikge1xuICBjb25zdCB7IGFyZ3MsIG9wdHMgfSA9IHNldFBhbmRvY09wdGlvbnMoZmlsZVBhdGgsIHJlbmRlck1hdGgpXG4gIGNvbnN0IGNwID0gQ1AuZXhlY0ZpbGUoXG4gICAgYXRvbUNvbmZpZygpLnBhbmRvY1BhdGgsXG4gICAgZ2V0QXJndW1lbnRzKGFyZ3MpLFxuICAgIG9wdHMsXG4gICAgZnVuY3Rpb24oZXJyb3IsIHN0ZG91dCwgc3RkZXJyKSB7XG4gICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEVycm9yKGVycm9yLnRvU3RyaW5nKCksIHtcbiAgICAgICAgICBzdGFjazogZXJyb3Iuc3RhY2ssXG4gICAgICAgICAgZGlzbWlzc2FibGU6IHRydWUsXG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgICBjb25zdCByZXN1bHQgPSBoYW5kbGVSZXNwb25zZShzdGRlcnIgfHwgJycsIHN0ZG91dCB8fCAnJywgcmVuZGVyTWF0aClcbiAgICAgIHJldHVybiBjYihudWxsLCByZXN1bHQpXG4gICAgfSxcbiAgKVxuICBjcC5zdGRpbi53cml0ZSh0ZXh0KVxuICBjcC5zdGRpbi5lbmQoKVxufVxuXG5mdW5jdGlvbiBnZXRBcmd1bWVudHMoaWFyZ3M6IEFyZ3MpIHtcbiAgY29uc3QgYXJncyA9IF8ucmVkdWNlKFxuICAgIGlhcmdzLFxuICAgIGZ1bmN0aW9uKHJlczogc3RyaW5nW10sIHZhbCwga2V5KSB7XG4gICAgICBpZiAodmFsICYmICFfLmlzRW1wdHkodmFsKSkge1xuICAgICAgICBjb25zdCBudmFsOiBzdHJpbmdbXSA9IF8uZmxhdHRlbihbdmFsXSlcbiAgICAgICAgXy5mb3JFYWNoKG52YWwsIGZ1bmN0aW9uKHY6IHN0cmluZykge1xuICAgICAgICAgIGlmICghXy5pc0VtcHR5KHYpKSB7XG4gICAgICAgICAgICByZXMucHVzaChgLS0ke2tleX09JHt2fWApXG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgfVxuICAgICAgcmV0dXJuIHJlc1xuICAgIH0sXG4gICAgW10sXG4gIClcbiAgY29uc3QgcmVzOiBzdHJpbmdbXSA9IFtdXG4gIGZvciAoY29uc3QgdmFsIG9mIFtcbiAgICAuLi5hcmdzLFxuICAgIC4uLmF0b20uY29uZmlnLmdldCgnbWFya2Rvd24tcHJldmlldy1wbHVzLnBhbmRvY0FyZ3VtZW50cycpISxcbiAgXSkge1xuICAgIGNvbnN0IG5ld3ZhbCA9IHZhbC5yZXBsYWNlKC9eKC0tW1xcd1xcLV0rKVxccyguKykkL2ksICckMT0kMicpXG4gICAgaWYgKG5ld3ZhbC5zdWJzdHIoMCwgMSkgPT09ICctJykge1xuICAgICAgcmVzLnB1c2gobmV3dmFsKVxuICAgIH1cbiAgfVxuICBjb25zb2xlLndhcm4ocmVzKVxuICByZXR1cm4gcmVzXG59XG5cbmV4cG9ydCA9IHtcbiAgcmVuZGVyUGFuZG9jLFxuICBfX3Rlc3RpbmdfXzoge1xuICAgIGZpbmRGaWxlUmVjdXJzaXZlLFxuICAgIHNldFBhbmRvY09wdGlvbnMsXG4gICAgZ2V0QXJndW1lbnRzLFxuICB9LFxufVxuIl19