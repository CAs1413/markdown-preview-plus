"use strict";
const _ = require("lodash");
const CP = require("child_process");
let fs = null;
let path = null;
const atomConfig = () => atom.config.get("markdown-preview-plus");
const getMathJaxPath = (function () {
    let cached = null;
    return function () {
        if (cached != null) {
            return cached;
        }
        try {
            return (cached = require.resolve("MathJax"));
        }
        catch (e) {
            return "";
        }
    };
})();
var findFileRecursive = function (filePath, fileName) {
    if (fs == null) {
        fs = require("fs");
    }
    if (path == null) {
        path = require("path");
    }
    const bibFile = path.join(filePath, "../", fileName);
    if (fs.existsSync(bibFile)) {
        return bibFile;
    }
    else {
        const newPath = path.join(bibFile, "..");
        if (newPath !== filePath && !_.includes(atom.project.getPaths(), newPath)) {
            return findFileRecursive(newPath, fileName);
        }
        else {
            return false;
        }
    }
};
const setPandocOptions = function (filePath, renderMath) {
    const args = {
        from: atomConfig().pandocMarkdownFlavor,
        to: "html"
    };
    const opts = { maxBuffer: Infinity };
    if (path == null) {
        path = require("path");
    }
    if (filePath != null) {
        opts.cwd = path.dirname(filePath);
    }
    const mathjaxPath = getMathJaxPath();
    args.mathjax = renderMath ? mathjaxPath : undefined;
    args.filter = atomConfig().pandocFilters;
    if (atomConfig().pandocBibliography) {
        args.filter.push("pandoc-citeproc");
        let bibFile = findFileRecursive(filePath, atomConfig().pandocBIBFile);
        if (!bibFile) {
            bibFile = atomConfig().pandocBIBFileFallback;
        }
        args.bibliography = bibFile ? bibFile : undefined;
        let cslFile = findFileRecursive(filePath, atomConfig().pandocCSLFile);
        if (!cslFile) {
            cslFile = atomConfig().pandocCSLFileFallback;
        }
        args.csl = cslFile ? cslFile : undefined;
    }
    return { args, opts };
};
const handleError = function (error, html, renderMath) {
    const message = _.uniq(error.split("\n")).join("<br>");
    html = `<h1>Pandoc Error:</h1><pre>${error}</pre><hr>${html}`;
    return handleSuccess(html, renderMath);
};
const handleMath = function (html) {
    const doc = document.createElement("div");
    doc.innerHTML = html;
    doc.querySelectorAll(".math").forEach(function (elem) {
        let math = elem.innerText;
        const mode = math.indexOf("\\[") > -1 ? "; mode=display" : "";
        math = math.replace(/\\[[()\]]/g, "");
        return (elem.outerHTML =
            '<span class="math">' +
                `<script type='math/tex${mode}'>${math}</script>` +
                "</span>");
    });
    return doc.innerHTML;
};
const removeReferences = function (html) {
    const doc = document.createElement("div");
    doc.innerHTML = html;
    doc.querySelectorAll(".references").forEach(elem => elem.remove());
    return doc.innerHTML;
};
var handleSuccess = function (html, renderMath) {
    if (renderMath) {
        html = handleMath(html);
    }
    if (atomConfig().pandocRemoveReferences) {
        html = removeReferences(html);
    }
    return [null, html];
};
const handleResponse = function (error, html, renderMath) {
    if (error) {
        return handleError(error, html, renderMath);
    }
    else {
        return handleSuccess(html, renderMath);
    }
};
const renderPandoc = function (text, filePath, renderMath, cb) {
    const { args, opts } = setPandocOptions(filePath, renderMath);
    const cp = CP.execFile(atomConfig().pandocPath, getArguments(args), opts, function (error, stdout, stderr) {
        if (error) {
            atom.notifications.addError(error.toString(), {
                stack: error.stack,
                dismissable: true
            });
        }
        const cbargs = handleResponse(stderr != null ? stderr : "", stdout != null ? stdout : "", renderMath);
        return cb(...Array.from(cbargs || []));
    });
    cp.stdin.write(text);
    return cp.stdin.end();
};
var getArguments = function (args) {
    args = _.reduce(args, function (res, val, key) {
        if (!_.isEmpty(val)) {
            val = _.flatten([val]);
            _.forEach(val, function (v) {
                if (!_.isEmpty(v)) {
                    return res.push(`--${key}=${v}`);
                }
            });
        }
        return res;
    }, []);
    args = _.union(args, atom.config.get("markdown-preview-plus.pandocArguments"));
    args = _.map(args, function (val) {
        val = val.replace(/^(--[\w\-]+)\s(.+)$/i, "$1=$2");
        if (val.substr(0, 1) !== "-") {
            return undefined;
        }
        else {
            return val;
        }
    });
    return _.reject(args, _.isEmpty);
};
module.exports = {
    renderPandoc,
    __testing__: {
        findFileRecursive,
        setPandocOptions,
        getArguments
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFuZG9jLWhlbHBlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9wYW5kb2MtaGVscGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFPQSxNQUFNLENBQUMsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUE7QUFDM0IsTUFBTSxFQUFFLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFBO0FBQ25DLElBQUksRUFBRSxHQUFHLElBQUksQ0FBQTtBQUNiLElBQUksSUFBSSxHQUFHLElBQUksQ0FBQTtBQUVmLE1BQU0sVUFBVSxHQUFHLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLHVCQUF1QixDQUFDLENBQUE7QUFLakUsTUFBTSxjQUFjLEdBQUcsQ0FBQztJQUN0QixJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUE7SUFDakIsTUFBTSxDQUFDO1FBQ0wsRUFBRSxDQUFDLENBQUMsTUFBTSxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDbkIsTUFBTSxDQUFDLE1BQU0sQ0FBQTtRQUNmLENBQUM7UUFDRCxJQUFJLENBQUM7WUFDSCxNQUFNLENBQUMsQ0FBQyxNQUFNLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFBO1FBQzlDLENBQUM7UUFBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ1gsTUFBTSxDQUFDLEVBQUUsQ0FBQTtRQUNYLENBQUM7SUFDSCxDQUFDLENBQUE7QUFDSCxDQUFDLENBQUMsRUFBRSxDQUFBO0FBRUosSUFBSSxpQkFBaUIsR0FBRyxVQUFTLFFBQVEsRUFBRSxRQUFRO0lBQ2pELEVBQUUsQ0FBQyxDQUFDLEVBQUUsSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ2YsRUFBRSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUNwQixDQUFDO0lBQ0QsRUFBRSxDQUFDLENBQUMsSUFBSSxJQUFJLElBQUks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RCxpQkFBUztJQUNQLFlBQVk7SUFDWixXQUFXLEVBQUU7UUFDWCxpQkFBaUI7UUFDakIsZ0JBQWdCO1FBQ2hCLFlBQVk7S0FDYjtDQUNGLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogZGVjYWZmZWluYXRlIHN1Z2dlc3Rpb25zOlxuICogRFMxMDE6IFJlbW92ZSB1bm5lY2Vzc2FyeSB1c2Ugb2YgQXJyYXkuZnJvbVxuICogRFMxMDI6IFJlbW92ZSB1bm5lY2Vzc2FyeSBjb2RlIGNyZWF0ZWQgYmVjYXVzZSBvZiBpbXBsaWNpdCByZXR1cm5zXG4gKiBEUzIwNzogQ29uc2lkZXIgc2hvcnRlciB2YXJpYXRpb25zIG9mIG51bGwgY2hlY2tzXG4gKiBGdWxsIGRvY3M6IGh0dHBzOi8vZ2l0aHViLmNvbS9kZWNhZmZlaW5hdGUvZGVjYWZmZWluYXRlL2Jsb2IvbWFzdGVyL2RvY3Mvc3VnZ2VzdGlvbnMubWRcbiAqL1xuY29uc3QgXyA9IHJlcXVpcmUoXCJsb2Rhc2hcIilcbmNvbnN0IENQID0gcmVxdWlyZShcImNoaWxkX3Byb2Nlc3NcIilcbmxldCBmcyA9IG51bGxcbmxldCBwYXRoID0gbnVsbFxuXG5jb25zdCBhdG9tQ29uZmlnID0gKCkgPT4gYXRvbS5jb25maWcuZ2V0KFwibWFya2Rvd24tcHJldmlldy1wbHVzXCIpXG5cbi8qKlxuICogU2V0cyBsb2NhbCBtYXRoamF4UGF0aCBpZiBhdmFpbGFibGVcbiAqL1xuY29uc3QgZ2V0TWF0aEpheFBhdGggPSAoZnVuY3Rpb24oKSB7XG4gIGxldCBjYWNoZWQgPSBudWxsXG4gIHJldHVybiBmdW5jdGlvbigpIHtcbiAgICBpZiAoY2FjaGVkICE9IG51bGwpIHtcbiAgICAgIHJldHVybiBjYWNoZWRcbiAgICB9XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiAoY2FjaGVkID0gcmVxdWlyZS5yZXNvbHZlKFwiTWF0aEpheFwiKSlcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICByZXR1cm4gXCJcIlxuICAgIH1cbiAgfVxufSkoKVxuXG52YXIgZmluZEZpbGVSZWN1cnNpdmUgPSBmdW5jdGlvbihmaWxlUGF0aCwgZmlsZU5hbWUpIHtcbiAgaWYgKGZzID09IG51bGwpIHtcbiAgICBmcyA9IHJlcXVpcmUoXCJmc1wiKVxuICB9XG4gIGlmIChwYXRoID09IG51bGwpIHtcbiAgICBwYXRoID0gcmVxdWlyZShcInBhdGhcIilcbiAgfVxuICBjb25zdCBiaWJGaWxlID0gcGF0aC5qb2luKGZpbGVQYXRoLCBcIi4uL1wiLCBmaWxlTmFtZSlcbiAgaWYgKGZzLmV4aXN0c1N5bmMoYmliRmlsZSkpIHtcbiAgICByZXR1cm4gYmliRmlsZVxuICB9IGVsc2Uge1xuICAgIGNvbnN0IG5ld1BhdGggPSBwYXRoLmpvaW4oYmliRmlsZSwgXCIuLlwiKVxuICAgIGlmIChuZXdQYXRoICE9PSBmaWxlUGF0aCAmJiAhXy5pbmNsdWRlcyhhdG9tLnByb2plY3QuZ2V0UGF0aHMoKSwgbmV3UGF0aCkpIHtcbiAgICAgIHJldHVybiBmaW5kRmlsZVJlY3Vyc2l2ZShuZXdQYXRoLCBmaWxlTmFtZSlcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIGZhbHNlXG4gICAgfVxuICB9XG59XG5cbi8qKlxuICogU2V0cyBsb2NhbCB2YXJpYWJsZXMgbmVlZGVkIGZvciBldmVyeXRoaW5nXG4gKiBAcGFyYW0ge3N0cmluZ30gcGF0aCB0byBtYXJrZG93biBmaWxlXG4gKlxuICovXG5jb25zdCBzZXRQYW5kb2NPcHRpb25zID0gZnVuY3Rpb24oZmlsZVBhdGgsIHJlbmRlck1hdGgpIHtcbiAgY29uc3QgYXJncyA9IHtcbiAgICBmcm9tOiBhdG9tQ29uZmlnKCkucGFuZG9jTWFya2Rvd25GbGF2b3IsXG4gICAgdG86IFwiaHRtbFwiXG4gIH1cbiAgY29uc3Qgb3B0cyA9IHsgbWF4QnVmZmVyOiBJbmZpbml0eSB9IC8vIHNlZSBodHRwczovL2dpdGh1Yi5jb20vYXRvbS1jb21tdW5pdHkvbWFya2Rvd24tcHJldmlldy1wbHVzL2lzc3Vlcy8zMTZcbiAgaWYgKHBhdGggPT0gbnVsbCkge1xuICAgIHBhdGggPSByZXF1aXJlKFwicGF0aFwiKVxuICB9XG4gIGlmIChmaWxlUGF0aCAhPSBudWxsKSB7XG4gICAgb3B0cy5jd2QgPSBwYXRoLmRpcm5hbWUoZmlsZVBhdGgpXG4gIH1cbiAgY29uc3QgbWF0aGpheFBhdGggPSBnZXRNYXRoSmF4UGF0aCgpXG4gIGFyZ3MubWF0aGpheCA9IHJlbmRlck1hdGggPyBtYXRoamF4UGF0aCA6IHVuZGVmaW5lZFxuICBhcmdzLmZpbHRlciA9IGF0b21Db25maWcoKS5wYW5kb2NGaWx0ZXJzXG4gIGlmIChhdG9tQ29uZmlnKCkucGFuZG9jQmlibGlvZ3JhcGh5KSB7XG4gICAgYXJncy5maWx0ZXIucHVzaChcInBhbmRvYy1jaXRlcHJvY1wiKVxuICAgIGxldCBiaWJGaWxlID0gZmluZEZpbGVSZWN1cnNpdmUoZmlsZVBhdGgsIGF0b21Db25maWcoKS5wYW5kb2NCSUJGaWxlKVxuICAgIGlmICghYmliRmlsZSkge1xuICAgICAgYmliRmlsZSA9IGF0b21Db25maWcoKS5wYW5kb2NCSUJGaWxlRmFsbGJhY2tcbiAgICB9XG4gICAgYXJncy5iaWJsaW9ncmFwaHkgPSBiaWJGaWxlID8gYmliRmlsZSA6IHVuZGVmaW5lZFxuICAgIGxldCBjc2xGaWxlID0gZmluZEZpbGVSZWN1cnNpdmUoZmlsZVBhdGgsIGF0b21Db25maWcoKS5wYW5kb2NDU0xGaWxlKVxuICAgIGlmICghY3NsRmlsZSkge1xuICAgICAgY3NsRmlsZSA9IGF0b21Db25maWcoKS5wYW5kb2NDU0xGaWxlRmFsbGJhY2tcbiAgICB9XG4gICAgYXJncy5jc2wgPSBjc2xGaWxlID8gY3NsRmlsZSA6IHVuZGVmaW5lZFxuICB9XG4gIHJldHVybiB7IGFyZ3MsIG9wdHMgfVxufVxuXG4vKipcbiAqIEhhbmRsZSBlcnJvciByZXNwb25zZSBmcm9tIFBhbmRvY1xuICogQHBhcmFtIHtlcnJvcn0gUmV0dXJuZWQgZXJyb3JcbiAqIEBwYXJhbSB7c3RyaW5nfSBSZXR1cm5lZCBIVE1MXG4gKiBAcmV0dXJuIHthcnJheX0gd2l0aCBBcmd1bWVudHMgZm9yIGNhbGxiYWNrRnVuY3Rpb24gKGVycm9yIHNldCB0byBudWxsKVxuICovXG5jb25zdCBoYW5kbGVFcnJvciA9IGZ1bmN0aW9uKGVycm9yLCBodG1sLCByZW5kZXJNYXRoKSB7XG4gIGNvbnN0IG1lc3NhZ2UgPSBfLnVuaXEoZXJyb3Iuc3BsaXQoXCJcXG5cIikpLmpvaW4oXCI8YnI+XCIpXG4gIGh0bWwgPSBgPGgxPlBhbmRvYyBFcnJvcjo8L2gxPjxwcmU+JHtlcnJvcn08L3ByZT48aHI+JHtodG1sfWBcbiAgcmV0dXJuIGhhbmRsZVN1Y2Nlc3MoaHRtbCwgcmVuZGVyTWF0aClcbn1cblxuLyoqXG4gKiBBZGp1c3RzIGFsbCBtYXRoIGVudmlyb25tZW50cyBpbiBIVE1MXG4gKiBAcGFyYW0ge3N0cmluZ30gSFRNTCB0byBiZSBhZGp1c3RlZFxuICogQHJldHVybiB7c3RyaW5nfSBIVE1MIHdpdGggYWRqdXN0ZWQgbWF0aCBlbnZpcm9ubWVudHNcbiAqL1xuY29uc3QgaGFuZGxlTWF0aCA9IGZ1bmN0aW9uKGh0bWwpIHtcbiAgY29uc3QgZG9jID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKVxuICBkb2MuaW5uZXJIVE1MID0gaHRtbFxuICBkb2MucXVlcnlTZWxlY3RvckFsbChcIi5tYXRoXCIpLmZvckVhY2goZnVuY3Rpb24oZWxlbSkge1xuICAgIGxldCBtYXRoID0gZWxlbS5pbm5lclRleHRcbiAgICAvLyBTZXQgbW9kZSBpZiBpdCBpcyBibG9jayBtYXRoXG4gICAgY29uc3QgbW9kZSA9IG1hdGguaW5kZXhPZihcIlxcXFxbXCIpID4gLTEgPyBcIjsgbW9kZT1kaXNwbGF5XCIgOiBcIlwiXG5cbiAgICAvLyBSZW1vdmUgc291cnJvdW5kaW5nIFxcWyBcXF0gYW5kIFxcKCBcXClcbiAgICBtYXRoID0gbWF0aC5yZXBsYWNlKC9cXFxcW1soKVxcXV0vZywgXCJcIilcbiAgICByZXR1cm4gKGVsZW0ub3V0ZXJIVE1MID1cbiAgICAgICc8c3BhbiBjbGFzcz1cIm1hdGhcIj4nICtcbiAgICAgIGA8c2NyaXB0IHR5cGU9J21hdGgvdGV4JHttb2RlfSc+JHttYXRofTwvc2NyaXB0PmAgK1xuICAgICAgXCI8L3NwYW4+XCIpXG4gIH0pXG5cbiAgcmV0dXJuIGRvYy5pbm5lckhUTUxcbn1cblxuY29uc3QgcmVtb3ZlUmVmZXJlbmNlcyA9IGZ1bmN0aW9uKGh0bWwpIHtcbiAgY29uc3QgZG9jID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKVxuICBkb2MuaW5uZXJIVE1MID0gaHRtbFxuICBkb2MucXVlcnlTZWxlY3RvckFsbChcIi5yZWZlcmVuY2VzXCIpLmZvckVhY2goZWxlbSA9PiBlbGVtLnJlbW92ZSgpKVxuICByZXR1cm4gZG9jLmlubmVySFRNTFxufVxuXG4vKipcbiAqIEhhbmRsZSBzdWNjZXNzZnVsIHJlc3BvbnNlIGZyb20gUGFuZG9jXG4gKiBAcGFyYW0ge3N0cmluZ30gUmV0dXJuZWQgSFRNTFxuICogQHJldHVybiB7YXJyYXl9IHdpdGggQXJndW1lbnRzIGZvciBjYWxsYmFja0Z1bmN0aW9uIChlcnJvciBzZXQgdG8gbnVsbClcbiAqL1xudmFyIGhhbmRsZVN1Y2Nlc3MgPSBmdW5jdGlvbihodG1sLCByZW5kZXJNYXRoKSB7XG4gIGlmIChyZW5kZXJNYXRoKSB7XG4gICAgaHRtbCA9IGhhbmRsZU1hdGgoaHRtbClcbiAgfVxuICBpZiAoYXRvbUNvbmZpZygpLnBhbmRvY1JlbW92ZVJlZmVyZW5jZXMpIHtcbiAgICBodG1sID0gcmVtb3ZlUmVmZXJlbmNlcyhodG1sKVxuICB9XG4gIHJldHVybiBbbnVsbCwgaHRtbF1cbn1cblxuLyoqXG4gKiBIYW5kbGUgcmVzcG9uc2UgZnJvbSBQYW5kb2NcbiAqIEBwYXJhbSB7T2JqZWN0fSBlcnJvciBpZiB0aHJvd25cbiAqIEBwYXJhbSB7c3RyaW5nfSBSZXR1cm5lZCBIVE1MXG4gKi9cbmNvbnN0IGhhbmRsZVJlc3BvbnNlID0gZnVuY3Rpb24oZXJyb3IsIGh0bWwsIHJlbmRlck1hdGgpIHtcbiAgaWYgKGVycm9yKSB7XG4gICAgcmV0dXJuIGhhbmRsZUVycm9yKGVycm9yLCBodG1sLCByZW5kZXJNYXRoKVxuICB9IGVsc2Uge1xuICAgIHJldHVybiBoYW5kbGVTdWNjZXNzKGh0bWwsIHJlbmRlck1hdGgpXG4gIH1cbn1cblxuLyoqXG4gKiBSZW5kZXJzIG1hcmtkb3duIHdpdGggcGFuZG9jXG4gKiBAcGFyYW0ge3N0cmluZ30gZG9jdW1lbnQgaW4gbWFya2Rvd25cbiAqIEBwYXJhbSB7Ym9vbGVhbn0gd2hldGhlciB0byByZW5kZXIgdGhlIG1hdGggd2l0aCBtYXRoamF4XG4gKiBAcGFyYW0ge2Z1bmN0aW9ufSBjYWxsYmFja0Z1bmN0aW9uXG4gKi9cbmNvbnN0IHJlbmRlclBhbmRvYyA9IGZ1bmN0aW9uKHRleHQsIGZpbGVQYXRoLCByZW5kZXJNYXRoLCBjYikge1xuICBjb25zdCB7IGFyZ3MsIG9wdHMgfSA9IHNldFBhbmRvY09wdGlvbnMoZmlsZVBhdGgsIHJlbmRlck1hdGgpXG4gIGNvbnN0IGNwID0gQ1AuZXhlY0ZpbGUoXG4gICAgYXRvbUNvbmZpZygpLnBhbmRvY1BhdGgsXG4gICAgZ2V0QXJndW1lbnRzKGFyZ3MpLFxuICAgIG9wdHMsXG4gICAgZnVuY3Rpb24oZXJyb3IsIHN0ZG91dCwgc3RkZXJyKSB7XG4gICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEVycm9yKGVycm9yLnRvU3RyaW5nKCksIHtcbiAgICAgICAgICBzdGFjazogZXJyb3Iuc3RhY2ssXG4gICAgICAgICAgZGlzbWlzc2FibGU6IHRydWVcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICAgIGNvbnN0IGNiYXJncyA9IGhhbmRsZVJlc3BvbnNlKFxuICAgICAgICBzdGRlcnIgIT0gbnVsbCA/IHN0ZGVyciA6IFwiXCIsXG4gICAgICAgIHN0ZG91dCAhPSBudWxsID8gc3Rkb3V0IDogXCJcIixcbiAgICAgICAgcmVuZGVyTWF0aFxuICAgICAgKVxuICAgICAgcmV0dXJuIGNiKC4uLkFycmF5LmZyb20oY2JhcmdzIHx8IFtdKSlcbiAgICB9XG4gIClcbiAgY3Auc3RkaW4ud3JpdGUodGV4dClcbiAgcmV0dXJuIGNwLnN0ZGluLmVuZCgpXG59XG5cbnZhciBnZXRBcmd1bWVudHMgPSBmdW5jdGlvbihhcmdzKSB7XG4gIGFyZ3MgPSBfLnJlZHVjZShcbiAgICBhcmdzLFxuICAgIGZ1bmN0aW9uKHJlcywgdmFsLCBrZXkpIHtcbiAgICAgIGlmICghXy5pc0VtcHR5KHZhbCkpIHtcbiAgICAgICAgdmFsID0gXy5mbGF0dGVuKFt2YWxdKVxuICAgICAgICBfLmZvckVhY2godmFsLCBmdW5jdGlvbih2KSB7XG4gICAgICAgICAgaWYgKCFfLmlzRW1wdHkodikpIHtcbiAgICAgICAgICAgIHJldHVybiByZXMucHVzaChgLS0ke2tleX09JHt2fWApXG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgfVxuICAgICAgcmV0dXJuIHJlc1xuICAgIH0sXG4gICAgW11cbiAgKVxuICBhcmdzID0gXy51bmlvbihhcmdzLCBhdG9tLmNvbmZpZy5nZXQoXCJtYXJrZG93bi1wcmV2aWV3LXBsdXMucGFuZG9jQXJndW1lbnRzXCIpKVxuICBhcmdzID0gXy5tYXAoYXJncywgZnVuY3Rpb24odmFsKSB7XG4gICAgdmFsID0gdmFsLnJlcGxhY2UoL14oLS1bXFx3XFwtXSspXFxzKC4rKSQvaSwgXCIkMT0kMlwiKVxuICAgIGlmICh2YWwuc3Vic3RyKDAsIDEpICE9PSBcIi1cIikge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZFxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdmFsXG4gICAgfVxuICB9KVxuICByZXR1cm4gXy5yZWplY3QoYXJncywgXy5pc0VtcHR5KVxufVxuXG5leHBvcnQgPSB7XG4gIHJlbmRlclBhbmRvYyxcbiAgX190ZXN0aW5nX186IHtcbiAgICBmaW5kRmlsZVJlY3Vyc2l2ZSxcbiAgICBzZXRQYW5kb2NPcHRpb25zLFxuICAgIGdldEFyZ3VtZW50c1xuICB9XG59XG4iXX0=