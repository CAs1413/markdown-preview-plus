"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const markdownItModule = require("markdown-it");
const twemoji = require("twemoji");
const path = require("path");
let markdownIt = null;
let markdownItOptions = null;
let renderLaTeX = null;
let math = null;
let lazyHeaders = null;
let checkBoxes = null;
let emoji = null;
const mathInline = (text) => `<span class='math'><script type='math/tex'>${text}</script></span>`;
const mathBlock = (text) => `<span class='math'><script type='math/tex; mode=display'>${text}</script></span>`;
const mathDollars = {
    inlineOpen: '$',
    inlineClose: '$',
    blockOpen: '$$',
    blockClose: '$$',
    inlineRenderer: mathInline,
    blockRenderer: mathBlock,
};
const mathBrackets = {
    inlineOpen: '\\(',
    inlineClose: '\\)',
    blockOpen: '\\[',
    blockClose: '\\]',
    inlineRenderer: mathInline,
    blockRenderer: mathBlock,
};
const getOptions = () => ({
    html: true,
    xhtmlOut: false,
    breaks: atom.config.get('markdown-preview-plus.breakOnSingleNewline'),
    langPrefix: 'lang-',
    linkify: true,
    typographer: true,
});
const init = function (rL) {
    renderLaTeX = rL;
    markdownItOptions = getOptions();
    markdownIt = markdownItModule(markdownItOptions);
    if (renderLaTeX) {
        if (math == null) {
            math = require('markdown-it-math');
        }
        markdownIt.use(math, mathDollars);
        markdownIt.use(math, mathBrackets);
    }
    lazyHeaders = atom.config.get('markdown-preview-plus.useLazyHeaders');
    if (lazyHeaders) {
        markdownIt.use(require('markdown-it-lazy-headers'));
    }
    checkBoxes = atom.config.get('markdown-preview-plus.useCheckBoxes');
    if (checkBoxes) {
        markdownIt.use(require('markdown-it-task-lists'));
    }
    emoji = atom.config.get('markdown-preview-plus.useEmoji');
    if (emoji) {
        markdownIt.use(require('markdown-it-emoji'));
        markdownIt.renderer.rules.emoji = function (token, idx) {
            return twemoji.parse(token[idx].content, {
                folder: 'svg',
                ext: '.svg',
                base: path.dirname(require.resolve('twemoji')) + path.sep,
            });
        };
    }
};
const needsInit = (rL) => markdownIt === null ||
    markdownItOptions === null ||
    markdownItOptions.breaks !==
        atom.config.get('markdown-preview-plus.breakOnSingleNewline') ||
    lazyHeaders !== atom.config.get('markdown-preview-plus.useLazyHeaders') ||
    checkBoxes !== atom.config.get('markdown-preview-plus.useCheckBoxes') ||
    emoji !== atom.config.get('markdown-preview-plus.emoji') ||
    rL !== renderLaTeX;
function render(text, rL) {
    if (needsInit(rL)) {
        init(rL);
    }
    return markdownIt.render(text);
}
exports.render = render;
function decode(url) {
    if (!markdownIt)
        throw new Error('markdownIt not initialized');
    return markdownIt.normalizeLinkText(url);
}
exports.decode = decode;
function getTokens(text, rL) {
    if (needsInit(rL)) {
        init(rL);
    }
    return markdownIt.parse(text, {});
}
exports.getTokens = getTokens;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFya2Rvd24taXQtaGVscGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL21hcmtkb3duLWl0LWhlbHBlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLGdEQUFnRDtBQUNoRCxtQ0FBbUM7QUFDbkMsNkJBQTRCO0FBQzVCLElBQUksVUFBVSxHQUF1QyxJQUFJLENBQUE7QUFDekQsSUFBSSxpQkFBaUIsR0FBb0MsSUFBSSxDQUFBO0FBQzdELElBQUksV0FBVyxHQUFtQixJQUFJLENBQUE7QUFDdEMsSUFBSSxJQUFJLEdBQVEsSUFBSSxDQUFBO0FBQ3BCLElBQUksV0FBVyxHQUFRLElBQUksQ0FBQTtBQUMzQixJQUFJLFVBQVUsR0FBUSxJQUFJLENBQUE7QUFDMUIsSUFBSSxLQUFLLEdBQVEsSUFBSSxDQUFBO0FBRXJCLE1BQU0sVUFBVSxHQUFHLENBQUMsSUFBWSxFQUFFLEVBQUUsQ0FDbEMsOENBQThDLElBQUksa0JBQWtCLENBQUE7QUFDdEUsTUFBTSxTQUFTLEdBQUcsQ0FBQyxJQUFZLEVBQUUsRUFBRSxDQUNqQyw0REFBNEQsSUFBSSxrQkFBa0IsQ0FBQTtBQUVwRixNQUFNLFdBQVcsR0FBRztJQUNsQixVQUFVLEVBQUUsR0FBRztJQUNmLFdBQVcsRUFBRSxHQUFHO0lBQ2hCLFNBQVMsRUFBRSxJQUFJO0lBQ2YsVUFBVSxFQUFFLElBQUk7SUFDaEIsY0FBYyxFQUFFLFVBQVU7SUFDMUIsYUFBYSxFQUFFLFNBQVM7Q0FDekIsQ0FBQTtBQUVELE1BQU0sWUFBWSxHQUFHO0lBQ25CLFVBQVUsRUFBRSxLQUFLO0lBQ2pCLFdBQVcsRUFBRSxLQUFLO0lBQ2xCLFNBQVMsRUFBRSxLQUFLO0lBQ2hCLFVBQVUsRUFBRSxLQUFLO0lBQ2pCLGNBQWMsRUFBRSxVQUFVO0lBQzFCLGFBQWEsRUFBRSxTQUFTO0NBQ3pCLENBQUE7QUFFRCxNQUFNLFVBQVUsR0FBRyxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQ3hCLElBQUksRUFBRSxJ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Q0FBQyxDQUFDLENBQUMsQ0FBQztRQUNsQixJQUFJLENBQUMsRUFBRSxDQUFDLENBQUE7SUFDVixDQUFDO0lBQ0QsTUFBTSxDQUFDLFVBQVcsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUE7QUFDakMsQ0FBQztBQUxELHdCQUtDO0FBRUQsZ0JBQXVCLEdBQVc7SUFDaEMsRUFBRSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUM7UUFBQyxNQUFNLElBQUksS0FBSyxDQUFDLDRCQUE0QixDQUFDLENBQUE7SUFDOUQsTUFBTSxDQUFDLFVBQVUsQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLENBQUMsQ0FBQTtBQUMxQyxDQUFDO0FBSEQsd0JBR0M7QUFFRCxtQkFBMEIsSUFBWSxFQUFFLEVBQVc7SUFDakQsRUFBRSxDQUFDLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNsQixJQUFJLENBQUMsRUFBRSxDQUFDLENBQUE7SUFDVixDQUFDO0lBQ0QsTUFBTSxDQUFDLFVBQVcsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFBO0FBQ3BDLENBQUM7QUFMRCw4QkFLQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBtYXJrZG93bkl0TW9kdWxlID0gcmVxdWlyZSgnbWFya2Rvd24taXQnKVxuaW1wb3J0IHR3ZW1vamkgPSByZXF1aXJlKCd0d2Vtb2ppJylcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCdcbmxldCBtYXJrZG93bkl0OiBtYXJrZG93bkl0TW9kdWxlLk1hcmtkb3duSXQgfCBudWxsID0gbnVsbFxubGV0IG1hcmtkb3duSXRPcHRpb25zOiBtYXJrZG93bkl0TW9kdWxlLk9wdGlvbnMgfCBudWxsID0gbnVsbFxubGV0IHJlbmRlckxhVGVYOiBib29sZWFuIHwgbnVsbCA9IG51bGxcbmxldCBtYXRoOiBhbnkgPSBudWxsXG5sZXQgbGF6eUhlYWRlcnM6IGFueSA9IG51bGxcbmxldCBjaGVja0JveGVzOiBhbnkgPSBudWxsXG5sZXQgZW1vamk6IGFueSA9IG51bGxcblxuY29uc3QgbWF0aElubGluZSA9ICh0ZXh0OiBzdHJpbmcpID0+XG4gIGA8c3BhbiBjbGFzcz0nbWF0aCc+PHNjcmlwdCB0eXBlPSdtYXRoL3RleCc+JHt0ZXh0fTwvc2NyaXB0Pjwvc3Bhbj5gXG5jb25zdCBtYXRoQmxvY2sgPSAodGV4dDogc3RyaW5nKSA9PlxuICBgPHNwYW4gY2xhc3M9J21hdGgnPjxzY3JpcHQgdHlwZT0nbWF0aC90ZXg7IG1vZGU9ZGlzcGxheSc+JHt0ZXh0fTwvc2NyaXB0Pjwvc3Bhbj5gXG5cbmNvbnN0IG1hdGhEb2xsYXJzID0ge1xuICBpbmxpbmVPcGVuOiAnJCcsXG4gIGlubGluZUNsb3NlOiAnJCcsXG4gIGJsb2NrT3BlbjogJyQkJyxcbiAgYmxvY2tDbG9zZTogJyQkJyxcbiAgaW5saW5lUmVuZGVyZXI6IG1hdGhJbmxpbmUsXG4gIGJsb2NrUmVuZGVyZXI6IG1hdGhCbG9jayxcbn1cblxuY29uc3QgbWF0aEJyYWNrZXRzID0ge1xuICBpbmxpbmVPcGVuOiAnXFxcXCgnLFxuICBpbmxpbmVDbG9zZTogJ1xcXFwpJyxcbiAgYmxvY2tPcGVuOiAnXFxcXFsnLFxuICBibG9ja0Nsb3NlOiAnXFxcXF0nLFxuICBpbmxpbmVSZW5kZXJlcjogbWF0aElubGluZSxcbiAgYmxvY2tSZW5kZXJlcjogbWF0aEJsb2NrLFxufVxuXG5jb25zdCBnZXRPcHRpb25zID0gKCkgPT4gKHtcbiAgaHRtbDogdHJ1ZSxcbiAgeGh0bWxPdXQ6IGZhbHNlLFxuICBicmVha3M6IGF0b20uY29uZmlnLmdldCgnbWFya2Rvd24tcHJldmlldy1wbHVzLmJyZWFrT25TaW5nbGVOZXdsaW5lJyksXG4gIGxhbmdQcmVmaXg6ICdsYW5nLScsXG4gIGxpbmtpZnk6IHRydWUsXG4gIHR5cG9ncmFwaGVyOiB0cnVlLFxufSlcblxuY29uc3QgaW5pdCA9IGZ1bmN0aW9uKHJMOiBib29sZWFuKSB7XG4gIHJlbmRlckxhVGVYID0gckxcblxuICBtYXJrZG93bkl0T3B0aW9ucyA9IGdldE9wdGlvbnMoKVxuXG4gIG1hcmtkb3duSXQgPSBtYXJrZG93bkl0TW9kdWxlKG1hcmtkb3duSXRPcHRpb25zKVxuXG4gIGlmIChyZW5kZXJMYVRlWCkge1xuICAgIGlmIChtYXRoID09IG51bGwpIHtcbiAgICAgIG1hdGggPSByZXF1aXJlKCdtYXJrZG93bi1pdC1tYXRoJylcbiAgICB9XG4gICAgbWFya2Rvd25JdC51c2UobWF0aCwgbWF0aERvbGxhcnMpXG4gICAgbWFya2Rvd25JdC51c2UobWF0aCwgbWF0aEJyYWNrZXRzKVxuICB9XG5cbiAgbGF6eUhlYWRlcnMgPSBhdG9tLmNvbmZpZy5nZXQoJ21hcmtkb3duLXByZXZpZXctcGx1cy51c2VMYXp5SGVhZGVycycpXG5cbiAgaWYgKGxhenlIZWFkZXJzKSB7XG4gICAgbWFya2Rvd25JdC51c2UocmVxdWlyZSgnbWFya2Rvd24taXQtbGF6eS1oZWFkZXJzJykpXG4gIH1cblxuICBjaGVja0JveGVzID0gYXRvbS5jb25maWcuZ2V0KCdtYXJrZG93bi1wcmV2aWV3LXBsdXMudXNlQ2hlY2tCb3hlcycpXG5cbiAgaWYgKGNoZWNrQm94ZXMpIHtcbiAgICBtYXJrZG93bkl0LnVzZShyZXF1aXJlKCdtYXJrZG93bi1pdC10YXNrLWxpc3RzJykpXG4gIH1cblxuICBlbW9qaSA9IGF0b20uY29uZmlnLmdldCgnbWFya2Rvd24tcHJldmlldy1wbHVzLnVzZUVtb2ppJylcblxuICBpZiAoZW1vamkpIHtcbiAgICBtYXJrZG93bkl0LnVzZShyZXF1aXJlKCdtYXJrZG93bi1pdC1lbW9qaScpKVxuICAgIG1hcmtkb3duSXQucmVuZGVyZXIucnVsZXMuZW1vamkgPSBmdW5jdGlvbih0b2tlbiwgaWR4KSB7XG4gICAgICByZXR1cm4gdHdlbW9qaS5wYXJzZSh0b2tlbltpZHhdLmNvbnRlbnQsIHtcbiAgICAgICAgZm9sZGVyOiAnc3ZnJyxcbiAgICAgICAgZXh0OiAnLnN2ZycsXG4gICAgICAgIGJhc2U6IHBhdGguZGlybmFtZShyZXF1aXJlLnJlc29sdmUoJ3R3ZW1vamknKSkgKyBwYXRoLnNlcCxcbiAgICAgIH0pXG4gICAgfVxuICB9XG59XG5cbmNvbnN0IG5lZWRzSW5pdCA9IChyTDogYm9vbGVhbikgPT5cbiAgbWFya2Rvd25JdCA9PT0gbnVsbCB8fFxuICBtYXJrZG93bkl0T3B0aW9ucyA9PT0gbnVsbCB8fFxuICBtYXJrZG93bkl0T3B0aW9ucy5icmVha3MgIT09XG4gICAgYXRvbS5jb25maWcuZ2V0KCdtYXJrZG93bi1wcmV2aWV3LXBsdXMuYnJlYWtPblNpbmdsZU5ld2xpbmUnKSB8fFxuICBsYXp5SGVhZGVycyAhPT0gYXRvbS5jb25maWcuZ2V0KCdtYXJrZG93bi1wcmV2aWV3LXBsdXMudXNlTGF6eUhlYWRlcnMnKSB8fFxuICBjaGVja0JveGVzICE9PSBhdG9tLmNvbmZpZy5nZXQoJ21hcmtkb3duLXByZXZpZXctcGx1cy51c2VDaGVja0JveGVzJykgfHxcbiAgZW1vamkgIT09IGF0b20uY29uZmlnLmdldCgnbWFya2Rvd24tcHJldmlldy1wbHVzLmVtb2ppJykgfHxcbiAgckwgIT09IHJlbmRlckxhVGVYXG5cbmV4cG9ydCBmdW5jdGlvbiByZW5kZXIodGV4dDogc3RyaW5nLCByTDogYm9vbGVhbikge1xuICBpZiAobmVlZHNJbml0KHJMKSkge1xuICAgIGluaXQockwpXG4gIH1cbiAgcmV0dXJuIG1hcmtkb3duSXQhLnJlbmRlcih0ZXh0KVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZGVjb2RlKHVybDogc3RyaW5nKSB7XG4gIGlmICghbWFya2Rvd25JdCkgdGhyb3cgbmV3IEVycm9yKCdtYXJrZG93bkl0IG5vdCBpbml0aWFsaXplZCcpXG4gIHJldHVybiBtYXJrZG93bkl0Lm5vcm1hbGl6ZUxpbmtUZXh0KHVybClcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFRva2Vucyh0ZXh0OiBzdHJpbmcsIHJMOiBib29sZWFuKSB7XG4gIGlmIChuZWVkc0luaXQockwpKSB7XG4gICAgaW5pdChyTClcbiAgfVxuICByZXR1cm4gbWFya2Rvd25JdCEucGFyc2UodGV4dCwge30pXG59XG4iXX0=