"use strict";
let WrappedDomTree;
const TwoDimArray = require("./two-dim-array");
let curHash = 0;
const hashTo = {};
module.exports = WrappedDomTree = class WrappedDomTree {
    constructor(dom, clone, rep) {
        if (clone) {
            this.shownTree = new WrappedDomTree(dom, false, this);
            this.dom = dom.cloneNode(true);
        }
        else {
            this.dom = dom;
            this.rep = rep;
        }
        this.clone = clone;
        this.hash = curHash++;
        hashTo[this.hash] = this;
        this.isText = dom.nodeType === 3;
        this.tagName = dom.tagName;
        this.className = dom.className;
        this.textData = dom.data;
        this.diffHash = {};
        if (this.isText) {
            this.size = 1;
        }
        else {
            ;
            ({ rep } = this);
            this.children = [].map.call(this.dom.childNodes, (dom, ind) => new WrappedDomTree(dom, false, rep ? rep.children[ind] : null));
            this.size = this.children.length
                ? this.children.reduce((prev, cur) => prev + cur.size, 0)
                : 0;
            if (!this.size) {
                this.size = 1;
            }
        }
    }
    diffTo(otherTree) {
        if (this.clone) {
            return this.shownTree.diffTo(otherTree);
        }
        const diff = this.rep.diff(otherTree);
        const { score } = diff;
        const { operations } = diff;
        let indexShift = 0;
        let inserted = [];
        let [last, possibleReplace, r, lastOp, lastElmDeleted, lastElmInserted] = Array.from([]);
        if (operations) {
            if (operations instanceof Array) {
                for (let op of Array.from(operations)) {
                    ;
                    (op => {
                        if (op.type === "d") {
                            const possibleLastDeleted = this.children[op.tree + indexShift]
                                .dom;
                            r = this.remove(op.tree + indexShift);
                            this.rep.remove(op.tree + indexShift);
                            if (!last || last.nextSibling === r || last === r) {
                                last = r;
                                if (last && lastOp && op.tree === lastOp.pos) {
                                    lastElmDeleted = possibleLastDeleted;
                                }
                                else {
                                    lastElmDeleted = null;
                                    lastElmInserted = null;
                                }
                                lastOp = op;
                            }
                            indexShift--;
                            return;
                        }
                        else if (op.type === "i") {
                            this.rep.insert(op.pos + indexShift, otherTree.children[op.otherTree]);
                            r = this.insert(op.pos + indexShift, otherTree.children[op.otherTree], this.rep.children[op.pos + indexShift]);
                            inserted.push(r);
                            if (!last || last.nextSibling === r) {
                                last = r;
                                lastOp = op;
                                lastElmInserted = r;
                            }
                            indexShift++;
                            return;
                        }
                        else {
                            const re = this.children[op.tree + indexShift].diffTo(otherTree.children[op.otherTree]);
                            if (!last ||
                                (last.nextSibling === this.children[op.tree + indexShift].dom &&
                                    re.last)) {
                                ;
                                ({ last } = re);
                                if (re.possibleReplace) {
                                    lastElmInserted = re.possibleReplace.cur;
                                    lastElmDeleted = re.possibleReplace.prev;
                                }
                                lastOp = op;
                            }
                            inserted = inserted.concat(re.inserted);
                            return;
                        }
                    })(op);
                }
            }
            else {
                console.log(operations);
                throw new Error("invalid operations");
            }
        }
        if (lastOp && lastOp.type !== "i" && lastElmInserted && lastElmDeleted) {
            possibleReplace = {
                cur: lastElmInserted,
                prev: lastElmDeleted
            };
        }
        return {
            last,
            inserted,
            possibleReplace
        };
    }
    insert(i, tree, rep) {
        const dom = tree.dom.cloneNode(true);
        if (i === this.dom.childNodes.length) {
            this.dom.appendChild(dom);
        }
        else {
            this.dom.insertBefore(dom, this.dom.childNodes[i]);
        }
        const ctree = new WrappedDomTree(dom, false, rep);
        this.children.splice(i, 0, ctree);
        return this.dom.childNodes[i];
    }
    remove(i) {
        this.dom.removeChild(this.dom.childNodes[i]);
        this.children[i].removeSelf();
        this.children.splice(i, 1);
        return this.dom.childNodes[i - 1];
    }
    diff(otherTree, tmax) {
        let i;
        if (this.equalTo(otherTree)) {
            return { score: 0, operations: null };
        }
        if (this.cannotReplaceWith(otherTree)) {
            return { score: 1 / 0, operations: null };
        }
        const key = otherTree.hash;
        if (Array.from(this.diffHash).includes(key)) {
            return this.diffHash[key];
        }
        if (tmax === undefined) {
            tmax = 100000;
        }
        if (tmax <= 0) {
            return 0;
        }
        let offset = 0;
        const forwardSearch = offset => {
            return (offset < this.children.length &&
                offset < otherTree.children.length &&
                this.children[offset].equalTo(otherTree.children[offset]));
        };
        while (forwardSearch(offset)) {
            offset++;
        }
        const dp = new TwoDimArray(this.children.length + 1 - offset, otherTree.children.length + 1 - offset);
        const p = new TwoDimArray(this.children.length + 1 - offset, otherTree.children.length + 1 - offset);
        dp.set(0, 0, 0);
        let sum = 0;
        if (otherTree.children.length - offset > 1) {
            let asc, end;
            for (i = 1, end = otherTree.children.length - offset - 1, asc = 1 <= end; asc ? i <= end : i >= end; asc ? i++ : i--) {
                dp.set(0, i, sum);
                p.set(0, i, i - 1);
                sum += otherTree.children[i + offset].size;
            }
        }
        if (otherTree.children.length - offset > 0) {
            dp.set(0, otherTree.children.length - offset, sum);
            p.set(0, otherTree.children.length - offset, otherTree.children.length - 1 - offset);
        }
        sum = 0;
        if (this.children.length - offset > 1) {
            let asc1, end1;
            for (i = 1, end1 = this.children.length - offset - 1, asc1 = 1 <= end1; asc1 ? i <= end1 : i >= end1; asc1 ? i++ : i--) {
                dp.set(i, 0, sum);
                p.set(i, 0, (i - 1) * p.col);
                sum += this.children[i + offset].size;
            }
        }
        if (this.children.length - offset) {
            dp.set(this.children.length - offset, 0, sum);
            p.set(this.children.length - offset, 0, (this.children.length - 1 - offset) * p.col);
        }
        var getScore = (i, j, max) => {
            if (dp.get(i, j) !== undefined) {
                return dp.get(i, j);
            }
            if (max === undefined) {
                max = 1 / 0;
            }
            if (max <= 0) {
                return 1 / 0;
            }
            let val = max;
            const bound = max;
            const subdiff = this.children[i - 1 + offset].diff(otherTree.children[j - 1 + offset], bound).score;
            let force = false;
            if (subdiff < bound &&
                subdiff + 1 <
                    this.children[i - 1 + offset].size +
                        otherTree.children[j - 1 + offset].size) {
                force = true;
            }
            val = getScore(i - 1, j - 1, bound - subdiff) + subdiff;
            let prev = p.getInd(i - 1, j - 1);
            if (!force) {
                let other = getScore(i - 1, j, Math.min(val, max) - this.children[i - 1 + offset].size) + this.children[i - 1 + offset].size;
                if (other < val) {
                    prev = p.getInd(i - 1, j);
                    val = other;
                }
                other =
                    getScore(i, j - 1, Math.min(val, max) - otherTree.children[j - 1 + offset].size) + otherTree.children[j - 1 + offset].size;
                if (other < val) {
                    prev = p.getInd(i, j - 1);
                    val = other;
                }
            }
            if (val >= max) {
                val = 1 / 0;
            }
            dp.set(i, j, val);
            p.set(i, j, prev);
            return val;
        };
        const score = getScore(this.children.length - offset, otherTree.children.length - offset, tmax);
        const operations = [];
        let cur = p.getInd(this.children.length - offset, otherTree.children.length - offset);
        let cr = this.children.length - 1 - offset;
        let cc = otherTree.children.length - 1 - offset;
        while (p.rawGet(cur) !== undefined) {
            const prev = p.rawGet(cur);
            const rc = p.get2DInd(prev);
            const pr = rc.r - 1;
            const pc = rc.c - 1;
            if (pr === cr) {
                operations.unshift({
                    type: "i",
                    otherTree: cc + offset,
                    pos: cr + 1 + offset
                });
            }
            else if (pc === cc) {
                operations.unshift({
                    type: "d",
                    tree: cr + offset
                });
            }
            else {
                const op = this.children[cr + offset].diff(otherTree.children[cc + offset]).operations;
                if (op && op.length) {
                    operations.unshift({
                        type: "r",
                        tree: cr + offset,
                        otherTree: cc + offset
                    });
                }
            }
            cur = prev;
            cr = pr;
            cc = pc;
        }
        this.diffHash[key] = {
            score,
            operations
        };
        return this.diffHash[key];
    }
    equalTo(otherTree) {
        return this.dom.isEqualNode(otherTree.dom);
    }
    cannotReplaceWith(otherTree) {
        return (this.isText ||
            otherTree.isText ||
            this.tagName !== otherTree.tagName ||
            this.className !== otherTree.className ||
            this.className === "math" ||
            this.className === "atom-text-editor" ||
            this.tagName === "A" ||
            (this.tagName === "IMG" && !this.dom.isEqualNode(otherTree.dom)));
    }
    getContent() {
        if (this.dom.outerHTML) {
            return this.dom.outerHTML;
        }
        else {
            return this.textData;
        }
    }
    removeSelf() {
        hashTo[this.hash] = null;
        this.children && this.children.forEach(c => c.removeSelf());
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid3JhcHBlZC1kb20tdHJlZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy93cmFwcGVkLWRvbS10cmVlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQTZCQSxZQUFZLENBQUE7QUFFWixJQUFJLGNBQWMsQ0FBQTtBQUNsQixNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsaUJBQWlCLENBQUMsQ0FBQTtBQUU5QyxJQUFJLE9BQU8sR0FBRyxDQUFDLENBQUE7QUFDZixNQUFNLE1BQU0sR0FBRyxFQUFFLENBQUE7QUFFakIsTUFBTSxDQUFDLE9BQU8sR0FBRyxjQUFjLEdBQUc7SUFLaEMsWUFBWSxHQUFHLEVBQUUsS0FBSyxFQUFFLEdBQUc7UUFDekIsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUNWLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxjQUFjLENBQUMsR0FBRyxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQTtZQUNyRCxJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDaEMsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ04sSUFBSSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUE7WUFDZCxJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQTtRQUNoQixDQUFDO1FBRUQsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUE7UUFDbEIsSUFBSSxDQUFDLElBQUksR0FBRyxPQUFPLEVBQUUsQ0FBQTtRQUNyQixNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQTtRQUN4QixJQUFJLENBQUMsTUFBTSxHQUFHLEdBQUcsQ0FBQyxRQUFRLEtBQUssQ0FBQyxDQUFBO1FBQ2hDLElBQUksQ0FBQyxPQUFPLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQTtRQUMxQixJQUFJLENBQUMsU0FBUyxHQUFHLEdBQUcsQ0FBQyxTQUFTLENB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QUM7WUFDdkIsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFBO1FBQzNCLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFBO1FBQ3RCLENBQUM7SUFDSCxDQUFDO0lBRUQsVUFBVTtRQUNSLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFBO1FBQ3hCLElBQUksQ0FBQyxRQUFRLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQTtJQUM3RCxDQUFDO0NBQ0YsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBkZWNhZmZlaW5hdGUgc3VnZ2VzdGlvbnM6XG4gKiBEUzEwMTogUmVtb3ZlIHVubmVjZXNzYXJ5IHVzZSBvZiBBcnJheS5mcm9tXG4gKiBEUzEwMjogUmVtb3ZlIHVubmVjZXNzYXJ5IGNvZGUgY3JlYXRlZCBiZWNhdXNlIG9mIGltcGxpY2l0IHJldHVybnNcbiAqIERTMjAyOiBTaW1wbGlmeSBkeW5hbWljIHJhbmdlIGxvb3BzXG4gKiBGdWxsIGRvY3M6IGh0dHBzOi8vZ2l0aHViLmNvbS9kZWNhZmZlaW5hdGUvZGVjYWZmZWluYXRlL2Jsb2IvbWFzdGVyL2RvY3Mvc3VnZ2VzdGlvbnMubWRcbiAqL1xuLy8gVGhpcyBmaWxlIGluY29ycG9yYXRlcyBjb2RlIGZyb20gW21hcmttb25dKGh0dHBzOi8vZ2l0aHViLmNvbS95eWpoYW8vbWFya21vbilcbi8vIGNvdmVyZWQgYnkgdGhlIGZvbGxvd2luZyB0ZXJtczpcbi8vXG4vLyBDb3B5cmlnaHQgKGMpIDIwMTQsIFlhbyBZdWppYW4sIGh0dHA6Ly95anlhby5jb21cbi8vXG4vLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5XG4vLyBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSBcIlNvZnR3YXJlXCIpLCB0byBkZWFsXG4vLyBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzXG4vLyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsXG4vLyBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXNcbi8vIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6XG4vL1xuLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW5cbi8vIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLlxuLy9cbi8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCBcIkFTIElTXCIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1Jcbi8vIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLFxuLy8gRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFXG4vLyBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSXG4vLyBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLFxuLy8gT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTlxuLy8gVEhFIFNPRlRXQVJFLlxuXCJ1c2Ugc3RyaWN0XCJcblxubGV0IFdyYXBwZWREb21UcmVlXG5jb25zdCBUd29EaW1BcnJheSA9IHJlcXVpcmUoXCIuL3R3by1kaW0tYXJyYXlcIilcblxubGV0IGN1ckhhc2ggPSAwXG5jb25zdCBoYXNoVG8gPSB7fVxuXG5tb2R1bGUuZXhwb3J0cyA9IFdyYXBwZWREb21UcmVlID0gY2xhc3MgV3JhcHBlZERvbVRyZWUge1xuICAvLyBAcGFyYW0gZG9tIEEgRE9NIGVsZW1lbnQgb2JqZWN0XG4gIC8vICAgIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0FQSS9lbGVtZW50XG4gIC8vIEBwYXJhbSBjbG9uZSBCb29sZWFuIGZsYWcgaW5kaWNhdGluZyBpZiB0aGlzIGlzIHRoZSBET00gdHJlZSB0byBtb2RpZnlcbiAgLy8gQHBhcmFtIHJlcCBXcmFwcGVkRG9tVHJlZSBvZiBhIERPTSBlbGVtZW50IG5vZGUgaW4gZG9tXG4gIGNvbnN0cnVjdG9yKGRvbSwgY2xvbmUsIHJlcCkge1xuICAgIGlmIChjbG9uZSkge1xuICAgICAgdGhpcy5zaG93blRyZWUgPSBuZXcgV3JhcHBlZERvbVRyZWUoZG9tLCBmYWxzZSwgdGhpcylcbiAgICAgIHRoaXMuZG9tID0gZG9tLmNsb25lTm9kZSh0cnVlKVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmRvbSA9IGRvbVxuICAgICAgdGhpcy5yZXAgPSByZXBcbiAgICB9XG5cbiAgICB0aGlzLmNsb25lID0gY2xvbmVcbiAgICB0aGlzLmhhc2ggPSBjdXJIYXNoKytcbiAgICBoYXNoVG9bdGhpcy5oYXNoXSA9IHRoaXNcbiAgICB0aGlzLmlzVGV4dCA9IGRvbS5ub2RlVHlwZSA9PT0gM1xuICAgIHRoaXMudGFnTmFtZSA9IGRvbS50YWdOYW1lXG4gICAgdGhpcy5jbGFzc05hbWUgPSBkb20uY2xhc3NOYW1lXG4gICAgdGhpcy50ZXh0RGF0YSA9IGRvbS5kYXRhXG4gICAgdGhpcy5kaWZmSGFzaCA9IHt9XG5cbiAgICBpZiAodGhpcy5pc1RleHQpIHtcbiAgICAgIHRoaXMuc2l6ZSA9IDFcbiAgICB9IGVsc2Uge1xuICAgICAgOyh7IHJlcCB9ID0gdGhpcylcbiAgICAgIHRoaXMuY2hpbGRyZW4gPSBbXS5tYXAuY2FsbChcbiAgICAgICAgdGhpcy5kb20uY2hpbGROb2RlcyxcbiAgICAgICAgKGRvbSwgaW5kKSA9PlxuICAgICAgICAgIG5ldyBXcmFwcGVkRG9tVHJlZShkb20sIGZhbHNlLCByZXAgPyByZXAuY2hpbGRyZW5baW5kXSA6IG51bGwpXG4gICAgICApXG4gICAgICB0aGlzLnNpemUgPSB0aGlzLmNoaWxkcmVuLmxlbmd0aFxuICAgICAgICA/IHRoaXMuY2hpbGRyZW4ucmVkdWNlKChwcmV2LCBjdXIpID0+IHByZXYgKyBjdXIuc2l6ZSwgMClcbiAgICAgICAgOiAwXG4gICAgICBpZiAoIXRoaXMuc2l6ZSkge1xuICAgICAgICB0aGlzLnNpemUgPSAxXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLy8gQHBhcmFtIG90aGVyVHJlZSBXcmFwcGVkRG9tVHJlZSBvZiBhIERPTSBlbGVtZW50IHRvIGRpZmYgYWdhaW5zdFxuICBkaWZmVG8ob3RoZXJUcmVlKSB7XG4gICAgaWYgKHRoaXMuY2xvbmUpIHtcbiAgICAgIHJldHVybiB0aGlzLnNob3duVHJlZS5kaWZmVG8ob3RoZXJUcmVlKVxuICAgIH1cblxuICAgIGNvbnN0IGRpZmYgPSB0aGlzLnJlcC5kaWZmKG90aGVyVHJlZSlcbiAgICBjb25zdCB7IHNjb3JlIH0gPSBkaWZmXG4gICAgY29uc3QgeyBvcGVyYXRpb25zIH0gPSBkaWZmXG4gICAgbGV0IGluZGV4U2hpZnQgPSAwXG4gICAgbGV0IGluc2VydGVkID0gW11cblxuICAgIC8vIEZvcmNlIHZhcmlhYmxlcyB0byBsZWFrIHRvIGRpZmZUbyBzY29wZVxuICAgIGxldCBbXG4gICAgICBsYXN0LFxuICAgICAgcG9zc2libGVSZXBsYWNlLFxuICAgICAgcixcbiAgICAgIGxhc3RPcCxcbiAgICAgIGxhc3RFbG1EZWxldGVkLFxuICAgICAgbGFzdEVsbUluc2VydGVkXG4gICAgXSA9IEFycmF5LmZyb20oW10pXG5cbiAgICBpZiAob3BlcmF0aW9ucykge1xuICAgICAgaWYgKG9wZXJhdGlvbnMgaW5zdGFuY2VvZiBBcnJheSkge1xuICAgICAgICBmb3IgKGxldCBvcCBvZiBBcnJheS5mcm9tKG9wZXJhdGlvbnMpKSB7XG4gICAgICAgICAgOyhvcCA9PiB7XG4gICAgICAgICAgICBpZiAob3AudHlwZSA9PT0gXCJkXCIpIHtcbiAgICAgICAgICAgICAgY29uc3QgcG9zc2libGVMYXN0RGVsZXRlZCA9IHRoaXMuY2hpbGRyZW5bb3AudHJlZSArIGluZGV4U2hpZnRdXG4gICAgICAgICAgICAgICAgLmRvbVxuICAgICAgICAgICAgICByID0gdGhpcy5yZW1vdmUob3AudHJlZSArIGluZGV4U2hpZnQpXG4gICAgICAgICAgICAgIHRoaXMucmVwLnJlbW92ZShvcC50cmVlICsgaW5kZXhTaGlmdClcbiAgICAgICAgICAgICAgaWYgKCFsYXN0IHx8IGxhc3QubmV4dFNpYmxpbmcgPT09IHIgfHwgbGFzdCA9PT0gcikge1xuICAgICAgICAgICAgICAgIGxhc3QgPSByXG4gICAgICAgICAgICAgICAgLy8gVW5kZWZpbmVkIGVycm9ycyBjYW4gYmUgdGhyb3cgc28gd2UgYWRkIGEgY29uZGl0aW9uIG9uIGxhc3RPcFxuICAgICAgICAgICAgICAgIC8vIGJlaW5nIGRlZmluZWRcbiAgICAgICAgICAgICAgICBpZiAobGFzdCAmJiBsYXN0T3AgJiYgb3AudHJlZSA9PT0gbGFzdE9wLnBvcykge1xuICAgICAgICAgICAgICAgICAgbGFzdEVsbURlbGV0ZWQgPSBwb3NzaWJsZUxhc3REZWxldGVkXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgIGxhc3RFbG1EZWxldGVkID0gbnVsbFxuICAgICAgICAgICAgICAgICAgbGFzdEVsbUluc2VydGVkID0gbnVsbFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBsYXN0T3AgPSBvcFxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGluZGV4U2hpZnQtLVxuICAgICAgICAgICAgICByZXR1cm5cbiAgICAgICAgICAgIH0gZWxzZSBpZiAob3AudHlwZSA9PT0gXCJpXCIpIHtcbiAgICAgICAgICAgICAgdGhpcy5yZXAuaW5zZXJ0KFxuICAgICAgICAgICAgICAgIG9wLnBvcyArIGluZGV4U2hpZnQsXG4gICAgICAgICAgICAgICAgb3RoZXJUcmVlLmNoaWxkcmVuW29wLm90aGVyVHJlZV1cbiAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICByID0gdGhpcy5pbnNlcnQoXG4gICAgICAgICAgICAgICAgb3AucG9zICsgaW5kZXhTaGlmdCxcbiAgICAgICAgICAgICAgICBvdGhlclRyZWUuY2hpbGRyZW5bb3Aub3RoZXJUcmVlXSxcbiAgICAgICAgICAgICAgICB0aGlzLnJlcC5jaGlsZHJlbltvcC5wb3MgKyBpbmRleFNoaWZ0XVxuICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgIGluc2VydGVkLnB1c2gocilcbiAgICAgICAgICAgICAgaWYgKCFsYXN0IHx8IGxhc3QubmV4dFNpYmxpbmcgPT09IHIpIHtcbiAgICAgICAgICAgICAgICBsYXN0ID0gclxuICAgICAgICAgICAgICAgIGxhc3RPcCA9IG9wXG4gICAgICAgICAgICAgICAgbGFzdEVsbUluc2VydGVkID0gclxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGluZGV4U2hpZnQrK1xuICAgICAgICAgICAgICByZXR1cm5cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGNvbnN0IHJlID0gdGhpcy5jaGlsZHJlbltvcC50cmVlICsgaW5kZXhTaGlmdF0uZGlmZlRvKFxuICAgICAgICAgICAgICAgIG90aGVyVHJlZS5jaGlsZHJlbltvcC5vdGhlclRyZWVdXG4gICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgICFsYXN0IHx8XG4gICAgICAgICAgICAgICAgKGxhc3QubmV4dFNpYmxpbmcgPT09IHRoaXMuY2hpbGRyZW5bb3AudHJlZSArIGluZGV4U2hpZnRdLmRvbSAmJlxuICAgICAgICAgICAgICAgICAgcmUubGFzdClcbiAgICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgOyh7IGxhc3QgfSA9IHJlKVxuICAgICAgICAgICAgICAgIGlmIChyZS5wb3NzaWJsZVJlcGxhY2UpIHtcbiAgICAgICAgICAgICAgICAgIGxhc3RFbG1JbnNlcnRlZCA9IHJlLnBvc3NpYmxlUmVwbGFjZS5jdXJcbiAgICAgICAgICAgICAgICAgIGxhc3RFbG1EZWxldGVkID0gcmUucG9zc2libGVSZXBsYWNlLnByZXZcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbGFzdE9wID0gb3BcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBpbnNlcnRlZCA9IGluc2VydGVkLmNvbmNhdChyZS5pbnNlcnRlZClcbiAgICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSkob3ApXG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnNvbGUubG9nKG9wZXJhdGlvbnMpXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcImludmFsaWQgb3BlcmF0aW9uc1wiKVxuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChsYXN0T3AgJiYgbGFzdE9wLnR5cGUgIT09IFwiaVwiICYmIGxhc3RFbG1JbnNlcnRlZCAmJiBsYXN0RWxtRGVsZXRlZCkge1xuICAgICAgcG9zc2libGVSZXBsYWNlID0ge1xuICAgICAgICBjdXI6IGxhc3RFbG1JbnNlcnRlZCxcbiAgICAgICAgcHJldjogbGFzdEVsbURlbGV0ZWRcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgbGFzdCxcbiAgICAgIGluc2VydGVkLFxuICAgICAgcG9zc2libGVSZXBsYWNlXG4gICAgfVxuICB9XG5cbiAgaW5zZXJ0KGksIHRyZWUsIHJlcCkge1xuICAgIGNvbnN0IGRvbSA9IHRyZWUuZG9tLmNsb25lTm9kZSh0cnVlKVxuICAgIGlmIChpID09PSB0aGlzLmRvbS5jaGlsZE5vZGVzLmxlbmd0aCkge1xuICAgICAgdGhpcy5kb20uYXBwZW5kQ2hpbGQoZG9tKVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmRvbS5pbnNlcnRCZWZvcmUoZG9tLCB0aGlzLmRvbS5jaGlsZE5vZGVzW2ldKVxuICAgIH1cblxuICAgIGNvbnN0IGN0cmVlID0gbmV3IFdyYXBwZWREb21UcmVlKGRvbSwgZmFsc2UsIHJlcClcbiAgICB0aGlzLmNoaWxkcmVuLnNwbGljZShpLCAwLCBjdHJlZSlcbiAgICByZXR1cm4gdGhpcy5kb20uY2hpbGROb2Rlc1tpXVxuICB9XG5cbiAgcmVtb3ZlKGkpIHtcbiAgICB0aGlzLmRvbS5yZW1vdmVDaGlsZCh0aGlzLmRvbS5jaGlsZE5vZGVzW2ldKVxuICAgIHRoaXMuY2hpbGRyZW5baV0ucmVtb3ZlU2VsZigpXG4gICAgdGhpcy5jaGlsZHJlbi5zcGxpY2UoaSwgMSlcbiAgICByZXR1cm4gdGhpcy5kb20uY2hpbGROb2Rlc1tpIC0gMV1cbiAgfVxuXG4gIGRpZmYob3RoZXJUcmVlLCB0bWF4KSB7XG4gICAgbGV0IGlcbiAgICBpZiAodGhpcy5lcXVhbFRvKG90aGVyVHJlZSkpIHtcbiAgICAgIHJldHVybiB7IHNjb3JlOiAwLCBvcGVyYXRpb25zOiBudWxsIH1cbiAgICB9XG5cbiAgICBpZiAodGhpcy5jYW5ub3RSZXBsYWNlV2l0aChvdGhlclRyZWUpKSB7XG4gICAgICByZXR1cm4geyBzY29yZTogMSAvIDAsIG9wZXJhdGlvbnM6IG51bGwgfVxuICAgIH1cblxuICAgIGNvbnN0IGtleSA9IG90aGVyVHJlZS5oYXNoXG4gICAgaWYgKEFycmF5LmZyb20odGhpcy5kaWZmSGFzaCkuaW5jbHVkZXMoa2V5KSkge1xuICAgICAgcmV0dXJuIHRoaXMuZGlmZkhhc2hba2V5XVxuICAgIH1cblxuICAgIGlmICh0bWF4ID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHRtYXggPSAxMDAwMDBcbiAgICB9XG4gICAgaWYgKHRtYXggPD0gMCkge1xuICAgICAgcmV0dXJuIDBcbiAgICB9XG5cbiAgICBsZXQgb2Zmc2V0ID0gMFxuICAgIGNvbnN0IGZvcndhcmRTZWFyY2ggPSBvZmZzZXQgPT4ge1xuICAgICAgcmV0dXJuIChcbiAgICAgICAgb2Zmc2V0IDwgdGhpcy5jaGlsZHJlbi5sZW5ndGggJiZcbiAgICAgICAgb2Zmc2V0IDwgb3RoZXJUcmVlLmNoaWxkcmVuLmxlbmd0aCAmJlxuICAgICAgICB0aGlzLmNoaWxkcmVuW29mZnNldF0uZXF1YWxUbyhvdGhlclRyZWUuY2hpbGRyZW5bb2Zmc2V0XSlcbiAgICAgIClcbiAgICB9XG4gICAgd2hpbGUgKGZvcndhcmRTZWFyY2gob2Zmc2V0KSkge1xuICAgICAgb2Zmc2V0KytcbiAgICB9XG5cbiAgICBjb25zdCBkcCA9IG5ldyBUd29EaW1BcnJheShcbiAgICAgIHRoaXMuY2hpbGRyZW4ubGVuZ3RoICsgMSAtIG9mZnNldCxcbiAgICAgIG90aGVyVHJlZS5jaGlsZHJlbi5sZW5ndGggKyAxIC0gb2Zmc2V0XG4gICAgKVxuICAgIGNvbnN0IHAgPSBuZXcgVHdvRGltQXJyYXkoXG4gICAgICB0aGlzLmNoaWxkcmVuLmxlbmd0aCArIDEgLSBvZmZzZXQsXG4gICAgICBvdGhlclRyZWUuY2hpbGRyZW4ubGVuZ3RoICsgMSAtIG9mZnNldFxuICAgIClcbiAgICBkcC5zZXQoMCwgMCwgMClcblxuICAgIGxldCBzdW0gPSAwXG4gICAgLy8gQmVjYXVzZSBjb2ZmZXNjcmlwdHMgYWxsb3dzIGJpZGVyY3Rpb25hbCBsb29wcyB3ZSBuZWVkIHRoaXMgY29uZGl0aW9uXG4gICAgLy8gZ2F1cmQgdG8gcHJldmVudCBhIGRlY3JlYXNpbmcgYXJyYXkgbGlzdFxuICAgIGlmIChvdGhlclRyZWUuY2hpbGRyZW4ubGVuZ3RoIC0gb2Zmc2V0ID4gMSkge1xuICAgICAgbGV0IGFzYywgZW5kXG4gICAgICBmb3IgKFxuICAgICAgICBpID0gMSwgZW5kID0gb3RoZXJUcmVlLmNoaWxkcmVuLmxlbmd0aCAtIG9mZnNldCAtIDEsIGFzYyA9IDEgPD0gZW5kO1xuICAgICAgICBhc2MgPyBpIDw9IGVuZCA6IGkgPj0gZW5kO1xuICAgICAgICBhc2MgPyBpKysgOiBpLS1cbiAgICAgICkge1xuICAgICAgICBkcC5zZXQoMCwgaSwgc3VtKVxuICAgICAgICBwLnNldCgwLCBpLCBpIC0gMSlcbiAgICAgICAgc3VtICs9IG90aGVyVHJlZS5jaGlsZHJlbltpICsgb2Zmc2V0XS5zaXplXG4gICAgICB9XG4gICAgfVxuICAgIGlmIChvdGhlclRyZWUuY2hpbGRyZW4ubGVuZ3RoIC0gb2Zmc2V0ID4gMCkge1xuICAgICAgZHAuc2V0KDAsIG90aGVyVHJlZS5jaGlsZHJlbi5sZW5ndGggLSBvZmZzZXQsIHN1bSlcbiAgICAgIHAuc2V0KFxuICAgICAgICAwLFxuICAgICAgICBvdGhlclRyZWUuY2hpbGRyZW4ubGVuZ3RoIC0gb2Zmc2V0LFxuICAgICAgICBvdGhlclRyZWUuY2hpbGRyZW4ubGVuZ3RoIC0gMSAtIG9mZnNldFxuICAgICAgKVxuICAgIH1cblxuICAgIHN1bSA9IDBcbiAgICAvLyBCZWNhdXNlIGNvZmZlc2NyaXB0cyBhbGxvd3MgYmlkZXJjdGlvbmFsIGxvb3BzIHdlIG5lZWQgdGhpcyBjb25kaXRpb25cbiAgICAvLyBnYXVyZCB0byBwcmV2ZW50IGEgZGVjcmVhc2luZyBhcnJheSBsaXN0XG4gICAgaWYgKHRoaXMuY2hpbGRyZW4ubGVuZ3RoIC0gb2Zmc2V0ID4gMSkge1xuICAgICAgbGV0IGFzYzEsIGVuZDFcbiAgICAgIGZvciAoXG4gICAgICAgIGkgPSAxLCBlbmQxID0gdGhpcy5jaGlsZHJlbi5sZW5ndGggLSBvZmZzZXQgLSAxLCBhc2MxID0gMSA8PSBlbmQxO1xuICAgICAgICBhc2MxID8gaSA8PSBlbmQxIDogaSA+PSBlbmQxO1xuICAgICAgICBhc2MxID8gaSsrIDogaS0tXG4gICAgICApIHtcbiAgICAgICAgZHAuc2V0KGksIDAsIHN1bSlcbiAgICAgICAgcC5zZXQoaSwgMCwgKGkgLSAxKSAqIHAuY29sKVxuICAgICAgICBzdW0gKz0gdGhpcy5jaGlsZHJlbltpICsgb2Zmc2V0XS5zaXplXG4gICAgICB9XG4gICAgfVxuICAgIGlmICh0aGlzLmNoaWxkcmVuLmxlbmd0aCAtIG9mZnNldCkge1xuICAgICAgZHAuc2V0KHRoaXMuY2hpbGRyZW4ubGVuZ3RoIC0gb2Zmc2V0LCAwLCBzdW0pXG4gICAgICBwLnNldChcbiAgICAgICAgdGhpcy5jaGlsZHJlbi5sZW5ndGggLSBvZmZzZXQsXG4gICAgICAgIDAsXG4gICAgICAgICh0aGlzLmNoaWxkcmVuLmxlbmd0aCAtIDEgLSBvZmZzZXQpICogcC5jb2xcbiAgICAgIClcbiAgICB9XG5cbiAgICB2YXIgZ2V0U2NvcmUgPSAoaSwgaiwgbWF4KSA9PiB7XG4gICAgICBpZiAoZHAuZ2V0KGksIGopICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgcmV0dXJuIGRwLmdldChpLCBqKVxuICAgICAgfVxuICAgICAgaWYgKG1heCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIG1heCA9IDEgLyAwXG4gICAgICB9XG4gICAgICBpZiAobWF4IDw9IDApIHtcbiAgICAgICAgcmV0dXJuIDEgLyAwXG4gICAgICB9XG5cbiAgICAgIGxldCB2YWwgPSBtYXhcbiAgICAgIGNvbnN0IGJvdW5kID0gbWF4XG4gICAgICBjb25zdCBzdWJkaWZmID0gdGhpcy5jaGlsZHJlbltpIC0gMSArIG9mZnNldF0uZGlmZihcbiAgICAgICAgb3RoZXJUcmVlLmNoaWxkcmVuW2ogLSAxICsgb2Zmc2V0XSxcbiAgICAgICAgYm91bmRcbiAgICAgICkuc2NvcmVcbiAgICAgIGxldCBmb3JjZSA9IGZhbHNlXG4gICAgICBpZiAoXG4gICAgICAgIHN1YmRpZmYgPCBib3VuZCAmJlxuICAgICAgICBzdWJkaWZmICsgMSA8XG4gICAgICAgICAgdGhpcy5jaGlsZHJlbltpIC0gMSArIG9mZnNldF0uc2l6ZSArXG4gICAgICAgICAgICBvdGhlclRyZWUuY2hpbGRyZW5baiAtIDEgKyBvZmZzZXRdLnNpemVcbiAgICAgICkge1xuICAgICAgICBmb3JjZSA9IHRydWVcbiAgICAgIH1cbiAgICAgIHZhbCA9IGdldFNjb3JlKGkgLSAxLCBqIC0gMSwgYm91bmQgLSBzdWJkaWZmKSArIHN1YmRpZmZcbiAgICAgIGxldCBwcmV2ID0gcC5nZXRJbmQoaSAtIDEsIGogLSAxKVxuXG4gICAgICBpZiAoIWZvcmNlKSB7XG4gICAgICAgIGxldCBvdGhlciA9XG4gICAgICAgICAgZ2V0U2NvcmUoXG4gICAgICAgICAgICBpIC0gMSxcbiAgICAgICAgICAgIGosXG4gICAgICAgICAgICBNYXRoLm1pbih2YWwsIG1heCkgLSB0aGlzLmNoaWxkcmVuW2kgLSAxICsgb2Zmc2V0XS5zaXplXG4gICAgICAgICAgKSArIHRoaXMuY2hpbGRyZW5baSAtIDEgKyBvZmZzZXRdLnNpemVcbiAgICAgICAgaWYgKG90aGVyIDwgdmFsKSB7XG4gICAgICAgICAgcHJldiA9IHAuZ2V0SW5kKGkgLSAxLCBqKVxuICAgICAgICAgIHZhbCA9IG90aGVyXG4gICAgICAgIH1cblxuICAgICAgICBvdGhlciA9XG4gICAgICAgICAgZ2V0U2NvcmUoXG4gICAgICAgICAgICBpLFxuICAgICAgICAgICAgaiAtIDEsXG4gICAgICAgICAgICBNYXRoLm1pbih2YWwsIG1heCkgLSBvdGhlclRyZWUuY2hpbGRyZW5baiAtIDEgKyBvZmZzZXRdLnNpemVcbiAgICAgICAgICApICsgb3RoZXJUcmVlLmNoaWxkcmVuW2ogLSAxICsgb2Zmc2V0XS5zaXplXG4gICAgICAgIGlmIChvdGhlciA8IHZhbCkge1xuICAgICAgICAgIHByZXYgPSBwLmdldEluZChpLCBqIC0gMSlcbiAgICAgICAgICB2YWwgPSBvdGhlclxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGlmICh2YWwgPj0gbWF4KSB7XG4gICAgICAgIHZhbCA9IDEgLyAwXG4gICAgICB9XG5cbiAgICAgIGRwLnNldChpLCBqLCB2YWwpXG4gICAgICBwLnNldChpLCBqLCBwcmV2KVxuICAgICAgcmV0dXJuIHZhbFxuICAgIH1cblxuICAgIGNvbnN0IHNjb3JlID0gZ2V0U2NvcmUoXG4gICAgICB0aGlzLmNoaWxkcmVuLmxlbmd0aCAtIG9mZnNldCxcbiAgICAgIG90aGVyVHJlZS5jaGlsZHJlbi5sZW5ndGggLSBvZmZzZXQsXG4gICAgICB0bWF4XG4gICAgKVxuICAgIGNvbnN0IG9wZXJhdGlvbnMgPSBbXVxuXG4gICAgbGV0IGN1ciA9IHAuZ2V0SW5kKFxuICAgICAgdGhpcy5jaGlsZHJlbi5sZW5ndGggLSBvZmZzZXQsXG4gICAgICBvdGhlclRyZWUuY2hpbGRyZW4ubGVuZ3RoIC0gb2Zmc2V0XG4gICAgKVxuICAgIGxldCBjciA9IHRoaXMuY2hpbGRyZW4ubGVuZ3RoIC0gMSAtIG9mZnNldFxuICAgIGxldCBjYyA9IG90aGVyVHJlZS5jaGlsZHJlbi5sZW5ndGggLSAxIC0gb2Zmc2V0XG5cbiAgICB3aGlsZSAocC5yYXdHZXQoY3VyKSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBjb25zdCBwcmV2ID0gcC5yYXdHZXQoY3VyKVxuICAgICAgY29uc3QgcmMgPSBwLmdldDJESW5kKHByZXYpXG4gICAgICBjb25zdCBwciA9IHJjLnIgLSAxXG4gICAgICBjb25zdCBwYyA9IHJjLmMgLSAxXG5cbiAgICAgIGlmIChwciA9PT0gY3IpIHtcbiAgICAgICAgb3BlcmF0aW9ucy51bnNoaWZ0KHtcbiAgICAgICAgICB0eXBlOiBcImlcIixcbiAgICAgICAgICBvdGhlclRyZWU6IGNjICsgb2Zmc2V0LFxuICAgICAgICAgIHBvczogY3IgKyAxICsgb2Zmc2V0XG4gICAgICAgIH0pXG4gICAgICB9IGVsc2UgaWYgKHBjID09PSBjYykge1xuICAgICAgICBvcGVyYXRpb25zLnVuc2hpZnQoe1xuICAgICAgICAgIHR5cGU6IFwiZFwiLFxuICAgICAgICAgIHRyZWU6IGNyICsgb2Zmc2V0XG4gICAgICAgIH0pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCBvcCA9IHRoaXMuY2hpbGRyZW5bY3IgKyBvZmZzZXRdLmRpZmYoXG4gICAgICAgICAgb3RoZXJUcmVlLmNoaWxkcmVuW2NjICsgb2Zmc2V0XVxuICAgICAgICApLm9wZXJhdGlvbnNcbiAgICAgICAgaWYgKG9wICYmIG9wLmxlbmd0aCkge1xuICAgICAgICAgIG9wZXJhdGlvbnMudW5zaGlmdCh7XG4gICAgICAgICAgICB0eXBlOiBcInJcIixcbiAgICAgICAgICAgIHRyZWU6IGNyICsgb2Zmc2V0LFxuICAgICAgICAgICAgb3RoZXJUcmVlOiBjYyArIG9mZnNldFxuICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGN1ciA9IHByZXZcbiAgICAgIGNyID0gcHJcbiAgICAgIGNjID0gcGNcbiAgICB9XG5cbiAgICB0aGlzLmRpZmZIYXNoW2tleV0gPSB7XG4gICAgICBzY29yZSxcbiAgICAgIG9wZXJhdGlvbnNcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5kaWZmSGFzaFtrZXldXG4gIH1cblxuICBlcXVhbFRvKG90aGVyVHJlZSkge1xuICAgIHJldHVybiB0aGlzLmRvbS5pc0VxdWFsTm9kZShvdGhlclRyZWUuZG9tKVxuICB9XG5cbiAgY2Fubm90UmVwbGFjZVdpdGgob3RoZXJUcmVlKSB7XG4gICAgcmV0dXJuIChcbiAgICAgIHRoaXMuaXNUZXh0IHx8XG4gICAgICBvdGhlclRyZWUuaXNUZXh0IHx8XG4gICAgICB0aGlzLnRhZ05hbWUgIT09IG90aGVyVHJlZS50YWdOYW1lIHx8XG4gICAgICB0aGlzLmNsYXNzTmFtZSAhPT0gb3RoZXJUcmVlLmNsYXNzTmFtZSB8fFxuICAgICAgdGhpcy5jbGFzc05hbWUgPT09IFwibWF0aFwiIHx8XG4gICAgICB0aGlzLmNsYXNzTmFtZSA9PT0gXCJhdG9tLXRleHQtZWRpdG9yXCIgfHxcbiAgICAgIHRoaXMudGFnTmFtZSA9PT0gXCJBXCIgfHxcbiAgICAgICh0aGlzLnRhZ05hbWUgPT09IFwiSU1HXCIgJiYgIXRoaXMuZG9tLmlzRXF1YWxOb2RlKG90aGVyVHJlZS5kb20pKVxuICAgIClcbiAgfVxuXG4gIGdldENvbnRlbnQoKSB7XG4gICAgaWYgKHRoaXMuZG9tLm91dGVySFRNTCkge1xuICAgICAgcmV0dXJuIHRoaXMuZG9tLm91dGVySFRNTFxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy50ZXh0RGF0YVxuICAgIH1cbiAgfVxuXG4gIHJlbW92ZVNlbGYoKSB7XG4gICAgaGFzaFRvW3RoaXMuaGFzaF0gPSBudWxsXG4gICAgdGhpcy5jaGlsZHJlbiAmJiB0aGlzLmNoaWxkcmVuLmZvckVhY2goYyA9PiBjLnJlbW92ZVNlbGYoKSlcbiAgfVxufVxuIl19