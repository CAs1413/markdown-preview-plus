"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const two_dim_array_1 = require("./two-dim-array");
let curHash = 0;
const hashTo = {};
class WrappedDomTree {
    constructor(dom, clone, rep) {
        this.children = [];
        this.size = 0;
        if (clone) {
            this.shownTree = new WrappedDomTree(dom, false, this);
            this.dom = dom.cloneNode(true);
        }
        else {
            this.dom = dom;
            this.rep = rep;
        }
        this.clone = clone;
        this.hash = curHash++;
        hashTo[this.hash] = this;
        this.isText = dom.nodeType === 3;
        this.tagName = dom.tagName;
        this.className = dom.className;
        this.textData = dom.data;
        this.diffHash = {};
        if (this.isText) {
            this.size = 1;
        }
        else {
            this.children = Array.from(this.dom.childNodes).map((dom, ind) => new WrappedDomTree(dom, false, rep ? rep.children[ind] : undefined));
            this.size = this.children.length
                ? this.children.reduce((prev, cur) => prev + cur.size, 0)
                : 0;
            if (!this.size) {
                this.size = 1;
            }
        }
    }
    diffTo(otherTree) {
        if (this.clone && this.shownTree) {
            return this.shownTree.diffTo(otherTree);
        }
        const diff = this.rep && this.rep.diff(otherTree);
        const operations = diff && diff.operations;
        let indexShift = 0;
        let inserted = [];
        let last;
        let possibleReplace;
        let r;
        let lastOp;
        let lastElmDeleted;
        let lastElmInserted;
        if (operations) {
            if (Array.isArray(operations)) {
                for (const op of operations) {
                    if (op.type === 'd') {
                        const possibleLastDeleted = this.children[op.tree + indexShift].dom;
                        r = this.remove(op.tree + indexShift);
                        this.rep && this.rep.remove(op.tree + indexShift);
                        if (!last || last.nextSibling === r || last === r) {
                            last = r;
                            if (last &&
                                lastOp &&
                                lastOp.type === 'i' &&
                                op.tree === lastOp.pos) {
                                lastElmDeleted = possibleLastDeleted;
                            }
                            else {
                                lastElmDeleted = undefined;
                                lastElmInserted = undefined;
                            }
                            lastOp = op;
                        }
                        indexShift--;
                    }
                    else if (op.type === 'i') {
                        this.rep &&
                            this.rep.insert(op.pos + indexShift, otherTree.children[op.otherTree]);
                        r = this.insert(op.pos + indexShift, otherTree.children[op.otherTree], this.rep && this.rep.children[op.pos + indexShift]);
                        inserted.push(r);
                        if (!last || last.nextSibling === r) {
                            last = r;
                            lastOp = op;
                            lastElmInserted = r;
                        }
                        indexShift++;
                    }
                    else {
                        const re = this.children[op.tree + indexShift].diffTo(otherTree.children[op.otherTree]);
                        if (!last ||
                            (last.nextSibling === this.children[op.tree + indexShift].dom &&
                                re.last)) {
                            ;
                            ({ last } = re);
                            if (re.possibleReplace) {
                                lastElmInserted = re.possibleReplace.cur;
                                lastElmDeleted = re.possibleReplace.prev;
                            }
                            lastOp = op;
                        }
                        inserted = inserted.concat(re.inserted);
                    }
                }
            }
            else {
                console.log(operations);
                throw new Error('invalid operations');
            }
        }
        if (lastOp && lastOp.type !== 'i' && lastElmInserted && lastElmDeleted) {
            possibleReplace = {
                cur: lastElmInserted,
                prev: lastElmDeleted,
            };
        }
        return {
            last,
            inserted,
            possibleReplace,
        };
    }
    insert(i, tree, rep) {
        const dom = tree.dom.cloneNode(true);
        if (i === this.dom.childNodes.length) {
            this.dom.appendChild(dom);
        }
        else {
            this.dom.insertBefore(dom, this.dom.childNodes[i]);
        }
        const ctree = new WrappedDomTree(dom, false, rep);
        this.children.splice(i, 0, ctree);
        return this.dom.childNodes[i];
    }
    remove(i) {
        this.dom.removeChild(this.dom.childNodes[i]);
        this.children[i].removeSelf();
        this.children.splice(i, 1);
        return this.dom.childNodes[i - 1];
    }
    diff(otherTree, tmax) {
        let i;
        if (this.equalTo(otherTree)) {
            return { score: 0, operations: undefined };
        }
        if (this.cannotReplaceWith(otherTree)) {
            return { score: 1 / 0, operations: undefined };
        }
        const key = otherTree.hash;
        if (Object.keys(this.diffHash).includes(key.toString())) {
            return this.diffHash[key];
        }
        if (tmax === undefined) {
            tmax = 100000;
        }
        if (tmax <= 0) {
            return { score: 0 };
        }
        let offset = 0;
        const forwardSearch = (offset) => offset < this.children.length &&
            offset < otherTree.children.length &&
            this.children[offset].equalTo(otherTree.children[offset]);
        while (forwardSearch(offset)) {
            offset++;
        }
        const dp = new two_dim_array_1.TwoDimArray(this.children.length + 1 - offset, otherTree.children.length + 1 - offset);
        const p = new two_dim_array_1.TwoDimArray(this.children.length + 1 - offset, otherTree.children.length + 1 - offset);
        dp.set(0, 0, 0);
        let sum = 0;
        if (otherTree.children.length - offset > 1) {
            let asc;
            let end;
            for (i = 1, end = otherTree.children.length - offset - 1, asc = 1 <= end; asc ? i <= end : i >= end; asc ? i++ : i--) {
                dp.set(0, i, sum);
                p.set(0, i, i - 1);
                sum += otherTree.children[i + offset].size;
            }
        }
        if (otherTree.children.length - offset > 0) {
            dp.set(0, otherTree.children.length - offset, sum);
            p.set(0, otherTree.children.length - offset, otherTree.children.length - 1 - offset);
        }
        sum = 0;
        if (this.children.length - offset > 1) {
            let asc1;
            let end1;
            for (i = 1, end1 = this.children.length - offset - 1, asc1 = 1 <= end1; asc1 ? i <= end1 : i >= end1; asc1 ? i++ : i--) {
                dp.set(i, 0, sum);
                p.set(i, 0, (i - 1) * p.col);
                sum += this.children[i + offset].size;
            }
        }
        if (this.children.length - offset) {
            dp.set(this.children.length - offset, 0, sum);
            p.set(this.children.length - offset, 0, (this.children.length - 1 - offset) * p.col);
        }
        const getScore = (i, j, max) => {
            const res = dp.get(i, j);
            if (res !== undefined) {
                return res;
            }
            if (max === undefined) {
                max = 1 / 0;
            }
            if (max <= 0) {
                return 1 / 0;
            }
            let val = max;
            const bound = max;
            const subdiff = this.children[i - 1 + offset].diff(otherTree.children[j - 1 + offset], bound).score;
            let force = false;
            if (subdiff < bound &&
                subdiff + 1 <
                    this.children[i - 1 + offset].size +
                        otherTree.children[j - 1 + offset].size) {
                force = true;
            }
            val = getScore(i - 1, j - 1, bound - subdiff) + subdiff;
            let prev = p.getInd(i - 1, j - 1);
            if (!force) {
                let other = getScore(i - 1, j, Math.min(val, max) - this.children[i - 1 + offset].size) + this.children[i - 1 + offset].size;
                if (other < val) {
                    prev = p.getInd(i - 1, j);
                    val = other;
                }
                other =
                    getScore(i, j - 1, Math.min(val, max) - otherTree.children[j - 1 + offset].size) + otherTree.children[j - 1 + offset].size;
                if (other < val) {
                    prev = p.getInd(i, j - 1);
                    val = other;
                }
            }
            if (val >= max) {
                val = 1 / 0;
            }
            dp.set(i, j, val);
            p.set(i, j, prev);
            return val;
        };
        const score = getScore(this.children.length - offset, otherTree.children.length - offset, tmax);
        const operations = [];
        let cur = p.getInd(this.children.length - offset, otherTree.children.length - offset);
        let cr = this.children.length - 1 - offset;
        let cc = otherTree.children.length - 1 - offset;
        while (p.rawGet(cur) !== undefined) {
            const prev = p.rawGet(cur);
            const rc = p.get2DInd(prev);
            const pr = rc.r - 1;
            const pc = rc.c - 1;
            if (pr === cr) {
                operations.unshift({
                    type: 'i',
                    otherTree: cc + offset,
                    pos: cr + 1 + offset,
                });
            }
            else if (pc === cc) {
                operations.unshift({
                    type: 'd',
                    tree: cr + offset,
                });
            }
            else {
                const op = this.children[cr + offset].diff(otherTree.children[cc + offset]).operations;
                if (op && op.length) {
                    operations.unshift({
                        type: 'r',
                        tree: cr + offset,
                        otherTree: cc + offset,
                    });
                }
            }
            cur = prev;
            cr = pr;
            cc = pc;
        }
        this.diffHash[key] = {
            score,
            operations,
        };
        return this.diffHash[key];
    }
    equalTo(otherTree) {
        return this.dom.isEqualNode(otherTree.dom);
    }
    cannotReplaceWith(otherTree) {
        return (this.isText ||
            otherTree.isText ||
            this.tagName !== otherTree.tagName ||
            this.className !== otherTree.className ||
            this.className === 'math' ||
            this.className === 'atom-text-editor' ||
            this.tagName === 'A' ||
            (this.tagName === 'IMG' && !this.dom.isEqualNode(otherTree.dom)));
    }
    getContent() {
        if (this.dom.outerHTML) {
            return this.dom.outerHTML;
        }
        else {
            return this.textData;
        }
    }
    removeSelf() {
        hashTo[this.hash] = undefined;
        this.children && this.children.forEach((c) => c.removeSelf());
    }
}
exports.WrappedDomTree = WrappedDomTree;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid3JhcHBlZC1kb20tdHJlZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy93cmFwcGVkLWRvbS10cmVlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBNkJBLG1EQUE2QztBQUU3QyxJQUFJLE9BQU8sR0FBRyxDQUFDLENBQUE7QUFDZixNQUFNLE1BQU0sR0FBa0QsRUFBRSxDQUFBO0FBT2hFO0lBb0JFLFlBQVksR0FBWSxFQUFFLEtBQWMsRUFBRSxHQUFvQjtRQWhCdEQsYUFBUSxHQUFxQixFQUFFLENBQUE7UUFDL0IsU0FBSSxHQUFXLENBQUMsQ0FBQTtRQWdCdEIsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUNWLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxjQUFjLENBQUMsR0FBRyxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQTtZQUNyRCxJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFZLENBQUE7UUFDM0MsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ04sSUFBSSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUE7WUFDZCxJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQTtRQUNoQixDQUFDO1FBRUQsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUE7UUFDbEIsSUFBSSxDQUFDLElBQUksR0FBRyxPQUFPLEVBQUUsQ0FBQTtRQUNyQixNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQTtRQUN4QixJQUFJLENBQUMsTUFBTSxHQUFHLEdBQUcsQ0FBQyxRQUFRLEtBQUssQ0FBQyxDQUFBO1FBQ2hDLElBQUksQ0FBQyxPQUFPLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQTtRQUMxQixJQUFJLENBQUMsU0FBUyxHQUFHLEdBQUcsQ0FBQyxTQUFTLENBQUE7UUFDOUIsSUFBSSxDQUFDLFFBQVEsR0FBSSxHQUFXLENBQUMsSUFB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LENBQUM7WUFDTixNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQTtRQUN0QixDQUFDO0lBQ0gsQ0FBQztJQUVELFVBQVU7UUFDUixNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLFNBQVMsQ0FBQTtRQUM3QixJQUFJLENBQUMsUUFBUSxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQTtJQUMvRCxDQUFDO0NBQ0Y7QUFqYkQsd0NBaWJDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIGRlY2FmZmVpbmF0ZSBzdWdnZXN0aW9uczpcbiAqIERTMTAxOiBSZW1vdmUgdW5uZWNlc3NhcnkgdXNlIG9mIEFycmF5LmZyb21cbiAqIERTMTAyOiBSZW1vdmUgdW5uZWNlc3NhcnkgY29kZSBjcmVhdGVkIGJlY2F1c2Ugb2YgaW1wbGljaXQgcmV0dXJuc1xuICogRFMyMDI6IFNpbXBsaWZ5IGR5bmFtaWMgcmFuZ2UgbG9vcHNcbiAqIEZ1bGwgZG9jczogaHR0cHM6Ly9naXRodWIuY29tL2RlY2FmZmVpbmF0ZS9kZWNhZmZlaW5hdGUvYmxvYi9tYXN0ZXIvZG9jcy9zdWdnZXN0aW9ucy5tZFxuICovXG4vLyBUaGlzIGZpbGUgaW5jb3Jwb3JhdGVzIGNvZGUgZnJvbSBbbWFya21vbl0oaHR0cHM6Ly9naXRodWIuY29tL3l5amhhby9tYXJrbW9uKVxuLy8gY292ZXJlZCBieSB0aGUgZm9sbG93aW5nIHRlcm1zOlxuLy9cbi8vIENvcHlyaWdodCAoYykgMjAxNCwgWWFvIFl1amlhbiwgaHR0cDovL3lqeWFvLmNvbVxuLy9cbi8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcbi8vIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlIFwiU29mdHdhcmVcIiksIHRvIGRlYWxcbi8vIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHNcbi8vIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGxcbi8vIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpc1xuLy8gZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczpcbi8vXG4vLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpblxuLy8gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuXG4vL1xuLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEIFwiQVMgSVNcIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUlxuLy8gSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksXG4vLyBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEVcbi8vIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVJcbi8vIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sXG4vLyBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOXG4vLyBUSEUgU09GVFdBUkUuXG5pbXBvcnQgeyBUd29EaW1BcnJheSB9IGZyb20gJy4vdHdvLWRpbS1hcnJheSdcblxubGV0IGN1ckhhc2ggPSAwXG5jb25zdCBoYXNoVG86IHsgW2tleTogc3RyaW5nXTogV3JhcHBlZERvbVRyZWUgfCB1bmRlZmluZWQgfSA9IHt9XG5cbnR5cGUgT3BlcmF0aW9uID1cbiAgfCB7IHR5cGU6ICdyJzsgdHJlZTogbnVtYmVyOyBvdGhlclRyZWU6IG51bWJlciB9XG4gIHwgeyB0eXBlOiAnZCc7IHRyZWU6IG51bWJlciB9XG4gIHwgeyB0eXBlOiAnaSc7IG90aGVyVHJlZTogbnVtYmVyOyBwb3M6IG51bWJlciB9XG5cbmV4cG9ydCBjbGFzcyBXcmFwcGVkRG9tVHJlZSB7XG4gIHB1YmxpYyByZWFkb25seSBzaG93blRyZWU/OiBXcmFwcGVkRG9tVHJlZVxuICBwdWJsaWMgcmVhZG9ubHkgZG9tOiBFbGVtZW50XG4gIHByaXZhdGUgdGV4dERhdGE6IHN0cmluZ1xuICBwcml2YXRlIGNoaWxkcmVuOiBXcmFwcGVkRG9tVHJlZVtdID0gW11cbiAgcHJpdmF0ZSBzaXplOiBudW1iZXIgPSAwXG4gIHByaXZhdGUgZGlmZkhhc2g6IHsgW2tleTogc3RyaW5nXTogYW55IH1cbiAgcHJpdmF0ZSBjbGFzc05hbWU6IHN0cmluZ1xuICBwcml2YXRlIHRhZ05hbWU6IHN0cmluZ1xuICBwcml2YXRlIHJlcD86IFdyYXBwZWREb21UcmVlXG4gIHByaXZhdGUgaXNUZXh0OiBib29sZWFuXG4gIHByaXZhdGUgaGFzaDogbnVtYmVyXG4gIHByaXZhdGUgY2xvbmU6IGJvb2xlYW5cbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLXVuaW5pdGlhbGl6ZWRcbiAgLy8gQHBhcmFtIGRvbSBBIERPTSBlbGVtZW50IG9iamVjdFxuICAvLyAgICBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvZWxlbWVudFxuICAvLyBAcGFyYW0gY2xvbmUgQm9vbGVhbiBmbGFnIGluZGljYXRpbmcgaWYgdGhpcyBpcyB0aGUgRE9NIHRyZWUgdG8gbW9kaWZ5XG4gIC8vIEBwYXJhbSByZXAgV3JhcHBlZERvbVRyZWUgb2YgYSBET00gZWxlbWVudCBub2RlIGluIGRvbVxuICBjb25zdHJ1Y3Rvcihkb206IEVsZW1lbnQsIGNsb25lOiB0cnVlKVxuICBjb25zdHJ1Y3Rvcihkb206IEVsZW1lbnQsIGNsb25lOiBmYWxzZSwgcmVwPzogV3JhcHBlZERvbVRyZWUpXG4gIGNvbnN0cnVjdG9yKGRvbTogRWxlbWVudCwgY2xvbmU6IGJvb2xlYW4sIHJlcD86IFdyYXBwZWREb21UcmVlKSB7XG4gICAgaWYgKGNsb25lKSB7XG4gICAgICB0aGlzLnNob3duVHJlZSA9IG5ldyBXcmFwcGVkRG9tVHJlZShkb20sIGZhbHNlLCB0aGlzKVxuICAgICAgdGhpcy5kb20gPSBkb20uY2xvbmVOb2RlKHRydWUpIGFzIEVsZW1lbnRcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5kb20gPSBkb21cbiAgICAgIHRoaXMucmVwID0gcmVwXG4gICAgfVxuXG4gICAgdGhpcy5jbG9uZSA9IGNsb25lXG4gICAgdGhpcy5oYXNoID0gY3VySGFzaCsrXG4gICAgaGFzaFRvW3RoaXMuaGFzaF0gPSB0aGlzXG4gICAgdGhpcy5pc1RleHQgPSBkb20ubm9kZVR5cGUgPT09IDNcbiAgICB0aGlzLnRhZ05hbWUgPSBkb20udGFnTmFtZVxuICAgIHRoaXMuY2xhc3NOYW1lID0gZG9tLmNsYXNzTmFtZVxuICAgIHRoaXMudGV4dERhdGEgPSAoZG9tIGFzIGFueSkuZGF0YVxuICAgIHRoaXMuZGlmZkhhc2ggPSB7fVxuXG4gICAgaWYgKHRoaXMuaXNUZXh0KSB7XG4gICAgICB0aGlzLnNpemUgPSAxXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuY2hpbGRyZW4gPSBBcnJheS5mcm9tKHRoaXMuZG9tLmNoaWxkTm9kZXMpLm1hcChcbiAgICAgICAgKGRvbSwgaW5kKSA9PlxuICAgICAgICAgIG5ldyBXcmFwcGVkRG9tVHJlZShcbiAgICAgICAgICAgIGRvbSBhcyBFbGVtZW50LFxuICAgICAgICAgICAgZmFsc2UsXG4gICAgICAgICAgICByZXAgPyByZXAuY2hpbGRyZW5baW5kXSA6IHVuZGVmaW5lZCxcbiAgICAgICAgICApLFxuICAgICAgKVxuICAgICAgdGhpcy5zaXplID0gdGhpcy5jaGlsZHJlbi5sZW5ndGhcbiAgICAgICAgPyB0aGlzLmNoaWxkcmVuLnJlZHVjZSgocHJldiwgY3VyKSA9PiBwcmV2ICsgY3VyLnNpemUsIDApXG4gICAgICAgIDogMFxuICAgICAgaWYgKCF0aGlzLnNpemUpIHtcbiAgICAgICAgdGhpcy5zaXplID0gMVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8vIEBwYXJhbSBvdGhlclRyZWUgV3JhcHBlZERvbVRyZWUgb2YgYSBET00gZWxlbWVudCB0byBkaWZmIGFnYWluc3RcbiAgcHVibGljIGRpZmZUbyhcbiAgICBvdGhlclRyZWU6IFdyYXBwZWREb21UcmVlLFxuICApOiB7XG4gICAgcG9zc2libGVSZXBsYWNlPzoge1xuICAgICAgY3VyPzogTm9kZVxuICAgICAgcHJldj86IEVsZW1lbnRcbiAgICB9XG4gICAgaW5zZXJ0ZWQ6IE5vZGVbXVxuICAgIGxhc3Q/OiBOb2RlXG4gIH0ge1xuICAgIGlmICh0aGlzLmNsb25lICYmIHRoaXMuc2hvd25UcmVlKSB7XG4gICAgICByZXR1cm4gdGhpcy5zaG93blRyZWUuZGlmZlRvKG90aGVyVHJlZSlcbiAgICB9XG5cbiAgICBjb25zdCBkaWZmID0gdGhpcy5yZXAgJiYgdGhpcy5yZXAuZGlmZihvdGhlclRyZWUpXG4gICAgY29uc3Qgb3BlcmF0aW9ucyA9IGRpZmYgJiYgZGlmZi5vcGVyYXRpb25zXG4gICAgbGV0IGluZGV4U2hpZnQgPSAwXG4gICAgbGV0IGluc2VydGVkOiBOb2RlW10gPSBbXVxuXG4gICAgLy8gRm9yY2UgdmFyaWFibGVzIHRvIGxlYWsgdG8gZGlmZlRvIHNjb3BlXG4gICAgbGV0IGxhc3Q6IE5vZGUgfCB1bmRlZmluZWRcbiAgICBsZXQgcG9zc2libGVSZXBsYWNlXG4gICAgbGV0IHJcbiAgICBsZXQgbGFzdE9wOiBPcGVyYXRpb24gfCB1bmRlZmluZWRcbiAgICBsZXQgbGFzdEVsbURlbGV0ZWQ6IEVsZW1lbnQgfCB1bmRlZmluZWRcbiAgICBsZXQgbGFzdEVsbUluc2VydGVkOiBFbGVtZW50IHwgdW5kZWZpbmVkXG5cbiAgICBpZiAob3BlcmF0aW9ucykge1xuICAgICAgaWYgKEFycmF5LmlzQXJyYXkob3BlcmF0aW9ucykpIHtcbiAgICAgICAgZm9yIChjb25zdCBvcCBvZiBvcGVyYXRpb25zKSB7XG4gICAgICAgICAgaWYgKG9wLnR5cGUgPT09ICdkJykge1xuICAgICAgICAgICAgY29uc3QgcG9zc2libGVMYXN0RGVsZXRlZCA9IHRoaXMuY2hpbGRyZW5bb3AudHJlZSArIGluZGV4U2hpZnRdLmRvbVxuICAgICAgICAgICAgciA9IHRoaXMucmVtb3ZlKG9wLnRyZWUgKyBpbmRleFNoaWZ0KVxuICAgICAgICAgICAgdGhpcy5yZXAgJiYgdGhpcy5yZXAucmVtb3ZlKG9wLnRyZWUgKyBpbmRleFNoaWZ0KVxuICAgICAgICAgICAgaWYgKCFsYXN0IHx8IGxhc3QubmV4dFNpYmxpbmcgPT09IHIgfHwgbGFzdCA9PT0gcikge1xuICAgICAgICAgICAgICBsYXN0ID0gclxuICAgICAgICAgICAgICAvLyBVbmRlZmluZWQgZXJyb3JzIGNhbiBiZSB0aHJvdyBzbyB3ZSBhZGQgYSBjb25kaXRpb24gb24gbGFzdE9wXG4gICAgICAgICAgICAgIC8vIGJlaW5nIGRlZmluZWRcbiAgICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgIGxhc3QgJiZcbiAgICAgICAgICAgICAgICBsYXN0T3AgJiZcbiAgICAgICAgICAgICAgICBsYXN0T3AudHlwZSA9PT0gJ2knICYmXG4gICAgICAgICAgICAgICAgb3AudHJlZSA9PT0gbGFzdE9wLnBvc1xuICAgICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICBsYXN0RWxtRGVsZXRlZCA9IHBvc3NpYmxlTGFzdERlbGV0ZWRcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBsYXN0RWxtRGVsZXRlZCA9IHVuZGVmaW5lZFxuICAgICAgICAgICAgICAgIGxhc3RFbG1JbnNlcnRlZCA9IHVuZGVmaW5lZFxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGxhc3RPcCA9IG9wXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpbmRleFNoaWZ0LS1cbiAgICAgICAgICB9IGVsc2UgaWYgKG9wLnR5cGUgPT09ICdpJykge1xuICAgICAgICAgICAgdGhpcy5yZXAgJiZcbiAgICAgICAgICAgICAgdGhpcy5yZXAuaW5zZXJ0KFxuICAgICAgICAgICAgICAgIG9wLnBvcyArIGluZGV4U2hpZnQsXG4gICAgICAgICAgICAgICAgb3RoZXJUcmVlLmNoaWxkcmVuW29wLm90aGVyVHJlZV0sXG4gICAgICAgICAgICAgIClcbiAgICAgICAgICAgIHIgPSB0aGlzLmluc2VydChcbiAgICAgICAgICAgICAgb3AucG9zICsgaW5kZXhTaGlmdCxcbiAgICAgICAgICAgICAgb3RoZXJUcmVlLmNoaWxkcmVuW29wLm90aGVyVHJlZV0sXG4gICAgICAgICAgICAgIHRoaXMucmVwICYmIHRoaXMucmVwLmNoaWxkcmVuW29wLnBvcyArIGluZGV4U2hpZnRdLFxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgaW5zZXJ0ZWQucHVzaChyKVxuICAgICAgICAgICAgaWYgKCFsYXN0IHx8IGxhc3QubmV4dFNpYmxpbmcgPT09IHIpIHtcbiAgICAgICAgICAgICAgbGFzdCA9IHJcbiAgICAgICAgICAgICAgbGFzdE9wID0gb3BcbiAgICAgICAgICAgICAgbGFzdEVsbUluc2VydGVkID0gciBhcyBFbGVtZW50XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpbmRleFNoaWZ0KytcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc3QgcmUgPSB0aGlzLmNoaWxkcmVuW29wLnRyZWUgKyBpbmRleFNoaWZ0XS5kaWZmVG8oXG4gICAgICAgICAgICAgIG90aGVyVHJlZS5jaGlsZHJlbltvcC5vdGhlclRyZWVdLFxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAhbGFzdCB8fFxuICAgICAgICAgICAgICAobGFzdC5uZXh0U2libGluZyA9PT0gdGhpcy5jaGlsZHJlbltvcC50cmVlICsgaW5kZXhTaGlmdF0uZG9tICYmXG4gICAgICAgICAgICAgICAgcmUubGFzdClcbiAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICA7KHsgbGFzdCB9ID0gcmUpXG4gICAgICAgICAgICAgIGlmIChyZS5wb3NzaWJsZVJlcGxhY2UpIHtcbiAgICAgICAgICAgICAgICBsYXN0RWxtSW5zZXJ0ZWQgPSByZS5wb3NzaWJsZVJlcGxhY2UuY3VyIGFzIEVsZW1lbnQgfCB1bmRlZmluZWRcbiAgICAgICAgICAgICAgICBsYXN0RWxtRGVsZXRlZCA9IHJlLnBvc3NpYmxlUmVwbGFjZS5wcmV2XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgbGFzdE9wID0gb3BcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGluc2VydGVkID0gaW5zZXJ0ZWQuY29uY2F0KHJlLmluc2VydGVkKVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc29sZS5sb2cob3BlcmF0aW9ucylcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdpbnZhbGlkIG9wZXJhdGlvbnMnKVxuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChsYXN0T3AgJiYgbGFzdE9wLnR5cGUgIT09ICdpJyAmJiBsYXN0RWxtSW5zZXJ0ZWQgJiYgbGFzdEVsbURlbGV0ZWQpIHtcbiAgICAgIHBvc3NpYmxlUmVwbGFjZSA9IHtcbiAgICAgICAgY3VyOiBsYXN0RWxtSW5zZXJ0ZWQsXG4gICAgICAgIHByZXY6IGxhc3RFbG1EZWxldGVkLFxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBsYXN0LFxuICAgICAgaW5zZXJ0ZWQsXG4gICAgICBwb3NzaWJsZVJlcGxhY2UsXG4gICAgfVxuICB9XG5cbiAgaW5zZXJ0KGk6IG51bWJlciwgdHJlZTogV3JhcHBlZERvbVRyZWUsIHJlcD86IFdyYXBwZWREb21UcmVlKSB7XG4gICAgY29uc3QgZG9tID0gdHJlZS5kb20uY2xvbmVOb2RlKHRydWUpXG4gICAgaWYgKGkgPT09IHRoaXMuZG9tLmNoaWxkTm9kZXMubGVuZ3RoKSB7XG4gICAgICB0aGlzLmRvbS5hcHBlbmRDaGlsZChkb20pXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZG9tLmluc2VydEJlZm9yZShkb20sIHRoaXMuZG9tLmNoaWxkTm9kZXNbaV0pXG4gICAgfVxuXG4gICAgY29uc3QgY3RyZWUgPSBuZXcgV3JhcHBlZERvbVRyZWUoZG9tIGFzIEVsZW1lbnQsIGZhbHNlLCByZXApXG4gICAgdGhpcy5jaGlsZHJlbi5zcGxpY2UoaSwgMCwgY3RyZWUpXG4gICAgcmV0dXJuIHRoaXMuZG9tLmNoaWxkTm9kZXNbaV1cbiAgfVxuXG4gIHJlbW92ZShpOiBudW1iZXIpIHtcbiAgICB0aGlzLmRvbS5yZW1vdmVDaGlsZCh0aGlzLmRvbS5jaGlsZE5vZGVzW2ldKVxuICAgIHRoaXMuY2hpbGRyZW5baV0ucmVtb3ZlU2VsZigpXG4gICAgdGhpcy5jaGlsZHJlbi5zcGxpY2UoaSwgMSlcbiAgICByZXR1cm4gdGhpcy5kb20uY2hpbGROb2Rlc1tpIC0gMV1cbiAgfVxuXG4gIHByaXZhdGUgZGlmZihcbiAgICBvdGhlclRyZWU6IFdyYXBwZWREb21UcmVlLFxuICAgIHRtYXg/OiBudW1iZXIsXG4gICk6IHtcbiAgICBzY29yZTogbnVtYmVyXG4gICAgb3BlcmF0aW9ucz86IE9wZXJhdGlvbltdXG4gIH0ge1xuICAgIGxldCBpXG4gICAgaWYgKHRoaXMuZXF1YWxUbyhvdGhlclRyZWUpKSB7XG4gICAgICByZXR1cm4geyBzY29yZTogMCwgb3BlcmF0aW9uczogdW5kZWZpbmVkIH1cbiAgICB9XG5cbiAgICBpZiAodGhpcy5jYW5ub3RSZXBsYWNlV2l0aChvdGhlclRyZWUpKSB7XG4gICAgICByZXR1cm4geyBzY29yZTogMSAvIDAsIG9wZXJhdGlvbnM6IHVuZGVmaW5lZCB9XG4gICAgfVxuXG4gICAgY29uc3Qga2V5ID0gb3RoZXJUcmVlLmhhc2hcbiAgICBpZiAoT2JqZWN0LmtleXModGhpcy5kaWZmSGFzaCkuaW5jbHVkZXMoa2V5LnRvU3RyaW5nKCkpKSB7XG4gICAgICByZXR1cm4gdGhpcy5kaWZmSGFzaFtrZXldXG4gICAgfVxuXG4gICAgaWYgKHRtYXggPT09IHVuZGVmaW5lZCkge1xuICAgICAgdG1heCA9IDEwMDAwMFxuICAgIH1cbiAgICBpZiAodG1heCA8PSAwKSB7XG4gICAgICByZXR1cm4geyBzY29yZTogMCB9XG4gICAgfVxuXG4gICAgbGV0IG9mZnNldCA9IDBcbiAgICBjb25zdCBmb3J3YXJkU2VhcmNoID0gKG9mZnNldDogbnVtYmVyKSA9PlxuICAgICAgb2Zmc2V0IDwgdGhpcy5jaGlsZHJlbi5sZW5ndGggJiZcbiAgICAgIG9mZnNldCA8IG90aGVyVHJlZS5jaGlsZHJlbi5sZW5ndGggJiZcbiAgICAgIHRoaXMuY2hpbGRyZW5bb2Zmc2V0XS5lcXVhbFRvKG90aGVyVHJlZS5jaGlsZHJlbltvZmZzZXRdKVxuICAgIHdoaWxlIChmb3J3YXJkU2VhcmNoKG9mZnNldCkpIHtcbiAgICAgIG9mZnNldCsrXG4gICAgfVxuXG4gICAgY29uc3QgZHAgPSBuZXcgVHdvRGltQXJyYXk8bnVtYmVyPihcbiAgICAgIHRoaXMuY2hpbGRyZW4ubGVuZ3RoICsgMSAtIG9mZnNldCxcbiAgICAgIG90aGVyVHJlZS5jaGlsZHJlbi5sZW5ndGggKyAxIC0gb2Zmc2V0LFxuICAgIClcbiAgICBjb25zdCBwID0gbmV3IFR3b0RpbUFycmF5PG51bWJlcj4oXG4gICAgICB0aGlzLmNoaWxkcmVuLmxlbmd0aCArIDEgLSBvZmZzZXQsXG4gICAgICBvdGhlclRyZWUuY2hpbGRyZW4ubGVuZ3RoICsgMSAtIG9mZnNldCxcbiAgICApXG4gICAgZHAuc2V0KDAsIDAsIDApXG5cbiAgICBsZXQgc3VtID0gMFxuICAgIC8vIEJlY2F1c2UgY29mZmVzY3JpcHRzIGFsbG93cyBiaWRlcmN0aW9uYWwgbG9vcHMgd2UgbmVlZCB0aGlzIGNvbmRpdGlvblxuICAgIC8vIGdhdXJkIHRvIHByZXZlbnQgYSBkZWNyZWFzaW5nIGFycmF5IGxpc3RcbiAgICBpZiAob3RoZXJUcmVlLmNoaWxkcmVuLmxlbmd0aCAtIG9mZnNldCA+IDEpIHtcbiAgICAgIGxldCBhc2M6IGJvb2xlYW5cbiAgICAgIGxldCBlbmQ6IG51bWJlclxuICAgICAgZm9yIChcbiAgICAgICAgaSA9IDEsIGVuZCA9IG90aGVyVHJlZS5jaGlsZHJlbi5sZW5ndGggLSBvZmZzZXQgLSAxLCBhc2MgPSAxIDw9IGVuZDtcbiAgICAgICAgYXNjID8gaSA8PSBlbmQgOiBpID49IGVuZDtcbiAgICAgICAgYXNjID8gaSsrIDogaS0tXG4gICAgICApIHtcbiAgICAgICAgZHAuc2V0KDAsIGksIHN1bSlcbiAgICAgICAgcC5zZXQoMCwgaSwgaSAtIDEpXG4gICAgICAgIHN1bSArPSBvdGhlclRyZWUuY2hpbGRyZW5baSArIG9mZnNldF0uc2l6ZVxuICAgICAgfVxuICAgIH1cbiAgICBpZiAob3RoZXJUcmVlLmNoaWxkcmVuLmxlbmd0aCAtIG9mZnNldCA+IDApIHtcbiAgICAgIGRwLnNldCgwLCBvdGhlclRyZWUuY2hpbGRyZW4ubGVuZ3RoIC0gb2Zmc2V0LCBzdW0pXG4gICAgICBwLnNldChcbiAgICAgICAgMCxcbiAgICAgICAgb3RoZXJUcmVlLmNoaWxkcmVuLmxlbmd0aCAtIG9mZnNldCxcbiAgICAgICAgb3RoZXJUcmVlLmNoaWxkcmVuLmxlbmd0aCAtIDEgLSBvZmZzZXQsXG4gICAgICApXG4gICAgfVxuXG4gICAgc3VtID0gMFxuICAgIC8vIEJlY2F1c2UgY29mZmVzY3JpcHRzIGFsbG93cyBiaWRlcmN0aW9uYWwgbG9vcHMgd2UgbmVlZCB0aGlzIGNvbmRpdGlvblxuICAgIC8vIGdhdXJkIHRvIHByZXZlbnQgYSBkZWNyZWFzaW5nIGFycmF5IGxpc3RcbiAgICBpZiAodGhpcy5jaGlsZHJlbi5sZW5ndGggLSBvZmZzZXQgPiAxKSB7XG4gICAgICBsZXQgYXNjMTogYm9vbGVhblxuICAgICAgbGV0IGVuZDE6IG51bWJlclxuICAgICAgZm9yIChcbiAgICAgICAgaSA9IDEsIGVuZDEgPSB0aGlzLmNoaWxkcmVuLmxlbmd0aCAtIG9mZnNldCAtIDEsIGFzYzEgPSAxIDw9IGVuZDE7XG4gICAgICAgIGFzYzEgPyBpIDw9IGVuZDEgOiBpID49IGVuZDE7XG4gICAgICAgIGFzYzEgPyBpKysgOiBpLS1cbiAgICAgICkge1xuICAgICAgICBkcC5zZXQoaSwgMCwgc3VtKVxuICAgICAgICBwLnNldChpLCAwLCAoaSAtIDEpICogcC5jb2wpXG4gICAgICAgIHN1bSArPSB0aGlzLmNoaWxkcmVuW2kgKyBvZmZzZXRdLnNpemVcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHRoaXMuY2hpbGRyZW4ubGVuZ3RoIC0gb2Zmc2V0KSB7XG4gICAgICBkcC5zZXQodGhpcy5jaGlsZHJlbi5sZW5ndGggLSBvZmZzZXQsIDAsIHN1bSlcbiAgICAgIHAuc2V0KFxuICAgICAgICB0aGlzLmNoaWxkcmVuLmxlbmd0aCAtIG9mZnNldCxcbiAgICAgICAgMCxcbiAgICAgICAgKHRoaXMuY2hpbGRyZW4ubGVuZ3RoIC0gMSAtIG9mZnNldCkgKiBwLmNvbCxcbiAgICAgIClcbiAgICB9XG5cbiAgICBjb25zdCBnZXRTY29yZSA9IChpOiBudW1iZXIsIGo6IG51bWJlciwgbWF4PzogbnVtYmVyKTogbnVtYmVyID0+IHtcbiAgICAgIGNvbnN0IHJlcyA9IGRwLmdldChpLCBqKVxuICAgICAgaWYgKHJlcyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHJldHVybiByZXNcbiAgICAgIH1cbiAgICAgIGlmIChtYXggPT09IHVuZGVmaW5lZCkge1xuICAgICAgICBtYXggPSAxIC8gMFxuICAgICAgfVxuICAgICAgaWYgKG1heCA8PSAwKSB7XG4gICAgICAgIHJldHVybiAxIC8gMFxuICAgICAgfVxuXG4gICAgICBsZXQgdmFsID0gbWF4XG4gICAgICBjb25zdCBib3VuZCA9IG1heFxuICAgICAgY29uc3Qgc3ViZGlmZiA9IHRoaXMuY2hpbGRyZW5baSAtIDEgKyBvZmZzZXRdLmRpZmYoXG4gICAgICAgIG90aGVyVHJlZS5jaGlsZHJlbltqIC0gMSArIG9mZnNldF0sXG4gICAgICAgIGJvdW5kLFxuICAgICAgKS5zY29yZVxuICAgICAgbGV0IGZvcmNlID0gZmFsc2VcbiAgICAgIGlmIChcbiAgICAgICAgc3ViZGlmZiA8IGJvdW5kICYmXG4gICAgICAgIHN1YmRpZmYgKyAxIDxcbiAgICAgICAgICB0aGlzLmNoaWxkcmVuW2kgLSAxICsgb2Zmc2V0XS5zaXplICtcbiAgICAgICAgICAgIG90aGVyVHJlZS5jaGlsZHJlbltqIC0gMSArIG9mZnNldF0uc2l6ZVxuICAgICAgKSB7XG4gICAgICAgIGZvcmNlID0gdHJ1ZVxuICAgICAgfVxuICAgICAgdmFsID0gZ2V0U2NvcmUoaSAtIDEsIGogLSAxLCBib3VuZCAtIHN1YmRpZmYpICsgc3ViZGlmZlxuICAgICAgbGV0IHByZXYgPSBwLmdldEluZChpIC0gMSwgaiAtIDEpXG5cbiAgICAgIGlmICghZm9yY2UpIHtcbiAgICAgICAgbGV0IG90aGVyID1cbiAgICAgICAgICBnZXRTY29yZShcbiAgICAgICAgICAgIGkgLSAxLFxuICAgICAgICAgICAgaixcbiAgICAgICAgICAgIE1hdGgubWluKHZhbCwgbWF4KSAtIHRoaXMuY2hpbGRyZW5baSAtIDEgKyBvZmZzZXRdLnNpemUsXG4gICAgICAgICAgKSArIHRoaXMuY2hpbGRyZW5baSAtIDEgKyBvZmZzZXRdLnNpemVcbiAgICAgICAgaWYgKG90aGVyIDwgdmFsKSB7XG4gICAgICAgICAgcHJldiA9IHAuZ2V0SW5kKGkgLSAxLCBqKVxuICAgICAgICAgIHZhbCA9IG90aGVyXG4gICAgICAgIH1cblxuICAgICAgICBvdGhlciA9XG4gICAgICAgICAgZ2V0U2NvcmUoXG4gICAgICAgICAgICBpLFxuICAgICAgICAgICAgaiAtIDEsXG4gICAgICAgICAgICBNYXRoLm1pbih2YWwsIG1heCkgLSBvdGhlclRyZWUuY2hpbGRyZW5baiAtIDEgKyBvZmZzZXRdLnNpemUsXG4gICAgICAgICAgKSArIG90aGVyVHJlZS5jaGlsZHJlbltqIC0gMSArIG9mZnNldF0uc2l6ZVxuICAgICAgICBpZiAob3RoZXIgPCB2YWwpIHtcbiAgICAgICAgICBwcmV2ID0gcC5nZXRJbmQoaSwgaiAtIDEpXG4gICAgICAgICAgdmFsID0gb3RoZXJcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAodmFsID49IG1heCkge1xuICAgICAgICB2YWwgPSAxIC8gMFxuICAgICAgfVxuXG4gICAgICBkcC5zZXQoaSwgaiwgdmFsKVxuICAgICAgcC5zZXQoaSwgaiwgcHJldilcbiAgICAgIHJldHVybiB2YWxcbiAgICB9XG5cbiAgICBjb25zdCBzY29yZSA9IGdldFNjb3JlKFxuICAgICAgdGhpcy5jaGlsZHJlbi5sZW5ndGggLSBvZmZzZXQsXG4gICAgICBvdGhlclRyZWUuY2hpbGRyZW4ubGVuZ3RoIC0gb2Zmc2V0LFxuICAgICAgdG1heCxcbiAgICApXG4gICAgY29uc3Qgb3BlcmF0aW9uczogT3BlcmF0aW9uW10gPSBbXVxuXG4gICAgbGV0IGN1ciA9IHAuZ2V0SW5kKFxuICAgICAgdGhpcy5jaGlsZHJlbi5sZW5ndGggLSBvZmZzZXQsXG4gICAgICBvdGhlclRyZWUuY2hpbGRyZW4ubGVuZ3RoIC0gb2Zmc2V0LFxuICAgIClcbiAgICBsZXQgY3IgPSB0aGlzLmNoaWxkcmVuLmxlbmd0aCAtIDEgLSBvZmZzZXRcbiAgICBsZXQgY2MgPSBvdGhlclRyZWUuY2hpbGRyZW4ubGVuZ3RoIC0gMSAtIG9mZnNldFxuXG4gICAgd2hpbGUgKHAucmF3R2V0KGN1cikgIT09IHVuZGVmaW5lZCkge1xuICAgICAgY29uc3QgcHJldiA9IHAucmF3R2V0KGN1cikhXG4gICAgICBjb25zdCByYyA9IHAuZ2V0MkRJbmQocHJldilcbiAgICAgIGNvbnN0IHByID0gcmMuciAtIDFcbiAgICAgIGNvbnN0IHBjID0gcmMuYyAtIDFcblxuICAgICAgaWYgKHByID09PSBjcikge1xuICAgICAgICBvcGVyYXRpb25zLnVuc2hpZnQoe1xuICAgICAgICAgIHR5cGU6ICdpJyxcbiAgICAgICAgICBvdGhlclRyZWU6IGNjICsgb2Zmc2V0LFxuICAgICAgICAgIHBvczogY3IgKyAxICsgb2Zmc2V0LFxuICAgICAgICB9KVxuICAgICAgfSBlbHNlIGlmIChwYyA9PT0gY2MpIHtcbiAgICAgICAgb3BlcmF0aW9ucy51bnNoaWZ0KHtcbiAgICAgICAgICB0eXBlOiAnZCcsXG4gICAgICAgICAgdHJlZTogY3IgKyBvZmZzZXQsXG4gICAgICAgIH0pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCBvcCA9IHRoaXMuY2hpbGRyZW5bY3IgKyBvZmZzZXRdLmRpZmYoXG4gICAgICAgICAgb3RoZXJUcmVlLmNoaWxkcmVuW2NjICsgb2Zmc2V0XSxcbiAgICAgICAgKS5vcGVyYXRpb25zXG4gICAgICAgIGlmIChvcCAmJiBvcC5sZW5ndGgpIHtcbiAgICAgICAgICBvcGVyYXRpb25zLnVuc2hpZnQoe1xuICAgICAgICAgICAgdHlwZTogJ3InLFxuICAgICAgICAgICAgdHJlZTogY3IgKyBvZmZzZXQsXG4gICAgICAgICAgICBvdGhlclRyZWU6IGNjICsgb2Zmc2V0LFxuICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGN1ciA9IHByZXZcbiAgICAgIGNyID0gcHJcbiAgICAgIGNjID0gcGNcbiAgICB9XG5cbiAgICB0aGlzLmRpZmZIYXNoW2tleV0gPSB7XG4gICAgICBzY29yZSxcbiAgICAgIG9wZXJhdGlvbnMsXG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuZGlmZkhhc2hba2V5XVxuICB9XG5cbiAgZXF1YWxUbyhvdGhlclRyZWU6IFdyYXBwZWREb21UcmVlKSB7XG4gICAgcmV0dXJuIHRoaXMuZG9tLmlzRXF1YWxOb2RlKG90aGVyVHJlZS5kb20pXG4gIH1cblxuICBjYW5ub3RSZXBsYWNlV2l0aChvdGhlclRyZWU6IFdyYXBwZWREb21UcmVlKSB7XG4gICAgcmV0dXJuIChcbiAgICAgIHRoaXMuaXNUZXh0IHx8XG4gICAgICBvdGhlclRyZWUuaXNUZXh0IHx8XG4gICAgICB0aGlzLnRhZ05hbWUgIT09IG90aGVyVHJlZS50YWdOYW1lIHx8XG4gICAgICB0aGlzLmNsYXNzTmFtZSAhPT0gb3RoZXJUcmVlLmNsYXNzTmFtZSB8fFxuICAgICAgdGhpcy5jbGFzc05hbWUgPT09ICdtYXRoJyB8fFxuICAgICAgdGhpcy5jbGFzc05hbWUgPT09ICdhdG9tLXRleHQtZWRpdG9yJyB8fFxuICAgICAgdGhpcy50YWdOYW1lID09PSAnQScgfHxcbiAgICAgICh0aGlzLnRhZ05hbWUgPT09ICdJTUcnICYmICF0aGlzLmRvbS5pc0VxdWFsTm9kZShvdGhlclRyZWUuZG9tKSlcbiAgICApXG4gIH1cblxuICBnZXRDb250ZW50KCkge1xuICAgIGlmICh0aGlzLmRvbS5vdXRlckhUTUwpIHtcbiAgICAgIHJldHVybiB0aGlzLmRvbS5vdXRlckhUTUxcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHRoaXMudGV4dERhdGFcbiAgICB9XG4gIH1cblxuICByZW1vdmVTZWxmKCkge1xuICAgIGhhc2hUb1t0aGlzLmhhc2hdID0gdW5kZWZpbmVkXG4gICAgdGhpcy5jaGlsZHJlbiAmJiB0aGlzLmNoaWxkcmVuLmZvckVhY2goKGMpID0+IGMucmVtb3ZlU2VsZigpKVxuICB9XG59XG4iXX0=