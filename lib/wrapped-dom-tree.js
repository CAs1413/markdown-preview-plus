'use strict';
let WrappedDomTree;
const TwoDimArray = require('./two-dim-array');
let curHash = 0;
const hashTo = {};
module.exports = WrappedDomTree = class WrappedDomTree {
    constructor(dom, clone, rep) {
        if (clone) {
            this.shownTree = new WrappedDomTree(dom, false, this);
            this.dom = dom.cloneNode(true);
        }
        else {
            this.dom = dom;
            this.rep = rep;
        }
        this.clone = clone;
        this.hash = curHash++;
        hashTo[this.hash] = this;
        this.isText = dom.nodeType === 3;
        this.tagName = dom.tagName;
        this.className = dom.className;
        this.textData = dom.data;
        this.diffHash = {};
        if (this.isText) {
            this.size = 1;
        }
        else {
            ;
            ({ rep } = this);
            this.children = [].map.call(this.dom.childNodes, (dom, ind) => new WrappedDomTree(dom, false, rep ? rep.children[ind] : null));
            this.size = this.children.length
                ? this.children.reduce((prev, cur) => prev + cur.size, 0)
                : 0;
            if (!this.size) {
                this.size = 1;
            }
        }
    }
    diffTo(otherTree) {
        if (this.clone) {
            return this.shownTree.diffTo(otherTree);
        }
        const diff = this.rep.diff(otherTree);
        const { score } = diff;
        const { operations } = diff;
        let indexShift = 0;
        let inserted = [];
        let [last, possibleReplace, r, lastOp, lastElmDeleted, lastElmInserted,] = Array.from([]);
        if (operations) {
            if (operations instanceof Array) {
                for (let op of Array.from(operations)) {
                    ;
                    ((op) => {
                        if (op.type === 'd') {
                            const possibleLastDeleted = this.children[op.tree + indexShift]
                                .dom;
                            r = this.remove(op.tree + indexShift);
                            this.rep.remove(op.tree + indexShift);
                            if (!last || last.nextSibling === r || last === r) {
                                last = r;
                                if (last && lastOp && op.tree === lastOp.pos) {
                                    lastElmDeleted = possibleLastDeleted;
                                }
                                else {
                                    lastElmDeleted = null;
                                    lastElmInserted = null;
                                }
                                lastOp = op;
                            }
                            indexShift--;
                            return;
                        }
                        else if (op.type === 'i') {
                            this.rep.insert(op.pos + indexShift, otherTree.children[op.otherTree]);
                            r = this.insert(op.pos + indexShift, otherTree.children[op.otherTree], this.rep.children[op.pos + indexShift]);
                            inserted.push(r);
                            if (!last || last.nextSibling === r) {
                                last = r;
                                lastOp = op;
                                lastElmInserted = r;
                            }
                            indexShift++;
                            return;
                        }
                        else {
                            const re = this.children[op.tree + indexShift].diffTo(otherTree.children[op.otherTree]);
                            if (!last ||
                                (last.nextSibling === this.children[op.tree + indexShift].dom &&
                                    re.last)) {
                                ;
                                ({ last } = re);
                                if (re.possibleReplace) {
                                    lastElmInserted = re.possibleReplace.cur;
                                    lastElmDeleted = re.possibleReplace.prev;
                                }
                                lastOp = op;
                            }
                            inserted = inserted.concat(re.inserted);
                            return;
                        }
                    })(op);
                }
            }
            else {
                console.log(operations);
                throw new Error('invalid operations');
            }
        }
        if (lastOp && lastOp.type !== 'i' && lastElmInserted && lastElmDeleted) {
            possibleReplace = {
                cur: lastElmInserted,
                prev: lastElmDeleted,
            };
        }
        return {
            last,
            inserted,
            possibleReplace,
        };
    }
    insert(i, tree, rep) {
        const dom = tree.dom.cloneNode(true);
        if (i === this.dom.childNodes.length) {
            this.dom.appendChild(dom);
        }
        else {
            this.dom.insertBefore(dom, this.dom.childNodes[i]);
        }
        const ctree = new WrappedDomTree(dom, false, rep);
        this.children.splice(i, 0, ctree);
        return this.dom.childNodes[i];
    }
    remove(i) {
        this.dom.removeChild(this.dom.childNodes[i]);
        this.children[i].removeSelf();
        this.children.splice(i, 1);
        return this.dom.childNodes[i - 1];
    }
    diff(otherTree, tmax) {
        let i;
        if (this.equalTo(otherTree)) {
            return { score: 0, operations: null };
        }
        if (this.cannotReplaceWith(otherTree)) {
            return { score: 1 / 0, operations: null };
        }
        const key = otherTree.hash;
        if (Array.from(this.diffHash).includes(key)) {
            return this.diffHash[key];
        }
        if (tmax === undefined) {
            tmax = 100000;
        }
        if (tmax <= 0) {
            return 0;
        }
        let offset = 0;
        const forwardSearch = (offset) => {
            return (offset < this.children.length &&
                offset < otherTree.children.length &&
                this.children[offset].equalTo(otherTree.children[offset]));
        };
        while (forwardSearch(offset)) {
            offset++;
        }
        const dp = new TwoDimArray(this.children.length + 1 - offset, otherTree.children.length + 1 - offset);
        const p = new TwoDimArray(this.children.length + 1 - offset, otherTree.children.length + 1 - offset);
        dp.set(0, 0, 0);
        let sum = 0;
        if (otherTree.children.length - offset > 1) {
            let asc, end;
            for (i = 1, end = otherTree.children.length - offset - 1, asc = 1 <= end; asc ? i <= end : i >= end; asc ? i++ : i--) {
                dp.set(0, i, sum);
                p.set(0, i, i - 1);
                sum += otherTree.children[i + offset].size;
            }
        }
        if (otherTree.children.length - offset > 0) {
            dp.set(0, otherTree.children.length - offset, sum);
            p.set(0, otherTree.children.length - offset, otherTree.children.length - 1 - offset);
        }
        sum = 0;
        if (this.children.length - offset > 1) {
            let asc1, end1;
            for (i = 1, end1 = this.children.length - offset - 1, asc1 = 1 <= end1; asc1 ? i <= end1 : i >= end1; asc1 ? i++ : i--) {
                dp.set(i, 0, sum);
                p.set(i, 0, (i - 1) * p.col);
                sum += this.children[i + offset].size;
            }
        }
        if (this.children.length - offset) {
            dp.set(this.children.length - offset, 0, sum);
            p.set(this.children.length - offset, 0, (this.children.length - 1 - offset) * p.col);
        }
        var getScore = (i, j, max) => {
            if (dp.get(i, j) !== undefined) {
                return dp.get(i, j);
            }
            if (max === undefined) {
                max = 1 / 0;
            }
            if (max <= 0) {
                return 1 / 0;
            }
            let val = max;
            const bound = max;
            const subdiff = this.children[i - 1 + offset].diff(otherTree.children[j - 1 + offset], bound).score;
            let force = false;
            if (subdiff < bound &&
                subdiff + 1 <
                    this.children[i - 1 + offset].size +
                        otherTree.children[j - 1 + offset].size) {
                force = true;
            }
            val = getScore(i - 1, j - 1, bound - subdiff) + subdiff;
            let prev = p.getInd(i - 1, j - 1);
            if (!force) {
                let other = getScore(i - 1, j, Math.min(val, max) - this.children[i - 1 + offset].size) + this.children[i - 1 + offset].size;
                if (other < val) {
                    prev = p.getInd(i - 1, j);
                    val = other;
                }
                other =
                    getScore(i, j - 1, Math.min(val, max) - otherTree.children[j - 1 + offset].size) + otherTree.children[j - 1 + offset].size;
                if (other < val) {
                    prev = p.getInd(i, j - 1);
                    val = other;
                }
            }
            if (val >= max) {
                val = 1 / 0;
            }
            dp.set(i, j, val);
            p.set(i, j, prev);
            return val;
        };
        const score = getScore(this.children.length - offset, otherTree.children.length - offset, tmax);
        const operations = [];
        let cur = p.getInd(this.children.length - offset, otherTree.children.length - offset);
        let cr = this.children.length - 1 - offset;
        let cc = otherTree.children.length - 1 - offset;
        while (p.rawGet(cur) !== undefined) {
            const prev = p.rawGet(cur);
            const rc = p.get2DInd(prev);
            const pr = rc.r - 1;
            const pc = rc.c - 1;
            if (pr === cr) {
                operations.unshift({
                    type: 'i',
                    otherTree: cc + offset,
                    pos: cr + 1 + offset,
                });
            }
            else if (pc === cc) {
                operations.unshift({
                    type: 'd',
                    tree: cr + offset,
                });
            }
            else {
                const op = this.children[cr + offset].diff(otherTree.children[cc + offset]).operations;
                if (op && op.length) {
                    operations.unshift({
                        type: 'r',
                        tree: cr + offset,
                        otherTree: cc + offset,
                    });
                }
            }
            cur = prev;
            cr = pr;
            cc = pc;
        }
        this.diffHash[key] = {
            score,
            operations,
        };
        return this.diffHash[key];
    }
    equalTo(otherTree) {
        return this.dom.isEqualNode(otherTree.dom);
    }
    cannotReplaceWith(otherTree) {
        return (this.isText ||
            otherTree.isText ||
            this.tagName !== otherTree.tagName ||
            this.className !== otherTree.className ||
            this.className === 'math' ||
            this.className === 'atom-text-editor' ||
            this.tagName === 'A' ||
            (this.tagName === 'IMG' && !this.dom.isEqualNode(otherTree.dom)));
    }
    getContent() {
        if (this.dom.outerHTML) {
            return this.dom.outerHTML;
        }
        else {
            return this.textData;
        }
    }
    removeSelf() {
        hashTo[this.hash] = null;
        this.children && this.children.forEach((c) => c.removeSelf());
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid3JhcHBlZC1kb20tdHJlZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy93cmFwcGVkLWRvbS10cmVlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQTZCQSxZQUFZLENBQUE7QUFFWixJQUFJLGNBQWMsQ0FBQTtBQUNsQixNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsaUJBQWlCLENBQUMsQ0FBQTtBQUU5QyxJQUFJLE9BQU8sR0FBRyxDQUFDLENBQUE7QUFDZixNQUFNLE1BQU0sR0FBRyxFQUFFLENBQUE7QUFFakIsTUFBTSxDQUFDLE9BQU8sR0FBRyxjQUFjLEdBQUc7SUFLaEMsWUFBWSxHQUFHLEVBQUUsS0FBSyxFQUFFLEdBQUc7UUFDekIsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUNWLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxjQUFjLENBQUMsR0FBRyxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQTtZQUNyRCxJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDaEMsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ04sSUFBSSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUE7WUFDZCxJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQTtRQUNoQixDQUFDO1FBRUQsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUE7UUFDbEIsSUFBSSxDQUFDLElBQUksR0FBRyxPQUFPLEVBQUUsQ0FBQTtRQUNyQixNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQTtRQUN4QixJQUFJLENBQUMsTUFBTSxHQUFHLEdBQUcsQ0FBQyxRQUFRLEtBQUssQ0FBQyxDQUFBO1FBQ2hDLElBQUksQ0FBQyxPQUFPLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQTtRQUMxQixJQUFJLENBQUMsU0FBUyxHQUFHLEdBQUcsQ0FBQyxTQUFTLENB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QUMsQ0FBQyxDQUFDLENBQUE7SUFDL0IsQ0FBQztJQUVELE1BQU0sQ0FBQyxDQUFDO1FBQ04sSUFBSSxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtRQUM1QyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLFVBQVUsRUFBRSxDQUFBO1FBQzdCLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQTtRQUMxQixNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFBO0lBQ25DLENBQUM7SUFFRCxJQUFJLENBQUMsU0FBUyxFQUFFLElBQUk7UUFDbEIsSUFBSSxDQUFDLENBQUE7UUFDTCxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUM1QixNQUFNLENBQUMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLFVBQVUsRUFBRSxJQUFJLEVBQUUsQ0FBQTtRQUN2QyxDQUFDO1FBRUQsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN0QyxNQUFNLENBQUMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxVQUFVLEVBQUUsSUFBSSxFQUFFLENBQUE7UUFDM0MsQ0FBQztRQUVELE1BQU0sR0FBRyxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUE7UUFDMUIsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUM1QyxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQTtRQUMzQixDQUFDO1FBRUQsRUFBRSxDQUFDLENB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QUMsQ0FBQyxDQUFDO1lBQ3ZCLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQTtRQUMzQixDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDTixNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQTtRQUN0QixDQUFDO0lBQ0gsQ0FBQztJQUVELFVBQVU7UUFDUixNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQTtRQUN4QixJQUFJLENBQUMsUUFBUSxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQTtJQUMvRCxDQUFDO0NBQ0YsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBkZWNhZmZlaW5hdGUgc3VnZ2VzdGlvbnM6XG4gKiBEUzEwMTogUmVtb3ZlIHVubmVjZXNzYXJ5IHVzZSBvZiBBcnJheS5mcm9tXG4gKiBEUzEwMjogUmVtb3ZlIHVubmVjZXNzYXJ5IGNvZGUgY3JlYXRlZCBiZWNhdXNlIG9mIGltcGxpY2l0IHJldHVybnNcbiAqIERTMjAyOiBTaW1wbGlmeSBkeW5hbWljIHJhbmdlIGxvb3BzXG4gKiBGdWxsIGRvY3M6IGh0dHBzOi8vZ2l0aHViLmNvbS9kZWNhZmZlaW5hdGUvZGVjYWZmZWluYXRlL2Jsb2IvbWFzdGVyL2RvY3Mvc3VnZ2VzdGlvbnMubWRcbiAqL1xuLy8gVGhpcyBmaWxlIGluY29ycG9yYXRlcyBjb2RlIGZyb20gW21hcmttb25dKGh0dHBzOi8vZ2l0aHViLmNvbS95eWpoYW8vbWFya21vbilcbi8vIGNvdmVyZWQgYnkgdGhlIGZvbGxvd2luZyB0ZXJtczpcbi8vXG4vLyBDb3B5cmlnaHQgKGMpIDIwMTQsIFlhbyBZdWppYW4sIGh0dHA6Ly95anlhby5jb21cbi8vXG4vLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5XG4vLyBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSBcIlNvZnR3YXJlXCIpLCB0byBkZWFsXG4vLyBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzXG4vLyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsXG4vLyBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXNcbi8vIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6XG4vL1xuLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW5cbi8vIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLlxuLy9cbi8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCBcIkFTIElTXCIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1Jcbi8vIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLFxuLy8gRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFXG4vLyBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSXG4vLyBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLFxuLy8gT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTlxuLy8gVEhFIFNPRlRXQVJFLlxuJ3VzZSBzdHJpY3QnXG5cbmxldCBXcmFwcGVkRG9tVHJlZVxuY29uc3QgVHdvRGltQXJyYXkgPSByZXF1aXJlKCcuL3R3by1kaW0tYXJyYXknKVxuXG5sZXQgY3VySGFzaCA9IDBcbmNvbnN0IGhhc2hUbyA9IHt9XG5cbm1vZHVsZS5leHBvcnRzID0gV3JhcHBlZERvbVRyZWUgPSBjbGFzcyBXcmFwcGVkRG9tVHJlZSB7XG4gIC8vIEBwYXJhbSBkb20gQSBET00gZWxlbWVudCBvYmplY3RcbiAgLy8gICAgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL2VsZW1lbnRcbiAgLy8gQHBhcmFtIGNsb25lIEJvb2xlYW4gZmxhZyBpbmRpY2F0aW5nIGlmIHRoaXMgaXMgdGhlIERPTSB0cmVlIHRvIG1vZGlmeVxuICAvLyBAcGFyYW0gcmVwIFdyYXBwZWREb21UcmVlIG9mIGEgRE9NIGVsZW1lbnQgbm9kZSBpbiBkb21cbiAgY29uc3RydWN0b3IoZG9tLCBjbG9uZSwgcmVwKSB7XG4gICAgaWYgKGNsb25lKSB7XG4gICAgICB0aGlzLnNob3duVHJlZSA9IG5ldyBXcmFwcGVkRG9tVHJlZShkb20sIGZhbHNlLCB0aGlzKVxuICAgICAgdGhpcy5kb20gPSBkb20uY2xvbmVOb2RlKHRydWUpXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZG9tID0gZG9tXG4gICAgICB0aGlzLnJlcCA9IHJlcFxuICAgIH1cblxuICAgIHRoaXMuY2xvbmUgPSBjbG9uZVxuICAgIHRoaXMuaGFzaCA9IGN1ckhhc2grK1xuICAgIGhhc2hUb1t0aGlzLmhhc2hdID0gdGhpc1xuICAgIHRoaXMuaXNUZXh0ID0gZG9tLm5vZGVUeXBlID09PSAzXG4gICAgdGhpcy50YWdOYW1lID0gZG9tLnRhZ05hbWVcbiAgICB0aGlzLmNsYXNzTmFtZSA9IGRvbS5jbGFzc05hbWVcbiAgICB0aGlzLnRleHREYXRhID0gZG9tLmRhdGFcbiAgICB0aGlzLmRpZmZIYXNoID0ge31cblxuICAgIGlmICh0aGlzLmlzVGV4dCkge1xuICAgICAgdGhpcy5zaXplID0gMVxuICAgIH0gZWxzZSB7XG4gICAgICA7KHsgcmVwIH0gPSB0aGlzKVxuICAgICAgdGhpcy5jaGlsZHJlbiA9IFtdLm1hcC5jYWxsKFxuICAgICAgICB0aGlzLmRvbS5jaGlsZE5vZGVzLFxuICAgICAgICAoZG9tLCBpbmQpID0+XG4gICAgICAgICAgbmV3IFdyYXBwZWREb21UcmVlKGRvbSwgZmFsc2UsIHJlcCA/IHJlcC5jaGlsZHJlbltpbmRdIDogbnVsbCksXG4gICAgICApXG4gICAgICB0aGlzLnNpemUgPSB0aGlzLmNoaWxkcmVuLmxlbmd0aFxuICAgICAgICA/IHRoaXMuY2hpbGRyZW4ucmVkdWNlKChwcmV2LCBjdXIpID0+IHByZXYgKyBjdXIuc2l6ZSwgMClcbiAgICAgICAgOiAwXG4gICAgICBpZiAoIXRoaXMuc2l6ZSkge1xuICAgICAgICB0aGlzLnNpemUgPSAxXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLy8gQHBhcmFtIG90aGVyVHJlZSBXcmFwcGVkRG9tVHJlZSBvZiBhIERPTSBlbGVtZW50IHRvIGRpZmYgYWdhaW5zdFxuICBkaWZmVG8ob3RoZXJUcmVlKSB7XG4gICAgaWYgKHRoaXMuY2xvbmUpIHtcbiAgICAgIHJldHVybiB0aGlzLnNob3duVHJlZS5kaWZmVG8ob3RoZXJUcmVlKVxuICAgIH1cblxuICAgIGNvbnN0IGRpZmYgPSB0aGlzLnJlcC5kaWZmKG90aGVyVHJlZSlcbiAgICBjb25zdCB7IHNjb3JlIH0gPSBkaWZmXG4gICAgY29uc3QgeyBvcGVyYXRpb25zIH0gPSBkaWZmXG4gICAgbGV0IGluZGV4U2hpZnQgPSAwXG4gICAgbGV0IGluc2VydGVkID0gW11cblxuICAgIC8vIEZvcmNlIHZhcmlhYmxlcyB0byBsZWFrIHRvIGRpZmZUbyBzY29wZVxuICAgIGxldCBbXG4gICAgICBsYXN0LFxuICAgICAgcG9zc2libGVSZXBsYWNlLFxuICAgICAgcixcbiAgICAgIGxhc3RPcCxcbiAgICAgIGxhc3RFbG1EZWxldGVkLFxuICAgICAgbGFzdEVsbUluc2VydGVkLFxuICAgIF0gPSBBcnJheS5mcm9tKFtdKVxuXG4gICAgaWYgKG9wZXJhdGlvbnMpIHtcbiAgICAgIGlmIChvcGVyYXRpb25zIGluc3RhbmNlb2YgQXJyYXkpIHtcbiAgICAgICAgZm9yIChsZXQgb3Agb2YgQXJyYXkuZnJvbShvcGVyYXRpb25zKSkge1xuICAgICAgICAgIDsoKG9wKSA9PiB7XG4gICAgICAgICAgICBpZiAob3AudHlwZSA9PT0gJ2QnKSB7XG4gICAgICAgICAgICAgIGNvbnN0IHBvc3NpYmxlTGFzdERlbGV0ZWQgPSB0aGlzLmNoaWxkcmVuW29wLnRyZWUgKyBpbmRleFNoaWZ0XVxuICAgICAgICAgICAgICAgIC5kb21cbiAgICAgICAgICAgICAgciA9IHRoaXMucmVtb3ZlKG9wLnRyZWUgKyBpbmRleFNoaWZ0KVxuICAgICAgICAgICAgICB0aGlzLnJlcC5yZW1vdmUob3AudHJlZSArIGluZGV4U2hpZnQpXG4gICAgICAgICAgICAgIGlmICghbGFzdCB8fCBsYXN0Lm5leHRTaWJsaW5nID09PSByIHx8IGxhc3QgPT09IHIpIHtcbiAgICAgICAgICAgICAgICBsYXN0ID0gclxuICAgICAgICAgICAgICAgIC8vIFVuZGVmaW5lZCBlcnJvcnMgY2FuIGJlIHRocm93IHNvIHdlIGFkZCBhIGNvbmRpdGlvbiBvbiBsYXN0T3BcbiAgICAgICAgICAgICAgICAvLyBiZWluZyBkZWZpbmVkXG4gICAgICAgICAgICAgICAgaWYgKGxhc3QgJiYgbGFzdE9wICYmIG9wLnRyZWUgPT09IGxhc3RPcC5wb3MpIHtcbiAgICAgICAgICAgICAgICAgIGxhc3RFbG1EZWxldGVkID0gcG9zc2libGVMYXN0RGVsZXRlZFxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICBsYXN0RWxtRGVsZXRlZCA9IG51bGxcbiAgICAgICAgICAgICAgICAgIGxhc3RFbG1JbnNlcnRlZCA9IG51bGxcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbGFzdE9wID0gb3BcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBpbmRleFNoaWZ0LS1cbiAgICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgICB9IGVsc2UgaWYgKG9wLnR5cGUgPT09ICdpJykge1xuICAgICAgICAgICAgICB0aGlzLnJlcC5pbnNlcnQoXG4gICAgICAgICAgICAgICAgb3AucG9zICsgaW5kZXhTaGlmdCxcbiAgICAgICAgICAgICAgICBvdGhlclRyZWUuY2hpbGRyZW5bb3Aub3RoZXJUcmVlXSxcbiAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICByID0gdGhpcy5pbnNlcnQoXG4gICAgICAgICAgICAgICAgb3AucG9zICsgaW5kZXhTaGlmdCxcbiAgICAgICAgICAgICAgICBvdGhlclRyZWUuY2hpbGRyZW5bb3Aub3RoZXJUcmVlXSxcbiAgICAgICAgICAgICAgICB0aGlzLnJlcC5jaGlsZHJlbltvcC5wb3MgKyBpbmRleFNoaWZ0XSxcbiAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICBpbnNlcnRlZC5wdXNoKHIpXG4gICAgICAgICAgICAgIGlmICghbGFzdCB8fCBsYXN0Lm5leHRTaWJsaW5nID09PSByKSB7XG4gICAgICAgICAgICAgICAgbGFzdCA9IHJcbiAgICAgICAgICAgICAgICBsYXN0T3AgPSBvcFxuICAgICAgICAgICAgICAgIGxhc3RFbG1JbnNlcnRlZCA9IHJcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBpbmRleFNoaWZ0KytcbiAgICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBjb25zdCByZSA9IHRoaXMuY2hpbGRyZW5bb3AudHJlZSArIGluZGV4U2hpZnRdLmRpZmZUbyhcbiAgICAgICAgICAgICAgICBvdGhlclRyZWUuY2hpbGRyZW5bb3Aub3RoZXJUcmVlXSxcbiAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICAgIWxhc3QgfHxcbiAgICAgICAgICAgICAgICAobGFzdC5uZXh0U2libGluZyA9PT0gdGhpcy5jaGlsZHJlbltvcC50cmVlICsgaW5kZXhTaGlmdF0uZG9tICYmXG4gICAgICAgICAgICAgICAgICByZS5sYXN0KVxuICAgICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICA7KHsgbGFzdCB9ID0gcmUpXG4gICAgICAgICAgICAgICAgaWYgKHJlLnBvc3NpYmxlUmVwbGFjZSkge1xuICAgICAgICAgICAgICAgICAgbGFzdEVsbUluc2VydGVkID0gcmUucG9zc2libGVSZXBsYWNlLmN1clxuICAgICAgICAgICAgICAgICAgbGFzdEVsbURlbGV0ZWQgPSByZS5wb3NzaWJsZVJlcGxhY2UucHJldlxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBsYXN0T3AgPSBvcFxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGluc2VydGVkID0gaW5zZXJ0ZWQuY29uY2F0KHJlLmluc2VydGVkKVxuICAgICAgICAgICAgICByZXR1cm5cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KShvcClcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc29sZS5sb2cob3BlcmF0aW9ucylcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdpbnZhbGlkIG9wZXJhdGlvbnMnKVxuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChsYXN0T3AgJiYgbGFzdE9wLnR5cGUgIT09ICdpJyAmJiBsYXN0RWxtSW5zZXJ0ZWQgJiYgbGFzdEVsbURlbGV0ZWQpIHtcbiAgICAgIHBvc3NpYmxlUmVwbGFjZSA9IHtcbiAgICAgICAgY3VyOiBsYXN0RWxtSW5zZXJ0ZWQsXG4gICAgICAgIHByZXY6IGxhc3RFbG1EZWxldGVkLFxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBsYXN0LFxuICAgICAgaW5zZXJ0ZWQsXG4gICAgICBwb3NzaWJsZVJlcGxhY2UsXG4gICAgfVxuICB9XG5cbiAgaW5zZXJ0KGksIHRyZWUsIHJlcCkge1xuICAgIGNvbnN0IGRvbSA9IHRyZWUuZG9tLmNsb25lTm9kZSh0cnVlKVxuICAgIGlmIChpID09PSB0aGlzLmRvbS5jaGlsZE5vZGVzLmxlbmd0aCkge1xuICAgICAgdGhpcy5kb20uYXBwZW5kQ2hpbGQoZG9tKVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmRvbS5pbnNlcnRCZWZvcmUoZG9tLCB0aGlzLmRvbS5jaGlsZE5vZGVzW2ldKVxuICAgIH1cblxuICAgIGNvbnN0IGN0cmVlID0gbmV3IFdyYXBwZWREb21UcmVlKGRvbSwgZmFsc2UsIHJlcClcbiAgICB0aGlzLmNoaWxkcmVuLnNwbGljZShpLCAwLCBjdHJlZSlcbiAgICByZXR1cm4gdGhpcy5kb20uY2hpbGROb2Rlc1tpXVxuICB9XG5cbiAgcmVtb3ZlKGkpIHtcbiAgICB0aGlzLmRvbS5yZW1vdmVDaGlsZCh0aGlzLmRvbS5jaGlsZE5vZGVzW2ldKVxuICAgIHRoaXMuY2hpbGRyZW5baV0ucmVtb3ZlU2VsZigpXG4gICAgdGhpcy5jaGlsZHJlbi5zcGxpY2UoaSwgMSlcbiAgICByZXR1cm4gdGhpcy5kb20uY2hpbGROb2Rlc1tpIC0gMV1cbiAgfVxuXG4gIGRpZmYob3RoZXJUcmVlLCB0bWF4KSB7XG4gICAgbGV0IGlcbiAgICBpZiAodGhpcy5lcXVhbFRvKG90aGVyVHJlZSkpIHtcbiAgICAgIHJldHVybiB7IHNjb3JlOiAwLCBvcGVyYXRpb25zOiBudWxsIH1cbiAgICB9XG5cbiAgICBpZiAodGhpcy5jYW5ub3RSZXBsYWNlV2l0aChvdGhlclRyZWUpKSB7XG4gICAgICByZXR1cm4geyBzY29yZTogMSAvIDAsIG9wZXJhdGlvbnM6IG51bGwgfVxuICAgIH1cblxuICAgIGNvbnN0IGtleSA9IG90aGVyVHJlZS5oYXNoXG4gICAgaWYgKEFycmF5LmZyb20odGhpcy5kaWZmSGFzaCkuaW5jbHVkZXMoa2V5KSkge1xuICAgICAgcmV0dXJuIHRoaXMuZGlmZkhhc2hba2V5XVxuICAgIH1cblxuICAgIGlmICh0bWF4ID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHRtYXggPSAxMDAwMDBcbiAgICB9XG4gICAgaWYgKHRtYXggPD0gMCkge1xuICAgICAgcmV0dXJuIDBcbiAgICB9XG5cbiAgICBsZXQgb2Zmc2V0ID0gMFxuICAgIGNvbnN0IGZvcndhcmRTZWFyY2ggPSAob2Zmc2V0KSA9PiB7XG4gICAgICByZXR1cm4gKFxuICAgICAgICBvZmZzZXQgPCB0aGlzLmNoaWxkcmVuLmxlbmd0aCAmJlxuICAgICAgICBvZmZzZXQgPCBvdGhlclRyZWUuY2hpbGRyZW4ubGVuZ3RoICYmXG4gICAgICAgIHRoaXMuY2hpbGRyZW5bb2Zmc2V0XS5lcXVhbFRvKG90aGVyVHJlZS5jaGlsZHJlbltvZmZzZXRdKVxuICAgICAgKVxuICAgIH1cbiAgICB3aGlsZSAoZm9yd2FyZFNlYXJjaChvZmZzZXQpKSB7XG4gICAgICBvZmZzZXQrK1xuICAgIH1cblxuICAgIGNvbnN0IGRwID0gbmV3IFR3b0RpbUFycmF5KFxuICAgICAgdGhpcy5jaGlsZHJlbi5sZW5ndGggKyAxIC0gb2Zmc2V0LFxuICAgICAgb3RoZXJUcmVlLmNoaWxkcmVuLmxlbmd0aCArIDEgLSBvZmZzZXQsXG4gICAgKVxuICAgIGNvbnN0IHAgPSBuZXcgVHdvRGltQXJyYXkoXG4gICAgICB0aGlzLmNoaWxkcmVuLmxlbmd0aCArIDEgLSBvZmZzZXQsXG4gICAgICBvdGhlclRyZWUuY2hpbGRyZW4ubGVuZ3RoICsgMSAtIG9mZnNldCxcbiAgICApXG4gICAgZHAuc2V0KDAsIDAsIDApXG5cbiAgICBsZXQgc3VtID0gMFxuICAgIC8vIEJlY2F1c2UgY29mZmVzY3JpcHRzIGFsbG93cyBiaWRlcmN0aW9uYWwgbG9vcHMgd2UgbmVlZCB0aGlzIGNvbmRpdGlvblxuICAgIC8vIGdhdXJkIHRvIHByZXZlbnQgYSBkZWNyZWFzaW5nIGFycmF5IGxpc3RcbiAgICBpZiAob3RoZXJUcmVlLmNoaWxkcmVuLmxlbmd0aCAtIG9mZnNldCA+IDEpIHtcbiAgICAgIGxldCBhc2MsIGVuZFxuICAgICAgZm9yIChcbiAgICAgICAgaSA9IDEsIGVuZCA9IG90aGVyVHJlZS5jaGlsZHJlbi5sZW5ndGggLSBvZmZzZXQgLSAxLCBhc2MgPSAxIDw9IGVuZDtcbiAgICAgICAgYXNjID8gaSA8PSBlbmQgOiBpID49IGVuZDtcbiAgICAgICAgYXNjID8gaSsrIDogaS0tXG4gICAgICApIHtcbiAgICAgICAgZHAuc2V0KDAsIGksIHN1bSlcbiAgICAgICAgcC5zZXQoMCwgaSwgaSAtIDEpXG4gICAgICAgIHN1bSArPSBvdGhlclRyZWUuY2hpbGRyZW5baSArIG9mZnNldF0uc2l6ZVxuICAgICAgfVxuICAgIH1cbiAgICBpZiAob3RoZXJUcmVlLmNoaWxkcmVuLmxlbmd0aCAtIG9mZnNldCA+IDApIHtcbiAgICAgIGRwLnNldCgwLCBvdGhlclRyZWUuY2hpbGRyZW4ubGVuZ3RoIC0gb2Zmc2V0LCBzdW0pXG4gICAgICBwLnNldChcbiAgICAgICAgMCxcbiAgICAgICAgb3RoZXJUcmVlLmNoaWxkcmVuLmxlbmd0aCAtIG9mZnNldCxcbiAgICAgICAgb3RoZXJUcmVlLmNoaWxkcmVuLmxlbmd0aCAtIDEgLSBvZmZzZXQsXG4gICAgICApXG4gICAgfVxuXG4gICAgc3VtID0gMFxuICAgIC8vIEJlY2F1c2UgY29mZmVzY3JpcHRzIGFsbG93cyBiaWRlcmN0aW9uYWwgbG9vcHMgd2UgbmVlZCB0aGlzIGNvbmRpdGlvblxuICAgIC8vIGdhdXJkIHRvIHByZXZlbnQgYSBkZWNyZWFzaW5nIGFycmF5IGxpc3RcbiAgICBpZiAodGhpcy5jaGlsZHJlbi5sZW5ndGggLSBvZmZzZXQgPiAxKSB7XG4gICAgICBsZXQgYXNjMSwgZW5kMVxuICAgICAgZm9yIChcbiAgICAgICAgaSA9IDEsIGVuZDEgPSB0aGlzLmNoaWxkcmVuLmxlbmd0aCAtIG9mZnNldCAtIDEsIGFzYzEgPSAxIDw9IGVuZDE7XG4gICAgICAgIGFzYzEgPyBpIDw9IGVuZDEgOiBpID49IGVuZDE7XG4gICAgICAgIGFzYzEgPyBpKysgOiBpLS1cbiAgICAgICkge1xuICAgICAgICBkcC5zZXQoaSwgMCwgc3VtKVxuICAgICAgICBwLnNldChpLCAwLCAoaSAtIDEpICogcC5jb2wpXG4gICAgICAgIHN1bSArPSB0aGlzLmNoaWxkcmVuW2kgKyBvZmZzZXRdLnNpemVcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHRoaXMuY2hpbGRyZW4ubGVuZ3RoIC0gb2Zmc2V0KSB7XG4gICAgICBkcC5zZXQodGhpcy5jaGlsZHJlbi5sZW5ndGggLSBvZmZzZXQsIDAsIHN1bSlcbiAgICAgIHAuc2V0KFxuICAgICAgICB0aGlzLmNoaWxkcmVuLmxlbmd0aCAtIG9mZnNldCxcbiAgICAgICAgMCxcbiAgICAgICAgKHRoaXMuY2hpbGRyZW4ubGVuZ3RoIC0gMSAtIG9mZnNldCkgKiBwLmNvbCxcbiAgICAgIClcbiAgICB9XG5cbiAgICB2YXIgZ2V0U2NvcmUgPSAoaSwgaiwgbWF4KSA9PiB7XG4gICAgICBpZiAoZHAuZ2V0KGksIGopICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgcmV0dXJuIGRwLmdldChpLCBqKVxuICAgICAgfVxuICAgICAgaWYgKG1heCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIG1heCA9IDEgLyAwXG4gICAgICB9XG4gICAgICBpZiAobWF4IDw9IDApIHtcbiAgICAgICAgcmV0dXJuIDEgLyAwXG4gICAgICB9XG5cbiAgICAgIGxldCB2YWwgPSBtYXhcbiAgICAgIGNvbnN0IGJvdW5kID0gbWF4XG4gICAgICBjb25zdCBzdWJkaWZmID0gdGhpcy5jaGlsZHJlbltpIC0gMSArIG9mZnNldF0uZGlmZihcbiAgICAgICAgb3RoZXJUcmVlLmNoaWxkcmVuW2ogLSAxICsgb2Zmc2V0XSxcbiAgICAgICAgYm91bmQsXG4gICAgICApLnNjb3JlXG4gICAgICBsZXQgZm9yY2UgPSBmYWxzZVxuICAgICAgaWYgKFxuICAgICAgICBzdWJkaWZmIDwgYm91bmQgJiZcbiAgICAgICAgc3ViZGlmZiArIDEgPFxuICAgICAgICAgIHRoaXMuY2hpbGRyZW5baSAtIDEgKyBvZmZzZXRdLnNpemUgK1xuICAgICAgICAgICAgb3RoZXJUcmVlLmNoaWxkcmVuW2ogLSAxICsgb2Zmc2V0XS5zaXplXG4gICAgICApIHtcbiAgICAgICAgZm9yY2UgPSB0cnVlXG4gICAgICB9XG4gICAgICB2YWwgPSBnZXRTY29yZShpIC0gMSwgaiAtIDEsIGJvdW5kIC0gc3ViZGlmZikgKyBzdWJkaWZmXG4gICAgICBsZXQgcHJldiA9IHAuZ2V0SW5kKGkgLSAxLCBqIC0gMSlcblxuICAgICAgaWYgKCFmb3JjZSkge1xuICAgICAgICBsZXQgb3RoZXIgPVxuICAgICAgICAgIGdldFNjb3JlKFxuICAgICAgICAgICAgaSAtIDEsXG4gICAgICAgICAgICBqLFxuICAgICAgICAgICAgTWF0aC5taW4odmFsLCBtYXgpIC0gdGhpcy5jaGlsZHJlbltpIC0gMSArIG9mZnNldF0uc2l6ZSxcbiAgICAgICAgICApICsgdGhpcy5jaGlsZHJlbltpIC0gMSArIG9mZnNldF0uc2l6ZVxuICAgICAgICBpZiAob3RoZXIgPCB2YWwpIHtcbiAgICAgICAgICBwcmV2ID0gcC5nZXRJbmQoaSAtIDEsIGopXG4gICAgICAgICAgdmFsID0gb3RoZXJcbiAgICAgICAgfVxuXG4gICAgICAgIG90aGVyID1cbiAgICAgICAgICBnZXRTY29yZShcbiAgICAgICAgICAgIGksXG4gICAgICAgICAgICBqIC0gMSxcbiAgICAgICAgICAgIE1hdGgubWluKHZhbCwgbWF4KSAtIG90aGVyVHJlZS5jaGlsZHJlbltqIC0gMSArIG9mZnNldF0uc2l6ZSxcbiAgICAgICAgICApICsgb3RoZXJUcmVlLmNoaWxkcmVuW2ogLSAxICsgb2Zmc2V0XS5zaXplXG4gICAgICAgIGlmIChvdGhlciA8IHZhbCkge1xuICAgICAgICAgIHByZXYgPSBwLmdldEluZChpLCBqIC0gMSlcbiAgICAgICAgICB2YWwgPSBvdGhlclxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGlmICh2YWwgPj0gbWF4KSB7XG4gICAgICAgIHZhbCA9IDEgLyAwXG4gICAgICB9XG5cbiAgICAgIGRwLnNldChpLCBqLCB2YWwpXG4gICAgICBwLnNldChpLCBqLCBwcmV2KVxuICAgICAgcmV0dXJuIHZhbFxuICAgIH1cblxuICAgIGNvbnN0IHNjb3JlID0gZ2V0U2NvcmUoXG4gICAgICB0aGlzLmNoaWxkcmVuLmxlbmd0aCAtIG9mZnNldCxcbiAgICAgIG90aGVyVHJlZS5jaGlsZHJlbi5sZW5ndGggLSBvZmZzZXQsXG4gICAgICB0bWF4LFxuICAgIClcbiAgICBjb25zdCBvcGVyYXRpb25zID0gW11cblxuICAgIGxldCBjdXIgPSBwLmdldEluZChcbiAgICAgIHRoaXMuY2hpbGRyZW4ubGVuZ3RoIC0gb2Zmc2V0LFxuICAgICAgb3RoZXJUcmVlLmNoaWxkcmVuLmxlbmd0aCAtIG9mZnNldCxcbiAgICApXG4gICAgbGV0IGNyID0gdGhpcy5jaGlsZHJlbi5sZW5ndGggLSAxIC0gb2Zmc2V0XG4gICAgbGV0IGNjID0gb3RoZXJUcmVlLmNoaWxkcmVuLmxlbmd0aCAtIDEgLSBvZmZzZXRcblxuICAgIHdoaWxlIChwLnJhd0dldChjdXIpICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGNvbnN0IHByZXYgPSBwLnJhd0dldChjdXIpXG4gICAgICBjb25zdCByYyA9IHAuZ2V0MkRJbmQocHJldilcbiAgICAgIGNvbnN0IHByID0gcmMuciAtIDFcbiAgICAgIGNvbnN0IHBjID0gcmMuYyAtIDFcblxuICAgICAgaWYgKHByID09PSBjcikge1xuICAgICAgICBvcGVyYXRpb25zLnVuc2hpZnQoe1xuICAgICAgICAgIHR5cGU6ICdpJyxcbiAgICAgICAgICBvdGhlclRyZWU6IGNjICsgb2Zmc2V0LFxuICAgICAgICAgIHBvczogY3IgKyAxICsgb2Zmc2V0LFxuICAgICAgICB9KVxuICAgICAgfSBlbHNlIGlmIChwYyA9PT0gY2MpIHtcbiAgICAgICAgb3BlcmF0aW9ucy51bnNoaWZ0KHtcbiAgICAgICAgICB0eXBlOiAnZCcsXG4gICAgICAgICAgdHJlZTogY3IgKyBvZmZzZXQsXG4gICAgICAgIH0pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCBvcCA9IHRoaXMuY2hpbGRyZW5bY3IgKyBvZmZzZXRdLmRpZmYoXG4gICAgICAgICAgb3RoZXJUcmVlLmNoaWxkcmVuW2NjICsgb2Zmc2V0XSxcbiAgICAgICAgKS5vcGVyYXRpb25zXG4gICAgICAgIGlmIChvcCAmJiBvcC5sZW5ndGgpIHtcbiAgICAgICAgICBvcGVyYXRpb25zLnVuc2hpZnQoe1xuICAgICAgICAgICAgdHlwZTogJ3InLFxuICAgICAgICAgICAgdHJlZTogY3IgKyBvZmZzZXQsXG4gICAgICAgICAgICBvdGhlclRyZWU6IGNjICsgb2Zmc2V0LFxuICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGN1ciA9IHByZXZcbiAgICAgIGNyID0gcHJcbiAgICAgIGNjID0gcGNcbiAgICB9XG5cbiAgICB0aGlzLmRpZmZIYXNoW2tleV0gPSB7XG4gICAgICBzY29yZSxcbiAgICAgIG9wZXJhdGlvbnMsXG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuZGlmZkhhc2hba2V5XVxuICB9XG5cbiAgZXF1YWxUbyhvdGhlclRyZWUpIHtcbiAgICByZXR1cm4gdGhpcy5kb20uaXNFcXVhbE5vZGUob3RoZXJUcmVlLmRvbSlcbiAgfVxuXG4gIGNhbm5vdFJlcGxhY2VXaXRoKG90aGVyVHJlZSkge1xuICAgIHJldHVybiAoXG4gICAgICB0aGlzLmlzVGV4dCB8fFxuICAgICAgb3RoZXJUcmVlLmlzVGV4dCB8fFxuICAgICAgdGhpcy50YWdOYW1lICE9PSBvdGhlclRyZWUudGFnTmFtZSB8fFxuICAgICAgdGhpcy5jbGFzc05hbWUgIT09IG90aGVyVHJlZS5jbGFzc05hbWUgfHxcbiAgICAgIHRoaXMuY2xhc3NOYW1lID09PSAnbWF0aCcgfHxcbiAgICAgIHRoaXMuY2xhc3NOYW1lID09PSAnYXRvbS10ZXh0LWVkaXRvcicgfHxcbiAgICAgIHRoaXMudGFnTmFtZSA9PT0gJ0EnIHx8XG4gICAgICAodGhpcy50YWdOYW1lID09PSAnSU1HJyAmJiAhdGhpcy5kb20uaXNFcXVhbE5vZGUob3RoZXJUcmVlLmRvbSkpXG4gICAgKVxuICB9XG5cbiAgZ2V0Q29udGVudCgpIHtcbiAgICBpZiAodGhpcy5kb20ub3V0ZXJIVE1MKSB7XG4gICAgICByZXR1cm4gdGhpcy5kb20ub3V0ZXJIVE1MXG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB0aGlzLnRleHREYXRhXG4gICAgfVxuICB9XG5cbiAgcmVtb3ZlU2VsZigpIHtcbiAgICBoYXNoVG9bdGhpcy5oYXNoXSA9IG51bGxcbiAgICB0aGlzLmNoaWxkcmVuICYmIHRoaXMuY2hpbGRyZW4uZm9yRWFjaCgoYykgPT4gYy5yZW1vdmVTZWxmKCkpXG4gIH1cbn1cbiJdfQ==