"use strict";
let WrappedDomTree;
const TwoDimArray = require('./two-dim-array');
let curHash = 0;
const hashTo = {};
module.exports = (WrappedDomTree = class WrappedDomTree {
    constructor(dom, clone, rep) {
        if (clone) {
            this.shownTree = new WrappedDomTree(dom, false, this);
            this.dom = dom.cloneNode(true);
        }
        else {
            this.dom = dom;
            this.rep = rep;
        }
        this.clone = clone;
        this.hash = curHash++;
        hashTo[this.hash] = this;
        this.isText = dom.nodeType === 3;
        this.tagName = dom.tagName;
        this.className = dom.className;
        this.textData = dom.data;
        this.diffHash = {};
        if (this.isText) {
            this.size = 1;
        }
        else {
            ({ rep } = this);
            this.children = [].map.call(this.dom.childNodes, (dom, ind) => new WrappedDomTree(dom, false, rep ? rep.children[ind] : null));
            this.size = this.children.length ? this.children.reduce(((prev, cur) => prev + cur.size), 0) : 0;
            if (!this.size) {
                this.size = 1;
            }
        }
    }
    diffTo(otherTree) {
        if (this.clone) {
            return this.shownTree.diffTo(otherTree);
        }
        const diff = this.rep.diff(otherTree);
        const { score } = diff;
        const { operations } = diff;
        let indexShift = 0;
        let inserted = [];
        let [last, possibleReplace, r, lastOp, lastElmDeleted, lastElmInserted] = Array.from([]);
        if (operations) {
            if (operations instanceof Array) {
                for (let op of Array.from(operations)) {
                    (op => {
                        if (op.type === "d") {
                            const possibleLastDeleted = this.children[op.tree + indexShift].dom;
                            r = this.remove(op.tree + indexShift);
                            this.rep.remove(op.tree + indexShift);
                            if (!last || (last.nextSibling === r) || (last === r)) {
                                last = r;
                                if (last && lastOp && (op.tree === lastOp.pos)) {
                                    lastElmDeleted = possibleLastDeleted;
                                }
                                else {
                                    lastElmDeleted = null;
                                    lastElmInserted = null;
                                }
                                lastOp = op;
                            }
                            indexShift--;
                            return;
                        }
                        else if (op.type === "i") {
                            this.rep.insert(op.pos + indexShift, otherTree.children[op.otherTree]);
                            r = this.insert(op.pos + indexShift, otherTree.children[op.otherTree], this.rep.children[op.pos + indexShift]);
                            inserted.push(r);
                            if (!last || (last.nextSibling === r)) {
                                last = r;
                                lastOp = op;
                                lastElmInserted = r;
                            }
                            indexShift++;
                            return;
                        }
                        else {
                            const re = this.children[op.tree + indexShift].diffTo(otherTree.children[op.otherTree]);
                            if (!last || ((last.nextSibling === this.children[op.tree + indexShift].dom) && re.last)) {
                                ({ last } = re);
                                if (re.possibleReplace) {
                                    lastElmInserted = re.possibleReplace.cur;
                                    lastElmDeleted = re.possibleReplace.prev;
                                }
                                lastOp = op;
                            }
                            inserted = inserted.concat(re.inserted);
                            return;
                        }
                    })(op);
                }
            }
            else {
                console.log(operations);
                throw new Error("invalid operations");
            }
        }
        if (lastOp && (lastOp.type !== 'i') && lastElmInserted && lastElmDeleted) {
            possibleReplace = {
                cur: lastElmInserted,
                prev: lastElmDeleted
            };
        }
        return {
            last,
            inserted,
            possibleReplace
        };
    }
    insert(i, tree, rep) {
        const dom = tree.dom.cloneNode(true);
        if (i === this.dom.childNodes.length) {
            this.dom.appendChild(dom);
        }
        else {
            this.dom.insertBefore(dom, this.dom.childNodes[i]);
        }
        const ctree = new WrappedDomTree(dom, false, rep);
        this.children.splice(i, 0, ctree);
        return this.dom.childNodes[i];
    }
    remove(i) {
        this.dom.removeChild(this.dom.childNodes[i]);
        this.children[i].removeSelf();
        this.children.splice(i, 1);
        return this.dom.childNodes[i - 1];
    }
    diff(otherTree, tmax) {
        let i;
        if (this.equalTo(otherTree)) {
            return { score: 0, operations: null };
        }
        if (this.cannotReplaceWith(otherTree)) {
            return { score: 1 / 0, operations: null };
        }
        const key = otherTree.hash;
        if (Array.from(this.diffHash).includes(key)) {
            return this.diffHash[key];
        }
        if (tmax === undefined) {
            tmax = 100000;
        }
        if (tmax <= 0) {
            return 0;
        }
        let offset = 0;
        const forwardSearch = offset => {
            return (offset < this.children.length) &&
                (offset < otherTree.children.length) &&
                this.children[offset].equalTo(otherTree.children[offset]);
        };
        while (forwardSearch(offset)) {
            offset++;
        }
        const dp = new TwoDimArray((this.children.length + 1) - offset, (otherTree.children.length + 1) - offset);
        const p = new TwoDimArray((this.children.length + 1) - offset, (otherTree.children.length + 1) - offset);
        dp.set(0, 0, 0);
        let sum = 0;
        if ((otherTree.children.length - offset) > 1) {
            let asc, end;
            for (i = 1, end = otherTree.children.length - offset - 1, asc = 1 <= end; asc ? i <= end : i >= end; asc ? i++ : i--) {
                dp.set(0, i, sum);
                p.set(0, i, i - 1);
                sum += otherTree.children[i + offset].size;
            }
        }
        if ((otherTree.children.length - offset) > 0) {
            dp.set(0, otherTree.children.length - offset, sum);
            p.set(0, otherTree.children.length - offset, otherTree.children.length - 1 - offset);
        }
        sum = 0;
        if ((this.children.length - offset) > 1) {
            let asc1, end1;
            for (i = 1, end1 = this.children.length - offset - 1, asc1 = 1 <= end1; asc1 ? i <= end1 : i >= end1; asc1 ? i++ : i--) {
                dp.set(i, 0, sum);
                p.set(i, 0, (i - 1) * p.col);
                sum += this.children[i + offset].size;
            }
        }
        if (this.children.length - offset) {
            dp.set(this.children.length - offset, 0, sum);
            p.set(this.children.length - offset, 0, (this.children.length - 1 - offset) * p.col);
        }
        var getScore = (i, j, max) => {
            if (dp.get(i, j) !== undefined) {
                return dp.get(i, j);
            }
            if (max === undefined) {
                max = 1 / 0;
            }
            if (max <= 0) {
                return 1 / 0;
            }
            let val = max;
            const bound = max;
            const subdiff = this.children[(i - 1) + offset].diff(otherTree.children[(j - 1) + offset], bound).score;
            let force = false;
            if ((subdiff < bound) && ((subdiff + 1) < (this.children[(i - 1) + offset].size + otherTree.children[(j - 1) + offset].size))) {
                force = true;
            }
            val = getScore(i - 1, j - 1, bound - subdiff) + subdiff;
            let prev = p.getInd(i - 1, j - 1);
            if (!force) {
                let other = getScore(i - 1, j, Math.min(val, max) - this.children[(i - 1) + offset].size) + this.children[(i - 1) + offset].size;
                if (other < val) {
                    prev = p.getInd(i - 1, j);
                    val = other;
                }
                other = getScore(i, j - 1, Math.min(val, max) - otherTree.children[(j - 1) + offset].size) + otherTree.children[(j - 1) + offset].size;
                if (other < val) {
                    prev = p.getInd(i, j - 1);
                    val = other;
                }
            }
            if (val >= max) {
                val = 1 / 0;
            }
            dp.set(i, j, val);
            p.set(i, j, prev);
            return val;
        };
        const score = getScore(this.children.length - offset, otherTree.children.length - offset, tmax);
        const operations = [];
        let cur = p.getInd(this.children.length - offset, otherTree.children.length - offset);
        let cr = this.children.length - 1 - offset;
        let cc = otherTree.children.length - 1 - offset;
        while (p.rawGet(cur) !== undefined) {
            const prev = p.rawGet(cur);
            const rc = p.get2DInd(prev);
            const pr = rc.r - 1;
            const pc = rc.c - 1;
            if (pr === cr) {
                operations.unshift({
                    type: "i",
                    otherTree: cc + offset,
                    pos: cr + 1 + offset
                });
            }
            else if (pc === cc) {
                operations.unshift({
                    type: "d",
                    tree: cr + offset
                });
            }
            else {
                const op = this.children[cr + offset].diff(otherTree.children[cc + offset]).operations;
                if (op && op.length) {
                    operations.unshift({
                        type: "r",
                        tree: cr + offset,
                        otherTree: cc + offset
                    });
                }
            }
            cur = prev;
            cr = pr;
            cc = pc;
        }
        this.diffHash[key] = {
            score,
            operations
        };
        return this.diffHash[key];
    }
    equalTo(otherTree) {
        return this.dom.isEqualNode(otherTree.dom);
    }
    cannotReplaceWith(otherTree) {
        return this.isText ||
            otherTree.isText ||
            (this.tagName !== otherTree.tagName) ||
            (this.className !== otherTree.className) ||
            (this.className === "math") ||
            (this.className === "atom-text-editor") ||
            (this.tagName === "A") ||
            ((this.tagName === "IMG") && !this.dom.isEqualNode(otherTree.dom));
    }
    getContent() {
        if (this.dom.outerHTML) {
            return this.dom.outerHTML;
        }
        else {
            return this.textData;
        }
    }
    removeSelf() {
        hashTo[this.hash] = null;
        this.children && this.children.forEach(c => c.removeSelf());
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid3JhcHBlZC1kb20tdHJlZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy93cmFwcGVkLWRvbS10cmVlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQTZCQSxZQUFZLENBQUM7QUFFYixJQUFJLGNBQWMsQ0FBQztBQUNuQixNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsaUJBQWlCLENBQUMsQ0FBQztBQUUvQyxJQUFJLE9BQU8sR0FBRyxDQUFDLENBQUM7QUFDaEIsTUFBTSxNQUFNLEdBQUksRUFBRSxDQUFDO0FBRW5CLE1BQU0sQ0FBQyxPQUFPLEdBQUcsQ0FBQyxjQUFjLEdBQUc7SUFLakMsWUFBWSxHQUFHLEVBQUUsS0FBSyxFQUFFLEdBQUc7UUFDekIsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUNWLElBQUksQ0FBQyxTQUFTLEdBQUksSUFBSSxjQUFjLENBQUMsR0FBRyxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztZQUN2RCxJQUFJLENBQUMsR0FBRyxHQUFVLEdBQUcsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDeEMsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ04sSUFBSSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUM7WUFDZixJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQztRQUNqQixDQUFDO1FBRUQsSUFBSSxDQUFDLEtBQUssR0FBVSxLQUFLLENBQUM7UUFDMUIsSUFBSSxDQUFDLElBQUksR0FBVyxPQUFPLEVBQUUsQ0FBQztRQUM5QixNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQztRQUN6QixJQUFJLENBQUMsTUFBTSxHQUFTLEdBQUcsQ0FBQyxRQUFRLEtBQUssQ0FBQyxDQUFDO1FBQ3ZDLElBQUksQ0FBQyxPQUFPLEdBQVEsR0FBRyxDQUFDLE9BQU8sQ0FBQztRQUNoQyxJQUFJLENBQUMsU0FBUyxHQUFNLEdBQUcsQ0FBQyxT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QUUsR0FBRyxDQUFDLENBQUM7WUFDOUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sR0FBRyxNQUFNLEVBQUUsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxHQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNyRixDQUFDO1FBRUQsSUFBSSxRQUFRLEdBQUcsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxFQUFFO1lBQzNCLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUM7Z0JBQy9CLE1BQU0sQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUN0QixDQUFDO1lBQ0QsRUFBRSxDQUFDLENBQUMsR0FBRyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3RCLEdBQUcsR0FBRyxDQUFDLEdBQUMsQ0FBQyxDQUFDO1lBQ1osQ0FBQztZQUNELEVBQUUsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNiLE1BQU0sQ0FBQyxDQUFDLEdBQUMsQ0FBQyxDQUFDO1lBQ2IsQ0FBQztZQUVELElBQUksR0FBRyxHQUFPLEdBQUcsQ0FBQztZQUNsQixNQUFNLEtBQUssR0FBSyxHQUFHLENBQUM7WUFDcEIsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUUsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQyxLQUFLLENBQUM7WUFDekcsSUFBSSxLQUFLLEdBQUssS0FBSyxDQUFDO1lBQ3BCLEVBQUUsQ0FBQyxDQUFD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SUFBSSxDQUFDLFNBQVMsS0FBSyxrQkFBa0IsQ0FBQztZQUN2QyxDQUFDLElBQUksQ0FBQyxPQUFPLEtBQUssR0FBRyxDQUFDO1lBQ3RCLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxLQUFLLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDckUsQ0FBQztJQUVELFVBQVU7UUFDUixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDdkIsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDO1FBQzVCLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDO1FBQ3ZCLENBQUM7SUFDSCxDQUFDO0lBRUQsVUFBVTtRQUNSLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDO1FBQ3pCLElBQUksQ0FBQyxRQUFRLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQztJQUM5RCxDQUFDO0NBQ0YsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIGRlY2FmZmVpbmF0ZSBzdWdnZXN0aW9uczpcbiAqIERTMTAxOiBSZW1vdmUgdW5uZWNlc3NhcnkgdXNlIG9mIEFycmF5LmZyb21cbiAqIERTMTAyOiBSZW1vdmUgdW5uZWNlc3NhcnkgY29kZSBjcmVhdGVkIGJlY2F1c2Ugb2YgaW1wbGljaXQgcmV0dXJuc1xuICogRFMyMDI6IFNpbXBsaWZ5IGR5bmFtaWMgcmFuZ2UgbG9vcHNcbiAqIEZ1bGwgZG9jczogaHR0cHM6Ly9naXRodWIuY29tL2RlY2FmZmVpbmF0ZS9kZWNhZmZlaW5hdGUvYmxvYi9tYXN0ZXIvZG9jcy9zdWdnZXN0aW9ucy5tZFxuICovXG4vLyBUaGlzIGZpbGUgaW5jb3Jwb3JhdGVzIGNvZGUgZnJvbSBbbWFya21vbl0oaHR0cHM6Ly9naXRodWIuY29tL3l5amhhby9tYXJrbW9uKVxuLy8gY292ZXJlZCBieSB0aGUgZm9sbG93aW5nIHRlcm1zOlxuLy9cbi8vIENvcHlyaWdodCAoYykgMjAxNCwgWWFvIFl1amlhbiwgaHR0cDovL3lqeWFvLmNvbVxuLy9cbi8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcbi8vIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlIFwiU29mdHdhcmVcIiksIHRvIGRlYWxcbi8vIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHNcbi8vIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGxcbi8vIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpc1xuLy8gZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczpcbi8vXG4vLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpblxuLy8gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuXG4vL1xuLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEIFwiQVMgSVNcIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUlxuLy8gSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksXG4vLyBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEVcbi8vIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVJcbi8vIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sXG4vLyBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOXG4vLyBUSEUgU09GVFdBUkUuXG5cInVzZSBzdHJpY3RcIjtcblxubGV0IFdyYXBwZWREb21UcmVlO1xuY29uc3QgVHdvRGltQXJyYXkgPSByZXF1aXJlKCcuL3R3by1kaW0tYXJyYXknKTtcblxubGV0IGN1ckhhc2ggPSAwO1xuY29uc3QgaGFzaFRvICA9IHt9O1xuXG5tb2R1bGUuZXhwb3J0cyA9IChXcmFwcGVkRG9tVHJlZSA9IGNsYXNzIFdyYXBwZWREb21UcmVlIHtcbiAgLy8gQHBhcmFtIGRvbSBBIERPTSBlbGVtZW50IG9iamVjdFxuICAvLyAgICBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvZWxlbWVudFxuICAvLyBAcGFyYW0gY2xvbmUgQm9vbGVhbiBmbGFnIGluZGljYXRpbmcgaWYgdGhpcyBpcyB0aGUgRE9NIHRyZWUgdG8gbW9kaWZ5XG4gIC8vIEBwYXJhbSByZXAgV3JhcHBlZERvbVRyZWUgb2YgYSBET00gZWxlbWVudCBub2RlIGluIGRvbVxuICBjb25zdHJ1Y3Rvcihkb20sIGNsb25lLCByZXApIHtcbiAgICBpZiAoY2xvbmUpIHtcbiAgICAgIHRoaXMuc2hvd25UcmVlICA9IG5ldyBXcmFwcGVkRG9tVHJlZShkb20sIGZhbHNlLCB0aGlzKTtcbiAgICAgIHRoaXMuZG9tICAgICAgICA9IGRvbS5jbG9uZU5vZGUodHJ1ZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZG9tID0gZG9tO1xuICAgICAgdGhpcy5yZXAgPSByZXA7XG4gICAgfVxuXG4gICAgdGhpcy5jbG9uZSAgICAgICAgPSBjbG9uZTtcbiAgICB0aGlzLmhhc2ggICAgICAgICA9IGN1ckhhc2grKztcbiAgICBoYXNoVG9bdGhpcy5oYXNoXSA9IHRoaXM7XG4gICAgdGhpcy5pc1RleHQgICAgICAgPSBkb20ubm9kZVR5cGUgPT09IDM7XG4gICAgdGhpcy50YWdOYW1lICAgICAgPSBkb20udGFnTmFtZTtcbiAgICB0aGlzLmNsYXNzTmFtZSAgICA9IGRvbS5jbGFzc05hbWU7XG4gICAgdGhpcy50ZXh0RGF0YSAgICAgPSBkb20uZGF0YTtcbiAgICB0aGlzLmRpZmZIYXNoICAgICA9IHt9O1xuXG4gICAgaWYgKHRoaXMuaXNUZXh0KSB7XG4gICAgICB0aGlzLnNpemUgPSAxO1xuICAgIH0gZWxzZSB7XG4gICAgICAoeyByZXAgfSA9IHRoaXMpO1xuICAgICAgdGhpcy5jaGlsZHJlbiA9IFtdLm1hcC5jYWxsKHRoaXMuZG9tLmNoaWxkTm9kZXMsIChkb20sIGluZCkgPT4gbmV3IFdyYXBwZWREb21UcmVlKGRvbSwgZmFsc2UsIHJlcCA/IHJlcC5jaGlsZHJlbltpbmRdIDogbnVsbCkpO1xuICAgICAgdGhpcy5zaXplID0gdGhpcy5jaGlsZHJlbi5sZW5ndGggPyB0aGlzLmNoaWxkcmVuLnJlZHVjZSgoIChwcmV2LCBjdXIpID0+IHByZXYgKyBjdXIuc2l6ZSksIDApIDogMDtcbiAgICAgIGlmICghdGhpcy5zaXplKSB7XG4gICAgICAgIHRoaXMuc2l6ZSA9IDE7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLy8gQHBhcmFtIG90aGVyVHJlZSBXcmFwcGVkRG9tVHJlZSBvZiBhIERPTSBlbGVtZW50IHRvIGRpZmYgYWdhaW5zdFxuICBkaWZmVG8ob3RoZXJUcmVlKSB7XG4gICAgaWYgKHRoaXMuY2xvbmUpIHtcbiAgICAgIHJldHVybiB0aGlzLnNob3duVHJlZS5kaWZmVG8ob3RoZXJUcmVlKTtcbiAgICB9XG5cbiAgICBjb25zdCBkaWZmICAgICAgICA9IHRoaXMucmVwLmRpZmYob3RoZXJUcmVlKTtcbiAgICBjb25zdCB7IHNjb3JlIH0gICAgICAgPSBkaWZmO1xuICAgIGNvbnN0IHsgb3BlcmF0aW9ucyB9ICA9IGRpZmY7XG4gICAgbGV0IGluZGV4U2hpZnQgID0gMDtcbiAgICBsZXQgaW5zZXJ0ZWQgICAgPSBbXTtcblxuICAgIC8vIEZvcmNlIHZhcmlhYmxlcyB0byBsZWFrIHRvIGRpZmZUbyBzY29wZVxuICAgIGxldCBbbGFzdCwgcG9zc2libGVSZXBsYWNlLCByLCBsYXN0T3AsIGxhc3RFbG1EZWxldGVkLCBsYXN0RWxtSW5zZXJ0ZWRdID0gQXJyYXkuZnJvbShbXSk7XG5cbiAgICBpZiAob3BlcmF0aW9ucykge1xuICAgICAgaWYgKG9wZXJhdGlvbnMgaW5zdGFuY2VvZiBBcnJheSkge1xuICAgICAgICBmb3IgKGxldCBvcCBvZiBBcnJheS5mcm9tKG9wZXJhdGlvbnMpKSB7XG4gICAgICAgICAgKG9wID0+IHtcbiAgICAgICAgICAgIGlmIChvcC50eXBlID09PSBcImRcIikge1xuICAgICAgICAgICAgICBjb25zdCBwb3NzaWJsZUxhc3REZWxldGVkID0gdGhpcy5jaGlsZHJlbltvcC50cmVlICsgaW5kZXhTaGlmdF0uZG9tO1xuICAgICAgICAgICAgICByID0gdGhpcy5yZW1vdmUob3AudHJlZSArIGluZGV4U2hpZnQpO1xuICAgICAgICAgICAgICB0aGlzLnJlcC5yZW1vdmUob3AudHJlZSArIGluZGV4U2hpZnQpO1xuICAgICAgICAgICAgICBpZiAoIWxhc3QgfHwgKGxhc3QubmV4dFNpYmxpbmcgPT09IHIpIHx8IChsYXN0ID09PSByKSkge1xuICAgICAgICAgICAgICAgIGxhc3QgPSByO1xuICAgICAgICAgICAgICAgIC8vIFVuZGVmaW5lZCBlcnJvcnMgY2FuIGJlIHRocm93IHNvIHdlIGFkZCBhIGNvbmRpdGlvbiBvbiBsYXN0T3BcbiAgICAgICAgICAgICAgICAvLyBiZWluZyBkZWZpbmVkXG4gICAgICAgICAgICAgICAgaWYgKGxhc3QgJiYgbGFzdE9wICYmIChvcC50cmVlID09PSBsYXN0T3AucG9zKSkge1xuICAgICAgICAgICAgICAgICAgbGFzdEVsbURlbGV0ZWQgPSBwb3NzaWJsZUxhc3REZWxldGVkO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICBsYXN0RWxtRGVsZXRlZCAgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgbGFzdEVsbUluc2VydGVkID0gbnVsbDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbGFzdE9wID0gb3A7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgaW5kZXhTaGlmdC0tO1xuICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9IGVsc2UgaWYgKG9wLnR5cGUgPT09IFwiaVwiKSB7XG4gICAgICAgICAgICAgIHRoaXMucmVwLmluc2VydChvcC5wb3MgKyBpbmRleFNoaWZ0LCBvdGhlclRyZWUuY2hpbGRyZW5bb3Aub3RoZXJUcmVlXSk7XG4gICAgICAgICAgICAgIHIgPSB0aGlzLmluc2VydChvcC5wb3MgKyBpbmRleFNoaWZ0LCBvdGhlclRyZWUuY2hpbGRyZW5bb3Aub3RoZXJUcmVlXSwgdGhpcy5yZXAuY2hpbGRyZW5bb3AucG9zICsgaW5kZXhTaGlmdF0pO1xuICAgICAgICAgICAgICBpbnNlcnRlZC5wdXNoKHIpO1xuICAgICAgICAgICAgICBpZiAoIWxhc3QgfHwgKGxhc3QubmV4dFNpYmxpbmcgPT09IHIpKSB7XG4gICAgICAgICAgICAgICAgbGFzdCA9IHI7XG4gICAgICAgICAgICAgICAgbGFzdE9wID0gb3A7XG4gICAgICAgICAgICAgICAgbGFzdEVsbUluc2VydGVkID0gcjtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBpbmRleFNoaWZ0Kys7XG4gICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGNvbnN0IHJlID0gdGhpcy5jaGlsZHJlbltvcC50cmVlICsgaW5kZXhTaGlmdF0uZGlmZlRvKG90aGVyVHJlZS5jaGlsZHJlbltvcC5vdGhlclRyZWVdKTtcbiAgICAgICAgICAgICAgaWYgKCFsYXN0IHx8ICgobGFzdC5uZXh0U2libGluZyA9PT0gdGhpcy5jaGlsZHJlbltvcC50cmVlICsgaW5kZXhTaGlmdF0uZG9tKSAmJiByZS5sYXN0KSkge1xuICAgICAgICAgICAgICAgICh7IGxhc3QgfSA9IHJlKTtcbiAgICAgICAgICAgICAgICBpZiAocmUucG9zc2libGVSZXBsYWNlKSB7XG4gICAgICAgICAgICAgICAgICBsYXN0RWxtSW5zZXJ0ZWQgPSByZS5wb3NzaWJsZVJlcGxhY2UuY3VyO1xuICAgICAgICAgICAgICAgICAgbGFzdEVsbURlbGV0ZWQgID0gcmUucG9zc2libGVSZXBsYWNlLnByZXY7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGxhc3RPcCA9IG9wO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGluc2VydGVkID0gaW5zZXJ0ZWQuY29uY2F0KHJlLmluc2VydGVkKTtcbiAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pKG9wKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc29sZS5sb2cob3BlcmF0aW9ucyk7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcImludmFsaWQgb3BlcmF0aW9uc1wiKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAobGFzdE9wICYmIChsYXN0T3AudHlwZSAhPT0gJ2knKSAmJiBsYXN0RWxtSW5zZXJ0ZWQgJiYgbGFzdEVsbURlbGV0ZWQpIHtcbiAgICAgIHBvc3NpYmxlUmVwbGFjZSA9IHtcbiAgICAgICAgY3VyOiBsYXN0RWxtSW5zZXJ0ZWQsXG4gICAgICAgIHByZXY6IGxhc3RFbG1EZWxldGVkXG4gICAgICB9O1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBsYXN0LFxuICAgICAgaW5zZXJ0ZWQsXG4gICAgICBwb3NzaWJsZVJlcGxhY2VcbiAgICB9O1xuICB9XG5cbiAgaW5zZXJ0KGksIHRyZWUsIHJlcCkge1xuICAgIGNvbnN0IGRvbSA9IHRyZWUuZG9tLmNsb25lTm9kZSh0cnVlKTtcbiAgICBpZiAoaSA9PT0gdGhpcy5kb20uY2hpbGROb2Rlcy5sZW5ndGgpIHtcbiAgICAgIHRoaXMuZG9tLmFwcGVuZENoaWxkKGRvbSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZG9tLmluc2VydEJlZm9yZShkb20sIHRoaXMuZG9tLmNoaWxkTm9kZXNbaV0pO1xuICAgIH1cblxuICAgIGNvbnN0IGN0cmVlID0gbmV3IFdyYXBwZWREb21UcmVlKGRvbSwgZmFsc2UsIHJlcCk7XG4gICAgdGhpcy5jaGlsZHJlbi5zcGxpY2UoaSwgMCwgY3RyZWUpO1xuICAgIHJldHVybiB0aGlzLmRvbS5jaGlsZE5vZGVzW2ldO1xuICB9XG5cbiAgcmVtb3ZlKGkpIHtcbiAgICB0aGlzLmRvbS5yZW1vdmVDaGlsZCh0aGlzLmRvbS5jaGlsZE5vZGVzW2ldKTtcbiAgICB0aGlzLmNoaWxkcmVuW2ldLnJlbW92ZVNlbGYoKTtcbiAgICB0aGlzLmNoaWxkcmVuLnNwbGljZShpLCAxKTtcbiAgICByZXR1cm4gdGhpcy5kb20uY2hpbGROb2Rlc1tpLTFdO1xuICB9XG5cbiAgZGlmZihvdGhlclRyZWUsIHRtYXgpIHtcbiAgICBsZXQgaTtcbiAgICBpZiAodGhpcy5lcXVhbFRvKG90aGVyVHJlZSkpIHtcbiAgICAgIHJldHVybiB7c2NvcmU6IDAsIG9wZXJhdGlvbnM6IG51bGx9O1xuICAgIH1cblxuICAgIGlmICh0aGlzLmNhbm5vdFJlcGxhY2VXaXRoKG90aGVyVHJlZSkpIHtcbiAgICAgIHJldHVybiB7c2NvcmU6IDEvMCwgb3BlcmF0aW9uczogbnVsbH07XG4gICAgfVxuXG4gICAgY29uc3Qga2V5ID0gb3RoZXJUcmVlLmhhc2g7XG4gICAgaWYgKEFycmF5LmZyb20odGhpcy5kaWZmSGFzaCkuaW5jbHVkZXMoa2V5KSkge1xuICAgICAgcmV0dXJuIHRoaXMuZGlmZkhhc2hba2V5XTtcbiAgICB9XG5cbiAgICBpZiAodG1heCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICB0bWF4ID0gMTAwMDAwO1xuICAgIH1cbiAgICBpZiAodG1heCA8PSAwKSB7XG4gICAgICByZXR1cm4gMDtcbiAgICB9XG5cbiAgICBsZXQgb2Zmc2V0ID0gMDtcbiAgICBjb25zdCBmb3J3YXJkU2VhcmNoID0gb2Zmc2V0ID0+IHtcbiAgICAgIHJldHVybiAob2Zmc2V0IDwgdGhpcy5jaGlsZHJlbi5sZW5ndGgpICYmXG4gICAgICAob2Zmc2V0IDwgb3RoZXJUcmVlLmNoaWxkcmVuLmxlbmd0aCkgJiZcbiAgICAgIHRoaXMuY2hpbGRyZW5bb2Zmc2V0XS5lcXVhbFRvKG90aGVyVHJlZS5jaGlsZHJlbltvZmZzZXRdKTtcbiAgICB9O1xuICAgIHdoaWxlIChmb3J3YXJkU2VhcmNoKG9mZnNldCkpIHtcbiAgICAgIG9mZnNldCsrO1xuICAgIH1cblxuICAgIGNvbnN0IGRwID0gbmV3IFR3b0RpbUFycmF5KCh0aGlzLmNoaWxkcmVuLmxlbmd0aCArIDEpIC0gb2Zmc2V0LCAob3RoZXJUcmVlLmNoaWxkcmVuLmxlbmd0aCArIDEpIC0gb2Zmc2V0KTtcbiAgICBjb25zdCBwICA9IG5ldyBUd29EaW1BcnJheSgodGhpcy5jaGlsZHJlbi5sZW5ndGggKyAxKSAtIG9mZnNldCwgKG90aGVyVHJlZS5jaGlsZHJlbi5sZW5ndGggKyAxKSAtIG9mZnNldCk7XG4gICAgZHAuc2V0KDAsIDAsIDApO1xuXG4gICAgbGV0IHN1bSA9IDA7XG4gICAgLy8gQmVjYXVzZSBjb2ZmZXNjcmlwdHMgYWxsb3dzIGJpZGVyY3Rpb25hbCBsb29wcyB3ZSBuZWVkIHRoaXMgY29uZGl0aW9uXG4gICAgLy8gZ2F1cmQgdG8gcHJldmVudCBhIGRlY3JlYXNpbmcgYXJyYXkgbGlzdFxuICAgIGlmICgob3RoZXJUcmVlLmNoaWxkcmVuLmxlbmd0aCAtIG9mZnNldCkgPiAxKSB7XG4gICAgICBsZXQgYXNjLCBlbmQ7XG4gICAgICBmb3IgKGkgPSAxLCBlbmQgPSBvdGhlclRyZWUuY2hpbGRyZW4ubGVuZ3RoIC0gb2Zmc2V0IC0gMSwgYXNjID0gMSA8PSBlbmQ7IGFzYyA/IGkgPD0gZW5kIDogaSA+PSBlbmQ7IGFzYyA/IGkrKyA6IGktLSkge1xuICAgICAgICBkcC5zZXQoMCwgaSwgc3VtKTtcbiAgICAgICAgcC5zZXQoMCwgaSwgaS0xKTtcbiAgICAgICAgc3VtICs9IG90aGVyVHJlZS5jaGlsZHJlbltpICsgb2Zmc2V0XS5zaXplO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAoKG90aGVyVHJlZS5jaGlsZHJlbi5sZW5ndGggLSBvZmZzZXQpID4gMCkge1xuICAgICAgZHAuc2V0KDAsIG90aGVyVHJlZS5jaGlsZHJlbi5sZW5ndGggLSBvZmZzZXQsIHN1bSk7XG4gICAgICBwLnNldCgwLCBvdGhlclRyZWUuY2hpbGRyZW4ubGVuZ3RoIC0gb2Zmc2V0LCBvdGhlclRyZWUuY2hpbGRyZW4ubGVuZ3RoIC0gMSAtIG9mZnNldCk7XG4gICAgfVxuXG4gICAgc3VtID0gMDtcbiAgICAvLyBCZWNhdXNlIGNvZmZlc2NyaXB0cyBhbGxvd3MgYmlkZXJjdGlvbmFsIGxvb3BzIHdlIG5lZWQgdGhpcyBjb25kaXRpb25cbiAgICAvLyBnYXVyZCB0byBwcmV2ZW50IGEgZGVjcmVhc2luZyBhcnJheSBsaXN0XG4gICAgaWYgKCh0aGlzLmNoaWxkcmVuLmxlbmd0aCAtIG9mZnNldCkgPiAxKSB7XG4gICAgICBsZXQgYXNjMSwgZW5kMTtcbiAgICAgIGZvciAoaSA9IDEsIGVuZDEgPSB0aGlzLmNoaWxkcmVuLmxlbmd0aCAtIG9mZnNldCAtIDEsIGFzYzEgPSAxIDw9IGVuZDE7IGFzYzEgPyBpIDw9IGVuZDEgOiBpID49IGVuZDE7IGFzYzEgPyBpKysgOiBpLS0pIHtcbiAgICAgICAgZHAuc2V0KGksIDAsIHN1bSk7XG4gICAgICAgIHAuc2V0KGksIDAsIChpLTEpKnAuY29sKTtcbiAgICAgICAgc3VtICs9IHRoaXMuY2hpbGRyZW5baSArIG9mZnNldF0uc2l6ZTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHRoaXMuY2hpbGRyZW4ubGVuZ3RoIC0gb2Zmc2V0KSB7XG4gICAgICBkcC5zZXQodGhpcy5jaGlsZHJlbi5sZW5ndGggLSBvZmZzZXQsIDAsIHN1bSk7XG4gICAgICBwLnNldCh0aGlzLmNoaWxkcmVuLmxlbmd0aCAtIG9mZnNldCwgMCwgKHRoaXMuY2hpbGRyZW4ubGVuZ3RoIC0gMSAtIG9mZnNldCkqcC5jb2wpO1xuICAgIH1cblxuICAgIHZhciBnZXRTY29yZSA9IChpLCBqLCBtYXgpID0+IHtcbiAgICAgIGlmIChkcC5nZXQoaSwgaikgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICByZXR1cm4gZHAuZ2V0KGksIGopO1xuICAgICAgfVxuICAgICAgaWYgKG1heCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIG1heCA9IDEvMDtcbiAgICAgIH1cbiAgICAgIGlmIChtYXggPD0gMCkge1xuICAgICAgICByZXR1cm4gMS8wO1xuICAgICAgfVxuXG4gICAgICBsZXQgdmFsICAgICA9IG1heDtcbiAgICAgIGNvbnN0IGJvdW5kICAgPSBtYXg7XG4gICAgICBjb25zdCBzdWJkaWZmID0gdGhpcy5jaGlsZHJlblsoaSAtIDEpICsgb2Zmc2V0XS5kaWZmKCBvdGhlclRyZWUuY2hpbGRyZW5bKGogLSAxKSArIG9mZnNldF0sIGJvdW5kKS5zY29yZTtcbiAgICAgIGxldCBmb3JjZSAgID0gZmFsc2U7XG4gICAgICBpZiAoKHN1YmRpZmYgPCBib3VuZCkgJiYgKChzdWJkaWZmICsgMSkgPCAodGhpcy5jaGlsZHJlblsoaSAtIDEpICsgb2Zmc2V0XS5zaXplICsgb3RoZXJUcmVlLmNoaWxkcmVuWyhqIC0gMSkgKyBvZmZzZXRdLnNpemUpKSkge1xuICAgICAgICBmb3JjZSA9IHRydWU7XG4gICAgICB9XG4gICAgICB2YWwgPSBnZXRTY29yZShpLTEsIGotMSwgYm91bmQgLSBzdWJkaWZmKSArIHN1YmRpZmY7XG4gICAgICBsZXQgcHJldiA9IHAuZ2V0SW5kKGktMSwgai0xKTtcblxuICAgICAgaWYgKCFmb3JjZSkge1xuICAgICAgICBsZXQgb3RoZXIgPSBnZXRTY29yZShpLTEsIGosIE1hdGgubWluKHZhbCwgbWF4KSAtIHRoaXMuY2hpbGRyZW5bKGktMSkrb2Zmc2V0XS5zaXplKSArIHRoaXMuY2hpbGRyZW5bKGktMSkrb2Zmc2V0XS5zaXplO1xuICAgICAgICBpZiAob3RoZXIgPCB2YWwpIHtcbiAgICAgICAgICBwcmV2ICA9IHAuZ2V0SW5kKGktMSwgaik7XG4gICAgICAgICAgdmFsICAgPSBvdGhlcjtcbiAgICAgICAgfVxuXG4gICAgICAgIG90aGVyID0gZ2V0U2NvcmUoaSwgai0xLCBNYXRoLm1pbih2YWwsIG1heCkgLSBvdGhlclRyZWUuY2hpbGRyZW5bKGotMSkrb2Zmc2V0XS5zaXplKSArIG90aGVyVHJlZS5jaGlsZHJlblsoai0xKStvZmZzZXRdLnNpemU7XG4gICAgICAgIGlmIChvdGhlciA8IHZhbCkge1xuICAgICAgICAgIHByZXYgID0gcC5nZXRJbmQoaSwgai0xKTtcbiAgICAgICAgICB2YWwgICA9IG90aGVyO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGlmICh2YWwgPj0gbWF4KSB7XG4gICAgICAgIHZhbCA9IDEvMDtcbiAgICAgIH1cblxuICAgICAgZHAuc2V0KGksIGosIHZhbCk7XG4gICAgICBwLnNldChpLCBqLCBwcmV2KTtcbiAgICAgIHJldHVybiB2YWw7XG4gICAgfTtcblxuICAgIGNvbnN0IHNjb3JlID0gZ2V0U2NvcmUodGhpcy5jaGlsZHJlbi5sZW5ndGggLSBvZmZzZXQsIG90aGVyVHJlZS5jaGlsZHJlbi5sZW5ndGggLSBvZmZzZXQsIHRtYXgpO1xuICAgIGNvbnN0IG9wZXJhdGlvbnMgPSBbXTtcblxuICAgIGxldCBjdXIgPSBwLmdldEluZCh0aGlzLmNoaWxkcmVuLmxlbmd0aCAtIG9mZnNldCwgb3RoZXJUcmVlLmNoaWxkcmVuLmxlbmd0aCAtIG9mZnNldCk7XG4gICAgbGV0IGNyICA9IHRoaXMuY2hpbGRyZW4ubGVuZ3RoIC0gMSAtIG9mZnNldDtcbiAgICBsZXQgY2MgID0gb3RoZXJUcmVlLmNoaWxkcmVuLmxlbmd0aCAtIDEgLSBvZmZzZXQ7XG5cbiAgICB3aGlsZSAocC5yYXdHZXQoY3VyKSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBjb25zdCBwcmV2ICA9IHAucmF3R2V0KGN1cik7XG4gICAgICBjb25zdCByYyAgICA9IHAuZ2V0MkRJbmQocHJldik7XG4gICAgICBjb25zdCBwciAgICA9IHJjLnIgLSAxO1xuICAgICAgY29uc3QgcGMgICAgPSByYy5jIC0gMTtcblxuICAgICAgaWYgKHByID09PSBjcikge1xuICAgICAgICBvcGVyYXRpb25zLnVuc2hpZnQoe1xuICAgICAgICAgIHR5cGU6IFwiaVwiLFxuICAgICAgICAgIG90aGVyVHJlZTogY2MgKyBvZmZzZXQsXG4gICAgICAgICAgcG9zOiBjciArIDEgKyBvZmZzZXRcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2UgaWYgKHBjID09PSBjYykge1xuICAgICAgICBvcGVyYXRpb25zLnVuc2hpZnQoe1xuICAgICAgICAgIHR5cGU6IFwiZFwiLFxuICAgICAgICAgIHRyZWU6IGNyICsgb2Zmc2V0XG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3Qgb3AgPSB0aGlzLmNoaWxkcmVuW2NyICsgb2Zmc2V0XS5kaWZmKG90aGVyVHJlZS5jaGlsZHJlbltjYyArIG9mZnNldF0pLm9wZXJhdGlvbnM7XG4gICAgICAgIGlmIChvcCAmJiBvcC5sZW5ndGgpIHtcbiAgICAgICAgICBvcGVyYXRpb25zLnVuc2hpZnQoe1xuICAgICAgICAgICAgdHlwZTogXCJyXCIsXG4gICAgICAgICAgICB0cmVlOiBjciArIG9mZnNldCxcbiAgICAgICAgICAgIG90aGVyVHJlZTogY2MgKyBvZmZzZXRcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgY3VyID0gcHJldjtcbiAgICAgIGNyICA9IHByO1xuICAgICAgY2MgID0gcGM7XG4gICAgfVxuXG4gICAgdGhpcy5kaWZmSGFzaFtrZXldID0ge1xuICAgICAgc2NvcmUsXG4gICAgICBvcGVyYXRpb25zXG4gICAgfTtcblxuICAgIHJldHVybiB0aGlzLmRpZmZIYXNoW2tleV07XG4gIH1cblxuICBlcXVhbFRvKG90aGVyVHJlZSkge1xuICAgIHJldHVybiB0aGlzLmRvbS5pc0VxdWFsTm9kZShvdGhlclRyZWUuZG9tKTtcbiAgfVxuXG4gIGNhbm5vdFJlcGxhY2VXaXRoKG90aGVyVHJlZSkge1xuICAgIHJldHVybiB0aGlzLmlzVGV4dCB8fFxuICAgIG90aGVyVHJlZS5pc1RleHQgfHxcbiAgICAodGhpcy50YWdOYW1lICE9PSBvdGhlclRyZWUudGFnTmFtZSkgfHxcbiAgICAodGhpcy5jbGFzc05hbWUgIT09IG90aGVyVHJlZS5jbGFzc05hbWUpIHx8XG4gICAgKHRoaXMuY2xhc3NOYW1lID09PSBcIm1hdGhcIikgfHxcbiAgICAodGhpcy5jbGFzc05hbWUgPT09IFwiYXRvbS10ZXh0LWVkaXRvclwiKSB8fFxuICAgICh0aGlzLnRhZ05hbWUgPT09IFwiQVwiKSB8fFxuICAgICgodGhpcy50YWdOYW1lID09PSBcIklNR1wiKSAmJiAhdGhpcy5kb20uaXNFcXVhbE5vZGUob3RoZXJUcmVlLmRvbSkpO1xuICB9XG5cbiAgZ2V0Q29udGVudCgpIHtcbiAgICBpZiAodGhpcy5kb20ub3V0ZXJIVE1MKSB7XG4gICAgICByZXR1cm4gdGhpcy5kb20ub3V0ZXJIVE1MO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy50ZXh0RGF0YTtcbiAgICB9XG4gIH1cblxuICByZW1vdmVTZWxmKCkge1xuICAgIGhhc2hUb1t0aGlzLmhhc2hdID0gbnVsbDtcbiAgICB0aGlzLmNoaWxkcmVuICYmIHRoaXMuY2hpbGRyZW4uZm9yRWFjaChjID0+IGMucmVtb3ZlU2VsZigpKTtcbiAgfVxufSk7XG4iXX0=