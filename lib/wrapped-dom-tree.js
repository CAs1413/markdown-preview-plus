"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const two_dim_array_1 = require("./two-dim-array");
let curHash = 0;
const hashTo = {};
class WrappedDomTree {
    constructor(dom, clone, rep) {
        this.children = [];
        this.size = 0;
        if (clone) {
            this.shownTree = new WrappedDomTree(dom, false, this);
            this.dom = dom.cloneNode(true);
        }
        else {
            this.dom = dom;
            this.rep = rep;
        }
        this.clone = clone;
        this.hash = curHash++;
        hashTo[this.hash] = this;
        this.isText = dom.nodeType === 3;
        this.tagName = dom.tagName;
        this.className = dom.className;
        this.textData = dom.data;
        this.diffHash = {};
        if (this.isText) {
            this.size = 1;
        }
        else {
            this.children = Array.from(this.dom.childNodes).map((dom, ind) => new WrappedDomTree(dom, false, rep ? rep.children[ind] : undefined));
            this.size = this.children.length
                ? this.children.reduce((prev, cur) => prev + cur.size, 0)
                : 0;
            if (!this.size) {
                this.size = 1;
            }
        }
    }
    diffTo(otherTree) {
        if (this.clone && this.shownTree) {
            return this.shownTree.diffTo(otherTree);
        }
        const diff = this.rep && this.rep.diff(otherTree);
        const operations = diff && diff.operations;
        let indexShift = 0;
        let inserted = [];
        let last;
        let possibleReplace;
        let r;
        let lastOp;
        let lastElmDeleted;
        let lastElmInserted;
        if (operations) {
            if (Array.isArray(operations)) {
                for (const op of operations) {
                    if (op.type === 'd') {
                        const possibleLastDeleted = this.children[op.tree + indexShift].dom;
                        r = this.remove(op.tree + indexShift);
                        this.rep && this.rep.remove(op.tree + indexShift);
                        if (!last || last.nextSibling === r || last === r) {
                            last = r;
                            if (last &&
                                lastOp &&
                                lastOp.type === 'i' &&
                                op.tree === lastOp.pos) {
                                lastElmDeleted = possibleLastDeleted;
                            }
                            else {
                                lastElmDeleted = undefined;
                                lastElmInserted = undefined;
                            }
                            lastOp = op;
                        }
                        indexShift--;
                    }
                    else if (op.type === 'i') {
                        this.rep &&
                            this.rep.insert(op.pos + indexShift, otherTree.children[op.otherTree]);
                        r = this.insert(op.pos + indexShift, otherTree.children[op.otherTree], this.rep && this.rep.children[op.pos + indexShift]);
                        inserted.push(r);
                        if (!last || last.nextSibling === r) {
                            last = r;
                            lastOp = op;
                            lastElmInserted = r;
                        }
                        indexShift++;
                    }
                    else {
                        const re = this.children[op.tree + indexShift].diffTo(otherTree.children[op.otherTree]);
                        if (!last ||
                            (last.nextSibling === this.children[op.tree + indexShift].dom &&
                                re.last)) {
                            ;
                            ({ last } = re);
                            if (re.possibleReplace) {
                                lastElmInserted = re.possibleReplace.cur;
                                lastElmDeleted = re.possibleReplace.prev;
                            }
                            lastOp = op;
                        }
                        inserted = inserted.concat(re.inserted);
                    }
                }
            }
            else {
                console.log(operations);
                throw new Error('invalid operations');
            }
        }
        if (lastOp && lastOp.type !== 'i' && lastElmInserted && lastElmDeleted) {
            possibleReplace = {
                cur: lastElmInserted,
                prev: lastElmDeleted,
            };
        }
        return {
            last,
            inserted,
            possibleReplace,
        };
    }
    insert(i, tree, rep) {
        const dom = tree.dom.cloneNode(true);
        if (i === this.dom.childNodes.length) {
            this.dom.appendChild(dom);
        }
        else {
            this.dom.insertBefore(dom, this.dom.childNodes[i]);
        }
        const ctree = new WrappedDomTree(dom, false, rep);
        this.children.splice(i, 0, ctree);
        return this.dom.childNodes[i];
    }
    remove(i) {
        this.dom.removeChild(this.dom.childNodes[i]);
        this.children[i].removeSelf();
        this.children.splice(i, 1);
        return this.dom.childNodes[i - 1];
    }
    diff(otherTree, tmax) {
        let i;
        if (this.equalTo(otherTree)) {
            return { score: 0, operations: undefined };
        }
        if (this.cannotReplaceWith(otherTree)) {
            return { score: 1 / 0, operations: undefined };
        }
        const key = otherTree.hash;
        if (Object.keys(this.diffHash).includes(key.toString())) {
            return this.diffHash[key];
        }
        if (tmax === undefined) {
            tmax = 100000;
        }
        if (tmax <= 0) {
            return { score: 0 };
        }
        let offset = 0;
        const forwardSearch = (offset) => offset < this.children.length &&
            offset < otherTree.children.length &&
            this.children[offset].equalTo(otherTree.children[offset]);
        while (forwardSearch(offset)) {
            offset++;
        }
        const dp = new two_dim_array_1.TwoDimArray(this.children.length + 1 - offset, otherTree.children.length + 1 - offset);
        const p = new two_dim_array_1.TwoDimArray(this.children.length + 1 - offset, otherTree.children.length + 1 - offset);
        dp.set(0, 0, 0);
        let sum = 0;
        if (otherTree.children.length - offset > 1) {
            let asc;
            let end;
            for (i = 1, end = otherTree.children.length - offset - 1, asc = 1 <= end; asc ? i <= end : i >= end; asc ? i++ : i--) {
                dp.set(0, i, sum);
                p.set(0, i, i - 1);
                sum += otherTree.children[i + offset].size;
            }
        }
        if (otherTree.children.length - offset > 0) {
            dp.set(0, otherTree.children.length - offset, sum);
            p.set(0, otherTree.children.length - offset, otherTree.children.length - 1 - offset);
        }
        sum = 0;
        if (this.children.length - offset > 1) {
            let asc1;
            let end1;
            for (i = 1, end1 = this.children.length - offset - 1, asc1 = 1 <= end1; asc1 ? i <= end1 : i >= end1; asc1 ? i++ : i--) {
                dp.set(i, 0, sum);
                p.set(i, 0, (i - 1) * p.col);
                sum += this.children[i + offset].size;
            }
        }
        if (this.children.length - offset) {
            dp.set(this.children.length - offset, 0, sum);
            p.set(this.children.length - offset, 0, (this.children.length - 1 - offset) * p.col);
        }
        const getScore = (i, j, max) => {
            const res = dp.get(i, j);
            if (res !== undefined) {
                return res;
            }
            if (max === undefined) {
                max = 1 / 0;
            }
            if (max <= 0) {
                return 1 / 0;
            }
            let val = max;
            const bound = max;
            const subdiff = this.children[i - 1 + offset].diff(otherTree.children[j - 1 + offset], bound).score;
            let force = false;
            if (subdiff < bound &&
                subdiff + 1 <
                    this.children[i - 1 + offset].size +
                        otherTree.children[j - 1 + offset].size) {
                force = true;
            }
            val = getScore(i - 1, j - 1, bound - subdiff) + subdiff;
            let prev = p.getInd(i - 1, j - 1);
            if (!force) {
                let other = getScore(i - 1, j, Math.min(val, max) - this.children[i - 1 + offset].size) + this.children[i - 1 + offset].size;
                if (other < val) {
                    prev = p.getInd(i - 1, j);
                    val = other;
                }
                other =
                    getScore(i, j - 1, Math.min(val, max) - otherTree.children[j - 1 + offset].size) + otherTree.children[j - 1 + offset].size;
                if (other < val) {
                    prev = p.getInd(i, j - 1);
                    val = other;
                }
            }
            if (val >= max) {
                val = 1 / 0;
            }
            dp.set(i, j, val);
            p.set(i, j, prev);
            return val;
        };
        const score = getScore(this.children.length - offset, otherTree.children.length - offset, tmax);
        const operations = [];
        let cur = p.getInd(this.children.length - offset, otherTree.children.length - offset);
        let cr = this.children.length - 1 - offset;
        let cc = otherTree.children.length - 1 - offset;
        while (p.rawGet(cur) !== undefined) {
            const prev = p.rawGet(cur);
            const rc = p.get2DInd(prev);
            const pr = rc.r - 1;
            const pc = rc.c - 1;
            if (pr === cr) {
                operations.unshift({
                    type: 'i',
                    otherTree: cc + offset,
                    pos: cr + 1 + offset,
                });
            }
            else if (pc === cc) {
                operations.unshift({
                    type: 'd',
                    tree: cr + offset,
                });
            }
            else {
                const op = this.children[cr + offset].diff(otherTree.children[cc + offset]).operations;
                if (op && op.length) {
                    operations.unshift({
                        type: 'r',
                        tree: cr + offset,
                        otherTree: cc + offset,
                    });
                }
            }
            cur = prev;
            cr = pr;
            cc = pc;
        }
        this.diffHash[key] = {
            score,
            operations,
        };
        return this.diffHash[key];
    }
    equalTo(otherTree) {
        return this.dom.isEqualNode(otherTree.dom);
    }
    cannotReplaceWith(otherTree) {
        return (this.isText ||
            otherTree.isText ||
            this.tagName !== otherTree.tagName ||
            this.className !== otherTree.className ||
            this.className === 'math' ||
            this.className === 'atom-text-editor' ||
            this.tagName === 'A' ||
            (this.tagName === 'IMG' && !this.dom.isEqualNode(otherTree.dom)));
    }
    getContent() {
        if (this.dom.outerHTML) {
            return this.dom.outerHTML;
        }
        else {
            return this.textData;
        }
    }
    removeSelf() {
        hashTo[this.hash] = undefined;
        this.children &&
            this.children.forEach((c) => {
                c.removeSelf();
            });
    }
}
exports.WrappedDomTree = WrappedDomTree;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid3JhcHBlZC1kb20tdHJlZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy93cmFwcGVkLWRvbS10cmVlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBNEJBLG1EQUE2QztBQUU3QyxJQUFJLE9BQU8sR0FBRyxDQUFDLENBQUE7QUFDZixNQUFNLE1BQU0sR0FBa0QsRUFBRSxDQUFBO0FBT2hFO0lBdUJFLFlBQVksR0FBWSxFQUFFLEtBQWMsRUFBRSxHQUFvQjtRQW5CdEQsYUFBUSxHQUFxQixFQUFFLENBQUE7UUFDL0IsU0FBSSxHQUFXLENBQUMsQ0FBQTtRQW1CdEIsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUNWLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxjQUFjLENBQUMsR0FBRyxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQTtZQUNyRCxJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFZLENBQUE7UUFDM0MsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ04sSUFBSSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUE7WUFDZCxJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQTtRQUNoQixDQUFDO1FBRUQsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUE7UUFDbEIsSUFBSSxDQUFDLElBQUksR0FBRyxPQUFPLEVBQUUsQ0FBQTtRQUNyQixNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQTtRQUN4QixJQUFJLENBQUMsTUFBTSxHQUFHLEdBQUcsQ0FBQyxRQUFRLEtBQUssQ0FBQyxDQUFBO1FBQ2hDLElBQUksQ0FBQyxPQUFPLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQTtRQUMxQixJQUFJLENBQUMsU0FBUyxHQUFHLEdBQUcsQ0FBQyxTQUFTLENBQUE7UUFDOUIsSUFBSSxDQUFDLFFBQVEsR0FBSSxHQUFnQyxDQUFDLElB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QyxDQUFDO1lBQ04sTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUE7UUFDdEIsQ0FBQztJQUNILENBQUM7SUFFRCxVQUFVO1FBQ1IsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxTQUFTLENBQUE7UUFDN0IsSUFBSSxDQUFDLFFBQVE7WUFDWCxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFO2dCQUMxQixDQUFDLENBQUMsVUFBVSxFQUFFLENBQUE7WUFDaEIsQ0FBQyxDQUFDLENBQUE7SUFDTixDQUFDO0NBQ0Y7QUF2YkQsd0NBdWJDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIGRlY2FmZmVpbmF0ZSBzdWdnZXN0aW9uczpcbiAqIERTMTAyOiBSZW1vdmUgdW5uZWNlc3NhcnkgY29kZSBjcmVhdGVkIGJlY2F1c2Ugb2YgaW1wbGljaXQgcmV0dXJuc1xuICogRFMyMDI6IFNpbXBsaWZ5IGR5bmFtaWMgcmFuZ2UgbG9vcHNcbiAqIEZ1bGwgZG9jczogaHR0cHM6Ly9naXRodWIuY29tL2RlY2FmZmVpbmF0ZS9kZWNhZmZlaW5hdGUvYmxvYi9tYXN0ZXIvZG9jcy9zdWdnZXN0aW9ucy5tZFxuICovXG4vLyBUaGlzIGZpbGUgaW5jb3Jwb3JhdGVzIGNvZGUgZnJvbSBbbWFya21vbl0oaHR0cHM6Ly9naXRodWIuY29tL3l5amhhby9tYXJrbW9uKVxuLy8gY292ZXJlZCBieSB0aGUgZm9sbG93aW5nIHRlcm1zOlxuLy9cbi8vIENvcHlyaWdodCAoYykgMjAxNCwgWWFvIFl1amlhbiwgaHR0cDovL3lqeWFvLmNvbVxuLy9cbi8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcbi8vIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlIFwiU29mdHdhcmVcIiksIHRvIGRlYWxcbi8vIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHNcbi8vIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGxcbi8vIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpc1xuLy8gZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczpcbi8vXG4vLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpblxuLy8gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuXG4vL1xuLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEIFwiQVMgSVNcIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUlxuLy8gSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksXG4vLyBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEVcbi8vIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVJcbi8vIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sXG4vLyBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOXG4vLyBUSEUgU09GVFdBUkUuXG5pbXBvcnQgeyBUd29EaW1BcnJheSB9IGZyb20gJy4vdHdvLWRpbS1hcnJheSdcblxubGV0IGN1ckhhc2ggPSAwXG5jb25zdCBoYXNoVG86IHsgW2tleTogc3RyaW5nXTogV3JhcHBlZERvbVRyZWUgfCB1bmRlZmluZWQgfSA9IHt9XG5cbnR5cGUgT3BlcmF0aW9uID1cbiAgfCB7IHR5cGU6ICdyJzsgdHJlZTogbnVtYmVyOyBvdGhlclRyZWU6IG51bWJlciB9XG4gIHwgeyB0eXBlOiAnZCc7IHRyZWU6IG51bWJlciB9XG4gIHwgeyB0eXBlOiAnaSc7IG90aGVyVHJlZTogbnVtYmVyOyBwb3M6IG51bWJlciB9XG5cbmV4cG9ydCBjbGFzcyBXcmFwcGVkRG9tVHJlZSB7XG4gIHB1YmxpYyByZWFkb25seSBzaG93blRyZWU/OiBXcmFwcGVkRG9tVHJlZVxuICBwdWJsaWMgcmVhZG9ubHkgZG9tOiBFbGVtZW50XG4gIHByaXZhdGUgdGV4dERhdGE6IHN0cmluZ1xuICBwcml2YXRlIGNoaWxkcmVuOiBXcmFwcGVkRG9tVHJlZVtdID0gW11cbiAgcHJpdmF0ZSBzaXplOiBudW1iZXIgPSAwXG4gIHByaXZhdGUgZGlmZkhhc2g6IHsgW2tleTogc3RyaW5nXToge1xuICAgIHNjb3JlOiBudW1iZXJcbiAgICBvcGVyYXRpb25zPzogT3BlcmF0aW9uW11cbiAgfSB9XG4gIHByaXZhdGUgY2xhc3NOYW1lOiBzdHJpbmdcbiAgcHJpdmF0ZSB0YWdOYW1lOiBzdHJpbmdcbiAgcHJpdmF0ZSByZXA/OiBXcmFwcGVkRG9tVHJlZVxuICBwcml2YXRlIGlzVGV4dDogYm9vbGVhblxuICBwcml2YXRlIGhhc2g6IG51bWJlclxuICBwcml2YXRlIGNsb25lOiBib29sZWFuXG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby11bmluaXRpYWxpemVkXG4gIC8vIEBwYXJhbSBkb20gQSBET00gZWxlbWVudCBvYmplY3RcbiAgLy8gICAgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL2VsZW1lbnRcbiAgLy8gQHBhcmFtIGNsb25lIEJvb2xlYW4gZmxhZyBpbmRpY2F0aW5nIGlmIHRoaXMgaXMgdGhlIERPTSB0cmVlIHRvIG1vZGlmeVxuICAvLyBAcGFyYW0gcmVwIFdyYXBwZWREb21UcmVlIG9mIGEgRE9NIGVsZW1lbnQgbm9kZSBpbiBkb21cbiAgY29uc3RydWN0b3IoZG9tOiBFbGVtZW50LCBjbG9uZTogdHJ1ZSlcbiAgY29uc3RydWN0b3IoZG9tOiBFbGVtZW50LCBjbG9uZTogZmFsc2UsIHJlcD86IFdyYXBwZWREb21UcmVlKVxuICBjb25zdHJ1Y3Rvcihkb206IEVsZW1lbnQsIGNsb25lOiBib29sZWFuLCByZXA/OiBXcmFwcGVkRG9tVHJlZSkge1xuICAgIGlmIChjbG9uZSkge1xuICAgICAgdGhpcy5zaG93blRyZWUgPSBuZXcgV3JhcHBlZERvbVRyZWUoZG9tLCBmYWxzZSwgdGhpcylcbiAgICAgIHRoaXMuZG9tID0gZG9tLmNsb25lTm9kZSh0cnVlKSBhcyBFbGVtZW50XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZG9tID0gZG9tXG4gICAgICB0aGlzLnJlcCA9IHJlcFxuICAgIH1cblxuICAgIHRoaXMuY2xvbmUgPSBjbG9uZVxuICAgIHRoaXMuaGFzaCA9IGN1ckhhc2grK1xuICAgIGhhc2hUb1t0aGlzLmhhc2hdID0gdGhpc1xuICAgIHRoaXMuaXNUZXh0ID0gZG9tLm5vZGVUeXBlID09PSAzXG4gICAgdGhpcy50YWdOYW1lID0gZG9tLnRhZ05hbWVcbiAgICB0aGlzLmNsYXNzTmFtZSA9IGRvbS5jbGFzc05hbWVcbiAgICB0aGlzLnRleHREYXRhID0gKGRvbSBhcyBFbGVtZW50ICYge2RhdGE6IHN0cmluZ30pLmRhdGFcbiAgICB0aGlzLmRpZmZIYXNoID0ge31cblxuICAgIGlmICh0aGlzLmlzVGV4dCkge1xuICAgICAgdGhpcy5zaXplID0gMVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmNoaWxkcmVuID0gQXJyYXkuZnJvbSh0aGlzLmRvbS5jaGlsZE5vZGVzKS5tYXAoXG4gICAgICAgIChkb20sIGluZCkgPT5cbiAgICAgICAgICBuZXcgV3JhcHBlZERvbVRyZWUoXG4gICAgICAgICAgICBkb20gYXMgRWxlbWVudCxcbiAgICAgICAgICAgIGZhbHNlLFxuICAgICAgICAgICAgcmVwID8gcmVwLmNoaWxkcmVuW2luZF0gOiB1bmRlZmluZWQsXG4gICAgICAgICAgKSxcbiAgICAgIClcbiAgICAgIHRoaXMuc2l6ZSA9IHRoaXMuY2hpbGRyZW4ubGVuZ3RoXG4gICAgICAgID8gdGhpcy5jaGlsZHJlbi5yZWR1Y2UoKHByZXYsIGN1cikgPT4gcHJldiArIGN1ci5zaXplLCAwKVxuICAgICAgICA6IDBcbiAgICAgIGlmICghdGhpcy5zaXplKSB7XG4gICAgICAgIHRoaXMuc2l6ZSA9IDFcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvLyBAcGFyYW0gb3RoZXJUcmVlIFdyYXBwZWREb21UcmVlIG9mIGEgRE9NIGVsZW1lbnQgdG8gZGlmZiBhZ2FpbnN0XG4gIHB1YmxpYyBkaWZmVG8oXG4gICAgb3RoZXJUcmVlOiBXcmFwcGVkRG9tVHJlZSxcbiAgKToge1xuICAgIHBvc3NpYmxlUmVwbGFjZT86IHtcbiAgICAgIGN1cj86IE5vZGVcbiAgICAgIHByZXY/OiBFbGVtZW50XG4gICAgfVxuICAgIGluc2VydGVkOiBOb2RlW11cbiAgICBsYXN0PzogTm9kZVxuICB9IHtcbiAgICBpZiAodGhpcy5jbG9uZSAmJiB0aGlzLnNob3duVHJlZSkge1xuICAgICAgcmV0dXJuIHRoaXMuc2hvd25UcmVlLmRpZmZUbyhvdGhlclRyZWUpXG4gICAgfVxuXG4gICAgY29uc3QgZGlmZiA9IHRoaXMucmVwICYmIHRoaXMucmVwLmRpZmYob3RoZXJUcmVlKVxuICAgIGNvbnN0IG9wZXJhdGlvbnMgPSBkaWZmICYmIGRpZmYub3BlcmF0aW9uc1xuICAgIGxldCBpbmRleFNoaWZ0ID0gMFxuICAgIGxldCBpbnNlcnRlZDogTm9kZVtdID0gW11cblxuICAgIC8vIEZvcmNlIHZhcmlhYmxlcyB0byBsZWFrIHRvIGRpZmZUbyBzY29wZVxuICAgIGxldCBsYXN0OiBOb2RlIHwgdW5kZWZpbmVkXG4gICAgbGV0IHBvc3NpYmxlUmVwbGFjZVxuICAgIGxldCByXG4gICAgbGV0IGxhc3RPcDogT3BlcmF0aW9uIHwgdW5kZWZpbmVkXG4gICAgbGV0IGxhc3RFbG1EZWxldGVkOiBFbGVtZW50IHwgdW5kZWZpbmVkXG4gICAgbGV0IGxhc3RFbG1JbnNlcnRlZDogRWxlbWVudCB8IHVuZGVmaW5lZFxuXG4gICAgaWYgKG9wZXJhdGlvbnMpIHtcbiAgICAgIGlmIChBcnJheS5pc0FycmF5KG9wZXJhdGlvbnMpKSB7XG4gICAgICAgIGZvciAoY29uc3Qgb3Agb2Ygb3BlcmF0aW9ucykge1xuICAgICAgICAgIGlmIChvcC50eXBlID09PSAnZCcpIHtcbiAgICAgICAgICAgIGNvbnN0IHBvc3NpYmxlTGFzdERlbGV0ZWQgPSB0aGlzLmNoaWxkcmVuW29wLnRyZWUgKyBpbmRleFNoaWZ0XS5kb21cbiAgICAgICAgICAgIHIgPSB0aGlzLnJlbW92ZShvcC50cmVlICsgaW5kZXhTaGlmdClcbiAgICAgICAgICAgIHRoaXMucmVwICYmIHRoaXMucmVwLnJlbW92ZShvcC50cmVlICsgaW5kZXhTaGlmdClcbiAgICAgICAgICAgIGlmICghbGFzdCB8fCBsYXN0Lm5leHRTaWJsaW5nID09PSByIHx8IGxhc3QgPT09IHIpIHtcbiAgICAgICAgICAgICAgbGFzdCA9IHJcbiAgICAgICAgICAgICAgLy8gVW5kZWZpbmVkIGVycm9ycyBjYW4gYmUgdGhyb3cgc28gd2UgYWRkIGEgY29uZGl0aW9uIG9uIGxhc3RPcFxuICAgICAgICAgICAgICAvLyBiZWluZyBkZWZpbmVkXG4gICAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICBsYXN0ICYmXG4gICAgICAgICAgICAgICAgbGFzdE9wICYmXG4gICAgICAgICAgICAgICAgbGFzdE9wLnR5cGUgPT09ICdpJyAmJlxuICAgICAgICAgICAgICAgIG9wLnRyZWUgPT09IGxhc3RPcC5wb3NcbiAgICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgbGFzdEVsbURlbGV0ZWQgPSBwb3NzaWJsZUxhc3REZWxldGVkXG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgbGFzdEVsbURlbGV0ZWQgPSB1bmRlZmluZWRcbiAgICAgICAgICAgICAgICBsYXN0RWxtSW5zZXJ0ZWQgPSB1bmRlZmluZWRcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBsYXN0T3AgPSBvcFxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaW5kZXhTaGlmdC0tXG4gICAgICAgICAgfSBlbHNlIGlmIChvcC50eXBlID09PSAnaScpIHtcbiAgICAgICAgICAgIHRoaXMucmVwICYmXG4gICAgICAgICAgICAgIHRoaXMucmVwLmluc2VydChcbiAgICAgICAgICAgICAgICBvcC5wb3MgKyBpbmRleFNoaWZ0LFxuICAgICAgICAgICAgICAgIG90aGVyVHJlZS5jaGlsZHJlbltvcC5vdGhlclRyZWVdLFxuICAgICAgICAgICAgICApXG4gICAgICAgICAgICByID0gdGhpcy5pbnNlcnQoXG4gICAgICAgICAgICAgIG9wLnBvcyArIGluZGV4U2hpZnQsXG4gICAgICAgICAgICAgIG90aGVyVHJlZS5jaGlsZHJlbltvcC5vdGhlclRyZWVdLFxuICAgICAgICAgICAgICB0aGlzLnJlcCAmJiB0aGlzLnJlcC5jaGlsZHJlbltvcC5wb3MgKyBpbmRleFNoaWZ0XSxcbiAgICAgICAgICAgIClcbiAgICAgICAgICAgIGluc2VydGVkLnB1c2gocilcbiAgICAgICAgICAgIGlmICghbGFzdCB8fCBsYXN0Lm5leHRTaWJsaW5nID09PSByKSB7XG4gICAgICAgICAgICAgIGxhc3QgPSByXG4gICAgICAgICAgICAgIGxhc3RPcCA9IG9wXG4gICAgICAgICAgICAgIGxhc3RFbG1JbnNlcnRlZCA9IHIgYXMgRWxlbWVudFxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaW5kZXhTaGlmdCsrXG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IHJlID0gdGhpcy5jaGlsZHJlbltvcC50cmVlICsgaW5kZXhTaGlmdF0uZGlmZlRvKFxuICAgICAgICAgICAgICBvdGhlclRyZWUuY2hpbGRyZW5bb3Aub3RoZXJUcmVlXSxcbiAgICAgICAgICAgIClcbiAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgIWxhc3QgfHxcbiAgICAgICAgICAgICAgKGxhc3QubmV4dFNpYmxpbmcgPT09IHRoaXMuY2hpbGRyZW5bb3AudHJlZSArIGluZGV4U2hpZnRdLmRvbSAmJlxuICAgICAgICAgICAgICAgIHJlLmxhc3QpXG4gICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgOyh7IGxhc3QgfSA9IHJlKVxuICAgICAgICAgICAgICBpZiAocmUucG9zc2libGVSZXBsYWNlKSB7XG4gICAgICAgICAgICAgICAgbGFzdEVsbUluc2VydGVkID0gcmUucG9zc2libGVSZXBsYWNlLmN1ciBhcyBFbGVtZW50IHwgdW5kZWZpbmVkXG4gICAgICAgICAgICAgICAgbGFzdEVsbURlbGV0ZWQgPSByZS5wb3NzaWJsZVJlcGxhY2UucHJldlxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGxhc3RPcCA9IG9wXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpbnNlcnRlZCA9IGluc2VydGVkLmNvbmNhdChyZS5pbnNlcnRlZClcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnNvbGUubG9nKG9wZXJhdGlvbnMpXG4gICAgICAgIHRocm93IG5ldyBFcnJvcignaW52YWxpZCBvcGVyYXRpb25zJylcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAobGFzdE9wICYmIGxhc3RPcC50eXBlICE9PSAnaScgJiYgbGFzdEVsbUluc2VydGVkICYmIGxhc3RFbG1EZWxldGVkKSB7XG4gICAgICBwb3NzaWJsZVJlcGxhY2UgPSB7XG4gICAgICAgIGN1cjogbGFzdEVsbUluc2VydGVkLFxuICAgICAgICBwcmV2OiBsYXN0RWxtRGVsZXRlZCxcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgbGFzdCxcbiAgICAgIGluc2VydGVkLFxuICAgICAgcG9zc2libGVSZXBsYWNlLFxuICAgIH1cbiAgfVxuXG4gIGluc2VydChpOiBudW1iZXIsIHRyZWU6IFdyYXBwZWREb21UcmVlLCByZXA/OiBXcmFwcGVkRG9tVHJlZSkge1xuICAgIGNvbnN0IGRvbSA9IHRyZWUuZG9tLmNsb25lTm9kZSh0cnVlKVxuICAgIGlmIChpID09PSB0aGlzLmRvbS5jaGlsZE5vZGVzLmxlbmd0aCkge1xuICAgICAgdGhpcy5kb20uYXBwZW5kQ2hpbGQoZG9tKVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmRvbS5pbnNlcnRCZWZvcmUoZG9tLCB0aGlzLmRvbS5jaGlsZE5vZGVzW2ldKVxuICAgIH1cblxuICAgIGNvbnN0IGN0cmVlID0gbmV3IFdyYXBwZWREb21UcmVlKGRvbSBhcyBFbGVtZW50LCBmYWxzZSwgcmVwKVxuICAgIHRoaXMuY2hpbGRyZW4uc3BsaWNlKGksIDAsIGN0cmVlKVxuICAgIHJldHVybiB0aGlzLmRvbS5jaGlsZE5vZGVzW2ldXG4gIH1cblxuICByZW1vdmUoaTogbnVtYmVyKSB7XG4gICAgdGhpcy5kb20ucmVtb3ZlQ2hpbGQodGhpcy5kb20uY2hpbGROb2Rlc1tpXSlcbiAgICB0aGlzLmNoaWxkcmVuW2ldLnJlbW92ZVNlbGYoKVxuICAgIHRoaXMuY2hpbGRyZW4uc3BsaWNlKGksIDEpXG4gICAgcmV0dXJuIHRoaXMuZG9tLmNoaWxkTm9kZXNbaSAtIDFdXG4gIH1cblxuICBwcml2YXRlIGRpZmYoXG4gICAgb3RoZXJUcmVlOiBXcmFwcGVkRG9tVHJlZSxcbiAgICB0bWF4PzogbnVtYmVyLFxuICApOiB7XG4gICAgc2NvcmU6IG51bWJlclxuICAgIG9wZXJhdGlvbnM/OiBPcGVyYXRpb25bXVxuICB9IHtcbiAgICBsZXQgaVxuICAgIGlmICh0aGlzLmVxdWFsVG8ob3RoZXJUcmVlKSkge1xuICAgICAgcmV0dXJuIHsgc2NvcmU6IDAsIG9wZXJhdGlvbnM6IHVuZGVmaW5lZCB9XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuY2Fubm90UmVwbGFjZVdpdGgob3RoZXJUcmVlKSkge1xuICAgICAgcmV0dXJuIHsgc2NvcmU6IDEgLyAwLCBvcGVyYXRpb25zOiB1bmRlZmluZWQgfVxuICAgIH1cblxuICAgIGNvbnN0IGtleSA9IG90aGVyVHJlZS5oYXNoXG4gICAgaWYgKE9iamVjdC5rZXlzKHRoaXMuZGlmZkhhc2gpLmluY2x1ZGVzKGtleS50b1N0cmluZygpKSkge1xuICAgICAgcmV0dXJuIHRoaXMuZGlmZkhhc2hba2V5XVxuICAgIH1cblxuICAgIGlmICh0bWF4ID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHRtYXggPSAxMDAwMDBcbiAgICB9XG4gICAgaWYgKHRtYXggPD0gMCkge1xuICAgICAgcmV0dXJuIHsgc2NvcmU6IDAgfVxuICAgIH1cblxuICAgIGxldCBvZmZzZXQgPSAwXG4gICAgY29uc3QgZm9yd2FyZFNlYXJjaCA9IChvZmZzZXQ6IG51bWJlcikgPT5cbiAgICAgIG9mZnNldCA8IHRoaXMuY2hpbGRyZW4ubGVuZ3RoICYmXG4gICAgICBvZmZzZXQgPCBvdGhlclRyZWUuY2hpbGRyZW4ubGVuZ3RoICYmXG4gICAgICB0aGlzLmNoaWxkcmVuW29mZnNldF0uZXF1YWxUbyhvdGhlclRyZWUuY2hpbGRyZW5bb2Zmc2V0XSlcbiAgICB3aGlsZSAoZm9yd2FyZFNlYXJjaChvZmZzZXQpKSB7XG4gICAgICBvZmZzZXQrK1xuICAgIH1cblxuICAgIGNvbnN0IGRwID0gbmV3IFR3b0RpbUFycmF5PG51bWJlcj4oXG4gICAgICB0aGlzLmNoaWxkcmVuLmxlbmd0aCArIDEgLSBvZmZzZXQsXG4gICAgICBvdGhlclRyZWUuY2hpbGRyZW4ubGVuZ3RoICsgMSAtIG9mZnNldCxcbiAgICApXG4gICAgY29uc3QgcCA9IG5ldyBUd29EaW1BcnJheTxudW1iZXI+KFxuICAgICAgdGhpcy5jaGlsZHJlbi5sZW5ndGggKyAxIC0gb2Zmc2V0LFxuICAgICAgb3RoZXJUcmVlLmNoaWxkcmVuLmxlbmd0aCArIDEgLSBvZmZzZXQsXG4gICAgKVxuICAgIGRwLnNldCgwLCAwLCAwKVxuXG4gICAgbGV0IHN1bSA9IDBcbiAgICAvLyBCZWNhdXNlIGNvZmZlc2NyaXB0cyBhbGxvd3MgYmlkZXJjdGlvbmFsIGxvb3BzIHdlIG5lZWQgdGhpcyBjb25kaXRpb25cbiAgICAvLyBnYXVyZCB0byBwcmV2ZW50IGEgZGVjcmVhc2luZyBhcnJheSBsaXN0XG4gICAgaWYgKG90aGVyVHJlZS5jaGlsZHJlbi5sZW5ndGggLSBvZmZzZXQgPiAxKSB7XG4gICAgICBsZXQgYXNjOiBib29sZWFuXG4gICAgICBsZXQgZW5kOiBudW1iZXJcbiAgICAgIGZvciAoXG4gICAgICAgIGkgPSAxLCBlbmQgPSBvdGhlclRyZWUuY2hpbGRyZW4ubGVuZ3RoIC0gb2Zmc2V0IC0gMSwgYXNjID0gMSA8PSBlbmQ7XG4gICAgICAgIGFzYyA/IGkgPD0gZW5kIDogaSA+PSBlbmQ7XG4gICAgICAgIGFzYyA/IGkrKyA6IGktLVxuICAgICAgKSB7XG4gICAgICAgIGRwLnNldCgwLCBpLCBzdW0pXG4gICAgICAgIHAuc2V0KDAsIGksIGkgLSAxKVxuICAgICAgICBzdW0gKz0gb3RoZXJUcmVlLmNoaWxkcmVuW2kgKyBvZmZzZXRdLnNpemVcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKG90aGVyVHJlZS5jaGlsZHJlbi5sZW5ndGggLSBvZmZzZXQgPiAwKSB7XG4gICAgICBkcC5zZXQoMCwgb3RoZXJUcmVlLmNoaWxkcmVuLmxlbmd0aCAtIG9mZnNldCwgc3VtKVxuICAgICAgcC5zZXQoXG4gICAgICAgIDAsXG4gICAgICAgIG90aGVyVHJlZS5jaGlsZHJlbi5sZW5ndGggLSBvZmZzZXQsXG4gICAgICAgIG90aGVyVHJlZS5jaGlsZHJlbi5sZW5ndGggLSAxIC0gb2Zmc2V0LFxuICAgICAgKVxuICAgIH1cblxuICAgIHN1bSA9IDBcbiAgICAvLyBCZWNhdXNlIGNvZmZlc2NyaXB0cyBhbGxvd3MgYmlkZXJjdGlvbmFsIGxvb3BzIHdlIG5lZWQgdGhpcyBjb25kaXRpb25cbiAgICAvLyBnYXVyZCB0byBwcmV2ZW50IGEgZGVjcmVhc2luZyBhcnJheSBsaXN0XG4gICAgaWYgKHRoaXMuY2hpbGRyZW4ubGVuZ3RoIC0gb2Zmc2V0ID4gMSkge1xuICAgICAgbGV0IGFzYzE6IGJvb2xlYW5cbiAgICAgIGxldCBlbmQxOiBudW1iZXJcbiAgICAgIGZvciAoXG4gICAgICAgIGkgPSAxLCBlbmQxID0gdGhpcy5jaGlsZHJlbi5sZW5ndGggLSBvZmZzZXQgLSAxLCBhc2MxID0gMSA8PSBlbmQxO1xuICAgICAgICBhc2MxID8gaSA8PSBlbmQxIDogaSA+PSBlbmQxO1xuICAgICAgICBhc2MxID8gaSsrIDogaS0tXG4gICAgICApIHtcbiAgICAgICAgZHAuc2V0KGksIDAsIHN1bSlcbiAgICAgICAgcC5zZXQoaSwgMCwgKGkgLSAxKSAqIHAuY29sKVxuICAgICAgICBzdW0gKz0gdGhpcy5jaGlsZHJlbltpICsgb2Zmc2V0XS5zaXplXG4gICAgICB9XG4gICAgfVxuICAgIGlmICh0aGlzLmNoaWxkcmVuLmxlbmd0aCAtIG9mZnNldCkge1xuICAgICAgZHAuc2V0KHRoaXMuY2hpbGRyZW4ubGVuZ3RoIC0gb2Zmc2V0LCAwLCBzdW0pXG4gICAgICBwLnNldChcbiAgICAgICAgdGhpcy5jaGlsZHJlbi5sZW5ndGggLSBvZmZzZXQsXG4gICAgICAgIDAsXG4gICAgICAgICh0aGlzLmNoaWxkcmVuLmxlbmd0aCAtIDEgLSBvZmZzZXQpICogcC5jb2wsXG4gICAgICApXG4gICAgfVxuXG4gICAgY29uc3QgZ2V0U2NvcmUgPSAoaTogbnVtYmVyLCBqOiBudW1iZXIsIG1heD86IG51bWJlcik6IG51bWJlciA9PiB7XG4gICAgICBjb25zdCByZXMgPSBkcC5nZXQoaSwgailcbiAgICAgIGlmIChyZXMgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICByZXR1cm4gcmVzXG4gICAgICB9XG4gICAgICBpZiAobWF4ID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgbWF4ID0gMSAvIDBcbiAgICAgIH1cbiAgICAgIGlmIChtYXggPD0gMCkge1xuICAgICAgICByZXR1cm4gMSAvIDBcbiAgICAgIH1cblxuICAgICAgbGV0IHZhbCA9IG1heFxuICAgICAgY29uc3QgYm91bmQgPSBtYXhcbiAgICAgIGNvbnN0IHN1YmRpZmYgPSB0aGlzLmNoaWxkcmVuW2kgLSAxICsgb2Zmc2V0XS5kaWZmKFxuICAgICAgICBvdGhlclRyZWUuY2hpbGRyZW5baiAtIDEgKyBvZmZzZXRdLFxuICAgICAgICBib3VuZCxcbiAgICAgICkuc2NvcmVcbiAgICAgIGxldCBmb3JjZSA9IGZhbHNlXG4gICAgICBpZiAoXG4gICAgICAgIHN1YmRpZmYgPCBib3VuZCAmJlxuICAgICAgICBzdWJkaWZmICsgMSA8XG4gICAgICAgICAgdGhpcy5jaGlsZHJlbltpIC0gMSArIG9mZnNldF0uc2l6ZSArXG4gICAgICAgICAgICBvdGhlclRyZWUuY2hpbGRyZW5baiAtIDEgKyBvZmZzZXRdLnNpemVcbiAgICAgICkge1xuICAgICAgICBmb3JjZSA9IHRydWVcbiAgICAgIH1cbiAgICAgIHZhbCA9IGdldFNjb3JlKGkgLSAxLCBqIC0gMSwgYm91bmQgLSBzdWJkaWZmKSArIHN1YmRpZmZcbiAgICAgIGxldCBwcmV2ID0gcC5nZXRJbmQoaSAtIDEsIGogLSAxKVxuXG4gICAgICBpZiAoIWZvcmNlKSB7XG4gICAgICAgIGxldCBvdGhlciA9XG4gICAgICAgICAgZ2V0U2NvcmUoXG4gICAgICAgICAgICBpIC0gMSxcbiAgICAgICAgICAgIGosXG4gICAgICAgICAgICBNYXRoLm1pbih2YWwsIG1heCkgLSB0aGlzLmNoaWxkcmVuW2kgLSAxICsgb2Zmc2V0XS5zaXplLFxuICAgICAgICAgICkgKyB0aGlzLmNoaWxkcmVuW2kgLSAxICsgb2Zmc2V0XS5zaXplXG4gICAgICAgIGlmIChvdGhlciA8IHZhbCkge1xuICAgICAgICAgIHByZXYgPSBwLmdldEluZChpIC0gMSwgailcbiAgICAgICAgICB2YWwgPSBvdGhlclxuICAgICAgICB9XG5cbiAgICAgICAgb3RoZXIgPVxuICAgICAgICAgIGdldFNjb3JlKFxuICAgICAgICAgICAgaSxcbiAgICAgICAgICAgIGogLSAxLFxuICAgICAgICAgICAgTWF0aC5taW4odmFsLCBtYXgpIC0gb3RoZXJUcmVlLmNoaWxkcmVuW2ogLSAxICsgb2Zmc2V0XS5zaXplLFxuICAgICAgICAgICkgKyBvdGhlclRyZWUuY2hpbGRyZW5baiAtIDEgKyBvZmZzZXRdLnNpemVcbiAgICAgICAgaWYgKG90aGVyIDwgdmFsKSB7XG4gICAgICAgICAgcHJldiA9IHAuZ2V0SW5kKGksIGogLSAxKVxuICAgICAgICAgIHZhbCA9IG90aGVyXG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgaWYgKHZhbCA+PSBtYXgpIHtcbiAgICAgICAgdmFsID0gMSAvIDBcbiAgICAgIH1cblxuICAgICAgZHAuc2V0KGksIGosIHZhbClcbiAgICAgIHAuc2V0KGksIGosIHByZXYpXG4gICAgICByZXR1cm4gdmFsXG4gICAgfVxuXG4gICAgY29uc3Qgc2NvcmUgPSBnZXRTY29yZShcbiAgICAgIHRoaXMuY2hpbGRyZW4ubGVuZ3RoIC0gb2Zmc2V0LFxuICAgICAgb3RoZXJUcmVlLmNoaWxkcmVuLmxlbmd0aCAtIG9mZnNldCxcbiAgICAgIHRtYXgsXG4gICAgKVxuICAgIGNvbnN0IG9wZXJhdGlvbnM6IE9wZXJhdGlvbltdID0gW11cblxuICAgIGxldCBjdXIgPSBwLmdldEluZChcbiAgICAgIHRoaXMuY2hpbGRyZW4ubGVuZ3RoIC0gb2Zmc2V0LFxuICAgICAgb3RoZXJUcmVlLmNoaWxkcmVuLmxlbmd0aCAtIG9mZnNldCxcbiAgICApXG4gICAgbGV0IGNyID0gdGhpcy5jaGlsZHJlbi5sZW5ndGggLSAxIC0gb2Zmc2V0XG4gICAgbGV0IGNjID0gb3RoZXJUcmVlLmNoaWxkcmVuLmxlbmd0aCAtIDEgLSBvZmZzZXRcblxuICAgIHdoaWxlIChwLnJhd0dldChjdXIpICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGNvbnN0IHByZXYgPSBwLnJhd0dldChjdXIpIVxuICAgICAgY29uc3QgcmMgPSBwLmdldDJESW5kKHByZXYpXG4gICAgICBjb25zdCBwciA9IHJjLnIgLSAxXG4gICAgICBjb25zdCBwYyA9IHJjLmMgLSAxXG5cbiAgICAgIGlmIChwciA9PT0gY3IpIHtcbiAgICAgICAgb3BlcmF0aW9ucy51bnNoaWZ0KHtcbiAgICAgICAgICB0eXBlOiAnaScsXG4gICAgICAgICAgb3RoZXJUcmVlOiBjYyArIG9mZnNldCxcbiAgICAgICAgICBwb3M6IGNyICsgMSArIG9mZnNldCxcbiAgICAgICAgfSlcbiAgICAgIH0gZWxzZSBpZiAocGMgPT09IGNjKSB7XG4gICAgICAgIG9wZXJhdGlvbnMudW5zaGlmdCh7XG4gICAgICAgICAgdHlwZTogJ2QnLFxuICAgICAgICAgIHRyZWU6IGNyICsgb2Zmc2V0LFxuICAgICAgICB9KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3Qgb3AgPSB0aGlzLmNoaWxkcmVuW2NyICsgb2Zmc2V0XS5kaWZmKFxuICAgICAgICAgIG90aGVyVHJlZS5jaGlsZHJlbltjYyArIG9mZnNldF0sXG4gICAgICAgICkub3BlcmF0aW9uc1xuICAgICAgICBpZiAob3AgJiYgb3AubGVuZ3RoKSB7XG4gICAgICAgICAgb3BlcmF0aW9ucy51bnNoaWZ0KHtcbiAgICAgICAgICAgIHR5cGU6ICdyJyxcbiAgICAgICAgICAgIHRyZWU6IGNyICsgb2Zmc2V0LFxuICAgICAgICAgICAgb3RoZXJUcmVlOiBjYyArIG9mZnNldCxcbiAgICAgICAgICB9KVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICBjdXIgPSBwcmV2XG4gICAgICBjciA9IHByXG4gICAgICBjYyA9IHBjXG4gICAgfVxuXG4gICAgdGhpcy5kaWZmSGFzaFtrZXldID0ge1xuICAgICAgc2NvcmUsXG4gICAgICBvcGVyYXRpb25zLFxuICAgIH1cblxuICAgIHJldHVybiB0aGlzLmRpZmZIYXNoW2tleV1cbiAgfVxuXG4gIGVxdWFsVG8ob3RoZXJUcmVlOiBXcmFwcGVkRG9tVHJlZSkge1xuICAgIHJldHVybiB0aGlzLmRvbS5pc0VxdWFsTm9kZShvdGhlclRyZWUuZG9tKVxuICB9XG5cbiAgY2Fubm90UmVwbGFjZVdpdGgob3RoZXJUcmVlOiBXcmFwcGVkRG9tVHJlZSkge1xuICAgIHJldHVybiAoXG4gICAgICB0aGlzLmlzVGV4dCB8fFxuICAgICAgb3RoZXJUcmVlLmlzVGV4dCB8fFxuICAgICAgdGhpcy50YWdOYW1lICE9PSBvdGhlclRyZWUudGFnTmFtZSB8fFxuICAgICAgdGhpcy5jbGFzc05hbWUgIT09IG90aGVyVHJlZS5jbGFzc05hbWUgfHxcbiAgICAgIHRoaXMuY2xhc3NOYW1lID09PSAnbWF0aCcgfHxcbiAgICAgIHRoaXMuY2xhc3NOYW1lID09PSAnYXRvbS10ZXh0LWVkaXRvcicgfHxcbiAgICAgIHRoaXMudGFnTmFtZSA9PT0gJ0EnIHx8XG4gICAgICAodGhpcy50YWdOYW1lID09PSAnSU1HJyAmJiAhdGhpcy5kb20uaXNFcXVhbE5vZGUob3RoZXJUcmVlLmRvbSkpXG4gICAgKVxuICB9XG5cbiAgZ2V0Q29udGVudCgpIHtcbiAgICBpZiAodGhpcy5kb20ub3V0ZXJIVE1MKSB7XG4gICAgICByZXR1cm4gdGhpcy5kb20ub3V0ZXJIVE1MXG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB0aGlzLnRleHREYXRhXG4gICAgfVxuICB9XG5cbiAgcmVtb3ZlU2VsZigpIHtcbiAgICBoYXNoVG9bdGhpcy5oYXNoXSA9IHVuZGVmaW5lZFxuICAgIHRoaXMuY2hpbGRyZW4gJiZcbiAgICAgIHRoaXMuY2hpbGRyZW4uZm9yRWFjaCgoYykgPT4ge1xuICAgICAgICBjLnJlbW92ZVNlbGYoKVxuICAgICAgfSlcbiAgfVxufVxuIl19