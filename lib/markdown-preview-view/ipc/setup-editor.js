"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const electron_1 = require("electron");
const request_handler_1 = require("./request-handler");
const util_1 = require("../../util");
const should_scroll_sync_1 = require("./should-scroll-sync");
const event_handler_1 = require("./event-handler");
function setupEditor(editor) {
    const disp = new atom_1.CompositeDisposable();
    const windowId = electron_1.remote.getCurrentWindow().id;
    const editorId = editor.id;
    const emit = event_handler_1.constructEmitter(windowId, editorId);
    const requestHandler = new request_handler_1.RequestHandler(windowId, editorId, {
        scrollToBufferRange([min, max]) {
            if (min === 0) {
                editor.scrollToBufferPosition([min, 0]);
            }
            else if (max >= editor.getLastBufferRow() - 1) {
                editor.scrollToBufferPosition([max, 0]);
            }
            else {
                const range = atom_1.Range.fromObject([[min, 0], [max, 0]]);
                editor.scrollToScreenRange(editor.screenRangeForBufferRange(range), {
                    center: false,
                });
            }
        },
        destroy() {
            disp.dispose();
        },
        init() {
            return {
                path: editor.getPath(),
                title: editor.getTitle(),
                grammar: editor.getGrammar().scopeName,
                text: editor.getText(),
            };
        },
        openSource(row) {
            if (row !== undefined) {
                editor.setCursorBufferPosition([row, 0]);
            }
            electron_1.remote.getCurrentWindow().focus();
            const pane = atom.workspace.paneForItem(editor);
            if (!pane)
                return;
            pane.activateItem(editor);
            pane.activate();
        },
    });
    disp.add(editor.getBuffer().onDidStopChanging(() => {
        if (util_1.atomConfig().previewConfig.liveUpdate) {
            emit('changeText', editor.getText());
        }
        if (util_1.atomConfig().syncConfig.syncPreviewOnChange) {
            emit('syncPreview', editor.getCursorBufferPosition().row);
        }
    }), editor.onDidChangePath(() => {
        emit('changePath', {
            path: editor.getPath(),
            title: editor.getTitle(),
        });
    }), editor.onDidChangeGrammar((grammar) => {
        emit('changeGrammar', grammar.scopeName);
    }), editor.onDidDestroy(() => {
        disp.dispose();
        if (util_1.atomConfig().previewConfig.closePreviewWithEditor) {
            emit('destroy', undefined);
        }
    }), editor.getBuffer().onDidSave(() => {
        if (!util_1.atomConfig().previewConfig.liveUpdate) {
            emit('changeText', editor.getText());
        }
    }), editor.getBuffer().onDidReload(() => {
        if (!util_1.atomConfig().previewConfig.liveUpdate) {
            emit('changeText', editor.getText());
        }
    }), atom.views.getView(editor).onDidChangeScrollTop(() => {
        if (!should_scroll_sync_1.shouldScrollSync('editor'))
            return;
        const [first, last] = editor.getVisibleRowRange();
        const firstLine = editor.bufferRowForScreenRow(first);
        const lastLine = editor.bufferRowForScreenRow(last);
        emit('scrollSync', [firstLine, lastLine]);
    }), atom.commands.add(atom.views.getView(editor), {
        'markdown-preview-plus:sync-preview': () => {
            emit('syncPreview', editor.getCursorBufferPosition().row);
        },
    }), requestHandler);
}
exports.setupEditor = setupEditor;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2V0dXAtZWRpdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL21hcmtkb3duLXByZXZpZXctdmlldy9pcGMvc2V0dXAtZWRpdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsK0JBQTZEO0FBQzdELHVDQUFpQztBQUNqQyx1REFBa0Q7QUFDbEQscUNBQXVDO0FBQ3ZDLDZEQUF1RDtBQUN2RCxtREFBa0Q7QUFFbEQscUJBQTRCLE1BQWtCO0lBQzVDLE1BQU0sSUFBSSxHQUFHLElBQUksMEJBQW1CLEVBQUUsQ0FBQTtJQUN0QyxNQUFNLFFBQVEsR0FBRyxpQkFBTSxDQUFDLGdCQUFnQixFQUFFLENBQUMsRUFBRSxDQUFBO0lBQzdDLE1BQU0sUUFBUSxHQUFHLE1BQU0sQ0FBQyxFQUFFLENBQUE7SUFDMUIsTUFBTSxJQUFJLEdBQUcsZ0NBQWdCLENBQUMsUUFBUSxFQUFFLFFBQVEsQ0FBQyxDQUFBO0lBQ2pELE1BQU0sY0FBYyxHQUFHLElBQUksZ0NBQWMsQ0FBQyxRQUFRLEVBQUUsUUFBUSxFQUFFO1FBQzVELG1CQUFtQixDQUFDLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBbUI7WUFDOUMsSUFBSSxHQUFHLEtBQUssQ0FBQyxFQUFFO2dCQUNiLE1BQU0sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFBO2FBQ3hDO2lCQUFNLElBQUksR0FBRyxJQUFJLE1BQU0sQ0FBQyxnQkFBZ0IsRUFBRSxHQUFHLENBQUMsRUFBRTtnQkFDL0MsTUFBTSxDQUFDLHNCQUFzQixDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUE7YUFDeEM7aUJBQU07Z0JBQ0wsTUFBTSxLQUFLLEdBQUcsWUFBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtnQkFD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QVksRUFBRSxNQUFNLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQTtTQUNyQztJQUNILENBQUMsQ0FBQyxFQUNGLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLG9CQUFvQixDQUFDLEdBQUcsRUFBRTtRQUNuRCxJQUFJLENBQUMscUNBQWdCLENBQUMsUUFBUSxDQUFDO1lBQUUsT0FBTTtRQUN2QyxNQUFNLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxHQUFHLE1BQU0sQ0FBQyxrQkFBa0IsRUFBRSxDQUFBO1FBQ2pELE1BQU0sU0FBUyxHQUFHLE1BQU0sQ0FBQyxxQkFBcUIsQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUNyRCxNQUFNLFFBQVEsR0FBRyxNQUFNLENBQUMscUJBQXFCLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDbkQsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDLFNBQVMsRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFBO0lBQzNDLENBQUMsQ0FBQyxFQUNGLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUFFO1FBQzVDLG9DQUFvQyxFQUFFLEdBQUcsRUFBRTtZQUN6QyxJQUFJLENBQUMsYUFBYSxFQUFFLE1BQU0sQ0FBQyx1QkFBdUIsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFBO1FBQzNELENBQUM7S0FDRixDQUFDLEVBQ0YsY0FBYyxDQUNmLENBQUE7QUFDSCxDQUFDO0FBeEZELGtDQXdGQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRleHRFZGl0b3IsIENvbXBvc2l0ZURpc3Bvc2FibGUsIFJhbmdlIH0gZnJvbSAnYXRvbSdcbmltcG9ydCB7IHJlbW90ZSB9IGZyb20gJ2VsZWN0cm9uJ1xuaW1wb3J0IHsgUmVxdWVzdEhhbmRsZXIgfSBmcm9tICcuL3JlcXVlc3QtaGFuZGxlcidcbmltcG9ydCB7IGF0b21Db25maWcgfSBmcm9tICcuLi8uLi91dGlsJ1xuaW1wb3J0IHsgc2hvdWxkU2Nyb2xsU3luYyB9IGZyb20gJy4vc2hvdWxkLXNjcm9sbC1zeW5jJ1xuaW1wb3J0IHsgY29uc3RydWN0RW1pdHRlciB9IGZyb20gJy4vZXZlbnQtaGFuZGxlcidcblxuZXhwb3J0IGZ1bmN0aW9uIHNldHVwRWRpdG9yKGVkaXRvcjogVGV4dEVkaXRvcikge1xuICBjb25zdCBkaXNwID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuICBjb25zdCB3aW5kb3dJZCA9IHJlbW90ZS5nZXRDdXJyZW50V2luZG93KCkuaWRcbiAgY29uc3QgZWRpdG9ySWQgPSBlZGl0b3IuaWRcbiAgY29uc3QgZW1pdCA9IGNvbnN0cnVjdEVtaXR0ZXIod2luZG93SWQsIGVkaXRvcklkKVxuICBjb25zdCByZXF1ZXN0SGFuZGxlciA9IG5ldyBSZXF1ZXN0SGFuZGxlcih3aW5kb3dJZCwgZWRpdG9ySWQsIHtcbiAgICBzY3JvbGxUb0J1ZmZlclJhbmdlKFttaW4sIG1heF06IFtudW1iZXIsIG51bWJlcl0pIHtcbiAgICAgIGlmIChtaW4gPT09IDApIHtcbiAgICAgICAgZWRpdG9yLnNjcm9sbFRvQnVmZmVyUG9zaXRpb24oW21pbiwgMF0pXG4gICAgICB9IGVsc2UgaWYgKG1heCA+PSBlZGl0b3IuZ2V0TGFzdEJ1ZmZlclJvdygpIC0gMSkge1xuICAgICAgICBlZGl0b3Iuc2Nyb2xsVG9CdWZmZXJQb3NpdGlvbihbbWF4LCAwXSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IHJhbmdlID0gUmFuZ2UuZnJvbU9iamVjdChbW21pbiwgMF0sIFttYXgsIDBdXSlcbiAgICAgICAgZWRpdG9yLnNjcm9sbFRvU2NyZWVuUmFuZ2UoZWRpdG9yLnNjcmVlblJhbmdlRm9yQnVmZmVyUmFuZ2UocmFuZ2UpLCB7XG4gICAgICAgICAgY2VudGVyOiBmYWxzZSxcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICB9LFxuICAgIGRlc3Ryb3koKSB7XG4gICAgICBkaXNwLmRpc3Bvc2UoKVxuICAgIH0sXG4gICAgaW5pdCgpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHBhdGg6IGVkaXRvci5nZXRQYXRoKCksXG4gICAgICAgIHRpdGxlOiBlZGl0b3IuZ2V0VGl0bGUoKSxcbiAgICAgICAgZ3JhbW1hcjogZWRpdG9yLmdldEdyYW1tYXIoKS5zY29wZU5hbWUsXG4gICAgICAgIHRleHQ6IGVkaXRvci5nZXRUZXh0KCksXG4gICAgICB9XG4gICAgfSxcbiAgICBvcGVuU291cmNlKHJvdz86IG51bWJlcikge1xuICAgICAgaWYgKHJvdyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIGVkaXRvci5zZXRDdXJzb3JCdWZmZXJQb3NpdGlvbihbcm93LCAwXSlcbiAgICAgIH1cbiAgICAgIHJlbW90ZS5nZXRDdXJyZW50V2luZG93KCkuZm9jdXMoKVxuICAgICAgY29uc3QgcGFuZSA9IGF0b20ud29ya3NwYWNlLnBhbmVGb3JJdGVtKGVkaXRvcilcbiAgICAgIGlmICghcGFuZSkgcmV0dXJuXG4gICAgICBwYW5lLmFjdGl2YXRlSXRlbShlZGl0b3IpXG4gICAgICBwYW5lLmFjdGl2YXRlKClcbiAgICB9LFxuICB9KVxuICBkaXNwLmFkZChcbiAgICBlZGl0b3IuZ2V0QnVmZmVyKCkub25EaWRTdG9wQ2hhbmdpbmcoKCkgPT4ge1xuICAgICAgaWYgKGF0b21Db25maWcoKS5wcmV2aWV3Q29uZmlnLmxpdmVVcGRhdGUpIHtcbiAgICAgICAgZW1pdCgnY2hhbmdlVGV4dCcsIGVkaXRvci5nZXRUZXh0KCkpXG4gICAgICB9XG4gICAgICBpZiAoYXRvbUNvbmZpZygpLnN5bmNDb25maWcuc3luY1ByZXZpZXdPbkNoYW5nZSkge1xuICAgICAgICBlbWl0KCdzeW5jUHJldmlldycsIGVkaXRvci5nZXRDdXJzb3JCdWZmZXJQb3NpdGlvbigpLnJvdylcbiAgICAgIH1cbiAgICB9KSxcbiAgICBlZGl0b3Iub25EaWRDaGFuZ2VQYXRoKCgpID0+IHtcbiAgICAgIGVtaXQoJ2NoYW5nZVBhdGgnLCB7XG4gICAgICAgIHBhdGg6IGVkaXRvci5nZXRQYXRoKCksXG4gICAgICAgIHRpdGxlOiBlZGl0b3IuZ2V0VGl0bGUoKSxcbiAgICAgIH0pXG4gICAgfSksXG4gICAgZWRpdG9yLm9uRGlkQ2hhbmdlR3JhbW1hcigoZ3JhbW1hcikgPT4ge1xuICAgICAgZW1pdCgnY2hhbmdlR3JhbW1hcicsIGdyYW1tYXIuc2NvcGVOYW1lKVxuICAgIH0pLFxuICAgIGVkaXRvci5vbkRpZERlc3Ryb3koKCkgPT4ge1xuICAgICAgZGlzcC5kaXNwb3NlKClcbiAgICAgIGlmIChhdG9tQ29uZmlnKCkucHJldmlld0NvbmZpZy5jbG9zZVByZXZpZXdXaXRoRWRpdG9yKSB7XG4gICAgICAgIGVtaXQoJ2Rlc3Ryb3knLCB1bmRlZmluZWQpXG4gICAgICB9XG4gICAgfSksXG4gICAgZWRpdG9yLmdldEJ1ZmZlcigpLm9uRGlkU2F2ZSgoKSA9PiB7XG4gICAgICBpZiAoIWF0b21Db25maWcoKS5wcmV2aWV3Q29uZmlnLmxpdmVVcGRhdGUpIHtcbiAgICAgICAgZW1pdCgnY2hhbmdlVGV4dCcsIGVkaXRvci5nZXRUZXh0KCkpXG4gICAgICB9XG4gICAgfSksXG4gICAgZWRpdG9yLmdldEJ1ZmZlcigpLm9uRGlkUmVsb2FkKCgpID0+IHtcbiAgICAgIGlmICghYXRvbUNvbmZpZygpLnByZXZpZXdDb25maWcubGl2ZVVwZGF0ZSkge1xuICAgICAgICBlbWl0KCdjaGFuZ2VUZXh0JywgZWRpdG9yLmdldFRleHQoKSlcbiAgICAgIH1cbiAgICB9KSxcbiAgICBhdG9tLnZpZXdzLmdldFZpZXcoZWRpdG9yKS5vbkRpZENoYW5nZVNjcm9sbFRvcCgoKSA9PiB7XG4gICAgICBpZiAoIXNob3VsZFNjcm9sbFN5bmMoJ2VkaXRvcicpKSByZXR1cm5cbiAgICAgIGNvbnN0IFtmaXJzdCwgbGFzdF0gPSBlZGl0b3IuZ2V0VmlzaWJsZVJvd1JhbmdlKClcbiAgICAgIGNvbnN0IGZpcnN0TGluZSA9IGVkaXRvci5idWZmZXJSb3dGb3JTY3JlZW5Sb3coZmlyc3QpXG4gICAgICBjb25zdCBsYXN0TGluZSA9IGVkaXRvci5idWZmZXJSb3dGb3JTY3JlZW5Sb3cobGFzdClcbiAgICAgIGVtaXQoJ3Njcm9sbFN5bmMnLCBbZmlyc3RMaW5lLCBsYXN0TGluZV0pXG4gICAgfSksXG4gICAgYXRvbS5jb21tYW5kcy5hZGQoYXRvbS52aWV3cy5nZXRWaWV3KGVkaXRvciksIHtcbiAgICAgICdtYXJrZG93bi1wcmV2aWV3LXBsdXM6c3luYy1wcmV2aWV3JzogKCkgPT4ge1xuICAgICAgICBlbWl0KCdzeW5jUHJldmlldycsIGVkaXRvci5nZXRDdXJzb3JCdWZmZXJQb3NpdGlvbigpLnJvdylcbiAgICAgIH0sXG4gICAgfSksXG4gICAgcmVxdWVzdEhhbmRsZXIsXG4gIClcbn1cbiJdfQ==