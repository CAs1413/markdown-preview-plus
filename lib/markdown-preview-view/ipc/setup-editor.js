"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const electron_1 = require("electron");
const request_handler_1 = require("./request-handler");
const util_1 = require("../../util");
const should_scroll_sync_1 = require("./should-scroll-sync");
const event_handler_1 = require("./event-handler");
function setupEditor(editor) {
    const disp = new atom_1.CompositeDisposable();
    const windowId = electron_1.remote.getCurrentWindow().id;
    const editorId = editor.id;
    const emit = event_handler_1.constructEmitter(windowId, editorId);
    const requestHandler = new request_handler_1.RequestHandler(windowId, editorId, {
        scrollToBufferRange([min, max]) {
            if (min === 0) {
                editor.scrollToBufferPosition([min, 0]);
            }
            else if (max >= editor.getLastBufferRow() - 1) {
                editor.scrollToBufferPosition([max, 0]);
            }
            else {
                const range = atom_1.Range.fromObject([[min, 0], [max, 0]]);
                editor.scrollToScreenRange(editor.screenRangeForBufferRange(range), {
                    center: false,
                });
            }
        },
        destroy() {
            disp.dispose();
        },
        init() {
            return {
                path: editor.getPath(),
                title: editor.getTitle(),
                grammar: editor.getGrammar().scopeName,
                text: editor.getText(),
            };
        },
        openSource(row) {
            if (row !== undefined) {
                editor.setCursorBufferPosition([row, 0]);
            }
            electron_1.remote.getCurrentWindow().focus();
            const pane = atom.workspace.paneForItem(editor);
            if (!pane)
                return;
            pane.activateItem(editor);
            pane.activate();
        },
    });
    disp.add(editor.getBuffer().onDidStopChanging(() => {
        if (util_1.atomConfig().previewConfig.liveUpdate) {
            emit('changeText', editor.getText());
        }
        if (util_1.atomConfig().syncConfig.syncPreviewOnChange) {
            emit('syncPreview', editor.getCursorBufferPosition().row);
        }
    }), editor.onDidChangePath(() => {
        emit('changePath', {
            path: editor.getPath(),
            title: editor.getTitle(),
        });
    }), editor.onDidChangeGrammar((grammar) => {
        emit('changeGrammar', grammar.scopeName);
    }), editor.onDidDestroy(() => {
        if (util_1.atomConfig().previewConfig.closePreviewWithEditor) {
            emit('destroy', undefined);
        }
    }), editor.getBuffer().onDidSave(() => {
        if (!util_1.atomConfig().previewConfig.liveUpdate) {
            emit('changeText', editor.getText());
        }
    }), editor.getBuffer().onDidReload(() => {
        if (!util_1.atomConfig().previewConfig.liveUpdate) {
            emit('changeText', editor.getText());
        }
    }), atom.views.getView(editor).onDidChangeScrollTop(() => {
        if (!should_scroll_sync_1.shouldScrollSync('editor'))
            return;
        const [first, last] = editor.getVisibleRowRange();
        const firstLine = editor.bufferRowForScreenRow(first);
        const lastLine = editor.bufferRowForScreenRow(last);
        emit('scrollSync', [firstLine, lastLine]);
    }), atom.commands.add(atom.views.getView(editor), {
        'markdown-preview-plus:sync-preview': () => {
            emit('syncPreview', editor.getCursorBufferPosition().row);
        },
    }), requestHandler);
    return disp;
}
exports.setupEditor = setupEditor;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2V0dXAtZWRpdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL21hcmtkb3duLXByZXZpZXctdmlldy9pcGMvc2V0dXAtZWRpdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsK0JBQTZEO0FBQzdELHVDQUFpQztBQUNqQyx1REFBa0Q7QUFDbEQscUNBQXVDO0FBQ3ZDLDZEQUF1RDtBQUN2RCxtREFBa0Q7QUFFbEQscUJBQTRCLE1BQWtCO0lBQzVDLE1BQU0sSUFBSSxHQUFHLElBQUksMEJBQW1CLEVBQUUsQ0FBQTtJQUN0QyxNQUFNLFFBQVEsR0FBRyxpQkFBTSxDQUFDLGdCQUFnQixFQUFFLENBQUMsRUFBRSxDQUFBO0lBQzdDLE1BQU0sUUFBUSxHQUFHLE1BQU0sQ0FBQyxFQUFFLENBQUE7SUFDMUIsTUFBTSxJQUFJLEdBQUcsZ0NBQWdCLENBQUMsUUFBUSxFQUFFLFFBQVEsQ0FBQyxDQUFBO0lBQ2pELE1BQU0sY0FBYyxHQUFHLElBQUksZ0NBQWMsQ0FBQyxRQUFRLEVBQUUsUUFBUSxFQUFFO1FBQzVELG1CQUFtQixDQUFDLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBbUI7WUFDOUMsSUFBSSxHQUFHLEtBQUssQ0FBQyxFQUFFO2dCQUNiLE1BQU0sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFBO2FBQ3hDO2lCQUFNLElBQUksR0FBRyxJQUFJLE1BQU0sQ0FBQyxnQkFBZ0IsRUFBRSxHQUFHLENBQUMsRUFBRTtnQkFDL0MsTUFBTSxDQUFDLHNCQUFzQixDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUE7YUFDeEM7aUJBQU07Z0JBQ0wsTUFBTSxLQUFLLEdBQUcsWUFBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtnQkFD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QUMsQ0FBQTtTQUNyQztJQUNILENBQUMsQ0FBQyxFQUNGLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLG9CQUFvQixDQUFDLEdBQUcsRUFBRTtRQUNuRCxJQUFJLENBQUMscUNBQWdCLENBQUMsUUFBUSxDQUFDO1lBQUUsT0FBTTtRQUN2QyxNQUFNLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxHQUFHLE1BQU0sQ0FBQyxrQkFBa0IsRUFBRSxDQUFBO1FBQ2pELE1BQU0sU0FBUyxHQUFHLE1BQU0sQ0FBQyxxQkFBcUIsQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUNyRCxNQUFNLFFBQVEsR0FBRyxNQUFNLENBQUMscUJBQXFCLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDbkQsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDLFNBQVMsRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFBO0lBQzNDLENBQUMsQ0FBQyxFQUNGLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUFFO1FBQzVDLG9DQUFvQyxFQUFFLEdBQUcsRUFBRTtZQUN6QyxJQUFJLENBQUMsYUFBYSxFQUFFLE1BQU0sQ0FBQyx1QkFBdUIsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFBO1FBQzNELENBQUM7S0FDRixDQUFDLEVBQ0YsY0FBYyxDQUNmLENBQUE7SUFDRCxPQUFPLElBQUksQ0FBQTtBQUNiLENBQUM7QUF4RkQsa0NBd0ZDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGV4dEVkaXRvciwgQ29tcG9zaXRlRGlzcG9zYWJsZSwgUmFuZ2UgfSBmcm9tICdhdG9tJ1xuaW1wb3J0IHsgcmVtb3RlIH0gZnJvbSAnZWxlY3Ryb24nXG5pbXBvcnQgeyBSZXF1ZXN0SGFuZGxlciB9IGZyb20gJy4vcmVxdWVzdC1oYW5kbGVyJ1xuaW1wb3J0IHsgYXRvbUNvbmZpZyB9IGZyb20gJy4uLy4uL3V0aWwnXG5pbXBvcnQgeyBzaG91bGRTY3JvbGxTeW5jIH0gZnJvbSAnLi9zaG91bGQtc2Nyb2xsLXN5bmMnXG5pbXBvcnQgeyBjb25zdHJ1Y3RFbWl0dGVyIH0gZnJvbSAnLi9ldmVudC1oYW5kbGVyJ1xuXG5leHBvcnQgZnVuY3Rpb24gc2V0dXBFZGl0b3IoZWRpdG9yOiBUZXh0RWRpdG9yKTogQ29tcG9zaXRlRGlzcG9zYWJsZSB7XG4gIGNvbnN0IGRpc3AgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gIGNvbnN0IHdpbmRvd0lkID0gcmVtb3RlLmdldEN1cnJlbnRXaW5kb3coKS5pZFxuICBjb25zdCBlZGl0b3JJZCA9IGVkaXRvci5pZFxuICBjb25zdCBlbWl0ID0gY29uc3RydWN0RW1pdHRlcih3aW5kb3dJZCwgZWRpdG9ySWQpXG4gIGNvbnN0IHJlcXVlc3RIYW5kbGVyID0gbmV3IFJlcXVlc3RIYW5kbGVyKHdpbmRvd0lkLCBlZGl0b3JJZCwge1xuICAgIHNjcm9sbFRvQnVmZmVyUmFuZ2UoW21pbiwgbWF4XTogW251bWJlciwgbnVtYmVyXSkge1xuICAgICAgaWYgKG1pbiA9PT0gMCkge1xuICAgICAgICBlZGl0b3Iuc2Nyb2xsVG9CdWZmZXJQb3NpdGlvbihbbWluLCAwXSlcbiAgICAgIH0gZWxzZSBpZiAobWF4ID49IGVkaXRvci5nZXRMYXN0QnVmZmVyUm93KCkgLSAxKSB7XG4gICAgICAgIGVkaXRvci5zY3JvbGxUb0J1ZmZlclBvc2l0aW9uKFttYXgsIDBdKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgcmFuZ2UgPSBSYW5nZS5mcm9tT2JqZWN0KFtbbWluLCAwXSwgW21heCwgMF1dKVxuICAgICAgICBlZGl0b3Iuc2Nyb2xsVG9TY3JlZW5SYW5nZShlZGl0b3Iuc2NyZWVuUmFuZ2VGb3JCdWZmZXJSYW5nZShyYW5nZSksIHtcbiAgICAgICAgICBjZW50ZXI6IGZhbHNlLFxuICAgICAgICB9KVxuICAgICAgfVxuICAgIH0sXG4gICAgZGVzdHJveSgpIHtcbiAgICAgIGRpc3AuZGlzcG9zZSgpXG4gICAgfSxcbiAgICBpbml0KCkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgcGF0aDogZWRpdG9yLmdldFBhdGgoKSxcbiAgICAgICAgdGl0bGU6IGVkaXRvci5nZXRUaXRsZSgpLFxuICAgICAgICBncmFtbWFyOiBlZGl0b3IuZ2V0R3JhbW1hcigpLnNjb3BlTmFtZSxcbiAgICAgICAgdGV4dDogZWRpdG9yLmdldFRleHQoKSxcbiAgICAgIH1cbiAgICB9LFxuICAgIG9wZW5Tb3VyY2Uocm93PzogbnVtYmVyKSB7XG4gICAgICBpZiAocm93ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgZWRpdG9yLnNldEN1cnNvckJ1ZmZlclBvc2l0aW9uKFtyb3csIDBdKVxuICAgICAgfVxuICAgICAgcmVtb3RlLmdldEN1cnJlbnRXaW5kb3coKS5mb2N1cygpXG4gICAgICBjb25zdCBwYW5lID0gYXRvbS53b3Jrc3BhY2UucGFuZUZvckl0ZW0oZWRpdG9yKVxuICAgICAgaWYgKCFwYW5lKSByZXR1cm5cbiAgICAgIHBhbmUuYWN0aXZhdGVJdGVtKGVkaXRvcilcbiAgICAgIHBhbmUuYWN0aXZhdGUoKVxuICAgIH0sXG4gIH0pXG4gIGRpc3AuYWRkKFxuICAgIGVkaXRvci5nZXRCdWZmZXIoKS5vbkRpZFN0b3BDaGFuZ2luZygoKSA9PiB7XG4gICAgICBpZiAoYXRvbUNvbmZpZygpLnByZXZpZXdDb25maWcubGl2ZVVwZGF0ZSkge1xuICAgICAgICBlbWl0KCdjaGFuZ2VUZXh0JywgZWRpdG9yLmdldFRleHQoKSlcbiAgICAgIH1cbiAgICAgIGlmIChhdG9tQ29uZmlnKCkuc3luY0NvbmZpZy5zeW5jUHJldmlld09uQ2hhbmdlKSB7XG4gICAgICAgIGVtaXQoJ3N5bmNQcmV2aWV3JywgZWRpdG9yLmdldEN1cnNvckJ1ZmZlclBvc2l0aW9uKCkucm93KVxuICAgICAgfVxuICAgIH0pLFxuICAgIGVkaXRvci5vbkRpZENoYW5nZVBhdGgoKCkgPT4ge1xuICAgICAgZW1pdCgnY2hhbmdlUGF0aCcsIHtcbiAgICAgICAgcGF0aDogZWRpdG9yLmdldFBhdGgoKSxcbiAgICAgICAgdGl0bGU6IGVkaXRvci5nZXRUaXRsZSgpLFxuICAgICAgfSlcbiAgICB9KSxcbiAgICBlZGl0b3Iub25EaWRDaGFuZ2VHcmFtbWFyKChncmFtbWFyKSA9PiB7XG4gICAgICBlbWl0KCdjaGFuZ2VHcmFtbWFyJywgZ3JhbW1hci5zY29wZU5hbWUpXG4gICAgfSksXG4gICAgZWRpdG9yLm9uRGlkRGVzdHJveSgoKSA9PiB7XG4gICAgICBpZiAoYXRvbUNvbmZpZygpLnByZXZpZXdDb25maWcuY2xvc2VQcmV2aWV3V2l0aEVkaXRvcikge1xuICAgICAgICBlbWl0KCdkZXN0cm95JywgdW5kZWZpbmVkKVxuICAgICAgfVxuICAgIH0pLFxuICAgIGVkaXRvci5nZXRCdWZmZXIoKS5vbkRpZFNhdmUoKCkgPT4ge1xuICAgICAgaWYgKCFhdG9tQ29uZmlnKCkucHJldmlld0NvbmZpZy5saXZlVXBkYXRlKSB7XG4gICAgICAgIGVtaXQoJ2NoYW5nZVRleHQnLCBlZGl0b3IuZ2V0VGV4dCgpKVxuICAgICAgfVxuICAgIH0pLFxuICAgIGVkaXRvci5nZXRCdWZmZXIoKS5vbkRpZFJlbG9hZCgoKSA9PiB7XG4gICAgICBpZiAoIWF0b21Db25maWcoKS5wcmV2aWV3Q29uZmlnLmxpdmVVcGRhdGUpIHtcbiAgICAgICAgZW1pdCgnY2hhbmdlVGV4dCcsIGVkaXRvci5nZXRUZXh0KCkpXG4gICAgICB9XG4gICAgfSksXG4gICAgYXRvbS52aWV3cy5nZXRWaWV3KGVkaXRvcikub25EaWRDaGFuZ2VTY3JvbGxUb3AoKCkgPT4ge1xuICAgICAgaWYgKCFzaG91bGRTY3JvbGxTeW5jKCdlZGl0b3InKSkgcmV0dXJuXG4gICAgICBjb25zdCBbZmlyc3QsIGxhc3RdID0gZWRpdG9yLmdldFZpc2libGVSb3dSYW5nZSgpXG4gICAgICBjb25zdCBmaXJzdExpbmUgPSBlZGl0b3IuYnVmZmVyUm93Rm9yU2NyZWVuUm93KGZpcnN0KVxuICAgICAgY29uc3QgbGFzdExpbmUgPSBlZGl0b3IuYnVmZmVyUm93Rm9yU2NyZWVuUm93KGxhc3QpXG4gICAgICBlbWl0KCdzY3JvbGxTeW5jJywgW2ZpcnN0TGluZSwgbGFzdExpbmVdKVxuICAgIH0pLFxuICAgIGF0b20uY29tbWFuZHMuYWRkKGF0b20udmlld3MuZ2V0VmlldyhlZGl0b3IpLCB7XG4gICAgICAnbWFya2Rvd24tcHJldmlldy1wbHVzOnN5bmMtcHJldmlldyc6ICgpID0+IHtcbiAgICAgICAgZW1pdCgnc3luY1ByZXZpZXcnLCBlZGl0b3IuZ2V0Q3Vyc29yQnVmZmVyUG9zaXRpb24oKS5yb3cpXG4gICAgICB9LFxuICAgIH0pLFxuICAgIHJlcXVlc3RIYW5kbGVyLFxuICApXG4gIHJldHVybiBkaXNwXG59XG4iXX0=