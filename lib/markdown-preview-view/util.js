"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const fs = require("fs");
const util_1 = require("../util");
function editorForId(editorId) {
    for (const editor of atom.workspace.getTextEditors()) {
        if (editor.id === editorId) {
            return editor;
        }
    }
    return undefined;
}
exports.editorForId = editorForId;
let getStylesOverride = undefined;
function __setGetStylesOverride(f) {
    getStylesOverride = f;
}
exports.__setGetStylesOverride = __setGetStylesOverride;
function getStyles(context) {
    if (getStylesOverride)
        return getStylesOverride(context);
    const textEditorStyles = document.createElement('atom-styles');
    textEditorStyles.initialize(atom.styles);
    textEditorStyles.setAttribute('context', context);
    return Array.from(textEditorStyles.childNodes).map((styleElement) => styleElement.innerText);
}
exports.getStyles = getStyles;
function getMarkdownPreviewCSS() {
    const markdowPreviewRules = ['body { padding: 0; margin: 0; }'];
    const cssUrlRefExp = /url\(atom:\/\/markdown-preview-plus\/assets\/(.*)\)/;
    return markdowPreviewRules
        .concat(getStyles('markdown-preview-plus'))
        .concat(getStyles('atom-text-editor'))
        .join('\n')
        .replace(/\batom-text-editor\b/g, 'pre.editor-colors')
        .replace(/\bmarkdown-preview-plus-view\b/g, '.markdown-preview-plus-view')
        .replace(cssUrlRefExp, function (_match, assetsName, _offset, _string) {
        const assetPath = path.join(__dirname, '../../assets', assetsName);
        const originalData = fs.readFileSync(assetPath, 'binary');
        const base64Data = new Buffer(originalData, 'binary').toString('base64');
        return `url('data:image/jpeg;base64,${base64Data}')`;
    });
}
exports.getMarkdownPreviewCSS = getMarkdownPreviewCSS;
function bubbleToContainerToken(pathToToken) {
    const end = pathToToken.length - 1;
    for (let i = 0; i <= end; i++) {
        if (pathToToken[i].tag === 'table') {
            return pathToToken.slice(0, i + 1);
        }
    }
    return pathToToken;
}
exports.bubbleToContainerToken = bubbleToContainerToken;
function decodeTag(token) {
    if (token.tag === 'math') {
        return 'span';
    }
    if (token.tag === 'code') {
        return 'span';
    }
    if (token.tag === '') {
        return null;
    }
    return token.tag;
}
exports.decodeTag = decodeTag;
function getPathToToken(tokens, line) {
    let pathToToken = [];
    let tokenTagCount = {};
    let level = 0;
    for (const token of tokens) {
        if (token.level < level) {
            break;
        }
        if (token.hidden) {
            continue;
        }
        if (token.nesting === -1) {
            continue;
        }
        const tag = decodeTag(token);
        if (tag === null) {
            continue;
        }
        token.tag = tag;
        if (token.map != null &&
            line >= token.map[0] &&
            line <= token.map[1] - 1) {
            if (token.nesting === 1) {
                pathToToken.push({
                    tag: token.tag,
                    index: tokenTagCount[token.tag] || 0,
                });
                tokenTagCount = {};
                level++;
            }
            else if (token.nesting === 0) {
                pathToToken.push({
                    tag: token.tag,
                    index: tokenTagCount[token.tag] || 0,
                });
                break;
            }
        }
        else if (token.level === level) {
            if (tokenTagCount[token.tag] !== undefined) {
                tokenTagCount[token.tag]++;
            }
            else {
                tokenTagCount[token.tag] = 1;
            }
        }
    }
    pathToToken = bubbleToContainerToken(pathToToken);
    return pathToToken;
}
exports.getPathToToken = getPathToToken;
exports.mathJaxScript = `\
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
jax: ["input/TeX","output/HTML-CSS"],
extensions: [],
TeX: {
extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
},
showMathMenu: false
});
</script>
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js">
</script>\
`;
function mkHtml(title, html, renderLaTeX, useGithubStyle) {
    const githubStyle = useGithubStyle ? ' data-use-github-style' : '';
    let maybeMathJaxScript;
    if (renderLaTeX) {
        maybeMathJaxScript = exports.mathJaxScript;
    }
    else {
        maybeMathJaxScript = '';
    }
    return `\
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>${title}</title>${maybeMathJaxScript}
    <style>${getMarkdownPreviewCSS()}</style>
${html.head.innerHTML}
  </head>
  <body class="markdown-preview-plus-view"${githubStyle}>
    ${html.body.innerHTML}
  </body>
</html>
`;
}
exports.mkHtml = mkHtml;
function destroy(item) {
    const pane = atom.workspace.paneForItem(item);
    if (pane)
        util_1.handlePromise(pane.destroyItem(item));
}
exports.destroy = destroy;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tYXJrZG93bi1wcmV2aWV3LXZpZXcvdXRpbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLDZCQUE0QjtBQUM1Qix5QkFBd0I7QUFFeEIsa0NBQXVDO0FBRXZDLHFCQUE0QixRQUFnQjtJQUMxQyxHQUFHLENBQUMsQ0FBQyxNQUFNLE1BQU0sSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLGNBQWMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUNyRCxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsRUFBRSxLQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUM7WUFDM0IsTUFBTSxDQUFDLE1BQU0sQ0FBQTtRQUNmLENBQUM7SUFDSCxDQUFDO0lBQ0QsTUFBTSxDQUFDLFNBQVMsQ0FBQTtBQUNsQixDQUFDO0FBUEQsa0NBT0M7QUFHRCxJQUFJLGlCQUFpQixHQUFpQyxTQUFTLENBQUE7QUFFL0QsZ0NBQXVDLENBQW9CO0lBQ3pELGlCQUFpQixHQUFHLENBQUMsQ0FBQTtBQUN2QixDQUFDO0FBRkQsd0RBRUM7QUFFRCxtQkFBMEIsT0FBZTtJQUN2QyxFQUFFLENBQUMsQ0FBQyxpQkFBaUIsQ0FBQztRQUFDLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLENBQUMsQ0FBQTtJQUN4RCxNQUFNLGdCQUFnQixHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQzdDLGFBQWEsQ0FDOEMsQ0FBQTtJQUM3RCxnQkFBZ0IsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFBO0lBQ3hDLGdCQUFnQixDQUFDLFlBQVksQ0FBQyxTQUFTLEVBQUUsT0FBTyxDQUFDLENBQUE7SUFHakQsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxDQUFDLENBQUMsR0FBRyxDQUNoRCxDQUFDLFlBQVksRUFBRSxFQUFFLENBQUUsWUFBaUMsQ0FBQyxTQUFTLENBQy9ELENB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RyxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUM3QyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUM7UUFBQyxvQkFBYSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQTtBQUNqRCxDQUFDO0FBSEQsMEJBR0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUZXh0RWRpdG9yLCBTdHlsZU1hbmFnZXIgfSBmcm9tICdhdG9tJ1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJ1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnXG5pbXBvcnQgeyBUb2tlbiB9IGZyb20gJ21hcmtkb3duLWl0J1xuaW1wb3J0IHsgaGFuZGxlUHJvbWlzZSB9IGZyb20gJy4uL3V0aWwnXG5cbmV4cG9ydCBmdW5jdGlvbiBlZGl0b3JGb3JJZChlZGl0b3JJZDogbnVtYmVyKTogVGV4dEVkaXRvciB8IHVuZGVmaW5lZCB7XG4gIGZvciAoY29uc3QgZWRpdG9yIG9mIGF0b20ud29ya3NwYWNlLmdldFRleHRFZGl0b3JzKCkpIHtcbiAgICBpZiAoZWRpdG9yLmlkID09PSBlZGl0b3JJZCkge1xuICAgICAgcmV0dXJuIGVkaXRvclxuICAgIH1cbiAgfVxuICByZXR1cm4gdW5kZWZpbmVkXG59XG5cbi8vIHRoaXMgd2VpcmRuZXNzIGFsbG93cyBvdmVycmlkaW5nIGluIHRlc3RzXG5sZXQgZ2V0U3R5bGVzT3ZlcnJpZGU6IHR5cGVvZiBnZXRTdHlsZXMgfCB1bmRlZmluZWQgPSB1bmRlZmluZWRcblxuZXhwb3J0IGZ1bmN0aW9uIF9fc2V0R2V0U3R5bGVzT3ZlcnJpZGUoZj86IHR5cGVvZiBnZXRTdHlsZXMpIHtcbiAgZ2V0U3R5bGVzT3ZlcnJpZGUgPSBmXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRTdHlsZXMoY29udGV4dDogc3RyaW5nKTogc3RyaW5nW10ge1xuICBpZiAoZ2V0U3R5bGVzT3ZlcnJpZGUpIHJldHVybiBnZXRTdHlsZXNPdmVycmlkZShjb250ZXh0KVxuICBjb25zdCB0ZXh0RWRpdG9yU3R5bGVzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcbiAgICAnYXRvbS1zdHlsZXMnLFxuICApIGFzIEhUTUxFbGVtZW50ICYgeyBpbml0aWFsaXplKHN0eWxlczogU3R5bGVNYW5hZ2VyKTogdm9pZCB9XG4gIHRleHRFZGl0b3JTdHlsZXMuaW5pdGlhbGl6ZShhdG9tLnN0eWxlcylcbiAgdGV4dEVkaXRvclN0eWxlcy5zZXRBdHRyaWJ1dGUoJ2NvbnRleHQnLCBjb250ZXh0KVxuXG4gIC8vIEV4dHJhY3Qgc3R5bGUgZWxlbWVudHMgY29udGVudFxuICByZXR1cm4gQXJyYXkuZnJvbSh0ZXh0RWRpdG9yU3R5bGVzLmNoaWxkTm9kZXMpLm1hcChcbiAgICAoc3R5bGVFbGVtZW50KSA9PiAoc3R5bGVFbGVtZW50IGFzIEhUTUxTdHlsZUVsZW1lbnQpLmlubmVyVGV4dCxcbiAgKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0TWFya2Rvd25QcmV2aWV3Q1NTKCkge1xuICBjb25zdCBtYXJrZG93UHJldmlld1J1bGVzID0gWydib2R5IHsgcGFkZGluZzogMDsgbWFyZ2luOiAwOyB9J11cbiAgY29uc3QgY3NzVXJsUmVmRXhwID0gL3VybFxcKGF0b206XFwvXFwvbWFya2Rvd24tcHJldmlldy1wbHVzXFwvYXNzZXRzXFwvKC4qKVxcKS9cblxuICByZXR1cm4gbWFya2Rvd1ByZXZpZXdSdWxlc1xuICAgIC5jb25jYXQoZ2V0U3R5bGVzKCdtYXJrZG93bi1wcmV2aWV3LXBsdXMnKSlcbiAgICAuY29uY2F0KGdldFN0eWxlcygnYXRvbS10ZXh0LWVkaXRvcicpKVxuICAgIC5qb2luKCdcXG4nKVxuICAgIC5yZXBsYWNlKC9cXGJhdG9tLXRleHQtZWRpdG9yXFxiL2csICdwcmUuZWRpdG9yLWNvbG9ycycpXG4gICAgLnJlcGxhY2UoL1xcYm1hcmtkb3duLXByZXZpZXctcGx1cy12aWV3XFxiL2csICcubWFya2Rvd24tcHJldmlldy1wbHVzLXZpZXcnKVxuICAgIC5yZXBsYWNlKGNzc1VybFJlZkV4cCwgZnVuY3Rpb24oXG4gICAgICBfbWF0Y2gsXG4gICAgICBhc3NldHNOYW1lOiBzdHJpbmcsXG4gICAgICBfb2Zmc2V0LFxuICAgICAgX3N0cmluZyxcbiAgICApIHtcbiAgICAgIC8vIGJhc2U2NCBlbmNvZGUgYXNzZXRzXG4gICAgICBjb25zdCBhc3NldFBhdGggPSBwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vLi4vYXNzZXRzJywgYXNzZXRzTmFtZSlcbiAgICAgIGNvbnN0IG9yaWdpbmFsRGF0YSA9IGZzLnJlYWRGaWxlU3luYyhhc3NldFBhdGgsICdiaW5hcnknKVxuICAgICAgY29uc3QgYmFzZTY0RGF0YSA9IG5ldyBCdWZmZXIob3JpZ2luYWxEYXRhLCAnYmluYXJ5JykudG9TdHJpbmcoJ2Jhc2U2NCcpXG4gICAgICByZXR1cm4gYHVybCgnZGF0YTppbWFnZS9qcGVnO2Jhc2U2NCwke2Jhc2U2NERhdGF9JylgXG4gICAgfSlcbn1cblxuLy9cbi8vIERldGVybWluZSBhIHN1YnNlcXVlbmNlIG9mIGEgc2VxdWVuY2Ugb2YgdG9rZW5zIHJlcHJlc2VudGluZyBhIHBhdGggdGhyb3VnaFxuLy8gSFRNTEVsZW1lbnRzIHRoYXQgZG9lcyBub3QgY29udGludWUgZGVlcGVyIHRoYW4gYSB0YWJsZSBlbGVtZW50LlxuLy9cbi8vIEBwYXJhbSB7KHRhZzogPHRhZz4sIGluZGV4OiA8aW5kZXg+KVtdfSBwYXRoVG9Ub2tlbiBBcnJheSBvZiB0b2tlbnNcbi8vICAgcmVwcmVzZW50aW5nIGEgcGF0aCB0byBhIEhUTUxFbGVtZW50IHdpdGggdGhlIHJvb3QgZWxlbWVudCBhdFxuLy8gICBwYXRoVG9Ub2tlblswXSBhbmQgdGhlIHRhcmdldCBlbGVtZW50IGF0IHRoZSBoaWdoZXN0IGluZGV4LiBFYWNoIGVsZW1lbnRcbi8vICAgY29uc2lzdHMgb2YgYSBgdGFnYCBhbmQgYGluZGV4YCByZXByZXNlbnRpbmcgaXRzIGluZGV4IGFtb25nc3QgaXRzXG4vLyAgIHNpYmxpbmcgZWxlbWVudHMgb2YgdGhlIHNhbWUgYHRhZ2AuXG4vLyBAcmV0dXJuIHsodGFnOiA8dGFnPiwgaW5kZXg6IDxpbmRleD4pW119IFRoZSBzdWJzZXF1ZW5jZSBvZiBwYXRoVG9Ub2tlbiB0aGF0XG4vLyAgIG1haW50YWlucyB0aGUgc2FtZSByb290IGJ1dCB0ZXJtaW5hdGVzIGF0IGEgdGFibGUgZWxlbWVudCBvciB0aGUgdGFyZ2V0XG4vLyAgIGVsZW1lbnQsIHdoaWNoZXZlciBjb21lcyBmaXJzdC5cbi8vXG5leHBvcnQgZnVuY3Rpb24gYnViYmxlVG9Db250YWluZXJUb2tlbihcbiAgcGF0aFRvVG9rZW46IEFycmF5PHsgdGFnOiBzdHJpbmc7IGluZGV4OiBudW1iZXIgfT4sXG4pIHtcbiAgY29uc3QgZW5kID0gcGF0aFRvVG9rZW4ubGVuZ3RoIC0gMVxuICBmb3IgKGxldCBpID0gMDsgaSA8PSBlbmQ7IGkrKykge1xuICAgIGlmIChwYXRoVG9Ub2tlbltpXS50YWcgPT09ICd0YWJsZScpIHtcbiAgICAgIHJldHVybiBwYXRoVG9Ub2tlbi5zbGljZSgwLCBpICsgMSlcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHBhdGhUb1Rva2VuXG59XG5cbi8vXG4vLyBEZWNvZGUgdGFncyB1c2VkIGJ5IG1hcmtkb3duLWl0XG4vL1xuLy8gQHBhcmFtIHttYXJrZG93bi1pdC5Ub2tlbn0gdG9rZW4gRGVjb2RlIHRoZSB0YWcgb2YgdG9rZW4uXG4vLyBAcmV0dXJuIHtzdHJpbmd8bnVsbH0gRGVjb2RlZCB0YWcgb3IgYG51bGxgIGlmIHRoZSB0b2tlbiBoYXMgbm8gdGFnLlxuLy9cbmV4cG9ydCBmdW5jdGlvbiBkZWNvZGVUYWcodG9rZW46IFRva2VuKTogc3RyaW5nIHwgbnVsbCB7XG4gIGlmICh0b2tlbi50YWcgPT09ICdtYXRoJykge1xuICAgIHJldHVybiAnc3BhbidcbiAgfVxuICBpZiAodG9rZW4udGFnID09PSAnY29kZScpIHtcbiAgICByZXR1cm4gJ3NwYW4nXG4gIH1cbiAgaWYgKHRva2VuLnRhZyA9PT0gJycpIHtcbiAgICByZXR1cm4gbnVsbFxuICB9XG4gIHJldHVybiB0b2tlbi50YWdcbn1cblxuLy9cbi8vIERldGVybWluZSBwYXRoIHRvIGEgdGFyZ2V0IHRva2VuLlxuLy9cbi8vIEBwYXJhbSB7KG1hcmtkb3duLWl0LlRva2VuKVtdfSB0b2tlbnMgQXJyYXkgb2YgdG9rZW5zIGFzIHJldHVybmVkIGJ5XG4vLyAgIGBtYXJrZG93bi1pdC5wYXJzZSgpYC5cbi8vIEBwYXJhbSB7bnVtYmVyfSBsaW5lIExpbmUgcmVwcmVzZW50aW5nIHRoZSB0YXJnZXQgdG9rZW4uXG4vLyBAcmV0dXJuIHsodGFnOiA8dGFnPiwgaW5kZXg6IDxpbmRleD4pW119IEFycmF5IHJlcHJlc2VudGluZyBhIHBhdGggdG8gdGhlXG4vLyAgIHRhcmdldCB0b2tlbi4gVGhlIHJvb3QgdG9rZW4gaXMgcmVwcmVzZW50ZWQgYnkgdGhlIGZpcnN0IGVsZW1lbnQgaW4gdGhlXG4vLyAgIGFycmF5IGFuZCB0aGUgdGFyZ2V0IHRva2VuIGJ5IHRoZSBsYXN0IGVsbWVudC4gRWFjaCBlbGVtZW50IGNvbnNpc3RzIG9mIGFcbi8vICAgYHRhZ2AgYW5kIGBpbmRleGAgcmVwcmVzZW50aW5nIGl0cyBpbmRleCBhbW9uZ3N0IGl0cyBzaWJsaW5nIHRva2VucyBpblxuLy8gICBgdG9rZW5zYCBvZiB0aGUgc2FtZSBgdGFnYC4gYGxpbmVgIHdpbGwgbGllIGJldHdlZW4gdGhlIHByb3BlcnRpZXNcbi8vICAgYG1hcFswXWAgYW5kIGBtYXBbMV1gIG9mIHRoZSB0YXJnZXQgdG9rZW4uXG4vL1xuZXhwb3J0IGZ1bmN0aW9uIGdldFBhdGhUb1Rva2VuKHRva2VuczogVG9rZW5bXSwgbGluZTogbnVtYmVyKSB7XG4gIGxldCBwYXRoVG9Ub2tlbjogQXJyYXk8eyB0YWc6IHN0cmluZzsgaW5kZXg6IG51bWJlciB9PiA9IFtdXG4gIGxldCB0b2tlblRhZ0NvdW50OiB7IFtrZXk6IHN0cmluZ106IG51bWJlciB8IHVuZGVmaW5lZCB9ID0ge31cbiAgbGV0IGxldmVsID0gMFxuXG4gIGZvciAoY29uc3QgdG9rZW4gb2YgdG9rZW5zKSB7XG4gICAgaWYgKHRva2VuLmxldmVsIDwgbGV2ZWwpIHtcbiAgICAgIGJyZWFrXG4gICAgfVxuICAgIGlmICh0b2tlbi5oaWRkZW4pIHtcbiAgICAgIGNvbnRpbnVlXG4gICAgfVxuICAgIGlmICh0b2tlbi5uZXN0aW5nID09PSAtMSkge1xuICAgICAgY29udGludWVcbiAgICB9XG5cbiAgICBjb25zdCB0YWcgPSBkZWNvZGVUYWcodG9rZW4pXG4gICAgaWYgKHRhZyA9PT0gbnVsbCkge1xuICAgICAgY29udGludWVcbiAgICB9XG4gICAgdG9rZW4udGFnID0gdGFnXG5cbiAgICBpZiAoXG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6c3RyaWN0LXR5cGUtcHJlZGljYXRlcyAvLyBUT0RPOiBjb21wbGFpbiBvbiBEVFxuICAgICAgdG9rZW4ubWFwICE9IG51bGwgJiYgLy8gdG9rZW4ubWFwICpjYW4qIGJlIG51bGxcbiAgICAgIGxpbmUgPj0gdG9rZW4ubWFwWzBdICYmXG4gICAgICBsaW5lIDw9IHRva2VuLm1hcFsxXSAtIDFcbiAgICApIHtcbiAgICAgIGlmICh0b2tlbi5uZXN0aW5nID09PSAxKSB7XG4gICAgICAgIHBhdGhUb1Rva2VuLnB1c2goe1xuICAgICAgICAgIHRhZzogdG9rZW4udGFnLFxuICAgICAgICAgIGluZGV4OiB0b2tlblRhZ0NvdW50W3Rva2VuLnRhZ10gfHwgMCxcbiAgICAgICAgfSlcbiAgICAgICAgdG9rZW5UYWdDb3VudCA9IHt9XG4gICAgICAgIGxldmVsKytcbiAgICAgIH0gZWxzZSBpZiAodG9rZW4ubmVzdGluZyA9PT0gMCkge1xuICAgICAgICBwYXRoVG9Ub2tlbi5wdXNoKHtcbiAgICAgICAgICB0YWc6IHRva2VuLnRhZyxcbiAgICAgICAgICBpbmRleDogdG9rZW5UYWdDb3VudFt0b2tlbi50YWddIHx8IDAsXG4gICAgICAgIH0pXG4gICAgICAgIGJyZWFrXG4gICAgICB9XG4gICAgfSBlbHNlIGlmICh0b2tlbi5sZXZlbCA9PT0gbGV2ZWwpIHtcbiAgICAgIGlmICh0b2tlblRhZ0NvdW50W3Rva2VuLnRhZ10gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0b2tlblRhZ0NvdW50W3Rva2VuLnRhZ10hKytcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRva2VuVGFnQ291bnRbdG9rZW4udGFnXSA9IDFcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwYXRoVG9Ub2tlbiA9IGJ1YmJsZVRvQ29udGFpbmVyVG9rZW4ocGF0aFRvVG9rZW4pXG4gIHJldHVybiBwYXRoVG9Ub2tlblxufVxuXG5leHBvcnQgY29uc3QgbWF0aEpheFNjcmlwdCA9IGBcXFxuPHNjcmlwdCB0eXBlPVwidGV4dC94LW1hdGhqYXgtY29uZmlnXCI+XG5NYXRoSmF4Lkh1Yi5Db25maWcoe1xuamF4OiBbXCJpbnB1dC9UZVhcIixcIm91dHB1dC9IVE1MLUNTU1wiXSxcbmV4dGVuc2lvbnM6IFtdLFxuVGVYOiB7XG5leHRlbnNpb25zOiBbXCJBTVNtYXRoLmpzXCIsXCJBTVNzeW1ib2xzLmpzXCIsXCJub0Vycm9ycy5qc1wiLFwibm9VbmRlZmluZWQuanNcIl1cbn0sXG5zaG93TWF0aE1lbnU6IGZhbHNlXG59KTtcbjwvc2NyaXB0PlxuPHNjcmlwdCB0eXBlPVwidGV4dC9qYXZhc2NyaXB0XCIgc3JjPVwiaHR0cHM6Ly9jZG4ubWF0aGpheC5vcmcvbWF0aGpheC9sYXRlc3QvTWF0aEpheC5qc1wiPlxuPC9zY3JpcHQ+XFxcbmBcblxuZXhwb3J0IGZ1bmN0aW9uIG1rSHRtbChcbiAgdGl0bGU6IHN0cmluZyxcbiAgaHRtbDogSFRNTERvY3VtZW50LFxuICByZW5kZXJMYVRlWDogYm9vbGVhbixcbiAgdXNlR2l0aHViU3R5bGU6IGJvb2xlYW4sXG4pIHtcbiAgY29uc3QgZ2l0aHViU3R5bGUgPSB1c2VHaXRodWJTdHlsZSA/ICcgZGF0YS11c2UtZ2l0aHViLXN0eWxlJyA6ICcnXG4gIGxldCBtYXliZU1hdGhKYXhTY3JpcHRcbiAgaWYgKHJlbmRlckxhVGVYKSB7XG4gICAgbWF5YmVNYXRoSmF4U2NyaXB0ID0gbWF0aEpheFNjcmlwdFxuICB9IGVsc2Uge1xuICAgIG1heWJlTWF0aEpheFNjcmlwdCA9ICcnXG4gIH1cbiAgcmV0dXJuIGBcXFxuPCFET0NUWVBFIGh0bWw+XG48aHRtbD5cbiAgPGhlYWQ+XG4gICAgPG1ldGEgY2hhcnNldD1cInV0Zi04XCIgLz5cbiAgICA8dGl0bGU+JHt0aXRsZX08L3RpdGxlPiR7bWF5YmVNYXRoSmF4U2NyaXB0fVxuICAgIDxzdHlsZT4ke2dldE1hcmtkb3duUHJldmlld0NTUygpfTwvc3R5bGU+XG4ke2h0bWwuaGVhZC5pbm5lckhUTUx9XG4gIDwvaGVhZD5cbiAgPGJvZHkgY2xhc3M9XCJtYXJrZG93bi1wcmV2aWV3LXBsdXMtdmlld1wiJHtnaXRodWJTdHlsZX0+XG4gICAgJHtodG1sLmJvZHkuaW5uZXJIVE1MfVxuICA8L2JvZHk+XG48L2h0bWw+XG5gIC8vIEVuc3VyZSB0cmFpbGluZyBuZXdsaW5lXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBkZXN0cm95KGl0ZW06IG9iamVjdCkge1xuICBjb25zdCBwYW5lID0gYXRvbS53b3Jrc3BhY2UucGFuZUZvckl0ZW0oaXRlbSlcbiAgaWYgKHBhbmUpIGhhbmRsZVByb21pc2UocGFuZS5kZXN0cm95SXRlbShpdGVtKSlcbn1cbiJdfQ==