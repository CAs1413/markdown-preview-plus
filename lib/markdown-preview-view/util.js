"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const fs = require("fs");
const util_1 = require("../util");
function editorForId(editorId) {
    for (const editor of atom.workspace.getTextEditors()) {
        if (editor.id === editorId) {
            return editor;
        }
    }
    return undefined;
}
exports.editorForId = editorForId;
let getStylesOverride = undefined;
function __setGetStylesOverride(f) {
    getStylesOverride = f;
}
exports.__setGetStylesOverride = __setGetStylesOverride;
function* getStyles(context) {
    const elements = atom.styles.getStyleElements();
    for (const element of elements) {
        if (context === undefined || element.getAttribute('context') === context) {
            yield element.innerText;
        }
    }
}
function getClientStyle(file) {
    return atom.themes.loadStylesheet(path.join(__dirname, '..', '..', 'styles-client', `${file}.less`));
}
function getUserStyles() {
    const el = atom.styles.styleElementsBySourcePath[atom.styles.getUserStyleSheetPath()];
    if (!el)
        return [];
    return [el.innerText];
}
exports.getUserStyles = getUserStyles;
function getSyntaxTheme(themeName) {
    if (themeName !== '') {
        const themes = atom.themes.getLoadedThemes();
        if (themes) {
            const [theme] = themes.filter((x) => x.name === themeName);
            if (theme) {
                const stshts = theme
                    .getStylesheetPaths()
                    .map((p) => atom.themes.loadStylesheet(p));
                return processEditorStyles(stshts);
            }
        }
        atom.notifications.addWarning('Failed to load syntax theme', {
            detail: `Markdown-preview-plus couldn't find '${themeName}'`,
        });
    }
    return processEditorStyles(getStyles('atom-text-editor'));
}
function* getActivePackageStyles(packageName) {
    const pack = atom.packages.getActivePackage(packageName);
    if (!pack)
        return undefined;
    const stylesheets = pack.getStylesheetPaths();
    for (const ss of stylesheets) {
        const element = atom.styles.styleElementsBySourcePath[ss];
        if (element)
            yield element.innerText;
    }
}
function getPreviewStyles(display) {
    if (getStylesOverride)
        return getStylesOverride(display);
    const styles = [];
    if (display) {
        const packList = util_1.atomConfig().importPackageStyles;
        if (packList.includes('*')) {
            styles.push(...processEditorStyles(getStyles()));
            styles.push(getClientStyle('patch'));
        }
        else {
            for (const pack of packList) {
                styles.push(...processEditorStyles(getActivePackageStyles(pack)));
            }
            if (packList.includes('fonts')) {
                const fontsVar = atom.styles.styleElementsBySourcePath['fonts-package-editorfont'];
                if (fontsVar)
                    styles.push(...processEditorStyles([fontsVar.innerText]));
            }
        }
    }
    styles.push(getClientStyle('generic'));
    if (display)
        styles.push(getClientStyle('display'));
    if (util_1.atomConfig().useGitHubStyle) {
        styles.push(getClientStyle('github'));
    }
    else {
        styles.push(getClientStyle('default'));
    }
    styles.push(...getSyntaxTheme(util_1.atomConfig().syntaxThemeName));
    styles.push(...processEditorStyles(getUserStyles()));
    return styles;
}
exports.getPreviewStyles = getPreviewStyles;
function* processEditorStyles(styles) {
    for (const style of styles) {
        yield style.replace(/\batom-text-editor\b/g, 'pre.editor-colors');
    }
}
function getMarkdownPreviewCSS() {
    const cssUrlRefExp = /url\(atom:\/\/markdown-preview-plus\/assets\/(.*)\)/;
    return getPreviewStyles(false)
        .join('\n')
        .replace(cssUrlRefExp, function (_match, assetsName, _offset, _string) {
        const assetPath = path.join(__dirname, '../../assets', assetsName);
        const originalData = fs.readFileSync(assetPath, 'binary');
        const base64Data = new Buffer(originalData, 'binary').toString('base64');
        return `url('data:image/jpeg;base64,${base64Data}')`;
    });
}
function decodeTag(token) {
    if (token.tag === 'math') {
        return 'span';
    }
    if (token.tag === 'code') {
        return 'atom-text-editor';
    }
    if (token.tag === '') {
        return null;
    }
    return token.tag;
}
function buildLineMap(tokens) {
    const lineMap = {};
    const tokenTagCount = {};
    tokenTagCount[0] = {};
    for (const token of tokens) {
        if (token.hidden)
            continue;
        if (token.map == null)
            continue;
        const tag = decodeTag(token);
        if (tag === null)
            continue;
        if (token.nesting === 1) {
            for (let line = token.map[0]; line < token.map[1]; line += 1) {
                if (lineMap[line] == null)
                    lineMap[line] = [];
                lineMap[line].push({
                    tag: tag,
                    index: tokenTagCount[token.level][tag] || 0,
                });
            }
            tokenTagCount[token.level + 1] = {};
        }
        else if (token.nesting === 0) {
            for (let line = token.map[0]; line < token.map[1]; line += 1) {
                if (lineMap[line] == null)
                    lineMap[line] = [];
                lineMap[line].push({
                    tag: tag,
                    index: tokenTagCount[token.level][tag] || 0,
                });
            }
        }
        const ttc = tokenTagCount[token.level][tag];
        tokenTagCount[token.level][tag] = ttc ? ttc + 1 : 1;
    }
    return lineMap;
}
exports.buildLineMap = buildLineMap;
function mathJaxScript(texConfig) {
    return `\
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    jax: ["input/TeX","output/HTML-CSS"],
    extensions: ["[a11y]/accessibility-menu.js"],
    'HTML-CSS': {
      availableFonts: [],
      webFont: 'TeX',
      undefinedFamily: ${JSON.stringify(util_1.atomConfig().mathConfig.undefinedFamily)},
      mtextFontInherit: true,
    },
    TeX: ${JSON.stringify(texConfig, undefined, 2)},
    showMathMenu: true
  });
</script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js"></script>`;
}
function mkHtml(title, html, renderLaTeX, texConfig) {
    let maybeMathJaxScript;
    if (renderLaTeX) {
        maybeMathJaxScript = mathJaxScript(texConfig);
    }
    else {
        maybeMathJaxScript = '';
    }
    return `\
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>${title}</title>${maybeMathJaxScript}
    <style>${getMarkdownPreviewCSS()}</style>
${html.head.innerHTML}
  </head>
  <body>
    ${html.body.innerHTML}
  </body>
</html>
`;
}
exports.mkHtml = mkHtml;
function destroy(item) {
    const pane = atom.workspace.paneForItem(item);
    if (pane)
        util_1.handlePromise(pane.destroyItem(item));
}
exports.destroy = destroy;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tYXJrZG93bi1wcmV2aWV3LXZpZXcvdXRpbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLDZCQUE0QjtBQUM1Qix5QkFBd0I7QUFFeEIsa0NBQW1EO0FBRW5ELFNBQWdCLFdBQVcsQ0FBQyxRQUFnQjtJQUMxQyxLQUFLLE1BQU0sTUFBTSxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsY0FBYyxFQUFFLEVBQUU7UUFDcEQsSUFBSSxNQUFNLENBQUMsRUFBRSxLQUFLLFFBQVEsRUFBRTtZQUMxQixPQUFPLE1BQU0sQ0FBQTtTQUNkO0tBQ0Y7SUFDRCxPQUFPLFNBQVMsQ0FBQTtBQUNsQixDQUFDO0FBUEQsa0NBT0M7QUFHRCxJQUFJLGlCQUFpQixHQUF3QyxTQUFTLENBQUE7QUFFdEUsU0FBZ0Isc0JBQXNCLENBQUMsQ0FBMkI7SUFDaEUsaUJBQWlCLEdBQUcsQ0FBQyxDQUFBO0FBQ3ZCLENBQUM7QUFGRCx3REFFQztBQUVELFFBQVEsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxPQUF1QjtJQUN6QyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLGdCQUFnQixFQUFFLENBQUE7SUFFL0MsS0FBSyxNQUFNLE9BQU8sSUFBSSxRQUFRLEVBQUU7UUFDOUIsSUFBSSxPQUFPLEtBQUssU0FBUyxJQUFJLE9BQU8sQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLEtBQUssT0FBTyxFQUFFO1lBQ3hFLE1BQU0sT0FBTyxDQUFDLFNBQVMsQ0FBQTtTQUN4QjtLQUNGO0FBQ0gsQ0FBQztBQUVELFNBQVMsY0FBYyxDQUFDLElBQVk7SUFDbEMsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLGNBQWMsQ0FDL0IsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxlQUFlLEVBQUUsR0FBRyxJQUFJLE9BQU8sQ0FBQyxDQUNsRSxDQUFBO0FBQ0gs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SSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFBO0FBQ2pELENBQUM7QUFIRCwwQkFHQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRleHRFZGl0b3IgfSBmcm9tICdhdG9tJ1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJ1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnXG5pbXBvcnQgeyBUb2tlbiB9IGZyb20gJ21hcmtkb3duLWl0J1xuaW1wb3J0IHsgaGFuZGxlUHJvbWlzZSwgYXRvbUNvbmZpZyB9IGZyb20gJy4uL3V0aWwnXG5cbmV4cG9ydCBmdW5jdGlvbiBlZGl0b3JGb3JJZChlZGl0b3JJZDogbnVtYmVyKTogVGV4dEVkaXRvciB8IHVuZGVmaW5lZCB7XG4gIGZvciAoY29uc3QgZWRpdG9yIG9mIGF0b20ud29ya3NwYWNlLmdldFRleHRFZGl0b3JzKCkpIHtcbiAgICBpZiAoZWRpdG9yLmlkID09PSBlZGl0b3JJZCkge1xuICAgICAgcmV0dXJuIGVkaXRvclxuICAgIH1cbiAgfVxuICByZXR1cm4gdW5kZWZpbmVkXG59XG5cbi8vIHRoaXMgd2VpcmRuZXNzIGFsbG93cyBvdmVycmlkaW5nIGluIHRlc3RzXG5sZXQgZ2V0U3R5bGVzT3ZlcnJpZGU6IHR5cGVvZiBnZXRQcmV2aWV3U3R5bGVzIHwgdW5kZWZpbmVkID0gdW5kZWZpbmVkXG5cbmV4cG9ydCBmdW5jdGlvbiBfX3NldEdldFN0eWxlc092ZXJyaWRlKGY/OiB0eXBlb2YgZ2V0UHJldmlld1N0eWxlcykge1xuICBnZXRTdHlsZXNPdmVycmlkZSA9IGZcbn1cblxuZnVuY3Rpb24qIGdldFN0eWxlcyhjb250ZXh0Pzogc3RyaW5nIHwgbnVsbCk6IEl0ZXJhYmxlSXRlcmF0b3I8c3RyaW5nPiB7XG4gIGNvbnN0IGVsZW1lbnRzID0gYXRvbS5zdHlsZXMuZ2V0U3R5bGVFbGVtZW50cygpXG5cbiAgZm9yIChjb25zdCBlbGVtZW50IG9mIGVsZW1lbnRzKSB7XG4gICAgaWYgKGNvbnRleHQgPT09IHVuZGVmaW5lZCB8fCBlbGVtZW50LmdldEF0dHJpYnV0ZSgnY29udGV4dCcpID09PSBjb250ZXh0KSB7XG4gICAgICB5aWVsZCBlbGVtZW50LmlubmVyVGV4dFxuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBnZXRDbGllbnRTdHlsZShmaWxlOiBzdHJpbmcpOiBzdHJpbmcge1xuICByZXR1cm4gYXRvbS50aGVtZXMubG9hZFN0eWxlc2hlZXQoXG4gICAgcGF0aC5qb2luKF9fZGlybmFtZSwgJy4uJywgJy4uJywgJ3N0eWxlcy1jbGllbnQnLCBgJHtmaWxlfS5sZXNzYCksXG4gIClcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFVzZXJTdHlsZXMoKSB7XG4gIGNvbnN0IGVsID1cbiAgICBhdG9tLnN0eWxlcy5zdHlsZUVsZW1lbnRzQnlTb3VyY2VQYXRoW2F0b20uc3R5bGVzLmdldFVzZXJTdHlsZVNoZWV0UGF0aCgpXVxuICBpZiAoIWVsKSByZXR1cm4gW11cbiAgcmV0dXJuIFtlbC5pbm5lclRleHRdXG59XG5cbmZ1bmN0aW9uIGdldFN5bnRheFRoZW1lKHRoZW1lTmFtZTogc3RyaW5nKTogSXRlcmFibGU8c3RyaW5nPiB7XG4gIGlmICh0aGVtZU5hbWUgIT09ICcnKSB7XG4gICAgY29uc3QgdGhlbWVzID0gYXRvbS50aGVtZXMuZ2V0TG9hZGVkVGhlbWVzKClcbiAgICBpZiAodGhlbWVzKSB7XG4gICAgICBjb25zdCBbdGhlbWVdID0gdGhlbWVzLmZpbHRlcigoeCkgPT4geC5uYW1lID09PSB0aGVtZU5hbWUpXG4gICAgICBpZiAodGhlbWUpIHtcbiAgICAgICAgY29uc3Qgc3RzaHRzID0gdGhlbWVcbiAgICAgICAgICAuZ2V0U3R5bGVzaGVldFBhdGhzKClcbiAgICAgICAgICAubWFwKChwKSA9PiBhdG9tLnRoZW1lcy5sb2FkU3R5bGVzaGVldChwKSlcbiAgICAgICAgcmV0dXJuIHByb2Nlc3NFZGl0b3JTdHlsZXMoc3RzaHRzKVxuICAgICAgfVxuICAgIH1cbiAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkV2FybmluZygnRmFpbGVkIHRvIGxvYWQgc3ludGF4IHRoZW1lJywge1xuICAgICAgZGV0YWlsOiBgTWFya2Rvd24tcHJldmlldy1wbHVzIGNvdWxkbid0IGZpbmQgJyR7dGhlbWVOYW1lfSdgLFxuICAgIH0pXG4gIH1cbiAgLy8gZGVmYXVsdFxuICByZXR1cm4gcHJvY2Vzc0VkaXRvclN0eWxlcyhnZXRTdHlsZXMoJ2F0b20tdGV4dC1lZGl0b3InKSlcbn1cblxuZnVuY3Rpb24qIGdldEFjdGl2ZVBhY2thZ2VTdHlsZXMoXG4gIHBhY2thZ2VOYW1lOiBzdHJpbmcsXG4pOiBJdGVyYWJsZUl0ZXJhdG9yPHN0cmluZz4ge1xuICBjb25zdCBwYWNrID0gYXRvbS5wYWNrYWdlcy5nZXRBY3RpdmVQYWNrYWdlKHBhY2thZ2VOYW1lKVxuICBpZiAoIXBhY2spIHJldHVybiB1bmRlZmluZWRcbiAgY29uc3Qgc3R5bGVzaGVldHMgPSBwYWNrLmdldFN0eWxlc2hlZXRQYXRocygpXG4gIGZvciAoY29uc3Qgc3Mgb2Ygc3R5bGVzaGVldHMpIHtcbiAgICBjb25zdCBlbGVtZW50ID0gYXRvbS5zdHlsZXMuc3R5bGVFbGVtZW50c0J5U291cmNlUGF0aFtzc11cbiAgICBpZiAoZWxlbWVudCkgeWllbGQgZWxlbWVudC5pbm5lclRleHRcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0UHJldmlld1N0eWxlcyhkaXNwbGF5OiBib29sZWFuKTogc3RyaW5nW10ge1xuICBpZiAoZ2V0U3R5bGVzT3ZlcnJpZGUpIHJldHVybiBnZXRTdHlsZXNPdmVycmlkZShkaXNwbGF5KVxuICBjb25zdCBzdHlsZXMgPSBbXVxuICBpZiAoZGlzcGxheSkge1xuICAgIGNvbnN0IHBhY2tMaXN0ID0gYXRvbUNvbmZpZygpLmltcG9ydFBhY2thZ2VTdHlsZXNcbiAgICBpZiAocGFja0xpc3QuaW5jbHVkZXMoJyonKSkge1xuICAgICAgc3R5bGVzLnB1c2goLi4ucHJvY2Vzc0VkaXRvclN0eWxlcyhnZXRTdHlsZXMoKSkpXG4gICAgICBzdHlsZXMucHVzaChnZXRDbGllbnRTdHlsZSgncGF0Y2gnKSlcbiAgICB9IGVsc2Uge1xuICAgICAgZm9yIChjb25zdCBwYWNrIG9mIHBhY2tMaXN0KSB7XG4gICAgICAgIHN0eWxlcy5wdXNoKC4uLnByb2Nlc3NFZGl0b3JTdHlsZXMoZ2V0QWN0aXZlUGFja2FnZVN0eWxlcyhwYWNrKSkpXG4gICAgICB9XG4gICAgICAvLyBleHBsaWNpdCBjb21wYXRpYmlsaXR5IHdpdGggdGhlIGZvbnRzIHBhY2thZ2VcbiAgICAgIGlmIChwYWNrTGlzdC5pbmNsdWRlcygnZm9udHMnKSkge1xuICAgICAgICBjb25zdCBmb250c1ZhciA9XG4gICAgICAgICAgYXRvbS5zdHlsZXMuc3R5bGVFbGVtZW50c0J5U291cmNlUGF0aFsnZm9udHMtcGFja2FnZS1lZGl0b3Jmb250J11cbiAgICAgICAgaWYgKGZvbnRzVmFyKSBzdHlsZXMucHVzaCguLi5wcm9jZXNzRWRpdG9yU3R5bGVzKFtmb250c1Zhci5pbm5lclRleHRdKSlcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBzdHlsZXMucHVzaChnZXRDbGllbnRTdHlsZSgnZ2VuZXJpYycpKVxuICBpZiAoZGlzcGxheSkgc3R5bGVzLnB1c2goZ2V0Q2xpZW50U3R5bGUoJ2Rpc3BsYXknKSlcbiAgaWYgKGF0b21Db25maWcoKS51c2VHaXRIdWJTdHlsZSkge1xuICAgIHN0eWxlcy5wdXNoKGdldENsaWVudFN0eWxlKCdnaXRodWInKSlcbiAgfSBlbHNlIHtcbiAgICBzdHlsZXMucHVzaChnZXRDbGllbnRTdHlsZSgnZGVmYXVsdCcpKVxuICB9XG4gIHN0eWxlcy5wdXNoKC4uLmdldFN5bnRheFRoZW1lKGF0b21Db25maWcoKS5zeW50YXhUaGVtZU5hbWUpKVxuICBzdHlsZXMucHVzaCguLi5wcm9jZXNzRWRpdG9yU3R5bGVzKGdldFVzZXJTdHlsZXMoKSkpXG4gIHJldHVybiBzdHlsZXNcbn1cblxuZnVuY3Rpb24qIHByb2Nlc3NFZGl0b3JTdHlsZXMoc3R5bGVzOiBJdGVyYWJsZTxzdHJpbmc+KSB7XG4gIGZvciAoY29uc3Qgc3R5bGUgb2Ygc3R5bGVzKSB7XG4gICAgeWllbGQgc3R5bGUucmVwbGFjZSgvXFxiYXRvbS10ZXh0LWVkaXRvclxcYi9nLCAncHJlLmVkaXRvci1jb2xvcnMnKVxuICB9XG59XG5cbmZ1bmN0aW9uIGdldE1hcmtkb3duUHJldmlld0NTUygpIHtcbiAgY29uc3QgY3NzVXJsUmVmRXhwID0gL3VybFxcKGF0b206XFwvXFwvbWFya2Rvd24tcHJldmlldy1wbHVzXFwvYXNzZXRzXFwvKC4qKVxcKS9cblxuICByZXR1cm4gZ2V0UHJldmlld1N0eWxlcyhmYWxzZSlcbiAgICAuam9pbignXFxuJylcbiAgICAucmVwbGFjZShjc3NVcmxSZWZFeHAsIGZ1bmN0aW9uKFxuICAgICAgX21hdGNoLFxuICAgICAgYXNzZXRzTmFtZTogc3RyaW5nLFxuICAgICAgX29mZnNldCxcbiAgICAgIF9zdHJpbmcsXG4gICAgKSB7XG4gICAgICAvLyBiYXNlNjQgZW5jb2RlIGFzc2V0c1xuICAgICAgY29uc3QgYXNzZXRQYXRoID0gcGF0aC5qb2luKF9fZGlybmFtZSwgJy4uLy4uL2Fzc2V0cycsIGFzc2V0c05hbWUpXG4gICAgICBjb25zdCBvcmlnaW5hbERhdGEgPSBmcy5yZWFkRmlsZVN5bmMoYXNzZXRQYXRoLCAnYmluYXJ5JylcbiAgICAgIGNvbnN0IGJhc2U2NERhdGEgPSBuZXcgQnVmZmVyKG9yaWdpbmFsRGF0YSwgJ2JpbmFyeScpLnRvU3RyaW5nKCdiYXNlNjQnKVxuICAgICAgcmV0dXJuIGB1cmwoJ2RhdGE6aW1hZ2UvanBlZztiYXNlNjQsJHtiYXNlNjREYXRhfScpYFxuICAgIH0pXG59XG5cbi8vXG4vLyBEZWNvZGUgdGFncyB1c2VkIGJ5IG1hcmtkb3duLWl0XG4vL1xuLy8gQHBhcmFtIHttYXJrZG93bi1pdC5Ub2tlbn0gdG9rZW4gRGVjb2RlIHRoZSB0YWcgb2YgdG9rZW4uXG4vLyBAcmV0dXJuIHtzdHJpbmd8bnVsbH0gRGVjb2RlZCB0YWcgb3IgYG51bGxgIGlmIHRoZSB0b2tlbiBoYXMgbm8gdGFnLlxuLy9cbmZ1bmN0aW9uIGRlY29kZVRhZyh0b2tlbjogVG9rZW4pOiBzdHJpbmcgfCBudWxsIHtcbiAgaWYgKHRva2VuLnRhZyA9PT0gJ21hdGgnKSB7XG4gICAgcmV0dXJuICdzcGFuJ1xuICB9XG4gIGlmICh0b2tlbi50YWcgPT09ICdjb2RlJykge1xuICAgIHJldHVybiAnYXRvbS10ZXh0LWVkaXRvcidcbiAgfVxuICBpZiAodG9rZW4udGFnID09PSAnJykge1xuICAgIHJldHVybiBudWxsXG4gIH1cbiAgcmV0dXJuIHRva2VuLnRhZ1xufVxuXG4vL1xuLy8gRGV0ZXJtaW5lIHBhdGggdG8gYSB0YXJnZXQgdG9rZW4uXG4vL1xuLy8gQHBhcmFtIHsobWFya2Rvd24taXQuVG9rZW4pW119IHRva2VucyBBcnJheSBvZiB0b2tlbnMgYXMgcmV0dXJuZWQgYnlcbi8vICAgYG1hcmtkb3duLWl0LnBhcnNlKClgLlxuLy8gQHBhcmFtIHtudW1iZXJ9IGxpbmUgTGluZSByZXByZXNlbnRpbmcgdGhlIHRhcmdldCB0b2tlbi5cbi8vIEByZXR1cm4geyh0YWc6IDx0YWc+LCBpbmRleDogPGluZGV4PilbXX0gQXJyYXkgcmVwcmVzZW50aW5nIGEgcGF0aCB0byB0aGVcbi8vICAgdGFyZ2V0IHRva2VuLiBUaGUgcm9vdCB0b2tlbiBpcyByZXByZXNlbnRlZCBieSB0aGUgZmlyc3QgZWxlbWVudCBpbiB0aGVcbi8vICAgYXJyYXkgYW5kIHRoZSB0YXJnZXQgdG9rZW4gYnkgdGhlIGxhc3QgZWxtZW50LiBFYWNoIGVsZW1lbnQgY29uc2lzdHMgb2YgYVxuLy8gICBgdGFnYCBhbmQgYGluZGV4YCByZXByZXNlbnRpbmcgaXRzIGluZGV4IGFtb25nc3QgaXRzIHNpYmxpbmcgdG9rZW5zIGluXG4vLyAgIGB0b2tlbnNgIG9mIHRoZSBzYW1lIGB0YWdgLiBgbGluZWAgd2lsbCBsaWUgYmV0d2VlbiB0aGUgcHJvcGVydGllc1xuLy8gICBgbWFwWzBdYCBhbmQgYG1hcFsxXWAgb2YgdGhlIHRhcmdldCB0b2tlbi5cbi8vXG5leHBvcnQgZnVuY3Rpb24gYnVpbGRMaW5lTWFwKHRva2VuczogUmVhZG9ubHlBcnJheTxSZWFkb25seTxUb2tlbj4+KSB7XG4gIGNvbnN0IGxpbmVNYXA6IHsgW2xpbmU6IG51bWJlcl06IEFycmF5PHsgdGFnOiBzdHJpbmc7IGluZGV4OiBudW1iZXIgfT4gfSA9IHt9XG4gIGNvbnN0IHRva2VuVGFnQ291bnQ6IHsgW2xpbmU6IG51bWJlcl06IHsgW3RhZzogc3RyaW5nXTogbnVtYmVyIH0gfSA9IHt9XG4gIHRva2VuVGFnQ291bnRbMF0gPSB7fVxuXG4gIGZvciAoY29uc3QgdG9rZW4gb2YgdG9rZW5zKSB7XG4gICAgaWYgKHRva2VuLmhpZGRlbikgY29udGludWVcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6c3RyaWN0LXR5cGUtcHJlZGljYXRlcyAvLyBUT0RPOiBjb21wbGFpbiBvbiBEVFxuICAgIGlmICh0b2tlbi5tYXAgPT0gbnVsbCkgY29udGludWVcblxuICAgIGNvbnN0IHRhZyA9IGRlY29kZVRhZyh0b2tlbilcbiAgICBpZiAodGFnID09PSBudWxsKSBjb250aW51ZVxuXG4gICAgaWYgKHRva2VuLm5lc3RpbmcgPT09IDEpIHtcbiAgICAgIC8vIG9wZW5pbmcgdGFnXG4gICAgICBmb3IgKGxldCBsaW5lID0gdG9rZW4ubWFwWzBdOyBsaW5lIDwgdG9rZW4ubWFwWzFdOyBsaW5lICs9IDEpIHtcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnN0cmljdC10eXBlLXByZWRpY2F0ZXNcbiAgICAgICAgaWYgKGxpbmVNYXBbbGluZV0gPT0gbnVsbCkgbGluZU1hcFtsaW5lXSA9IFtdXG4gICAgICAgIGxpbmVNYXBbbGluZV0ucHVzaCh7XG4gICAgICAgICAgdGFnOiB0YWcsXG4gICAgICAgICAgaW5kZXg6IHRva2VuVGFnQ291bnRbdG9rZW4ubGV2ZWxdW3RhZ10gfHwgMCxcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICAgIHRva2VuVGFnQ291bnRbdG9rZW4ubGV2ZWwgKyAxXSA9IHt9XG4gICAgfSBlbHNlIGlmICh0b2tlbi5uZXN0aW5nID09PSAwKSB7XG4gICAgICAvLyBzZWxmLWNsb3NpbmcgdGFnXG4gICAgICBmb3IgKGxldCBsaW5lID0gdG9rZW4ubWFwWzBdOyBsaW5lIDwgdG9rZW4ubWFwWzFdOyBsaW5lICs9IDEpIHtcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnN0cmljdC10eXBlLXByZWRpY2F0ZXNcbiAgICAgICAgaWYgKGxpbmVNYXBbbGluZV0gPT0gbnVsbCkgbGluZU1hcFtsaW5lXSA9IFtdXG4gICAgICAgIGxpbmVNYXBbbGluZV0ucHVzaCh7XG4gICAgICAgICAgdGFnOiB0YWcsXG4gICAgICAgICAgaW5kZXg6IHRva2VuVGFnQ291bnRbdG9rZW4ubGV2ZWxdW3RhZ10gfHwgMCxcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3QgdHRjID0gdG9rZW5UYWdDb3VudFt0b2tlbi5sZXZlbF1bdGFnXVxuICAgIHRva2VuVGFnQ291bnRbdG9rZW4ubGV2ZWxdW3RhZ10gPSB0dGMgPyB0dGMgKyAxIDogMVxuICB9XG5cbiAgcmV0dXJuIGxpbmVNYXBcbn1cblxuZnVuY3Rpb24gbWF0aEpheFNjcmlwdCh0ZXhDb25maWc6IE1hdGhKYXguVGVYSW5wdXRQcm9jZXNzb3IpIHtcbiAgcmV0dXJuIGBcXFxuPHNjcmlwdCB0eXBlPVwidGV4dC94LW1hdGhqYXgtY29uZmlnXCI+XG4gIE1hdGhKYXguSHViLkNvbmZpZyh7XG4gICAgamF4OiBbXCJpbnB1dC9UZVhcIixcIm91dHB1dC9IVE1MLUNTU1wiXSxcbiAgICBleHRlbnNpb25zOiBbXCJbYTExeV0vYWNjZXNzaWJpbGl0eS1tZW51LmpzXCJdLFxuICAgICdIVE1MLUNTUyc6IHtcbiAgICAgIGF2YWlsYWJsZUZvbnRzOiBbXSxcbiAgICAgIHdlYkZvbnQ6ICdUZVgnLFxuICAgICAgdW5kZWZpbmVkRmFtaWx5OiAke0pTT04uc3RyaW5naWZ5KFxuICAgICAgICBhdG9tQ29uZmlnKCkubWF0aENvbmZpZy51bmRlZmluZWRGYW1pbHksXG4gICAgICApfSxcbiAgICAgIG10ZXh0Rm9udEluaGVyaXQ6IHRydWUsXG4gICAgfSxcbiAgICBUZVg6ICR7SlNPTi5zdHJpbmdpZnkodGV4Q29uZmlnLCB1bmRlZmluZWQsIDIpfSxcbiAgICBzaG93TWF0aE1lbnU6IHRydWVcbiAgfSk7XG48L3NjcmlwdD5cbjxzY3JpcHQgdHlwZT1cInRleHQvamF2YXNjcmlwdFwiIHNyYz1cImh0dHBzOi8vY2RuanMuY2xvdWRmbGFyZS5jb20vYWpheC9saWJzL21hdGhqYXgvMi43LjQvTWF0aEpheC5qc1wiPjwvc2NyaXB0PmBcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1rSHRtbChcbiAgdGl0bGU6IHN0cmluZyxcbiAgaHRtbDogSFRNTERvY3VtZW50LFxuICByZW5kZXJMYVRlWDogYm9vbGVhbixcbiAgdGV4Q29uZmlnOiBNYXRoSmF4LlRlWElucHV0UHJvY2Vzc29yLFxuKSB7XG4gIGxldCBtYXliZU1hdGhKYXhTY3JpcHQ6IHN0cmluZ1xuICBpZiAocmVuZGVyTGFUZVgpIHtcbiAgICBtYXliZU1hdGhKYXhTY3JpcHQgPSBtYXRoSmF4U2NyaXB0KHRleENvbmZpZylcbiAgfSBlbHNlIHtcbiAgICBtYXliZU1hdGhKYXhTY3JpcHQgPSAnJ1xuICB9XG4gIHJldHVybiBgXFxcbjwhRE9DVFlQRSBodG1sPlxuPGh0bWw+XG4gIDxoZWFkPlxuICAgIDxtZXRhIGNoYXJzZXQ9XCJ1dGYtOFwiIC8+XG4gICAgPHRpdGxlPiR7dGl0bGV9PC90aXRsZT4ke21heWJlTWF0aEpheFNjcmlwdH1cbiAgICA8c3R5bGU+JHtnZXRNYXJrZG93blByZXZpZXdDU1MoKX08L3N0eWxlPlxuJHtodG1sLmhlYWQuaW5uZXJIVE1MfVxuICA8L2hlYWQ+XG4gIDxib2R5PlxuICAgICR7aHRtbC5ib2R5LmlubmVySFRNTH1cbiAgPC9ib2R5PlxuPC9odG1sPlxuYCAvLyBFbnN1cmUgdHJhaWxpbmcgbmV3bGluZVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZGVzdHJveShpdGVtOiBvYmplY3QpIHtcbiAgY29uc3QgcGFuZSA9IGF0b20ud29ya3NwYWNlLnBhbmVGb3JJdGVtKGl0ZW0pXG4gIGlmIChwYW5lKSBoYW5kbGVQcm9taXNlKHBhbmUuZGVzdHJveUl0ZW0oaXRlbSkpXG59XG4iXX0=