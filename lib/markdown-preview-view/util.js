"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const fs = require("fs");
const util_1 = require("../util");
function editorForId(editorId) {
    for (const editor of atom.workspace.getTextEditors()) {
        if (editor.id === editorId) {
            return editor;
        }
    }
    return undefined;
}
exports.editorForId = editorForId;
let getStylesOverride = undefined;
function __setGetStylesOverride(f) {
    getStylesOverride = f;
}
exports.__setGetStylesOverride = __setGetStylesOverride;
function getStyles(context) {
    if (getStylesOverride)
        return getStylesOverride(context);
    const textEditorStyles = document.createElement('atom-styles');
    textEditorStyles.initialize(atom.styles);
    textEditorStyles.setAttribute('context', context);
    return Array.from(textEditorStyles.childNodes).map((styleElement) => styleElement.innerText);
}
exports.getStyles = getStyles;
function getMarkdownPreviewCSS() {
    const markdowPreviewRules = ['body { padding: 0; margin: 0; }'];
    const cssUrlRefExp = /url\(atom:\/\/markdown-preview-plus\/assets\/(.*)\)/;
    return markdowPreviewRules
        .concat(getStyles('markdown-preview-plus'))
        .concat(getStyles('atom-text-editor'))
        .join('\n')
        .replace(/atom-text-editor/g, 'pre.editor-colors')
        .replace(cssUrlRefExp, function (_match, assetsName, _offset, _string) {
        const assetPath = path.join(__dirname, '../../assets', assetsName);
        const originalData = fs.readFileSync(assetPath, 'binary');
        const base64Data = new Buffer(originalData, 'binary').toString('base64');
        return `url('data:image/jpeg;base64,${base64Data}')`;
    });
}
exports.getMarkdownPreviewCSS = getMarkdownPreviewCSS;
function bubbleToContainerElement(element) {
    let testElement = element;
    for (;;) {
        const parent = testElement.parentElement;
        if (!parent)
            break;
        if (parent.classList.contains('MathJax_Display')) {
            return parent.parentElement;
        }
        if (parent.classList.contains('atom-text-editor')) {
            return parent;
        }
        testElement = parent;
    }
    return element;
}
exports.bubbleToContainerElement = bubbleToContainerElement;
function bubbleToContainerToken(pathToToken) {
    const end = pathToToken.length - 1;
    for (let i = 0; i <= end; i++) {
        if (pathToToken[i].tag === 'table') {
            return pathToToken.slice(0, i + 1);
        }
    }
    return pathToToken;
}
exports.bubbleToContainerToken = bubbleToContainerToken;
function encodeTag(element) {
    if (element.classList.contains('math')) {
        return 'math';
    }
    if (element.classList.contains('atom-text-editor')) {
        return 'code';
    }
    return element.tagName.toLowerCase();
}
exports.encodeTag = encodeTag;
function decodeTag(token) {
    if (token.tag === 'math') {
        return 'span';
    }
    if (token.tag === 'code') {
        return 'span';
    }
    if (token.tag === '') {
        return null;
    }
    return token.tag;
}
exports.decodeTag = decodeTag;
function getPathToElement(element) {
    if (element.tagName.toLowerCase() === 'markdown-preview-plus-view') {
        return [
            {
                tag: 'div',
                index: 0,
            },
        ];
    }
    element = bubbleToContainerElement(element);
    const tag = encodeTag(element);
    const siblings = element.parentElement.children;
    let siblingsCount = 0;
    for (const sibling of Array.from(siblings)) {
        const siblingTag = sibling.nodeType === 1 ? encodeTag(sibling) : null;
        if (sibling === element) {
            const pathToElement = getPathToElement(element.parentElement);
            pathToElement.push({
                tag,
                index: siblingsCount,
            });
            return pathToElement;
        }
        else if (siblingTag === tag) {
            siblingsCount++;
        }
    }
    throw new Error('failure in getPathToElement');
}
exports.getPathToElement = getPathToElement;
function getPathToToken(tokens, line) {
    let pathToToken = [];
    let tokenTagCount = {};
    let level = 0;
    for (const token of tokens) {
        if (token.level < level) {
            break;
        }
        if (token.hidden) {
            continue;
        }
        if (token.nesting === -1) {
            continue;
        }
        const tag = decodeTag(token);
        if (tag === null) {
            continue;
        }
        token.tag = tag;
        if (token.map != null &&
            line >= token.map[0] &&
            line <= token.map[1] - 1) {
            if (token.nesting === 1) {
                pathToToken.push({
                    tag: token.tag,
                    index: tokenTagCount[token.tag] || 0,
                });
                tokenTagCount = {};
                level++;
            }
            else if (token.nesting === 0) {
                pathToToken.push({
                    tag: token.tag,
                    index: tokenTagCount[token.tag] || 0,
                });
                break;
            }
        }
        else if (token.level === level) {
            if (tokenTagCount[token.tag] !== undefined) {
                tokenTagCount[token.tag]++;
            }
            else {
                tokenTagCount[token.tag] = 1;
            }
        }
    }
    pathToToken = bubbleToContainerToken(pathToToken);
    return pathToToken;
}
exports.getPathToToken = getPathToToken;
exports.mathJaxScript = `\
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
jax: ["input/TeX","output/HTML-CSS"],
extensions: [],
TeX: {
extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
},
showMathMenu: false
});
</script>
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js">
</script>\
`;
function mkHtml(title, html, renderLaTeX, useGithubStyle) {
    const githubStyle = useGithubStyle ? ' data-use-github-style' : '';
    let maybeMathJaxScript;
    if (renderLaTeX) {
        maybeMathJaxScript = exports.mathJaxScript;
    }
    else {
        maybeMathJaxScript = '';
    }
    return `\
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>${title}</title>${maybeMathJaxScript}
    <style>${getMarkdownPreviewCSS()}</style>
${html.head}
  </head>
  <body>
    <markdown-preview-plus-view${githubStyle}>
      ${html.body}
    </markdown-preview-plus-view>
  </body>
</html>
`;
}
exports.mkHtml = mkHtml;
function destroy(item) {
    const pane = atom.workspace.paneForItem(item);
    if (pane)
        util_1.handlePromise(pane.destroyItem(item));
}
exports.destroy = destroy;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tYXJrZG93bi1wcmV2aWV3LXZpZXcvdXRpbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLDZCQUE0QjtBQUM1Qix5QkFBd0I7QUFFeEIsa0NBQXVDO0FBRXZDLHFCQUE0QixRQUFnQjtJQUMxQyxHQUFHLENBQUMsQ0FBQyxNQUFNLE1BQU0sSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLGNBQWMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUNyRCxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsRUFBRSxLQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUM7WUFDM0IsTUFBTSxDQUFDLE1BQU0sQ0FBQTtRQUNmLENBQUM7SUFDSCxDQUFDO0lBQ0QsTUFBTSxDQUFDLFNBQVMsQ0FBQTtBQUNsQixDQUFDO0FBUEQsa0NBT0M7QUFHRCxJQUFJLGlCQUFpQixHQUFpQyxTQUFTLENBQUE7QUFFL0QsZ0NBQXVDLENBQW9CO0lBQ3pELGlCQUFpQixHQUFHLENBQUMsQ0FBQTtBQUN2QixDQUFDO0FBRkQsd0RBRUM7QUFFRCxtQkFBMEIsT0FBZTtJQUN2QyxFQUFFLENBQUMsQ0FBQyxpQkFBaUIsQ0FBQztRQUFDLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLENBQUMsQ0FBQTtJQUN4RCxNQUFNLGdCQUFnQixHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQzdDLGFBQWEsQ0FDOEMsQ0FBQTtJQUM3RCxnQkFBZ0IsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFBO0lBQ3hDLGdCQUFnQixDQUFDLFlBQVksQ0FBQyxTQUFTLEVBQUUsT0FBTyxDQUFDLENBQUE7SUFHakQsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxDQUFDLENBQUMsR0FBRyxDQUNoRCxDQUFDLFlBQVksRUFBRSxFQUFFLENBQUUsWUFBaUMsQ0FBQyxTQUFTLENBQy9ELENBQUE7QUFDSCxDQUFDO0FBWkQsOEJBWUM7QUFFRDtJQUNFLE1BQU0sbUJBQW1CLEdBQUcsQ0FBQyxpQ0FBaUMsQ0FBQyxDQUFBO0lBQy9ELE1BQU0sWUFBWSxHQUFHLHFEQUFxRCxDQUFBO0lBRTFFLE1BQU0sQ0FBQyxtQkFBbUI7U0FDdkIsTUFBTSxDQUFDLFNBQVMsQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO1NBQzFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsa0JBQWtCLENBQUMsQ0FBQztTQUNyQyxJQUFJLENBQUMsSUFBSSxDQUFDO1NBQ1YsT0FBTyxDQUFDLG1CQUFtQixFQUFFLG1CQUFtQixDQUFDO1NBQ2pELE9BQU8sQ0FBQyxZQUFZLEVBQUUsVUFDckIsTUFBTSxFQUNOLFVBQWtCLEVBQ2xCLE9BQU8sRUFDUCxPQUFPO1FBR1AsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsY0FBYyxFQUFFLFVBQVUsQ0FBQyxDQUFBO1FBQ2xFLE1BQU0sWUFBWSxHQUFHLEVBQUUsQ0FBQyxZQUFZLENBQUMsU0FBUyxFQUFFLFFBQVEsQ0FBQyxDQUFBO1FBQ3pELE1BQU0sVUFBVSxHQUFHLElBQUksTUFBTSxDQUFDLFlBQVksRUFBRSxRQUFRLENBQUMsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUE7UUFDeEUsTUFBTSxDQUFDLCtCQUErQixVQUFVLElBQUksQ0FBQTtJQUN0RCxDQUFDLENBQUMsQ0FBQTtBQUNOLENBQUM7QUFyQkQsc0RBcUJDO0FBV0Qsa0NBQXlDLE9BQW9CO0lBQzNELElBQUksV0FBVyxHQUFHLE9BQU8sQ0FBQTtJQUN6QixHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7UUFDUixNQUFNLE1BQU0sR0FBRyxXQUFXLENBQUMsYUFBYSxDQUFBO1FBQ3hDLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDO1lBQUMsS0FBSyxDQUFBO1FBQ2xCLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLGlCQUFpQixDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2pELE1BQU0sQ0FBQyxNQUFNLENBQUMsYUFBYyxDQUFBO1FBQzlCLENBQUM7UUFDRCxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNsRCxNQUFNLENBQUMsTUFBTSxDQUFBO1FBQ2YsQ0FBQztRQUNELFdBQVcsR0FBRyxNQUFNLENBQUE7SUFDdEIsQ0FBQztJQUNELE1BQU0sQ0FBQyxPQUFPLENBQUE7QUFDaEIsQ0FBQztBQWRELDREQWNDO0FBZUQsZ0NBQ0UsV0FBa0Q7SUFFbEQsTUFBTSxHQUFHLEdBQUcsV0FBVyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUE7SUFDbEMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsSUFBSSxHQUFHLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztRQUM5QixFQUFFLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxLQUFLLE9BQU8sQ0FBQyxDQUFDLENBQUM7WUFDbkMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQTtRQUNwQyxDQUFDO0lBQ0gsQ0FBQztJQUNELE1BQU0sQ0FBQyxXQUFXLENBQUE7QUFDcEIsQ0FBQztBQVZELHdEQVVDO0FBUUQsbUJBQTBCLE9BQW9CO0lBQzVDLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN2QyxNQUFNLENBQUMsTUFBTSxDQUFBO0lBQ2YsQ0FBQztJQUNELEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ25ELE1BQU0sQ0FBQyxNQUFNLENBQUE7SUFDZixDQUFDO0lBQ0QsTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsV0FBVyxFQUFFLENBQUE7QUFDdEMsQ0FBQztBQVJELDhCQVFDO0FBUUQsbUJBQTBCLEtBQVk7SUFDcEMsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsS0FBSyxNQUFNLENBQUMsQ0FBQyxDQUFDO1FBQ3pCLE1BQU0sQ0FBQyxNQUFNLENBQUE7SUFDZixDQUFDO0lBQ0QsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsS0FBSyxNQUFNLENBQUMsQ0FBQyxDQUFDO1FBQ3pCLE1BQU0sQ0FBQyxNQUFNLENBQUE7SUFDZixDQUFDO0lBQ0QsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3JCLE1BQU0sQ0FBQyxJQUFJLENBQUE7SUFDYixDQUFDO0lBQ0QsTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUE7QUFDbEIsQ0FBQztBQVhELDhCQVdDO0FBYUQsMEJBQ0UsT0FBb0I7SUFFcEIsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsS0FBSyw0QkFBNEIsQ0FBQyxDQUFDLENBQUM7UUFDbkUsTUFBTSxDQUFDO1lBQ0w7Z0JBQ0UsR0FBRyxFQUFFLEtBQUs7Z0JBQ1YsS0FBSyxFQUFFLENBQUM7YUFDVDtTQUNGLENBQUE7SUFDSCxDQUFDO0lBRUQsT0FBTyxHQUFHLHdCQUF3QixDQUFDLE9BQU8sQ0FBQyxDQUFBO0lBQzNDLE1BQU0sR0FBRyxHQUFHLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQTtJQUM5QixNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsYUFBYyxDQUFDLFFBQVEsQ0FBQTtJQUNoRCxJQUFJLGFBQWEsR0FBRyxDQUFDLENBQUE7SUFFckIsR0FBRyxDQUFDLENBQUMsTUFBTSxPQUFPLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDM0MsTUFBTSxVQUFVLEdBQ2QsT0FBTyxDQUFDLFFBQVEsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxPQUFzQixDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQTtRQUNuRSxFQUFFLENBQUMsQ0FBQyxPQUFPLEtBQUssT0FBTyxDQUFDLENBQUMsQ0FBQztZQUN4QixNQUFNLGFBQWEsR0FBRyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsYUFBYyxDQUFDLENBQUE7WUFDOUQsYUFBYSxDQUFDLElBQUksQ0FBQztnQkFDakIsR0FBRztnQkFDSCxLQUFLLEVBQUUsYUFBYTthQUNyQixDQUFDLENBQUE7WUFDRixNQUFNLENBQUMsYUFBYSxDQUFBO1FBQ3RCLENBQUM7UUFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsVUFBVSxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDOUIsYUFBYSxFQUFFLENBQUE7UUFDakIsQ0FBQztJQUNILENBQUM7SUFDRCxNQUFNLElBQUksS0FBSyxDQUFDLDZCQUE2QixDQUFDLENBQUE7QUFDaEQsQ0FBQztBQWhDRCw0Q0FnQ0M7QUFlRCx3QkFBK0IsTUFBZSxFQUFFLElBQVk7SUFDMUQsSUFBSSxXQUFXLEdBQTBDLEVBQUUsQ0FBQTtJQUMzRCxJQUFJLGFBQWEsR0FBMEMsRUFBRSxDQUFBO0lBQzdELElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQTtJQUViLEdBQUcsQ0FBQyxDQUFDLE1BQU0sS0FBSyxJQUFJLE1BQU0sQ0FBQyxDQUFDLENBQUM7UUFDM0IsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDO1lBQ3hCLEtBQUssQ0FBQTtRQUNQLENBQUM7UUFDRCxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUNqQixRQUFRLENBQUE7UUFDVixDQUFDO1FBQ0QsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDekIsUUFBUSxDQUFBO1FBQ1YsQ0FBQztRQUVELE1BQU0sR0FBRyxHQUFHLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUM1QixFQUFFLENBQUMsQ0FBQyxHQUFHLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FBQztZQUNqQixRQUFRLENBQUE7UUFDVixDQUFDO1FBQ0QsS0FBSyxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUE7UUFFZixFQUFFLENBQUMsQ0FFRCxLQUFLLENBQUMsR0FBRyxJQUFJLElBQUk7WUFDakIsSUFBSSxJQUFJLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ3BCLElBQUksSUFBSSxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQ3pCLENBQUMsQ0FBQyxDQUFDO1lBQ0QsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUN4QixXQUFXLENBQUMsSUFBSSxDQUFDO29CQUNmLEdBQUcsRUFBRSxLQUFLLENBQUMsR0FBRztvQkFDZCxLQUFLLEVBQUUsYUFBYSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDO2lCQUNyQyxDQUFDLENBQUE7Z0JBQ0YsYUFBYSxHQUFHLEVBQUUsQ0FBQTtnQkFDbEIsS0FBSyxFQUFFLENBQUE7WUFDVCxDQUFDO1lBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDL0IsV0FBVyxDQUFDLElBQUksQ0FBQztvQkFDZixHQUFHLEVBQUUsS0FBSyxDQUFDLEdBQUc7b0JBQ2QsS0FBSyxFQUFFLGFBQWEsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQztpQkFDckMsQ0FBQyxDQUFBO2dCQUNGLEtBQUssQ0FBQTtZQUNQLENBQUM7UUFDSCxDQUFDO1FBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxLQUFLLEtBQUssS0FBSyxDQUFDLENBQUMsQ0FBQztZQUNqQyxFQUFFLENBQUMsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUM7Z0JBQzNDLGFBQWEsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFFLEVBQUUsQ0FBQTtZQUM3QixDQUFDO1lBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ04sYUFBYSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUE7WUFDOUIsQ0FBQztRQUNILENBQUM7SUFDSCxDQUFDO0lBRUQsV0FBVyxHQUFHLHNCQUFzQixDQUFDLFdBQVcsQ0FBQyxDQUFBO0lBQ2pELE1BQU0sQ0FBQyxXQUFXLENBQUE7QUFDcEIsQ0FBQztBQXJERCx3Q0FxREM7QUFFWSxRQUFBLGFBQWEsR0FBRzs7Ozs7Ozs7Ozs7OztDQWE1QixDQUFBO0FBRUQsZ0JBQ0UsS0FBYSxFQUNiLElBQW9DLEVBQ3BDLFdBQW9CLEVBQ3BCLGNBQXVCO0lBRXZCLE1BQU0sV0FBVyxHQUFHLGNBQWMsQ0FBQyxDQUFDLENBQUMsd0JBQXdCLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQTtJQUNsRSxJQUFJLGtCQUFrQixDQUFBO0lBQ3RCLEVBQUUsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUM7UUFDaEIsa0JBQWtCLEdBQUcscUJBQWEsQ0FBQTtJQUNwQyxDQUFDO0lBQUMsSUFBSSxDQUFDLENBQUM7UUFDTixrQkFBa0IsR0FBRyxFQUFFLENBQUE7SUFDekIsQ0FBQztJQUNELE1BQU0sQ0FBQzs7Ozs7YUFLSSxLQUFLLFdBQVcsa0JBQWtCO2FBQ2xDLHFCQUFxQixFQUFFO0VBQ2xDLElBQUksQ0FBQyxJQUFJOzs7aUNBR3NCLFdBQVc7UUFDcEMsSUFBSSxDQUFDLElBQUk7Ozs7Q0FJaEIsQ0FBQTtBQUNELENBQUM7QUE3QkQsd0JBNkJDO0FBRUQsaUJBQXdCLElBQVk7SUFDbEMsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUE7SUFDN0MsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDO1FBQUMsb0JBQWEsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUE7QUFDakQsQ0FBQztBQUhELDBCQUdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGV4dEVkaXRvciwgU3R5bGVNYW5hZ2VyIH0gZnJvbSAnYXRvbSdcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCdcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJ1xuaW1wb3J0IHsgVG9rZW4gfSBmcm9tICdtYXJrZG93bi1pdCdcbmltcG9ydCB7IGhhbmRsZVByb21pc2UgfSBmcm9tICcuLi91dGlsJ1xuXG5leHBvcnQgZnVuY3Rpb24gZWRpdG9yRm9ySWQoZWRpdG9ySWQ6IG51bWJlcik6IFRleHRFZGl0b3IgfCB1bmRlZmluZWQge1xuICBmb3IgKGNvbnN0IGVkaXRvciBvZiBhdG9tLndvcmtzcGFjZS5nZXRUZXh0RWRpdG9ycygpKSB7XG4gICAgaWYgKGVkaXRvci5pZCA9PT0gZWRpdG9ySWQpIHtcbiAgICAgIHJldHVybiBlZGl0b3JcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHVuZGVmaW5lZFxufVxuXG4vLyB0aGlzIHdlaXJkbmVzcyBhbGxvd3Mgb3ZlcnJpZGluZyBpbiB0ZXN0c1xubGV0IGdldFN0eWxlc092ZXJyaWRlOiB0eXBlb2YgZ2V0U3R5bGVzIHwgdW5kZWZpbmVkID0gdW5kZWZpbmVkXG5cbmV4cG9ydCBmdW5jdGlvbiBfX3NldEdldFN0eWxlc092ZXJyaWRlKGY/OiB0eXBlb2YgZ2V0U3R5bGVzKSB7XG4gIGdldFN0eWxlc092ZXJyaWRlID0gZlxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0U3R5bGVzKGNvbnRleHQ6IHN0cmluZyk6IHN0cmluZ1tdIHtcbiAgaWYgKGdldFN0eWxlc092ZXJyaWRlKSByZXR1cm4gZ2V0U3R5bGVzT3ZlcnJpZGUoY29udGV4dClcbiAgY29uc3QgdGV4dEVkaXRvclN0eWxlcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXG4gICAgJ2F0b20tc3R5bGVzJyxcbiAgKSBhcyBIVE1MRWxlbWVudCAmIHsgaW5pdGlhbGl6ZShzdHlsZXM6IFN0eWxlTWFuYWdlcik6IHZvaWQgfVxuICB0ZXh0RWRpdG9yU3R5bGVzLmluaXRpYWxpemUoYXRvbS5zdHlsZXMpXG4gIHRleHRFZGl0b3JTdHlsZXMuc2V0QXR0cmlidXRlKCdjb250ZXh0JywgY29udGV4dClcblxuICAvLyBFeHRyYWN0IHN0eWxlIGVsZW1lbnRzIGNvbnRlbnRcbiAgcmV0dXJuIEFycmF5LmZyb20odGV4dEVkaXRvclN0eWxlcy5jaGlsZE5vZGVzKS5tYXAoXG4gICAgKHN0eWxlRWxlbWVudCkgPT4gKHN0eWxlRWxlbWVudCBhcyBIVE1MU3R5bGVFbGVtZW50KS5pbm5lclRleHQsXG4gIClcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldE1hcmtkb3duUHJldmlld0NTUygpIHtcbiAgY29uc3QgbWFya2Rvd1ByZXZpZXdSdWxlcyA9IFsnYm9keSB7IHBhZGRpbmc6IDA7IG1hcmdpbjogMDsgfSddXG4gIGNvbnN0IGNzc1VybFJlZkV4cCA9IC91cmxcXChhdG9tOlxcL1xcL21hcmtkb3duLXByZXZpZXctcGx1c1xcL2Fzc2V0c1xcLyguKilcXCkvXG5cbiAgcmV0dXJuIG1hcmtkb3dQcmV2aWV3UnVsZXNcbiAgICAuY29uY2F0KGdldFN0eWxlcygnbWFya2Rvd24tcHJldmlldy1wbHVzJykpXG4gICAgLmNvbmNhdChnZXRTdHlsZXMoJ2F0b20tdGV4dC1lZGl0b3InKSlcbiAgICAuam9pbignXFxuJylcbiAgICAucmVwbGFjZSgvYXRvbS10ZXh0LWVkaXRvci9nLCAncHJlLmVkaXRvci1jb2xvcnMnKVxuICAgIC5yZXBsYWNlKGNzc1VybFJlZkV4cCwgZnVuY3Rpb24oXG4gICAgICBfbWF0Y2gsXG4gICAgICBhc3NldHNOYW1lOiBzdHJpbmcsXG4gICAgICBfb2Zmc2V0LFxuICAgICAgX3N0cmluZyxcbiAgICApIHtcbiAgICAgIC8vIGJhc2U2NCBlbmNvZGUgYXNzZXRzXG4gICAgICBjb25zdCBhc3NldFBhdGggPSBwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vLi4vYXNzZXRzJywgYXNzZXRzTmFtZSlcbiAgICAgIGNvbnN0IG9yaWdpbmFsRGF0YSA9IGZzLnJlYWRGaWxlU3luYyhhc3NldFBhdGgsICdiaW5hcnknKVxuICAgICAgY29uc3QgYmFzZTY0RGF0YSA9IG5ldyBCdWZmZXIob3JpZ2luYWxEYXRhLCAnYmluYXJ5JykudG9TdHJpbmcoJ2Jhc2U2NCcpXG4gICAgICByZXR1cm4gYHVybCgnZGF0YTppbWFnZS9qcGVnO2Jhc2U2NCwke2Jhc2U2NERhdGF9JylgXG4gICAgfSlcbn1cblxuLy9cbi8vIEZpbmQgdGhlIGNsb3Nlc3QgYW5jZXN0b3Igb2YgYW4gZWxlbWVudCB0aGF0IGlzIG5vdCBhIGRlY2VuZGFudCBvZiBlaXRoZXJcbi8vIGBzcGFuLm1hdGhgIG9yIGBzcGFuLmF0b20tdGV4dC1lZGl0b3JgLlxuLy9cbi8vIEBwYXJhbSB7SFRNTEVsZW1lbnR9IGVsZW1lbnQgVGhlIGVsZW1lbnQgZnJvbSB3aGljaCB0aGUgc2VhcmNoIGZvciBhXG4vLyAgIGNsb3Nlc3QgYW5jZXN0b3IgYmVnaW5zLlxuLy8gQHJldHVybiB7SFRNTEVsZW1lbnR9IFRoZSBjbG9zZXN0IGFuY2VzdG9yIHRvIGBlbGVtZW50YCB0aGF0IGRvZXMgbm90XG4vLyAgIGNvbnRhaW4gZWl0aGVyIGBzcGFuLm1hdGhgIG9yIGBzcGFuLmF0b20tdGV4dC1lZGl0b3JgLlxuLy9cbmV4cG9ydCBmdW5jdGlvbiBidWJibGVUb0NvbnRhaW5lckVsZW1lbnQoZWxlbWVudDogSFRNTEVsZW1lbnQpOiBIVE1MRWxlbWVudCB7XG4gIGxldCB0ZXN0RWxlbWVudCA9IGVsZW1lbnRcbiAgZm9yICg7Oykge1xuICAgIGNvbnN0IHBhcmVudCA9IHRlc3RFbGVtZW50LnBhcmVudEVsZW1lbnRcbiAgICBpZiAoIXBhcmVudCkgYnJlYWtcbiAgICBpZiAocGFyZW50LmNsYXNzTGlzdC5jb250YWlucygnTWF0aEpheF9EaXNwbGF5JykpIHtcbiAgICAgIHJldHVybiBwYXJlbnQucGFyZW50RWxlbWVudCFcbiAgICB9XG4gICAgaWYgKHBhcmVudC5jbGFzc0xpc3QuY29udGFpbnMoJ2F0b20tdGV4dC1lZGl0b3InKSkge1xuICAgICAgcmV0dXJuIHBhcmVudFxuICAgIH1cbiAgICB0ZXN0RWxlbWVudCA9IHBhcmVudFxuICB9XG4gIHJldHVybiBlbGVtZW50XG59XG5cbi8vXG4vLyBEZXRlcm1pbmUgYSBzdWJzZXF1ZW5jZSBvZiBhIHNlcXVlbmNlIG9mIHRva2VucyByZXByZXNlbnRpbmcgYSBwYXRoIHRocm91Z2hcbi8vIEhUTUxFbGVtZW50cyB0aGF0IGRvZXMgbm90IGNvbnRpbnVlIGRlZXBlciB0aGFuIGEgdGFibGUgZWxlbWVudC5cbi8vXG4vLyBAcGFyYW0geyh0YWc6IDx0YWc+LCBpbmRleDogPGluZGV4PilbXX0gcGF0aFRvVG9rZW4gQXJyYXkgb2YgdG9rZW5zXG4vLyAgIHJlcHJlc2VudGluZyBhIHBhdGggdG8gYSBIVE1MRWxlbWVudCB3aXRoIHRoZSByb290IGVsZW1lbnQgYXRcbi8vICAgcGF0aFRvVG9rZW5bMF0gYW5kIHRoZSB0YXJnZXQgZWxlbWVudCBhdCB0aGUgaGlnaGVzdCBpbmRleC4gRWFjaCBlbGVtZW50XG4vLyAgIGNvbnNpc3RzIG9mIGEgYHRhZ2AgYW5kIGBpbmRleGAgcmVwcmVzZW50aW5nIGl0cyBpbmRleCBhbW9uZ3N0IGl0c1xuLy8gICBzaWJsaW5nIGVsZW1lbnRzIG9mIHRoZSBzYW1lIGB0YWdgLlxuLy8gQHJldHVybiB7KHRhZzogPHRhZz4sIGluZGV4OiA8aW5kZXg+KVtdfSBUaGUgc3Vic2VxdWVuY2Ugb2YgcGF0aFRvVG9rZW4gdGhhdFxuLy8gICBtYWludGFpbnMgdGhlIHNhbWUgcm9vdCBidXQgdGVybWluYXRlcyBhdCBhIHRhYmxlIGVsZW1lbnQgb3IgdGhlIHRhcmdldFxuLy8gICBlbGVtZW50LCB3aGljaGV2ZXIgY29tZXMgZmlyc3QuXG4vL1xuZXhwb3J0IGZ1bmN0aW9uIGJ1YmJsZVRvQ29udGFpbmVyVG9rZW4oXG4gIHBhdGhUb1Rva2VuOiBBcnJheTx7IHRhZzogc3RyaW5nOyBpbmRleDogbnVtYmVyIH0+LFxuKSB7XG4gIGNvbnN0IGVuZCA9IHBhdGhUb1Rva2VuLmxlbmd0aCAtIDFcbiAgZm9yIChsZXQgaSA9IDA7IGkgPD0gZW5kOyBpKyspIHtcbiAgICBpZiAocGF0aFRvVG9rZW5baV0udGFnID09PSAndGFibGUnKSB7XG4gICAgICByZXR1cm4gcGF0aFRvVG9rZW4uc2xpY2UoMCwgaSArIDEpXG4gICAgfVxuICB9XG4gIHJldHVybiBwYXRoVG9Ub2tlblxufVxuXG4vL1xuLy8gRW5jb2RlIHRhZ3MgZm9yIG1hcmtkb3duLWl0LlxuLy9cbi8vIEBwYXJhbSB7SFRNTEVsZW1lbnR9IGVsZW1lbnQgRW5jb2RlIHRoZSB0YWcgb2YgZWxlbWVudC5cbi8vIEByZXR1cm4ge3N0cmluZ30gRW5jb2RlZCB0YWcuXG4vL1xuZXhwb3J0IGZ1bmN0aW9uIGVuY29kZVRhZyhlbGVtZW50OiBIVE1MRWxlbWVudCk6IHN0cmluZyB7XG4gIGlmIChlbGVtZW50LmNsYXNzTGlzdC5jb250YWlucygnbWF0aCcpKSB7XG4gICAgcmV0dXJuICdtYXRoJ1xuICB9XG4gIGlmIChlbGVtZW50LmNsYXNzTGlzdC5jb250YWlucygnYXRvbS10ZXh0LWVkaXRvcicpKSB7XG4gICAgcmV0dXJuICdjb2RlJ1xuICB9IC8vIG9ubHkgdG9rZW4udHlwZSBpcyBgZmVuY2VgIGNvZGUgYmxvY2tzIHNob3VsZCBldmVyIGJlIGZvdW5kIGluIHRoZSBmaXJzdCBsZXZlbCBvZiB0aGUgdG9rZW5zIGFycmF5XG4gIHJldHVybiBlbGVtZW50LnRhZ05hbWUudG9Mb3dlckNhc2UoKVxufVxuXG4vL1xuLy8gRGVjb2RlIHRhZ3MgdXNlZCBieSBtYXJrZG93bi1pdFxuLy9cbi8vIEBwYXJhbSB7bWFya2Rvd24taXQuVG9rZW59IHRva2VuIERlY29kZSB0aGUgdGFnIG9mIHRva2VuLlxuLy8gQHJldHVybiB7c3RyaW5nfG51bGx9IERlY29kZWQgdGFnIG9yIGBudWxsYCBpZiB0aGUgdG9rZW4gaGFzIG5vIHRhZy5cbi8vXG5leHBvcnQgZnVuY3Rpb24gZGVjb2RlVGFnKHRva2VuOiBUb2tlbik6IHN0cmluZyB8IG51bGwge1xuICBpZiAodG9rZW4udGFnID09PSAnbWF0aCcpIHtcbiAgICByZXR1cm4gJ3NwYW4nXG4gIH1cbiAgaWYgKHRva2VuLnRhZyA9PT0gJ2NvZGUnKSB7XG4gICAgcmV0dXJuICdzcGFuJ1xuICB9XG4gIGlmICh0b2tlbi50YWcgPT09ICcnKSB7XG4gICAgcmV0dXJuIG51bGxcbiAgfVxuICByZXR1cm4gdG9rZW4udGFnXG59XG5cbi8vXG4vLyBEZXRlcm1pbmUgcGF0aCB0byBhIHRhcmdldCBlbGVtZW50IGZyb20gYSBjb250YWluZXIgYG1hcmtkb3duLXByZXZpZXctcGx1cy12aWV3YC5cbi8vXG4vLyBAcGFyYW0ge0hUTUxFbGVtZW50fSBlbGVtZW50IFRhcmdldCBIVE1MRWxlbWVudC5cbi8vIEByZXR1cm4geyh0YWc6IDx0YWc+LCBpbmRleDogPGluZGV4PilbXX0gQXJyYXkgb2YgdG9rZW5zIHJlcHJlc2VudGluZyBhIHBhdGhcbi8vICAgdG8gYGVsZW1lbnRgIGZyb20gYG1hcmtkb3duLXByZXZpZXctcGx1cy12aWV3YC4gVGhlIHJvb3QgYG1hcmtkb3duLXByZXZpZXctcGx1cy12aWV3YFxuLy8gICBlbGVtZW50IGlzIHRoZSBmaXJzdCBlbGVtZW50cyBpbiB0aGUgYXJyYXkgYW5kIHRoZSB0YXJnZXQgZWxlbWVudFxuLy8gICBgZWxlbWVudGAgYXQgdGhlIGhpZ2hlc3QgaW5kZXguIEVhY2ggZWxlbWVudCBjb25zaXN0cyBvZiBhIGB0YWdgIGFuZFxuLy8gICBgaW5kZXhgIHJlcHJlc2VudGluZyBpdHMgaW5kZXggYW1vbmdzdCBpdHMgc2libGluZyBlbGVtZW50cyBvZiB0aGUgc2FtZVxuLy8gICBgdGFnYC5cbi8vXG5leHBvcnQgZnVuY3Rpb24gZ2V0UGF0aFRvRWxlbWVudChcbiAgZWxlbWVudDogSFRNTEVsZW1lbnQsXG4pOiBBcnJheTx7IHRhZzogc3RyaW5nOyBpbmRleDogbnVtYmVyIH0+IHtcbiAgaWYgKGVsZW1lbnQudGFnTmFtZS50b0xvd2VyQ2FzZSgpID09PSAnbWFya2Rvd24tcHJldmlldy1wbHVzLXZpZXcnKSB7XG4gICAgcmV0dXJuIFtcbiAgICAgIHtcbiAgICAgICAgdGFnOiAnZGl2JyxcbiAgICAgICAgaW5kZXg6IDAsXG4gICAgICB9LFxuICAgIF1cbiAgfVxuXG4gIGVsZW1lbnQgPSBidWJibGVUb0NvbnRhaW5lckVsZW1lbnQoZWxlbWVudClcbiAgY29uc3QgdGFnID0gZW5jb2RlVGFnKGVsZW1lbnQpXG4gIGNvbnN0IHNpYmxpbmdzID0gZWxlbWVudC5wYXJlbnRFbGVtZW50IS5jaGlsZHJlblxuICBsZXQgc2libGluZ3NDb3VudCA9IDBcblxuICBmb3IgKGNvbnN0IHNpYmxpbmcgb2YgQXJyYXkuZnJvbShzaWJsaW5ncykpIHtcbiAgICBjb25zdCBzaWJsaW5nVGFnID1cbiAgICAgIHNpYmxpbmcubm9kZVR5cGUgPT09IDEgPyBlbmNvZGVUYWcoc2libGluZyBhcyBIVE1MRWxlbWVudCkgOiBudWxsXG4gICAgaWYgKHNpYmxpbmcgPT09IGVsZW1lbnQpIHtcbiAgICAgIGNvbnN0IHBhdGhUb0VsZW1lbnQgPSBnZXRQYXRoVG9FbGVtZW50KGVsZW1lbnQucGFyZW50RWxlbWVudCEpXG4gICAgICBwYXRoVG9FbGVtZW50LnB1c2goe1xuICAgICAgICB0YWcsXG4gICAgICAgIGluZGV4OiBzaWJsaW5nc0NvdW50LFxuICAgICAgfSlcbiAgICAgIHJldHVybiBwYXRoVG9FbGVtZW50XG4gICAgfSBlbHNlIGlmIChzaWJsaW5nVGFnID09PSB0YWcpIHtcbiAgICAgIHNpYmxpbmdzQ291bnQrK1xuICAgIH1cbiAgfVxuICB0aHJvdyBuZXcgRXJyb3IoJ2ZhaWx1cmUgaW4gZ2V0UGF0aFRvRWxlbWVudCcpXG59XG5cbi8vXG4vLyBEZXRlcm1pbmUgcGF0aCB0byBhIHRhcmdldCB0b2tlbi5cbi8vXG4vLyBAcGFyYW0geyhtYXJrZG93bi1pdC5Ub2tlbilbXX0gdG9rZW5zIEFycmF5IG9mIHRva2VucyBhcyByZXR1cm5lZCBieVxuLy8gICBgbWFya2Rvd24taXQucGFyc2UoKWAuXG4vLyBAcGFyYW0ge251bWJlcn0gbGluZSBMaW5lIHJlcHJlc2VudGluZyB0aGUgdGFyZ2V0IHRva2VuLlxuLy8gQHJldHVybiB7KHRhZzogPHRhZz4sIGluZGV4OiA8aW5kZXg+KVtdfSBBcnJheSByZXByZXNlbnRpbmcgYSBwYXRoIHRvIHRoZVxuLy8gICB0YXJnZXQgdG9rZW4uIFRoZSByb290IHRva2VuIGlzIHJlcHJlc2VudGVkIGJ5IHRoZSBmaXJzdCBlbGVtZW50IGluIHRoZVxuLy8gICBhcnJheSBhbmQgdGhlIHRhcmdldCB0b2tlbiBieSB0aGUgbGFzdCBlbG1lbnQuIEVhY2ggZWxlbWVudCBjb25zaXN0cyBvZiBhXG4vLyAgIGB0YWdgIGFuZCBgaW5kZXhgIHJlcHJlc2VudGluZyBpdHMgaW5kZXggYW1vbmdzdCBpdHMgc2libGluZyB0b2tlbnMgaW5cbi8vICAgYHRva2Vuc2Agb2YgdGhlIHNhbWUgYHRhZ2AuIGBsaW5lYCB3aWxsIGxpZSBiZXR3ZWVuIHRoZSBwcm9wZXJ0aWVzXG4vLyAgIGBtYXBbMF1gIGFuZCBgbWFwWzFdYCBvZiB0aGUgdGFyZ2V0IHRva2VuLlxuLy9cbmV4cG9ydCBmdW5jdGlvbiBnZXRQYXRoVG9Ub2tlbih0b2tlbnM6IFRva2VuW10sIGxpbmU6IG51bWJlcikge1xuICBsZXQgcGF0aFRvVG9rZW46IEFycmF5PHsgdGFnOiBzdHJpbmc7IGluZGV4OiBudW1iZXIgfT4gPSBbXVxuICBsZXQgdG9rZW5UYWdDb3VudDogeyBba2V5OiBzdHJpbmddOiBudW1iZXIgfCB1bmRlZmluZWQgfSA9IHt9XG4gIGxldCBsZXZlbCA9IDBcblxuICBmb3IgKGNvbnN0IHRva2VuIG9mIHRva2Vucykge1xuICAgIGlmICh0b2tlbi5sZXZlbCA8IGxldmVsKSB7XG4gICAgICBicmVha1xuICAgIH1cbiAgICBpZiAodG9rZW4uaGlkZGVuKSB7XG4gICAgICBjb250aW51ZVxuICAgIH1cbiAgICBpZiAodG9rZW4ubmVzdGluZyA9PT0gLTEpIHtcbiAgICAgIGNvbnRpbnVlXG4gICAgfVxuXG4gICAgY29uc3QgdGFnID0gZGVjb2RlVGFnKHRva2VuKVxuICAgIGlmICh0YWcgPT09IG51bGwpIHtcbiAgICAgIGNvbnRpbnVlXG4gICAgfVxuICAgIHRva2VuLnRhZyA9IHRhZ1xuXG4gICAgaWYgKFxuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnN0cmljdC10eXBlLXByZWRpY2F0ZXMgLy8gVE9ETzogY29tcGxhaW4gb24gRFRcbiAgICAgIHRva2VuLm1hcCAhPSBudWxsICYmIC8vIHRva2VuLm1hcCAqY2FuKiBiZSBudWxsXG4gICAgICBsaW5lID49IHRva2VuLm1hcFswXSAmJlxuICAgICAgbGluZSA8PSB0b2tlbi5tYXBbMV0gLSAxXG4gICAgKSB7XG4gICAgICBpZiAodG9rZW4ubmVzdGluZyA9PT0gMSkge1xuICAgICAgICBwYXRoVG9Ub2tlbi5wdXNoKHtcbiAgICAgICAgICB0YWc6IHRva2VuLnRhZyxcbiAgICAgICAgICBpbmRleDogdG9rZW5UYWdDb3VudFt0b2tlbi50YWddIHx8IDAsXG4gICAgICAgIH0pXG4gICAgICAgIHRva2VuVGFnQ291bnQgPSB7fVxuICAgICAgICBsZXZlbCsrXG4gICAgICB9IGVsc2UgaWYgKHRva2VuLm5lc3RpbmcgPT09IDApIHtcbiAgICAgICAgcGF0aFRvVG9rZW4ucHVzaCh7XG4gICAgICAgICAgdGFnOiB0b2tlbi50YWcsXG4gICAgICAgICAgaW5kZXg6IHRva2VuVGFnQ291bnRbdG9rZW4udGFnXSB8fCAwLFxuICAgICAgICB9KVxuICAgICAgICBicmVha1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAodG9rZW4ubGV2ZWwgPT09IGxldmVsKSB7XG4gICAgICBpZiAodG9rZW5UYWdDb3VudFt0b2tlbi50YWddICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdG9rZW5UYWdDb3VudFt0b2tlbi50YWddISsrXG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0b2tlblRhZ0NvdW50W3Rva2VuLnRhZ10gPSAxXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcGF0aFRvVG9rZW4gPSBidWJibGVUb0NvbnRhaW5lclRva2VuKHBhdGhUb1Rva2VuKVxuICByZXR1cm4gcGF0aFRvVG9rZW5cbn1cblxuZXhwb3J0IGNvbnN0IG1hdGhKYXhTY3JpcHQgPSBgXFxcbjxzY3JpcHQgdHlwZT1cInRleHQveC1tYXRoamF4LWNvbmZpZ1wiPlxuTWF0aEpheC5IdWIuQ29uZmlnKHtcbmpheDogW1wiaW5wdXQvVGVYXCIsXCJvdXRwdXQvSFRNTC1DU1NcIl0sXG5leHRlbnNpb25zOiBbXSxcblRlWDoge1xuZXh0ZW5zaW9uczogW1wiQU1TbWF0aC5qc1wiLFwiQU1Tc3ltYm9scy5qc1wiLFwibm9FcnJvcnMuanNcIixcIm5vVW5kZWZpbmVkLmpzXCJdXG59LFxuc2hvd01hdGhNZW51OiBmYWxzZVxufSk7XG48L3NjcmlwdD5cbjxzY3JpcHQgdHlwZT1cInRleHQvamF2YXNjcmlwdFwiIHNyYz1cImh0dHBzOi8vY2RuLm1hdGhqYXgub3JnL21hdGhqYXgvbGF0ZXN0L01hdGhKYXguanNcIj5cbjwvc2NyaXB0PlxcXG5gXG5cbmV4cG9ydCBmdW5jdGlvbiBta0h0bWwoXG4gIHRpdGxlOiBzdHJpbmcsXG4gIGh0bWw6IHsgaGVhZDogc3RyaW5nOyBib2R5OiBzdHJpbmcgfSxcbiAgcmVuZGVyTGFUZVg6IGJvb2xlYW4sXG4gIHVzZUdpdGh1YlN0eWxlOiBib29sZWFuLFxuKSB7XG4gIGNvbnN0IGdpdGh1YlN0eWxlID0gdXNlR2l0aHViU3R5bGUgPyAnIGRhdGEtdXNlLWdpdGh1Yi1zdHlsZScgOiAnJ1xuICBsZXQgbWF5YmVNYXRoSmF4U2NyaXB0XG4gIGlmIChyZW5kZXJMYVRlWCkge1xuICAgIG1heWJlTWF0aEpheFNjcmlwdCA9IG1hdGhKYXhTY3JpcHRcbiAgfSBlbHNlIHtcbiAgICBtYXliZU1hdGhKYXhTY3JpcHQgPSAnJ1xuICB9XG4gIHJldHVybiBgXFxcbjwhRE9DVFlQRSBodG1sPlxuPGh0bWw+XG4gIDxoZWFkPlxuICAgIDxtZXRhIGNoYXJzZXQ9XCJ1dGYtOFwiIC8+XG4gICAgPHRpdGxlPiR7dGl0bGV9PC90aXRsZT4ke21heWJlTWF0aEpheFNjcmlwdH1cbiAgICA8c3R5bGU+JHtnZXRNYXJrZG93blByZXZpZXdDU1MoKX08L3N0eWxlPlxuJHtodG1sLmhlYWR9XG4gIDwvaGVhZD5cbiAgPGJvZHk+XG4gICAgPG1hcmtkb3duLXByZXZpZXctcGx1cy12aWV3JHtnaXRodWJTdHlsZX0+XG4gICAgICAke2h0bWwuYm9keX1cbiAgICA8L21hcmtkb3duLXByZXZpZXctcGx1cy12aWV3PlxuICA8L2JvZHk+XG48L2h0bWw+XG5gIC8vIEVuc3VyZSB0cmFpbGluZyBuZXdsaW5lXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBkZXN0cm95KGl0ZW06IG9iamVjdCkge1xuICBjb25zdCBwYW5lID0gYXRvbS53b3Jrc3BhY2UucGFuZUZvckl0ZW0oaXRlbSlcbiAgaWYgKHBhbmUpIGhhbmRsZVByb21pc2UocGFuZS5kZXN0cm95SXRlbShpdGVtKSlcbn1cbiJdfQ==