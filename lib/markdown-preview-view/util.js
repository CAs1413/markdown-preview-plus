"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const fs = require("fs");
const util_1 = require("../util");
function editorForId(editorId) {
    for (const editor of atom.workspace.getTextEditors()) {
        if (editor.id === editorId) {
            return editor;
        }
    }
    return undefined;
}
exports.editorForId = editorForId;
let getStylesOverride = undefined;
function __setGetStylesOverride(f) {
    getStylesOverride = f;
}
exports.__setGetStylesOverride = __setGetStylesOverride;
function getStyles(context) {
    if (getStylesOverride)
        return getStylesOverride(context);
    const textEditorStyles = document.createElement('atom-styles');
    textEditorStyles.initialize(atom.styles);
    textEditorStyles.setAttribute('context', context);
    return Array.from(textEditorStyles.childNodes).map((styleElement) => styleElement.innerText);
}
exports.getStyles = getStyles;
function getMarkdownPreviewCSS() {
    const markdowPreviewRules = ['body { padding: 0; margin: 0; }'];
    const cssUrlRefExp = /url\(atom:\/\/markdown-preview-plus\/assets\/(.*)\)/;
    return markdowPreviewRules
        .concat(getStyles('markdown-preview-plus'))
        .concat(getStyles('atom-text-editor'))
        .join('\n')
        .replace(/\batom-text-editor\b/g, 'pre.editor-colors')
        .replace(/\bmarkdown-preview-plus-view\b/g, '.markdown-preview-plus-view')
        .replace(cssUrlRefExp, function (_match, assetsName, _offset, _string) {
        const assetPath = path.join(__dirname, '../../assets', assetsName);
        const originalData = fs.readFileSync(assetPath, 'binary');
        const base64Data = new Buffer(originalData, 'binary').toString('base64');
        return `url('data:image/jpeg;base64,${base64Data}')`;
    });
}
exports.getMarkdownPreviewCSS = getMarkdownPreviewCSS;
function bubbleToContainerToken(pathToToken) {
    const end = pathToToken.length - 1;
    for (let i = 0; i <= end; i++) {
        if (pathToToken[i].tag === 'table') {
            return pathToToken.slice(0, i + 1);
        }
    }
    return pathToToken;
}
exports.bubbleToContainerToken = bubbleToContainerToken;
function decodeTag(token) {
    if (token.tag === 'math') {
        return 'span';
    }
    if (token.tag === 'code') {
        return 'span';
    }
    if (token.tag === '') {
        return null;
    }
    return token.tag;
}
exports.decodeTag = decodeTag;
function getPathToToken(tokens, line) {
    let pathToToken = [];
    let tokenTagCount = {};
    let level = 0;
    for (const token of tokens) {
        if (token.level < level) {
            break;
        }
        if (token.hidden) {
            continue;
        }
        if (token.nesting === -1) {
            continue;
        }
        const tag = decodeTag(token);
        if (tag === null) {
            continue;
        }
        token.tag = tag;
        if (token.map != null &&
            line >= token.map[0] &&
            line <= token.map[1] - 1) {
            if (token.nesting === 1) {
                pathToToken.push({
                    tag: token.tag,
                    index: tokenTagCount[token.tag] || 0,
                });
                tokenTagCount = {};
                level++;
            }
            else if (token.nesting === 0) {
                pathToToken.push({
                    tag: token.tag,
                    index: tokenTagCount[token.tag] || 0,
                });
                break;
            }
        }
        else if (token.level === level) {
            if (tokenTagCount[token.tag] !== undefined) {
                tokenTagCount[token.tag]++;
            }
            else {
                tokenTagCount[token.tag] = 1;
            }
        }
    }
    pathToToken = bubbleToContainerToken(pathToToken);
    return pathToToken;
}
exports.getPathToToken = getPathToToken;
exports.mathJaxScript = `\
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
jax: ["input/TeX","output/HTML-CSS"],
extensions: [],
TeX: {
extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
},
showMathMenu: false
});
</script>
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js">
</script>\
`;
function mkHtml(title, html, renderLaTeX, useGithubStyle) {
    const githubStyle = useGithubStyle ? ' data-use-github-style' : '';
    let maybeMathJaxScript;
    if (renderLaTeX) {
        maybeMathJaxScript = exports.mathJaxScript;
    }
    else {
        maybeMathJaxScript = '';
    }
    return `\
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>${title}</title>${maybeMathJaxScript}
    <style>${getMarkdownPreviewCSS()}</style>
${html.head.innerHTML}
  </head>
  <body class="markdown-preview-plus-view"${githubStyle}>
    ${html.body.innerHTML}
  </body>
</html>
`;
}
exports.mkHtml = mkHtml;
function destroy(item) {
    const pane = atom.workspace.paneForItem(item);
    if (pane)
        util_1.handlePromise(pane.destroyItem(item));
}
exports.destroy = destroy;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tYXJrZG93bi1wcmV2aWV3LXZpZXcvdXRpbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLDZCQUE0QjtBQUM1Qix5QkFBd0I7QUFFeEIsa0NBQXVDO0FBRXZDLHFCQUE0QixRQUFnQjtJQUMxQyxLQUFLLE1BQU0sTUFBTSxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsY0FBYyxFQUFFLEVBQUU7UUFDcEQsSUFBSSxNQUFNLENBQUMsRUFBRSxLQUFLLFFBQVEsRUFBRTtZQUMxQixPQUFPLE1BQU0sQ0FBQTtTQUNkO0tBQ0Y7SUFDRCxPQUFPLFNBQVMsQ0FBQTtBQUNsQixDQUFDO0FBUEQsa0NBT0M7QUFHRCxJQUFJLGlCQUFpQixHQUFpQyxTQUFTLENBQUE7QUFFL0QsZ0NBQXVDLENBQW9CO0lBQ3pELGlCQUFpQixHQUFHLENBQUMsQ0FBQTtBQUN2QixDQUFDO0FBRkQsd0RBRUM7QUFFRCxtQkFBMEIsT0FBZTtJQUN2QyxJQUFJLGlCQUFpQjtRQUFFLE9BQU8saUJBQWlCLENBQUMsT0FBTyxDQUFDLENBQUE7SUFDeEQsTUFBTSxnQkFBZ0IsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUM3QyxhQUFhLENBQzhDLENBQUE7SUFDN0QsZ0JBQWdCLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQTtJQUN4QyxnQkFBZ0IsQ0FBQyxZQUFZLENBQUMsU0FBUyxFQUFFLE9BQU8sQ0FBQyxDQUFBO0lBR2pELE9BQU8sS0FBSyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVLENBQUMsQ0FBQyxHQUFHLENBQ2hELENBQUMsWUFBWSxFQUFFLEVBQUUsQ0FBRSxZQUFpQyxDQUFDLFNBQVMsQ0FDL0QsQ0FBQTtBQUNILENBQUM7QUFaRCw4QkFZQztBQUVEO0lBQ0UsTUFBTSxtQkFBbUIsR0FBRyxDQUFDLGlDQUFpQyxDQUFDLENBQUE7SUFDL0QsTUFBTSxZ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QUksV0FBVyxFQUFFO1FBQ2Ysa0JBQWtCLEdBQUcscUJBQWEsQ0FBQTtLQUNuQztTQUFNO1FBQ0wsa0JBQWtCLEdBQUcsRUFBRSxDQUFBO0tBQ3hCO0lBQ0QsT0FBTzs7Ozs7YUFLSSxLQUFLLFdBQVcsa0JBQWtCO2FBQ2xDLHFCQUFxQixFQUFFO0VBQ2xDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUzs7NENBRXVCLFdBQVc7TUFDakQsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTOzs7Q0FHeEIsQ0FBQTtBQUNELENBQUM7QUEzQkQsd0JBMkJDO0FBRUQsaUJBQXdCLElBQVk7SUFDbEMsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUE7SUFDN0MsSUFBSSxJQUFJO1FBQUUsb0JBQWEsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUE7QUFDakQsQ0FBQztBQUhELDBCQUdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGV4dEVkaXRvciwgU3R5bGVNYW5hZ2VyIH0gZnJvbSAnYXRvbSdcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCdcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJ1xuaW1wb3J0IHsgVG9rZW4gfSBmcm9tICdtYXJrZG93bi1pdCdcbmltcG9ydCB7IGhhbmRsZVByb21pc2UgfSBmcm9tICcuLi91dGlsJ1xuXG5leHBvcnQgZnVuY3Rpb24gZWRpdG9yRm9ySWQoZWRpdG9ySWQ6IG51bWJlcik6IFRleHRFZGl0b3IgfCB1bmRlZmluZWQge1xuICBmb3IgKGNvbnN0IGVkaXRvciBvZiBhdG9tLndvcmtzcGFjZS5nZXRUZXh0RWRpdG9ycygpKSB7XG4gICAgaWYgKGVkaXRvci5pZCA9PT0gZWRpdG9ySWQpIHtcbiAgICAgIHJldHVybiBlZGl0b3JcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHVuZGVmaW5lZFxufVxuXG4vLyB0aGlzIHdlaXJkbmVzcyBhbGxvd3Mgb3ZlcnJpZGluZyBpbiB0ZXN0c1xubGV0IGdldFN0eWxlc092ZXJyaWRlOiB0eXBlb2YgZ2V0U3R5bGVzIHwgdW5kZWZpbmVkID0gdW5kZWZpbmVkXG5cbmV4cG9ydCBmdW5jdGlvbiBfX3NldEdldFN0eWxlc092ZXJyaWRlKGY/OiB0eXBlb2YgZ2V0U3R5bGVzKSB7XG4gIGdldFN0eWxlc092ZXJyaWRlID0gZlxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0U3R5bGVzKGNvbnRleHQ6IHN0cmluZyk6IHN0cmluZ1tdIHtcbiAgaWYgKGdldFN0eWxlc092ZXJyaWRlKSByZXR1cm4gZ2V0U3R5bGVzT3ZlcnJpZGUoY29udGV4dClcbiAgY29uc3QgdGV4dEVkaXRvclN0eWxlcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXG4gICAgJ2F0b20tc3R5bGVzJyxcbiAgKSBhcyBIVE1MRWxlbWVudCAmIHsgaW5pdGlhbGl6ZShzdHlsZXM6IFN0eWxlTWFuYWdlcik6IHZvaWQgfVxuICB0ZXh0RWRpdG9yU3R5bGVzLmluaXRpYWxpemUoYXRvbS5zdHlsZXMpXG4gIHRleHRFZGl0b3JTdHlsZXMuc2V0QXR0cmlidXRlKCdjb250ZXh0JywgY29udGV4dClcblxuICAvLyBFeHRyYWN0IHN0eWxlIGVsZW1lbnRzIGNvbnRlbnRcbiAgcmV0dXJuIEFycmF5LmZyb20odGV4dEVkaXRvclN0eWxlcy5jaGlsZE5vZGVzKS5tYXAoXG4gICAgKHN0eWxlRWxlbWVudCkgPT4gKHN0eWxlRWxlbWVudCBhcyBIVE1MU3R5bGVFbGVtZW50KS5pbm5lclRleHQsXG4gIClcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldE1hcmtkb3duUHJldmlld0NTUygpIHtcbiAgY29uc3QgbWFya2Rvd1ByZXZpZXdSdWxlcyA9IFsnYm9keSB7IHBhZGRpbmc6IDA7IG1hcmdpbjogMDsgfSddXG4gIGNvbnN0IGNzc1VybFJlZkV4cCA9IC91cmxcXChhdG9tOlxcL1xcL21hcmtkb3duLXByZXZpZXctcGx1c1xcL2Fzc2V0c1xcLyguKilcXCkvXG5cbiAgcmV0dXJuIG1hcmtkb3dQcmV2aWV3UnVsZXNcbiAgICAuY29uY2F0KGdldFN0eWxlcygnbWFya2Rvd24tcHJldmlldy1wbHVzJykpXG4gICAgLmNvbmNhdChnZXRTdHlsZXMoJ2F0b20tdGV4dC1lZGl0b3InKSlcbiAgICAuam9pbignXFxuJylcbiAgICAucmVwbGFjZSgvXFxiYXRvbS10ZXh0LWVkaXRvclxcYi9nLCAncHJlLmVkaXRvci1jb2xvcnMnKVxuICAgIC5yZXBsYWNlKC9cXGJtYXJrZG93bi1wcmV2aWV3LXBsdXMtdmlld1xcYi9nLCAnLm1hcmtkb3duLXByZXZpZXctcGx1cy12aWV3JylcbiAgICAucmVwbGFjZShjc3NVcmxSZWZFeHAsIGZ1bmN0aW9uKFxuICAgICAgX21hdGNoLFxuICAgICAgYXNzZXRzTmFtZTogc3RyaW5nLFxuICAgICAgX29mZnNldCxcbiAgICAgIF9zdHJpbmcsXG4gICAgKSB7XG4gICAgICAvLyBiYXNlNjQgZW5jb2RlIGFzc2V0c1xuICAgICAgY29uc3QgYXNzZXRQYXRoID0gcGF0aC5qb2luKF9fZGlybmFtZSwgJy4uLy4uL2Fzc2V0cycsIGFzc2V0c05hbWUpXG4gICAgICBjb25zdCBvcmlnaW5hbERhdGEgPSBmcy5yZWFkRmlsZVN5bmMoYXNzZXRQYXRoLCAnYmluYXJ5JylcbiAgICAgIGNvbnN0IGJhc2U2NERhdGEgPSBuZXcgQnVmZmVyKG9yaWdpbmFsRGF0YSwgJ2JpbmFyeScpLnRvU3RyaW5nKCdiYXNlNjQnKVxuICAgICAgcmV0dXJuIGB1cmwoJ2RhdGE6aW1hZ2UvanBlZztiYXNlNjQsJHtiYXNlNjREYXRhfScpYFxuICAgIH0pXG59XG5cbi8vXG4vLyBEZXRlcm1pbmUgYSBzdWJzZXF1ZW5jZSBvZiBhIHNlcXVlbmNlIG9mIHRva2VucyByZXByZXNlbnRpbmcgYSBwYXRoIHRocm91Z2hcbi8vIEhUTUxFbGVtZW50cyB0aGF0IGRvZXMgbm90IGNvbnRpbnVlIGRlZXBlciB0aGFuIGEgdGFibGUgZWxlbWVudC5cbi8vXG4vLyBAcGFyYW0geyh0YWc6IDx0YWc+LCBpbmRleDogPGluZGV4PilbXX0gcGF0aFRvVG9rZW4gQXJyYXkgb2YgdG9rZW5zXG4vLyAgIHJlcHJlc2VudGluZyBhIHBhdGggdG8gYSBIVE1MRWxlbWVudCB3aXRoIHRoZSByb290IGVsZW1lbnQgYXRcbi8vICAgcGF0aFRvVG9rZW5bMF0gYW5kIHRoZSB0YXJnZXQgZWxlbWVudCBhdCB0aGUgaGlnaGVzdCBpbmRleC4gRWFjaCBlbGVtZW50XG4vLyAgIGNvbnNpc3RzIG9mIGEgYHRhZ2AgYW5kIGBpbmRleGAgcmVwcmVzZW50aW5nIGl0cyBpbmRleCBhbW9uZ3N0IGl0c1xuLy8gICBzaWJsaW5nIGVsZW1lbnRzIG9mIHRoZSBzYW1lIGB0YWdgLlxuLy8gQHJldHVybiB7KHRhZzogPHRhZz4sIGluZGV4OiA8aW5kZXg+KVtdfSBUaGUgc3Vic2VxdWVuY2Ugb2YgcGF0aFRvVG9rZW4gdGhhdFxuLy8gICBtYWludGFpbnMgdGhlIHNhbWUgcm9vdCBidXQgdGVybWluYXRlcyBhdCBhIHRhYmxlIGVsZW1lbnQgb3IgdGhlIHRhcmdldFxuLy8gICBlbGVtZW50LCB3aGljaGV2ZXIgY29tZXMgZmlyc3QuXG4vL1xuZXhwb3J0IGZ1bmN0aW9uIGJ1YmJsZVRvQ29udGFpbmVyVG9rZW4oXG4gIHBhdGhUb1Rva2VuOiBBcnJheTx7IHRhZzogc3RyaW5nOyBpbmRleDogbnVtYmVyIH0+LFxuKSB7XG4gIGNvbnN0IGVuZCA9IHBhdGhUb1Rva2VuLmxlbmd0aCAtIDFcbiAgZm9yIChsZXQgaSA9IDA7IGkgPD0gZW5kOyBpKyspIHtcbiAgICBpZiAocGF0aFRvVG9rZW5baV0udGFnID09PSAndGFibGUnKSB7XG4gICAgICByZXR1cm4gcGF0aFRvVG9rZW4uc2xpY2UoMCwgaSArIDEpXG4gICAgfVxuICB9XG4gIHJldHVybiBwYXRoVG9Ub2tlblxufVxuXG4vL1xuLy8gRGVjb2RlIHRhZ3MgdXNlZCBieSBtYXJrZG93bi1pdFxuLy9cbi8vIEBwYXJhbSB7bWFya2Rvd24taXQuVG9rZW59IHRva2VuIERlY29kZSB0aGUgdGFnIG9mIHRva2VuLlxuLy8gQHJldHVybiB7c3RyaW5nfG51bGx9IERlY29kZWQgdGFnIG9yIGBudWxsYCBpZiB0aGUgdG9rZW4gaGFzIG5vIHRhZy5cbi8vXG5leHBvcnQgZnVuY3Rpb24gZGVjb2RlVGFnKHRva2VuOiBUb2tlbik6IHN0cmluZyB8IG51bGwge1xuICBpZiAodG9rZW4udGFnID09PSAnbWF0aCcpIHtcbiAgICByZXR1cm4gJ3NwYW4nXG4gIH1cbiAgaWYgKHRva2VuLnRhZyA9PT0gJ2NvZGUnKSB7XG4gICAgcmV0dXJuICdzcGFuJ1xuICB9XG4gIGlmICh0b2tlbi50YWcgPT09ICcnKSB7XG4gICAgcmV0dXJuIG51bGxcbiAgfVxuICByZXR1cm4gdG9rZW4udGFnXG59XG5cbi8vXG4vLyBEZXRlcm1pbmUgcGF0aCB0byBhIHRhcmdldCB0b2tlbi5cbi8vXG4vLyBAcGFyYW0geyhtYXJrZG93bi1pdC5Ub2tlbilbXX0gdG9rZW5zIEFycmF5IG9mIHRva2VucyBhcyByZXR1cm5lZCBieVxuLy8gICBgbWFya2Rvd24taXQucGFyc2UoKWAuXG4vLyBAcGFyYW0ge251bWJlcn0gbGluZSBMaW5lIHJlcHJlc2VudGluZyB0aGUgdGFyZ2V0IHRva2VuLlxuLy8gQHJldHVybiB7KHRhZzogPHRhZz4sIGluZGV4OiA8aW5kZXg+KVtdfSBBcnJheSByZXByZXNlbnRpbmcgYSBwYXRoIHRvIHRoZVxuLy8gICB0YXJnZXQgdG9rZW4uIFRoZSByb290IHRva2VuIGlzIHJlcHJlc2VudGVkIGJ5IHRoZSBmaXJzdCBlbGVtZW50IGluIHRoZVxuLy8gICBhcnJheSBhbmQgdGhlIHRhcmdldCB0b2tlbiBieSB0aGUgbGFzdCBlbG1lbnQuIEVhY2ggZWxlbWVudCBjb25zaXN0cyBvZiBhXG4vLyAgIGB0YWdgIGFuZCBgaW5kZXhgIHJlcHJlc2VudGluZyBpdHMgaW5kZXggYW1vbmdzdCBpdHMgc2libGluZyB0b2tlbnMgaW5cbi8vICAgYHRva2Vuc2Agb2YgdGhlIHNhbWUgYHRhZ2AuIGBsaW5lYCB3aWxsIGxpZSBiZXR3ZWVuIHRoZSBwcm9wZXJ0aWVzXG4vLyAgIGBtYXBbMF1gIGFuZCBgbWFwWzFdYCBvZiB0aGUgdGFyZ2V0IHRva2VuLlxuLy9cbmV4cG9ydCBmdW5jdGlvbiBnZXRQYXRoVG9Ub2tlbih0b2tlbnM6IFRva2VuW10sIGxpbmU6IG51bWJlcikge1xuICBsZXQgcGF0aFRvVG9rZW46IEFycmF5PHsgdGFnOiBzdHJpbmc7IGluZGV4OiBudW1iZXIgfT4gPSBbXVxuICBsZXQgdG9rZW5UYWdDb3VudDogeyBba2V5OiBzdHJpbmddOiBudW1iZXIgfCB1bmRlZmluZWQgfSA9IHt9XG4gIGxldCBsZXZlbCA9IDBcblxuICBmb3IgKGNvbnN0IHRva2VuIG9mIHRva2Vucykge1xuICAgIGlmICh0b2tlbi5sZXZlbCA8IGxldmVsKSB7XG4gICAgICBicmVha1xuICAgIH1cbiAgICBpZiAodG9rZW4uaGlkZGVuKSB7XG4gICAgICBjb250aW51ZVxuICAgIH1cbiAgICBpZiAodG9rZW4ubmVzdGluZyA9PT0gLTEpIHtcbiAgICAgIGNvbnRpbnVlXG4gICAgfVxuXG4gICAgY29uc3QgdGFnID0gZGVjb2RlVGFnKHRva2VuKVxuICAgIGlmICh0YWcgPT09IG51bGwpIHtcbiAgICAgIGNvbnRpbnVlXG4gICAgfVxuICAgIHRva2VuLnRhZyA9IHRhZ1xuXG4gICAgaWYgKFxuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnN0cmljdC10eXBlLXByZWRpY2F0ZXMgLy8gVE9ETzogY29tcGxhaW4gb24gRFRcbiAgICAgIHRva2VuLm1hcCAhPSBudWxsICYmIC8vIHRva2VuLm1hcCAqY2FuKiBiZSBudWxsXG4gICAgICBsaW5lID49IHRva2VuLm1hcFswXSAmJlxuICAgICAgbGluZSA8PSB0b2tlbi5tYXBbMV0gLSAxXG4gICAgKSB7XG4gICAgICBpZiAodG9rZW4ubmVzdGluZyA9PT0gMSkge1xuICAgICAgICBwYXRoVG9Ub2tlbi5wdXNoKHtcbiAgICAgICAgICB0YWc6IHRva2VuLnRhZyxcbiAgICAgICAgICBpbmRleDogdG9rZW5UYWdDb3VudFt0b2tlbi50YWddIHx8IDAsXG4gICAgICAgIH0pXG4gICAgICAgIHRva2VuVGFnQ291bnQgPSB7fVxuICAgICAgICBsZXZlbCsrXG4gICAgICB9IGVsc2UgaWYgKHRva2VuLm5lc3RpbmcgPT09IDApIHtcbiAgICAgICAgcGF0aFRvVG9rZW4ucHVzaCh7XG4gICAgICAgICAgdGFnOiB0b2tlbi50YWcsXG4gICAgICAgICAgaW5kZXg6IHRva2VuVGFnQ291bnRbdG9rZW4udGFnXSB8fCAwLFxuICAgICAgICB9KVxuICAgICAgICBicmVha1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAodG9rZW4ubGV2ZWwgPT09IGxldmVsKSB7XG4gICAgICBpZiAodG9rZW5UYWdDb3VudFt0b2tlbi50YWddICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdG9rZW5UYWdDb3VudFt0b2tlbi50YWddISsrXG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0b2tlblRhZ0NvdW50W3Rva2VuLnRhZ10gPSAxXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcGF0aFRvVG9rZW4gPSBidWJibGVUb0NvbnRhaW5lclRva2VuKHBhdGhUb1Rva2VuKVxuICByZXR1cm4gcGF0aFRvVG9rZW5cbn1cblxuZXhwb3J0IGNvbnN0IG1hdGhKYXhTY3JpcHQgPSBgXFxcbjxzY3JpcHQgdHlwZT1cInRleHQveC1tYXRoamF4LWNvbmZpZ1wiPlxuTWF0aEpheC5IdWIuQ29uZmlnKHtcbmpheDogW1wiaW5wdXQvVGVYXCIsXCJvdXRwdXQvSFRNTC1DU1NcIl0sXG5leHRlbnNpb25zOiBbXSxcblRlWDoge1xuZXh0ZW5zaW9uczogW1wiQU1TbWF0aC5qc1wiLFwiQU1Tc3ltYm9scy5qc1wiLFwibm9FcnJvcnMuanNcIixcIm5vVW5kZWZpbmVkLmpzXCJdXG59LFxuc2hvd01hdGhNZW51OiBmYWxzZVxufSk7XG48L3NjcmlwdD5cbjxzY3JpcHQgdHlwZT1cInRleHQvamF2YXNjcmlwdFwiIHNyYz1cImh0dHBzOi8vY2RuLm1hdGhqYXgub3JnL21hdGhqYXgvbGF0ZXN0L01hdGhKYXguanNcIj5cbjwvc2NyaXB0PlxcXG5gXG5cbmV4cG9ydCBmdW5jdGlvbiBta0h0bWwoXG4gIHRpdGxlOiBzdHJpbmcsXG4gIGh0bWw6IEhUTUxEb2N1bWVudCxcbiAgcmVuZGVyTGFUZVg6IGJvb2xlYW4sXG4gIHVzZUdpdGh1YlN0eWxlOiBib29sZWFuLFxuKSB7XG4gIGNvbnN0IGdpdGh1YlN0eWxlID0gdXNlR2l0aHViU3R5bGUgPyAnIGRhdGEtdXNlLWdpdGh1Yi1zdHlsZScgOiAnJ1xuICBsZXQgbWF5YmVNYXRoSmF4U2NyaXB0XG4gIGlmIChyZW5kZXJMYVRlWCkge1xuICAgIG1heWJlTWF0aEpheFNjcmlwdCA9IG1hdGhKYXhTY3JpcHRcbiAgfSBlbHNlIHtcbiAgICBtYXliZU1hdGhKYXhTY3JpcHQgPSAnJ1xuICB9XG4gIHJldHVybiBgXFxcbjwhRE9DVFlQRSBodG1sPlxuPGh0bWw+XG4gIDxoZWFkPlxuICAgIDxtZXRhIGNoYXJzZXQ9XCJ1dGYtOFwiIC8+XG4gICAgPHRpdGxlPiR7dGl0bGV9PC90aXRsZT4ke21heWJlTWF0aEpheFNjcmlwdH1cbiAgICA8c3R5bGU+JHtnZXRNYXJrZG93blByZXZpZXdDU1MoKX08L3N0eWxlPlxuJHtodG1sLmhlYWQuaW5uZXJIVE1MfVxuICA8L2hlYWQ+XG4gIDxib2R5IGNsYXNzPVwibWFya2Rvd24tcHJldmlldy1wbHVzLXZpZXdcIiR7Z2l0aHViU3R5bGV9PlxuICAgICR7aHRtbC5ib2R5LmlubmVySFRNTH1cbiAgPC9ib2R5PlxuPC9odG1sPlxuYCAvLyBFbnN1cmUgdHJhaWxpbmcgbmV3bGluZVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZGVzdHJveShpdGVtOiBvYmplY3QpIHtcbiAgY29uc3QgcGFuZSA9IGF0b20ud29ya3NwYWNlLnBhbmVGb3JJdGVtKGl0ZW0pXG4gIGlmIChwYW5lKSBoYW5kbGVQcm9taXNlKHBhbmUuZGVzdHJveUl0ZW0oaXRlbSkpXG59XG4iXX0=