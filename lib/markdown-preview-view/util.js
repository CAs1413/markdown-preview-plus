"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const fs = require("fs");
const util_1 = require("../util");
function editorForId(editorId) {
    for (const editor of atom.workspace.getTextEditors()) {
        if (editor.id === editorId) {
            return editor;
        }
    }
    return undefined;
}
exports.editorForId = editorForId;
let getStylesOverride = undefined;
function __setGetStylesOverride(f) {
    getStylesOverride = f;
}
exports.__setGetStylesOverride = __setGetStylesOverride;
function* getStyles(context) {
    const elements = atom.styles.getStyleElements();
    for (const element of elements) {
        if (context === undefined || element.getAttribute('context') === context) {
            yield element.innerText;
        }
    }
}
function getClientStyle(file) {
    return atom.themes.loadStylesheet(path.join(__dirname, '..', '..', 'styles-client', `${file}.less`));
}
function getUserStyles() {
    const el = atom.styles.styleElementsBySourcePath[atom.styles.getUserStyleSheetPath()];
    if (!el)
        return [];
    return [el.innerText];
}
exports.getUserStyles = getUserStyles;
function getSyntaxTheme(themeName) {
    if (themeName !== '') {
        const themes = atom.themes.getLoadedThemes();
        if (themes) {
            const [theme] = themes.filter((x) => x.name === themeName);
            if (theme) {
                const stshts = theme
                    .getStylesheetPaths()
                    .map((p) => atom.themes.loadStylesheet(p));
                return processEditorStyles(stshts);
            }
        }
        atom.notifications.addWarning('Failed to load syntax theme', {
            detail: `Markdown-preview-plus couldn't find '${themeName}'`,
        });
    }
    return processEditorStyles(getStyles('atom-text-editor'));
}
function* getActivePackageStyles(packageName) {
    const pack = atom.packages.getActivePackage(packageName);
    if (!pack)
        return undefined;
    const stylesheets = pack.getStylesheetPaths();
    for (const ss of stylesheets) {
        const element = atom.styles.styleElementsBySourcePath[ss];
        if (element)
            yield element.innerText;
    }
}
function getPreviewStyles(display) {
    if (getStylesOverride)
        return getStylesOverride(display);
    const styles = [];
    if (display) {
        const globalStyles = atom.styles.styleElementsBySourcePath['global-text-editor-styles'];
        if (globalStyles) {
            styles.push(...processWorkspaceStyles([globalStyles.innerText]));
        }
        styles.push(getClientStyle('editor-global-font'));
        const packList = util_1.atomConfig().importPackageStyles;
        if (packList.includes('*')) {
            styles.push(...processEditorStyles(getStyles()));
            styles.push(getClientStyle('patch'));
        }
        else {
            for (const pack of packList) {
                styles.push(...processEditorStyles(getActivePackageStyles(pack)));
            }
            if (packList.includes('fonts')) {
                const fontsVar = atom.styles.styleElementsBySourcePath['fonts-package-editorfont'];
                if (fontsVar)
                    styles.push(...processEditorStyles([fontsVar.innerText]));
            }
        }
    }
    styles.push(getClientStyle('generic'));
    if (display)
        styles.push(getClientStyle('display'));
    if (util_1.atomConfig().useGitHubStyle) {
        styles.push(getClientStyle('github'));
    }
    else {
        styles.push(getClientStyle('default'));
    }
    styles.push(...getSyntaxTheme(util_1.atomConfig().syntaxThemeName));
    styles.push(...processEditorStyles(getUserStyles()));
    return styles;
}
exports.getPreviewStyles = getPreviewStyles;
function* processEditorStyles(styles) {
    for (const style of styles) {
        yield style.replace(/\batom-text-editor\b/g, 'pre.editor-colors');
    }
}
function* processWorkspaceStyles(styles) {
    for (const style of styles) {
        yield style.replace(/\batom-workspace\b/g, ':root');
    }
}
function getMarkdownPreviewCSS() {
    const cssUrlRefExp = /url\(atom:\/\/markdown-preview-plus\/assets\/(.*)\)/;
    return getPreviewStyles(false)
        .join('\n')
        .replace(cssUrlRefExp, function (_match, assetsName, _offset, _string) {
        const assetPath = path.join(__dirname, '../../assets', assetsName);
        const originalData = fs.readFileSync(assetPath, 'binary');
        const base64Data = new Buffer(originalData, 'binary').toString('base64');
        return `url('data:image/jpeg;base64,${base64Data}')`;
    });
}
function decodeTag(token) {
    if (token.tag === 'math') {
        return 'span';
    }
    if (token.tag === 'code') {
        return 'atom-text-editor';
    }
    if (token.tag === '') {
        return null;
    }
    return token.tag;
}
function buildLineMap(tokens) {
    const lineMap = {};
    const tokenTagCount = {};
    tokenTagCount[0] = {};
    for (const token of tokens) {
        if (token.hidden)
            continue;
        if (token.map == null)
            continue;
        const tag = decodeTag(token);
        if (tag === null)
            continue;
        if (token.nesting === 1) {
            for (let line = token.map[0]; line < token.map[1]; line += 1) {
                if (lineMap[line] == null)
                    lineMap[line] = [];
                lineMap[line].push({
                    tag: tag,
                    index: tokenTagCount[token.level][tag] || 0,
                });
            }
            tokenTagCount[token.level + 1] = {};
        }
        else if (token.nesting === 0) {
            for (let line = token.map[0]; line < token.map[1]; line += 1) {
                if (lineMap[line] == null)
                    lineMap[line] = [];
                lineMap[line].push({
                    tag: tag,
                    index: tokenTagCount[token.level][tag] || 0,
                });
            }
        }
        const ttc = tokenTagCount[token.level][tag];
        tokenTagCount[token.level][tag] = ttc ? ttc + 1 : 1;
    }
    return lineMap;
}
exports.buildLineMap = buildLineMap;
function mathJaxScript(texConfig) {
    return `\
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    jax: ["input/TeX","output/HTML-CSS"],
    extensions: ["[a11y]/accessibility-menu.js"],
    'HTML-CSS': {
      availableFonts: [],
      webFont: 'TeX',
      undefinedFamily: ${JSON.stringify(util_1.atomConfig().mathConfig.undefinedFamily)},
      mtextFontInherit: true,
    },
    TeX: ${JSON.stringify(texConfig, undefined, 2)},
    showMathMenu: true
  });
</script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js"></script>`;
}
function mkHtml(title, html, renderLaTeX, texConfig) {
    let maybeMathJaxScript;
    if (renderLaTeX) {
        maybeMathJaxScript = mathJaxScript(texConfig);
    }
    else {
        maybeMathJaxScript = '';
    }
    return `\
<!DOCTYPE html>
<html data-markdown-preview-plus-context="html-export">
  <head>
    <meta charset="utf-8" />
    <title>${title}</title>${maybeMathJaxScript}
    <style>${getMarkdownPreviewCSS()}</style>
${html.head.innerHTML}
  </head>
  <body>
    ${html.body.innerHTML}
  </body>
</html>
`;
}
exports.mkHtml = mkHtml;
function destroy(item) {
    const pane = atom.workspace.paneForItem(item);
    if (pane)
        util_1.handlePromise(pane.destroyItem(item));
}
exports.destroy = destroy;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tYXJrZG93bi1wcmV2aWV3LXZpZXcvdXRpbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLDZCQUE0QjtBQUM1Qix5QkFBd0I7QUFFeEIsa0NBQW1EO0FBRW5ELFNBQWdCLFdBQVcsQ0FBQyxRQUFnQjtJQUMxQyxLQUFLLE1BQU0sTUFBTSxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsY0FBYyxFQUFFLEVBQUU7UUFDcEQsSUFBSSxNQUFNLENBQUMsRUFBRSxLQUFLLFFBQVEsRUFBRTtZQUMxQixPQUFPLE1BQU0sQ0FBQTtTQUNkO0tBQ0Y7SUFDRCxPQUFPLFNBQVMsQ0FBQTtBQUNsQixDQUFDO0FBUEQsa0NBT0M7QUFHRCxJQUFJLGlCQUFpQixHQUF3QyxTQUFTLENBQUE7QUFFdEUsU0FBZ0Isc0JBQXNCLENBQUMsQ0FBMkI7SUFDaEUsaUJBQWlCLEdBQUcsQ0FBQyxDQUFBO0FBQ3ZCLENBQUM7QUFGRCx3REFFQztBQUVELFFBQVEsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxPQUF1QjtJQUN6QyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLGdCQUFnQixFQUFFLENBQUE7SUFFL0MsS0FBSyxNQUFNLE9BQU8sSUFBSSxRQUFRLEVBQUU7UUFDOUIsSUFBSSxPQUFPLEtBQUssU0FBUyxJQUFJLE9BQU8sQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLEtBQUssT0FBTyxFQUFFO1lBQ3hFLE1BQU0sT0FBTyxDQUFDLFNBQVMsQ0FBQTtTQUN4QjtLQUNGO0FBQ0gsQ0FBQztBQUVELFNBQVMsY0FBYyxDQUFDLElBQVk7SUFDbEMsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLGNBQWMsQ0FDL0IsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxlQUFlLEVBQUUsR0FBRyxJQUFJLE9BQU8sQ0FBQyxDQUNsRSxDQUFBO0FBQ0gs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QUM5QixJQUFJLFdBQVcsRUFBRTtRQUNmLGtCQUFrQixHQUFHLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQTtLQUM5QztTQUFNO1FBQ0wsa0JBQWtCLEdBQUcsRUFBRSxDQUFBO0tBQ3hCO0lBQ0QsT0FBTzs7Ozs7YUFLSSxLQUFLLFdBQVcsa0JBQWtCO2FBQ2xDLHFCQUFxQixFQUFFO0VBQ2xDLElBQUksQ0FBQyxJQUFLLENBQUMsU0FBUzs7O01BR2hCLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUzs7O0NBR3hCLENBQUE7QUFDRCxDQUFDO0FBMUJELHdCQTBCQztBQUVELFNBQWdCLE9BQU8sQ0FBQyxJQUFZO0lBQ2xDLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFBO0lBQzdDLElBQUksSUFBSTtRQUFFLG9CQUFhLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFBO0FBQ2pELENBQUM7QUFIRCwwQkFHQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRleHRFZGl0b3IgfSBmcm9tICdhdG9tJ1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJ1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnXG5pbXBvcnQgeyBUb2tlbiB9IGZyb20gJ21hcmtkb3duLWl0J1xuaW1wb3J0IHsgaGFuZGxlUHJvbWlzZSwgYXRvbUNvbmZpZyB9IGZyb20gJy4uL3V0aWwnXG5cbmV4cG9ydCBmdW5jdGlvbiBlZGl0b3JGb3JJZChlZGl0b3JJZDogbnVtYmVyKTogVGV4dEVkaXRvciB8IHVuZGVmaW5lZCB7XG4gIGZvciAoY29uc3QgZWRpdG9yIG9mIGF0b20ud29ya3NwYWNlLmdldFRleHRFZGl0b3JzKCkpIHtcbiAgICBpZiAoZWRpdG9yLmlkID09PSBlZGl0b3JJZCkge1xuICAgICAgcmV0dXJuIGVkaXRvclxuICAgIH1cbiAgfVxuICByZXR1cm4gdW5kZWZpbmVkXG59XG5cbi8vIHRoaXMgd2VpcmRuZXNzIGFsbG93cyBvdmVycmlkaW5nIGluIHRlc3RzXG5sZXQgZ2V0U3R5bGVzT3ZlcnJpZGU6IHR5cGVvZiBnZXRQcmV2aWV3U3R5bGVzIHwgdW5kZWZpbmVkID0gdW5kZWZpbmVkXG5cbmV4cG9ydCBmdW5jdGlvbiBfX3NldEdldFN0eWxlc092ZXJyaWRlKGY/OiB0eXBlb2YgZ2V0UHJldmlld1N0eWxlcykge1xuICBnZXRTdHlsZXNPdmVycmlkZSA9IGZcbn1cblxuZnVuY3Rpb24qIGdldFN0eWxlcyhjb250ZXh0Pzogc3RyaW5nIHwgbnVsbCk6IEl0ZXJhYmxlSXRlcmF0b3I8c3RyaW5nPiB7XG4gIGNvbnN0IGVsZW1lbnRzID0gYXRvbS5zdHlsZXMuZ2V0U3R5bGVFbGVtZW50cygpXG5cbiAgZm9yIChjb25zdCBlbGVtZW50IG9mIGVsZW1lbnRzKSB7XG4gICAgaWYgKGNvbnRleHQgPT09IHVuZGVmaW5lZCB8fCBlbGVtZW50LmdldEF0dHJpYnV0ZSgnY29udGV4dCcpID09PSBjb250ZXh0KSB7XG4gICAgICB5aWVsZCBlbGVtZW50LmlubmVyVGV4dFxuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBnZXRDbGllbnRTdHlsZShmaWxlOiBzdHJpbmcpOiBzdHJpbmcge1xuICByZXR1cm4gYXRvbS50aGVtZXMubG9hZFN0eWxlc2hlZXQoXG4gICAgcGF0aC5qb2luKF9fZGlybmFtZSwgJy4uJywgJy4uJywgJ3N0eWxlcy1jbGllbnQnLCBgJHtmaWxlfS5sZXNzYCksXG4gIClcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFVzZXJTdHlsZXMoKSB7XG4gIGNvbnN0IGVsID1cbiAgICBhdG9tLnN0eWxlcy5zdHlsZUVsZW1lbnRzQnlTb3VyY2VQYXRoW2F0b20uc3R5bGVzLmdldFVzZXJTdHlsZVNoZWV0UGF0aCgpXVxuICBpZiAoIWVsKSByZXR1cm4gW11cbiAgcmV0dXJuIFtlbC5pbm5lclRleHRdXG59XG5cbmZ1bmN0aW9uIGdldFN5bnRheFRoZW1lKHRoZW1lTmFtZTogc3RyaW5nKTogSXRlcmFibGU8c3RyaW5nPiB7XG4gIGlmICh0aGVtZU5hbWUgIT09ICcnKSB7XG4gICAgY29uc3QgdGhlbWVzID0gYXRvbS50aGVtZXMuZ2V0TG9hZGVkVGhlbWVzKClcbiAgICBpZiAodGhlbWVzKSB7XG4gICAgICBjb25zdCBbdGhlbWVdID0gdGhlbWVzLmZpbHRlcigoeCkgPT4geC5uYW1lID09PSB0aGVtZU5hbWUpXG4gICAgICBpZiAodGhlbWUpIHtcbiAgICAgICAgY29uc3Qgc3RzaHRzID0gdGhlbWVcbiAgICAgICAgICAuZ2V0U3R5bGVzaGVldFBhdGhzKClcbiAgICAgICAgICAubWFwKChwKSA9PiBhdG9tLnRoZW1lcy5sb2FkU3R5bGVzaGVldChwKSlcbiAgICAgICAgcmV0dXJuIHByb2Nlc3NFZGl0b3JTdHlsZXMoc3RzaHRzKVxuICAgICAgfVxuICAgIH1cbiAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkV2FybmluZygnRmFpbGVkIHRvIGxvYWQgc3ludGF4IHRoZW1lJywge1xuICAgICAgZGV0YWlsOiBgTWFya2Rvd24tcHJldmlldy1wbHVzIGNvdWxkbid0IGZpbmQgJyR7dGhlbWVOYW1lfSdgLFxuICAgIH0pXG4gIH1cbiAgLy8gZGVmYXVsdFxuICByZXR1cm4gcHJvY2Vzc0VkaXRvclN0eWxlcyhnZXRTdHlsZXMoJ2F0b20tdGV4dC1lZGl0b3InKSlcbn1cblxuZnVuY3Rpb24qIGdldEFjdGl2ZVBhY2thZ2VTdHlsZXMoXG4gIHBhY2thZ2VOYW1lOiBzdHJpbmcsXG4pOiBJdGVyYWJsZUl0ZXJhdG9yPHN0cmluZz4ge1xuICBjb25zdCBwYWNrID0gYXRvbS5wYWNrYWdlcy5nZXRBY3RpdmVQYWNrYWdlKHBhY2thZ2VOYW1lKVxuICBpZiAoIXBhY2spIHJldHVybiB1bmRlZmluZWRcbiAgY29uc3Qgc3R5bGVzaGVldHMgPSBwYWNrLmdldFN0eWxlc2hlZXRQYXRocygpXG4gIGZvciAoY29uc3Qgc3Mgb2Ygc3R5bGVzaGVldHMpIHtcbiAgICBjb25zdCBlbGVtZW50ID0gYXRvbS5zdHlsZXMuc3R5bGVFbGVtZW50c0J5U291cmNlUGF0aFtzc11cbiAgICBpZiAoZWxlbWVudCkgeWllbGQgZWxlbWVudC5pbm5lclRleHRcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0UHJldmlld1N0eWxlcyhkaXNwbGF5OiBib29sZWFuKTogc3RyaW5nW10ge1xuICBpZiAoZ2V0U3R5bGVzT3ZlcnJpZGUpIHJldHVybiBnZXRTdHlsZXNPdmVycmlkZShkaXNwbGF5KVxuICBjb25zdCBzdHlsZXMgPSBbXVxuICBpZiAoZGlzcGxheSkge1xuICAgIC8vIGdsb2JhbCBlZGl0b3Igc3R5bGVzXG4gICAgY29uc3QgZ2xvYmFsU3R5bGVzID1cbiAgICAgIGF0b20uc3R5bGVzLnN0eWxlRWxlbWVudHNCeVNvdXJjZVBhdGhbJ2dsb2JhbC10ZXh0LWVkaXRvci1zdHlsZXMnXVxuICAgIGlmIChnbG9iYWxTdHlsZXMpIHtcbiAgICAgIHN0eWxlcy5wdXNoKC4uLnByb2Nlc3NXb3Jrc3BhY2VTdHlsZXMoW2dsb2JhbFN0eWxlcy5pbm5lclRleHRdKSlcbiAgICB9XG4gICAgc3R5bGVzLnB1c2goZ2V0Q2xpZW50U3R5bGUoJ2VkaXRvci1nbG9iYWwtZm9udCcpKVxuICAgIC8vIHBhY2thZ2Ugc3R5bGVzXG4gICAgY29uc3QgcGFja0xpc3QgPSBhdG9tQ29uZmlnKCkuaW1wb3J0UGFja2FnZVN0eWxlc1xuICAgIGlmIChwYWNrTGlzdC5pbmNsdWRlcygnKicpKSB7XG4gICAgICBzdHlsZXMucHVzaCguLi5wcm9jZXNzRWRpdG9yU3R5bGVzKGdldFN0eWxlcygpKSlcbiAgICAgIHN0eWxlcy5wdXNoKGdldENsaWVudFN0eWxlKCdwYXRjaCcpKVxuICAgIH0gZWxzZSB7XG4gICAgICBmb3IgKGNvbnN0IHBhY2sgb2YgcGFja0xpc3QpIHtcbiAgICAgICAgc3R5bGVzLnB1c2goLi4ucHJvY2Vzc0VkaXRvclN0eWxlcyhnZXRBY3RpdmVQYWNrYWdlU3R5bGVzKHBhY2spKSlcbiAgICAgIH1cbiAgICAgIC8vIGV4cGxpY2l0IGNvbXBhdGliaWxpdHkgd2l0aCB0aGUgZm9udHMgcGFja2FnZVxuICAgICAgaWYgKHBhY2tMaXN0LmluY2x1ZGVzKCdmb250cycpKSB7XG4gICAgICAgIGNvbnN0IGZvbnRzVmFyID1cbiAgICAgICAgICBhdG9tLnN0eWxlcy5zdHlsZUVsZW1lbnRzQnlTb3VyY2VQYXRoWydmb250cy1wYWNrYWdlLWVkaXRvcmZvbnQnXVxuICAgICAgICBpZiAoZm9udHNWYXIpIHN0eWxlcy5wdXNoKC4uLnByb2Nlc3NFZGl0b3JTdHlsZXMoW2ZvbnRzVmFyLmlubmVyVGV4dF0pKVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHN0eWxlcy5wdXNoKGdldENsaWVudFN0eWxlKCdnZW5lcmljJykpXG4gIGlmIChkaXNwbGF5KSBzdHlsZXMucHVzaChnZXRDbGllbnRTdHlsZSgnZGlzcGxheScpKVxuICBpZiAoYXRvbUNvbmZpZygpLnVzZUdpdEh1YlN0eWxlKSB7XG4gICAgc3R5bGVzLnB1c2goZ2V0Q2xpZW50U3R5bGUoJ2dpdGh1YicpKVxuICB9IGVsc2Uge1xuICAgIHN0eWxlcy5wdXNoKGdldENsaWVudFN0eWxlKCdkZWZhdWx0JykpXG4gIH1cbiAgc3R5bGVzLnB1c2goLi4uZ2V0U3ludGF4VGhlbWUoYXRvbUNvbmZpZygpLnN5bnRheFRoZW1lTmFtZSkpXG4gIHN0eWxlcy5wdXNoKC4uLnByb2Nlc3NFZGl0b3JTdHlsZXMoZ2V0VXNlclN0eWxlcygpKSlcbiAgcmV0dXJuIHN0eWxlc1xufVxuXG5mdW5jdGlvbiogcHJvY2Vzc0VkaXRvclN0eWxlcyhzdHlsZXM6IEl0ZXJhYmxlPHN0cmluZz4pIHtcbiAgZm9yIChjb25zdCBzdHlsZSBvZiBzdHlsZXMpIHtcbiAgICB5aWVsZCBzdHlsZS5yZXBsYWNlKC9cXGJhdG9tLXRleHQtZWRpdG9yXFxiL2csICdwcmUuZWRpdG9yLWNvbG9ycycpXG4gIH1cbn1cblxuZnVuY3Rpb24qIHByb2Nlc3NXb3Jrc3BhY2VTdHlsZXMoc3R5bGVzOiBJdGVyYWJsZTxzdHJpbmc+KSB7XG4gIGZvciAoY29uc3Qgc3R5bGUgb2Ygc3R5bGVzKSB7XG4gICAgeWllbGQgc3R5bGUucmVwbGFjZSgvXFxiYXRvbS13b3Jrc3BhY2VcXGIvZywgJzpyb290JylcbiAgfVxufVxuXG5mdW5jdGlvbiBnZXRNYXJrZG93blByZXZpZXdDU1MoKSB7XG4gIGNvbnN0IGNzc1VybFJlZkV4cCA9IC91cmxcXChhdG9tOlxcL1xcL21hcmtkb3duLXByZXZpZXctcGx1c1xcL2Fzc2V0c1xcLyguKilcXCkvXG5cbiAgcmV0dXJuIGdldFByZXZpZXdTdHlsZXMoZmFsc2UpXG4gICAgLmpvaW4oJ1xcbicpXG4gICAgLnJlcGxhY2UoY3NzVXJsUmVmRXhwLCBmdW5jdGlvbihcbiAgICAgIF9tYXRjaCxcbiAgICAgIGFzc2V0c05hbWU6IHN0cmluZyxcbiAgICAgIF9vZmZzZXQsXG4gICAgICBfc3RyaW5nLFxuICAgICkge1xuICAgICAgLy8gYmFzZTY0IGVuY29kZSBhc3NldHNcbiAgICAgIGNvbnN0IGFzc2V0UGF0aCA9IHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi8uLi9hc3NldHMnLCBhc3NldHNOYW1lKVxuICAgICAgY29uc3Qgb3JpZ2luYWxEYXRhID0gZnMucmVhZEZpbGVTeW5jKGFzc2V0UGF0aCwgJ2JpbmFyeScpXG4gICAgICBjb25zdCBiYXNlNjREYXRhID0gbmV3IEJ1ZmZlcihvcmlnaW5hbERhdGEsICdiaW5hcnknKS50b1N0cmluZygnYmFzZTY0JylcbiAgICAgIHJldHVybiBgdXJsKCdkYXRhOmltYWdlL2pwZWc7YmFzZTY0LCR7YmFzZTY0RGF0YX0nKWBcbiAgICB9KVxufVxuXG4vL1xuLy8gRGVjb2RlIHRhZ3MgdXNlZCBieSBtYXJrZG93bi1pdFxuLy9cbi8vIEBwYXJhbSB7bWFya2Rvd24taXQuVG9rZW59IHRva2VuIERlY29kZSB0aGUgdGFnIG9mIHRva2VuLlxuLy8gQHJldHVybiB7c3RyaW5nfG51bGx9IERlY29kZWQgdGFnIG9yIGBudWxsYCBpZiB0aGUgdG9rZW4gaGFzIG5vIHRhZy5cbi8vXG5mdW5jdGlvbiBkZWNvZGVUYWcodG9rZW46IFRva2VuKTogc3RyaW5nIHwgbnVsbCB7XG4gIGlmICh0b2tlbi50YWcgPT09ICdtYXRoJykge1xuICAgIHJldHVybiAnc3BhbidcbiAgfVxuICBpZiAodG9rZW4udGFnID09PSAnY29kZScpIHtcbiAgICByZXR1cm4gJ2F0b20tdGV4dC1lZGl0b3InXG4gIH1cbiAgaWYgKHRva2VuLnRhZyA9PT0gJycpIHtcbiAgICByZXR1cm4gbnVsbFxuICB9XG4gIHJldHVybiB0b2tlbi50YWdcbn1cblxuLy9cbi8vIERldGVybWluZSBwYXRoIHRvIGEgdGFyZ2V0IHRva2VuLlxuLy9cbi8vIEBwYXJhbSB7KG1hcmtkb3duLWl0LlRva2VuKVtdfSB0b2tlbnMgQXJyYXkgb2YgdG9rZW5zIGFzIHJldHVybmVkIGJ5XG4vLyAgIGBtYXJrZG93bi1pdC5wYXJzZSgpYC5cbi8vIEBwYXJhbSB7bnVtYmVyfSBsaW5lIExpbmUgcmVwcmVzZW50aW5nIHRoZSB0YXJnZXQgdG9rZW4uXG4vLyBAcmV0dXJuIHsodGFnOiA8dGFnPiwgaW5kZXg6IDxpbmRleD4pW119IEFycmF5IHJlcHJlc2VudGluZyBhIHBhdGggdG8gdGhlXG4vLyAgIHRhcmdldCB0b2tlbi4gVGhlIHJvb3QgdG9rZW4gaXMgcmVwcmVzZW50ZWQgYnkgdGhlIGZpcnN0IGVsZW1lbnQgaW4gdGhlXG4vLyAgIGFycmF5IGFuZCB0aGUgdGFyZ2V0IHRva2VuIGJ5IHRoZSBsYXN0IGVsbWVudC4gRWFjaCBlbGVtZW50IGNvbnNpc3RzIG9mIGFcbi8vICAgYHRhZ2AgYW5kIGBpbmRleGAgcmVwcmVzZW50aW5nIGl0cyBpbmRleCBhbW9uZ3N0IGl0cyBzaWJsaW5nIHRva2VucyBpblxuLy8gICBgdG9rZW5zYCBvZiB0aGUgc2FtZSBgdGFnYC4gYGxpbmVgIHdpbGwgbGllIGJldHdlZW4gdGhlIHByb3BlcnRpZXNcbi8vICAgYG1hcFswXWAgYW5kIGBtYXBbMV1gIG9mIHRoZSB0YXJnZXQgdG9rZW4uXG4vL1xuZXhwb3J0IGZ1bmN0aW9uIGJ1aWxkTGluZU1hcCh0b2tlbnM6IFJlYWRvbmx5QXJyYXk8UmVhZG9ubHk8VG9rZW4+Pikge1xuICBjb25zdCBsaW5lTWFwOiB7IFtsaW5lOiBudW1iZXJdOiBBcnJheTx7IHRhZzogc3RyaW5nOyBpbmRleDogbnVtYmVyIH0+IH0gPSB7fVxuICBjb25zdCB0b2tlblRhZ0NvdW50OiB7IFtsaW5lOiBudW1iZXJdOiB7IFt0YWc6IHN0cmluZ106IG51bWJlciB9IH0gPSB7fVxuICB0b2tlblRhZ0NvdW50WzBdID0ge31cblxuICBmb3IgKGNvbnN0IHRva2VuIG9mIHRva2Vucykge1xuICAgIGlmICh0b2tlbi5oaWRkZW4pIGNvbnRpbnVlXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnN0cmljdC10eXBlLXByZWRpY2F0ZXMgLy8gVE9ETzogY29tcGxhaW4gb24gRFRcbiAgICBpZiAodG9rZW4ubWFwID09IG51bGwpIGNvbnRpbnVlXG5cbiAgICBjb25zdCB0YWcgPSBkZWNvZGVUYWcodG9rZW4pXG4gICAgaWYgKHRhZyA9PT0gbnVsbCkgY29udGludWVcblxuICAgIGlmICh0b2tlbi5uZXN0aW5nID09PSAxKSB7XG4gICAgICAvLyBvcGVuaW5nIHRhZ1xuICAgICAgZm9yIChsZXQgbGluZSA9IHRva2VuLm1hcFswXTsgbGluZSA8IHRva2VuLm1hcFsxXTsgbGluZSArPSAxKSB7XG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpzdHJpY3QtdHlwZS1wcmVkaWNhdGVzXG4gICAgICAgIGlmIChsaW5lTWFwW2xpbmVdID09IG51bGwpIGxpbmVNYXBbbGluZV0gPSBbXVxuICAgICAgICBsaW5lTWFwW2xpbmVdLnB1c2goe1xuICAgICAgICAgIHRhZzogdGFnLFxuICAgICAgICAgIGluZGV4OiB0b2tlblRhZ0NvdW50W3Rva2VuLmxldmVsXVt0YWddIHx8IDAsXG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgICB0b2tlblRhZ0NvdW50W3Rva2VuLmxldmVsICsgMV0gPSB7fVxuICAgIH0gZWxzZSBpZiAodG9rZW4ubmVzdGluZyA9PT0gMCkge1xuICAgICAgLy8gc2VsZi1jbG9zaW5nIHRhZ1xuICAgICAgZm9yIChsZXQgbGluZSA9IHRva2VuLm1hcFswXTsgbGluZSA8IHRva2VuLm1hcFsxXTsgbGluZSArPSAxKSB7XG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpzdHJpY3QtdHlwZS1wcmVkaWNhdGVzXG4gICAgICAgIGlmIChsaW5lTWFwW2xpbmVdID09IG51bGwpIGxpbmVNYXBbbGluZV0gPSBbXVxuICAgICAgICBsaW5lTWFwW2xpbmVdLnB1c2goe1xuICAgICAgICAgIHRhZzogdGFnLFxuICAgICAgICAgIGluZGV4OiB0b2tlblRhZ0NvdW50W3Rva2VuLmxldmVsXVt0YWddIHx8IDAsXG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgfVxuICAgIGNvbnN0IHR0YyA9IHRva2VuVGFnQ291bnRbdG9rZW4ubGV2ZWxdW3RhZ11cbiAgICB0b2tlblRhZ0NvdW50W3Rva2VuLmxldmVsXVt0YWddID0gdHRjID8gdHRjICsgMSA6IDFcbiAgfVxuXG4gIHJldHVybiBsaW5lTWFwXG59XG5cbmZ1bmN0aW9uIG1hdGhKYXhTY3JpcHQodGV4Q29uZmlnOiBNYXRoSmF4LlRlWElucHV0UHJvY2Vzc29yKSB7XG4gIHJldHVybiBgXFxcbjxzY3JpcHQgdHlwZT1cInRleHQveC1tYXRoamF4LWNvbmZpZ1wiPlxuICBNYXRoSmF4Lkh1Yi5Db25maWcoe1xuICAgIGpheDogW1wiaW5wdXQvVGVYXCIsXCJvdXRwdXQvSFRNTC1DU1NcIl0sXG4gICAgZXh0ZW5zaW9uczogW1wiW2ExMXldL2FjY2Vzc2liaWxpdHktbWVudS5qc1wiXSxcbiAgICAnSFRNTC1DU1MnOiB7XG4gICAgICBhdmFpbGFibGVGb250czogW10sXG4gICAgICB3ZWJGb250OiAnVGVYJyxcbiAgICAgIHVuZGVmaW5lZEZhbWlseTogJHtKU09OLnN0cmluZ2lmeShcbiAgICAgICAgYXRvbUNvbmZpZygpLm1hdGhDb25maWcudW5kZWZpbmVkRmFtaWx5LFxuICAgICAgKX0sXG4gICAgICBtdGV4dEZvbnRJbmhlcml0OiB0cnVlLFxuICAgIH0sXG4gICAgVGVYOiAke0pTT04uc3RyaW5naWZ5KHRleENvbmZpZywgdW5kZWZpbmVkLCAyKX0sXG4gICAgc2hvd01hdGhNZW51OiB0cnVlXG4gIH0pO1xuPC9zY3JpcHQ+XG48c2NyaXB0IHR5cGU9XCJ0ZXh0L2phdmFzY3JpcHRcIiBzcmM9XCJodHRwczovL2NkbmpzLmNsb3VkZmxhcmUuY29tL2FqYXgvbGlicy9tYXRoamF4LzIuNy40L01hdGhKYXguanNcIj48L3NjcmlwdD5gXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBta0h0bWwoXG4gIHRpdGxlOiBzdHJpbmcsXG4gIGh0bWw6IEhUTUxEb2N1bWVudCxcbiAgcmVuZGVyTGFUZVg6IGJvb2xlYW4sXG4gIHRleENvbmZpZzogTWF0aEpheC5UZVhJbnB1dFByb2Nlc3Nvcixcbikge1xuICBsZXQgbWF5YmVNYXRoSmF4U2NyaXB0OiBzdHJpbmdcbiAgaWYgKHJlbmRlckxhVGVYKSB7XG4gICAgbWF5YmVNYXRoSmF4U2NyaXB0ID0gbWF0aEpheFNjcmlwdCh0ZXhDb25maWcpXG4gIH0gZWxzZSB7XG4gICAgbWF5YmVNYXRoSmF4U2NyaXB0ID0gJydcbiAgfVxuICByZXR1cm4gYFxcXG48IURPQ1RZUEUgaHRtbD5cbjxodG1sIGRhdGEtbWFya2Rvd24tcHJldmlldy1wbHVzLWNvbnRleHQ9XCJodG1sLWV4cG9ydFwiPlxuICA8aGVhZD5cbiAgICA8bWV0YSBjaGFyc2V0PVwidXRmLThcIiAvPlxuICAgIDx0aXRsZT4ke3RpdGxlfTwvdGl0bGU+JHttYXliZU1hdGhKYXhTY3JpcHR9XG4gICAgPHN0eWxlPiR7Z2V0TWFya2Rvd25QcmV2aWV3Q1NTKCl9PC9zdHlsZT5cbiR7aHRtbC5oZWFkIS5pbm5lckhUTUx9XG4gIDwvaGVhZD5cbiAgPGJvZHk+XG4gICAgJHtodG1sLmJvZHkuaW5uZXJIVE1MfVxuICA8L2JvZHk+XG48L2h0bWw+XG5gIC8vIEVuc3VyZSB0cmFpbGluZyBuZXdsaW5lXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBkZXN0cm95KGl0ZW06IG9iamVjdCkge1xuICBjb25zdCBwYW5lID0gYXRvbS53b3Jrc3BhY2UucGFuZUZvckl0ZW0oaXRlbSlcbiAgaWYgKHBhbmUpIGhhbmRsZVByb21pc2UocGFuZS5kZXN0cm95SXRlbShpdGVtKSlcbn1cbiJdfQ==