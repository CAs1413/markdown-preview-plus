"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const electron_1 = require("electron");
const fileUriToPath = require("file-uri-to-path");
const util_1 = require("../util");
const util_2 = require("./util");
const image_watch_helper_1 = require("../image-watch-helper");
class WebviewHandler {
    constructor(init) {
        this.emitter = new atom_1.Emitter();
        this.disposables = new atom_1.CompositeDisposable();
        this.destroyed = false;
        this.zoomLevel = 0;
        this.replyCallbacks = new Map();
        this.replyCallbackId = 0;
        this._element = document.createElement('webview');
        this._element.classList.add('markdown-preview-plus', 'native-key-bindings');
        this._element.disablewebsecurity = 'true';
        this._element.nodeintegration = 'true';
        this._element.src = `file:///${__dirname}/../../client/template.html`;
        this._element.style.width = '100%';
        this._element.style.height = '100%';
        this._element.addEventListener('ipc-message', (e) => {
            switch (e.channel) {
                case 'zoom-in':
                    this.zoomIn();
                    break;
                case 'zoom-out':
                    this.zoomOut();
                    break;
                case 'did-scroll-preview':
                    this.emitter.emit('did-scroll-preview', e.args[0]);
                    break;
                case 'uncaught-error': {
                    const err = e.args[0];
                    const newErr = new Error();
                    atom.notifications.addFatalError(`Uncaught error ${err.name} in markdown-preview-plus webview client`, {
                        dismissable: true,
                        stack: newErr.stack,
                        detail: `${err.message}\n\nstack:\n${err.stack}`,
                    });
                    break;
                }
                case 'show-context-menu': {
                    atom.contextMenu.showForEvent({ target: this._element });
                    break;
                }
                case 'request-reply': {
                    const { id, request, result } = e.args[0];
                    const cb = this.replyCallbacks.get(id);
                    if (cb && request === cb.request) {
                        const callback = cb.callback;
                        callback(result);
                    }
                    break;
                }
            }
        });
        this._element.addEventListener('will-navigate', async (e) => {
            const exts = util_1.atomConfig().previewConfig.shellOpenFileExtensions;
            const forceOpenExternal = exts.some((ext) => e.url.toLowerCase().endsWith(`.${ext.toLowerCase()}`));
            if (e.url.startsWith('file://') && !forceOpenExternal) {
                util_1.handlePromise(atom.workspace.open(fileUriToPath(e.url)));
            }
            else {
                electron_1.shell.openExternal(e.url);
            }
        });
        this.disposables.add(atom.styles.onDidAddStyleElement(() => {
            util_1.handlePromise(this.updateStyles());
        }), atom.styles.onDidRemoveStyleElement(() => {
            util_1.handlePromise(this.updateStyles());
        }), atom.styles.onDidUpdateStyleElement(() => {
            util_1.handlePromise(this.updateStyles());
        }));
        this.initPromise = new Promise((resolve) => {
            this._element.addEventListener('dom-ready', () => {
                if (this.destroyed)
                    return;
                this._element.setZoomLevel(this.zoomLevel);
                resolve();
                util_1.handlePromise(this.updateStyles().then(init));
            });
        });
        this.disposables.add((this.imageWatcher = new image_watch_helper_1.ImageWatcher(this.updateImages.bind(this))));
    }
    get element() {
        return this._element;
    }
    async runJS(js) {
        return new Promise((resolve) => this._element.executeJavaScript(js, false, resolve));
    }
    destroy() {
        if (this.destroyed)
            return;
        this.destroyed = true;
        this.disposables.dispose();
        this._element.remove();
    }
    async update(html, renderLaTeX) {
        if (this.destroyed)
            return undefined;
        return this.runRequest('update-preview', {
            html,
            renderLaTeX,
        });
    }
    async fullyReady() {
        if (this.destroyed)
            return;
        return this.runRequest('await-fully-ready', {});
    }
    async setSourceMap(map) {
        return this.send('set-source-map', { map });
    }
    async setBasePath(path) {
        return this.send('set-base-path', { path });
    }
    async init(params) {
        return this.send('init', params);
    }
    async updateImages(oldSource, version) {
        return this.send('update-images', {
            oldsrc: oldSource,
            v: version,
        });
    }
    async printToPDF(opts) {
        return new Promise((resolve, reject) => {
            this._element.getWebContents().printToPDF(opts, (error, data) => {
                if (error) {
                    reject(error);
                    return;
                }
                resolve(data);
            });
        });
    }
    async sync(line, flash) {
        return this.send('sync', { line, flash });
    }
    async syncSource() {
        return this.runRequest('sync-source', {});
    }
    async scrollSync(firstLine, lastLine) {
        return this.send('scroll-sync', { firstLine, lastLine });
    }
    zoomIn() {
        this.zoomLevel += 0.1;
        this._element.setZoomLevel(this.zoomLevel);
    }
    zoomOut() {
        this.zoomLevel -= 0.1;
        this._element.setZoomLevel(this.zoomLevel);
    }
    resetZoom() {
        this.zoomLevel = 0;
        this._element.setZoomLevel(this.zoomLevel);
    }
    print() {
        this._element.print();
    }
    openDevTools() {
        this._element.openDevTools();
    }
    async reload() {
        await this.runRequest('reload', {});
        this._element.reload();
    }
    async error(msg) {
        return this.send('error', { msg });
    }
    async getTeXConfig() {
        return this.runRequest('get-tex-config', {});
    }
    async getSelection() {
        return this.runRequest('get-selection', {});
    }
    async updateStyles() {
        return this.send('style', { styles: util_2.getPreviewStyles(true) });
    }
    async runRequest(request, args) {
        const id = this.replyCallbackId++;
        const result = new Promise((resolve) => {
            this.replyCallbacks.set(id, {
                request: request,
                callback: (result) => {
                    this.replyCallbacks.delete(id);
                    resolve(result);
                },
            });
        });
        const newargs = Object.assign({ id }, args);
        await this.send(request, newargs);
        return result;
    }
    async send(channel, value) {
        await this.initPromise;
        this._element.send(channel, value);
    }
}
exports.WebviewHandler = WebviewHandler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2Vidmlldy1oYW5kbGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL21hcmtkb3duLXByZXZpZXctdmlldy93ZWJ2aWV3LWhhbmRsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrQkFBbUQ7QUFDbkQsdUNBQTRDO0FBQzVDLGtEQUFrRDtBQUVsRCxrQ0FBbUQ7QUFFbkQsaUNBQXlDO0FBQ3pDLDhEQUFvRDtBQTJDcEQsTUFBYSxjQUFjO0lBZ0J6QixZQUFZLElBQWdDO1FBZjVCLFlBQU8sR0FBRyxJQUFJLGNBQU8sRUFLbEMsQ0FBQTtRQUVPLGdCQUFXLEdBQUcsSUFBSSwwQkFBbUIsRUFBRSxDQUFBO1FBRXpDLGNBQVMsR0FBRyxLQUFLLENBQUE7UUFDakIsY0FBUyxHQUFHLENBQUMsQ0FBQTtRQUNiLG1CQUFjLEdBQUcsSUFBSSxHQUFHLEVBQStCLENBQUE7UUFDdkQsb0JBQWUsR0FBRyxDQUFDLENBQUE7UUFJekIsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxDQUFBO1FBQ2pELElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyx1QkFBdUIsRUFBRSxxQkFBcUIsQ0FBQyxDQUFBO1FBQzNFLElBQUksQ0FBQyxRQUFRLENBQUMsa0JBQWtCLEdBQUcsTUFBTSxDQUFBO1FBQ3pDLElBQUksQ0FBQyxRQUFRLENBQUMsZUFBZSxHQUFHLE1BQU0sQ0FBQTtRQUN0QyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsR0FBRyxXQUFXLFNBQVMsNkJBQTZCLENBQUE7UUFDckUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsS0FBSyxHQUFHLE1BQU0sQ0FBQTtRQUNsQyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFBO1FBQ25DLElBQUksQ0FBQyxRQUFRLENBQUMsZ0JBQWdCLENBQzVCLGFBQWEsRUFDYixD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QUFVLENBQ3hCLE9BQVUsRUFDVixJQUFxRTtRQUVyRSxNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUE7UUFDakMsTUFBTSxNQUFNLEdBQUcsSUFBSSxPQUFPLENBQXFCLENBQUMsT0FBTyxFQUFFLEVBQUU7WUFDekQsSUFBSSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFHO2dCQUMzQixPQUFPLEVBQUUsT0FBTztnQkFDaEIsUUFBUSxFQUFFLENBQUMsTUFBMEIsRUFBRSxFQUFFO29CQUN2QyxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQTtvQkFDOUIsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFBO2dCQUNqQixDQUFDO2FBQ29DLENBQUMsQ0FBQTtRQUMxQyxDQUFDLENBQUMsQ0FBQTtRQUNGLE1BQU0sT0FBTyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFBRSxJQUFJLENBQUMsQ0FBQTtRQUMzQyxNQUFNLElBQUksQ0FBQyxJQUFJLENBQUksT0FBTyxFQUFFLE9BQXdCLENBQUMsQ0FBQTtRQUNyRCxPQUFPLE1BQU0sQ0FBQTtJQUNmLENBQUM7SUFFUyxLQUFLLENBQUMsSUFBSSxDQUNsQixPQUFVLEVBQ1YsS0FBb0I7UUFFcEIsTUFBTSxJQUFJLENBQUMsV0FBVyxDQUFBO1FBQ3RCLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFJLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQTtJQUN2QyxDQUFDO0NBQ0Y7QUEzUEQsd0NBMlBDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRW1pdHRlciwgQ29tcG9zaXRlRGlzcG9zYWJsZSB9IGZyb20gJ2F0b20nXG5pbXBvcnQgeyBXZWJ2aWV3VGFnLCBzaGVsbCB9IGZyb20gJ2VsZWN0cm9uJ1xuaW1wb3J0IGZpbGVVcmlUb1BhdGggPSByZXF1aXJlKCdmaWxlLXVyaS10by1wYXRoJylcblxuaW1wb3J0IHsgaGFuZGxlUHJvbWlzZSwgYXRvbUNvbmZpZyB9IGZyb20gJy4uL3V0aWwnXG5pbXBvcnQgeyBSZXF1ZXN0UmVwbHlNYXAsIENoYW5uZWxNYXAgfSBmcm9tICcuLi8uLi9zcmMtY2xpZW50L2lwYydcbmltcG9ydCB7IGdldFByZXZpZXdTdHlsZXMgfSBmcm9tICcuL3V0aWwnXG5pbXBvcnQgeyBJbWFnZVdhdGNoZXIgfSBmcm9tICcuLi9pbWFnZS13YXRjaC1oZWxwZXInXG5cbmV4cG9ydCB0eXBlIFJlcGx5Q2FsbGJhY2tTdHJ1Y3Q8XG4gIFQgZXh0ZW5kcyBrZXlvZiBSZXF1ZXN0UmVwbHlNYXAgPSBrZXlvZiBSZXF1ZXN0UmVwbHlNYXBcbj4gPSB7XG4gIFtLIGluIGtleW9mIFJlcXVlc3RSZXBseU1hcF06IHtcbiAgICByZXF1ZXN0OiBLXG4gICAgY2FsbGJhY2s6IChyZXBseTogUmVxdWVzdFJlcGx5TWFwW0tdKSA9PiB2b2lkXG4gIH1cbn1bVF1cblxuaW50ZXJmYWNlIFByaW50VG9QREZPcHRpb25zUmVhbCB7XG4gIC8qKlxuICAgKiBTcGVjaWZpZXMgdGhlIHR5cGUgb2YgbWFyZ2lucyB0byB1c2UuIFVzZXMgMCBmb3IgZGVmYXVsdCBtYXJnaW4sIDEgZm9yIG5vXG4gICAqIG1hcmdpbiwgYW5kIDIgZm9yIG1pbmltdW0gbWFyZ2luLlxuICAgKi9cbiAgbWFyZ2luc1R5cGU/OiBudW1iZXJcbiAgLyoqXG4gICAqIFNwZWNpZnkgcGFnZSBzaXplIG9mIHRoZSBnZW5lcmF0ZWQgUERGLiBDYW4gYmUgQTMsIEE0LCBBNSwgTGVnYWwsIExldHRlcixcbiAgICogVGFibG9pZCBvciBhbiBPYmplY3QgY29udGFpbmluZyBoZWlnaHQgYW5kIHdpZHRoIGluIG1pY3JvbnMuXG4gICAqL1xuICBwYWdlU2l6ZT86XG4gICAgfCB7IHdpZHRoOiBudW1iZXI7IGhlaWdodDogbnVtYmVyIH1cbiAgICB8ICdBMydcbiAgICB8ICdBNCdcbiAgICB8ICdBNSdcbiAgICB8ICdMZWdhbCdcbiAgICB8ICdMZXR0ZXInXG4gICAgfCAnVGFibG9pZCdcbiAgLyoqXG4gICAqIFdoZXRoZXIgdG8gcHJpbnQgQ1NTIGJhY2tncm91bmRzLlxuICAgKi9cbiAgcHJpbnRCYWNrZ3JvdW5kPzogYm9vbGVhblxuICAvKipcbiAgICogV2hldGhlciB0byBwcmludCBzZWxlY3Rpb24gb25seS5cbiAgICovXG4gIHByaW50U2VsZWN0aW9uT25seT86IGJvb2xlYW5cbiAgLyoqXG4gICAqIHRydWUgZm9yIGxhbmRzY2FwZSwgZmFsc2UgZm9yIHBvcnRyYWl0LlxuICAgKi9cbiAgbGFuZHNjYXBlPzogYm9vbGVhblxufVxuXG5leHBvcnQgY2xhc3MgV2Vidmlld0hhbmRsZXIge1xuICBwdWJsaWMgcmVhZG9ubHkgZW1pdHRlciA9IG5ldyBFbWl0dGVyPFxuICAgIHt9LFxuICAgIHtcbiAgICAgICdkaWQtc2Nyb2xsLXByZXZpZXcnOiB7IG1pbjogbnVtYmVyOyBtYXg6IG51bWJlciB9XG4gICAgfVxuICA+KClcbiAgcHVibGljIHJlYWRvbmx5IGltYWdlV2F0Y2hlcjogSW1hZ2VXYXRjaGVyXG4gIHByb3RlY3RlZCBkaXNwb3NhYmxlcyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgcHJpdmF0ZSByZWFkb25seSBfZWxlbWVudDogV2Vidmlld1RhZ1xuICBwcml2YXRlIGRlc3Ryb3llZCA9IGZhbHNlXG4gIHByaXZhdGUgem9vbUxldmVsID0gMFxuICBwcml2YXRlIHJlcGx5Q2FsbGJhY2tzID0gbmV3IE1hcDxudW1iZXIsIFJlcGx5Q2FsbGJhY2tTdHJ1Y3Q+KClcbiAgcHJpdmF0ZSByZXBseUNhbGxiYWNrSWQgPSAwXG4gIHByaXZhdGUgcmVhZG9ubHkgaW5pdFByb21pc2U6IFByb21pc2U8dm9pZD5cblxuICBjb25zdHJ1Y3Rvcihpbml0OiAoKSA9PiB2b2lkIHwgUHJvbWlzZTx2b2lkPikge1xuICAgIHRoaXMuX2VsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd3ZWJ2aWV3JylcbiAgICB0aGlzLl9lbGVtZW50LmNsYXNzTGlzdC5hZGQoJ21hcmtkb3duLXByZXZpZXctcGx1cycsICduYXRpdmUta2V5LWJpbmRpbmdzJylcbiAgICB0aGlzLl9lbGVtZW50LmRpc2FibGV3ZWJzZWN1cml0eSA9ICd0cnVlJ1xuICAgIHRoaXMuX2VsZW1lbnQubm9kZWludGVncmF0aW9uID0gJ3RydWUnXG4gICAgdGhpcy5fZWxlbWVudC5zcmMgPSBgZmlsZTovLy8ke19fZGlybmFtZX0vLi4vLi4vY2xpZW50L3RlbXBsYXRlLmh0bWxgXG4gICAgdGhpcy5fZWxlbWVudC5zdHlsZS53aWR0aCA9ICcxMDAlJ1xuICAgIHRoaXMuX2VsZW1lbnQuc3R5bGUuaGVpZ2h0ID0gJzEwMCUnXG4gICAgdGhpcy5fZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKFxuICAgICAgJ2lwYy1tZXNzYWdlJyxcbiAgICAgIChlOiBFbGVjdHJvbi5JcGNNZXNzYWdlRXZlbnRDdXN0b20pID0+IHtcbiAgICAgICAgc3dpdGNoIChlLmNoYW5uZWwpIHtcbiAgICAgICAgICBjYXNlICd6b29tLWluJzpcbiAgICAgICAgICAgIHRoaXMuem9vbUluKClcbiAgICAgICAgICAgIGJyZWFrXG4gICAgICAgICAgY2FzZSAnem9vbS1vdXQnOlxuICAgICAgICAgICAgdGhpcy56b29tT3V0KClcbiAgICAgICAgICAgIGJyZWFrXG4gICAgICAgICAgY2FzZSAnZGlkLXNjcm9sbC1wcmV2aWV3JzpcbiAgICAgICAgICAgIHRoaXMuZW1pdHRlci5lbWl0KCdkaWQtc2Nyb2xsLXByZXZpZXcnLCBlLmFyZ3NbMF0pXG4gICAgICAgICAgICBicmVha1xuICAgICAgICAgIGNhc2UgJ3VuY2F1Z2h0LWVycm9yJzoge1xuICAgICAgICAgICAgY29uc3QgZXJyID0gZS5hcmdzWzBdXG4gICAgICAgICAgICBjb25zdCBuZXdFcnIgPSBuZXcgRXJyb3IoKVxuICAgICAgICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEZhdGFsRXJyb3IoXG4gICAgICAgICAgICAgIGBVbmNhdWdodCBlcnJvciAke2Vyci5uYW1lfSBpbiBtYXJrZG93bi1wcmV2aWV3LXBsdXMgd2VidmlldyBjbGllbnRgLFxuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgZGlzbWlzc2FibGU6IHRydWUsXG4gICAgICAgICAgICAgICAgc3RhY2s6IG5ld0Vyci5zdGFjayxcbiAgICAgICAgICAgICAgICBkZXRhaWw6IGAke2Vyci5tZXNzYWdlfVxcblxcbnN0YWNrOlxcbiR7ZXJyLnN0YWNrfWAsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICApXG4gICAgICAgICAgICBicmVha1xuICAgICAgICAgIH1cbiAgICAgICAgICBjYXNlICdzaG93LWNvbnRleHQtbWVudSc6IHtcbiAgICAgICAgICAgIGF0b20uY29udGV4dE1lbnUuc2hvd0ZvckV2ZW50KHsgdGFyZ2V0OiB0aGlzLl9lbGVtZW50IH0pXG4gICAgICAgICAgICBicmVha1xuICAgICAgICAgIH1cbiAgICAgICAgICAvLyByZXBsaWVzXG4gICAgICAgICAgY2FzZSAncmVxdWVzdC1yZXBseSc6IHtcbiAgICAgICAgICAgIGNvbnN0IHsgaWQsIHJlcXVlc3QsIHJlc3VsdCB9ID0gZS5hcmdzWzBdXG4gICAgICAgICAgICBjb25zdCBjYiA9IHRoaXMucmVwbHlDYWxsYmFja3MuZ2V0KGlkKVxuICAgICAgICAgICAgaWYgKGNiICYmIHJlcXVlc3QgPT09IGNiLnJlcXVlc3QpIHtcbiAgICAgICAgICAgICAgY29uc3QgY2FsbGJhY2s6IChyOiBhbnkpID0+IHZvaWQgPSBjYi5jYWxsYmFja1xuICAgICAgICAgICAgICBjYWxsYmFjayhyZXN1bHQpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBicmVha1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSxcbiAgICApXG4gICAgdGhpcy5fZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCd3aWxsLW5hdmlnYXRlJywgYXN5bmMgKGUpID0+IHtcbiAgICAgIGNvbnN0IGV4dHMgPSBhdG9tQ29uZmlnKCkucHJldmlld0NvbmZpZy5zaGVsbE9wZW5GaWxlRXh0ZW5zaW9uc1xuICAgICAgY29uc3QgZm9yY2VPcGVuRXh0ZXJuYWwgPSBleHRzLnNvbWUoKGV4dCkgPT5cbiAgICAgICAgZS51cmwudG9Mb3dlckNhc2UoKS5lbmRzV2l0aChgLiR7ZXh0LnRvTG93ZXJDYXNlKCl9YCksXG4gICAgICApXG4gICAgICBpZiAoZS51cmwuc3RhcnRzV2l0aCgnZmlsZTovLycpICYmICFmb3JjZU9wZW5FeHRlcm5hbCkge1xuICAgICAgICBoYW5kbGVQcm9taXNlKGF0b20ud29ya3NwYWNlLm9wZW4oZmlsZVVyaVRvUGF0aChlLnVybCkpKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgc2hlbGwub3BlbkV4dGVybmFsKGUudXJsKVxuICAgICAgfVxuICAgIH0pXG5cbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChcbiAgICAgIGF0b20uc3R5bGVzLm9uRGlkQWRkU3R5bGVFbGVtZW50KCgpID0+IHtcbiAgICAgICAgaGFuZGxlUHJvbWlzZSh0aGlzLnVwZGF0ZVN0eWxlcygpKVxuICAgICAgfSksXG4gICAgICBhdG9tLnN0eWxlcy5vbkRpZFJlbW92ZVN0eWxlRWxlbWVudCgoKSA9PiB7XG4gICAgICAgIGhhbmRsZVByb21pc2UodGhpcy51cGRhdGVTdHlsZXMoKSlcbiAgICAgIH0pLFxuICAgICAgYXRvbS5zdHlsZXMub25EaWRVcGRhdGVTdHlsZUVsZW1lbnQoKCkgPT4ge1xuICAgICAgICBoYW5kbGVQcm9taXNlKHRoaXMudXBkYXRlU3R5bGVzKCkpXG4gICAgICB9KSxcbiAgICApXG5cbiAgICB0aGlzLmluaXRQcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgIHRoaXMuX2VsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignZG9tLXJlYWR5JywgKCkgPT4ge1xuICAgICAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHJldHVyblxuICAgICAgICB0aGlzLl9lbGVtZW50LnNldFpvb21MZXZlbCh0aGlzLnpvb21MZXZlbClcbiAgICAgICAgcmVzb2x2ZSgpXG4gICAgICAgIGhhbmRsZVByb21pc2UodGhpcy51cGRhdGVTdHlsZXMoKS50aGVuKGluaXQpKVxuICAgICAgfSlcbiAgICB9KVxuXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoXG4gICAgICAodGhpcy5pbWFnZVdhdGNoZXIgPSBuZXcgSW1hZ2VXYXRjaGVyKHRoaXMudXBkYXRlSW1hZ2VzLmJpbmQodGhpcykpKSxcbiAgICApXG4gIH1cblxuICBwdWJsaWMgZ2V0IGVsZW1lbnQoKTogSFRNTEVsZW1lbnQge1xuICAgIHJldHVybiB0aGlzLl9lbGVtZW50XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgcnVuSlM8VD4oanM6IHN0cmluZykge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTxUPigocmVzb2x2ZSkgPT5cbiAgICAgIHRoaXMuX2VsZW1lbnQuZXhlY3V0ZUphdmFTY3JpcHQoanMsIGZhbHNlLCByZXNvbHZlKSxcbiAgICApXG4gIH1cblxuICBwdWJsaWMgZGVzdHJveSgpIHtcbiAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHJldHVyblxuICAgIHRoaXMuZGVzdHJveWVkID0gdHJ1ZVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuZGlzcG9zZSgpXG4gICAgdGhpcy5fZWxlbWVudC5yZW1vdmUoKVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHVwZGF0ZShodG1sOiBzdHJpbmcsIHJlbmRlckxhVGVYOiBib29sZWFuKSB7XG4gICAgaWYgKHRoaXMuZGVzdHJveWVkKSByZXR1cm4gdW5kZWZpbmVkXG4gICAgcmV0dXJuIHRoaXMucnVuUmVxdWVzdCgndXBkYXRlLXByZXZpZXcnLCB7XG4gICAgICBodG1sLFxuICAgICAgcmVuZGVyTGFUZVgsXG4gICAgfSlcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBmdWxseVJlYWR5KCkge1xuICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgcmV0dXJuXG4gICAgcmV0dXJuIHRoaXMucnVuUmVxdWVzdCgnYXdhaXQtZnVsbHktcmVhZHknLCB7fSlcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBzZXRTb3VyY2VNYXAobWFwOiB7XG4gICAgW2xpbmU6IG51bWJlcl06IHsgdGFnOiBzdHJpbmc7IGluZGV4OiBudW1iZXIgfVtdXG4gIH0pIHtcbiAgICByZXR1cm4gdGhpcy5zZW5kPCdzZXQtc291cmNlLW1hcCc+KCdzZXQtc291cmNlLW1hcCcsIHsgbWFwIH0pXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc2V0QmFzZVBhdGgocGF0aD86IHN0cmluZykge1xuICAgIHJldHVybiB0aGlzLnNlbmQ8J3NldC1iYXNlLXBhdGgnPignc2V0LWJhc2UtcGF0aCcsIHsgcGF0aCB9KVxuICB9XG5cbiAgcHVibGljIGFzeW5jIGluaXQocGFyYW1zOiBDaGFubmVsTWFwWydpbml0J10pIHtcbiAgICByZXR1cm4gdGhpcy5zZW5kPCdpbml0Jz4oJ2luaXQnLCBwYXJhbXMpXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgdXBkYXRlSW1hZ2VzKG9sZFNvdXJjZTogc3RyaW5nLCB2ZXJzaW9uOiBudW1iZXIgfCB1bmRlZmluZWQpIHtcbiAgICByZXR1cm4gdGhpcy5zZW5kPCd1cGRhdGUtaW1hZ2VzJz4oJ3VwZGF0ZS1pbWFnZXMnLCB7XG4gICAgICBvbGRzcmM6IG9sZFNvdXJjZSxcbiAgICAgIHY6IHZlcnNpb24sXG4gICAgfSlcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBwcmludFRvUERGKG9wdHM6IFByaW50VG9QREZPcHRpb25zUmVhbCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTxCdWZmZXI+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIC8vIFRPRE86IENvbXBsYWluIG9uIEVsZWN0cm9uXG4gICAgICB0aGlzLl9lbGVtZW50LmdldFdlYkNvbnRlbnRzKCkucHJpbnRUb1BERihvcHRzIGFzIGFueSwgKGVycm9yLCBkYXRhKSA9PiB7XG4gICAgICAgIGlmIChlcnJvcikge1xuICAgICAgICAgIHJlamVjdChlcnJvcilcbiAgICAgICAgICByZXR1cm5cbiAgICAgICAgfVxuICAgICAgICByZXNvbHZlKGRhdGEpXG4gICAgICB9KVxuICAgIH0pXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc3luYyhsaW5lOiBudW1iZXIsIGZsYXNoOiBib29sZWFuKSB7XG4gICAgcmV0dXJuIHRoaXMuc2VuZDwnc3luYyc+KCdzeW5jJywgeyBsaW5lLCBmbGFzaCB9KVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHN5bmNTb3VyY2UoKSB7XG4gICAgcmV0dXJuIHRoaXMucnVuUmVxdWVzdCgnc3luYy1zb3VyY2UnLCB7fSlcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBzY3JvbGxTeW5jKGZpcnN0TGluZTogbnVtYmVyLCBsYXN0TGluZTogbnVtYmVyKSB7XG4gICAgcmV0dXJuIHRoaXMuc2VuZDwnc2Nyb2xsLXN5bmMnPignc2Nyb2xsLXN5bmMnLCB7IGZpcnN0TGluZSwgbGFzdExpbmUgfSlcbiAgfVxuXG4gIHB1YmxpYyB6b29tSW4oKSB7XG4gICAgdGhpcy56b29tTGV2ZWwgKz0gMC4xXG4gICAgdGhpcy5fZWxlbWVudC5zZXRab29tTGV2ZWwodGhpcy56b29tTGV2ZWwpXG4gIH1cblxuICBwdWJsaWMgem9vbU91dCgpIHtcbiAgICB0aGlzLnpvb21MZXZlbCAtPSAwLjFcbiAgICB0aGlzLl9lbGVtZW50LnNldFpvb21MZXZlbCh0aGlzLnpvb21MZXZlbClcbiAgfVxuXG4gIHB1YmxpYyByZXNldFpvb20oKSB7XG4gICAgdGhpcy56b29tTGV2ZWwgPSAwXG4gICAgdGhpcy5fZWxlbWVudC5zZXRab29tTGV2ZWwodGhpcy56b29tTGV2ZWwpXG4gIH1cblxuICBwdWJsaWMgcHJpbnQoKSB7XG4gICAgdGhpcy5fZWxlbWVudC5wcmludCgpXG4gIH1cblxuICBwdWJsaWMgb3BlbkRldlRvb2xzKCkge1xuICAgIHRoaXMuX2VsZW1lbnQub3BlbkRldlRvb2xzKClcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyByZWxvYWQoKSB7XG4gICAgYXdhaXQgdGhpcy5ydW5SZXF1ZXN0KCdyZWxvYWQnLCB7fSlcbiAgICB0aGlzLl9lbGVtZW50LnJlbG9hZCgpXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZXJyb3IobXNnOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdGhpcy5zZW5kPCdlcnJvcic+KCdlcnJvcicsIHsgbXNnIH0pXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZ2V0VGVYQ29uZmlnKCkge1xuICAgIHJldHVybiB0aGlzLnJ1blJlcXVlc3QoJ2dldC10ZXgtY29uZmlnJywge30pXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZ2V0U2VsZWN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLnJ1blJlcXVlc3QoJ2dldC1zZWxlY3Rpb24nLCB7fSlcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyB1cGRhdGVTdHlsZXMoKSB7XG4gICAgcmV0dXJuIHRoaXMuc2VuZDwnc3R5bGUnPignc3R5bGUnLCB7IHN0eWxlczogZ2V0UHJldmlld1N0eWxlcyh0cnVlKSB9KVxuICB9XG5cbiAgcHJvdGVjdGVkIGFzeW5jIHJ1blJlcXVlc3Q8VCBleHRlbmRzIGtleW9mIFJlcXVlc3RSZXBseU1hcD4oXG4gICAgcmVxdWVzdDogVCxcbiAgICBhcmdzOiB7IFtLIGluIEV4Y2x1ZGU8a2V5b2YgQ2hhbm5lbE1hcFtUXSwgJ2lkJz5dOiBDaGFubmVsTWFwW1RdW0tdIH0sXG4gICkge1xuICAgIGNvbnN0IGlkID0gdGhpcy5yZXBseUNhbGxiYWNrSWQrK1xuICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBQcm9taXNlPFJlcXVlc3RSZXBseU1hcFtUXT4oKHJlc29sdmUpID0+IHtcbiAgICAgIHRoaXMucmVwbHlDYWxsYmFja3Muc2V0KGlkLCAoe1xuICAgICAgICByZXF1ZXN0OiByZXF1ZXN0LFxuICAgICAgICBjYWxsYmFjazogKHJlc3VsdDogUmVxdWVzdFJlcGx5TWFwW1RdKSA9PiB7XG4gICAgICAgICAgdGhpcy5yZXBseUNhbGxiYWNrcy5kZWxldGUoaWQpXG4gICAgICAgICAgcmVzb2x2ZShyZXN1bHQpXG4gICAgICAgIH0sXG4gICAgICB9IGFzIHVua25vd24pIGFzIFJlcGx5Q2FsbGJhY2tTdHJ1Y3Q8VD4pXG4gICAgfSlcbiAgICBjb25zdCBuZXdhcmdzID0gT2JqZWN0LmFzc2lnbih7IGlkIH0sIGFyZ3MpXG4gICAgYXdhaXQgdGhpcy5zZW5kPFQ+KHJlcXVlc3QsIG5ld2FyZ3MgYXMgQ2hhbm5lbE1hcFtUXSlcbiAgICByZXR1cm4gcmVzdWx0XG4gIH1cblxuICBwcm90ZWN0ZWQgYXN5bmMgc2VuZDxUIGV4dGVuZHMga2V5b2YgQ2hhbm5lbE1hcD4oXG4gICAgY2hhbm5lbDogVCxcbiAgICB2YWx1ZTogQ2hhbm5lbE1hcFtUXSxcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgdGhpcy5pbml0UHJvbWlzZVxuICAgIHRoaXMuX2VsZW1lbnQuc2VuZDxUPihjaGFubmVsLCB2YWx1ZSlcbiAgfVxufVxuIl19