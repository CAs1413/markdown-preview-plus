"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const fs = require("fs");
const atom_1 = require("atom");
const electron_1 = require("electron");
const fileUriToPath = require("file-uri-to-path");
const util_1 = require("../util");
const util_2 = require("./util");
class WebviewHandler {
    constructor(init) {
        this.emitter = new atom_1.Emitter();
        this.disposables = new atom_1.CompositeDisposable();
        this.destroyed = false;
        this.zoomLevel = 0;
        this.replyCallbacks = new Map();
        this.replyCallbackId = 0;
        this._element = document.createElement('webview');
        this._element.classList.add('markdown-preview-plus', 'native-key-bindings');
        this._element.disablewebsecurity = 'true';
        this._element.nodeintegration = 'true';
        this._element.src = `file:///${__dirname}/../../client/template.html`;
        this._element.style.width = '100%';
        this._element.style.height = '100%';
        this._element.addEventListener('ipc-message', (e) => {
            switch (e.channel) {
                case 'zoom-in':
                    this.zoomIn();
                    break;
                case 'zoom-out':
                    this.zoomOut();
                    break;
                case 'did-scroll-preview':
                    this.emitter.emit('did-scroll-preview', e.args[0]);
                    break;
                case 'uncaught-error': {
                    const err = e.args[0];
                    const newErr = new Error();
                    atom.notifications.addFatalError(`Uncaught error ${err.name} in markdown-preview-plus webview client`, {
                        dismissable: true,
                        stack: newErr.stack,
                        detail: `${err.message}\n\nstack:\n${err.stack}`,
                    });
                    break;
                }
                case 'request-reply': {
                    const { id, request, result } = e.args[0];
                    const cb = this.replyCallbacks.get(id);
                    if (cb && request === cb.request) {
                        const callback = cb.callback;
                        callback(result);
                    }
                    break;
                }
            }
        });
        this._element.addEventListener('will-navigate', async (e) => {
            const exts = util_1.atomConfig().previewConfig.shellOpenFileExtensions;
            const forceOpenExternal = exts.some((ext) => e.url.toLowerCase().endsWith(`.${ext.toLowerCase()}`));
            if (e.url.startsWith('file://') && !forceOpenExternal) {
                util_1.handlePromise(atom.workspace.open(fileUriToPath(e.url)));
            }
            else {
                electron_1.shell.openExternal(e.url);
            }
        });
        this.disposables.add(atom.styles.onDidAddStyleElement(() => {
            this.updateStyles();
        }), atom.styles.onDidRemoveStyleElement(() => {
            this.updateStyles();
        }), atom.styles.onDidUpdateStyleElement(() => {
            this.updateStyles();
        }));
        const onload = () => {
            if (this.destroyed)
                return;
            this._element.setZoomLevel(this.zoomLevel);
            this.updateStyles();
            init();
        };
        this._element.addEventListener('dom-ready', onload);
    }
    get element() {
        return this._element;
    }
    async runJS(js) {
        return new Promise((resolve) => this._element.executeJavaScript(js, false, resolve));
    }
    destroy() {
        if (this.destroyed)
            return;
        this.destroyed = true;
        this.disposables.dispose();
        this._element.remove();
    }
    async update(html, renderLaTeX) {
        if (this.destroyed)
            return undefined;
        return this.runRequest('update-preview', {
            html,
            renderLaTeX,
        });
    }
    setSourceMap(map) {
        this._element.send('set-source-map', { map });
    }
    setBasePath(path) {
        this._element.send('set-base-path', { path });
    }
    init(atomHome, mathJaxConfig, context) {
        this._element.send('init', {
            atomHome,
            mathJaxConfig,
            context,
        });
    }
    updateImages(oldSource, version) {
        this._element.send('update-images', {
            oldsrc: oldSource,
            v: version,
        });
    }
    async saveToPDF(filePath) {
        const opts = util_1.atomConfig().saveConfig.saveToPDFOptions;
        const customPageSize = parsePageSize(opts.customPageSize);
        const pageSize = opts.pageSize === 'Custom' ? customPageSize : opts.pageSize;
        if (pageSize === undefined) {
            throw new Error(`Failed to parse custom page size: ${opts.customPageSize}`);
        }
        const selection = await this.getSelection();
        const printSelectionOnly = selection ? opts.printSelectionOnly : false;
        const newOpts = Object.assign({}, opts, { pageSize,
            printSelectionOnly });
        await this.prepareSaveToPDF(newOpts);
        try {
            const data = await new Promise((resolve, reject) => {
                this._element.printToPDF(newOpts, (error, data) => {
                    if (error) {
                        reject(error);
                        return;
                    }
                    resolve(data);
                });
            });
            await new Promise((resolve, reject) => {
                fs.writeFile(filePath, data, (error) => {
                    if (error) {
                        reject(error);
                        return;
                    }
                    resolve();
                });
            });
        }
        finally {
            util_1.handlePromise(this.finishSaveToPDF());
        }
    }
    sync(line, flash) {
        this._element.send('sync', { line, flash });
    }
    async syncSource() {
        return this.runRequest('sync-source', {});
    }
    scrollSync(firstLine, lastLine) {
        this._element.send('scroll-sync', { firstLine, lastLine });
    }
    zoomIn() {
        this.zoomLevel += 0.1;
        this._element.setZoomLevel(this.zoomLevel);
    }
    zoomOut() {
        this.zoomLevel -= 0.1;
        this._element.setZoomLevel(this.zoomLevel);
    }
    resetZoom() {
        this.zoomLevel = 0;
        this._element.setZoomLevel(this.zoomLevel);
    }
    print() {
        this._element.print();
    }
    openDevTools() {
        this._element.openDevTools();
    }
    async reload() {
        await this.runRequest('reload', {});
        this._element.reload();
    }
    error(msg) {
        this._element.send('error', { msg });
    }
    async getTeXConfig() {
        return this.runRequest('get-tex-config', {});
    }
    async getSelection() {
        return this.runRequest('get-selection', {});
    }
    updateStyles() {
        this._element.send('style', { styles: util_2.getPreviewStyles(true) });
    }
    async runRequest(request, args) {
        const id = this.replyCallbackId++;
        return new Promise((resolve) => {
            this.replyCallbacks.set(id, {
                request: request,
                callback: (result) => {
                    this.replyCallbacks.delete(id);
                    resolve(result);
                },
            });
            const newargs = Object.assign({ id }, args);
            this._element.send(request, newargs);
        });
    }
    async prepareSaveToPDF(opts) {
        const [width, height] = getPageWidth(opts.pageSize);
        await this.runRequest('prepare-pdf-export', {
            width: opts.landscape ? height : width,
        });
    }
    async finishSaveToPDF() {
        return this.runRequest('finished-pdf-export', {});
    }
}
exports.WebviewHandler = WebviewHandler;
function parsePageSize(size) {
    if (!size)
        return undefined;
    const rx = /^([\d.,]+)(cm|mm|in)?x([\d.,]+)(cm|mm|in)?$/i;
    const res = size.replace(/\s*/g, '').match(rx);
    if (res) {
        const width = parseFloat(res[1]);
        const wunit = res[2];
        const height = parseFloat(res[3]);
        const hunit = res[4];
        return {
            width: convert(width, wunit),
            height: convert(height, hunit),
        };
    }
    else {
        return undefined;
    }
}
function convert(val, unit) {
    return val * unitInMicrons(unit);
}
function unitInMicrons(unit = 'mm') {
    switch (unit) {
        case 'mm':
            return 1000;
        case 'cm':
            return 10000;
        case 'in':
            return 25400;
    }
}
function getPageWidth(pageSize) {
    switch (pageSize) {
        case 'A3':
            return [297, 420];
        case 'A4':
            return [210, 297];
        case 'A5':
            return [148, 210];
        case 'Legal':
            return [216, 356];
        case 'Letter':
            return [216, 279];
        case 'Tabloid':
            return [279, 432];
        default:
            return [pageSize.width / 1000, pageSize.height / 1000];
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2Vidmlldy1oYW5kbGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL21hcmtkb3duLXByZXZpZXctdmlldy93ZWJ2aWV3LWhhbmRsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSx5QkFBd0I7QUFDeEIsK0JBQWlFO0FBQ2pFLHVDQUE0QztBQUM1QyxrREFBa0Q7QUFFbEQsa0NBQW1EO0FBRW5ELGlDQUF5QztBQVd6QyxNQUFhLGNBQWM7SUFjekIsWUFBWSxJQUFnQjtRQWJaLFlBQU8sR0FBRyxJQUFJLGNBQU8sRUFLbEMsQ0FBQTtRQUNPLGdCQUFXLEdBQUcsSUFBSSwwQkFBbUIsRUFBRSxDQUFBO1FBRXpDLGNBQVMsR0FBRyxLQUFLLENBQUE7UUFDakIsY0FBUyxHQUFHLENBQUMsQ0FBQTtRQUNiLG1CQUFjLEdBQUcsSUFBSSxHQUFHLEVBQStCLENBQUE7UUFDdkQsb0JBQWUsR0FBRyxDQUFDLENBQUE7UUFHekIsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxDQUFBO1FBQ2pELElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyx1QkFBdUIsRUFBRSxxQkFBcUIsQ0FBQyxDQUFBO1FBQzNFLElBQUksQ0FBQyxRQUFRLENBQUMsa0JBQWtCLEdBQUcsTUFBTSxDQUFBO1FBQ3pDLElBQUksQ0FBQyxRQUFRLENBQUMsZUFBZSxHQUFHLE1BQU0sQ0FBQTtRQUN0QyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsR0FBRyxXQUFXLFNBQVMsNkJBQTZCLENBQUE7UUFDckUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsS0FBSyxHQUFHLE1BQU0sQ0FBQTtRQUNsQyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFBO1FBQ25DLElBQUksQ0FBQyxRQUFRLENBQUMsZ0JBQWdCLENBQzVCLGFBQWEsRUFDYixDQUFD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Q0gsQ0FBQztBQVNELFNBQVMsT0FBTyxDQUFDLEdBQVcsRUFBRSxJQUFXO0lBQ3ZDLE9BQU8sR0FBRyxHQUFHLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQTtBQUNsQyxDQUFDO0FBRUQsU0FBUyxhQUFhLENBQUMsT0FBYSxJQUFJO0lBQ3RDLFFBQVEsSUFBSSxFQUFFO1FBQ1osS0FBSyxJQUFJO1lBQ1AsT0FBTyxJQUFJLENBQUE7UUFDYixLQUFLLElBQUk7WUFDUCxPQUFPLEtBQUssQ0FBQTtRQUNkLEtBQUssSUFBSTtZQUNQLE9BQU8sS0FBSyxDQUFBO0tBQ2Y7QUFDSCxDQUFDO0FBRUQsU0FBUyxZQUFZLENBQUMsUUFBa0I7SUFDdEMsUUFBUSxRQUFRLEVBQUU7UUFDaEIsS0FBSyxJQUFJO1lBQ1AsT0FBTyxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQTtRQUNuQixLQUFLLElBQUk7WUFDUCxPQUFPLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFBO1FBQ25CLEtBQUssSUFBSTtZQUNQLE9BQU8sQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUE7UUFDbkIsS0FBSyxPQUFPO1lBQ1YsT0FBTyxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQTtRQUNuQixLQUFLLFFBQVE7WUFDWCxPQUFPLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFBO1FBQ25CLEtBQUssU0FBUztZQUNaLE9BQU8sQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUE7UUFDbkI7WUFDRSxPQUFPLENBQUMsUUFBUSxDQUFDLEtBQUssR0FBRyxJQUFJLEVBQUUsUUFBUSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsQ0FBQTtLQUN6RDtBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBmcyBmcm9tICdmcydcbmltcG9ydCB7IEVtaXR0ZXIsIENvbXBvc2l0ZURpc3Bvc2FibGUsIENvbmZpZ1ZhbHVlcyB9IGZyb20gJ2F0b20nXG5pbXBvcnQgeyBXZWJ2aWV3VGFnLCBzaGVsbCB9IGZyb20gJ2VsZWN0cm9uJ1xuaW1wb3J0IGZpbGVVcmlUb1BhdGggPSByZXF1aXJlKCdmaWxlLXVyaS10by1wYXRoJylcblxuaW1wb3J0IHsgaGFuZGxlUHJvbWlzZSwgYXRvbUNvbmZpZyB9IGZyb20gJy4uL3V0aWwnXG5pbXBvcnQgeyBSZXF1ZXN0UmVwbHlNYXAsIENoYW5uZWxNYXAgfSBmcm9tICcuLi8uLi9zcmMtY2xpZW50L2lwYydcbmltcG9ydCB7IGdldFByZXZpZXdTdHlsZXMgfSBmcm9tICcuL3V0aWwnXG5cbmV4cG9ydCB0eXBlIFJlcGx5Q2FsbGJhY2tTdHJ1Y3Q8XG4gIFQgZXh0ZW5kcyBrZXlvZiBSZXF1ZXN0UmVwbHlNYXAgPSBrZXlvZiBSZXF1ZXN0UmVwbHlNYXBcbj4gPSB7XG4gIFtLIGluIGtleW9mIFJlcXVlc3RSZXBseU1hcF06IHtcbiAgICByZXF1ZXN0OiBLXG4gICAgY2FsbGJhY2s6IChyZXBseTogUmVxdWVzdFJlcGx5TWFwW0tdKSA9PiB2b2lkXG4gIH1cbn1bVF1cblxuZXhwb3J0IGNsYXNzIFdlYnZpZXdIYW5kbGVyIHtcbiAgcHVibGljIHJlYWRvbmx5IGVtaXR0ZXIgPSBuZXcgRW1pdHRlcjxcbiAgICB7fSxcbiAgICB7XG4gICAgICAnZGlkLXNjcm9sbC1wcmV2aWV3JzogeyBtaW46IG51bWJlcjsgbWF4OiBudW1iZXIgfVxuICAgIH1cbiAgPigpXG4gIHByb3RlY3RlZCBkaXNwb3NhYmxlcyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgcHJpdmF0ZSByZWFkb25seSBfZWxlbWVudDogV2Vidmlld1RhZ1xuICBwcml2YXRlIGRlc3Ryb3llZCA9IGZhbHNlXG4gIHByaXZhdGUgem9vbUxldmVsID0gMFxuICBwcml2YXRlIHJlcGx5Q2FsbGJhY2tzID0gbmV3IE1hcDxudW1iZXIsIFJlcGx5Q2FsbGJhY2tTdHJ1Y3Q+KClcbiAgcHJpdmF0ZSByZXBseUNhbGxiYWNrSWQgPSAwXG5cbiAgY29uc3RydWN0b3IoaW5pdDogKCkgPT4gdm9pZCkge1xuICAgIHRoaXMuX2VsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd3ZWJ2aWV3JylcbiAgICB0aGlzLl9lbGVtZW50LmNsYXNzTGlzdC5hZGQoJ21hcmtkb3duLXByZXZpZXctcGx1cycsICduYXRpdmUta2V5LWJpbmRpbmdzJylcbiAgICB0aGlzLl9lbGVtZW50LmRpc2FibGV3ZWJzZWN1cml0eSA9ICd0cnVlJ1xuICAgIHRoaXMuX2VsZW1lbnQubm9kZWludGVncmF0aW9uID0gJ3RydWUnXG4gICAgdGhpcy5fZWxlbWVudC5zcmMgPSBgZmlsZTovLy8ke19fZGlybmFtZX0vLi4vLi4vY2xpZW50L3RlbXBsYXRlLmh0bWxgXG4gICAgdGhpcy5fZWxlbWVudC5zdHlsZS53aWR0aCA9ICcxMDAlJ1xuICAgIHRoaXMuX2VsZW1lbnQuc3R5bGUuaGVpZ2h0ID0gJzEwMCUnXG4gICAgdGhpcy5fZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKFxuICAgICAgJ2lwYy1tZXNzYWdlJyxcbiAgICAgIChlOiBFbGVjdHJvbi5JcGNNZXNzYWdlRXZlbnRDdXN0b20pID0+IHtcbiAgICAgICAgc3dpdGNoIChlLmNoYW5uZWwpIHtcbiAgICAgICAgICBjYXNlICd6b29tLWluJzpcbiAgICAgICAgICAgIHRoaXMuem9vbUluKClcbiAgICAgICAgICAgIGJyZWFrXG4gICAgICAgICAgY2FzZSAnem9vbS1vdXQnOlxuICAgICAgICAgICAgdGhpcy56b29tT3V0KClcbiAgICAgICAgICAgIGJyZWFrXG4gICAgICAgICAgY2FzZSAnZGlkLXNjcm9sbC1wcmV2aWV3JzpcbiAgICAgICAgICAgIHRoaXMuZW1pdHRlci5lbWl0KCdkaWQtc2Nyb2xsLXByZXZpZXcnLCBlLmFyZ3NbMF0pXG4gICAgICAgICAgICBicmVha1xuICAgICAgICAgIGNhc2UgJ3VuY2F1Z2h0LWVycm9yJzoge1xuICAgICAgICAgICAgY29uc3QgZXJyID0gZS5hcmdzWzBdXG4gICAgICAgICAgICBjb25zdCBuZXdFcnIgPSBuZXcgRXJyb3IoKVxuICAgICAgICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEZhdGFsRXJyb3IoXG4gICAgICAgICAgICAgIGBVbmNhdWdodCBlcnJvciAke1xuICAgICAgICAgICAgICAgIGVyci5uYW1lXG4gICAgICAgICAgICAgIH0gaW4gbWFya2Rvd24tcHJldmlldy1wbHVzIHdlYnZpZXcgY2xpZW50YCxcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGRpc21pc3NhYmxlOiB0cnVlLFxuICAgICAgICAgICAgICAgIHN0YWNrOiBuZXdFcnIuc3RhY2ssXG4gICAgICAgICAgICAgICAgZGV0YWlsOiBgJHtlcnIubWVzc2FnZX1cXG5cXG5zdGFjazpcXG4ke2Vyci5zdGFja31gLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgICB9XG4gICAgICAgICAgLy8gcmVwbGllc1xuICAgICAgICAgIGNhc2UgJ3JlcXVlc3QtcmVwbHknOiB7XG4gICAgICAgICAgICBjb25zdCB7IGlkLCByZXF1ZXN0LCByZXN1bHQgfSA9IGUuYXJnc1swXVxuICAgICAgICAgICAgY29uc3QgY2IgPSB0aGlzLnJlcGx5Q2FsbGJhY2tzLmdldChpZClcbiAgICAgICAgICAgIGlmIChjYiAmJiByZXF1ZXN0ID09PSBjYi5yZXF1ZXN0KSB7XG4gICAgICAgICAgICAgIGNvbnN0IGNhbGxiYWNrOiAocjogYW55KSA9PiB2b2lkID0gY2IuY2FsbGJhY2tcbiAgICAgICAgICAgICAgY2FsbGJhY2socmVzdWx0KVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgKVxuICAgIHRoaXMuX2VsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignd2lsbC1uYXZpZ2F0ZScsIGFzeW5jIChlKSA9PiB7XG4gICAgICBjb25zdCBleHRzID0gYXRvbUNvbmZpZygpLnByZXZpZXdDb25maWcuc2hlbGxPcGVuRmlsZUV4dGVuc2lvbnNcbiAgICAgIGNvbnN0IGZvcmNlT3BlbkV4dGVybmFsID0gZXh0cy5zb21lKChleHQpID0+XG4gICAgICAgIGUudXJsLnRvTG93ZXJDYXNlKCkuZW5kc1dpdGgoYC4ke2V4dC50b0xvd2VyQ2FzZSgpfWApLFxuICAgICAgKVxuICAgICAgaWYgKGUudXJsLnN0YXJ0c1dpdGgoJ2ZpbGU6Ly8nKSAmJiAhZm9yY2VPcGVuRXh0ZXJuYWwpIHtcbiAgICAgICAgaGFuZGxlUHJvbWlzZShhdG9tLndvcmtzcGFjZS5vcGVuKGZpbGVVcmlUb1BhdGgoZS51cmwpKSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHNoZWxsLm9wZW5FeHRlcm5hbChlLnVybClcbiAgICAgIH1cbiAgICB9KVxuXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoXG4gICAgICBhdG9tLnN0eWxlcy5vbkRpZEFkZFN0eWxlRWxlbWVudCgoKSA9PiB7XG4gICAgICAgIHRoaXMudXBkYXRlU3R5bGVzKClcbiAgICAgIH0pLFxuICAgICAgYXRvbS5zdHlsZXMub25EaWRSZW1vdmVTdHlsZUVsZW1lbnQoKCkgPT4ge1xuICAgICAgICB0aGlzLnVwZGF0ZVN0eWxlcygpXG4gICAgICB9KSxcbiAgICAgIGF0b20uc3R5bGVzLm9uRGlkVXBkYXRlU3R5bGVFbGVtZW50KCgpID0+IHtcbiAgICAgICAgdGhpcy51cGRhdGVTdHlsZXMoKVxuICAgICAgfSksXG4gICAgKVxuXG4gICAgY29uc3Qgb25sb2FkID0gKCkgPT4ge1xuICAgICAgaWYgKHRoaXMuZGVzdHJveWVkKSByZXR1cm5cbiAgICAgIHRoaXMuX2VsZW1lbnQuc2V0Wm9vbUxldmVsKHRoaXMuem9vbUxldmVsKVxuICAgICAgdGhpcy51cGRhdGVTdHlsZXMoKVxuICAgICAgaW5pdCgpXG4gICAgfVxuICAgIHRoaXMuX2VsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignZG9tLXJlYWR5Jywgb25sb2FkKVxuICB9XG5cbiAgcHVibGljIGdldCBlbGVtZW50KCk6IEhUTUxFbGVtZW50IHtcbiAgICByZXR1cm4gdGhpcy5fZWxlbWVudFxuICB9XG5cbiAgcHVibGljIGFzeW5jIHJ1bkpTPFQ+KGpzOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8VD4oKHJlc29sdmUpID0+XG4gICAgICB0aGlzLl9lbGVtZW50LmV4ZWN1dGVKYXZhU2NyaXB0KGpzLCBmYWxzZSwgcmVzb2x2ZSksXG4gICAgKVxuICB9XG5cbiAgcHVibGljIGRlc3Ryb3koKSB7XG4gICAgaWYgKHRoaXMuZGVzdHJveWVkKSByZXR1cm5cbiAgICB0aGlzLmRlc3Ryb3llZCA9IHRydWVcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmRpc3Bvc2UoKVxuICAgIHRoaXMuX2VsZW1lbnQucmVtb3ZlKClcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyB1cGRhdGUoaHRtbDogc3RyaW5nLCByZW5kZXJMYVRlWDogYm9vbGVhbikge1xuICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgcmV0dXJuIHVuZGVmaW5lZFxuICAgIHJldHVybiB0aGlzLnJ1blJlcXVlc3QoJ3VwZGF0ZS1wcmV2aWV3Jywge1xuICAgICAgaHRtbCxcbiAgICAgIHJlbmRlckxhVGVYLFxuICAgIH0pXG4gIH1cblxuICBwdWJsaWMgc2V0U291cmNlTWFwKG1hcDoge1xuICAgIFtsaW5lOiBudW1iZXJdOiB7IHRhZzogc3RyaW5nOyBpbmRleDogbnVtYmVyIH1bXVxuICB9KSB7XG4gICAgdGhpcy5fZWxlbWVudC5zZW5kPCdzZXQtc291cmNlLW1hcCc+KCdzZXQtc291cmNlLW1hcCcsIHsgbWFwIH0pXG4gIH1cblxuICBwdWJsaWMgc2V0QmFzZVBhdGgocGF0aD86IHN0cmluZykge1xuICAgIHRoaXMuX2VsZW1lbnQuc2VuZDwnc2V0LWJhc2UtcGF0aCc+KCdzZXQtYmFzZS1wYXRoJywgeyBwYXRoIH0pXG4gIH1cblxuICBwdWJsaWMgaW5pdChcbiAgICBhdG9tSG9tZTogc3RyaW5nLFxuICAgIG1hdGhKYXhDb25maWc6IE1hdGhKYXhDb25maWcsXG4gICAgY29udGV4dDogJ2xpdmUtcHJldmlldycgfCAnY29weS1odG1sJyxcbiAgKSB7XG4gICAgdGhpcy5fZWxlbWVudC5zZW5kPCdpbml0Jz4oJ2luaXQnLCB7XG4gICAgICBhdG9tSG9tZSxcbiAgICAgIG1hdGhKYXhDb25maWcsXG4gICAgICBjb250ZXh0LFxuICAgIH0pXG4gIH1cblxuICBwdWJsaWMgdXBkYXRlSW1hZ2VzKG9sZFNvdXJjZTogc3RyaW5nLCB2ZXJzaW9uOiBudW1iZXIgfCB1bmRlZmluZWQpIHtcbiAgICB0aGlzLl9lbGVtZW50LnNlbmQ8J3VwZGF0ZS1pbWFnZXMnPigndXBkYXRlLWltYWdlcycsIHtcbiAgICAgIG9sZHNyYzogb2xkU291cmNlLFxuICAgICAgdjogdmVyc2lvbixcbiAgICB9KVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHNhdmVUb1BERihmaWxlUGF0aDogc3RyaW5nKSB7XG4gICAgY29uc3Qgb3B0cyA9IGF0b21Db25maWcoKS5zYXZlQ29uZmlnLnNhdmVUb1BERk9wdGlvbnNcbiAgICBjb25zdCBjdXN0b21QYWdlU2l6ZSA9IHBhcnNlUGFnZVNpemUob3B0cy5jdXN0b21QYWdlU2l6ZSlcbiAgICBjb25zdCBwYWdlU2l6ZSA9IG9wdHMucGFnZVNpemUgPT09ICdDdXN0b20nID8gY3VzdG9tUGFnZVNpemUgOiBvcHRzLnBhZ2VTaXplXG4gICAgaWYgKHBhZ2VTaXplID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYEZhaWxlZCB0byBwYXJzZSBjdXN0b20gcGFnZSBzaXplOiAke29wdHMuY3VzdG9tUGFnZVNpemV9YCxcbiAgICAgIClcbiAgICB9XG4gICAgY29uc3Qgc2VsZWN0aW9uID0gYXdhaXQgdGhpcy5nZXRTZWxlY3Rpb24oKVxuICAgIGNvbnN0IHByaW50U2VsZWN0aW9uT25seSA9IHNlbGVjdGlvbiA/IG9wdHMucHJpbnRTZWxlY3Rpb25Pbmx5IDogZmFsc2VcbiAgICBjb25zdCBuZXdPcHRzID0ge1xuICAgICAgLi4ub3B0cyxcbiAgICAgIHBhZ2VTaXplLFxuICAgICAgcHJpbnRTZWxlY3Rpb25Pbmx5LFxuICAgIH1cbiAgICBhd2FpdCB0aGlzLnByZXBhcmVTYXZlVG9QREYobmV3T3B0cylcbiAgICB0cnkge1xuICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IG5ldyBQcm9taXNlPEJ1ZmZlcj4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAvLyBUT0RPOiBDb21wbGFpbiBvbiBFbGVjdHJvblxuICAgICAgICB0aGlzLl9lbGVtZW50LnByaW50VG9QREYobmV3T3B0cyBhcyBhbnksIChlcnJvciwgZGF0YSkgPT4ge1xuICAgICAgICAgIGlmIChlcnJvcikge1xuICAgICAgICAgICAgcmVqZWN0KGVycm9yKVxuICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgfVxuICAgICAgICAgIHJlc29sdmUoZGF0YSlcbiAgICAgICAgfSlcbiAgICAgIH0pXG4gICAgICBhd2FpdCBuZXcgUHJvbWlzZTx2b2lkPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIGZzLndyaXRlRmlsZShmaWxlUGF0aCwgZGF0YSwgKGVycm9yKSA9PiB7XG4gICAgICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgICAgICByZWplY3QoZXJyb3IpXG4gICAgICAgICAgICByZXR1cm5cbiAgICAgICAgICB9XG4gICAgICAgICAgcmVzb2x2ZSgpXG4gICAgICAgIH0pXG4gICAgICB9KVxuICAgIH0gZmluYWxseSB7XG4gICAgICBoYW5kbGVQcm9taXNlKHRoaXMuZmluaXNoU2F2ZVRvUERGKCkpXG4gICAgfVxuICB9XG5cbiAgcHVibGljIHN5bmMobGluZTogbnVtYmVyLCBmbGFzaDogYm9vbGVhbikge1xuICAgIHRoaXMuX2VsZW1lbnQuc2VuZDwnc3luYyc+KCdzeW5jJywgeyBsaW5lLCBmbGFzaCB9KVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHN5bmNTb3VyY2UoKSB7XG4gICAgcmV0dXJuIHRoaXMucnVuUmVxdWVzdCgnc3luYy1zb3VyY2UnLCB7fSlcbiAgfVxuXG4gIHB1YmxpYyBzY3JvbGxTeW5jKGZpcnN0TGluZTogbnVtYmVyLCBsYXN0TGluZTogbnVtYmVyKSB7XG4gICAgdGhpcy5fZWxlbWVudC5zZW5kPCdzY3JvbGwtc3luYyc+KCdzY3JvbGwtc3luYycsIHsgZmlyc3RMaW5lLCBsYXN0TGluZSB9KVxuICB9XG5cbiAgcHVibGljIHpvb21JbigpIHtcbiAgICB0aGlzLnpvb21MZXZlbCArPSAwLjFcbiAgICB0aGlzLl9lbGVtZW50LnNldFpvb21MZXZlbCh0aGlzLnpvb21MZXZlbClcbiAgfVxuXG4gIHB1YmxpYyB6b29tT3V0KCkge1xuICAgIHRoaXMuem9vbUxldmVsIC09IDAuMVxuICAgIHRoaXMuX2VsZW1lbnQuc2V0Wm9vbUxldmVsKHRoaXMuem9vbUxldmVsKVxuICB9XG5cbiAgcHVibGljIHJlc2V0Wm9vbSgpIHtcbiAgICB0aGlzLnpvb21MZXZlbCA9IDBcbiAgICB0aGlzLl9lbGVtZW50LnNldFpvb21MZXZlbCh0aGlzLnpvb21MZXZlbClcbiAgfVxuXG4gIHB1YmxpYyBwcmludCgpIHtcbiAgICB0aGlzLl9lbGVtZW50LnByaW50KClcbiAgfVxuXG4gIHB1YmxpYyBvcGVuRGV2VG9vbHMoKSB7XG4gICAgdGhpcy5fZWxlbWVudC5vcGVuRGV2VG9vbHMoKVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHJlbG9hZCgpIHtcbiAgICBhd2FpdCB0aGlzLnJ1blJlcXVlc3QoJ3JlbG9hZCcsIHt9KVxuICAgIHRoaXMuX2VsZW1lbnQucmVsb2FkKClcbiAgfVxuXG4gIHB1YmxpYyBlcnJvcihtc2c6IHN0cmluZykge1xuICAgIHRoaXMuX2VsZW1lbnQuc2VuZDwnZXJyb3InPignZXJyb3InLCB7IG1zZyB9KVxuICB9XG5cbiAgcHVibGljIGFzeW5jIGdldFRlWENvbmZpZygpIHtcbiAgICByZXR1cm4gdGhpcy5ydW5SZXF1ZXN0KCdnZXQtdGV4LWNvbmZpZycsIHt9KVxuICB9XG5cbiAgcHVibGljIGFzeW5jIGdldFNlbGVjdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5ydW5SZXF1ZXN0KCdnZXQtc2VsZWN0aW9uJywge30pXG4gIH1cblxuICBwdWJsaWMgdXBkYXRlU3R5bGVzKCkge1xuICAgIHRoaXMuX2VsZW1lbnQuc2VuZDwnc3R5bGUnPignc3R5bGUnLCB7IHN0eWxlczogZ2V0UHJldmlld1N0eWxlcyh0cnVlKSB9KVxuICB9XG5cbiAgcHJvdGVjdGVkIGFzeW5jIHJ1blJlcXVlc3Q8VCBleHRlbmRzIGtleW9mIFJlcXVlc3RSZXBseU1hcD4oXG4gICAgcmVxdWVzdDogVCxcbiAgICBhcmdzOiB7IFtLIGluIEV4Y2x1ZGU8a2V5b2YgQ2hhbm5lbE1hcFtUXSwgJ2lkJz5dOiBDaGFubmVsTWFwW1RdW0tdIH0sXG4gICkge1xuICAgIGNvbnN0IGlkID0gdGhpcy5yZXBseUNhbGxiYWNrSWQrK1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTxSZXF1ZXN0UmVwbHlNYXBbVF0+KChyZXNvbHZlKSA9PiB7XG4gICAgICB0aGlzLnJlcGx5Q2FsbGJhY2tzLnNldChpZCwge1xuICAgICAgICByZXF1ZXN0OiByZXF1ZXN0LFxuICAgICAgICBjYWxsYmFjazogKHJlc3VsdDogUmVxdWVzdFJlcGx5TWFwW1RdKSA9PiB7XG4gICAgICAgICAgdGhpcy5yZXBseUNhbGxiYWNrcy5kZWxldGUoaWQpXG4gICAgICAgICAgcmVzb2x2ZShyZXN1bHQpXG4gICAgICAgIH0sXG4gICAgICB9IGFzIFJlcGx5Q2FsbGJhY2tTdHJ1Y3Q8VD4pXG4gICAgICBjb25zdCBuZXdhcmdzID0gT2JqZWN0LmFzc2lnbih7IGlkIH0sIGFyZ3MpXG4gICAgICB0aGlzLl9lbGVtZW50LnNlbmQ8VD4ocmVxdWVzdCwgbmV3YXJncylcbiAgICB9KVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBwcmVwYXJlU2F2ZVRvUERGKG9wdHM6IHtcbiAgICBwYWdlU2l6ZTogUGFnZVNpemVcbiAgICBsYW5kc2NhcGU6IGJvb2xlYW5cbiAgfSk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IFt3aWR0aCwgaGVpZ2h0XSA9IGdldFBhZ2VXaWR0aChvcHRzLnBhZ2VTaXplKVxuICAgIGF3YWl0IHRoaXMucnVuUmVxdWVzdCgncHJlcGFyZS1wZGYtZXhwb3J0Jywge1xuICAgICAgd2lkdGg6IG9wdHMubGFuZHNjYXBlID8gaGVpZ2h0IDogd2lkdGgsXG4gICAgfSlcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZmluaXNoU2F2ZVRvUERGKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHJldHVybiB0aGlzLnJ1blJlcXVlc3QoJ2ZpbmlzaGVkLXBkZi1leHBvcnQnLCB7fSlcbiAgfVxufVxuXG50eXBlIFVuaXQgPSAnbW0nIHwgJ2NtJyB8ICdpbidcblxuZnVuY3Rpb24gcGFyc2VQYWdlU2l6ZShzaXplOiBzdHJpbmcpIHtcbiAgaWYgKCFzaXplKSByZXR1cm4gdW5kZWZpbmVkXG4gIGNvbnN0IHJ4ID0gL14oW1xcZC4sXSspKGNtfG1tfGluKT94KFtcXGQuLF0rKShjbXxtbXxpbik/JC9pXG4gIGNvbnN0IHJlcyA9IHNpemUucmVwbGFjZSgvXFxzKi9nLCAnJykubWF0Y2gocngpXG4gIGlmIChyZXMpIHtcbiAgICBjb25zdCB3aWR0aCA9IHBhcnNlRmxvYXQocmVzWzFdKVxuICAgIGNvbnN0IHd1bml0ID0gcmVzWzJdIGFzIFVuaXQgfCB1bmRlZmluZWRcbiAgICBjb25zdCBoZWlnaHQgPSBwYXJzZUZsb2F0KHJlc1szXSlcbiAgICBjb25zdCBodW5pdCA9IHJlc1s0XSBhcyBVbml0IHwgdW5kZWZpbmVkXG4gICAgcmV0dXJuIHtcbiAgICAgIHdpZHRoOiBjb252ZXJ0KHdpZHRoLCB3dW5pdCksXG4gICAgICBoZWlnaHQ6IGNvbnZlcnQoaGVpZ2h0LCBodW5pdCksXG4gICAgfVxuICB9IGVsc2Uge1xuICAgIHJldHVybiB1bmRlZmluZWRcbiAgfVxufVxuXG50eXBlIFBhZ2VTaXplID1cbiAgfCBFeGNsdWRlPFxuICAgICAgQ29uZmlnVmFsdWVzWydtYXJrZG93bi1wcmV2aWV3LXBsdXMuc2F2ZUNvbmZpZy5zYXZlVG9QREZPcHRpb25zLnBhZ2VTaXplJ10sXG4gICAgICAnQ3VzdG9tJ1xuICAgID5cbiAgfCB7IHdpZHRoOiBudW1iZXI7IGhlaWdodDogbnVtYmVyIH1cblxuZnVuY3Rpb24gY29udmVydCh2YWw6IG51bWJlciwgdW5pdD86IFVuaXQpIHtcbiAgcmV0dXJuIHZhbCAqIHVuaXRJbk1pY3JvbnModW5pdClcbn1cblxuZnVuY3Rpb24gdW5pdEluTWljcm9ucyh1bml0OiBVbml0ID0gJ21tJykge1xuICBzd2l0Y2ggKHVuaXQpIHtcbiAgICBjYXNlICdtbSc6XG4gICAgICByZXR1cm4gMTAwMFxuICAgIGNhc2UgJ2NtJzpcbiAgICAgIHJldHVybiAxMDAwMFxuICAgIGNhc2UgJ2luJzpcbiAgICAgIHJldHVybiAyNTQwMFxuICB9XG59XG5cbmZ1bmN0aW9uIGdldFBhZ2VXaWR0aChwYWdlU2l6ZTogUGFnZVNpemUpIHtcbiAgc3dpdGNoIChwYWdlU2l6ZSkge1xuICAgIGNhc2UgJ0EzJzpcbiAgICAgIHJldHVybiBbMjk3LCA0MjBdXG4gICAgY2FzZSAnQTQnOlxuICAgICAgcmV0dXJuIFsyMTAsIDI5N11cbiAgICBjYXNlICdBNSc6XG4gICAgICByZXR1cm4gWzE0OCwgMjEwXVxuICAgIGNhc2UgJ0xlZ2FsJzpcbiAgICAgIHJldHVybiBbMjE2LCAzNTZdXG4gICAgY2FzZSAnTGV0dGVyJzpcbiAgICAgIHJldHVybiBbMjE2LCAyNzldXG4gICAgY2FzZSAnVGFibG9pZCc6XG4gICAgICByZXR1cm4gWzI3OSwgNDMyXVxuICAgIGRlZmF1bHQ6XG4gICAgICByZXR1cm4gW3BhZ2VTaXplLndpZHRoIC8gMTAwMCwgcGFnZVNpemUuaGVpZ2h0IC8gMTAwMF1cbiAgfVxufVxuIl19