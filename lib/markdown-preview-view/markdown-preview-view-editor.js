"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const util = require("./util");
const markdown_preview_view_1 = require("./markdown-preview-view");
const util_1 = require("../util");
const electron_1 = require("electron");
const markdown_preview_view_editor_remote_1 = require("./markdown-preview-view-editor-remote");
class MarkdownPreviewViewEditor extends markdown_preview_view_1.MarkdownPreviewView {
    constructor(editor) {
        super();
        this.editor = editor;
        this.syncPreviewHelper = async () => {
            const pos = this.editor.getCursorBufferPosition().row;
            this.syncPreview(pos);
        };
        this.handleEditorEvents();
    }
    static create(editor) {
        let mppv = MarkdownPreviewViewEditor.editorMap.get(editor);
        if (!mppv) {
            mppv = new MarkdownPreviewViewEditor(editor);
            MarkdownPreviewViewEditor.editorMap.set(editor, mppv);
        }
        return mppv;
    }
    static viewForEditor(editor) {
        return MarkdownPreviewViewEditor.editorMap.get(editor);
    }
    destroy() {
        super.destroy();
        MarkdownPreviewViewEditor.editorMap.delete(this.editor);
    }
    serialize() {
        return {
            deserializer: 'markdown-preview-plus/MarkdownPreviewView',
            editorId: this.editor && this.editor.id,
        };
    }
    getTitle() {
        return `${this.editor.getTitle()} Preview`;
    }
    getURI() {
        return `markdown-preview-plus://editor/${this.editor.id}`;
    }
    getPath() {
        return this.editor.getPath();
    }
    async getMarkdownSource() {
        return this.editor.getText();
    }
    getGrammar() {
        return this.editor.getGrammar();
    }
    didScrollPreview(min, max) {
        if (!this.shouldScrollSync('preview'))
            return;
        if (min === 0) {
            this.editor.scrollToBufferPosition([min, 0]);
        }
        else if (max >= this.editor.getLastBufferRow() - 1) {
            this.editor.scrollToBufferPosition([max, 0]);
        }
        else {
            const range = atom_1.Range.fromObject([[min, 0], [max, 0]]);
            this.editor.scrollToScreenRange(this.editor.screenRangeForBufferRange(range), { center: false });
        }
    }
    openNewWindow() {
        const windowId = electron_1.remote.getCurrentWindow().id;
        const editorId = this.editor.id;
        atom.open({
            pathsToOpen: [
                `markdown-preview-plus://remote-editor/${windowId}/${editorId}`,
            ],
        });
        markdown_preview_view_editor_remote_1.MarkdownPreviewViewEditorRemote.setupEditor(this.editor);
        util.destroy(this);
    }
    openSource(initialLine) {
        if (initialLine !== undefined) {
            this.editor.setCursorBufferPosition([initialLine, 0]);
        }
        const pane = atom.workspace.paneForItem(this.editor);
        if (!pane)
            return;
        pane.activateItem(this.editor);
        pane.activate();
    }
    handleEditorEvents() {
        this.disposables.add(atom.workspace.onDidChangeActiveTextEditor((ed) => {
            if (util_1.atomConfig().previewConfig.activatePreviewWithEditor) {
                if (ed === this.editor) {
                    const pane = atom.workspace.paneForItem(this);
                    if (!pane)
                        return;
                    const edPane = atom.workspace.paneForItem(ed);
                    if (pane === edPane)
                        return;
                    pane.activateItem(this);
                }
            }
        }), this.editor.getBuffer().onDidStopChanging(() => {
            if (util_1.atomConfig().previewConfig.liveUpdate) {
                this.changeHandler();
            }
            if (util_1.atomConfig().syncConfig.syncPreviewOnChange) {
                util_1.handlePromise(this.syncPreviewHelper());
            }
        }), this.editor.onDidChangePath(() => {
            this.emitter.emit('did-change-title');
        }), this.editor.onDidDestroy(() => {
            if (util_1.atomConfig().previewConfig.closePreviewWithEditor) {
                util.destroy(this);
            }
        }), this.editor.getBuffer().onDidSave(() => {
            if (!util_1.atomConfig().previewConfig.liveUpdate) {
                this.changeHandler();
            }
        }), this.editor.getBuffer().onDidReload(() => {
            if (!util_1.atomConfig().previewConfig.liveUpdate) {
                this.changeHandler();
            }
        }), atom.views.getView(this.editor).onDidChangeScrollTop(() => {
            if (!this.shouldScrollSync('editor'))
                return;
            const [first, last] = this.editor.getVisibleRowRange();
            this.element.send('scroll-sync', {
                firstLine: this.editor.bufferRowForScreenRow(first),
                lastLine: this.editor.bufferRowForScreenRow(last),
            });
        }), atom.commands.add(atom.views.getView(this.editor), {
            'markdown-preview-plus:sync-preview': this.syncPreviewHelper,
        }));
    }
    shouldScrollSync(whatScrolled) {
        const config = util_1.atomConfig().syncConfig;
        if (config.syncEditorOnPreviewScroll && config.syncPreviewOnEditorScroll) {
            const item = whatScrolled === 'editor' ? this.editor : this;
            const pane = atom.workspace.paneForItem(item);
            return pane && pane.isActive();
        }
        else {
            return ((config.syncEditorOnPreviewScroll && whatScrolled === 'preview') ||
                (config.syncPreviewOnEditorScroll && whatScrolled === 'editor'));
        }
    }
}
MarkdownPreviewViewEditor.editorMap = new WeakMap();
exports.MarkdownPreviewViewEditor = MarkdownPreviewViewEditor;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFya2Rvd24tcHJldmlldy12aWV3LWVkaXRvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tYXJrZG93bi1wcmV2aWV3LXZpZXcvbWFya2Rvd24tcHJldmlldy12aWV3LWVkaXRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtCQUFpRDtBQUNqRCwrQkFBOEI7QUFDOUIsbUVBQTRFO0FBQzVFLGtDQUFtRDtBQUNuRCx1Q0FBaUM7QUFDakMsK0ZBQXVGO0FBRXZGLCtCQUF1QyxTQUFRLDJDQUFtQjtJQU1oRSxZQUE0QixNQUFrQjtRQUM1QyxLQUFLLEVBQUUsQ0FBQTtRQURtQixXQUFNLEdBQU4sTUFBTSxDQUFZO1FBOEl0QyxzQkFBaUIsR0FBRyxLQUFLLElBQUksRUFBRTtZQUNyQyxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLHVCQUF1QixFQUFFLENBQUMsR0FBRyxDQUFBO1lBQ3JELElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUE7UUFDdkIsQ0FBQyxDQUFBO1FBL0lDLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFBO0lBQzNCLENBQUM7SUFFTSxNQUFNLENBQUMsTUFBTSxDQUFDLE1BQWtCO1FBQ3JDLElBQUksSUFBSSxHQUFHLHlCQUF5QixDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUE7UUFDMUQsSUFBSSxDQUFDLElBQUksRUFBRTtZQUNULElBQUksR0FBRyxJQUFJLHlCQUF5QixDQUFDLE1BQU0sQ0FBQyxDQUFBO1lBQzVDLHlCQUF5QixDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFBO1NBQ3REO1FBQ0QsT0FBTyxJQUFJLENBQUE7SUFDYixDQUFDO0lBRU0sTUFBTSxDQUFDLGFBQWEsQ0FBQyxNQUFrQjtRQUM1QyxPQUFPLHlCQUF5QixDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENB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SixDQUFDLENBQUMsRUFDRixJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUU7WUFDakQsb0NBQW9DLEVBQUUsSUFBSSxDQUFDLGlCQUFpQjtTQUM3RCxDQUFDLENBQ0gsQ0FBQTtJQUNILENBQUM7SUFPTyxnQkFBZ0IsQ0FBQyxZQUFrQztRQUN6RCxNQUFNLE1BQU0sR0FBRyxpQkFBVSxFQUFFLENBQUMsVUFBVSxDQUFBO1FBQ3RDLElBQUksTUFBTSxDQUFDLHlCQUF5QixJQUFJLE1BQU0sQ0FBQyx5QkFBeUIsRUFBRTtZQUN4RSxNQUFNLElBQUksR0FBRyxZQUFZLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUE7WUFDM0QsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUE7WUFDN0MsT0FBTyxJQUFJLElBQUksSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFBO1NBQy9CO2FBQU07WUFDTCxPQUFPLENBQ0wsQ0FBQyxNQUFNLENBQUMseUJBQXlCLElBQUksWUFBWSxLQUFLLFNBQVMsQ0FBQztnQkFDaEUsQ0FBQyxNQUFNLENBQUMseUJBQXlCLElBQUksWUFBWSxLQUFLLFFBQVEsQ0FBQyxDQUNoRSxDQUFBO1NBQ0Y7SUFDSCxDQUFDOztBQXBLYyxtQ0FBUyxHQUFHLElBQUksT0FBTyxFQUduQyxDQUFBO0FBSkwsOERBc0tDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGV4dEVkaXRvciwgR3JhbW1hciwgUmFuZ2UgfSBmcm9tICdhdG9tJ1xuaW1wb3J0ICogYXMgdXRpbCBmcm9tICcuL3V0aWwnXG5pbXBvcnQgeyBNYXJrZG93blByZXZpZXdWaWV3LCBTZXJpYWxpemVkTVBWIH0gZnJvbSAnLi9tYXJrZG93bi1wcmV2aWV3LXZpZXcnXG5pbXBvcnQgeyBoYW5kbGVQcm9taXNlLCBhdG9tQ29uZmlnIH0gZnJvbSAnLi4vdXRpbCdcbmltcG9ydCB7IHJlbW90ZSB9IGZyb20gJ2VsZWN0cm9uJ1xuaW1wb3J0IHsgTWFya2Rvd25QcmV2aWV3Vmlld0VkaXRvclJlbW90ZSB9IGZyb20gJy4vbWFya2Rvd24tcHJldmlldy12aWV3LWVkaXRvci1yZW1vdGUnXG5cbmV4cG9ydCBjbGFzcyBNYXJrZG93blByZXZpZXdWaWV3RWRpdG9yIGV4dGVuZHMgTWFya2Rvd25QcmV2aWV3VmlldyB7XG4gIHByaXZhdGUgc3RhdGljIGVkaXRvck1hcCA9IG5ldyBXZWFrTWFwPFxuICAgIFRleHRFZGl0b3IsXG4gICAgTWFya2Rvd25QcmV2aWV3Vmlld0VkaXRvclxuICA+KClcblxuICBwcml2YXRlIGNvbnN0cnVjdG9yKHByaXZhdGUgZWRpdG9yOiBUZXh0RWRpdG9yKSB7XG4gICAgc3VwZXIoKVxuICAgIHRoaXMuaGFuZGxlRWRpdG9yRXZlbnRzKClcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgY3JlYXRlKGVkaXRvcjogVGV4dEVkaXRvcikge1xuICAgIGxldCBtcHB2ID0gTWFya2Rvd25QcmV2aWV3Vmlld0VkaXRvci5lZGl0b3JNYXAuZ2V0KGVkaXRvcilcbiAgICBpZiAoIW1wcHYpIHtcbiAgICAgIG1wcHYgPSBuZXcgTWFya2Rvd25QcmV2aWV3Vmlld0VkaXRvcihlZGl0b3IpXG4gICAgICBNYXJrZG93blByZXZpZXdWaWV3RWRpdG9yLmVkaXRvck1hcC5zZXQoZWRpdG9yLCBtcHB2KVxuICAgIH1cbiAgICByZXR1cm4gbXBwdlxuICB9XG5cbiAgcHVibGljIHN0YXRpYyB2aWV3Rm9yRWRpdG9yKGVkaXRvcjogVGV4dEVkaXRvcikge1xuICAgIHJldHVybiBNYXJrZG93blByZXZpZXdWaWV3RWRpdG9yLmVkaXRvck1hcC5nZXQoZWRpdG9yKVxuICB9XG5cbiAgcHVibGljIGRlc3Ryb3koKSB7XG4gICAgc3VwZXIuZGVzdHJveSgpXG4gICAgTWFya2Rvd25QcmV2aWV3Vmlld0VkaXRvci5lZGl0b3JNYXAuZGVsZXRlKHRoaXMuZWRpdG9yKVxuICB9XG5cbiAgcHVibGljIHNlcmlhbGl6ZSgpOiBTZXJpYWxpemVkTVBWIHtcbiAgICByZXR1cm4ge1xuICAgICAgZGVzZXJpYWxpemVyOiAnbWFya2Rvd24tcHJldmlldy1wbHVzL01hcmtkb3duUHJldmlld1ZpZXcnLFxuICAgICAgZWRpdG9ySWQ6IHRoaXMuZWRpdG9yICYmIHRoaXMuZWRpdG9yLmlkLFxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBnZXRUaXRsZSgpIHtcbiAgICByZXR1cm4gYCR7dGhpcy5lZGl0b3IuZ2V0VGl0bGUoKX0gUHJldmlld2BcbiAgfVxuXG4gIHB1YmxpYyBnZXRVUkkoKSB7XG4gICAgcmV0dXJuIGBtYXJrZG93bi1wcmV2aWV3LXBsdXM6Ly9lZGl0b3IvJHt0aGlzLmVkaXRvci5pZH1gXG4gIH1cblxuICBwdWJsaWMgZ2V0UGF0aCgpIHtcbiAgICByZXR1cm4gdGhpcy5lZGl0b3IuZ2V0UGF0aCgpXG4gIH1cblxuICBwcm90ZWN0ZWQgYXN5bmMgZ2V0TWFya2Rvd25Tb3VyY2UoKSB7XG4gICAgcmV0dXJuIHRoaXMuZWRpdG9yLmdldFRleHQoKVxuICB9XG5cbiAgcHJvdGVjdGVkIGdldEdyYW1tYXIoKTogR3JhbW1hciB7XG4gICAgcmV0dXJuIHRoaXMuZWRpdG9yLmdldEdyYW1tYXIoKVxuICB9XG5cbiAgcHJvdGVjdGVkIGRpZFNjcm9sbFByZXZpZXcobWluOiBudW1iZXIsIG1heDogbnVtYmVyKSB7XG4gICAgaWYgKCF0aGlzLnNob3VsZFNjcm9sbFN5bmMoJ3ByZXZpZXcnKSkgcmV0dXJuXG4gICAgaWYgKG1pbiA9PT0gMCkge1xuICAgICAgdGhpcy5lZGl0b3Iuc2Nyb2xsVG9CdWZmZXJQb3NpdGlvbihbbWluLCAwXSlcbiAgICB9IGVsc2UgaWYgKG1heCA+PSB0aGlzLmVkaXRvci5nZXRMYXN0QnVmZmVyUm93KCkgLSAxKSB7XG4gICAgICB0aGlzLmVkaXRvci5zY3JvbGxUb0J1ZmZlclBvc2l0aW9uKFttYXgsIDBdKVxuICAgIH0gZWxzZSB7XG4gICAgICAvLyBjb25zdCBtaWQgPSBNYXRoLmZsb29yKDAuNSAqIChtaW4gKyBtYXgpKVxuICAgICAgLy8gdGhpcy5lZGl0b3Iuc2Nyb2xsVG9CdWZmZXJQb3NpdGlvbihbbWlkLCAwXSwgeyBjZW50ZXI6IHRydWUgfSlcbiAgICAgIGNvbnN0IHJhbmdlID0gUmFuZ2UuZnJvbU9iamVjdChbW21pbiwgMF0sIFttYXgsIDBdXSlcbiAgICAgIHRoaXMuZWRpdG9yLnNjcm9sbFRvU2NyZWVuUmFuZ2UoXG4gICAgICAgIHRoaXMuZWRpdG9yLnNjcmVlblJhbmdlRm9yQnVmZmVyUmFuZ2UocmFuZ2UpLFxuICAgICAgICB7IGNlbnRlcjogZmFsc2UgfSxcbiAgICAgIClcbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgb3Blbk5ld1dpbmRvdygpIHtcbiAgICBjb25zdCB3aW5kb3dJZCA9IHJlbW90ZS5nZXRDdXJyZW50V2luZG93KCkuaWRcbiAgICBjb25zdCBlZGl0b3JJZCA9IHRoaXMuZWRpdG9yLmlkXG4gICAgYXRvbS5vcGVuKHtcbiAgICAgIHBhdGhzVG9PcGVuOiBbXG4gICAgICAgIGBtYXJrZG93bi1wcmV2aWV3LXBsdXM6Ly9yZW1vdGUtZWRpdG9yLyR7d2luZG93SWR9LyR7ZWRpdG9ySWR9YCxcbiAgICAgIF0sXG4gICAgfSlcbiAgICBNYXJrZG93blByZXZpZXdWaWV3RWRpdG9yUmVtb3RlLnNldHVwRWRpdG9yKHRoaXMuZWRpdG9yKVxuICAgIHV0aWwuZGVzdHJveSh0aGlzKVxuICB9XG5cbiAgcHJvdGVjdGVkIG9wZW5Tb3VyY2UoaW5pdGlhbExpbmU/OiBudW1iZXIpIHtcbiAgICBpZiAoaW5pdGlhbExpbmUgIT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhpcy5lZGl0b3Iuc2V0Q3Vyc29yQnVmZmVyUG9zaXRpb24oW2luaXRpYWxMaW5lLCAwXSlcbiAgICB9XG4gICAgY29uc3QgcGFuZSA9IGF0b20ud29ya3NwYWNlLnBhbmVGb3JJdGVtKHRoaXMuZWRpdG9yKVxuICAgIGlmICghcGFuZSkgcmV0dXJuXG4gICAgcGFuZS5hY3RpdmF0ZUl0ZW0odGhpcy5lZGl0b3IpXG4gICAgcGFuZS5hY3RpdmF0ZSgpXG4gIH1cblxuICBwcml2YXRlIGhhbmRsZUVkaXRvckV2ZW50cygpIHtcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChcbiAgICAgIGF0b20ud29ya3NwYWNlLm9uRGlkQ2hhbmdlQWN0aXZlVGV4dEVkaXRvcigoZWQpID0+IHtcbiAgICAgICAgaWYgKGF0b21Db25maWcoKS5wcmV2aWV3Q29uZmlnLmFjdGl2YXRlUHJldmlld1dpdGhFZGl0b3IpIHtcbiAgICAgICAgICBpZiAoZWQgPT09IHRoaXMuZWRpdG9yKSB7XG4gICAgICAgICAgICBjb25zdCBwYW5lID0gYXRvbS53b3Jrc3BhY2UucGFuZUZvckl0ZW0odGhpcylcbiAgICAgICAgICAgIGlmICghcGFuZSkgcmV0dXJuXG4gICAgICAgICAgICBjb25zdCBlZFBhbmUgPSBhdG9tLndvcmtzcGFjZS5wYW5lRm9ySXRlbShlZClcbiAgICAgICAgICAgIGlmIChwYW5lID09PSBlZFBhbmUpIHJldHVyblxuICAgICAgICAgICAgcGFuZS5hY3RpdmF0ZUl0ZW0odGhpcylcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pLFxuICAgICAgdGhpcy5lZGl0b3IuZ2V0QnVmZmVyKCkub25EaWRTdG9wQ2hhbmdpbmcoKCkgPT4ge1xuICAgICAgICBpZiAoYXRvbUNvbmZpZygpLnByZXZpZXdDb25maWcubGl2ZVVwZGF0ZSkge1xuICAgICAgICAgIHRoaXMuY2hhbmdlSGFuZGxlcigpXG4gICAgICAgIH1cbiAgICAgICAgaWYgKGF0b21Db25maWcoKS5zeW5jQ29uZmlnLnN5bmNQcmV2aWV3T25DaGFuZ2UpIHtcbiAgICAgICAgICBoYW5kbGVQcm9taXNlKHRoaXMuc3luY1ByZXZpZXdIZWxwZXIoKSlcbiAgICAgICAgfVxuICAgICAgfSksXG4gICAgICB0aGlzLmVkaXRvci5vbkRpZENoYW5nZVBhdGgoKCkgPT4ge1xuICAgICAgICB0aGlzLmVtaXR0ZXIuZW1pdCgnZGlkLWNoYW5nZS10aXRsZScpXG4gICAgICB9KSxcbiAgICAgIHRoaXMuZWRpdG9yLm9uRGlkRGVzdHJveSgoKSA9PiB7XG4gICAgICAgIGlmIChhdG9tQ29uZmlnKCkucHJldmlld0NvbmZpZy5jbG9zZVByZXZpZXdXaXRoRWRpdG9yKSB7XG4gICAgICAgICAgdXRpbC5kZXN0cm95KHRoaXMpXG4gICAgICAgIH1cbiAgICAgIH0pLFxuICAgICAgdGhpcy5lZGl0b3IuZ2V0QnVmZmVyKCkub25EaWRTYXZlKCgpID0+IHtcbiAgICAgICAgaWYgKCFhdG9tQ29uZmlnKCkucHJldmlld0NvbmZpZy5saXZlVXBkYXRlKSB7XG4gICAgICAgICAgdGhpcy5jaGFuZ2VIYW5kbGVyKClcbiAgICAgICAgfVxuICAgICAgfSksXG4gICAgICB0aGlzLmVkaXRvci5nZXRCdWZmZXIoKS5vbkRpZFJlbG9hZCgoKSA9PiB7XG4gICAgICAgIGlmICghYXRvbUNvbmZpZygpLnByZXZpZXdDb25maWcubGl2ZVVwZGF0ZSkge1xuICAgICAgICAgIHRoaXMuY2hhbmdlSGFuZGxlcigpXG4gICAgICAgIH1cbiAgICAgIH0pLFxuICAgICAgYXRvbS52aWV3cy5nZXRWaWV3KHRoaXMuZWRpdG9yKS5vbkRpZENoYW5nZVNjcm9sbFRvcCgoKSA9PiB7XG4gICAgICAgIGlmICghdGhpcy5zaG91bGRTY3JvbGxTeW5jKCdlZGl0b3InKSkgcmV0dXJuXG4gICAgICAgIGNvbnN0IFtmaXJzdCwgbGFzdF0gPSB0aGlzLmVkaXRvci5nZXRWaXNpYmxlUm93UmFuZ2UoKVxuICAgICAgICB0aGlzLmVsZW1lbnQuc2VuZDwnc2Nyb2xsLXN5bmMnPignc2Nyb2xsLXN5bmMnLCB7XG4gICAgICAgICAgZmlyc3RMaW5lOiB0aGlzLmVkaXRvci5idWZmZXJSb3dGb3JTY3JlZW5Sb3coZmlyc3QpLFxuICAgICAgICAgIGxhc3RMaW5lOiB0aGlzLmVkaXRvci5idWZmZXJSb3dGb3JTY3JlZW5Sb3cobGFzdCksXG4gICAgICAgIH0pXG4gICAgICB9KSxcbiAgICAgIGF0b20uY29tbWFuZHMuYWRkKGF0b20udmlld3MuZ2V0Vmlldyh0aGlzLmVkaXRvciksIHtcbiAgICAgICAgJ21hcmtkb3duLXByZXZpZXctcGx1czpzeW5jLXByZXZpZXcnOiB0aGlzLnN5bmNQcmV2aWV3SGVscGVyLFxuICAgICAgfSksXG4gICAgKVxuICB9XG5cbiAgcHJpdmF0ZSBzeW5jUHJldmlld0hlbHBlciA9IGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBwb3MgPSB0aGlzLmVkaXRvci5nZXRDdXJzb3JCdWZmZXJQb3NpdGlvbigpLnJvd1xuICAgIHRoaXMuc3luY1ByZXZpZXcocG9zKVxuICB9XG5cbiAgcHJpdmF0ZSBzaG91bGRTY3JvbGxTeW5jKHdoYXRTY3JvbGxlZDogJ2VkaXRvcicgfCAncHJldmlldycpIHtcbiAgICBjb25zdCBjb25maWcgPSBhdG9tQ29uZmlnKCkuc3luY0NvbmZpZ1xuICAgIGlmIChjb25maWcuc3luY0VkaXRvck9uUHJldmlld1Njcm9sbCAmJiBjb25maWcuc3luY1ByZXZpZXdPbkVkaXRvclNjcm9sbCkge1xuICAgICAgY29uc3QgaXRlbSA9IHdoYXRTY3JvbGxlZCA9PT0gJ2VkaXRvcicgPyB0aGlzLmVkaXRvciA6IHRoaXNcbiAgICAgIGNvbnN0IHBhbmUgPSBhdG9tLndvcmtzcGFjZS5wYW5lRm9ySXRlbShpdGVtKVxuICAgICAgcmV0dXJuIHBhbmUgJiYgcGFuZS5pc0FjdGl2ZSgpXG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiAoXG4gICAgICAgIChjb25maWcuc3luY0VkaXRvck9uUHJldmlld1Njcm9sbCAmJiB3aGF0U2Nyb2xsZWQgPT09ICdwcmV2aWV3JykgfHxcbiAgICAgICAgKGNvbmZpZy5zeW5jUHJldmlld09uRWRpdG9yU2Nyb2xsICYmIHdoYXRTY3JvbGxlZCA9PT0gJ2VkaXRvcicpXG4gICAgICApXG4gICAgfVxuICB9XG59XG4iXX0=