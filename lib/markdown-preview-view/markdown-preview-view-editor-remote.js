"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const util = require("./util");
const markdown_preview_view_1 = require("./markdown-preview-view");
const util_1 = require("../util");
const electron_1 = require("electron");
class MarkdownPreviewViewEditorRemote extends markdown_preview_view_1.MarkdownPreviewView {
    constructor(windowId, editorId) {
        super();
        this.windowId = windowId;
        this.editorId = editorId;
        this.ipcIdx = 0;
        this.title = '<Pending>';
        this.syncPreviewHelper = async () => {
            const pos = await this.ipc('getCursorBufferRow', undefined);
            this.syncPreview(pos);
        };
        this.handleEditorEvents();
        this.myWindowId = electron_1.remote.getCurrentWindow().id;
        util_1.handlePromise(this.ipc('init', undefined));
    }
    destroy() {
        util_1.handlePromise(this.ipc('destroy', undefined));
        super.destroy();
    }
    getTitle() {
        return `${this.title} Preview`;
    }
    getURI() {
        return `markdown-preview-plus://remote-editor/${this.windowId}/${this.editorId}`;
    }
    getPath() {
        return this.path;
    }
    serialize() {
        return undefined;
    }
    async getMarkdownSource() {
        return this.ipc('getText', undefined);
    }
    getGrammar() {
        return this.grammar;
    }
    async didScrollPreview(min, max) {
        if (!this.shouldScrollSync('preview'))
            return;
        if (min === 0) {
            await this.ipc('scrollToBufferRow', min);
        }
        else if (max >= (await this.ipc('getLastBufferRow', undefined)) - 1) {
            await this.ipc('scrollToBufferRow', max);
        }
        else {
            await this.ipc('scrollToBufferRange', [min, max]);
        }
    }
    openSource(initialLine) {
        util_1.handlePromise(this.ipc('openSource', initialLine));
    }
    handleEditorEvents() {
        this.disposables.add(this.ipcEvent('onDidStopChanging', () => {
            if (util_1.atomConfig().previewConfig.liveUpdate) {
                this.changeHandler();
            }
            if (util_1.atomConfig().syncConfig.syncPreviewOnChange) {
                util_1.handlePromise(this.syncPreviewHelper());
            }
        }), this.ipcEvent('onDidChangePath', ({ title, path }) => {
            this.title = title;
            this.path = path;
            this.emitter.emit('did-change-title');
        }), this.ipcEvent('onDidChangeGrammar', (grammarName) => {
            this.grammar = atom.grammars.grammarForScopeName(grammarName);
            this.emitter.emit('did-change-title');
        }), this.ipcEvent('onDidDestroy', () => {
            if (util_1.atomConfig().previewConfig.closePreviewWithEditor) {
                util.destroy(this);
            }
        }), this.ipcEvent('onDidSave', () => {
            if (!util_1.atomConfig().previewConfig.liveUpdate) {
                this.changeHandler();
            }
        }), this.ipcEvent('onDidReload', () => {
            if (!util_1.atomConfig().previewConfig.liveUpdate) {
                this.changeHandler();
            }
        }), this.ipcEvent('onDidChangeScrollTop', (bufferRowRange) => {
            if (!this.shouldScrollSync('editor'))
                return;
            const [first, last] = bufferRowRange;
            this.element.send('scroll-sync', {
                firstLine: first,
                lastLine: last,
            });
        }), this.ipcEvent('syncPreview', this.syncPreviewHelper));
    }
    shouldScrollSync(whatScrolled) {
        const config = util_1.atomConfig().syncConfig;
        if (config.syncEditorOnPreviewScroll && config.syncPreviewOnEditorScroll) {
            return ((whatScrolled === 'preview') === electron_1.remote.getCurrentWindow().isFocused());
        }
        else {
            return ((config.syncEditorOnPreviewScroll && whatScrolled === 'preview') ||
                (config.syncPreviewOnEditorScroll && whatScrolled === 'editor'));
        }
    }
    async ipc(cmd, args) {
        return new Promise((resolve) => {
            const idx = this.ipcIdx++;
            const handler = (e) => {
                if (e.forWindowId === this.myWindowId &&
                    e.windowId === this.windowId &&
                    e.editorId === this.editorId &&
                    e.idx === idx) {
                    electron_1.remote.ipcMain.removeListener('markdown-preview-plus-editor-reply', handler);
                    resolve(e.reply);
                }
            };
            electron_1.remote.ipcMain.on('markdown-preview-plus-editor-reply', handler);
            electron_1.remote.ipcMain.emit('markdown-preview-plus-editor-request', {
                windowId: this.windowId,
                editorId: this.editorId,
                forWindowId: this.myWindowId,
                idx,
                cmd,
                args,
            });
        });
    }
    ipcEvent(name, callback) {
        const handler = (e) => {
            if (this.editorId === e.editorId &&
                this.windowId === e.windowId &&
                name === e.event) {
                callback(e.arg);
            }
        };
        electron_1.remote.ipcMain.on('markdown-preview-plus-editor-event', handler);
        return new atom_1.Disposable(function () {
            electron_1.remote.ipcMain.removeListener('markdown-preview-plus-editor-event', handler);
        });
    }
    static setupEditor(editor) {
        const disp = new atom_1.CompositeDisposable();
        const windowId = electron_1.remote.getCurrentWindow().id;
        const editorId = editor.id;
        function emit(event, arg) {
            electron_1.remote.ipcMain.emit('markdown-preview-plus-editor-event', {
                editorId,
                windowId,
                event,
                arg,
            });
        }
        function requestHandler(e) {
            if (e.editorId !== editorId || e.windowId !== windowId)
                return;
            let reply = undefined;
            switch (e.cmd) {
                case 'getCursorBufferRow':
                    reply = editor.getCursorBufferPosition().row;
                    break;
                case 'scrollToBufferRange':
                    const [min, max] = e.args;
                    const range = atom_1.Range.fromObject([[min, 0], [max, 0]]);
                    editor.scrollToScreenRange(editor.screenRangeForBufferRange(range), {
                        center: false,
                    });
                    reply = undefined;
                    break;
                case 'scrollToBufferRow':
                    editor.scrollToBufferPosition([e.args, 0]);
                    reply = undefined;
                    break;
                case 'getLastBufferRow':
                    reply = editor.getLastBufferRow();
                    break;
                case 'getText':
                    reply = editor.getText();
                    break;
                case 'destroy':
                    disp.dispose();
                    reply = undefined;
                    break;
                case 'init':
                    emit('onDidChangePath', {
                        path: editor.getPath(),
                        title: editor.getTitle(),
                    });
                    emit('onDidChangeGrammar', editor.getGrammar().scopeName);
                    break;
                case 'openSource':
                    if (e.args !== undefined) {
                        editor.setCursorBufferPosition([e.args, 0]);
                    }
                    electron_1.remote.getCurrentWindow().focus();
                    const pane = atom.workspace.paneForItem(editor);
                    if (!pane)
                        break;
                    pane.activateItem(editor);
                    pane.activate();
                    break;
            }
            electron_1.remote.ipcMain.emit('markdown-preview-plus-editor-reply', {
                editorId: e.editorId,
                windowId: e.windowId,
                forWindowId: e.forWindowId,
                idx: e.idx,
                reply,
            });
        }
        electron_1.remote.ipcMain.on('markdown-preview-plus-editor-request', requestHandler);
        disp.add(editor.getBuffer().onDidStopChanging(() => {
            emit('onDidStopChanging', undefined);
        }), editor.onDidChangePath(() => {
            emit('onDidChangePath', {
                path: editor.getPath(),
                title: editor.getTitle(),
            });
        }), editor.onDidChangeGrammar((grammar) => {
            emit('onDidChangeGrammar', grammar.scopeName);
        }), editor.onDidDestroy(() => {
            emit('onDidDestroy', undefined);
        }), editor.getBuffer().onDidSave(() => {
            emit('onDidSave', undefined);
        }), editor.getBuffer().onDidReload(() => {
            emit('onDidReload', undefined);
        }), atom.views.getView(editor).onDidChangeScrollTop(() => {
            const [first, last] = editor.getVisibleRowRange();
            const firstLine = editor.bufferRowForScreenRow(first);
            const lastLine = editor.bufferRowForScreenRow(last);
            emit('onDidChangeScrollTop', [firstLine, lastLine]);
        }), atom.commands.add(atom.views.getView(editor), {
            'markdown-preview-plus:sync-preview': () => {
                emit('syncPreview', undefined);
            },
        }), new atom_1.Disposable(() => {
            electron_1.remote.ipcMain.removeListener('markdown-preview-plus-editor-request', requestHandler);
        }));
        return disp;
    }
}
exports.MarkdownPreviewViewEditorRemote = MarkdownPreviewViewEditorRemote;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFya2Rvd24tcHJldmlldy12aWV3LWVkaXRvci1yZW1vdGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvbWFya2Rvd24tcHJldmlldy12aWV3L21hcmtkb3duLXByZXZpZXctdmlldy1lZGl0b3ItcmVtb3RlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsK0JBTWE7QUFDYiwrQkFBOEI7QUFDOUIsbUVBQTRFO0FBQzVFLGtDQUFtRDtBQUNuRCx1Q0FBaUM7QUFFakMscUNBQTZDLFNBQVEsMkNBQW1CO0lBT3RFLFlBQW9CLFFBQWdCLEVBQVUsUUFBZ0I7UUFDNUQsS0FBSyxFQUFFLENBQUE7UUFEVyxhQUFRLEdBQVIsUUFBUSxDQUFRO1FBQVUsYUFBUSxHQUFSLFFBQVEsQ0FBUTtRQU50RCxXQUFNLEdBQUcsQ0FBQyxDQUFBO1FBRVYsVUFBSyxHQUFXLFdBQVcsQ0FBQTtRQTBHM0Isc0JBQWlCLEdBQUcsS0FBSyxJQUFJLEVBQUU7WUFDckMsTUFBTSxHQUFHLEdBQUcsTUFBTSxJQUFJLENBQUMsR0FBRyxDQUFDLG9CQUFvQixFQUFFLFNBQVMsQ0FBQyxDQUFBO1lBQzNELElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUE7UUFDdkIsQ0FBQyxDQUFBO1FBdkdDLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFBO1FBQ3pCLElBQUksQ0FBQyxVQUFVLEdBQUcsaUJBQU0sQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDLEVBQUUsQ0FBQTtRQUM5QyxvQkFBYSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUE7SUFDNUMsQ0FBQztJQUVNLE9BQU87UUFDWixvQkFBYSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUE7UUFDN0MsS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFBO0lBQ2pCLENBQUM7SUFFTSxRQUFRO1FBQ2IsT0FB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QUFDLENBQUMsRUFDRixJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUM1QyxvQ0FBb0MsRUFBRSxHQUFHLEVBQUU7Z0JBQ3pDLElBQUksQ0FBQyxhQUFhLEVBQUUsU0FBUyxDQUFDLENBQUE7WUFDaEMsQ0FBQztTQUNGLENBQUMsRUFDRixJQUFJLGlCQUFVLENBQUMsR0FBRyxFQUFFO1lBQ2xCLGlCQUFNLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FDM0Isc0NBQXNDLEVBQ3RDLGNBQWMsQ0FDZixDQUFBO1FBQ0gsQ0FBQyxDQUFDLENBQ0gsQ0FBQTtRQUNELE9BQU8sSUFBSSxDQUFBO0lBQ2IsQ0FBQztDQUNGO0FBbFRELDBFQWtUQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIFRleHRFZGl0b3IsXG4gIEdyYW1tYXIsXG4gIFJhbmdlLFxuICBEaXNwb3NhYmxlLFxuICBDb21wb3NpdGVEaXNwb3NhYmxlLFxufSBmcm9tICdhdG9tJ1xuaW1wb3J0ICogYXMgdXRpbCBmcm9tICcuL3V0aWwnXG5pbXBvcnQgeyBNYXJrZG93blByZXZpZXdWaWV3LCBTZXJpYWxpemVkTVBWIH0gZnJvbSAnLi9tYXJrZG93bi1wcmV2aWV3LXZpZXcnXG5pbXBvcnQgeyBoYW5kbGVQcm9taXNlLCBhdG9tQ29uZmlnIH0gZnJvbSAnLi4vdXRpbCdcbmltcG9ydCB7IHJlbW90ZSB9IGZyb20gJ2VsZWN0cm9uJ1xuXG5leHBvcnQgY2xhc3MgTWFya2Rvd25QcmV2aWV3Vmlld0VkaXRvclJlbW90ZSBleHRlbmRzIE1hcmtkb3duUHJldmlld1ZpZXcge1xuICBwcml2YXRlIGlwY0lkeCA9IDBcbiAgcHJpdmF0ZSBteVdpbmRvd0lkOiBudW1iZXJcbiAgcHJpdmF0ZSB0aXRsZTogc3RyaW5nID0gJzxQZW5kaW5nPidcbiAgcHJpdmF0ZSBwYXRoPzogc3RyaW5nXG4gIHByaXZhdGUgZ3JhbW1hcj86IEdyYW1tYXJcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHdpbmRvd0lkOiBudW1iZXIsIHByaXZhdGUgZWRpdG9ySWQ6IG51bWJlcikge1xuICAgIHN1cGVyKClcbiAgICB0aGlzLmhhbmRsZUVkaXRvckV2ZW50cygpXG4gICAgdGhpcy5teVdpbmRvd0lkID0gcmVtb3RlLmdldEN1cnJlbnRXaW5kb3coKS5pZFxuICAgIGhhbmRsZVByb21pc2UodGhpcy5pcGMoJ2luaXQnLCB1bmRlZmluZWQpKVxuICB9XG5cbiAgcHVibGljIGRlc3Ryb3koKSB7XG4gICAgaGFuZGxlUHJvbWlzZSh0aGlzLmlwYygnZGVzdHJveScsIHVuZGVmaW5lZCkpXG4gICAgc3VwZXIuZGVzdHJveSgpXG4gIH1cblxuICBwdWJsaWMgZ2V0VGl0bGUoKSB7XG4gICAgcmV0dXJuIGAke3RoaXMudGl0bGV9IFByZXZpZXdgXG4gIH1cblxuICBwdWJsaWMgZ2V0VVJJKCkge1xuICAgIHJldHVybiBgbWFya2Rvd24tcHJldmlldy1wbHVzOi8vcmVtb3RlLWVkaXRvci8ke3RoaXMud2luZG93SWR9LyR7XG4gICAgICB0aGlzLmVkaXRvcklkXG4gICAgfWBcbiAgfVxuXG4gIHB1YmxpYyBnZXRQYXRoKCkge1xuICAgIHJldHVybiB0aGlzLnBhdGhcbiAgfVxuXG4gIHB1YmxpYyBzZXJpYWxpemUoKTogU2VyaWFsaXplZE1QViB7XG4gICAgcmV0dXJuIHVuZGVmaW5lZCBhcyBhbnlcbiAgfVxuXG4gIHByb3RlY3RlZCBhc3luYyBnZXRNYXJrZG93blNvdXJjZSgpIHtcbiAgICByZXR1cm4gdGhpcy5pcGMoJ2dldFRleHQnLCB1bmRlZmluZWQpXG4gIH1cblxuICBwcm90ZWN0ZWQgZ2V0R3JhbW1hcigpOiBHcmFtbWFyIHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy5ncmFtbWFyXG4gIH1cblxuICBwcm90ZWN0ZWQgYXN5bmMgZGlkU2Nyb2xsUHJldmlldyhtaW46IG51bWJlciwgbWF4OiBudW1iZXIpIHtcbiAgICBpZiAoIXRoaXMuc2hvdWxkU2Nyb2xsU3luYygncHJldmlldycpKSByZXR1cm5cbiAgICBpZiAobWluID09PSAwKSB7XG4gICAgICBhd2FpdCB0aGlzLmlwYygnc2Nyb2xsVG9CdWZmZXJSb3cnLCBtaW4pXG4gICAgfSBlbHNlIGlmIChtYXggPj0gKGF3YWl0IHRoaXMuaXBjKCdnZXRMYXN0QnVmZmVyUm93JywgdW5kZWZpbmVkKSkgLSAxKSB7XG4gICAgICBhd2FpdCB0aGlzLmlwYygnc2Nyb2xsVG9CdWZmZXJSb3cnLCBtYXgpXG4gICAgfSBlbHNlIHtcbiAgICAgIGF3YWl0IHRoaXMuaXBjKCdzY3JvbGxUb0J1ZmZlclJhbmdlJywgW21pbiwgbWF4XSlcbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgb3BlblNvdXJjZShpbml0aWFsTGluZT86IG51bWJlcikge1xuICAgIGhhbmRsZVByb21pc2UodGhpcy5pcGMoJ29wZW5Tb3VyY2UnLCBpbml0aWFsTGluZSkpXG4gIH1cblxuICBwcml2YXRlIGhhbmRsZUVkaXRvckV2ZW50cygpIHtcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChcbiAgICAgIHRoaXMuaXBjRXZlbnQoJ29uRGlkU3RvcENoYW5naW5nJywgKCkgPT4ge1xuICAgICAgICBpZiAoYXRvbUNvbmZpZygpLnByZXZpZXdDb25maWcubGl2ZVVwZGF0ZSkge1xuICAgICAgICAgIHRoaXMuY2hhbmdlSGFuZGxlcigpXG4gICAgICAgIH1cbiAgICAgICAgaWYgKGF0b21Db25maWcoKS5zeW5jQ29uZmlnLnN5bmNQcmV2aWV3T25DaGFuZ2UpIHtcbiAgICAgICAgICBoYW5kbGVQcm9taXNlKHRoaXMuc3luY1ByZXZpZXdIZWxwZXIoKSlcbiAgICAgICAgfVxuICAgICAgfSksXG4gICAgICB0aGlzLmlwY0V2ZW50KCdvbkRpZENoYW5nZVBhdGgnLCAoeyB0aXRsZSwgcGF0aCB9KSA9PiB7XG4gICAgICAgIHRoaXMudGl0bGUgPSB0aXRsZVxuICAgICAgICB0aGlzLnBhdGggPSBwYXRoXG4gICAgICAgIHRoaXMuZW1pdHRlci5lbWl0KCdkaWQtY2hhbmdlLXRpdGxlJylcbiAgICAgIH0pLFxuICAgICAgdGhpcy5pcGNFdmVudCgnb25EaWRDaGFuZ2VHcmFtbWFyJywgKGdyYW1tYXJOYW1lKSA9PiB7XG4gICAgICAgIHRoaXMuZ3JhbW1hciA9IGF0b20uZ3JhbW1hcnMuZ3JhbW1hckZvclNjb3BlTmFtZShncmFtbWFyTmFtZSkhXG4gICAgICAgIHRoaXMuZW1pdHRlci5lbWl0KCdkaWQtY2hhbmdlLXRpdGxlJylcbiAgICAgIH0pLFxuICAgICAgdGhpcy5pcGNFdmVudCgnb25EaWREZXN0cm95JywgKCkgPT4ge1xuICAgICAgICBpZiAoYXRvbUNvbmZpZygpLnByZXZpZXdDb25maWcuY2xvc2VQcmV2aWV3V2l0aEVkaXRvcikge1xuICAgICAgICAgIHV0aWwuZGVzdHJveSh0aGlzKVxuICAgICAgICB9XG4gICAgICB9KSxcbiAgICAgIHRoaXMuaXBjRXZlbnQoJ29uRGlkU2F2ZScsICgpID0+IHtcbiAgICAgICAgaWYgKCFhdG9tQ29uZmlnKCkucHJldmlld0NvbmZpZy5saXZlVXBkYXRlKSB7XG4gICAgICAgICAgdGhpcy5jaGFuZ2VIYW5kbGVyKClcbiAgICAgICAgfVxuICAgICAgfSksXG4gICAgICB0aGlzLmlwY0V2ZW50KCdvbkRpZFJlbG9hZCcsICgpID0+IHtcbiAgICAgICAgaWYgKCFhdG9tQ29uZmlnKCkucHJldmlld0NvbmZpZy5saXZlVXBkYXRlKSB7XG4gICAgICAgICAgdGhpcy5jaGFuZ2VIYW5kbGVyKClcbiAgICAgICAgfVxuICAgICAgfSksXG4gICAgICB0aGlzLmlwY0V2ZW50KFxuICAgICAgICAnb25EaWRDaGFuZ2VTY3JvbGxUb3AnLFxuICAgICAgICAoYnVmZmVyUm93UmFuZ2U6IFtudW1iZXIsIG51bWJlcl0pID0+IHtcbiAgICAgICAgICBpZiAoIXRoaXMuc2hvdWxkU2Nyb2xsU3luYygnZWRpdG9yJykpIHJldHVyblxuICAgICAgICAgIGNvbnN0IFtmaXJzdCwgbGFzdF0gPSBidWZmZXJSb3dSYW5nZVxuICAgICAgICAgIHRoaXMuZWxlbWVudC5zZW5kPCdzY3JvbGwtc3luYyc+KCdzY3JvbGwtc3luYycsIHtcbiAgICAgICAgICAgIGZpcnN0TGluZTogZmlyc3QsXG4gICAgICAgICAgICBsYXN0TGluZTogbGFzdCxcbiAgICAgICAgICB9KVxuICAgICAgICB9LFxuICAgICAgKSxcbiAgICAgIHRoaXMuaXBjRXZlbnQoJ3N5bmNQcmV2aWV3JywgdGhpcy5zeW5jUHJldmlld0hlbHBlciksXG4gICAgKVxuICB9XG5cbiAgcHJpdmF0ZSBzeW5jUHJldmlld0hlbHBlciA9IGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBwb3MgPSBhd2FpdCB0aGlzLmlwYygnZ2V0Q3Vyc29yQnVmZmVyUm93JywgdW5kZWZpbmVkKVxuICAgIHRoaXMuc3luY1ByZXZpZXcocG9zKVxuICB9XG5cbiAgcHJpdmF0ZSBzaG91bGRTY3JvbGxTeW5jKHdoYXRTY3JvbGxlZDogJ2VkaXRvcicgfCAncHJldmlldycpIHtcbiAgICBjb25zdCBjb25maWcgPSBhdG9tQ29uZmlnKCkuc3luY0NvbmZpZ1xuICAgIGlmIChjb25maWcuc3luY0VkaXRvck9uUHJldmlld1Njcm9sbCAmJiBjb25maWcuc3luY1ByZXZpZXdPbkVkaXRvclNjcm9sbCkge1xuICAgICAgcmV0dXJuIChcbiAgICAgICAgKHdoYXRTY3JvbGxlZCA9PT0gJ3ByZXZpZXcnKSA9PT0gcmVtb3RlLmdldEN1cnJlbnRXaW5kb3coKS5pc0ZvY3VzZWQoKVxuICAgICAgKVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gKFxuICAgICAgICAoY29uZmlnLnN5bmNFZGl0b3JPblByZXZpZXdTY3JvbGwgJiYgd2hhdFNjcm9sbGVkID09PSAncHJldmlldycpIHx8XG4gICAgICAgIChjb25maWcuc3luY1ByZXZpZXdPbkVkaXRvclNjcm9sbCAmJiB3aGF0U2Nyb2xsZWQgPT09ICdlZGl0b3InKVxuICAgICAgKVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgaXBjPFQgZXh0ZW5kcyBrZXlvZiBJUENDbWQ+KFxuICAgIGNtZDogVCxcbiAgICBhcmdzOiBBcmc8SVBDQ21kW1RdPixcbiAgKTogUHJvbWlzZTxSZXR1cm5UeXBlPElQQ0NtZFtUXT4+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8YW55PigocmVzb2x2ZSkgPT4ge1xuICAgICAgY29uc3QgaWR4ID0gdGhpcy5pcGNJZHgrK1xuICAgICAgY29uc3QgaGFuZGxlciA9IChlOiB7XG4gICAgICAgIGVkaXRvcklkOiBudW1iZXJcbiAgICAgICAgd2luZG93SWQ6IG51bWJlclxuICAgICAgICBmb3JXaW5kb3dJZDogbnVtYmVyXG4gICAgICAgIGlkeDogbnVtYmVyXG4gICAgICAgIHJlcGx5OiBhbnlcbiAgICAgIH0pID0+IHtcbiAgICAgICAgaWYgKFxuICAgICAgICAgIGUuZm9yV2luZG93SWQgPT09IHRoaXMubXlXaW5kb3dJZCAmJlxuICAgICAgICAgIGUud2luZG93SWQgPT09IHRoaXMud2luZG93SWQgJiZcbiAgICAgICAgICBlLmVkaXRvcklkID09PSB0aGlzLmVkaXRvcklkICYmXG4gICAgICAgICAgZS5pZHggPT09IGlkeFxuICAgICAgICApIHtcbiAgICAgICAgICByZW1vdGUuaXBjTWFpbi5yZW1vdmVMaXN0ZW5lcihcbiAgICAgICAgICAgICdtYXJrZG93bi1wcmV2aWV3LXBsdXMtZWRpdG9yLXJlcGx5JyxcbiAgICAgICAgICAgIGhhbmRsZXIsXG4gICAgICAgICAgKVxuICAgICAgICAgIHJlc29sdmUoZS5yZXBseSlcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmVtb3RlLmlwY01haW4ub24oJ21hcmtkb3duLXByZXZpZXctcGx1cy1lZGl0b3ItcmVwbHknLCBoYW5kbGVyKVxuICAgICAgcmVtb3RlLmlwY01haW4uZW1pdCgnbWFya2Rvd24tcHJldmlldy1wbHVzLWVkaXRvci1yZXF1ZXN0Jywge1xuICAgICAgICB3aW5kb3dJZDogdGhpcy53aW5kb3dJZCxcbiAgICAgICAgZWRpdG9ySWQ6IHRoaXMuZWRpdG9ySWQsXG4gICAgICAgIGZvcldpbmRvd0lkOiB0aGlzLm15V2luZG93SWQsXG4gICAgICAgIGlkeCxcbiAgICAgICAgY21kLFxuICAgICAgICBhcmdzLFxuICAgICAgfSlcbiAgICB9KVxuICB9XG5cbiAgcHJpdmF0ZSBpcGNFdmVudDxUIGV4dGVuZHMga2V5b2YgSVBDRXZlbnRzPihcbiAgICBuYW1lOiBULFxuICAgIGNhbGxiYWNrOiAoYXJnOiBJUENFdmVudHNbVF0pID0+IHZvaWQsXG4gICk6IERpc3Bvc2FibGUge1xuICAgIGNvbnN0IGhhbmRsZXIgPSAoZToge1xuICAgICAgZWRpdG9ySWQ6IG51bWJlclxuICAgICAgd2luZG93SWQ6IG51bWJlclxuICAgICAgZXZlbnQ6IHN0cmluZ1xuICAgICAgYXJnOiBJUENFdmVudHNbVF1cbiAgICB9KSA9PiB7XG4gICAgICBpZiAoXG4gICAgICAgIHRoaXMuZWRpdG9ySWQgPT09IGUuZWRpdG9ySWQgJiZcbiAgICAgICAgdGhpcy53aW5kb3dJZCA9PT0gZS53aW5kb3dJZCAmJlxuICAgICAgICBuYW1lID09PSBlLmV2ZW50XG4gICAgICApIHtcbiAgICAgICAgY2FsbGJhY2soZS5hcmcpXG4gICAgICB9XG4gICAgfVxuICAgIHJlbW90ZS5pcGNNYWluLm9uKCdtYXJrZG93bi1wcmV2aWV3LXBsdXMtZWRpdG9yLWV2ZW50JywgaGFuZGxlcilcbiAgICByZXR1cm4gbmV3IERpc3Bvc2FibGUoZnVuY3Rpb24oKSB7XG4gICAgICByZW1vdGUuaXBjTWFpbi5yZW1vdmVMaXN0ZW5lcihcbiAgICAgICAgJ21hcmtkb3duLXByZXZpZXctcGx1cy1lZGl0b3ItZXZlbnQnLFxuICAgICAgICBoYW5kbGVyLFxuICAgICAgKVxuICAgIH0pXG4gIH1cblxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWVtYmVyLW9yZGVyaW5nXG4gIHB1YmxpYyBzdGF0aWMgc2V0dXBFZGl0b3IoZWRpdG9yOiBUZXh0RWRpdG9yKTogQ29tcG9zaXRlRGlzcG9zYWJsZSB7XG4gICAgY29uc3QgZGlzcCA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgICBjb25zdCB3aW5kb3dJZCA9IHJlbW90ZS5nZXRDdXJyZW50V2luZG93KCkuaWRcbiAgICBjb25zdCBlZGl0b3JJZCA9IGVkaXRvci5pZFxuICAgIGZ1bmN0aW9uIGVtaXQ8VCBleHRlbmRzIGtleW9mIElQQ0V2ZW50cz4oZXZlbnQ6IFQsIGFyZzogSVBDRXZlbnRzW1RdKSB7XG4gICAgICByZW1vdGUuaXBjTWFpbi5lbWl0KCdtYXJrZG93bi1wcmV2aWV3LXBsdXMtZWRpdG9yLWV2ZW50Jywge1xuICAgICAgICBlZGl0b3JJZCxcbiAgICAgICAgd2luZG93SWQsXG4gICAgICAgIGV2ZW50LFxuICAgICAgICBhcmcsXG4gICAgICB9KVxuICAgIH1cbiAgICBmdW5jdGlvbiByZXF1ZXN0SGFuZGxlcihlOiBFdmVudEZvcltrZXlvZiBJUENDbWRdKSB7XG4gICAgICBpZiAoZS5lZGl0b3JJZCAhPT0gZWRpdG9ySWQgfHwgZS53aW5kb3dJZCAhPT0gd2luZG93SWQpIHJldHVyblxuICAgICAgbGV0IHJlcGx5OiBhbnkgPSB1bmRlZmluZWRcbiAgICAgIHN3aXRjaCAoZS5jbWQpIHtcbiAgICAgICAgY2FzZSAnZ2V0Q3Vyc29yQnVmZmVyUm93JzpcbiAgICAgICAgICByZXBseSA9IGVkaXRvci5nZXRDdXJzb3JCdWZmZXJQb3NpdGlvbigpLnJvdyBhcyBSZXR1cm5UeXBlPFxuICAgICAgICAgICAgSVBDQ21kW3R5cGVvZiBlLmNtZF1cbiAgICAgICAgICA+XG4gICAgICAgICAgYnJlYWtcbiAgICAgICAgY2FzZSAnc2Nyb2xsVG9CdWZmZXJSYW5nZSc6XG4gICAgICAgICAgY29uc3QgW21pbiwgbWF4XSA9IGUuYXJnc1xuICAgICAgICAgIGNvbnN0IHJhbmdlID0gUmFuZ2UuZnJvbU9iamVjdChbW21pbiwgMF0sIFttYXgsIDBdXSlcbiAgICAgICAgICBlZGl0b3Iuc2Nyb2xsVG9TY3JlZW5SYW5nZShlZGl0b3Iuc2NyZWVuUmFuZ2VGb3JCdWZmZXJSYW5nZShyYW5nZSksIHtcbiAgICAgICAgICAgIGNlbnRlcjogZmFsc2UsXG4gICAgICAgICAgfSlcbiAgICAgICAgICByZXBseSA9IHVuZGVmaW5lZCBhcyBSZXR1cm5UeXBlPElQQ0NtZFt0eXBlb2YgZS5jbWRdPlxuICAgICAgICAgIGJyZWFrXG4gICAgICAgIGNhc2UgJ3Njcm9sbFRvQnVmZmVyUm93JzpcbiAgICAgICAgICBlZGl0b3Iuc2Nyb2xsVG9CdWZmZXJQb3NpdGlvbihbZS5hcmdzLCAwXSlcbiAgICAgICAgICByZXBseSA9IHVuZGVmaW5lZCBhcyBSZXR1cm5UeXBlPElQQ0NtZFt0eXBlb2YgZS5jbWRdPlxuICAgICAgICAgIGJyZWFrXG4gICAgICAgIGNhc2UgJ2dldExhc3RCdWZmZXJSb3cnOlxuICAgICAgICAgIHJlcGx5ID0gZWRpdG9yLmdldExhc3RCdWZmZXJSb3coKSBhcyBSZXR1cm5UeXBlPElQQ0NtZFt0eXBlb2YgZS5jbWRdPlxuICAgICAgICAgIGJyZWFrXG4gICAgICAgIGNhc2UgJ2dldFRleHQnOlxuICAgICAgICAgIHJlcGx5ID0gZWRpdG9yLmdldFRleHQoKSBhcyBSZXR1cm5UeXBlPElQQ0NtZFt0eXBlb2YgZS5jbWRdPlxuICAgICAgICAgIGJyZWFrXG4gICAgICAgIGNhc2UgJ2Rlc3Ryb3knOlxuICAgICAgICAgIGRpc3AuZGlzcG9zZSgpXG4gICAgICAgICAgcmVwbHkgPSB1bmRlZmluZWQgYXMgUmV0dXJuVHlwZTxJUENDbWRbdHlwZW9mIGUuY21kXT5cbiAgICAgICAgICBicmVha1xuICAgICAgICBjYXNlICdpbml0JzpcbiAgICAgICAgICBlbWl0KCdvbkRpZENoYW5nZVBhdGgnLCB7XG4gICAgICAgICAgICBwYXRoOiBlZGl0b3IuZ2V0UGF0aCgpLFxuICAgICAgICAgICAgdGl0bGU6IGVkaXRvci5nZXRUaXRsZSgpLFxuICAgICAgICAgIH0pXG4gICAgICAgICAgZW1pdCgnb25EaWRDaGFuZ2VHcmFtbWFyJywgZWRpdG9yLmdldEdyYW1tYXIoKS5zY29wZU5hbWUpXG4gICAgICAgICAgYnJlYWtcbiAgICAgICAgY2FzZSAnb3BlblNvdXJjZSc6XG4gICAgICAgICAgaWYgKGUuYXJncyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBlZGl0b3Iuc2V0Q3Vyc29yQnVmZmVyUG9zaXRpb24oW2UuYXJncywgMF0pXG4gICAgICAgICAgfVxuICAgICAgICAgIHJlbW90ZS5nZXRDdXJyZW50V2luZG93KCkuZm9jdXMoKVxuICAgICAgICAgIGNvbnN0IHBhbmUgPSBhdG9tLndvcmtzcGFjZS5wYW5lRm9ySXRlbShlZGl0b3IpXG4gICAgICAgICAgaWYgKCFwYW5lKSBicmVha1xuICAgICAgICAgIHBhbmUuYWN0aXZhdGVJdGVtKGVkaXRvcilcbiAgICAgICAgICBwYW5lLmFjdGl2YXRlKClcbiAgICAgICAgICBicmVha1xuICAgICAgfVxuICAgICAgcmVtb3RlLmlwY01haW4uZW1pdCgnbWFya2Rvd24tcHJldmlldy1wbHVzLWVkaXRvci1yZXBseScsIHtcbiAgICAgICAgZWRpdG9ySWQ6IGUuZWRpdG9ySWQsXG4gICAgICAgIHdpbmRvd0lkOiBlLndpbmRvd0lkLFxuICAgICAgICBmb3JXaW5kb3dJZDogZS5mb3JXaW5kb3dJZCxcbiAgICAgICAgaWR4OiBlLmlkeCxcbiAgICAgICAgcmVwbHksXG4gICAgICB9KVxuICAgIH1cbiAgICByZW1vdGUuaXBjTWFpbi5vbignbWFya2Rvd24tcHJldmlldy1wbHVzLWVkaXRvci1yZXF1ZXN0JywgcmVxdWVzdEhhbmRsZXIpXG4gICAgZGlzcC5hZGQoXG4gICAgICBlZGl0b3IuZ2V0QnVmZmVyKCkub25EaWRTdG9wQ2hhbmdpbmcoKCkgPT4ge1xuICAgICAgICBlbWl0KCdvbkRpZFN0b3BDaGFuZ2luZycsIHVuZGVmaW5lZClcbiAgICAgIH0pLFxuICAgICAgZWRpdG9yLm9uRGlkQ2hhbmdlUGF0aCgoKSA9PiB7XG4gICAgICAgIGVtaXQoJ29uRGlkQ2hhbmdlUGF0aCcsIHtcbiAgICAgICAgICBwYXRoOiBlZGl0b3IuZ2V0UGF0aCgpLFxuICAgICAgICAgIHRpdGxlOiBlZGl0b3IuZ2V0VGl0bGUoKSxcbiAgICAgICAgfSlcbiAgICAgIH0pLFxuICAgICAgZWRpdG9yLm9uRGlkQ2hhbmdlR3JhbW1hcigoZ3JhbW1hcikgPT4ge1xuICAgICAgICBlbWl0KCdvbkRpZENoYW5nZUdyYW1tYXInLCBncmFtbWFyLnNjb3BlTmFtZSlcbiAgICAgIH0pLFxuICAgICAgZWRpdG9yLm9uRGlkRGVzdHJveSgoKSA9PiB7XG4gICAgICAgIGVtaXQoJ29uRGlkRGVzdHJveScsIHVuZGVmaW5lZClcbiAgICAgIH0pLFxuICAgICAgZWRpdG9yLmdldEJ1ZmZlcigpLm9uRGlkU2F2ZSgoKSA9PiB7XG4gICAgICAgIGVtaXQoJ29uRGlkU2F2ZScsIHVuZGVmaW5lZClcbiAgICAgIH0pLFxuICAgICAgZWRpdG9yLmdldEJ1ZmZlcigpLm9uRGlkUmVsb2FkKCgpID0+IHtcbiAgICAgICAgZW1pdCgnb25EaWRSZWxvYWQnLCB1bmRlZmluZWQpXG4gICAgICB9KSxcbiAgICAgIGF0b20udmlld3MuZ2V0VmlldyhlZGl0b3IpLm9uRGlkQ2hhbmdlU2Nyb2xsVG9wKCgpID0+IHtcbiAgICAgICAgY29uc3QgW2ZpcnN0LCBsYXN0XSA9IGVkaXRvci5nZXRWaXNpYmxlUm93UmFuZ2UoKVxuICAgICAgICBjb25zdCBmaXJzdExpbmUgPSBlZGl0b3IuYnVmZmVyUm93Rm9yU2NyZWVuUm93KGZpcnN0KVxuICAgICAgICBjb25zdCBsYXN0TGluZSA9IGVkaXRvci5idWZmZXJSb3dGb3JTY3JlZW5Sb3cobGFzdClcbiAgICAgICAgZW1pdCgnb25EaWRDaGFuZ2VTY3JvbGxUb3AnLCBbZmlyc3RMaW5lLCBsYXN0TGluZV0pXG4gICAgICB9KSxcbiAgICAgIGF0b20uY29tbWFuZHMuYWRkKGF0b20udmlld3MuZ2V0VmlldyhlZGl0b3IpLCB7XG4gICAgICAgICdtYXJrZG93bi1wcmV2aWV3LXBsdXM6c3luYy1wcmV2aWV3JzogKCkgPT4ge1xuICAgICAgICAgIGVtaXQoJ3N5bmNQcmV2aWV3JywgdW5kZWZpbmVkKVxuICAgICAgICB9LFxuICAgICAgfSksXG4gICAgICBuZXcgRGlzcG9zYWJsZSgoKSA9PiB7XG4gICAgICAgIHJlbW90ZS5pcGNNYWluLnJlbW92ZUxpc3RlbmVyKFxuICAgICAgICAgICdtYXJrZG93bi1wcmV2aWV3LXBsdXMtZWRpdG9yLXJlcXVlc3QnLFxuICAgICAgICAgIHJlcXVlc3RIYW5kbGVyLFxuICAgICAgICApXG4gICAgICB9KSxcbiAgICApXG4gICAgcmV0dXJuIGRpc3BcbiAgfVxufVxuXG50eXBlIEFyZzxUIGV4dGVuZHMgKGFyZzogYW55KSA9PiBhbnk+ID0gVCBleHRlbmRzIChhcmc6IGluZmVyIFUpID0+IGFueVxuICA/IFVcbiAgOiBuZXZlclxuXG50eXBlIEV2ZW50Rm9yID0ge1xuICBbSyBpbiBrZXlvZiBJUENDbWRdOiB7XG4gICAgZWRpdG9ySWQ6IG51bWJlclxuICAgIHdpbmRvd0lkOiBudW1iZXJcbiAgICBmb3JXaW5kb3dJZDogbnVtYmVyXG4gICAgaWR4OiBudW1iZXJcbiAgICBjbWQ6IEtcbiAgICBhcmdzOiBBcmc8SVBDQ21kW0tdPlxuICB9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVBDQ21kIHtcbiAgZ2V0Q3Vyc29yQnVmZmVyUm93OiAoYXJnOiB2b2lkKSA9PiBudW1iZXJcbiAgc2Nyb2xsVG9CdWZmZXJSYW5nZTogKGFyZzogW251bWJlciwgbnVtYmVyXSkgPT4gdm9pZFxuICBzY3JvbGxUb0J1ZmZlclJvdzogKGFyZzogbnVtYmVyKSA9PiB2b2lkXG4gIGdldExhc3RCdWZmZXJSb3c6IChhcmc6IHZvaWQpID0+IG51bWJlclxuICBnZXRUZXh0OiAoYXJnOiB2b2lkKSA9PiBzdHJpbmdcbiAgZGVzdHJveTogKGFyZzogdm9pZCkgPT4gdm9pZFxuICBpbml0OiAoYXJnOiB2b2lkKSA9PiB2b2lkXG4gIG9wZW5Tb3VyY2U6IChhcmc/OiBudW1iZXIpID0+IHZvaWRcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJUENFdmVudHMge1xuICBzeW5jUHJldmlldzogdm9pZFxuICBvbkRpZENoYW5nZVNjcm9sbFRvcDogW251bWJlciwgbnVtYmVyXVxuICBvbkRpZFJlbG9hZDogdm9pZFxuICBvbkRpZFNhdmU6IHZvaWRcbiAgb25EaWRTdG9wQ2hhbmdpbmc6IHZvaWRcbiAgb25EaWREZXN0cm95OiB2b2lkXG4gIG9uRGlkQ2hhbmdlR3JhbW1hcjogc3RyaW5nXG4gIG9uRGlkQ2hhbmdlUGF0aDogeyB0aXRsZTogc3RyaW5nOyBwYXRoOiBzdHJpbmcgfCB1bmRlZmluZWQgfVxufVxuIl19