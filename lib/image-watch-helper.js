"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const fs = require("fs-plus");
const _ = require("lodash");
const path = require("path");
const cast_1 = require("./cast");
const pathWatcherPath = path.join(atom.packages.resourcePath, "/node_modules/pathwatcher/lib/main");
const pathWatcher = require(pathWatcherPath);
let imageRegister = {};
const refreshImages = _.debounce(function (src) {
    if (atom.workspace != null) {
        for (let item of atom.workspace.getPaneItems()) {
            if (cast_1.isMarkdownPreviewView(item)) {
                item.refreshImages(src);
            }
        }
    }
}, 250);
function srcClosure(src) {
    return function (event, _path) {
        if (event === "change" && fs.isFileSync(src)) {
            imageRegister[src].version = Date.now();
        }
        else {
            imageRegister[src].watcher.close();
            delete imageRegister[src];
        }
        refreshImages(src);
    };
}
function removeFile(file) {
    imageRegister = _.mapValues(imageRegister, function (image) {
        image.files = _.without(image.files, file);
        image.files = _.filter(image.files, fs.isFileSync);
        if (_.isEmpty(image.files)) {
            image.watched = false;
            image.watcher.close();
        }
        return image;
    });
}
exports.removeFile = removeFile;
function getVersion(image, file) {
    let version;
    const i = _.get(imageRegister, image, {});
    if (_.isEmpty(i)) {
        if (fs.isFileSync(image)) {
            version = Date.now();
            imageRegister[image] = {
                path: image,
                watched: true,
                files: [file],
                version,
                watcher: pathWatcher.watch(image, srcClosure(image))
            };
            return version;
        }
        else {
            return false;
        }
    }
    const files = _.get(i, "files");
    if (!_.includes(files, file)) {
        imageRegister[image].files.push(file);
    }
    version = _.get(i, "version");
    if (!version && fs.isFileSync(image)) {
        version = Date.now();
        imageRegister[image].version = version;
    }
    return version;
}
exports.getVersion = getVersion;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1hZ2Utd2F0Y2gtaGVscGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2ltYWdlLXdhdGNoLWhlbHBlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDhCQUE4QjtBQUM5Qiw0QkFBNEI7QUFDNUIsNkJBQTZCO0FBQzdCLGlDQUE4QztBQUM5QyxNQUFNLGVBQWUsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUMvQixJQUFJLENBQUMsUUFBUSxDQUFDLFlBQVksRUFDMUIsb0NBQW9DLENBQ3JDLENBQUE7QUFDRCxNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUE7QUFFNUMsSUFBSSxhQUFhLEdBQUcsRUFBRSxDQUFBO0FBRXRCLE1BQU0sYUFBYSxHQUFHLENBQUMsQ0FBQyxRQUFRLENBQUMsVUFBUyxHQUFHO0lBQzNDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQztRQUMzQixHQUFHLENBQUMsQ0FBQyxJQUFJLElBQUksSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksRUFBRSxDQUFDLENBQUMsQ0FBQztZQUMvQyxFQUFFLENBQUMsQ0FBQyw0QkFBcUIsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBRWhDLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLENBQUE7WUFDekIsQ0FBQztRQUNILENBQUM7SUFDSCxDQUFDO0FBQ0gsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFBO0FBRVAsb0JBQW9CLEdBQVc7SUFDN0IsTUFBTSxDQUFDLFVBQVMsS0FBYSxFQUFFLEtBQWE7UUFDMUMsRUFBRSxDQUFDLENBQUMsS0FBSyxLQUFLLFFBQVEsSUFBSSxFQUFFLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUM3QyxhQUFhLENBQUMsR0FBRyxDQUFDLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUs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aW1wb3J0IGZzID0gcmVxdWlyZShcImZzLXBsdXNcIilcbmltcG9ydCBfID0gcmVxdWlyZShcImxvZGFzaFwiKVxuaW1wb3J0IHBhdGggPSByZXF1aXJlKFwicGF0aFwiKVxuaW1wb3J0IHsgaXNNYXJrZG93blByZXZpZXdWaWV3IH0gZnJvbSBcIi4vY2FzdFwiXG5jb25zdCBwYXRoV2F0Y2hlclBhdGggPSBwYXRoLmpvaW4oXG4gIGF0b20ucGFja2FnZXMucmVzb3VyY2VQYXRoLFxuICBcIi9ub2RlX21vZHVsZXMvcGF0aHdhdGNoZXIvbGliL21haW5cIlxuKVxuY29uc3QgcGF0aFdhdGNoZXIgPSByZXF1aXJlKHBhdGhXYXRjaGVyUGF0aClcblxubGV0IGltYWdlUmVnaXN0ZXIgPSB7fVxuXG5jb25zdCByZWZyZXNoSW1hZ2VzID0gXy5kZWJvdW5jZShmdW5jdGlvbihzcmMpIHtcbiAgaWYgKGF0b20ud29ya3NwYWNlICE9IG51bGwpIHtcbiAgICBmb3IgKGxldCBpdGVtIG9mIGF0b20ud29ya3NwYWNlLmdldFBhbmVJdGVtcygpKSB7XG4gICAgICBpZiAoaXNNYXJrZG93blByZXZpZXdWaWV3KGl0ZW0pKSB7XG4gICAgICAgIC8vIFRPRE86IGNoZWNrIGFnYWluc3QgaW1hZ2VSZWdpc3RlcltzcmNdLnZlcnNpb24uZmlsZXNcbiAgICAgICAgaXRlbS5yZWZyZXNoSW1hZ2VzKHNyYylcbiAgICAgIH1cbiAgICB9XG4gIH1cbn0sIDI1MClcblxuZnVuY3Rpb24gc3JjQ2xvc3VyZShzcmM6IHN0cmluZykge1xuICByZXR1cm4gZnVuY3Rpb24oZXZlbnQ6IHN0cmluZywgX3BhdGg6IHN0cmluZykge1xuICAgIGlmIChldmVudCA9PT0gXCJjaGFuZ2VcIiAmJiBmcy5pc0ZpbGVTeW5jKHNyYykpIHtcbiAgICAgIGltYWdlUmVnaXN0ZXJbc3JjXS52ZXJzaW9uID0gRGF0ZS5ub3coKVxuICAgIH0gZWxzZSB7XG4gICAgICBpbWFnZVJlZ2lzdGVyW3NyY10ud2F0Y2hlci5jbG9zZSgpXG4gICAgICBkZWxldGUgaW1hZ2VSZWdpc3RlcltzcmNdXG4gICAgfVxuICAgIHJlZnJlc2hJbWFnZXMoc3JjKVxuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZW1vdmVGaWxlKGZpbGU6IHN0cmluZykge1xuICBpbWFnZVJlZ2lzdGVyID0gXy5tYXBWYWx1ZXMoaW1hZ2VSZWdpc3RlciwgZnVuY3Rpb24oaW1hZ2UpIHtcbiAgICBpbWFnZS5maWxlcyA9IF8ud2l0aG91dChpbWFnZS5maWxlcywgZmlsZSlcbiAgICBpbWFnZS5maWxlcyA9IF8uZmlsdGVyKGltYWdlLmZpbGVzLCBmcy5pc0ZpbGVTeW5jKVxuICAgIGlmIChfLmlzRW1wdHkoaW1hZ2UuZmlsZXMpKSB7XG4gICAgICBpbWFnZS53YXRjaGVkID0gZmFsc2VcbiAgICAgIGltYWdlLndhdGNoZXIuY2xvc2UoKVxuICAgIH1cbiAgICByZXR1cm4gaW1hZ2VcbiAgfSlcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFZlcnNpb24oaW1hZ2U6IHN0cmluZywgZmlsZTogc3RyaW5nKSB7XG4gIGxldCB2ZXJzaW9uXG4gIGNvbnN0IGkgPSBfLmdldChpbWFnZVJlZ2lzdGVyLCBpbWFnZSwge30pXG4gIGlmIChfLmlzRW1wdHkoaSkpIHtcbiAgICBpZiAoZnMuaXNGaWxlU3luYyhpbWFnZSkpIHtcbiAgICAgIHZlcnNpb24gPSBEYXRlLm5vdygpXG4gICAgICBpbWFnZVJlZ2lzdGVyW2ltYWdlXSA9IHtcbiAgICAgICAgcGF0aDogaW1hZ2UsXG4gICAgICAgIHdhdGNoZWQ6IHRydWUsXG4gICAgICAgIGZpbGVzOiBbZmlsZV0sXG4gICAgICAgIHZlcnNpb24sXG4gICAgICAgIHdhdGNoZXI6IHBhdGhXYXRjaGVyLndhdGNoKGltYWdlLCBzcmNDbG9zdXJlKGltYWdlKSlcbiAgICAgIH1cbiAgICAgIHJldHVybiB2ZXJzaW9uXG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBmYWxzZVxuICAgIH1cbiAgfVxuXG4gIGNvbnN0IGZpbGVzID0gXy5nZXQoaSwgXCJmaWxlc1wiKVxuICBpZiAoIV8uaW5jbHVkZXMoZmlsZXMsIGZpbGUpKSB7XG4gICAgaW1hZ2VSZWdpc3RlcltpbWFnZV0uZmlsZXMucHVzaChmaWxlKVxuICB9XG5cbiAgdmVyc2lvbiA9IF8uZ2V0KGksIFwidmVyc2lvblwiKVxuICBpZiAoIXZlcnNpb24gJiYgZnMuaXNGaWxlU3luYyhpbWFnZSkpIHtcbiAgICB2ZXJzaW9uID0gRGF0ZS5ub3coKVxuICAgIGltYWdlUmVnaXN0ZXJbaW1hZ2VdLnZlcnNpb24gPSB2ZXJzaW9uXG4gIH1cbiAgcmV0dXJuIHZlcnNpb25cbn1cbiJdfQ==