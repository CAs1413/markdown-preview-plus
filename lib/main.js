"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const url = require("url");
const fs = require("fs-plus");
const markdown_preview_view_1 = require("./markdown-preview-view");
const renderer = require("./renderer");
const mathjaxHelper = require("./mathjax-helper");
const cast_1 = require("./cast");
var config_1 = require("./config");
exports.config = config_1.config;
function activate() {
    atom.commands.add("atom-workspace", {
        "markdown-preview-plus:toggle": toggle,
        "markdown-preview-plus:copy-html": () => copyHtml(),
        "markdown-preview-plus:toggle-break-on-single-newline"() {
            const keyPath = "markdown-preview-plus.breakOnSingleNewline";
            return atom.config.set(keyPath, !atom.config.get(keyPath));
        }
    });
    atom.commands.add(".tree-view .file .name[data-name$=\\.markdown]", "markdown-preview-plus:preview-file", previewFile);
    atom.commands.add(".tree-view .file .name[data-name$=\\.md]", "markdown-preview-plus:preview-file", previewFile);
    atom.commands.add(".tree-view .file .name[data-name$=\\.mdown]", "markdown-preview-plus:preview-file", previewFile);
    atom.commands.add(".tree-view .file .name[data-name$=\\.mkd]", "markdown-preview-plus:preview-file", previewFile);
    atom.commands.add(".tree-view .file .name[data-name$=\\.mkdown]", "markdown-preview-plus:preview-file", previewFile);
    atom.commands.add(".tree-view .file .name[data-name$=\\.ron]", "markdown-preview-plus:preview-file", previewFile);
    atom.commands.add(".tree-view .file .name[data-name$=\\.txt]", "markdown-preview-plus:preview-file", previewFile);
    return atom.workspace.addOpener(uriToOpen => {
        let host, pathname, protocol;
        try {
            ;
            ({ protocol, host, pathname } = url.parse(uriToOpen));
        }
        catch (e) {
            console.error(e);
            return;
        }
        if (protocol !== "markdown-preview-plus:") {
            return;
        }
        try {
            if (pathname) {
                pathname = decodeURI(pathname);
            }
        }
        catch (e) {
            console.error(e);
            return;
        }
        if (host === "editor") {
            return createMarkdownPreviewView({
                editorId: parseInt(pathname.substring(1), 10)
            });
        }
        else {
            return createMarkdownPreviewView({ filePath: pathname });
        }
    });
}
exports.activate = activate;
function createMarkdownPreviewView(state) {
    if (state.editorId || fs.isFileSync(state.filePath)) {
        return new markdown_preview_view_1.MarkdownPreviewView(state);
    }
    return undefined;
}
exports.createMarkdownPreviewView = createMarkdownPreviewView;
function toggle() {
    let needle;
    if (cast_1.isMarkdownPreviewView(atom.workspace.getActivePaneItem())) {
        atom.workspace.destroyActivePaneItem();
        return;
    }
    const editor = atom.workspace.getActiveTextEditor();
    if (editor == null) {
        return;
    }
    const grammars = atom.config.get("markdown-preview-plus.grammars") || [];
    if (((needle = editor.getGrammar().scopeName), !grammars.includes(needle))) {
        return;
    }
    if (!removePreviewForEditor(editor)) {
        addPreviewForEditor(editor);
    }
}
exports.toggle = toggle;
function uriForEditor(editor) {
    return `markdown-preview-plus://editor/${editor.id}`;
}
exports.uriForEditor = uriForEditor;
function removePreviewForEditor(editor) {
    const uri = uriForEditor(editor);
    const previewPane = atom.workspace.paneForURI(uri);
    if (previewPane != null) {
        const preview = previewPane.itemForURI(uri);
        if (preview === undefined)
            return false;
        if (preview !== previewPane.getActiveItem()) {
            previewPane.activateItem(preview);
            return false;
        }
        previewPane.destroyItem(preview);
        return true;
    }
    else {
        return false;
    }
}
exports.removePreviewForEditor = removePreviewForEditor;
function addPreviewForEditor(editor) {
    const uri = uriForEditor(editor);
    const previousActivePane = atom.workspace.getActivePane();
    const options = { searchAllPanes: true };
    if (atom.config.get("markdown-preview-plus.openPreviewInSplitPane")) {
        options.split = atom.config.get("markdown-preview-plus.previewSplitPaneDir");
    }
    return atom.workspace.open(uri, options).then(function (markdownPreviewView) {
        if (cast_1.isMarkdownPreviewView(markdownPreviewView)) {
            return previousActivePane.activate();
        }
    });
}
exports.addPreviewForEditor = addPreviewForEditor;
function previewFile({ currentTarget }) {
    const filePath = currentTarget.dataset.path;
    if (!filePath) {
        return;
    }
    for (let editor of atom.workspace.getTextEditors()) {
        if (editor.getPath() === filePath) {
            addPreviewForEditor(editor);
            return;
        }
    }
    return atom.workspace.open(`markdown-preview-plus://${encodeURI(filePath)}`, {
        searchAllPanes: true
    });
}
exports.previewFile = previewFile;
const clipboardCopy = (text) => atom.clipboard.write(text);
function copyHtml(callback = clipboardCopy, scaleMath = 100) {
    const editor = atom.workspace.getActiveTextEditor();
    if (editor == null) {
        return;
    }
    const text = editor.getSelectedText() || editor.getText();
    const renderLaTeX = atom.config.get("markdown-preview-plus.enableLatexRenderingByDefault");
    return renderer.toHTML(text, editor.getPath(), editor.getGrammar(), renderLaTeX, true, function (error, html) {
        if (error) {
            return console.warn("Copying Markdown as HTML failed", error);
        }
        else if (renderLaTeX) {
            return mathjaxHelper.processHTMLString(html, function (proHTML) {
                proHTML = proHTML.replace(/MathJax\_SVG.*?font\-size\: 100%/g, match => match.replace(/font\-size\: 100%/, `font-size: ${scaleMath}%`));
                return callback(proHTML);
            });
        }
        else {
            return callback(html);
        }
    });
}
exports.copyHtml = copyHtml;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9tYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBTUEsTUFBTSxHQUFHLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFBO0FBQzFCLE1BQU0sRUFBRSxHQUFHLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQTtBQUU3QixtRUFBd0U7QUFDeEUsdUNBQXVDO0FBQ3ZDLGtEQUFrRDtBQUNsRCxpQ0FBOEM7QUFLOUMsbUNBQWlDO0FBQXhCLDBCQUFBLE1BQU0sQ0FBQTtBQUVmO0lBQ0UsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLEVBQUU7UUFDbEMsOEJBQThCLEVBQUUsTUFBTTtRQUN0QyxpQ0FBaUMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxRQUFRLEVBQUU7UUFDbkQsc0RBQXNEO1lBQ3BELE1BQU0sT0FBTyxHQUFHLDRDQUE0QyxDQUFBO1lBQzVELE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFBO1FBQzVELENBQUM7S0FDRixDQUFDLENBQUE7SUFFRixJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FDZixnREFBZ0QsRUFDaEQsb0NBQW9DLEVBQ3BDLFdBQVcsQ0FDWixDQUFBO0lBQ0QsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQ2YsMENBQTBDLEVBQzFDLG9DQUFvQyxFQUNwQyxXQUFXLENBQ1osQ0FBQTtJQUNELElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUNmLDZDQUE2QyxFQUM3QyxvQ0FBb0MsRUFDcEMsV0FBVyxDQUNaLENBQUE7SUFDRCxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FDZiwyQ0FBMkMsRUFDM0Msb0NBQW9DLEVBQ3BDLFdBQVcsQ0FDWixDQUFBO0lBQ0QsSUFBSSxDQUFDLFFB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QUFJLENBQUMsRUFBRSxDQUFDLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQztZQUN2QixNQUFNLENBQUMsYUFBYSxDQUFDLGlCQUFpQixDQUFDLElBQUksRUFBRSxVQUFTLE9BQWU7Z0JBQ25FLE9BQU8sR0FBRyxPQUFPLENBQUMsT0FBTyxDQUN2QixtQ0FBbUMsRUFDbkMsS0FBSyxDQUFDLEVBQUUsQ0FDTixLQUFLLENBQUMsT0FBTyxDQUFDLG1CQUFtQixFQUFFLGNBQWMsU0FBUyxHQUFHLENBQUMsQ0FDakUsQ0FBQTtnQkFDRCxNQUFNLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1lBQzFCLENBQUMsQ0FBQyxDQUFBO1FBQ0osQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ04sTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUN2QixDQUFDO0lBQ0gsQ0FBQyxDQUNGLENBQUE7QUFDSCxDQUFDO0FBcENELDRCQW9DQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBkZWNhZmZlaW5hdGUgc3VnZ2VzdGlvbnM6XG4gKiBEUzEwMjogUmVtb3ZlIHVubmVjZXNzYXJ5IGNvZGUgY3JlYXRlZCBiZWNhdXNlIG9mIGltcGxpY2l0IHJldHVybnNcbiAqIERTMTA0OiBBdm9pZCBpbmxpbmUgYXNzaWdubWVudHNcbiAqIEZ1bGwgZG9jczogaHR0cHM6Ly9naXRodWIuY29tL2RlY2FmZmVpbmF0ZS9kZWNhZmZlaW5hdGUvYmxvYi9tYXN0ZXIvZG9jcy9zdWdnZXN0aW9ucy5tZFxuICovXG5jb25zdCB1cmwgPSByZXF1aXJlKFwidXJsXCIpXG5jb25zdCBmcyA9IHJlcXVpcmUoXCJmcy1wbHVzXCIpXG5cbmltcG9ydCB7IE1hcmtkb3duUHJldmlld1ZpZXcsIE1QVlBhcmFtcyB9IGZyb20gXCIuL21hcmtkb3duLXByZXZpZXctdmlld1wiXG5pbXBvcnQgcmVuZGVyZXIgPSByZXF1aXJlKFwiLi9yZW5kZXJlclwiKVxuaW1wb3J0IG1hdGhqYXhIZWxwZXIgPSByZXF1aXJlKFwiLi9tYXRoamF4LWhlbHBlclwiKVxuaW1wb3J0IHsgaXNNYXJrZG93blByZXZpZXdWaWV3IH0gZnJvbSBcIi4vY2FzdFwiXG5pbXBvcnQgeyBUZXh0RWRpdG9yIH0gZnJvbSBcImF0b21cIlxuaW1wb3J0IHsgV29ya3NwYWNlT3Blbk9wdGlvbnMgfSBmcm9tIFwiYXRvbVwiXG5pbXBvcnQgeyBDb21tYW5kRXZlbnQgfSBmcm9tIFwiYXRvbVwiXG5cbmV4cG9ydCB7IGNvbmZpZyB9IGZyb20gXCIuL2NvbmZpZ1wiXG5cbmV4cG9ydCBmdW5jdGlvbiBhY3RpdmF0ZSgpIHtcbiAgYXRvbS5jb21tYW5kcy5hZGQoXCJhdG9tLXdvcmtzcGFjZVwiLCB7XG4gICAgXCJtYXJrZG93bi1wcmV2aWV3LXBsdXM6dG9nZ2xlXCI6IHRvZ2dsZSxcbiAgICBcIm1hcmtkb3duLXByZXZpZXctcGx1czpjb3B5LWh0bWxcIjogKCkgPT4gY29weUh0bWwoKSxcbiAgICBcIm1hcmtkb3duLXByZXZpZXctcGx1czp0b2dnbGUtYnJlYWstb24tc2luZ2xlLW5ld2xpbmVcIigpIHtcbiAgICAgIGNvbnN0IGtleVBhdGggPSBcIm1hcmtkb3duLXByZXZpZXctcGx1cy5icmVha09uU2luZ2xlTmV3bGluZVwiXG4gICAgICByZXR1cm4gYXRvbS5jb25maWcuc2V0KGtleVBhdGgsICFhdG9tLmNvbmZpZy5nZXQoa2V5UGF0aCkpXG4gICAgfVxuICB9KVxuXG4gIGF0b20uY29tbWFuZHMuYWRkKFxuICAgIFwiLnRyZWUtdmlldyAuZmlsZSAubmFtZVtkYXRhLW5hbWUkPVxcXFwubWFya2Rvd25dXCIsXG4gICAgXCJtYXJrZG93bi1wcmV2aWV3LXBsdXM6cHJldmlldy1maWxlXCIsXG4gICAgcHJldmlld0ZpbGVcbiAgKVxuICBhdG9tLmNvbW1hbmRzLmFkZChcbiAgICBcIi50cmVlLXZpZXcgLmZpbGUgLm5hbWVbZGF0YS1uYW1lJD1cXFxcLm1kXVwiLFxuICAgIFwibWFya2Rvd24tcHJldmlldy1wbHVzOnByZXZpZXctZmlsZVwiLFxuICAgIHByZXZpZXdGaWxlXG4gIClcbiAgYXRvbS5jb21tYW5kcy5hZGQoXG4gICAgXCIudHJlZS12aWV3IC5maWxlIC5uYW1lW2RhdGEtbmFtZSQ9XFxcXC5tZG93bl1cIixcbiAgICBcIm1hcmtkb3duLXByZXZpZXctcGx1czpwcmV2aWV3LWZpbGVcIixcbiAgICBwcmV2aWV3RmlsZVxuICApXG4gIGF0b20uY29tbWFuZHMuYWRkKFxuICAgIFwiLnRyZWUtdmlldyAuZmlsZSAubmFtZVtkYXRhLW5hbWUkPVxcXFwubWtkXVwiLFxuICAgIFwibWFya2Rvd24tcHJldmlldy1wbHVzOnByZXZpZXctZmlsZVwiLFxuICAgIHByZXZpZXdGaWxlXG4gIClcbiAgYXRvbS5jb21tYW5kcy5hZGQoXG4gICAgXCIudHJlZS12aWV3IC5maWxlIC5uYW1lW2RhdGEtbmFtZSQ9XFxcXC5ta2Rvd25dXCIsXG4gICAgXCJtYXJrZG93bi1wcmV2aWV3LXBsdXM6cHJldmlldy1maWxlXCIsXG4gICAgcHJldmlld0ZpbGVcbiAgKVxuICBhdG9tLmNvbW1hbmRzLmFkZChcbiAgICBcIi50cmVlLXZpZXcgLmZpbGUgLm5hbWVbZGF0YS1uYW1lJD1cXFxcLnJvbl1cIixcbiAgICBcIm1hcmtkb3duLXByZXZpZXctcGx1czpwcmV2aWV3LWZpbGVcIixcbiAgICBwcmV2aWV3RmlsZVxuICApXG4gIGF0b20uY29tbWFuZHMuYWRkKFxuICAgIFwiLnRyZWUtdmlldyAuZmlsZSAubmFtZVtkYXRhLW5hbWUkPVxcXFwudHh0XVwiLFxuICAgIFwibWFya2Rvd24tcHJldmlldy1wbHVzOnByZXZpZXctZmlsZVwiLFxuICAgIHByZXZpZXdGaWxlXG4gIClcblxuICByZXR1cm4gYXRvbS53b3Jrc3BhY2UuYWRkT3BlbmVyKHVyaVRvT3BlbiA9PiB7XG4gICAgbGV0IGhvc3QsIHBhdGhuYW1lLCBwcm90b2NvbFxuICAgIHRyeSB7XG4gICAgICA7KHsgcHJvdG9jb2wsIGhvc3QsIHBhdGhuYW1lIH0gPSB1cmwucGFyc2UodXJpVG9PcGVuKSlcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBjb25zb2xlLmVycm9yKGUpXG4gICAgICByZXR1cm5cbiAgICB9XG5cbiAgICBpZiAocHJvdG9jb2wgIT09IFwibWFya2Rvd24tcHJldmlldy1wbHVzOlwiKSB7XG4gICAgICByZXR1cm5cbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgaWYgKHBhdGhuYW1lKSB7XG4gICAgICAgIHBhdGhuYW1lID0gZGVjb2RlVVJJKHBhdGhuYW1lKVxuICAgICAgfVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoZSlcbiAgICAgIHJldHVyblxuICAgIH1cblxuICAgIGlmIChob3N0ID09PSBcImVkaXRvclwiKSB7XG4gICAgICByZXR1cm4gY3JlYXRlTWFya2Rvd25QcmV2aWV3Vmlldyh7XG4gICAgICAgIGVkaXRvcklkOiBwYXJzZUludChwYXRobmFtZS5zdWJzdHJpbmcoMSksIDEwKVxuICAgICAgfSlcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIGNyZWF0ZU1hcmtkb3duUHJldmlld1ZpZXcoeyBmaWxlUGF0aDogcGF0aG5hbWUgfSlcbiAgICB9XG4gIH0pXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVNYXJrZG93blByZXZpZXdWaWV3KHN0YXRlOiBNUFZQYXJhbXMpIHtcbiAgaWYgKHN0YXRlLmVkaXRvcklkIHx8IGZzLmlzRmlsZVN5bmMoc3RhdGUuZmlsZVBhdGgpKSB7XG4gICAgcmV0dXJuIG5ldyBNYXJrZG93blByZXZpZXdWaWV3KHN0YXRlKVxuICB9XG4gIHJldHVybiB1bmRlZmluZWRcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHRvZ2dsZSgpIHtcbiAgbGV0IG5lZWRsZVxuICBpZiAoaXNNYXJrZG93blByZXZpZXdWaWV3KGF0b20ud29ya3NwYWNlLmdldEFjdGl2ZVBhbmVJdGVtKCkpKSB7XG4gICAgYXRvbS53b3Jrc3BhY2UuZGVzdHJveUFjdGl2ZVBhbmVJdGVtKClcbiAgICByZXR1cm5cbiAgfVxuXG4gIGNvbnN0IGVkaXRvciA9IGF0b20ud29ya3NwYWNlLmdldEFjdGl2ZVRleHRFZGl0b3IoKVxuICBpZiAoZWRpdG9yID09IG51bGwpIHtcbiAgICByZXR1cm5cbiAgfVxuXG4gIGNvbnN0IGdyYW1tYXJzID0gYXRvbS5jb25maWcuZ2V0KFwibWFya2Rvd24tcHJldmlldy1wbHVzLmdyYW1tYXJzXCIpIHx8IFtdXG4gIGlmICgoKG5lZWRsZSA9IGVkaXRvci5nZXRHcmFtbWFyKCkuc2NvcGVOYW1lKSwgIWdyYW1tYXJzLmluY2x1ZGVzKG5lZWRsZSkpKSB7XG4gICAgcmV0dXJuXG4gIH1cblxuICBpZiAoIXJlbW92ZVByZXZpZXdGb3JFZGl0b3IoZWRpdG9yKSkge1xuICAgIGFkZFByZXZpZXdGb3JFZGl0b3IoZWRpdG9yKVxuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB1cmlGb3JFZGl0b3IoZWRpdG9yOiBUZXh0RWRpdG9yKSB7XG4gIHJldHVybiBgbWFya2Rvd24tcHJldmlldy1wbHVzOi8vZWRpdG9yLyR7ZWRpdG9yLmlkfWBcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlbW92ZVByZXZpZXdGb3JFZGl0b3IoZWRpdG9yOiBUZXh0RWRpdG9yKSB7XG4gIGNvbnN0IHVyaSA9IHVyaUZvckVkaXRvcihlZGl0b3IpXG4gIGNvbnN0IHByZXZpZXdQYW5lID0gYXRvbS53b3Jrc3BhY2UucGFuZUZvclVSSSh1cmkpXG4gIGlmIChwcmV2aWV3UGFuZSAhPSBudWxsKSB7XG4gICAgY29uc3QgcHJldmlldyA9IHByZXZpZXdQYW5lLml0ZW1Gb3JVUkkodXJpKVxuICAgIGlmIChwcmV2aWV3ID09PSB1bmRlZmluZWQpIHJldHVybiBmYWxzZVxuICAgIGlmIChwcmV2aWV3ICE9PSBwcmV2aWV3UGFuZS5nZXRBY3RpdmVJdGVtKCkpIHtcbiAgICAgIHByZXZpZXdQYW5lLmFjdGl2YXRlSXRlbShwcmV2aWV3KVxuICAgICAgcmV0dXJuIGZhbHNlXG4gICAgfVxuICAgIHByZXZpZXdQYW5lLmRlc3Ryb3lJdGVtKHByZXZpZXcpXG4gICAgcmV0dXJuIHRydWVcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gZmFsc2VcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gYWRkUHJldmlld0ZvckVkaXRvcihlZGl0b3I6IFRleHRFZGl0b3IpIHtcbiAgY29uc3QgdXJpID0gdXJpRm9yRWRpdG9yKGVkaXRvcilcbiAgY29uc3QgcHJldmlvdXNBY3RpdmVQYW5lID0gYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlUGFuZSgpXG4gIGNvbnN0IG9wdGlvbnM6IFdvcmtzcGFjZU9wZW5PcHRpb25zID0geyBzZWFyY2hBbGxQYW5lczogdHJ1ZSB9XG4gIGlmIChhdG9tLmNvbmZpZy5nZXQoXCJtYXJrZG93bi1wcmV2aWV3LXBsdXMub3BlblByZXZpZXdJblNwbGl0UGFuZVwiKSkge1xuICAgIG9wdGlvbnMuc3BsaXQgPSBhdG9tLmNvbmZpZy5nZXQoXCJtYXJrZG93bi1wcmV2aWV3LXBsdXMucHJldmlld1NwbGl0UGFuZURpclwiKVxuICB9XG4gIHJldHVybiBhdG9tLndvcmtzcGFjZS5vcGVuKHVyaSwgb3B0aW9ucykudGhlbihmdW5jdGlvbihtYXJrZG93blByZXZpZXdWaWV3KSB7XG4gICAgaWYgKGlzTWFya2Rvd25QcmV2aWV3VmlldyhtYXJrZG93blByZXZpZXdWaWV3KSkge1xuICAgICAgcmV0dXJuIHByZXZpb3VzQWN0aXZlUGFuZS5hY3RpdmF0ZSgpXG4gICAgfVxuICB9KVxufVxuXG5leHBvcnQgZnVuY3Rpb24gcHJldmlld0ZpbGUoeyBjdXJyZW50VGFyZ2V0IH06IENvbW1hbmRFdmVudCkge1xuICBjb25zdCBmaWxlUGF0aCA9IGN1cnJlbnRUYXJnZXQuZGF0YXNldC5wYXRoXG4gIGlmICghZmlsZVBhdGgpIHtcbiAgICByZXR1cm5cbiAgfVxuXG4gIGZvciAobGV0IGVkaXRvciBvZiBhdG9tLndvcmtzcGFjZS5nZXRUZXh0RWRpdG9ycygpKSB7XG4gICAgaWYgKGVkaXRvci5nZXRQYXRoKCkgPT09IGZpbGVQYXRoKSB7XG4gICAgICBhZGRQcmV2aWV3Rm9yRWRpdG9yKGVkaXRvcilcbiAgICAgIHJldHVyblxuICAgIH1cbiAgfVxuXG4gIHJldHVybiBhdG9tLndvcmtzcGFjZS5vcGVuKGBtYXJrZG93bi1wcmV2aWV3LXBsdXM6Ly8ke2VuY29kZVVSSShmaWxlUGF0aCl9YCwge1xuICAgIHNlYXJjaEFsbFBhbmVzOiB0cnVlXG4gIH0pXG59XG5cbmNvbnN0IGNsaXBib2FyZENvcHkgPSAodGV4dDogc3RyaW5nKSA9PiBhdG9tLmNsaXBib2FyZC53cml0ZSh0ZXh0KVxuXG5leHBvcnQgZnVuY3Rpb24gY29weUh0bWwoY2FsbGJhY2s/OiB1bmRlZmluZWQsIHNjYWxlTWF0aD86IG51bWJlcik6IHZvaWRcbmV4cG9ydCBmdW5jdGlvbiBjb3B5SHRtbDxUPihcbiAgY2FsbGJhY2s/OiAodGV4dDogc3RyaW5nKSA9PiBULFxuICBzY2FsZU1hdGg/OiBudW1iZXJcbik6IFRcbmV4cG9ydCBmdW5jdGlvbiBjb3B5SHRtbChcbiAgY2FsbGJhY2s6ICh0ZXh0OiBzdHJpbmcpID0+IGFueSA9IGNsaXBib2FyZENvcHksXG4gIHNjYWxlTWF0aCA9IDEwMFxuKTogYW55IHtcbiAgY29uc3QgZWRpdG9yID0gYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlVGV4dEVkaXRvcigpXG4gIGlmIChlZGl0b3IgPT0gbnVsbCkge1xuICAgIHJldHVyblxuICB9XG5cbiAgY29uc3QgdGV4dCA9IGVkaXRvci5nZXRTZWxlY3RlZFRleHQoKSB8fCBlZGl0b3IuZ2V0VGV4dCgpXG4gIGNvbnN0IHJlbmRlckxhVGVYID0gYXRvbS5jb25maWcuZ2V0KFxuICAgIFwibWFya2Rvd24tcHJldmlldy1wbHVzLmVuYWJsZUxhdGV4UmVuZGVyaW5nQnlEZWZhdWx0XCJcbiAgKVxuICByZXR1cm4gcmVuZGVyZXIudG9IVE1MKFxuICAgIHRleHQsXG4gICAgZWRpdG9yLmdldFBhdGgoKSxcbiAgICBlZGl0b3IuZ2V0R3JhbW1hcigpLFxuICAgIHJlbmRlckxhVGVYLFxuICAgIHRydWUsXG4gICAgZnVuY3Rpb24oZXJyb3I6IEVycm9yLCBodG1sOiBzdHJpbmcpIHtcbiAgICAgIGlmIChlcnJvcikge1xuICAgICAgICByZXR1cm4gY29uc29sZS53YXJuKFwiQ29weWluZyBNYXJrZG93biBhcyBIVE1MIGZhaWxlZFwiLCBlcnJvcilcbiAgICAgIH0gZWxzZSBpZiAocmVuZGVyTGFUZVgpIHtcbiAgICAgICAgcmV0dXJuIG1hdGhqYXhIZWxwZXIucHJvY2Vzc0hUTUxTdHJpbmcoaHRtbCwgZnVuY3Rpb24ocHJvSFRNTDogc3RyaW5nKSB7XG4gICAgICAgICAgcHJvSFRNTCA9IHByb0hUTUwucmVwbGFjZShcbiAgICAgICAgICAgIC9NYXRoSmF4XFxfU1ZHLio/Zm9udFxcLXNpemVcXDogMTAwJS9nLFxuICAgICAgICAgICAgbWF0Y2ggPT5cbiAgICAgICAgICAgICAgbWF0Y2gucmVwbGFjZSgvZm9udFxcLXNpemVcXDogMTAwJS8sIGBmb250LXNpemU6ICR7c2NhbGVNYXRofSVgKVxuICAgICAgICAgIClcbiAgICAgICAgICByZXR1cm4gY2FsbGJhY2socHJvSFRNTClcbiAgICAgICAgfSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBjYWxsYmFjayhodG1sKVxuICAgICAgfVxuICAgIH1cbiAgKVxufVxuIl19