"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const url = require("url");
const fs = require("fs-plus");
const markdown_preview_view_1 = require("./markdown-preview-view");
const renderer = require("./renderer");
const mathjaxHelper = require("./mathjax-helper");
const cast_1 = require("./cast");
var config_1 = require("./config");
exports.config = config_1.config;
function activate() {
    atom.commands.add('atom-workspace', {
        'markdown-preview-plus:toggle': toggle,
        'markdown-preview-plus:copy-html': () => copyHtml(),
        'markdown-preview-plus:toggle-break-on-single-newline'() {
            const keyPath = 'markdown-preview-plus.breakOnSingleNewline';
            return atom.config.set(keyPath, !atom.config.get(keyPath));
        },
    });
    atom.commands.add('.tree-view .file .name[data-name$=\\.markdown]', 'markdown-preview-plus:preview-file', previewFile);
    atom.commands.add('.tree-view .file .name[data-name$=\\.md]', 'markdown-preview-plus:preview-file', previewFile);
    atom.commands.add('.tree-view .file .name[data-name$=\\.mdown]', 'markdown-preview-plus:preview-file', previewFile);
    atom.commands.add('.tree-view .file .name[data-name$=\\.mkd]', 'markdown-preview-plus:preview-file', previewFile);
    atom.commands.add('.tree-view .file .name[data-name$=\\.mkdown]', 'markdown-preview-plus:preview-file', previewFile);
    atom.commands.add('.tree-view .file .name[data-name$=\\.ron]', 'markdown-preview-plus:preview-file', previewFile);
    atom.commands.add('.tree-view .file .name[data-name$=\\.txt]', 'markdown-preview-plus:preview-file', previewFile);
    return atom.workspace.addOpener((uriToOpen) => {
        try {
            var { protocol, host, pathname } = url.parse(uriToOpen);
        }
        catch (e) {
            console.error(e);
            return;
        }
        if (protocol !== 'markdown-preview-plus:')
            return;
        if (!pathname)
            return;
        try {
            if (pathname) {
                pathname = decodeURI(pathname);
            }
        }
        catch (e) {
            console.error(e);
            return;
        }
        if (host === 'editor') {
            return createMarkdownPreviewView({
                editorId: parseInt(pathname.substring(1), 10),
            });
        }
        else {
            return createMarkdownPreviewView({ filePath: pathname });
        }
    });
}
exports.activate = activate;
function createMarkdownPreviewView(state) {
    if (state.editorId || (state.filePath && fs.isFileSync(state.filePath))) {
        return new markdown_preview_view_1.MarkdownPreviewView(state);
    }
    return undefined;
}
exports.createMarkdownPreviewView = createMarkdownPreviewView;
function toggle() {
    let needle;
    if (cast_1.isMarkdownPreviewView(atom.workspace.getActivePaneItem())) {
        atom.workspace.destroyActivePaneItem();
        return;
    }
    const editor = atom.workspace.getActiveTextEditor();
    if (editor == null) {
        return;
    }
    const grammars = atom.config.get('markdown-preview-plus.grammars') || [];
    if (((needle = editor.getGrammar().scopeName), !grammars.includes(needle))) {
        return;
    }
    if (!removePreviewForEditor(editor)) {
        addPreviewForEditor(editor);
    }
}
exports.toggle = toggle;
function uriForEditor(editor) {
    return `markdown-preview-plus://editor/${editor.id}`;
}
exports.uriForEditor = uriForEditor;
function removePreviewForEditor(editor) {
    const uri = uriForEditor(editor);
    const previewPane = atom.workspace.paneForURI(uri);
    if (previewPane != null) {
        const preview = previewPane.itemForURI(uri);
        if (preview === undefined)
            return false;
        if (preview !== previewPane.getActiveItem()) {
            previewPane.activateItem(preview);
            return false;
        }
        previewPane.destroyItem(preview);
        return true;
    }
    else {
        return false;
    }
}
exports.removePreviewForEditor = removePreviewForEditor;
function addPreviewForEditor(editor) {
    const uri = uriForEditor(editor);
    const previousActivePane = atom.workspace.getActivePane();
    const options = { searchAllPanes: true };
    if (atom.config.get('markdown-preview-plus.openPreviewInSplitPane')) {
        options.split = atom.config.get('markdown-preview-plus.previewSplitPaneDir');
    }
    return atom.workspace.open(uri, options).then(function (markdownPreviewView) {
        if (cast_1.isMarkdownPreviewView(markdownPreviewView)) {
            return previousActivePane.activate();
        }
    });
}
exports.addPreviewForEditor = addPreviewForEditor;
function previewFile({ currentTarget }) {
    const filePath = currentTarget.dataset.path;
    if (!filePath) {
        return;
    }
    for (let editor of atom.workspace.getTextEditors()) {
        if (editor.getPath() === filePath) {
            addPreviewForEditor(editor);
            return;
        }
    }
    return atom.workspace.open(`markdown-preview-plus://${encodeURI(filePath)}`, {
        searchAllPanes: true,
    });
}
exports.previewFile = previewFile;
const clipboardCopy = (text) => atom.clipboard.write(text);
function copyHtml(callback = clipboardCopy, scaleMath = 100) {
    const editor = atom.workspace.getActiveTextEditor();
    if (editor == null) {
        return;
    }
    const text = editor.getSelectedText() || editor.getText();
    const renderLaTeX = atom.config.get('markdown-preview-plus.enableLatexRenderingByDefault');
    renderer.toHTML(text, editor.getPath(), editor.getGrammar(), !!renderLaTeX, true, function (error, html) {
        if (error) {
            console.warn('Copying Markdown as HTML failed', error);
        }
        else if (renderLaTeX) {
            mathjaxHelper.processHTMLString(html, function (proHTML) {
                proHTML = proHTML.replace(/MathJax\_SVG.*?font\-size\: 100%/g, (match) => match.replace(/font\-size\: 100%/, `font-size: ${scaleMath}%`));
                callback(proHTML);
            });
        }
        else {
            callback(html);
        }
    });
}
exports.copyHtml = copyHtml;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9tYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBTUEsMkJBQTJCO0FBQzNCLDhCQUE4QjtBQUU5QixtRUFBd0U7QUFDeEUsdUNBQXVDO0FBQ3ZDLGtEQUFrRDtBQUNsRCxpQ0FBOEM7QUFLOUMsbUNBQWlDO0FBQXhCLDBCQUFBLE1BQU0sQ0FBQTtBQUVmO0lBQ0UsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLEVBQUU7UUFDbEMsOEJBQThCLEVBQUUsTUFBTTtRQUN0QyxpQ0FBaUMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxRQUFRLEVBQUU7UUFDbkQsc0RBQXNEO1lBQ3BELE1BQU0sT0FBTyxHQUFHLDRDQUE0QyxDQUFBO1lBQzVELE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFBO1FBQzVELENBQUM7S0FDRixDQUFDLENBQUE7SUFFRixJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FDZixnREFBZ0QsRUFDaEQsb0NBQW9DLEVBQ3BDLFdBQVcsQ0FDWixDQUFBO0lBQ0QsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQ2YsMENBQTBDLEVBQzFDLG9DQUFvQyxFQUNwQyxXQUFXLENBQ1osQ0FBQTtJQUNELElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUNmLDZDQUE2QyxFQUM3QyxvQ0FBb0MsRUFDcEMsV0FBVyxDQUNaLENBQUE7SUFDRCxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FDZiwyQ0FBMkMsRUFDM0Msb0NBQW9DLEVBQ3BDLFdBQVcsQ0FDWixDQUFBO0lBQ0QsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQ2YsOENBQThDLEVBQzlDLG9DQUFvQyxFQUNwQyxXQUFXLENBQ1osQ0FBQTtJQUNELElB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LENBQUMsSUFBSSxFQUFFLFVBQVMsT0FBZTtnQkFDNUQsT0FBTyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQ3ZCLG1DQUFtQyxFQUNuQyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQ1IsS0FBSyxDQUFDLE9BQU8sQ0FBQyxtQkFBbUIsRUFBRSxjQUFjLFNBQVMsR0FBRyxDQUFDLENBQ2pFLENBQUE7Z0JBQ0QsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1lBQ25CLENBQUMsQ0FBQyxDQUFBO1FBQ0osQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ04sUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQ2hCLENBQUM7SUFDSCxDQUFDLENBQ0YsQ0FBQTtBQUNILENBQUM7QUFwQ0QsNEJBb0NDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIGRlY2FmZmVpbmF0ZSBzdWdnZXN0aW9uczpcbiAqIERTMTAyOiBSZW1vdmUgdW5uZWNlc3NhcnkgY29kZSBjcmVhdGVkIGJlY2F1c2Ugb2YgaW1wbGljaXQgcmV0dXJuc1xuICogRFMxMDQ6IEF2b2lkIGlubGluZSBhc3NpZ25tZW50c1xuICogRnVsbCBkb2NzOiBodHRwczovL2dpdGh1Yi5jb20vZGVjYWZmZWluYXRlL2RlY2FmZmVpbmF0ZS9ibG9iL21hc3Rlci9kb2NzL3N1Z2dlc3Rpb25zLm1kXG4gKi9cbmltcG9ydCB1cmwgPSByZXF1aXJlKCd1cmwnKVxuaW1wb3J0IGZzID0gcmVxdWlyZSgnZnMtcGx1cycpXG5cbmltcG9ydCB7IE1hcmtkb3duUHJldmlld1ZpZXcsIE1QVlBhcmFtcyB9IGZyb20gJy4vbWFya2Rvd24tcHJldmlldy12aWV3J1xuaW1wb3J0IHJlbmRlcmVyID0gcmVxdWlyZSgnLi9yZW5kZXJlcicpXG5pbXBvcnQgbWF0aGpheEhlbHBlciA9IHJlcXVpcmUoJy4vbWF0aGpheC1oZWxwZXInKVxuaW1wb3J0IHsgaXNNYXJrZG93blByZXZpZXdWaWV3IH0gZnJvbSAnLi9jYXN0J1xuaW1wb3J0IHsgVGV4dEVkaXRvciB9IGZyb20gJ2F0b20nXG5pbXBvcnQgeyBXb3Jrc3BhY2VPcGVuT3B0aW9ucyB9IGZyb20gJ2F0b20nXG5pbXBvcnQgeyBDb21tYW5kRXZlbnQgfSBmcm9tICdhdG9tJ1xuXG5leHBvcnQgeyBjb25maWcgfSBmcm9tICcuL2NvbmZpZydcblxuZXhwb3J0IGZ1bmN0aW9uIGFjdGl2YXRlKCkge1xuICBhdG9tLmNvbW1hbmRzLmFkZCgnYXRvbS13b3Jrc3BhY2UnLCB7XG4gICAgJ21hcmtkb3duLXByZXZpZXctcGx1czp0b2dnbGUnOiB0b2dnbGUsXG4gICAgJ21hcmtkb3duLXByZXZpZXctcGx1czpjb3B5LWh0bWwnOiAoKSA9PiBjb3B5SHRtbCgpLFxuICAgICdtYXJrZG93bi1wcmV2aWV3LXBsdXM6dG9nZ2xlLWJyZWFrLW9uLXNpbmdsZS1uZXdsaW5lJygpIHtcbiAgICAgIGNvbnN0IGtleVBhdGggPSAnbWFya2Rvd24tcHJldmlldy1wbHVzLmJyZWFrT25TaW5nbGVOZXdsaW5lJ1xuICAgICAgcmV0dXJuIGF0b20uY29uZmlnLnNldChrZXlQYXRoLCAhYXRvbS5jb25maWcuZ2V0KGtleVBhdGgpKVxuICAgIH0sXG4gIH0pXG5cbiAgYXRvbS5jb21tYW5kcy5hZGQoXG4gICAgJy50cmVlLXZpZXcgLmZpbGUgLm5hbWVbZGF0YS1uYW1lJD1cXFxcLm1hcmtkb3duXScsXG4gICAgJ21hcmtkb3duLXByZXZpZXctcGx1czpwcmV2aWV3LWZpbGUnLFxuICAgIHByZXZpZXdGaWxlLFxuICApXG4gIGF0b20uY29tbWFuZHMuYWRkKFxuICAgICcudHJlZS12aWV3IC5maWxlIC5uYW1lW2RhdGEtbmFtZSQ9XFxcXC5tZF0nLFxuICAgICdtYXJrZG93bi1wcmV2aWV3LXBsdXM6cHJldmlldy1maWxlJyxcbiAgICBwcmV2aWV3RmlsZSxcbiAgKVxuICBhdG9tLmNvbW1hbmRzLmFkZChcbiAgICAnLnRyZWUtdmlldyAuZmlsZSAubmFtZVtkYXRhLW5hbWUkPVxcXFwubWRvd25dJyxcbiAgICAnbWFya2Rvd24tcHJldmlldy1wbHVzOnByZXZpZXctZmlsZScsXG4gICAgcHJldmlld0ZpbGUsXG4gIClcbiAgYXRvbS5jb21tYW5kcy5hZGQoXG4gICAgJy50cmVlLXZpZXcgLmZpbGUgLm5hbWVbZGF0YS1uYW1lJD1cXFxcLm1rZF0nLFxuICAgICdtYXJrZG93bi1wcmV2aWV3LXBsdXM6cHJldmlldy1maWxlJyxcbiAgICBwcmV2aWV3RmlsZSxcbiAgKVxuICBhdG9tLmNvbW1hbmRzLmFkZChcbiAgICAnLnRyZWUtdmlldyAuZmlsZSAubmFtZVtkYXRhLW5hbWUkPVxcXFwubWtkb3duXScsXG4gICAgJ21hcmtkb3duLXByZXZpZXctcGx1czpwcmV2aWV3LWZpbGUnLFxuICAgIHByZXZpZXdGaWxlLFxuICApXG4gIGF0b20uY29tbWFuZHMuYWRkKFxuICAgICcudHJlZS12aWV3IC5maWxlIC5uYW1lW2RhdGEtbmFtZSQ9XFxcXC5yb25dJyxcbiAgICAnbWFya2Rvd24tcHJldmlldy1wbHVzOnByZXZpZXctZmlsZScsXG4gICAgcHJldmlld0ZpbGUsXG4gIClcbiAgYXRvbS5jb21tYW5kcy5hZGQoXG4gICAgJy50cmVlLXZpZXcgLmZpbGUgLm5hbWVbZGF0YS1uYW1lJD1cXFxcLnR4dF0nLFxuICAgICdtYXJrZG93bi1wcmV2aWV3LXBsdXM6cHJldmlldy1maWxlJyxcbiAgICBwcmV2aWV3RmlsZSxcbiAgKVxuXG4gIHJldHVybiBhdG9tLndvcmtzcGFjZS5hZGRPcGVuZXIoKHVyaVRvT3BlbikgPT4ge1xuICAgIHRyeSB7XG4gICAgICB2YXIgeyBwcm90b2NvbCwgaG9zdCwgcGF0aG5hbWUgfSA9IHVybC5wYXJzZSh1cmlUb09wZW4pXG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgY29uc29sZS5lcnJvcihlKVxuICAgICAgcmV0dXJuXG4gICAgfVxuXG4gICAgaWYgKHByb3RvY29sICE9PSAnbWFya2Rvd24tcHJldmlldy1wbHVzOicpIHJldHVyblxuICAgIGlmICghcGF0aG5hbWUpIHJldHVyblxuXG4gICAgdHJ5IHtcbiAgICAgIGlmIChwYXRobmFtZSkge1xuICAgICAgICBwYXRobmFtZSA9IGRlY29kZVVSSShwYXRobmFtZSlcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBjb25zb2xlLmVycm9yKGUpXG4gICAgICByZXR1cm5cbiAgICB9XG5cbiAgICBpZiAoaG9zdCA9PT0gJ2VkaXRvcicpIHtcbiAgICAgIHJldHVybiBjcmVhdGVNYXJrZG93blByZXZpZXdWaWV3KHtcbiAgICAgICAgZWRpdG9ySWQ6IHBhcnNlSW50KHBhdGhuYW1lLnN1YnN0cmluZygxKSwgMTApLFxuICAgICAgfSlcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIGNyZWF0ZU1hcmtkb3duUHJldmlld1ZpZXcoeyBmaWxlUGF0aDogcGF0aG5hbWUgfSlcbiAgICB9XG4gIH0pXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVNYXJrZG93blByZXZpZXdWaWV3KHN0YXRlOiBNUFZQYXJhbXMpIHtcbiAgaWYgKHN0YXRlLmVkaXRvcklkIHx8IChzdGF0ZS5maWxlUGF0aCAmJiBmcy5pc0ZpbGVTeW5jKHN0YXRlLmZpbGVQYXRoKSkpIHtcbiAgICByZXR1cm4gbmV3IE1hcmtkb3duUHJldmlld1ZpZXcoc3RhdGUpXG4gIH1cbiAgcmV0dXJuIHVuZGVmaW5lZFxufVxuXG5leHBvcnQgZnVuY3Rpb24gdG9nZ2xlKCkge1xuICBsZXQgbmVlZGxlXG4gIGlmIChpc01hcmtkb3duUHJldmlld1ZpZXcoYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlUGFuZUl0ZW0oKSkpIHtcbiAgICBhdG9tLndvcmtzcGFjZS5kZXN0cm95QWN0aXZlUGFuZUl0ZW0oKVxuICAgIHJldHVyblxuICB9XG5cbiAgY29uc3QgZWRpdG9yID0gYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlVGV4dEVkaXRvcigpXG4gIGlmIChlZGl0b3IgPT0gbnVsbCkge1xuICAgIHJldHVyblxuICB9XG5cbiAgY29uc3QgZ3JhbW1hcnMgPSBhdG9tLmNvbmZpZy5nZXQoJ21hcmtkb3duLXByZXZpZXctcGx1cy5ncmFtbWFycycpIHx8IFtdXG4gIGlmICgoKG5lZWRsZSA9IGVkaXRvci5nZXRHcmFtbWFyKCkuc2NvcGVOYW1lKSwgIWdyYW1tYXJzLmluY2x1ZGVzKG5lZWRsZSkpKSB7XG4gICAgcmV0dXJuXG4gIH1cblxuICBpZiAoIXJlbW92ZVByZXZpZXdGb3JFZGl0b3IoZWRpdG9yKSkge1xuICAgIGFkZFByZXZpZXdGb3JFZGl0b3IoZWRpdG9yKVxuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB1cmlGb3JFZGl0b3IoZWRpdG9yOiBUZXh0RWRpdG9yKSB7XG4gIHJldHVybiBgbWFya2Rvd24tcHJldmlldy1wbHVzOi8vZWRpdG9yLyR7ZWRpdG9yLmlkfWBcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlbW92ZVByZXZpZXdGb3JFZGl0b3IoZWRpdG9yOiBUZXh0RWRpdG9yKSB7XG4gIGNvbnN0IHVyaSA9IHVyaUZvckVkaXRvcihlZGl0b3IpXG4gIGNvbnN0IHByZXZpZXdQYW5lID0gYXRvbS53b3Jrc3BhY2UucGFuZUZvclVSSSh1cmkpXG4gIGlmIChwcmV2aWV3UGFuZSAhPSBudWxsKSB7XG4gICAgY29uc3QgcHJldmlldyA9IHByZXZpZXdQYW5lLml0ZW1Gb3JVUkkodXJpKVxuICAgIGlmIChwcmV2aWV3ID09PSB1bmRlZmluZWQpIHJldHVybiBmYWxzZVxuICAgIGlmIChwcmV2aWV3ICE9PSBwcmV2aWV3UGFuZS5nZXRBY3RpdmVJdGVtKCkpIHtcbiAgICAgIHByZXZpZXdQYW5lLmFjdGl2YXRlSXRlbShwcmV2aWV3KVxuICAgICAgcmV0dXJuIGZhbHNlXG4gICAgfVxuICAgIHByZXZpZXdQYW5lLmRlc3Ryb3lJdGVtKHByZXZpZXcpXG4gICAgcmV0dXJuIHRydWVcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gZmFsc2VcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gYWRkUHJldmlld0ZvckVkaXRvcihlZGl0b3I6IFRleHRFZGl0b3IpIHtcbiAgY29uc3QgdXJpID0gdXJpRm9yRWRpdG9yKGVkaXRvcilcbiAgY29uc3QgcHJldmlvdXNBY3RpdmVQYW5lID0gYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlUGFuZSgpXG4gIGNvbnN0IG9wdGlvbnM6IFdvcmtzcGFjZU9wZW5PcHRpb25zID0geyBzZWFyY2hBbGxQYW5lczogdHJ1ZSB9XG4gIGlmIChhdG9tLmNvbmZpZy5nZXQoJ21hcmtkb3duLXByZXZpZXctcGx1cy5vcGVuUHJldmlld0luU3BsaXRQYW5lJykpIHtcbiAgICBvcHRpb25zLnNwbGl0ID0gYXRvbS5jb25maWcuZ2V0KCdtYXJrZG93bi1wcmV2aWV3LXBsdXMucHJldmlld1NwbGl0UGFuZURpcicpIVxuICB9XG4gIHJldHVybiBhdG9tLndvcmtzcGFjZS5vcGVuKHVyaSwgb3B0aW9ucykudGhlbihmdW5jdGlvbihtYXJrZG93blByZXZpZXdWaWV3KSB7XG4gICAgaWYgKGlzTWFya2Rvd25QcmV2aWV3VmlldyhtYXJrZG93blByZXZpZXdWaWV3KSkge1xuICAgICAgcmV0dXJuIHByZXZpb3VzQWN0aXZlUGFuZS5hY3RpdmF0ZSgpXG4gICAgfVxuICB9KVxufVxuXG5leHBvcnQgZnVuY3Rpb24gcHJldmlld0ZpbGUoeyBjdXJyZW50VGFyZ2V0IH06IENvbW1hbmRFdmVudCkge1xuICBjb25zdCBmaWxlUGF0aCA9IGN1cnJlbnRUYXJnZXQuZGF0YXNldC5wYXRoXG4gIGlmICghZmlsZVBhdGgpIHtcbiAgICByZXR1cm5cbiAgfVxuXG4gIGZvciAobGV0IGVkaXRvciBvZiBhdG9tLndvcmtzcGFjZS5nZXRUZXh0RWRpdG9ycygpKSB7XG4gICAgaWYgKGVkaXRvci5nZXRQYXRoKCkgPT09IGZpbGVQYXRoKSB7XG4gICAgICBhZGRQcmV2aWV3Rm9yRWRpdG9yKGVkaXRvcilcbiAgICAgIHJldHVyblxuICAgIH1cbiAgfVxuXG4gIHJldHVybiBhdG9tLndvcmtzcGFjZS5vcGVuKGBtYXJrZG93bi1wcmV2aWV3LXBsdXM6Ly8ke2VuY29kZVVSSShmaWxlUGF0aCl9YCwge1xuICAgIHNlYXJjaEFsbFBhbmVzOiB0cnVlLFxuICB9KVxufVxuXG5jb25zdCBjbGlwYm9hcmRDb3B5ID0gKHRleHQ6IHN0cmluZykgPT4gYXRvbS5jbGlwYm9hcmQud3JpdGUodGV4dClcblxuZXhwb3J0IGZ1bmN0aW9uIGNvcHlIdG1sKFxuICBjYWxsYmFjazogKHRleHQ6IHN0cmluZykgPT4gYW55ID0gY2xpcGJvYXJkQ29weSxcbiAgc2NhbGVNYXRoID0gMTAwLFxuKTogdm9pZCB7XG4gIGNvbnN0IGVkaXRvciA9IGF0b20ud29ya3NwYWNlLmdldEFjdGl2ZVRleHRFZGl0b3IoKVxuICBpZiAoZWRpdG9yID09IG51bGwpIHtcbiAgICByZXR1cm5cbiAgfVxuXG4gIGNvbnN0IHRleHQgPSBlZGl0b3IuZ2V0U2VsZWN0ZWRUZXh0KCkgfHwgZWRpdG9yLmdldFRleHQoKVxuICBjb25zdCByZW5kZXJMYVRlWCA9IGF0b20uY29uZmlnLmdldChcbiAgICAnbWFya2Rvd24tcHJldmlldy1wbHVzLmVuYWJsZUxhdGV4UmVuZGVyaW5nQnlEZWZhdWx0JyxcbiAgKVxuICByZW5kZXJlci50b0hUTUwoXG4gICAgdGV4dCxcbiAgICBlZGl0b3IuZ2V0UGF0aCgpLFxuICAgIGVkaXRvci5nZXRHcmFtbWFyKCksXG4gICAgISFyZW5kZXJMYVRlWCxcbiAgICB0cnVlLFxuICAgIGZ1bmN0aW9uKGVycm9yOiBFcnJvciB8IG51bGwsIGh0bWw6IHN0cmluZykge1xuICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUud2FybignQ29weWluZyBNYXJrZG93biBhcyBIVE1MIGZhaWxlZCcsIGVycm9yKVxuICAgICAgfSBlbHNlIGlmIChyZW5kZXJMYVRlWCkge1xuICAgICAgICBtYXRoamF4SGVscGVyLnByb2Nlc3NIVE1MU3RyaW5nKGh0bWwsIGZ1bmN0aW9uKHByb0hUTUw6IHN0cmluZykge1xuICAgICAgICAgIHByb0hUTUwgPSBwcm9IVE1MLnJlcGxhY2UoXG4gICAgICAgICAgICAvTWF0aEpheFxcX1NWRy4qP2ZvbnRcXC1zaXplXFw6IDEwMCUvZyxcbiAgICAgICAgICAgIChtYXRjaCkgPT5cbiAgICAgICAgICAgICAgbWF0Y2gucmVwbGFjZSgvZm9udFxcLXNpemVcXDogMTAwJS8sIGBmb250LXNpemU6ICR7c2NhbGVNYXRofSVgKSxcbiAgICAgICAgICApXG4gICAgICAgICAgY2FsbGJhY2socHJvSFRNTClcbiAgICAgICAgfSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNhbGxiYWNrKGh0bWwpXG4gICAgICB9XG4gICAgfSxcbiAgKVxufVxuIl19