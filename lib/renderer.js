"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const fs = require("fs-plus");
const highlight = require("atom-highlight");
const pandocHelper = require("./pandoc-helper");
const markdownIt = require("./markdown-it-helper");
const extension_helper_1 = require("./extension-helper");
const imageWatcher = require("./image-watch-helper");
const { resourcePath } = atom.getLoadSettings();
const packagePath = path.dirname(__dirname);
async function toDOMFragment(text, filePath, _grammar, renderLaTeX, callback) {
    return render(text, filePath, renderLaTeX, false, function (error, html) {
        if (error !== null) {
            return callback(error);
        }
        const template = document.createElement('template');
        template.innerHTML = html;
        const domFragment = template.content.cloneNode(true);
        return callback(null, domFragment);
    });
}
exports.toDOMFragment = toDOMFragment;
async function toHTML(text, filePath, grammar, renderLaTeX, copyHTMLFlag, callback) {
    if (text === null) {
        text = '';
    }
    return render(text, filePath, renderLaTeX, copyHTMLFlag, function (error, html) {
        let defaultCodeLanguage;
        if (error !== null) {
            callback(error, '');
        }
        if ((grammar && grammar.scopeName) === 'source.litcoffee') {
            defaultCodeLanguage = 'coffee';
        }
        if (!atom.config.get('markdown-preview-plus.enablePandoc') ||
            !atom.config.get('markdown-preview-plus.useNativePandocCodeStyles')) {
            html = tokenizeCodeBlocks(html, defaultCodeLanguage);
        }
        callback(null, html);
    });
}
exports.toHTML = toHTML;
async function render(text, filePath, renderLaTeX, copyHTMLFlag, callback) {
    text = text.replace(/^\s*<!doctype(\s+.*)?>\s*/i, '');
    const callbackFunction = async function (error, html) {
        if (error !== null) {
            callback(error, '');
        }
        html = sanitize(html);
        html = await resolveImagePaths(html, filePath, copyHTMLFlag);
        callback(null, html.trim());
    };
    if (atom.config.get('markdown-preview-plus.enablePandoc')) {
        pandocHelper.renderPandoc(text, filePath, renderLaTeX, callbackFunction);
    }
    else {
        return callbackFunction(null, markdownIt.render(text, renderLaTeX));
    }
}
function sanitize(html) {
    const doc = document.createElement('div');
    doc.innerHTML = html;
    doc.querySelectorAll("script:not([type^='math/tex'])").forEach((elem) => {
        elem.remove();
    });
    const attributesToRemove = [
        'onabort',
        'onblur',
        'onchange',
        'onclick',
        'ondbclick',
        'onerror',
        'onfocus',
        'onkeydown',
        'onkeypress',
        'onkeyup',
        'onload',
        'onmousedown',
        'onmousemove',
        'onmouseover',
        'onmouseout',
        'onmouseup',
        'onreset',
        'onresize',
        'onscroll',
        'onselect',
        'onsubmit',
        'onunload',
    ];
    doc.querySelectorAll('*').forEach((elem) => attributesToRemove.map((attribute) => {
        elem.removeAttribute(attribute);
    }));
    return doc.innerHTML;
}
async function resolveImagePaths(html, filePath, copyHTMLFlag) {
    const [rootDirectory] = atom.project.relativizePath(filePath || '');
    const doc = document.createElement('div');
    doc.innerHTML = html;
    await Promise.all(Array.from(doc.querySelectorAll('img')).map(async function (img) {
        let src = img.getAttribute('src');
        if (src) {
            if (!atom.config.get('markdown-preview-plus.enablePandoc')) {
                src = markdownIt.decode(src);
            }
            if (src.match(/^(https?|atom|data):/)) {
                return;
            }
            if (src.startsWith(process.resourcesPath)) {
                return;
            }
            if (src.startsWith(resourcePath)) {
                return;
            }
            if (src.startsWith(packagePath)) {
                return;
            }
            if (src[0] === '/') {
                if (!fs.isFileSync(src)) {
                    try {
                        if (rootDirectory !== null)
                            src = path.join(rootDirectory, src.substring(1));
                    }
                    catch (e) {
                    }
                }
            }
            else if (filePath) {
                src = path.resolve(path.dirname(filePath), src);
            }
            if (!copyHTMLFlag) {
                const v = await imageWatcher.getVersion(src, filePath);
                if (v) {
                    src = `${src}?v=${v}`;
                }
            }
            img.src = src;
        }
        return;
    }));
    return doc.innerHTML;
}
function convertCodeBlocksToAtomEditors(domFragment, defaultLanguage = 'text') {
    const fontFamily = atom.config.get('editor.fontFamily');
    if (fontFamily) {
        for (const codeElement of Array.from(domFragment.querySelectorAll('code'))) {
            codeElement.style.fontFamily = fontFamily;
        }
    }
    for (const preElement of Array.from(domFragment.querySelectorAll('pre'))) {
        const codeBlock = preElement.firstElementChild !== null
            ? preElement.firstElementChild
            : preElement;
        const cbClass = codeBlock.className;
        const fenceName = cbClass
            ? cbClass.replace(/^(lang-|sourceCode )/, '')
            : defaultLanguage;
        const editorElement = document.createElement('atom-text-editor');
        editorElement.setAttributeNode(document.createAttribute('gutter-hidden'));
        editorElement.removeAttribute('tabindex');
        preElement.parentElement.replaceChild(editorElement, preElement);
        const editor = editorElement.getModel();
        if (editor.cursorLineDecorations != null) {
            for (const cursorLineDecoration of editor.cursorLineDecorations) {
                cursorLineDecoration.destroy();
            }
        }
        editor.setText(codeBlock.textContent.replace(/\n$/, ''));
        const grammar = atom.grammars.grammarForScopeName(extension_helper_1.scopeForFenceName(fenceName));
        if (grammar)
            editor.setGrammar(grammar);
    }
    return domFragment;
}
exports.convertCodeBlocksToAtomEditors = convertCodeBlocksToAtomEditors;
function tokenizeCodeBlocks(html, defaultLanguage = 'text') {
    const doc = document.createElement('div');
    doc.innerHTML = html;
    const fontFamily = atom.config.get('editor.fontFamily');
    if (fontFamily) {
        doc
            .querySelectorAll('code')
            .forEach((code) => (code.style.fontFamily = fontFamily || null));
    }
    doc.querySelectorAll('pre').forEach(function (preElement) {
        const codeBlock = preElement.firstElementChild;
        const fenceName = codeBlock.className.replace(/^(lang-|sourceCode )/, '') || defaultLanguage;
        const highlightedHtml = highlight({
            fileContents: codeBlock.innerText,
            scopeName: extension_helper_1.scopeForFenceName(fenceName),
            nbsp: false,
            lineDivs: false,
            editorDiv: true,
            editorDivTag: 'pre',
            editorDivClass: fenceName
                ? `editor-colors lang-${fenceName}`
                : 'editor-colors',
        });
        preElement.outerHTML = highlightedHtml;
    });
    return doc.innerHTML;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVuZGVyZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcmVuZGVyZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFPQSw2QkFBNkI7QUFDN0IsOEJBQThCO0FBQzlCLDRDQUE0QztBQUM1QyxnREFBZ0Q7QUFDaEQsbURBQW1EO0FBQ25ELHlEQUFzRDtBQUN0RCxxREFBcUQ7QUFHckQsTUFBTSxFQUFFLFlBQVksRUFBRSxHQUFHLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQTtBQUMvQyxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFBO0FBRXBDLEtBQUssd0JBQ1YsSUFBWSxFQUNaLFFBQTRCLEVBQzVCLFFBQWEsRUFDYixXQUFvQixFQUNwQixRQUE2RDtJQUU3RCxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxRQUFRLEVBQUUsV0FBVyxFQUFFLEtBQUssRUFBRSxVQUNoRCxLQUFtQixFQUNuQixJQUFhO1FBRWIsRUFBRSxDQUFDLENBQUMsS0FBSyxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDbkIsTUFBTSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUN4QixDQUFDO1FBRUQsTUFBTSxRQUFRLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsQ0FBQTtRQUNuRCxRQUFRLENBQUMsU0FBUyxHQUFHLElBQUssQ0FBQTtRQUMxQixNQUFNLFdBQVcsR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUVwRCxNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxXQUFXLENBQUMsQ0FBQTtJQUNwQyxDQUFDLENBQUMsQ0FBQTtBQUNKLENBQUM7QUFyQkQsc0NBcUJDO0FBRU0sS0FBSyxpQkFDVixJQUFtQixFQUNuQixRQUE0QixFQUM1QixPQUE0QixFQUM1QixXQUFvQixFQUNwQixZQUFxQixFQUNyQixRQUFx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QWU7U0FDcEIsQ0FBQyxDQUFBO1FBRUYsVUFBVSxDQUFDLFNBQVMsR0FBRyxlQUFlLENBQUE7SUFDeEMsQ0FBQyxDQUFDLENBQUE7SUFFRixNQUFNLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQTtBQUN0QixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIGRlY2FmZmVpbmF0ZSBzdWdnZXN0aW9uczpcbiAqIERTMTAyOiBSZW1vdmUgdW5uZWNlc3NhcnkgY29kZSBjcmVhdGVkIGJlY2F1c2Ugb2YgaW1wbGljaXQgcmV0dXJuc1xuICogRFMxMDQ6IEF2b2lkIGlubGluZSBhc3NpZ25tZW50c1xuICogRFMyMDc6IENvbnNpZGVyIHNob3J0ZXIgdmFyaWF0aW9ucyBvZiBudWxsIGNoZWNrc1xuICogRnVsbCBkb2NzOiBodHRwczovL2dpdGh1Yi5jb20vZGVjYWZmZWluYXRlL2RlY2FmZmVpbmF0ZS9ibG9iL21hc3Rlci9kb2NzL3N1Z2dlc3Rpb25zLm1kXG4gKi9cbmltcG9ydCBwYXRoID0gcmVxdWlyZSgncGF0aCcpXG5pbXBvcnQgZnMgPSByZXF1aXJlKCdmcy1wbHVzJylcbmltcG9ydCBoaWdobGlnaHQgPSByZXF1aXJlKCdhdG9tLWhpZ2hsaWdodCcpXG5pbXBvcnQgcGFuZG9jSGVscGVyID0gcmVxdWlyZSgnLi9wYW5kb2MtaGVscGVyJylcbmltcG9ydCBtYXJrZG93bkl0ID0gcmVxdWlyZSgnLi9tYXJrZG93bi1pdC1oZWxwZXInKSAvLyBEZWZlciB1bnRpbCB1c2VkXG5pbXBvcnQgeyBzY29wZUZvckZlbmNlTmFtZSB9IGZyb20gJy4vZXh0ZW5zaW9uLWhlbHBlcidcbmltcG9ydCBpbWFnZVdhdGNoZXIgPSByZXF1aXJlKCcuL2ltYWdlLXdhdGNoLWhlbHBlcicpXG5pbXBvcnQgeyBHcmFtbWFyLCBUZXh0RWRpdG9yRWxlbWVudCB9IGZyb20gJ2F0b20nXG5cbmNvbnN0IHsgcmVzb3VyY2VQYXRoIH0gPSBhdG9tLmdldExvYWRTZXR0aW5ncygpXG5jb25zdCBwYWNrYWdlUGF0aCA9IHBhdGguZGlybmFtZShfX2Rpcm5hbWUpXG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB0b0RPTUZyYWdtZW50KFxuICB0ZXh0OiBzdHJpbmcsXG4gIGZpbGVQYXRoOiBzdHJpbmcgfCB1bmRlZmluZWQsXG4gIF9ncmFtbWFyOiBhbnksXG4gIHJlbmRlckxhVGVYOiBib29sZWFuLFxuICBjYWxsYmFjazogKGVycm9yOiBFcnJvciB8IG51bGwsIGRvbUZyYWdtZW50PzogTm9kZSkgPT4gc3RyaW5nLFxuKTogUHJvbWlzZTx2b2lkPiB7XG4gIHJldHVybiByZW5kZXIodGV4dCwgZmlsZVBhdGgsIHJlbmRlckxhVGVYLCBmYWxzZSwgZnVuY3Rpb24oXG4gICAgZXJyb3I6IEVycm9yIHwgbnVsbCxcbiAgICBodG1sPzogc3RyaW5nLFxuICApIHtcbiAgICBpZiAoZXJyb3IgIT09IG51bGwpIHtcbiAgICAgIHJldHVybiBjYWxsYmFjayhlcnJvcilcbiAgICB9XG5cbiAgICBjb25zdCB0ZW1wbGF0ZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RlbXBsYXRlJylcbiAgICB0ZW1wbGF0ZS5pbm5lckhUTUwgPSBodG1sIVxuICAgIGNvbnN0IGRvbUZyYWdtZW50ID0gdGVtcGxhdGUuY29udGVudC5jbG9uZU5vZGUodHJ1ZSlcblxuICAgIHJldHVybiBjYWxsYmFjayhudWxsLCBkb21GcmFnbWVudClcbiAgfSlcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHRvSFRNTChcbiAgdGV4dDogc3RyaW5nIHwgbnVsbCxcbiAgZmlsZVBhdGg6IHN0cmluZyB8IHVuZGVmaW5lZCxcbiAgZ3JhbW1hcjogR3JhbW1hciB8IHVuZGVmaW5lZCxcbiAgcmVuZGVyTGFUZVg6IGJvb2xlYW4sXG4gIGNvcHlIVE1MRmxhZzogYm9vbGVhbixcbiAgY2FsbGJhY2s6IChlcnJvcjogRXJyb3IgfCBudWxsLCBodG1sOiBzdHJpbmcpID0+IHZvaWQsXG4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgaWYgKHRleHQgPT09IG51bGwpIHtcbiAgICB0ZXh0ID0gJydcbiAgfVxuICByZXR1cm4gcmVuZGVyKHRleHQsIGZpbGVQYXRoLCByZW5kZXJMYVRlWCwgY29weUhUTUxGbGFnLCBmdW5jdGlvbihlcnJvciwgaHRtbCkge1xuICAgIGxldCBkZWZhdWx0Q29kZUxhbmd1YWdlOiBzdHJpbmcgfCB1bmRlZmluZWRcbiAgICBpZiAoZXJyb3IgIT09IG51bGwpIHtcbiAgICAgIGNhbGxiYWNrKGVycm9yLCAnJylcbiAgICB9XG4gICAgLy8gRGVmYXVsdCBjb2RlIGJsb2NrcyB0byBiZSBjb2ZmZWUgaW4gTGl0ZXJhdGUgQ29mZmVlU2NyaXB0IGZpbGVzXG4gICAgaWYgKChncmFtbWFyICYmIGdyYW1tYXIuc2NvcGVOYW1lKSA9PT0gJ3NvdXJjZS5saXRjb2ZmZWUnKSB7XG4gICAgICBkZWZhdWx0Q29kZUxhbmd1YWdlID0gJ2NvZmZlZSdcbiAgICB9XG4gICAgaWYgKFxuICAgICAgIWF0b20uY29uZmlnLmdldCgnbWFya2Rvd24tcHJldmlldy1wbHVzLmVuYWJsZVBhbmRvYycpIHx8XG4gICAgICAhYXRvbS5jb25maWcuZ2V0KCdtYXJrZG93bi1wcmV2aWV3LXBsdXMudXNlTmF0aXZlUGFuZG9jQ29kZVN0eWxlcycpXG4gICAgKSB7XG4gICAgICBodG1sID0gdG9rZW5pemVDb2RlQmxvY2tzKGh0bWwsIGRlZmF1bHRDb2RlTGFuZ3VhZ2UpXG4gICAgfVxuICAgIGNhbGxiYWNrKG51bGwsIGh0bWwpXG4gIH0pXG59XG5cbmFzeW5jIGZ1bmN0aW9uIHJlbmRlcihcbiAgdGV4dDogc3RyaW5nLFxuICBmaWxlUGF0aDogc3RyaW5nIHwgdW5kZWZpbmVkLFxuICByZW5kZXJMYVRlWDogYm9vbGVhbixcbiAgY29weUhUTUxGbGFnOiBib29sZWFuLFxuICBjYWxsYmFjazogKGVycm9yOiBFcnJvciB8IG51bGwsIGh0bWw6IHN0cmluZykgPT4gdm9pZCxcbik6IFByb21pc2U8dm9pZD4ge1xuICAvLyBSZW1vdmUgdGhlIDwhZG9jdHlwZT4gc2luY2Ugb3RoZXJ3aXNlIG1hcmtlZCB3aWxsIGVzY2FwZSBpdFxuICAvLyBodHRwczovL2dpdGh1Yi5jb20vY2hqai9tYXJrZWQvaXNzdWVzLzM1NFxuICB0ZXh0ID0gdGV4dC5yZXBsYWNlKC9eXFxzKjwhZG9jdHlwZShcXHMrLiopPz5cXHMqL2ksICcnKVxuXG4gIGNvbnN0IGNhbGxiYWNrRnVuY3Rpb24gPSBhc3luYyBmdW5jdGlvbihlcnJvcjogRXJyb3IgfCBudWxsLCBodG1sOiBzdHJpbmcpIHtcbiAgICBpZiAoZXJyb3IgIT09IG51bGwpIHtcbiAgICAgIGNhbGxiYWNrKGVycm9yLCAnJylcbiAgICB9XG4gICAgaHRtbCA9IHNhbml0aXplKGh0bWwpXG4gICAgaHRtbCA9IGF3YWl0IHJlc29sdmVJbWFnZVBhdGhzKGh0bWwsIGZpbGVQYXRoLCBjb3B5SFRNTEZsYWcpXG4gICAgY2FsbGJhY2sobnVsbCwgaHRtbC50cmltKCkpXG4gIH1cblxuICBpZiAoYXRvbS5jb25maWcuZ2V0KCdtYXJrZG93bi1wcmV2aWV3LXBsdXMuZW5hYmxlUGFuZG9jJykpIHtcbiAgICBwYW5kb2NIZWxwZXIucmVuZGVyUGFuZG9jKHRleHQsIGZpbGVQYXRoLCByZW5kZXJMYVRlWCwgY2FsbGJhY2tGdW5jdGlvbilcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gY2FsbGJhY2tGdW5jdGlvbihudWxsLCBtYXJrZG93bkl0LnJlbmRlcih0ZXh0LCByZW5kZXJMYVRlWCkpXG4gIH1cbn1cblxuZnVuY3Rpb24gc2FuaXRpemUoaHRtbDogc3RyaW5nKSB7XG4gIGNvbnN0IGRvYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpXG4gIGRvYy5pbm5lckhUTUwgPSBodG1sXG4gIC8vIERvIG5vdCByZW1vdmUgTWF0aEpheCBzY3JpcHQgZGVsaW1pdGVkIGJsb2Nrc1xuICBkb2MucXVlcnlTZWxlY3RvckFsbChcInNjcmlwdDpub3QoW3R5cGVePSdtYXRoL3RleCddKVwiKS5mb3JFYWNoKChlbGVtKSA9PiB7XG4gICAgZWxlbS5yZW1vdmUoKVxuICB9KVxuICBjb25zdCBhdHRyaWJ1dGVzVG9SZW1vdmUgPSBbXG4gICAgJ29uYWJvcnQnLFxuICAgICdvbmJsdXInLFxuICAgICdvbmNoYW5nZScsXG4gICAgJ29uY2xpY2snLFxuICAgICdvbmRiY2xpY2snLFxuICAgICdvbmVycm9yJyxcbiAgICAnb25mb2N1cycsXG4gICAgJ29ua2V5ZG93bicsXG4gICAgJ29ua2V5cHJlc3MnLFxuICAgICdvbmtleXVwJyxcbiAgICAnb25sb2FkJyxcbiAgICAnb25tb3VzZWRvd24nLFxuICAgICdvbm1vdXNlbW92ZScsXG4gICAgJ29ubW91c2VvdmVyJyxcbiAgICAnb25tb3VzZW91dCcsXG4gICAgJ29ubW91c2V1cCcsXG4gICAgJ29ucmVzZXQnLFxuICAgICdvbnJlc2l6ZScsXG4gICAgJ29uc2Nyb2xsJyxcbiAgICAnb25zZWxlY3QnLFxuICAgICdvbnN1Ym1pdCcsXG4gICAgJ29udW5sb2FkJyxcbiAgXVxuICBkb2MucXVlcnlTZWxlY3RvckFsbCgnKicpLmZvckVhY2goKGVsZW0pID0+XG4gICAgYXR0cmlidXRlc1RvUmVtb3ZlLm1hcCgoYXR0cmlidXRlKSA9PiB7XG4gICAgICBlbGVtLnJlbW92ZUF0dHJpYnV0ZShhdHRyaWJ1dGUpXG4gICAgfSksXG4gIClcbiAgcmV0dXJuIGRvYy5pbm5lckhUTUxcbn1cblxuYXN5bmMgZnVuY3Rpb24gcmVzb2x2ZUltYWdlUGF0aHMoXG4gIGh0bWw6IHN0cmluZyxcbiAgZmlsZVBhdGg6IHN0cmluZyB8IHVuZGVmaW5lZCxcbiAgY29weUhUTUxGbGFnOiBib29sZWFuLFxuKSB7XG4gIGNvbnN0IFtyb290RGlyZWN0b3J5XSA9IGF0b20ucHJvamVjdC5yZWxhdGl2aXplUGF0aChmaWxlUGF0aCB8fCAnJylcbiAgY29uc3QgZG9jID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JylcbiAgZG9jLmlubmVySFRNTCA9IGh0bWxcbiAgYXdhaXQgUHJvbWlzZS5hbGwoQXJyYXkuZnJvbShkb2MucXVlcnlTZWxlY3RvckFsbCgnaW1nJykpLm1hcChhc3luYyBmdW5jdGlvbihpbWcpIHtcbiAgICBsZXQgc3JjID0gaW1nLmdldEF0dHJpYnV0ZSgnc3JjJylcbiAgICBpZiAoc3JjKSB7XG4gICAgICBpZiAoIWF0b20uY29uZmlnLmdldCgnbWFya2Rvd24tcHJldmlldy1wbHVzLmVuYWJsZVBhbmRvYycpKSB7XG4gICAgICAgIHNyYyA9IG1hcmtkb3duSXQuZGVjb2RlKHNyYylcbiAgICAgIH1cblxuICAgICAgaWYgKHNyYy5tYXRjaCgvXihodHRwcz98YXRvbXxkYXRhKTovKSkge1xuICAgICAgICByZXR1cm5cbiAgICAgIH1cbiAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgIGlmIChzcmMuc3RhcnRzV2l0aChwcm9jZXNzLnJlc291cmNlc1BhdGggYXMgc3RyaW5nKSkge1xuICAgICAgICByZXR1cm5cbiAgICAgIH1cbiAgICAgIGlmIChzcmMuc3RhcnRzV2l0aChyZXNvdXJjZVBhdGgpKSB7XG4gICAgICAgIHJldHVyblxuICAgICAgfVxuICAgICAgaWYgKHNyYy5zdGFydHNXaXRoKHBhY2thZ2VQYXRoKSkge1xuICAgICAgICByZXR1cm5cbiAgICAgIH1cblxuICAgICAgaWYgKHNyY1swXSA9PT0gJy8nKSB7XG4gICAgICAgIGlmICghZnMuaXNGaWxlU3luYyhzcmMpKSB7XG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGlmIChyb290RGlyZWN0b3J5ICE9PSBudWxsKSBzcmMgPSBwYXRoLmpvaW4ocm9vdERpcmVjdG9yeSwgc3JjLnN1YnN0cmluZygxKSlcbiAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAvLyBub29wXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKGZpbGVQYXRoKSB7XG4gICAgICAgIHNyYyA9IHBhdGgucmVzb2x2ZShwYXRoLmRpcm5hbWUoZmlsZVBhdGgpLCBzcmMpXG4gICAgICB9XG5cbiAgICAgIC8vIFVzZSBtb3N0IHJlY2VudCB2ZXJzaW9uIG9mIGltYWdlXG4gICAgICBpZiAoIWNvcHlIVE1MRmxhZykge1xuICAgICAgICBjb25zdCB2ID0gYXdhaXQgaW1hZ2VXYXRjaGVyLmdldFZlcnNpb24oc3JjLCBmaWxlUGF0aClcbiAgICAgICAgaWYgKHYpIHtcbiAgICAgICAgICBzcmMgPSBgJHtzcmN9P3Y9JHt2fWBcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpbWcuc3JjID0gc3JjXG4gICAgfVxuICAgIHJldHVyblxuICB9KSlcblxuICByZXR1cm4gZG9jLmlubmVySFRNTFxufVxuXG5leHBvcnQgZnVuY3Rpb24gY29udmVydENvZGVCbG9ja3NUb0F0b21FZGl0b3JzKFxuICBkb21GcmFnbWVudDogRWxlbWVudCxcbiAgZGVmYXVsdExhbmd1YWdlOiBzdHJpbmcgPSAndGV4dCcsXG4pIHtcbiAgY29uc3QgZm9udEZhbWlseSA9IGF0b20uY29uZmlnLmdldCgnZWRpdG9yLmZvbnRGYW1pbHknKVxuICBpZiAoZm9udEZhbWlseSkge1xuICAgIGZvciAoY29uc3QgY29kZUVsZW1lbnQgb2YgQXJyYXkuZnJvbShcbiAgICAgIGRvbUZyYWdtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ2NvZGUnKSxcbiAgICApKSB7XG4gICAgICBjb2RlRWxlbWVudC5zdHlsZS5mb250RmFtaWx5ID0gZm9udEZhbWlseVxuICAgIH1cbiAgfVxuXG4gIGZvciAoY29uc3QgcHJlRWxlbWVudCBvZiBBcnJheS5mcm9tKGRvbUZyYWdtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ3ByZScpKSkge1xuICAgIGNvbnN0IGNvZGVCbG9jayA9XG4gICAgICBwcmVFbGVtZW50LmZpcnN0RWxlbWVudENoaWxkICE9PSBudWxsXG4gICAgICAgID8gcHJlRWxlbWVudC5maXJzdEVsZW1lbnRDaGlsZFxuICAgICAgICA6IHByZUVsZW1lbnRcbiAgICBjb25zdCBjYkNsYXNzID0gY29kZUJsb2NrLmNsYXNzTmFtZVxuICAgIGNvbnN0IGZlbmNlTmFtZSA9IGNiQ2xhc3NcbiAgICAgID8gY2JDbGFzcy5yZXBsYWNlKC9eKGxhbmctfHNvdXJjZUNvZGUgKS8sICcnKVxuICAgICAgOiBkZWZhdWx0TGFuZ3VhZ2VcblxuICAgIGNvbnN0IGVkaXRvckVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFxuICAgICAgJ2F0b20tdGV4dC1lZGl0b3InLFxuICAgICkgYXMgVGV4dEVkaXRvckVsZW1lbnRcbiAgICBlZGl0b3JFbGVtZW50LnNldEF0dHJpYnV0ZU5vZGUoZG9jdW1lbnQuY3JlYXRlQXR0cmlidXRlKCdndXR0ZXItaGlkZGVuJykpXG4gICAgZWRpdG9yRWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUoJ3RhYmluZGV4JykgLy8gbWFrZSByZWFkLW9ubHlcblxuICAgIHByZUVsZW1lbnQucGFyZW50RWxlbWVudCEucmVwbGFjZUNoaWxkKGVkaXRvckVsZW1lbnQsIHByZUVsZW1lbnQpXG5cbiAgICBjb25zdCBlZGl0b3IgPSBlZGl0b3JFbGVtZW50LmdldE1vZGVsKClcbiAgICAvLyByZW1vdmUgdGhlIGRlZmF1bHQgc2VsZWN0aW9uIG9mIGEgbGluZSBpbiBlYWNoIGVkaXRvclxuICAgIGlmIChlZGl0b3IuY3Vyc29yTGluZURlY29yYXRpb25zICE9IG51bGwpIHtcbiAgICAgIGZvciAoY29uc3QgY3Vyc29yTGluZURlY29yYXRpb24gb2YgZWRpdG9yLmN1cnNvckxpbmVEZWNvcmF0aW9ucykge1xuICAgICAgICBjdXJzb3JMaW5lRGVjb3JhdGlvbi5kZXN0cm95KClcbiAgICAgIH1cbiAgICB9XG5cbiAgICBlZGl0b3Iuc2V0VGV4dChjb2RlQmxvY2sudGV4dENvbnRlbnQhLnJlcGxhY2UoL1xcbiQvLCAnJykpXG4gICAgY29uc3QgZ3JhbW1hciA9IGF0b20uZ3JhbW1hcnMuZ3JhbW1hckZvclNjb3BlTmFtZShcbiAgICAgIHNjb3BlRm9yRmVuY2VOYW1lKGZlbmNlTmFtZSksXG4gICAgKVxuICAgIGlmIChncmFtbWFyKSBlZGl0b3Iuc2V0R3JhbW1hcihncmFtbWFyKVxuICB9XG5cbiAgcmV0dXJuIGRvbUZyYWdtZW50XG59XG5cbmZ1bmN0aW9uIHRva2VuaXplQ29kZUJsb2NrcyhodG1sOiBzdHJpbmcsIGRlZmF1bHRMYW5ndWFnZTogc3RyaW5nID0gJ3RleHQnKSB7XG4gIGNvbnN0IGRvYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpXG4gIGRvYy5pbm5lckhUTUwgPSBodG1sXG5cbiAgY29uc3QgZm9udEZhbWlseSA9IGF0b20uY29uZmlnLmdldCgnZWRpdG9yLmZvbnRGYW1pbHknKVxuICBpZiAoZm9udEZhbWlseSkge1xuICAgIGRvY1xuICAgICAgLnF1ZXJ5U2VsZWN0b3JBbGwoJ2NvZGUnKVxuICAgICAgLmZvckVhY2goKGNvZGUpID0+IChjb2RlLnN0eWxlLmZvbnRGYW1pbHkgPSBmb250RmFtaWx5IHx8IG51bGwpKVxuICB9XG5cbiAgZG9jLnF1ZXJ5U2VsZWN0b3JBbGwoJ3ByZScpLmZvckVhY2goZnVuY3Rpb24ocHJlRWxlbWVudCkge1xuICAgIGNvbnN0IGNvZGVCbG9jayA9IHByZUVsZW1lbnQuZmlyc3RFbGVtZW50Q2hpbGQgYXMgSFRNTEVsZW1lbnRcbiAgICBjb25zdCBmZW5jZU5hbWUgPVxuICAgICAgY29kZUJsb2NrLmNsYXNzTmFtZS5yZXBsYWNlKC9eKGxhbmctfHNvdXJjZUNvZGUgKS8sICcnKSB8fCBkZWZhdWx0TGFuZ3VhZ2VcblxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby11bnNhZmUtYW55XG4gICAgY29uc3QgaGlnaGxpZ2h0ZWRIdG1sOiBzdHJpbmcgPSBoaWdobGlnaHQoe1xuICAgICAgZmlsZUNvbnRlbnRzOiBjb2RlQmxvY2suaW5uZXJUZXh0LFxuICAgICAgc2NvcGVOYW1lOiBzY29wZUZvckZlbmNlTmFtZShmZW5jZU5hbWUpLFxuICAgICAgbmJzcDogZmFsc2UsXG4gICAgICBsaW5lRGl2czogZmFsc2UsXG4gICAgICBlZGl0b3JEaXY6IHRydWUsXG4gICAgICBlZGl0b3JEaXZUYWc6ICdwcmUnLFxuICAgICAgLy8gVGhlIGBlZGl0b3JgIGNsYXNzIG1lc3NlcyB0aGluZ3MgdXAgYXMgYC5lZGl0b3JgIGhhcyBhYnNvbHV0ZWx5IHBvc2l0aW9uZWQgbGluZXNcbiAgICAgIGVkaXRvckRpdkNsYXNzOiBmZW5jZU5hbWVcbiAgICAgICAgPyBgZWRpdG9yLWNvbG9ycyBsYW5nLSR7ZmVuY2VOYW1lfWBcbiAgICAgICAgOiAnZWRpdG9yLWNvbG9ycycsXG4gICAgfSlcblxuICAgIHByZUVsZW1lbnQub3V0ZXJIVE1MID0gaGlnaGxpZ2h0ZWRIdG1sXG4gIH0pXG5cbiAgcmV0dXJuIGRvYy5pbm5lckhUTUxcbn1cbiJdfQ==