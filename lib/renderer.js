"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const fs = require("fs-plus");
const highlight = require("atom-highlight");
const pandocHelper = require("./pandoc-helper");
const markdownIt = require("./markdown-it-helper");
const extension_helper_1 = require("./extension-helper");
const imageWatcher = require("./image-watch-helper");
const { resourcePath } = atom.getLoadSettings();
const packagePath = path.dirname(__dirname);
function toDOMFragment(text, filePath, _grammar, renderLaTeX, callback) {
    if (text == null) {
        text = "";
    }
    return render(text, filePath, renderLaTeX, false, function (error, html) {
        if (error != null) {
            return callback(error);
        }
        const template = document.createElement("template");
        template.innerHTML = html;
        const domFragment = template.content.cloneNode(true);
        return callback(null, domFragment);
    });
}
exports.toDOMFragment = toDOMFragment;
function toHTML(text, filePath, grammar, renderLaTeX, copyHTMLFlag, callback) {
    if (text == null) {
        text = "";
    }
    return render(text, filePath, renderLaTeX, copyHTMLFlag, function (error, html) {
        let defaultCodeLanguage;
        if (error != null) {
            return callback(error, "");
        }
        if ((grammar && grammar.scopeName) === "source.litcoffee") {
            defaultCodeLanguage = "coffee";
        }
        if (!atom.config.get("markdown-preview-plus.enablePandoc") ||
            !atom.config.get("markdown-preview-plus.useNativePandocCodeStyles")) {
            html = tokenizeCodeBlocks(html, defaultCodeLanguage);
        }
        return callback(null, html);
    });
}
exports.toHTML = toHTML;
function render(text, filePath, renderLaTeX, copyHTMLFlag, callback) {
    text = text.replace(/^\s*<!doctype(\s+.*)?>\s*/i, "");
    const callbackFunction = function (error, html) {
        if (error != null) {
            return callback(error, "");
        }
        html = sanitize(html);
        html = resolveImagePaths(html, filePath, copyHTMLFlag);
        return callback(null, html.trim());
    };
    if (atom.config.get("markdown-preview-plus.enablePandoc")) {
        return pandocHelper.renderPandoc(text, filePath, renderLaTeX, callbackFunction);
    }
    else {
        return callbackFunction(null, markdownIt.render(text, renderLaTeX));
    }
}
function sanitize(html) {
    const doc = document.createElement("div");
    doc.innerHTML = html;
    doc
        .querySelectorAll("script:not([type^='math/tex'])")
        .forEach(elem => elem.remove());
    const attributesToRemove = [
        "onabort",
        "onblur",
        "onchange",
        "onclick",
        "ondbclick",
        "onerror",
        "onfocus",
        "onkeydown",
        "onkeypress",
        "onkeyup",
        "onload",
        "onmousedown",
        "onmousemove",
        "onmouseover",
        "onmouseout",
        "onmouseup",
        "onreset",
        "onresize",
        "onscroll",
        "onselect",
        "onsubmit",
        "onunload"
    ];
    doc
        .querySelectorAll("*")
        .forEach(elem => Array.from(attributesToRemove).map(attribute => elem.removeAttribute(attribute)));
    return doc.innerHTML;
}
function resolveImagePaths(html, filePath, copyHTMLFlag) {
    let rootDirectory;
    if (atom.project != null) {
        ;
        [rootDirectory] = Array.from(atom.project.relativizePath(filePath || ""));
    }
    const doc = document.createElement("div");
    doc.innerHTML = html;
    doc.querySelectorAll("img").forEach(function (img) {
        let src;
        if ((src = img.getAttribute("src"))) {
            if (!atom.config.get("markdown-preview-plus.enablePandoc")) {
                src = markdownIt.decode(src);
            }
            if (src.match(/^(https?|atom|data):/)) {
                return;
            }
            if (src.startsWith(process.resourcesPath)) {
                return;
            }
            if (src.startsWith(resourcePath)) {
                return;
            }
            if (src.startsWith(packagePath)) {
                return;
            }
            if (src[0] === "/") {
                if (!fs.isFileSync(src)) {
                    try {
                        src = path.join(rootDirectory, src.substring(1));
                    }
                    catch (e) { }
                }
            }
            else if (filePath) {
                src = path.resolve(path.dirname(filePath), src);
            }
            if (!copyHTMLFlag) {
                const v = imageWatcher.getVersion(src, filePath);
                if (v) {
                    src = `${src}?v=${v}`;
                }
            }
            return (img.src = src);
        }
        return;
    });
    return doc.innerHTML;
}
function convertCodeBlocksToAtomEditors(domFragment, defaultLanguage) {
    let fontFamily;
    if (defaultLanguage == null) {
        defaultLanguage = "text";
    }
    if ((fontFamily = atom.config.get("editor.fontFamily"))) {
        for (let codeElement of Array.from(domFragment.querySelectorAll("code"))) {
            codeElement.style.fontFamily = fontFamily;
        }
    }
    for (let preElement of Array.from(domFragment.querySelectorAll("pre"))) {
        const codeBlock = preElement.firstElementChild != null
            ? preElement.firstElementChild
            : preElement;
        const cbClass = codeBlock.className;
        const fenceName = cbClass
            ? cbClass.replace(/^(lang-|sourceCode )/, "")
            : defaultLanguage;
        const editorElement = document.createElement("atom-text-editor");
        editorElement.setAttributeNode(document.createAttribute("gutter-hidden"));
        editorElement.removeAttribute("tabindex");
        preElement.parentElement.replaceChild(editorElement, preElement);
        const editor = editorElement.getModel();
        if (editor.cursorLineDecorations != null) {
            for (let cursorLineDecoration of editor.cursorLineDecorations) {
                cursorLineDecoration.destroy();
            }
        }
        editor.setText(codeBlock.textContent.replace(/\n$/, ""));
        const grammar = atom.grammars.grammarForScopeName(extension_helper_1.scopeForFenceName(fenceName));
        if (grammar)
            editor.setGrammar(grammar);
    }
    return domFragment;
}
exports.convertCodeBlocksToAtomEditors = convertCodeBlocksToAtomEditors;
function tokenizeCodeBlocks(html, defaultLanguage = "text") {
    let fontFamily;
    const doc = document.createElement("div");
    doc.innerHTML = html;
    if ((fontFamily = atom.config.get("editor.fontFamily"))) {
        doc
            .querySelectorAll("code")
            .forEach(code => (code.style.fontFamily = fontFamily || null));
    }
    doc.querySelectorAll("pre").forEach(function (preElement) {
        let left;
        const codeBlock = preElement.firstElementChild;
        const fenceName = (left = codeBlock.className.replace(/^(lang-|sourceCode )/, "")) != null
            ? left
            : defaultLanguage;
        const highlightedHtml = highlight({
            fileContents: codeBlock.innerText,
            scopeName: extension_helper_1.scopeForFenceName(fenceName),
            nbsp: false,
            lineDivs: false,
            editorDiv: true,
            editorDivTag: "pre",
            editorDivClass: fenceName
                ? `editor-colors lang-${fenceName}`
                : "editor-colors"
        });
        return (preElement.outerHTML = highlightedHtml);
    });
    return doc.innerHTML;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVuZGVyZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcmVuZGVyZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFTQSw2QkFBNkI7QUFDN0IsOEJBQThCO0FBQzlCLDRDQUE0QztBQUM1QyxnREFBZ0Q7QUFDaEQsbURBQW1EO0FBQ25ELHlEQUFzRDtBQUN0RCxxREFBcUQ7QUFHckQsTUFBTSxFQUFFLFlBQVksRUFBRSxHQUFHLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQTtBQUMvQyxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFBO0FBRTNDLHVCQUNFLElBQVksRUFDWixRQUFhLEVBQ2IsUUFBYSxFQUNiLFdBQW9CLEVBQ3BCLFFBQTZEO0lBRTdELEVBQUUsQ0FBQyxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ2pCLElBQUksR0FBRyxFQUFFLENBQUE7SUFDWCxDQUFDO0lBQ0QsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsUUFBUSxFQUFFLFdBQVcsRUFBRSxLQUFLLEVBQUUsVUFDaEQsS0FBbUIsRUFDbkIsSUFBYTtRQUViLEVBQUUsQ0FBQyxDQUFDLEtBQUssSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ2xCLE1BQU0sQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUE7UUFDeEIsQ0FBQztRQUVELE1BQU0sUUFBUSxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLENBQUE7UUFDbkQsUUFBUSxDQUFDLFNBQVMsR0FBRyxJQUFLLENBQUE7UUFDMUIsTUFBTSxXQUFXLEdBQUcsUUFBUSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUE7UUFFcEQsTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsV0FBVyxDQUFDLENBQUE7SUFDcEMsQ0FBQyxDQUFDLENBQUE7QUFDSixDQUFDO0FBeEJELHNDQXdCQztB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SUFBSSxJQUFJO1lBQ3RFLENBQUMsQ0FBQyxJQUFJO1lBQ04sQ0FBQyxDQUFDLGVBQWUsQ0FBQTtRQUVyQixNQUFNLGVBQWUsR0FBRyxTQUFTLENBQUM7WUFDaEMsWUFBWSxFQUFFLFNBQVMsQ0FBQyxTQUFTO1lBQ2pDLFNBQVMsRUFBRSxvQ0FBaUIsQ0FBQyxTQUFTLENBQUM7WUFDdkMsSUFBSSxFQUFFLEtBQUs7WUFDWCxRQUFRLEVBQUUsS0FBSztZQUNmLFNBQVMsRUFBRSxJQUFJO1lBQ2YsWUFBWSxFQUFFLEtBQUs7WUFFbkIsY0FBYyxFQUFFLFNBQVM7Z0JBQ3ZCLENBQUMsQ0FBQyxzQkFBc0IsU0FBUyxFQUFFO2dCQUNuQyxDQUFDLENBQUMsZUFBZTtTQUNwQixDQUFDLENBQUE7UUFFRixNQUFNLENBQUMsQ0FBQyxVQUFVLENBQUMsU0FBUyxHQUFHLGVBQWUsQ0FBQyxDQUFBO0lBQ2pELENBQUMsQ0FBQyxDQUFBO0lBRUYsTUFBTSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUE7QUFDdEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBkZWNhZmZlaW5hdGUgc3VnZ2VzdGlvbnM6XG4gKiBEUzEwMTogUmVtb3ZlIHVubmVjZXNzYXJ5IHVzZSBvZiBBcnJheS5mcmNvbnN0IGNiQ2xhc3MgPSBjb2RlQmxvY2suY2xhc3NOYW1lXG4gKiBEUzEwMjogUmVtb3ZlIHVubmVjZXNzYXJ5IGNvZGUgY3JlYXRlZCBiZWNhdXNlIG9mIGltcGxpY2l0IHJldHVybnNcbiAqIERTMTAzOiBSZXdyaXRlIGNvZGUgdG8gbm8gbG9uZ2VyIHVzZSBfX2d1YXJkX19cbiAqIERTMTA0OiBBdm9pZCBpbmxpbmUgYXNzaWdubWVudHNcbiAqIERTMjA3OiBDb25zaWRlciBzaG9ydGVyIHZhcmlhdGlvbnMgb2YgbnVsbCBjaGVja3NcbiAqIEZ1bGwgZG9jczogaHR0cHM6Ly9naXRodWIuY29tL2RlY2FmZmVpbmF0ZS9kZWNhZmZlaW5hdGUvYmxvYi9tYXN0ZXIvZG9jcy9zdWdnZXN0aW9ucy5tZFxuICovXG5pbXBvcnQgcGF0aCA9IHJlcXVpcmUoXCJwYXRoXCIpXG5pbXBvcnQgZnMgPSByZXF1aXJlKFwiZnMtcGx1c1wiKVxuaW1wb3J0IGhpZ2hsaWdodCA9IHJlcXVpcmUoXCJhdG9tLWhpZ2hsaWdodFwiKVxuaW1wb3J0IHBhbmRvY0hlbHBlciA9IHJlcXVpcmUoXCIuL3BhbmRvYy1oZWxwZXJcIilcbmltcG9ydCBtYXJrZG93bkl0ID0gcmVxdWlyZShcIi4vbWFya2Rvd24taXQtaGVscGVyXCIpIC8vIERlZmVyIHVudGlsIHVzZWRcbmltcG9ydCB7IHNjb3BlRm9yRmVuY2VOYW1lIH0gZnJvbSBcIi4vZXh0ZW5zaW9uLWhlbHBlclwiXG5pbXBvcnQgaW1hZ2VXYXRjaGVyID0gcmVxdWlyZShcIi4vaW1hZ2Utd2F0Y2gtaGVscGVyXCIpXG5pbXBvcnQgeyBHcmFtbWFyLCBUZXh0RWRpdG9yRWxlbWVudCB9IGZyb20gXCJhdG9tXCJcblxuY29uc3QgeyByZXNvdXJjZVBhdGggfSA9IGF0b20uZ2V0TG9hZFNldHRpbmdzKClcbmNvbnN0IHBhY2thZ2VQYXRoID0gcGF0aC5kaXJuYW1lKF9fZGlybmFtZSlcblxuZXhwb3J0IGZ1bmN0aW9uIHRvRE9NRnJhZ21lbnQoXG4gIHRleHQ6IHN0cmluZyxcbiAgZmlsZVBhdGg6IGFueSxcbiAgX2dyYW1tYXI6IGFueSxcbiAgcmVuZGVyTGFUZVg6IGJvb2xlYW4sXG4gIGNhbGxiYWNrOiAoZXJyb3I6IEVycm9yIHwgbnVsbCwgZG9tRnJhZ21lbnQ/OiBOb2RlKSA9PiBzdHJpbmdcbik6IHN0cmluZyB7XG4gIGlmICh0ZXh0ID09IG51bGwpIHtcbiAgICB0ZXh0ID0gXCJcIlxuICB9XG4gIHJldHVybiByZW5kZXIodGV4dCwgZmlsZVBhdGgsIHJlbmRlckxhVGVYLCBmYWxzZSwgZnVuY3Rpb24oXG4gICAgZXJyb3I6IEVycm9yIHwgbnVsbCxcbiAgICBodG1sPzogc3RyaW5nXG4gICkge1xuICAgIGlmIChlcnJvciAhPSBudWxsKSB7XG4gICAgICByZXR1cm4gY2FsbGJhY2soZXJyb3IpXG4gICAgfVxuXG4gICAgY29uc3QgdGVtcGxhdGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwidGVtcGxhdGVcIilcbiAgICB0ZW1wbGF0ZS5pbm5lckhUTUwgPSBodG1sIVxuICAgIGNvbnN0IGRvbUZyYWdtZW50ID0gdGVtcGxhdGUuY29udGVudC5jbG9uZU5vZGUodHJ1ZSlcblxuICAgIHJldHVybiBjYWxsYmFjayhudWxsLCBkb21GcmFnbWVudClcbiAgfSlcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHRvSFRNTChcbiAgdGV4dDogc3RyaW5nIHwgbnVsbCxcbiAgZmlsZVBhdGg6IHN0cmluZyB8IHVuZGVmaW5lZCxcbiAgZ3JhbW1hcjogR3JhbW1hciB8IG51bGwsXG4gIHJlbmRlckxhVGVYOiBib29sZWFuLFxuICBjb3B5SFRNTEZsYWc6IGJvb2xlYW4sXG4gIGNhbGxiYWNrOiAoZXJyb3I6IEVycm9yIHwgbnVsbCwgaHRtbDogc3RyaW5nKSA9PiBzdHJpbmdcbik6IHN0cmluZyB7XG4gIGlmICh0ZXh0ID09IG51bGwpIHtcbiAgICB0ZXh0ID0gXCJcIlxuICB9XG4gIHJldHVybiByZW5kZXIodGV4dCwgZmlsZVBhdGgsIHJlbmRlckxhVGVYLCBjb3B5SFRNTEZsYWcsIGZ1bmN0aW9uKFxuICAgIGVycm9yLFxuICAgIGh0bWxcbiAgKSB7XG4gICAgbGV0IGRlZmF1bHRDb2RlTGFuZ3VhZ2U6IHN0cmluZyB8IHVuZGVmaW5lZFxuICAgIGlmIChlcnJvciAhPSBudWxsKSB7XG4gICAgICByZXR1cm4gY2FsbGJhY2soZXJyb3IsIFwiXCIpXG4gICAgfVxuICAgIC8vIERlZmF1bHQgY29kZSBibG9ja3MgdG8gYmUgY29mZmVlIGluIExpdGVyYXRlIENvZmZlZVNjcmlwdCBmaWxlc1xuICAgIGlmICgoZ3JhbW1hciAmJiBncmFtbWFyLnNjb3BlTmFtZSkgPT09IFwic291cmNlLmxpdGNvZmZlZVwiKSB7XG4gICAgICBkZWZhdWx0Q29kZUxhbmd1YWdlID0gXCJjb2ZmZWVcIlxuICAgIH1cbiAgICBpZiAoXG4gICAgICAhYXRvbS5jb25maWcuZ2V0KFwibWFya2Rvd24tcHJldmlldy1wbHVzLmVuYWJsZVBhbmRvY1wiKSB8fFxuICAgICAgIWF0b20uY29uZmlnLmdldChcIm1hcmtkb3duLXByZXZpZXctcGx1cy51c2VOYXRpdmVQYW5kb2NDb2RlU3R5bGVzXCIpXG4gICAgKSB7XG4gICAgICBodG1sID0gdG9rZW5pemVDb2RlQmxvY2tzKGh0bWwsIGRlZmF1bHRDb2RlTGFuZ3VhZ2UpXG4gICAgfVxuICAgIHJldHVybiBjYWxsYmFjayhudWxsLCBodG1sKVxuICB9KVxufVxuXG5mdW5jdGlvbiByZW5kZXIoXG4gIHRleHQ6IHN0cmluZyxcbiAgZmlsZVBhdGg6IHN0cmluZyB8IHVuZGVmaW5lZCxcbiAgcmVuZGVyTGFUZVg6IGJvb2xlYW4sXG4gIGNvcHlIVE1MRmxhZzogYm9vbGVhbixcbiAgY2FsbGJhY2s6IChlcnJvcjogRXJyb3IgfCBudWxsLCBodG1sOiBzdHJpbmcpID0+IHN0cmluZ1xuKTogc3RyaW5nIHtcbiAgLy8gUmVtb3ZlIHRoZSA8IWRvY3R5cGU+IHNpbmNlIG90aGVyd2lzZSBtYXJrZWQgd2lsbCBlc2NhcGUgaXRcbiAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2NoamovbWFya2VkL2lzc3Vlcy8zNTRcbiAgdGV4dCA9IHRleHQucmVwbGFjZSgvXlxccyo8IWRvY3R5cGUoXFxzKy4qKT8+XFxzKi9pLCBcIlwiKVxuXG4gIGNvbnN0IGNhbGxiYWNrRnVuY3Rpb24gPSBmdW5jdGlvbihlcnJvcjogRXJyb3IgfCBudWxsLCBodG1sOiBzdHJpbmcpIHtcbiAgICBpZiAoZXJyb3IgIT0gbnVsbCkge1xuICAgICAgcmV0dXJuIGNhbGxiYWNrKGVycm9yLCBcIlwiKVxuICAgIH1cbiAgICBodG1sID0gc2FuaXRpemUoaHRtbClcbiAgICBodG1sID0gcmVzb2x2ZUltYWdlUGF0aHMoaHRtbCwgZmlsZVBhdGgsIGNvcHlIVE1MRmxhZylcbiAgICByZXR1cm4gY2FsbGJhY2sobnVsbCwgaHRtbC50cmltKCkpXG4gIH1cblxuICBpZiAoYXRvbS5jb25maWcuZ2V0KFwibWFya2Rvd24tcHJldmlldy1wbHVzLmVuYWJsZVBhbmRvY1wiKSkge1xuICAgIHJldHVybiBwYW5kb2NIZWxwZXIucmVuZGVyUGFuZG9jKFxuICAgICAgdGV4dCxcbiAgICAgIGZpbGVQYXRoLFxuICAgICAgcmVuZGVyTGFUZVgsXG4gICAgICBjYWxsYmFja0Z1bmN0aW9uXG4gICAgKVxuICB9IGVsc2Uge1xuICAgIHJldHVybiBjYWxsYmFja0Z1bmN0aW9uKG51bGwsIG1hcmtkb3duSXQucmVuZGVyKHRleHQsIHJlbmRlckxhVGVYKSlcbiAgfVxufVxuXG5mdW5jdGlvbiBzYW5pdGl6ZShodG1sOiBzdHJpbmcpIHtcbiAgY29uc3QgZG9jID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKVxuICBkb2MuaW5uZXJIVE1MID0gaHRtbFxuICAvLyBEbyBub3QgcmVtb3ZlIE1hdGhKYXggc2NyaXB0IGRlbGltaXRlZCBibG9ja3NcbiAgZG9jXG4gICAgLnF1ZXJ5U2VsZWN0b3JBbGwoXCJzY3JpcHQ6bm90KFt0eXBlXj0nbWF0aC90ZXgnXSlcIilcbiAgICAuZm9yRWFjaChlbGVtID0+IGVsZW0ucmVtb3ZlKCkpXG4gIGNvbnN0IGF0dHJpYnV0ZXNUb1JlbW92ZSA9IFtcbiAgICBcIm9uYWJvcnRcIixcbiAgICBcIm9uYmx1clwiLFxuICAgIFwib25jaGFuZ2VcIixcbiAgICBcIm9uY2xpY2tcIixcbiAgICBcIm9uZGJjbGlja1wiLFxuICAgIFwib25lcnJvclwiLFxuICAgIFwib25mb2N1c1wiLFxuICAgIFwib25rZXlkb3duXCIsXG4gICAgXCJvbmtleXByZXNzXCIsXG4gICAgXCJvbmtleXVwXCIsXG4gICAgXCJvbmxvYWRcIixcbiAgICBcIm9ubW91c2Vkb3duXCIsXG4gICAgXCJvbm1vdXNlbW92ZVwiLFxuICAgIFwib25tb3VzZW92ZXJcIixcbiAgICBcIm9ubW91c2VvdXRcIixcbiAgICBcIm9ubW91c2V1cFwiLFxuICAgIFwib25yZXNldFwiLFxuICAgIFwib25yZXNpemVcIixcbiAgICBcIm9uc2Nyb2xsXCIsXG4gICAgXCJvbnNlbGVjdFwiLFxuICAgIFwib25zdWJtaXRcIixcbiAgICBcIm9udW5sb2FkXCJcbiAgXVxuICBkb2NcbiAgICAucXVlcnlTZWxlY3RvckFsbChcIipcIilcbiAgICAuZm9yRWFjaChlbGVtID0+XG4gICAgICBBcnJheS5mcm9tKGF0dHJpYnV0ZXNUb1JlbW92ZSkubWFwKGF0dHJpYnV0ZSA9PlxuICAgICAgICBlbGVtLnJlbW92ZUF0dHJpYnV0ZShhdHRyaWJ1dGUpXG4gICAgICApXG4gICAgKVxuICByZXR1cm4gZG9jLmlubmVySFRNTFxufVxuXG5mdW5jdGlvbiByZXNvbHZlSW1hZ2VQYXRocyhcbiAgaHRtbDogc3RyaW5nLFxuICBmaWxlUGF0aDogc3RyaW5nIHwgdW5kZWZpbmVkLFxuICBjb3B5SFRNTEZsYWc6IGJvb2xlYW5cbikge1xuICBsZXQgcm9vdERpcmVjdG9yeTogc3RyaW5nXG4gIGlmIChhdG9tLnByb2plY3QgIT0gbnVsbCkge1xuICAgIDtbcm9vdERpcmVjdG9yeV0gPSBBcnJheS5mcm9tKGF0b20ucHJvamVjdC5yZWxhdGl2aXplUGF0aChmaWxlUGF0aCB8fCBcIlwiKSlcbiAgfVxuICBjb25zdCBkb2MgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpXG4gIGRvYy5pbm5lckhUTUwgPSBodG1sXG4gIGRvYy5xdWVyeVNlbGVjdG9yQWxsKFwiaW1nXCIpLmZvckVhY2goZnVuY3Rpb24oaW1nKSB7XG4gICAgbGV0IHNyY1xuICAgIGlmICgoc3JjID0gaW1nLmdldEF0dHJpYnV0ZShcInNyY1wiKSkpIHtcbiAgICAgIGlmICghYXRvbS5jb25maWcuZ2V0KFwibWFya2Rvd24tcHJldmlldy1wbHVzLmVuYWJsZVBhbmRvY1wiKSkge1xuICAgICAgICBzcmMgPSBtYXJrZG93bkl0LmRlY29kZShzcmMpXG4gICAgICB9XG5cbiAgICAgIGlmIChzcmMubWF0Y2goL14oaHR0cHM/fGF0b218ZGF0YSk6LykpIHtcbiAgICAgICAgcmV0dXJuXG4gICAgICB9XG4gICAgICAvLyBAdHMtaWdub3JlXG4gICAgICBpZiAoc3JjLnN0YXJ0c1dpdGgocHJvY2Vzcy5yZXNvdXJjZXNQYXRoKSkge1xuICAgICAgICByZXR1cm5cbiAgICAgIH1cbiAgICAgIGlmIChzcmMuc3RhcnRzV2l0aChyZXNvdXJjZVBhdGgpKSB7XG4gICAgICAgIHJldHVyblxuICAgICAgfVxuICAgICAgaWYgKHNyYy5zdGFydHNXaXRoKHBhY2thZ2VQYXRoKSkge1xuICAgICAgICByZXR1cm5cbiAgICAgIH1cblxuICAgICAgaWYgKHNyY1swXSA9PT0gXCIvXCIpIHtcbiAgICAgICAgaWYgKCFmcy5pc0ZpbGVTeW5jKHNyYykpIHtcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgc3JjID0gcGF0aC5qb2luKHJvb3REaXJlY3RvcnksIHNyYy5zdWJzdHJpbmcoMSkpXG4gICAgICAgICAgfSBjYXRjaCAoZSkge31cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmIChmaWxlUGF0aCkge1xuICAgICAgICBzcmMgPSBwYXRoLnJlc29sdmUocGF0aC5kaXJuYW1lKGZpbGVQYXRoKSwgc3JjKVxuICAgICAgfVxuXG4gICAgICAvLyBVc2UgbW9zdCByZWNlbnQgdmVyc2lvbiBvZiBpbWFnZVxuICAgICAgaWYgKCFjb3B5SFRNTEZsYWcpIHtcbiAgICAgICAgY29uc3QgdiA9IGltYWdlV2F0Y2hlci5nZXRWZXJzaW9uKHNyYywgZmlsZVBhdGgpXG4gICAgICAgIGlmICh2KSB7XG4gICAgICAgICAgc3JjID0gYCR7c3JjfT92PSR7dn1gXG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgcmV0dXJuIChpbWcuc3JjID0gc3JjKVxuICAgIH1cbiAgICByZXR1cm5cbiAgfSlcblxuICByZXR1cm4gZG9jLmlubmVySFRNTFxufVxuXG5leHBvcnQgZnVuY3Rpb24gY29udmVydENvZGVCbG9ja3NUb0F0b21FZGl0b3JzKFxuICBkb21GcmFnbWVudDogSFRNTEVsZW1lbnQsXG4gIGRlZmF1bHRMYW5ndWFnZTogc3RyaW5nXG4pIHtcbiAgbGV0IGZvbnRGYW1pbHlcbiAgaWYgKGRlZmF1bHRMYW5ndWFnZSA9PSBudWxsKSB7XG4gICAgZGVmYXVsdExhbmd1YWdlID0gXCJ0ZXh0XCJcbiAgfVxuICBpZiAoKGZvbnRGYW1pbHkgPSBhdG9tLmNvbmZpZy5nZXQoXCJlZGl0b3IuZm9udEZhbWlseVwiKSkpIHtcbiAgICBmb3IgKGxldCBjb2RlRWxlbWVudCBvZiBBcnJheS5mcm9tKGRvbUZyYWdtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoXCJjb2RlXCIpKSkge1xuICAgICAgY29kZUVsZW1lbnQuc3R5bGUuZm9udEZhbWlseSA9IGZvbnRGYW1pbHlcbiAgICB9XG4gIH1cblxuICBmb3IgKGxldCBwcmVFbGVtZW50IG9mIEFycmF5LmZyb20oZG9tRnJhZ21lbnQucXVlcnlTZWxlY3RvckFsbChcInByZVwiKSkpIHtcbiAgICBjb25zdCBjb2RlQmxvY2sgPVxuICAgICAgcHJlRWxlbWVudC5maXJzdEVsZW1lbnRDaGlsZCAhPSBudWxsXG4gICAgICAgID8gcHJlRWxlbWVudC5maXJzdEVsZW1lbnRDaGlsZFxuICAgICAgICA6IHByZUVsZW1lbnRcbiAgICBjb25zdCBjYkNsYXNzID0gY29kZUJsb2NrLmNsYXNzTmFtZVxuICAgIGNvbnN0IGZlbmNlTmFtZSA9IGNiQ2xhc3NcbiAgICAgID8gY2JDbGFzcy5yZXBsYWNlKC9eKGxhbmctfHNvdXJjZUNvZGUgKS8sIFwiXCIpXG4gICAgICA6IGRlZmF1bHRMYW5ndWFnZVxuXG4gICAgY29uc3QgZWRpdG9yRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXG4gICAgICBcImF0b20tdGV4dC1lZGl0b3JcIlxuICAgICkgYXMgVGV4dEVkaXRvckVsZW1lbnRcbiAgICBlZGl0b3JFbGVtZW50LnNldEF0dHJpYnV0ZU5vZGUoZG9jdW1lbnQuY3JlYXRlQXR0cmlidXRlKFwiZ3V0dGVyLWhpZGRlblwiKSlcbiAgICBlZGl0b3JFbGVtZW50LnJlbW92ZUF0dHJpYnV0ZShcInRhYmluZGV4XCIpIC8vIG1ha2UgcmVhZC1vbmx5XG5cbiAgICBwcmVFbGVtZW50LnBhcmVudEVsZW1lbnQhLnJlcGxhY2VDaGlsZChlZGl0b3JFbGVtZW50LCBwcmVFbGVtZW50KVxuXG4gICAgY29uc3QgZWRpdG9yID0gZWRpdG9yRWxlbWVudC5nZXRNb2RlbCgpXG4gICAgLy8gcmVtb3ZlIHRoZSBkZWZhdWx0IHNlbGVjdGlvbiBvZiBhIGxpbmUgaW4gZWFjaCBlZGl0b3JcbiAgICBpZiAoZWRpdG9yLmN1cnNvckxpbmVEZWNvcmF0aW9ucyAhPSBudWxsKSB7XG4gICAgICBmb3IgKGxldCBjdXJzb3JMaW5lRGVjb3JhdGlvbiBvZiBlZGl0b3IuY3Vyc29yTGluZURlY29yYXRpb25zKSB7XG4gICAgICAgIGN1cnNvckxpbmVEZWNvcmF0aW9uLmRlc3Ryb3koKVxuICAgICAgfVxuICAgIH1cblxuICAgIGVkaXRvci5zZXRUZXh0KGNvZGVCbG9jay50ZXh0Q29udGVudCEucmVwbGFjZSgvXFxuJC8sIFwiXCIpKVxuICAgIGNvbnN0IGdyYW1tYXIgPSBhdG9tLmdyYW1tYXJzLmdyYW1tYXJGb3JTY29wZU5hbWUoXG4gICAgICBzY29wZUZvckZlbmNlTmFtZShmZW5jZU5hbWUpXG4gICAgKVxuICAgIGlmIChncmFtbWFyKSBlZGl0b3Iuc2V0R3JhbW1hcihncmFtbWFyKVxuICB9XG5cbiAgcmV0dXJuIGRvbUZyYWdtZW50XG59XG5cbmZ1bmN0aW9uIHRva2VuaXplQ29kZUJsb2NrcyhodG1sOiBzdHJpbmcsIGRlZmF1bHRMYW5ndWFnZTogc3RyaW5nID0gXCJ0ZXh0XCIpIHtcbiAgbGV0IGZvbnRGYW1pbHk6IHN0cmluZyB8IHVuZGVmaW5lZFxuICBjb25zdCBkb2MgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpXG4gIGRvYy5pbm5lckhUTUwgPSBodG1sXG5cbiAgaWYgKChmb250RmFtaWx5ID0gYXRvbS5jb25maWcuZ2V0KFwiZWRpdG9yLmZvbnRGYW1pbHlcIikpKSB7XG4gICAgZG9jXG4gICAgICAucXVlcnlTZWxlY3RvckFsbChcImNvZGVcIilcbiAgICAgIC5mb3JFYWNoKGNvZGUgPT4gKGNvZGUuc3R5bGUuZm9udEZhbWlseSA9IGZvbnRGYW1pbHkgfHwgbnVsbCkpXG4gIH1cblxuICBkb2MucXVlcnlTZWxlY3RvckFsbChcInByZVwiKS5mb3JFYWNoKGZ1bmN0aW9uKHByZUVsZW1lbnQpIHtcbiAgICBsZXQgbGVmdFxuICAgIGNvbnN0IGNvZGVCbG9jayA9IHByZUVsZW1lbnQuZmlyc3RFbGVtZW50Q2hpbGQgYXMgSFRNTEVsZW1lbnRcbiAgICBjb25zdCBmZW5jZU5hbWUgPVxuICAgICAgKGxlZnQgPSBjb2RlQmxvY2suY2xhc3NOYW1lLnJlcGxhY2UoL14obGFuZy18c291cmNlQ29kZSApLywgXCJcIikpICE9IG51bGxcbiAgICAgICAgPyBsZWZ0XG4gICAgICAgIDogZGVmYXVsdExhbmd1YWdlXG5cbiAgICBjb25zdCBoaWdobGlnaHRlZEh0bWwgPSBoaWdobGlnaHQoe1xuICAgICAgZmlsZUNvbnRlbnRzOiBjb2RlQmxvY2suaW5uZXJUZXh0LFxuICAgICAgc2NvcGVOYW1lOiBzY29wZUZvckZlbmNlTmFtZShmZW5jZU5hbWUpLFxuICAgICAgbmJzcDogZmFsc2UsXG4gICAgICBsaW5lRGl2czogZmFsc2UsXG4gICAgICBlZGl0b3JEaXY6IHRydWUsXG4gICAgICBlZGl0b3JEaXZUYWc6IFwicHJlXCIsXG4gICAgICAvLyBUaGUgYGVkaXRvcmAgY2xhc3MgbWVzc2VzIHRoaW5ncyB1cCBhcyBgLmVkaXRvcmAgaGFzIGFic29sdXRlbHkgcG9zaXRpb25lZCBsaW5lc1xuICAgICAgZWRpdG9yRGl2Q2xhc3M6IGZlbmNlTmFtZVxuICAgICAgICA/IGBlZGl0b3ItY29sb3JzIGxhbmctJHtmZW5jZU5hbWV9YFxuICAgICAgICA6IFwiZWRpdG9yLWNvbG9yc1wiXG4gICAgfSlcblxuICAgIHJldHVybiAocHJlRWxlbWVudC5vdXRlckhUTUwgPSBoaWdobGlnaHRlZEh0bWwpXG4gIH0pXG5cbiAgcmV0dXJuIGRvYy5pbm5lckhUTUxcbn1cbiJdfQ==