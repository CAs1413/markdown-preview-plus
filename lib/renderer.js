"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const pandocHelper = require("./pandoc-helper");
const markdownIt = require("./markdown-it-helper");
const extension_helper_1 = require("./extension-helper");
const atom_1 = require("atom");
const util_1 = require("./util");
const util_common_1 = require("./util-common");
const { resourcePath } = atom.getLoadSettings();
const packagePath = path.dirname(__dirname);
async function render(options) {
    const text = options.text.replace(/^\s*<!doctype(\s+.*)?>\s*/i, '');
    let html;
    let error;
    if (util_1.atomConfig().renderer === 'pandoc') {
        try {
            html = await pandocHelper.renderPandoc(text, options.filePath, options.renderLaTeX);
        }
        catch (err) {
            const e = err;
            if (e.html === undefined)
                throw e;
            error = e.message;
            html = e.html;
        }
    }
    else {
        html = markdownIt.render(text, options.renderLaTeX);
    }
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    sanitize(doc);
    if (options.mode === 'normal') {
        options.imageWatcher.clear();
        resolveImagePaths(doc, options.filePath, false, undefined, options.imageWatcher);
    }
    else {
        switch (options.mode) {
            case 'save':
                handleImages({
                    doc,
                    filePath: options.filePath,
                    savePath: options.savePath,
                    behaviour: util_1.atomConfig().saveConfig.mediaOnSaveAsHTMLBehaviour,
                });
                break;
            case 'copy':
                handleImages({
                    doc,
                    filePath: options.filePath,
                    behaviour: util_1.atomConfig().saveConfig.mediaOnCopyAsHTMLBehaviour,
                });
                break;
            default:
                throw invalidMode(options.mode);
        }
    }
    let defaultCodeLanguage = 'text';
    if ((options.grammar && options.grammar.scopeName) === 'source.litcoffee') {
        defaultCodeLanguage = 'coffee';
    }
    if (!(util_1.atomConfig().renderer === 'pandoc' &&
        util_1.atomConfig().pandocConfig.useNativePandocCodeStyles)) {
        await highlightCodeBlocks(doc, defaultCodeLanguage);
    }
    if (error) {
        const errd = doc.createElement('div');
        const msgel = doc.createElement('code');
        msgel.innerText = error;
        errd.innerHTML = `<h1>Pandoc Error:</h1>${msgel.outerHTML}<hr>`;
        doc.body.insertBefore(errd, doc.body.firstElementChild);
    }
    return doc;
}
exports.render = render;
function invalidMode(mode) {
    return new Error(`Invalid render mode ${JSON.stringify(mode)}`);
}
function sanitize(doc) {
    doc.querySelectorAll("script:not([type^='math/tex'])").forEach((elem) => {
        elem.remove();
    });
    const attributesToRemove = [
        'onabort',
        'onblur',
        'onchange',
        'onclick',
        'ondbclick',
        'onerror',
        'onfocus',
        'onkeydown',
        'onkeypress',
        'onkeyup',
        'onload',
        'onmousedown',
        'onmousemove',
        'onmouseover',
        'onmouseout',
        'onmouseup',
        'onreset',
        'onresize',
        'onscroll',
        'onselect',
        'onsubmit',
        'onunload',
    ];
    doc.querySelectorAll('*').forEach((elem) => attributesToRemove.map((attribute) => {
        elem.removeAttribute(attribute);
    }));
}
function handleImages(opts) {
    const relativize = opts.behaviour === 'relativized';
    switch (opts.behaviour) {
        case 'relativized':
        case 'absolutized':
            resolveImagePaths(opts.doc, opts.filePath, relativize, opts.savePath);
            break;
        case 'untouched':
    }
}
function resolveImagePaths(doc, filePath, relativize, savePath, imageWatcher) {
    const [rootDirectory] = atom.project.relativizePath(filePath || '');
    const media = util_common_1.getMedia(doc);
    Array.from(media).map(function (img) {
        let src = img.getAttribute('src');
        if (src) {
            if (util_1.atomConfig().renderer !== 'pandoc') {
                src = decodeURI(src);
            }
            if (src.match(/^(https?|atom|data):/)) {
                return;
            }
            if (process.resourcesPath && src.startsWith(process.resourcesPath)) {
                return;
            }
            if (src.startsWith(resourcePath)) {
                return;
            }
            if (src.startsWith(packagePath)) {
                return;
            }
            if (src[0] === '/') {
                if (!util_1.isFileSync(src)) {
                    try {
                        if (rootDirectory !== null) {
                            src = path.join(rootDirectory, src.substring(1));
                        }
                    }
                    catch (e) {
                    }
                }
            }
            else if (filePath) {
                src = path.resolve(path.dirname(filePath), src);
            }
            if (relativize && (filePath !== undefined || savePath !== undefined)) {
                const fp = savePath !== undefined ? savePath : filePath;
                src = path.relative(path.dirname(fp), src);
            }
            if (imageWatcher) {
                const v = imageWatcher.watch(src);
                if (v !== undefined)
                    src = `${src}?v=${v}`;
            }
            img.src = src;
        }
    });
}
async function highlightCodeBlocks(domFragment, defaultLanguage) {
    const fontFamily = atom.config.get('editor.fontFamily');
    if (fontFamily) {
        for (const codeElement of Array.from(domFragment.querySelectorAll('code'))) {
            codeElement.style.fontFamily = fontFamily;
        }
    }
    await Promise.all(Array.from(domFragment.querySelectorAll('pre')).map(async (preElement) => {
        const codeBlock = preElement.firstElementChild !== null
            ? preElement.firstElementChild
            : preElement;
        const cbClass = codeBlock.className || preElement.className;
        const fenceName = cbClass
            ? cbClass.replace(/^(lang-|sourceCode )/, '')
            : defaultLanguage;
        const ctw = util_1.atomConfig().codeTabWidth;
        const ed = new atom_1.TextEditor({
            readonly: true,
            keyboardInputEnabled: false,
            showInvisibles: false,
            tabLength: ctw === 0 ? atom.config.get('editor.tabLength') : ctw,
        });
        const el = atom.views.getView(ed);
        try {
            el.setUpdatedSynchronously(true);
            el.style.pointerEvents = 'none';
            el.style.position = 'absolute';
            el.style.width = '0px';
            el.style.height = '1px';
            atom.views.getView(atom.workspace).appendChild(el);
            atom.grammars.assignLanguageMode(ed.getBuffer(), extension_helper_1.scopeForFenceName(fenceName));
            ed.setText(codeBlock.textContent.replace(/\r?\n$/, ''));
            await editorTokenized(ed);
            const html = Array.from(el.querySelectorAll('.line:not(.dummy)'));
            preElement.classList.add('editor-colors');
            preElement.innerHTML = html.map((x) => x.innerHTML).join('\n');
            if (fenceName)
                preElement.classList.add(`lang-${fenceName}`);
        }
        finally {
            el.remove();
        }
    }));
    return domFragment;
}
async function editorTokenized(editor) {
    return new Promise((resolve) => {
        if (editor.getBuffer().getLanguageMode().fullyTokenized) {
            resolve();
        }
        else {
            const disp = editor.onDidTokenize(() => {
                disp.dispose();
                resolve();
            });
        }
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVuZGVyZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcmVuZGVyZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw2QkFBNkI7QUFDN0IsZ0RBQWdEO0FBQ2hELG1EQUFtRDtBQUNuRCx5REFBc0Q7QUFDdEQsK0JBQTBDO0FBQzFDLGlDQUErQztBQUMvQywrQ0FBd0M7QUFHeEMsTUFBTSxFQUFFLFlBQVksRUFBRSxHQUFHLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQTtBQUMvQyxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFBO0FBaUJwQyxLQUFLLFVBQVUsTUFBTSxDQUFDLE9BQXNCO0lBR2pELE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLDRCQUE0QixFQUFFLEVBQUUsQ0FBQyxDQUFBO0lBRW5FLElBQUksSUFBSSxDQUFBO0lBQ1IsSUFBSSxLQUFLLENBQUE7SUFDVCxJQUFJLGlCQUFVLEVBQUUsQ0FBQyxRQUFRLEtBQUssUUFBUSxFQUFFO1FBQ3RDLElBQUk7WUFDRixJQUFJLEdBQUcsTUFBTSxZQUFZLENBQUMsWUFBWSxDQUNwQyxJQUFJLEVBQ0osT0FBTyxDQUFDLFFBQVEsRUFDaEIsT0FBTyxDQUFDLFdBQVcsQ0FDcEIsQ0FBQTtTQUNGO1FBQUMsT0FBTyxHQUFHLEVBQUU7WUFDWixNQUFNLENBQUMsR0FBRyxHQUFnQyxDQUFBO1lBQzFDLElBQUksQ0FBQyxDQUFDLElBQUksS0FBSyxTQUFTO2dCQUFFLE1BQU0sQ0FBQyxDQUFBO1lBQ2pDLEtBQUssR0FBRyxDQUFDLENBQUMsT0FBaUIsQ0FBQTtZQUMzQixJQUFJLEdBQUcsQ0FBQyxDQUFDLElBQWMsQ0FBQTtTQUN4QjtLQUNGO1NBQU07UUFDTCxJQUFJLEdBQUcsVUFBVSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFBO0tBQ3BEO0lBQ0Qs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QUFDSixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHBhdGggPSByZXF1aXJlKCdwYXRoJylcbmltcG9ydCBwYW5kb2NIZWxwZXIgPSByZXF1aXJlKCcuL3BhbmRvYy1oZWxwZXInKVxuaW1wb3J0IG1hcmtkb3duSXQgPSByZXF1aXJlKCcuL21hcmtkb3duLWl0LWhlbHBlcicpIC8vIERlZmVyIHVudGlsIHVzZWRcbmltcG9ydCB7IHNjb3BlRm9yRmVuY2VOYW1lIH0gZnJvbSAnLi9leHRlbnNpb24taGVscGVyJ1xuaW1wb3J0IHsgR3JhbW1hciwgVGV4dEVkaXRvciB9IGZyb20gJ2F0b20nXG5pbXBvcnQgeyBpc0ZpbGVTeW5jLCBhdG9tQ29uZmlnIH0gZnJvbSAnLi91dGlsJ1xuaW1wb3J0IHsgZ2V0TWVkaWEgfSBmcm9tICcuL3V0aWwtY29tbW9uJ1xuaW1wb3J0IHsgSW1hZ2VXYXRjaGVyIH0gZnJvbSAnLi9pbWFnZS13YXRjaC1oZWxwZXInXG5cbmNvbnN0IHsgcmVzb3VyY2VQYXRoIH0gPSBhdG9tLmdldExvYWRTZXR0aW5ncygpXG5jb25zdCBwYWNrYWdlUGF0aCA9IHBhdGguZGlybmFtZShfX2Rpcm5hbWUpXG5cbmV4cG9ydCB0eXBlIFJlbmRlck1vZGUgPSAnbm9ybWFsJyB8ICdjb3B5JyB8ICdzYXZlJ1xuXG5leHBvcnQgaW50ZXJmYWNlIENvbW1vblJlbmRlck9wdGlvbnM8VCBleHRlbmRzIFJlbmRlck1vZGU+IHtcbiAgdGV4dDogc3RyaW5nXG4gIGZpbGVQYXRoOiBzdHJpbmcgfCB1bmRlZmluZWRcbiAgZ3JhbW1hcj86IEdyYW1tYXJcbiAgcmVuZGVyTGFUZVg6IGJvb2xlYW5cbiAgbW9kZTogVFxufVxuXG5leHBvcnQgdHlwZSBSZW5kZXJPcHRpb25zID1cbiAgfCAoQ29tbW9uUmVuZGVyT3B0aW9uczwnbm9ybWFsJyB8ICdjb3B5Jz4gJiB7IGltYWdlV2F0Y2hlcjogSW1hZ2VXYXRjaGVyIH0pXG4gIHwgKENvbW1vblJlbmRlck9wdGlvbnM8J3NhdmUnPiAmIHsgc2F2ZVBhdGg6IHN0cmluZyB9KVxuICB8IChDb21tb25SZW5kZXJPcHRpb25zPCdjb3B5Jz4pXG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiByZW5kZXIob3B0aW9uczogUmVuZGVyT3B0aW9ucyk6IFByb21pc2U8SFRNTERvY3VtZW50PiB7XG4gIC8vIFJlbW92ZSB0aGUgPCFkb2N0eXBlPiBzaW5jZSBvdGhlcndpc2UgbWFya2VkIHdpbGwgZXNjYXBlIGl0XG4gIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9jaGpqL21hcmtlZC9pc3N1ZXMvMzU0XG4gIGNvbnN0IHRleHQgPSBvcHRpb25zLnRleHQucmVwbGFjZSgvXlxccyo8IWRvY3R5cGUoXFxzKy4qKT8+XFxzKi9pLCAnJylcblxuICBsZXQgaHRtbFxuICBsZXQgZXJyb3JcbiAgaWYgKGF0b21Db25maWcoKS5yZW5kZXJlciA9PT0gJ3BhbmRvYycpIHtcbiAgICB0cnkge1xuICAgICAgaHRtbCA9IGF3YWl0IHBhbmRvY0hlbHBlci5yZW5kZXJQYW5kb2MoXG4gICAgICAgIHRleHQsXG4gICAgICAgIG9wdGlvbnMuZmlsZVBhdGgsXG4gICAgICAgIG9wdGlvbnMucmVuZGVyTGFUZVgsXG4gICAgICApXG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBjb25zdCBlID0gZXJyIGFzIEVycm9yICYgeyBodG1sPzogc3RyaW5nIH1cbiAgICAgIGlmIChlLmh0bWwgPT09IHVuZGVmaW5lZCkgdGhyb3cgZVxuICAgICAgZXJyb3IgPSBlLm1lc3NhZ2UgYXMgc3RyaW5nXG4gICAgICBodG1sID0gZS5odG1sIGFzIHN0cmluZ1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBodG1sID0gbWFya2Rvd25JdC5yZW5kZXIodGV4dCwgb3B0aW9ucy5yZW5kZXJMYVRlWClcbiAgfVxuICBjb25zdCBwYXJzZXIgPSBuZXcgRE9NUGFyc2VyKClcbiAgY29uc3QgZG9jID0gcGFyc2VyLnBhcnNlRnJvbVN0cmluZyhodG1sLCAndGV4dC9odG1sJylcbiAgc2FuaXRpemUoZG9jKVxuICBpZiAob3B0aW9ucy5tb2RlID09PSAnbm9ybWFsJykge1xuICAgIG9wdGlvbnMuaW1hZ2VXYXRjaGVyLmNsZWFyKClcbiAgICByZXNvbHZlSW1hZ2VQYXRocyhcbiAgICAgIGRvYyxcbiAgICAgIG9wdGlvbnMuZmlsZVBhdGgsXG4gICAgICBmYWxzZSxcbiAgICAgIHVuZGVmaW5lZCxcbiAgICAgIG9wdGlvbnMuaW1hZ2VXYXRjaGVyLFxuICAgIClcbiAgfSBlbHNlIHtcbiAgICBzd2l0Y2ggKG9wdGlvbnMubW9kZSkge1xuICAgICAgY2FzZSAnc2F2ZSc6XG4gICAgICAgIGhhbmRsZUltYWdlcyh7XG4gICAgICAgICAgZG9jLFxuICAgICAgICAgIGZpbGVQYXRoOiBvcHRpb25zLmZpbGVQYXRoLFxuICAgICAgICAgIHNhdmVQYXRoOiBvcHRpb25zLnNhdmVQYXRoLFxuICAgICAgICAgIGJlaGF2aW91cjogYXRvbUNvbmZpZygpLnNhdmVDb25maWcubWVkaWFPblNhdmVBc0hUTUxCZWhhdmlvdXIsXG4gICAgICAgIH0pXG4gICAgICAgIGJyZWFrXG4gICAgICBjYXNlICdjb3B5JzpcbiAgICAgICAgaGFuZGxlSW1hZ2VzKHtcbiAgICAgICAgICBkb2MsXG4gICAgICAgICAgZmlsZVBhdGg6IG9wdGlvbnMuZmlsZVBhdGgsXG4gICAgICAgICAgYmVoYXZpb3VyOiBhdG9tQ29uZmlnKCkuc2F2ZUNvbmZpZy5tZWRpYU9uQ29weUFzSFRNTEJlaGF2aW91cixcbiAgICAgICAgfSlcbiAgICAgICAgYnJlYWtcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHRocm93IGludmFsaWRNb2RlKG9wdGlvbnMubW9kZSlcbiAgICB9XG4gIH1cbiAgbGV0IGRlZmF1bHRDb2RlTGFuZ3VhZ2U6IHN0cmluZyA9ICd0ZXh0J1xuICAvLyBEZWZhdWx0IGNvZGUgYmxvY2tzIHRvIGJlIGNvZmZlZSBpbiBMaXRlcmF0ZSBDb2ZmZWVTY3JpcHQgZmlsZXNcbiAgaWYgKChvcHRpb25zLmdyYW1tYXIgJiYgb3B0aW9ucy5ncmFtbWFyLnNjb3BlTmFtZSkgPT09ICdzb3VyY2UubGl0Y29mZmVlJykge1xuICAgIGRlZmF1bHRDb2RlTGFuZ3VhZ2UgPSAnY29mZmVlJ1xuICB9XG4gIGlmIChcbiAgICAhKFxuICAgICAgYXRvbUNvbmZpZygpLnJlbmRlcmVyID09PSAncGFuZG9jJyAmJlxuICAgICAgYXRvbUNvbmZpZygpLnBhbmRvY0NvbmZpZy51c2VOYXRpdmVQYW5kb2NDb2RlU3R5bGVzXG4gICAgKVxuICApIHtcbiAgICBhd2FpdCBoaWdobGlnaHRDb2RlQmxvY2tzKGRvYywgZGVmYXVsdENvZGVMYW5ndWFnZSlcbiAgfVxuICBpZiAoZXJyb3IpIHtcbiAgICBjb25zdCBlcnJkID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ2RpdicpXG4gICAgY29uc3QgbXNnZWwgPSBkb2MuY3JlYXRlRWxlbWVudCgnY29kZScpXG4gICAgbXNnZWwuaW5uZXJUZXh0ID0gZXJyb3JcbiAgICBlcnJkLmlubmVySFRNTCA9IGA8aDE+UGFuZG9jIEVycm9yOjwvaDE+JHttc2dlbC5vdXRlckhUTUx9PGhyPmBcbiAgICBkb2MuYm9keS5pbnNlcnRCZWZvcmUoZXJyZCwgZG9jLmJvZHkuZmlyc3RFbGVtZW50Q2hpbGQpXG4gIH1cbiAgcmV0dXJuIGRvY1xufVxuXG5mdW5jdGlvbiBpbnZhbGlkTW9kZShtb2RlOiBuZXZlcikge1xuICByZXR1cm4gbmV3IEVycm9yKGBJbnZhbGlkIHJlbmRlciBtb2RlICR7SlNPTi5zdHJpbmdpZnkobW9kZSl9YClcbn1cblxuZnVuY3Rpb24gc2FuaXRpemUoZG9jOiBIVE1MRG9jdW1lbnQpIHtcbiAgLy8gRG8gbm90IHJlbW92ZSBNYXRoSmF4IHNjcmlwdCBkZWxpbWl0ZWQgYmxvY2tzXG4gIGRvYy5xdWVyeVNlbGVjdG9yQWxsKFwic2NyaXB0Om5vdChbdHlwZV49J21hdGgvdGV4J10pXCIpLmZvckVhY2goKGVsZW0pID0+IHtcbiAgICBlbGVtLnJlbW92ZSgpXG4gIH0pXG4gIGNvbnN0IGF0dHJpYnV0ZXNUb1JlbW92ZSA9IFtcbiAgICAnb25hYm9ydCcsXG4gICAgJ29uYmx1cicsXG4gICAgJ29uY2hhbmdlJyxcbiAgICAnb25jbGljaycsXG4gICAgJ29uZGJjbGljaycsXG4gICAgJ29uZXJyb3InLFxuICAgICdvbmZvY3VzJyxcbiAgICAnb25rZXlkb3duJyxcbiAgICAnb25rZXlwcmVzcycsXG4gICAgJ29ua2V5dXAnLFxuICAgICdvbmxvYWQnLFxuICAgICdvbm1vdXNlZG93bicsXG4gICAgJ29ubW91c2Vtb3ZlJyxcbiAgICAnb25tb3VzZW92ZXInLFxuICAgICdvbm1vdXNlb3V0JyxcbiAgICAnb25tb3VzZXVwJyxcbiAgICAnb25yZXNldCcsXG4gICAgJ29ucmVzaXplJyxcbiAgICAnb25zY3JvbGwnLFxuICAgICdvbnNlbGVjdCcsXG4gICAgJ29uc3VibWl0JyxcbiAgICAnb251bmxvYWQnLFxuICBdXG4gIGRvYy5xdWVyeVNlbGVjdG9yQWxsKCcqJykuZm9yRWFjaCgoZWxlbSkgPT5cbiAgICBhdHRyaWJ1dGVzVG9SZW1vdmUubWFwKChhdHRyaWJ1dGUpID0+IHtcbiAgICAgIGVsZW0ucmVtb3ZlQXR0cmlidXRlKGF0dHJpYnV0ZSlcbiAgICB9KSxcbiAgKVxufVxuXG5mdW5jdGlvbiBoYW5kbGVJbWFnZXMob3B0czoge1xuICBiZWhhdmlvdXI6ICdyZWxhdGl2aXplZCcgfCAnYWJzb2x1dGl6ZWQnIHwgJ3VudG91Y2hlZCdcbiAgZG9jOiBIVE1MRG9jdW1lbnRcbiAgZmlsZVBhdGg/OiBzdHJpbmdcbiAgc2F2ZVBhdGg/OiBzdHJpbmdcbn0pIHtcbiAgY29uc3QgcmVsYXRpdml6ZSA9IG9wdHMuYmVoYXZpb3VyID09PSAncmVsYXRpdml6ZWQnXG4gIHN3aXRjaCAob3B0cy5iZWhhdmlvdXIpIHtcbiAgICBjYXNlICdyZWxhdGl2aXplZCc6XG4gICAgY2FzZSAnYWJzb2x1dGl6ZWQnOlxuICAgICAgcmVzb2x2ZUltYWdlUGF0aHMob3B0cy5kb2MsIG9wdHMuZmlsZVBhdGgsIHJlbGF0aXZpemUsIG9wdHMuc2F2ZVBhdGgpXG4gICAgICBicmVha1xuICAgIGNhc2UgJ3VudG91Y2hlZCc6XG4gICAgLyogbm9vcCAqL1xuICB9XG59XG5cbmZ1bmN0aW9uIHJlc29sdmVJbWFnZVBhdGhzKFxuICBkb2M6IEhUTUxEb2N1bWVudCxcbiAgZmlsZVBhdGg6IHN0cmluZyB8IHVuZGVmaW5lZCxcbiAgcmVsYXRpdml6ZTogYm9vbGVhbixcbiAgc2F2ZVBhdGg/OiBzdHJpbmcsXG4gIGltYWdlV2F0Y2hlcj86IEltYWdlV2F0Y2hlcixcbikge1xuICBjb25zdCBbcm9vdERpcmVjdG9yeV0gPSBhdG9tLnByb2plY3QucmVsYXRpdml6ZVBhdGgoZmlsZVBhdGggfHwgJycpXG4gIGNvbnN0IG1lZGlhID0gZ2V0TWVkaWEoZG9jKVxuICBBcnJheS5mcm9tKG1lZGlhKS5tYXAoZnVuY3Rpb24oaW1nKSB7XG4gICAgbGV0IHNyYyA9IGltZy5nZXRBdHRyaWJ1dGUoJ3NyYycpXG4gICAgaWYgKHNyYykge1xuICAgICAgaWYgKGF0b21Db25maWcoKS5yZW5kZXJlciAhPT0gJ3BhbmRvYycpIHtcbiAgICAgICAgc3JjID0gZGVjb2RlVVJJKHNyYylcbiAgICAgIH1cblxuICAgICAgaWYgKHNyYy5tYXRjaCgvXihodHRwcz98YXRvbXxkYXRhKTovKSkge1xuICAgICAgICByZXR1cm5cbiAgICAgIH1cbiAgICAgIGlmIChwcm9jZXNzLnJlc291cmNlc1BhdGggJiYgc3JjLnN0YXJ0c1dpdGgocHJvY2Vzcy5yZXNvdXJjZXNQYXRoKSkge1xuICAgICAgICByZXR1cm5cbiAgICAgIH1cbiAgICAgIGlmIChzcmMuc3RhcnRzV2l0aChyZXNvdXJjZVBhdGgpKSB7XG4gICAgICAgIHJldHVyblxuICAgICAgfVxuICAgICAgaWYgKHNyYy5zdGFydHNXaXRoKHBhY2thZ2VQYXRoKSkge1xuICAgICAgICByZXR1cm5cbiAgICAgIH1cblxuICAgICAgaWYgKHNyY1swXSA9PT0gJy8nKSB7XG4gICAgICAgIGlmICghaXNGaWxlU3luYyhzcmMpKSB7XG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGlmIChyb290RGlyZWN0b3J5ICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgIHNyYyA9IHBhdGguam9pbihyb290RGlyZWN0b3J5LCBzcmMuc3Vic3RyaW5nKDEpKVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIC8vIG5vb3BcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAoZmlsZVBhdGgpIHtcbiAgICAgICAgc3JjID0gcGF0aC5yZXNvbHZlKHBhdGguZGlybmFtZShmaWxlUGF0aCksIHNyYylcbiAgICAgIH1cblxuICAgICAgaWYgKHJlbGF0aXZpemUgJiYgKGZpbGVQYXRoICE9PSB1bmRlZmluZWQgfHwgc2F2ZVBhdGggIT09IHVuZGVmaW5lZCkpIHtcbiAgICAgICAgY29uc3QgZnAgPSBzYXZlUGF0aCAhPT0gdW5kZWZpbmVkID8gc2F2ZVBhdGggOiBmaWxlUGF0aCFcbiAgICAgICAgc3JjID0gcGF0aC5yZWxhdGl2ZShwYXRoLmRpcm5hbWUoZnApLCBzcmMpXG4gICAgICB9XG5cbiAgICAgIC8vIFdhdGNoIGltYWdlIGZvciBjaGFuZ2VzXG4gICAgICBpZiAoaW1hZ2VXYXRjaGVyKSB7XG4gICAgICAgIGNvbnN0IHYgPSBpbWFnZVdhdGNoZXIud2F0Y2goc3JjKVxuICAgICAgICBpZiAodiAhPT0gdW5kZWZpbmVkKSBzcmMgPSBgJHtzcmN9P3Y9JHt2fWBcbiAgICAgIH1cblxuICAgICAgaW1nLnNyYyA9IHNyY1xuICAgIH1cbiAgfSlcbn1cblxuYXN5bmMgZnVuY3Rpb24gaGlnaGxpZ2h0Q29kZUJsb2NrcyhcbiAgZG9tRnJhZ21lbnQ6IERvY3VtZW50LFxuICBkZWZhdWx0TGFuZ3VhZ2U6IHN0cmluZyxcbikge1xuICBjb25zdCBmb250RmFtaWx5ID0gYXRvbS5jb25maWcuZ2V0KCdlZGl0b3IuZm9udEZhbWlseScpXG4gIGlmIChmb250RmFtaWx5KSB7XG4gICAgZm9yIChjb25zdCBjb2RlRWxlbWVudCBvZiBBcnJheS5mcm9tKFxuICAgICAgZG9tRnJhZ21lbnQucXVlcnlTZWxlY3RvckFsbCgnY29kZScpLFxuICAgICkpIHtcbiAgICAgIGNvZGVFbGVtZW50LnN0eWxlLmZvbnRGYW1pbHkgPSBmb250RmFtaWx5XG4gICAgfVxuICB9XG5cbiAgYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgQXJyYXkuZnJvbShkb21GcmFnbWVudC5xdWVyeVNlbGVjdG9yQWxsKCdwcmUnKSkubWFwKGFzeW5jIChwcmVFbGVtZW50KSA9PiB7XG4gICAgICBjb25zdCBjb2RlQmxvY2sgPVxuICAgICAgICBwcmVFbGVtZW50LmZpcnN0RWxlbWVudENoaWxkICE9PSBudWxsXG4gICAgICAgICAgPyBwcmVFbGVtZW50LmZpcnN0RWxlbWVudENoaWxkXG4gICAgICAgICAgOiBwcmVFbGVtZW50XG4gICAgICBjb25zdCBjYkNsYXNzID0gY29kZUJsb2NrLmNsYXNzTmFtZSB8fCBwcmVFbGVtZW50LmNsYXNzTmFtZVxuICAgICAgY29uc3QgZmVuY2VOYW1lID0gY2JDbGFzc1xuICAgICAgICA/IGNiQ2xhc3MucmVwbGFjZSgvXihsYW5nLXxzb3VyY2VDb2RlICkvLCAnJylcbiAgICAgICAgOiBkZWZhdWx0TGFuZ3VhZ2VcblxuICAgICAgY29uc3QgY3R3ID0gYXRvbUNvbmZpZygpLmNvZGVUYWJXaWR0aFxuICAgICAgY29uc3QgZWQgPSBuZXcgVGV4dEVkaXRvcih7XG4gICAgICAgIHJlYWRvbmx5OiB0cnVlLFxuICAgICAgICBrZXlib2FyZElucHV0RW5hYmxlZDogZmFsc2UsXG4gICAgICAgIHNob3dJbnZpc2libGVzOiBmYWxzZSxcbiAgICAgICAgdGFiTGVuZ3RoOiBjdHcgPT09IDAgPyBhdG9tLmNvbmZpZy5nZXQoJ2VkaXRvci50YWJMZW5ndGgnKSA6IGN0dyxcbiAgICAgIH0pXG4gICAgICBjb25zdCBlbCA9IGF0b20udmlld3MuZ2V0VmlldyhlZClcbiAgICAgIHRyeSB7XG4gICAgICAgIGVsLnNldFVwZGF0ZWRTeW5jaHJvbm91c2x5KHRydWUpXG4gICAgICAgIGVsLnN0eWxlLnBvaW50ZXJFdmVudHMgPSAnbm9uZSdcbiAgICAgICAgZWwuc3R5bGUucG9zaXRpb24gPSAnYWJzb2x1dGUnXG4gICAgICAgIGVsLnN0eWxlLndpZHRoID0gJzBweCdcbiAgICAgICAgZWwuc3R5bGUuaGVpZ2h0ID0gJzFweCdcbiAgICAgICAgYXRvbS52aWV3cy5nZXRWaWV3KGF0b20ud29ya3NwYWNlKS5hcHBlbmRDaGlsZChlbClcbiAgICAgICAgYXRvbS5ncmFtbWFycy5hc3NpZ25MYW5ndWFnZU1vZGUoXG4gICAgICAgICAgZWQuZ2V0QnVmZmVyKCksXG4gICAgICAgICAgc2NvcGVGb3JGZW5jZU5hbWUoZmVuY2VOYW1lKSxcbiAgICAgICAgKVxuICAgICAgICBlZC5zZXRUZXh0KGNvZGVCbG9jay50ZXh0Q29udGVudCEucmVwbGFjZSgvXFxyP1xcbiQvLCAnJykpXG4gICAgICAgIGF3YWl0IGVkaXRvclRva2VuaXplZChlZClcbiAgICAgICAgY29uc3QgaHRtbCA9IEFycmF5LmZyb20oZWwucXVlcnlTZWxlY3RvckFsbCgnLmxpbmU6bm90KC5kdW1teSknKSlcbiAgICAgICAgcHJlRWxlbWVudC5jbGFzc0xpc3QuYWRkKCdlZGl0b3ItY29sb3JzJylcbiAgICAgICAgcHJlRWxlbWVudC5pbm5lckhUTUwgPSBodG1sLm1hcCgoeCkgPT4geC5pbm5lckhUTUwpLmpvaW4oJ1xcbicpXG4gICAgICAgIGlmIChmZW5jZU5hbWUpIHByZUVsZW1lbnQuY2xhc3NMaXN0LmFkZChgbGFuZy0ke2ZlbmNlTmFtZX1gKVxuICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgZWwucmVtb3ZlKClcbiAgICAgIH1cbiAgICB9KSxcbiAgKVxuXG4gIHJldHVybiBkb21GcmFnbWVudFxufVxuXG5hc3luYyBmdW5jdGlvbiBlZGl0b3JUb2tlbml6ZWQoZWRpdG9yOiBUZXh0RWRpdG9yKSB7XG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgIGlmIChlZGl0b3IuZ2V0QnVmZmVyKCkuZ2V0TGFuZ3VhZ2VNb2RlKCkuZnVsbHlUb2tlbml6ZWQpIHtcbiAgICAgIHJlc29sdmUoKVxuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBkaXNwID0gZWRpdG9yLm9uRGlkVG9rZW5pemUoKCkgPT4ge1xuICAgICAgICBkaXNwLmRpc3Bvc2UoKVxuICAgICAgICByZXNvbHZlKClcbiAgICAgIH0pXG4gICAgfVxuICB9KVxufVxuIl19