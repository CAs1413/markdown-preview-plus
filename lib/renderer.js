"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const pandocHelper = require("./pandoc-helper");
const markdownIt = require("./markdown-it-helper");
const extension_helper_1 = require("./extension-helper");
const atom_1 = require("atom");
const util_1 = require("./util");
const util_common_1 = require("./util-common");
const { resourcePath } = atom.getLoadSettings();
const packagePath = path.dirname(__dirname);
async function render(options) {
    const text = options.text.replace(/^\s*<!doctype(\s+.*)?>\s*/i, '');
    let html;
    let error;
    if (util_1.atomConfig().renderer === 'pandoc') {
        try {
            html = await pandocHelper.renderPandoc(text, options.filePath, options.renderLaTeX, options.mode === 'normal');
        }
        catch (err) {
            const e = err;
            if (e.html === undefined)
                throw e;
            error = e.message;
            html = e.html;
        }
    }
    else {
        html = markdownIt.render(text, options.renderLaTeX);
    }
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    sanitize(doc);
    if (options.mode === 'normal') {
        if (options.imageWatcher)
            options.imageWatcher.clear();
        resolveImagePaths(doc, options.filePath, false, undefined, options.imageWatcher);
    }
    else {
        switch (options.mode) {
            case 'save':
                handleImages({
                    doc,
                    filePath: options.filePath,
                    savePath: options.savePath,
                    behaviour: util_1.atomConfig().saveConfig.mediaOnSaveAsHTMLBehaviour,
                });
                break;
            case 'copy':
                handleImages({
                    doc,
                    filePath: options.filePath,
                    behaviour: util_1.atomConfig().saveConfig.mediaOnCopyAsHTMLBehaviour,
                });
                break;
            default:
                throw invalidMode(options);
        }
    }
    let defaultCodeLanguage = 'text';
    if ((options.grammar && options.grammar.scopeName) === 'source.litcoffee') {
        defaultCodeLanguage = 'coffee';
    }
    if (!(util_1.atomConfig().renderer === 'pandoc' &&
        util_1.atomConfig().pandocConfig.useNativePandocCodeStyles)) {
        await highlightCodeBlocks(doc, defaultCodeLanguage);
    }
    if (error) {
        const errd = doc.createElement('div');
        const msgel = doc.createElement('code');
        msgel.innerText = error;
        errd.innerHTML = `<h1>Pandoc Error:</h1>${msgel.outerHTML}<hr>`;
        doc.body.insertBefore(errd, doc.body.firstElementChild);
    }
    return doc;
}
exports.render = render;
function invalidMode(mode) {
    return new Error(`Invalid render mode ${JSON.stringify(mode)}`);
}
function sanitize(doc) {
    doc.querySelectorAll("script:not([type^='math/tex'])").forEach((elem) => {
        elem.remove();
    });
    const attributesToRemove = [
        'onabort',
        'onblur',
        'onchange',
        'onclick',
        'ondbclick',
        'onerror',
        'onfocus',
        'onkeydown',
        'onkeypress',
        'onkeyup',
        'onload',
        'onmousedown',
        'onmousemove',
        'onmouseover',
        'onmouseout',
        'onmouseup',
        'onreset',
        'onresize',
        'onscroll',
        'onselect',
        'onsubmit',
        'onunload',
    ];
    doc.querySelectorAll('*').forEach((elem) => attributesToRemove.map((attribute) => {
        elem.removeAttribute(attribute);
    }));
}
function handleImages(opts) {
    const relativize = opts.behaviour === 'relativized';
    switch (opts.behaviour) {
        case 'relativized':
        case 'absolutized':
            resolveImagePaths(opts.doc, opts.filePath, relativize, opts.savePath);
            break;
        case 'untouched':
    }
}
function resolveImagePaths(doc, filePath, relativize, savePath, imageWatcher) {
    const [rootDirectory] = atom.project.relativizePath(filePath || '');
    const media = util_common_1.getMedia(doc);
    Array.from(media).map(function (img) {
        let attrName;
        if (img.tagName === 'LINK')
            attrName = 'href';
        else
            attrName = 'src';
        let src = img.getAttribute(attrName);
        if (src) {
            if (util_1.atomConfig().renderer !== 'pandoc') {
                src = decodeURI(src);
            }
            if (src.match(/^(https?|atom|data):/)) {
                return;
            }
            if (process.resourcesPath && src.startsWith(process.resourcesPath)) {
                return;
            }
            if (src.startsWith(resourcePath)) {
                return;
            }
            if (src.startsWith(packagePath)) {
                return;
            }
            if (src[0] === '/') {
                if (!util_1.isFileSync(src)) {
                    try {
                        if (rootDirectory !== null) {
                            src = path.join(rootDirectory, src.substring(1));
                        }
                    }
                    catch (e) {
                    }
                }
            }
            else if (filePath) {
                src = path.resolve(path.dirname(filePath), src);
            }
            if (relativize && (filePath !== undefined || savePath !== undefined)) {
                const fp = savePath !== undefined ? savePath : filePath;
                src = path.relative(path.dirname(fp), src);
            }
            if (imageWatcher) {
                const v = imageWatcher.watch(src);
                if (v !== undefined)
                    src = `${src}?v=${v}`;
            }
            img[attrName] = src;
        }
    });
}
async function highlightCodeBlocks(domFragment, defaultLanguage) {
    const fontFamily = atom.config.get('editor.fontFamily');
    if (fontFamily) {
        for (const codeElement of Array.from(domFragment.querySelectorAll('code'))) {
            codeElement.style.fontFamily = fontFamily;
        }
    }
    await Promise.all(Array.from(domFragment.querySelectorAll('pre')).map(async (preElement) => {
        const codeBlock = preElement.firstElementChild !== null
            ? preElement.firstElementChild
            : preElement;
        const cbClass = codeBlock.className || preElement.className;
        const fenceName = cbClass
            ? cbClass.replace(/^(lang-|sourceCode )/, '')
            : defaultLanguage;
        const ctw = util_1.atomConfig().codeTabWidth;
        const ed = new atom_1.TextEditor({
            readonly: true,
            keyboardInputEnabled: false,
            showInvisibles: false,
            tabLength: ctw === 0 ? atom.config.get('editor.tabLength') : ctw,
        });
        const el = atom.views.getView(ed);
        try {
            el.setUpdatedSynchronously(true);
            el.style.pointerEvents = 'none';
            el.style.position = 'absolute';
            el.style.top = '100vh';
            el.style.width = '100vw';
            atom.grammars.assignLanguageMode(ed.getBuffer(), extension_helper_1.scopeForFenceName(fenceName));
            ed.setText(codeBlock.textContent.replace(/\r?\n$/, ''));
            atom.views.getView(atom.workspace).appendChild(el);
            await editorTokenized(ed);
            const html = Array.from(el.querySelectorAll('.line:not(.dummy)'));
            preElement.classList.add('editor-colors');
            preElement.innerHTML = html.map((x) => x.innerHTML).join('\n');
            if (fenceName)
                preElement.classList.add(`lang-${fenceName}`);
        }
        finally {
            el.remove();
        }
    }));
    return domFragment;
}
async function editorTokenized(editor) {
    return new Promise((resolve) => {
        const languageMode = editor.getBuffer().getLanguageMode();
        const nextUpdatePromise = editor.component.getNextUpdatePromise();
        if (languageMode.fullyTokenized || languageMode.tree) {
            resolve(nextUpdatePromise);
        }
        else {
            const disp = editor.onDidTokenize(() => {
                disp.dispose();
                resolve(nextUpdatePromise);
            });
        }
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVuZGVyZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcmVuZGVyZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw2QkFBNkI7QUFDN0IsZ0RBQWdEO0FBQ2hELG1EQUFtRDtBQUNuRCx5REFBc0Q7QUFDdEQsK0JBQTBDO0FBQzFDLGlDQUErQztBQUMvQywrQ0FBd0M7QUFHeEMsTUFBTSxFQUFFLFlBQVksRUFBRSxHQUFHLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQTtBQUMvQyxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFBO0FBaUJwQyxLQUFLLFVBQVUsTUFBTSxDQUFDLE9BQXNCO0lBR2pELE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLDRCQUE0QixFQUFFLEVBQUUsQ0FBQyxDQUFBO0lBRW5FLElBQUksSUFBSSxDQUFBO0lBQ1IsSUFBSSxLQUFLLENBQUE7SUFDVCxJQUFJLGlCQUFVLEVBQUUsQ0FBQyxRQUFRLEtBQUssUUFBUSxFQUFFO1FBQ3RDLElBQUk7WUFDRixJQUFJLEdBQUcsTUFBTSxZQUFZLENBQUMsWUFBWSxDQUNwQyxJQUFJLEVBQ0osT0FBTyxDQUFDLFFBQVEsRUFDaEIsT0FBTyxDQUFDLFdBQVcsRUFDbkIsT0FBTyxDQUFDLElBQUksS0FBSyxRQUFRLENBQzFCLENBQUE7U0FDRjtRQUFDLE9BQU8sR0FBRyxFQUFFO1lBQ1osTUFBTSxDQUFDLEdBQUcsR0FBZ0MsQ0FBQTtZQUMxQyxJQUFJLENBQUMsQ0FBQyxJQUFJLEtBQUssU0FBUztnQkFBRSxNQUFNLENBQUMsQ0FBQTtZQUNqQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLE9BQWlCLENBQUE7WUFDM0IsSUFBSSxHQUFHLENBQUMsQ0FBQyxJQUFjLENBQUE7U0FDeEI7S0FDRjtTQUFNO1FBQ0wsSUFBSSxHQUFHLFVBQVUsQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLE9BQU8s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LEdBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQyxvQkFBb0IsRUFBRSxDQUFBO1FBQ2pFLElBQUksWUFBWSxDQUFDLGNBQWMsSUFBSSxZQUFZLENBQUMsSUFBSSxFQUFFO1lBQ3BELE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFBO1NBQzNCO2FBQU07WUFDTCxNQUFNLElBQUksR0FBRyxNQUFNLENBQUMsYUFBYSxDQUFDLEdBQUcsRUFBRTtnQkFDckMsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFBO2dCQUNkLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFBO1lBQzVCLENBQUMsQ0FBQyxDQUFBO1NBQ0g7SUFDSCxDQUFDLENBQUMsQ0FBQTtBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKVxuaW1wb3J0IHBhbmRvY0hlbHBlciA9IHJlcXVpcmUoJy4vcGFuZG9jLWhlbHBlcicpXG5pbXBvcnQgbWFya2Rvd25JdCA9IHJlcXVpcmUoJy4vbWFya2Rvd24taXQtaGVscGVyJykgLy8gRGVmZXIgdW50aWwgdXNlZFxuaW1wb3J0IHsgc2NvcGVGb3JGZW5jZU5hbWUgfSBmcm9tICcuL2V4dGVuc2lvbi1oZWxwZXInXG5pbXBvcnQgeyBHcmFtbWFyLCBUZXh0RWRpdG9yIH0gZnJvbSAnYXRvbSdcbmltcG9ydCB7IGlzRmlsZVN5bmMsIGF0b21Db25maWcgfSBmcm9tICcuL3V0aWwnXG5pbXBvcnQgeyBnZXRNZWRpYSB9IGZyb20gJy4vdXRpbC1jb21tb24nXG5pbXBvcnQgeyBJbWFnZVdhdGNoZXIgfSBmcm9tICcuL2ltYWdlLXdhdGNoLWhlbHBlcidcblxuY29uc3QgeyByZXNvdXJjZVBhdGggfSA9IGF0b20uZ2V0TG9hZFNldHRpbmdzKClcbmNvbnN0IHBhY2thZ2VQYXRoID0gcGF0aC5kaXJuYW1lKF9fZGlybmFtZSlcblxuZXhwb3J0IHR5cGUgUmVuZGVyTW9kZSA9ICdub3JtYWwnIHwgJ2NvcHknIHwgJ3NhdmUnXG5cbmV4cG9ydCBpbnRlcmZhY2UgQ29tbW9uUmVuZGVyT3B0aW9uczxUIGV4dGVuZHMgUmVuZGVyTW9kZT4ge1xuICB0ZXh0OiBzdHJpbmdcbiAgZmlsZVBhdGg6IHN0cmluZyB8IHVuZGVmaW5lZFxuICBncmFtbWFyPzogR3JhbW1hclxuICByZW5kZXJMYVRlWDogYm9vbGVhblxuICBtb2RlOiBUXG59XG5cbmV4cG9ydCB0eXBlIFJlbmRlck9wdGlvbnMgPVxuICB8IChDb21tb25SZW5kZXJPcHRpb25zPCdub3JtYWwnPiAmIHsgaW1hZ2VXYXRjaGVyPzogSW1hZ2VXYXRjaGVyIH0pXG4gIHwgKENvbW1vblJlbmRlck9wdGlvbnM8J3NhdmUnPiAmIHsgc2F2ZVBhdGg6IHN0cmluZyB9KVxuICB8IENvbW1vblJlbmRlck9wdGlvbnM8J2NvcHknPlxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcmVuZGVyKG9wdGlvbnM6IFJlbmRlck9wdGlvbnMpOiBQcm9taXNlPEhUTUxEb2N1bWVudD4ge1xuICAvLyBSZW1vdmUgdGhlIDwhZG9jdHlwZT4gc2luY2Ugb3RoZXJ3aXNlIG1hcmtlZCB3aWxsIGVzY2FwZSBpdFxuICAvLyBodHRwczovL2dpdGh1Yi5jb20vY2hqai9tYXJrZWQvaXNzdWVzLzM1NFxuICBjb25zdCB0ZXh0ID0gb3B0aW9ucy50ZXh0LnJlcGxhY2UoL15cXHMqPCFkb2N0eXBlKFxccysuKik/PlxccyovaSwgJycpXG5cbiAgbGV0IGh0bWxcbiAgbGV0IGVycm9yXG4gIGlmIChhdG9tQ29uZmlnKCkucmVuZGVyZXIgPT09ICdwYW5kb2MnKSB7XG4gICAgdHJ5IHtcbiAgICAgIGh0bWwgPSBhd2FpdCBwYW5kb2NIZWxwZXIucmVuZGVyUGFuZG9jKFxuICAgICAgICB0ZXh0LFxuICAgICAgICBvcHRpb25zLmZpbGVQYXRoLFxuICAgICAgICBvcHRpb25zLnJlbmRlckxhVGVYLFxuICAgICAgICBvcHRpb25zLm1vZGUgPT09ICdub3JtYWwnLFxuICAgICAgKVxuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgY29uc3QgZSA9IGVyciBhcyBFcnJvciAmIHsgaHRtbD86IHN0cmluZyB9XG4gICAgICBpZiAoZS5odG1sID09PSB1bmRlZmluZWQpIHRocm93IGVcbiAgICAgIGVycm9yID0gZS5tZXNzYWdlIGFzIHN0cmluZ1xuICAgICAgaHRtbCA9IGUuaHRtbCBhcyBzdHJpbmdcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgaHRtbCA9IG1hcmtkb3duSXQucmVuZGVyKHRleHQsIG9wdGlvbnMucmVuZGVyTGFUZVgpXG4gIH1cbiAgY29uc3QgcGFyc2VyID0gbmV3IERPTVBhcnNlcigpXG4gIGNvbnN0IGRvYyA9IHBhcnNlci5wYXJzZUZyb21TdHJpbmcoaHRtbCwgJ3RleHQvaHRtbCcpXG4gIHNhbml0aXplKGRvYylcbiAgaWYgKG9wdGlvbnMubW9kZSA9PT0gJ25vcm1hbCcpIHtcbiAgICBpZiAob3B0aW9ucy5pbWFnZVdhdGNoZXIpIG9wdGlvbnMuaW1hZ2VXYXRjaGVyLmNsZWFyKClcbiAgICByZXNvbHZlSW1hZ2VQYXRocyhcbiAgICAgIGRvYyxcbiAgICAgIG9wdGlvbnMuZmlsZVBhdGgsXG4gICAgICBmYWxzZSxcbiAgICAgIHVuZGVmaW5lZCxcbiAgICAgIG9wdGlvbnMuaW1hZ2VXYXRjaGVyLFxuICAgIClcbiAgfSBlbHNlIHtcbiAgICBzd2l0Y2ggKG9wdGlvbnMubW9kZSkge1xuICAgICAgY2FzZSAnc2F2ZSc6XG4gICAgICAgIGhhbmRsZUltYWdlcyh7XG4gICAgICAgICAgZG9jLFxuICAgICAgICAgIGZpbGVQYXRoOiBvcHRpb25zLmZpbGVQYXRoLFxuICAgICAgICAgIHNhdmVQYXRoOiBvcHRpb25zLnNhdmVQYXRoLFxuICAgICAgICAgIGJlaGF2aW91cjogYXRvbUNvbmZpZygpLnNhdmVDb25maWcubWVkaWFPblNhdmVBc0hUTUxCZWhhdmlvdXIsXG4gICAgICAgIH0pXG4gICAgICAgIGJyZWFrXG4gICAgICBjYXNlICdjb3B5JzpcbiAgICAgICAgaGFuZGxlSW1hZ2VzKHtcbiAgICAgICAgICBkb2MsXG4gICAgICAgICAgZmlsZVBhdGg6IG9wdGlvbnMuZmlsZVBhdGgsXG4gICAgICAgICAgYmVoYXZpb3VyOiBhdG9tQ29uZmlnKCkuc2F2ZUNvbmZpZy5tZWRpYU9uQ29weUFzSFRNTEJlaGF2aW91cixcbiAgICAgICAgfSlcbiAgICAgICAgYnJlYWtcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHRocm93IGludmFsaWRNb2RlKG9wdGlvbnMpXG4gICAgfVxuICB9XG4gIGxldCBkZWZhdWx0Q29kZUxhbmd1YWdlOiBzdHJpbmcgPSAndGV4dCdcbiAgLy8gRGVmYXVsdCBjb2RlIGJsb2NrcyB0byBiZSBjb2ZmZWUgaW4gTGl0ZXJhdGUgQ29mZmVlU2NyaXB0IGZpbGVzXG4gIGlmICgob3B0aW9ucy5ncmFtbWFyICYmIG9wdGlvbnMuZ3JhbW1hci5zY29wZU5hbWUpID09PSAnc291cmNlLmxpdGNvZmZlZScpIHtcbiAgICBkZWZhdWx0Q29kZUxhbmd1YWdlID0gJ2NvZmZlZSdcbiAgfVxuICBpZiAoXG4gICAgIShcbiAgICAgIGF0b21Db25maWcoKS5yZW5kZXJlciA9PT0gJ3BhbmRvYycgJiZcbiAgICAgIGF0b21Db25maWcoKS5wYW5kb2NDb25maWcudXNlTmF0aXZlUGFuZG9jQ29kZVN0eWxlc1xuICAgIClcbiAgKSB7XG4gICAgYXdhaXQgaGlnaGxpZ2h0Q29kZUJsb2Nrcyhkb2MsIGRlZmF1bHRDb2RlTGFuZ3VhZ2UpXG4gIH1cbiAgaWYgKGVycm9yKSB7XG4gICAgY29uc3QgZXJyZCA9IGRvYy5jcmVhdGVFbGVtZW50KCdkaXYnKVxuICAgIGNvbnN0IG1zZ2VsID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ2NvZGUnKVxuICAgIG1zZ2VsLmlubmVyVGV4dCA9IGVycm9yXG4gICAgZXJyZC5pbm5lckhUTUwgPSBgPGgxPlBhbmRvYyBFcnJvcjo8L2gxPiR7bXNnZWwub3V0ZXJIVE1MfTxocj5gXG4gICAgZG9jLmJvZHkuaW5zZXJ0QmVmb3JlKGVycmQsIGRvYy5ib2R5LmZpcnN0RWxlbWVudENoaWxkKVxuICB9XG4gIHJldHVybiBkb2Ncbn1cblxuZnVuY3Rpb24gaW52YWxpZE1vZGUobW9kZTogbmV2ZXIpIHtcbiAgcmV0dXJuIG5ldyBFcnJvcihgSW52YWxpZCByZW5kZXIgbW9kZSAke0pTT04uc3RyaW5naWZ5KG1vZGUpfWApXG59XG5cbmZ1bmN0aW9uIHNhbml0aXplKGRvYzogSFRNTERvY3VtZW50KSB7XG4gIC8vIERvIG5vdCByZW1vdmUgTWF0aEpheCBzY3JpcHQgZGVsaW1pdGVkIGJsb2Nrc1xuICBkb2MucXVlcnlTZWxlY3RvckFsbChcInNjcmlwdDpub3QoW3R5cGVePSdtYXRoL3RleCddKVwiKS5mb3JFYWNoKChlbGVtKSA9PiB7XG4gICAgZWxlbS5yZW1vdmUoKVxuICB9KVxuICBjb25zdCBhdHRyaWJ1dGVzVG9SZW1vdmUgPSBbXG4gICAgJ29uYWJvcnQnLFxuICAgICdvbmJsdXInLFxuICAgICdvbmNoYW5nZScsXG4gICAgJ29uY2xpY2snLFxuICAgICdvbmRiY2xpY2snLFxuICAgICdvbmVycm9yJyxcbiAgICAnb25mb2N1cycsXG4gICAgJ29ua2V5ZG93bicsXG4gICAgJ29ua2V5cHJlc3MnLFxuICAgICdvbmtleXVwJyxcbiAgICAnb25sb2FkJyxcbiAgICAnb25tb3VzZWRvd24nLFxuICAgICdvbm1vdXNlbW92ZScsXG4gICAgJ29ubW91c2VvdmVyJyxcbiAgICAnb25tb3VzZW91dCcsXG4gICAgJ29ubW91c2V1cCcsXG4gICAgJ29ucmVzZXQnLFxuICAgICdvbnJlc2l6ZScsXG4gICAgJ29uc2Nyb2xsJyxcbiAgICAnb25zZWxlY3QnLFxuICAgICdvbnN1Ym1pdCcsXG4gICAgJ29udW5sb2FkJyxcbiAgXVxuICBkb2MucXVlcnlTZWxlY3RvckFsbCgnKicpLmZvckVhY2goKGVsZW0pID0+XG4gICAgYXR0cmlidXRlc1RvUmVtb3ZlLm1hcCgoYXR0cmlidXRlKSA9PiB7XG4gICAgICBlbGVtLnJlbW92ZUF0dHJpYnV0ZShhdHRyaWJ1dGUpXG4gICAgfSksXG4gIClcbn1cblxuZnVuY3Rpb24gaGFuZGxlSW1hZ2VzKG9wdHM6IHtcbiAgYmVoYXZpb3VyOiAncmVsYXRpdml6ZWQnIHwgJ2Fic29sdXRpemVkJyB8ICd1bnRvdWNoZWQnXG4gIGRvYzogSFRNTERvY3VtZW50XG4gIGZpbGVQYXRoPzogc3RyaW5nXG4gIHNhdmVQYXRoPzogc3RyaW5nXG59KSB7XG4gIGNvbnN0IHJlbGF0aXZpemUgPSBvcHRzLmJlaGF2aW91ciA9PT0gJ3JlbGF0aXZpemVkJ1xuICBzd2l0Y2ggKG9wdHMuYmVoYXZpb3VyKSB7XG4gICAgY2FzZSAncmVsYXRpdml6ZWQnOlxuICAgIGNhc2UgJ2Fic29sdXRpemVkJzpcbiAgICAgIHJlc29sdmVJbWFnZVBhdGhzKG9wdHMuZG9jLCBvcHRzLmZpbGVQYXRoLCByZWxhdGl2aXplLCBvcHRzLnNhdmVQYXRoKVxuICAgICAgYnJlYWtcbiAgICBjYXNlICd1bnRvdWNoZWQnOlxuICAgIC8qIG5vb3AgKi9cbiAgfVxufVxuXG5mdW5jdGlvbiByZXNvbHZlSW1hZ2VQYXRocyhcbiAgZG9jOiBIVE1MRG9jdW1lbnQsXG4gIGZpbGVQYXRoOiBzdHJpbmcgfCB1bmRlZmluZWQsXG4gIHJlbGF0aXZpemU6IGJvb2xlYW4sXG4gIHNhdmVQYXRoPzogc3RyaW5nLFxuICBpbWFnZVdhdGNoZXI/OiBJbWFnZVdhdGNoZXIsXG4pIHtcbiAgY29uc3QgW3Jvb3REaXJlY3RvcnldID0gYXRvbS5wcm9qZWN0LnJlbGF0aXZpemVQYXRoKGZpbGVQYXRoIHx8ICcnKVxuICBjb25zdCBtZWRpYSA9IGdldE1lZGlhKGRvYylcbiAgQXJyYXkuZnJvbShtZWRpYSkubWFwKGZ1bmN0aW9uKGltZykge1xuICAgIGxldCBhdHRyTmFtZTogJ2hyZWYnIHwgJ3NyYydcbiAgICBpZiAoaW1nLnRhZ05hbWUgPT09ICdMSU5LJykgYXR0ck5hbWUgPSAnaHJlZidcbiAgICBlbHNlIGF0dHJOYW1lID0gJ3NyYydcbiAgICBsZXQgc3JjID0gaW1nLmdldEF0dHJpYnV0ZShhdHRyTmFtZSlcbiAgICBpZiAoc3JjKSB7XG4gICAgICBpZiAoYXRvbUNvbmZpZygpLnJlbmRlcmVyICE9PSAncGFuZG9jJykge1xuICAgICAgICBzcmMgPSBkZWNvZGVVUkkoc3JjKVxuICAgICAgfVxuXG4gICAgICBpZiAoc3JjLm1hdGNoKC9eKGh0dHBzP3xhdG9tfGRhdGEpOi8pKSB7XG4gICAgICAgIHJldHVyblxuICAgICAgfVxuICAgICAgaWYgKHByb2Nlc3MucmVzb3VyY2VzUGF0aCAmJiBzcmMuc3RhcnRzV2l0aChwcm9jZXNzLnJlc291cmNlc1BhdGgpKSB7XG4gICAgICAgIHJldHVyblxuICAgICAgfVxuICAgICAgaWYgKHNyYy5zdGFydHNXaXRoKHJlc291cmNlUGF0aCkpIHtcbiAgICAgICAgcmV0dXJuXG4gICAgICB9XG4gICAgICBpZiAoc3JjLnN0YXJ0c1dpdGgocGFja2FnZVBhdGgpKSB7XG4gICAgICAgIHJldHVyblxuICAgICAgfVxuXG4gICAgICBpZiAoc3JjWzBdID09PSAnLycpIHtcbiAgICAgICAgaWYgKCFpc0ZpbGVTeW5jKHNyYykpIHtcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgaWYgKHJvb3REaXJlY3RvcnkgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgc3JjID0gcGF0aC5qb2luKHJvb3REaXJlY3RvcnksIHNyYy5zdWJzdHJpbmcoMSkpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgLy8gbm9vcFxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmIChmaWxlUGF0aCkge1xuICAgICAgICBzcmMgPSBwYXRoLnJlc29sdmUocGF0aC5kaXJuYW1lKGZpbGVQYXRoKSwgc3JjKVxuICAgICAgfVxuXG4gICAgICBpZiAocmVsYXRpdml6ZSAmJiAoZmlsZVBhdGggIT09IHVuZGVmaW5lZCB8fCBzYXZlUGF0aCAhPT0gdW5kZWZpbmVkKSkge1xuICAgICAgICBjb25zdCBmcCA9IHNhdmVQYXRoICE9PSB1bmRlZmluZWQgPyBzYXZlUGF0aCA6IGZpbGVQYXRoIVxuICAgICAgICBzcmMgPSBwYXRoLnJlbGF0aXZlKHBhdGguZGlybmFtZShmcCksIHNyYylcbiAgICAgIH1cblxuICAgICAgLy8gV2F0Y2ggaW1hZ2UgZm9yIGNoYW5nZXNcbiAgICAgIGlmIChpbWFnZVdhdGNoZXIpIHtcbiAgICAgICAgY29uc3QgdiA9IGltYWdlV2F0Y2hlci53YXRjaChzcmMpXG4gICAgICAgIGlmICh2ICE9PSB1bmRlZmluZWQpIHNyYyA9IGAke3NyY30/dj0ke3Z9YFxuICAgICAgfVxuXG4gICAgICBpbWdbYXR0ck5hbWVdID0gc3JjXG4gICAgfVxuICB9KVxufVxuXG5hc3luYyBmdW5jdGlvbiBoaWdobGlnaHRDb2RlQmxvY2tzKFxuICBkb21GcmFnbWVudDogRG9jdW1lbnQsXG4gIGRlZmF1bHRMYW5ndWFnZTogc3RyaW5nLFxuKSB7XG4gIGNvbnN0IGZvbnRGYW1pbHkgPSBhdG9tLmNvbmZpZy5nZXQoJ2VkaXRvci5mb250RmFtaWx5JylcbiAgaWYgKGZvbnRGYW1pbHkpIHtcbiAgICBmb3IgKGNvbnN0IGNvZGVFbGVtZW50IG9mIEFycmF5LmZyb20oXG4gICAgICBkb21GcmFnbWVudC5xdWVyeVNlbGVjdG9yQWxsKCdjb2RlJyksXG4gICAgKSkge1xuICAgICAgY29kZUVsZW1lbnQuc3R5bGUuZm9udEZhbWlseSA9IGZvbnRGYW1pbHlcbiAgICB9XG4gIH1cblxuICBhd2FpdCBQcm9taXNlLmFsbChcbiAgICBBcnJheS5mcm9tKGRvbUZyYWdtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ3ByZScpKS5tYXAoYXN5bmMgKHByZUVsZW1lbnQpID0+IHtcbiAgICAgIGNvbnN0IGNvZGVCbG9jayA9XG4gICAgICAgIHByZUVsZW1lbnQuZmlyc3RFbGVtZW50Q2hpbGQgIT09IG51bGxcbiAgICAgICAgICA/IHByZUVsZW1lbnQuZmlyc3RFbGVtZW50Q2hpbGRcbiAgICAgICAgICA6IHByZUVsZW1lbnRcbiAgICAgIGNvbnN0IGNiQ2xhc3MgPSBjb2RlQmxvY2suY2xhc3NOYW1lIHx8IHByZUVsZW1lbnQuY2xhc3NOYW1lXG4gICAgICBjb25zdCBmZW5jZU5hbWUgPSBjYkNsYXNzXG4gICAgICAgID8gY2JDbGFzcy5yZXBsYWNlKC9eKGxhbmctfHNvdXJjZUNvZGUgKS8sICcnKVxuICAgICAgICA6IGRlZmF1bHRMYW5ndWFnZVxuXG4gICAgICBjb25zdCBjdHcgPSBhdG9tQ29uZmlnKCkuY29kZVRhYldpZHRoXG4gICAgICBjb25zdCBlZCA9IG5ldyBUZXh0RWRpdG9yKHtcbiAgICAgICAgcmVhZG9ubHk6IHRydWUsXG4gICAgICAgIGtleWJvYXJkSW5wdXRFbmFibGVkOiBmYWxzZSxcbiAgICAgICAgc2hvd0ludmlzaWJsZXM6IGZhbHNlLFxuICAgICAgICB0YWJMZW5ndGg6IGN0dyA9PT0gMCA/IGF0b20uY29uZmlnLmdldCgnZWRpdG9yLnRhYkxlbmd0aCcpIDogY3R3LFxuICAgICAgfSlcbiAgICAgIGNvbnN0IGVsID0gYXRvbS52aWV3cy5nZXRWaWV3KGVkKVxuICAgICAgdHJ5IHtcbiAgICAgICAgZWwuc2V0VXBkYXRlZFN5bmNocm9ub3VzbHkodHJ1ZSlcbiAgICAgICAgZWwuc3R5bGUucG9pbnRlckV2ZW50cyA9ICdub25lJ1xuICAgICAgICBlbC5zdHlsZS5wb3NpdGlvbiA9ICdhYnNvbHV0ZSdcbiAgICAgICAgZWwuc3R5bGUudG9wID0gJzEwMHZoJ1xuICAgICAgICBlbC5zdHlsZS53aWR0aCA9ICcxMDB2dydcbiAgICAgICAgYXRvbS5ncmFtbWFycy5hc3NpZ25MYW5ndWFnZU1vZGUoXG4gICAgICAgICAgZWQuZ2V0QnVmZmVyKCksXG4gICAgICAgICAgc2NvcGVGb3JGZW5jZU5hbWUoZmVuY2VOYW1lKSxcbiAgICAgICAgKVxuICAgICAgICBlZC5zZXRUZXh0KGNvZGVCbG9jay50ZXh0Q29udGVudCEucmVwbGFjZSgvXFxyP1xcbiQvLCAnJykpXG4gICAgICAgIGF0b20udmlld3MuZ2V0VmlldyhhdG9tLndvcmtzcGFjZSkuYXBwZW5kQ2hpbGQoZWwpXG4gICAgICAgIGF3YWl0IGVkaXRvclRva2VuaXplZChlZClcbiAgICAgICAgY29uc3QgaHRtbCA9IEFycmF5LmZyb20oZWwucXVlcnlTZWxlY3RvckFsbCgnLmxpbmU6bm90KC5kdW1teSknKSlcbiAgICAgICAgcHJlRWxlbWVudC5jbGFzc0xpc3QuYWRkKCdlZGl0b3ItY29sb3JzJylcbiAgICAgICAgcHJlRWxlbWVudC5pbm5lckhUTUwgPSBodG1sLm1hcCgoeCkgPT4geC5pbm5lckhUTUwpLmpvaW4oJ1xcbicpXG4gICAgICAgIGlmIChmZW5jZU5hbWUpIHByZUVsZW1lbnQuY2xhc3NMaXN0LmFkZChgbGFuZy0ke2ZlbmNlTmFtZX1gKVxuICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgZWwucmVtb3ZlKClcbiAgICAgIH1cbiAgICB9KSxcbiAgKVxuXG4gIHJldHVybiBkb21GcmFnbWVudFxufVxuXG5hc3luYyBmdW5jdGlvbiBlZGl0b3JUb2tlbml6ZWQoZWRpdG9yOiBUZXh0RWRpdG9yKSB7XG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgIGNvbnN0IGxhbmd1YWdlTW9kZSA9IGVkaXRvci5nZXRCdWZmZXIoKS5nZXRMYW5ndWFnZU1vZGUoKVxuICAgIGNvbnN0IG5leHRVcGRhdGVQcm9taXNlID0gZWRpdG9yLmNvbXBvbmVudC5nZXROZXh0VXBkYXRlUHJvbWlzZSgpXG4gICAgaWYgKGxhbmd1YWdlTW9kZS5mdWxseVRva2VuaXplZCB8fCBsYW5ndWFnZU1vZGUudHJlZSkge1xuICAgICAgcmVzb2x2ZShuZXh0VXBkYXRlUHJvbWlzZSlcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgZGlzcCA9IGVkaXRvci5vbkRpZFRva2VuaXplKCgpID0+IHtcbiAgICAgICAgZGlzcC5kaXNwb3NlKClcbiAgICAgICAgcmVzb2x2ZShuZXh0VXBkYXRlUHJvbWlzZSlcbiAgICAgIH0pXG4gICAgfVxuICB9KVxufVxuIl19