"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const fs = require("fs-plus");
const highlight = require("atom-highlight");
const pandocHelper = require("./pandoc-helper");
const markdownIt = require("./markdown-it-helper");
const extension_helper_1 = require("./extension-helper");
const imageWatcher = require("./image-watch-helper");
const { resourcePath } = atom.getLoadSettings();
const packagePath = path.dirname(__dirname);
function toDOMFragment(text, filePath, _grammar, renderLaTeX, callback) {
    if (text == null) {
        text = '';
    }
    return render(text, filePath, renderLaTeX, false, function (error, html) {
        if (error != null) {
            return callback(error);
        }
        const template = document.createElement('template');
        template.innerHTML = html;
        const domFragment = template.content.cloneNode(true);
        return callback(null, domFragment);
    });
}
exports.toDOMFragment = toDOMFragment;
function toHTML(text, filePath, grammar, renderLaTeX, copyHTMLFlag, callback) {
    if (text == null) {
        text = '';
    }
    return render(text, filePath, renderLaTeX, copyHTMLFlag, function (error, html) {
        let defaultCodeLanguage;
        if (error != null) {
            return callback(error, '');
        }
        if ((grammar && grammar.scopeName) === 'source.litcoffee') {
            defaultCodeLanguage = 'coffee';
        }
        if (!atom.config.get('markdown-preview-plus.enablePandoc') ||
            !atom.config.get('markdown-preview-plus.useNativePandocCodeStyles')) {
            html = tokenizeCodeBlocks(html, defaultCodeLanguage);
        }
        return callback(null, html);
    });
}
exports.toHTML = toHTML;
function render(text, filePath, renderLaTeX, copyHTMLFlag, callback) {
    text = text.replace(/^\s*<!doctype(\s+.*)?>\s*/i, '');
    const callbackFunction = function (error, html) {
        if (error != null) {
            return callback(error, '');
        }
        html = sanitize(html);
        html = resolveImagePaths(html, filePath, copyHTMLFlag);
        return callback(null, html.trim());
    };
    if (atom.config.get('markdown-preview-plus.enablePandoc')) {
        return pandocHelper.renderPandoc(text, filePath, renderLaTeX, callbackFunction);
    }
    else {
        return callbackFunction(null, markdownIt.render(text, renderLaTeX));
    }
}
function sanitize(html) {
    const doc = document.createElement('div');
    doc.innerHTML = html;
    doc
        .querySelectorAll("script:not([type^='math/tex'])")
        .forEach((elem) => elem.remove());
    const attributesToRemove = [
        'onabort',
        'onblur',
        'onchange',
        'onclick',
        'ondbclick',
        'onerror',
        'onfocus',
        'onkeydown',
        'onkeypress',
        'onkeyup',
        'onload',
        'onmousedown',
        'onmousemove',
        'onmouseover',
        'onmouseout',
        'onmouseup',
        'onreset',
        'onresize',
        'onscroll',
        'onselect',
        'onsubmit',
        'onunload',
    ];
    doc
        .querySelectorAll('*')
        .forEach((elem) => Array.from(attributesToRemove).map((attribute) => elem.removeAttribute(attribute)));
    return doc.innerHTML;
}
function resolveImagePaths(html, filePath, copyHTMLFlag) {
    let rootDirectory;
    if (atom.project != null) {
        ;
        [rootDirectory] = Array.from(atom.project.relativizePath(filePath || ''));
    }
    const doc = document.createElement('div');
    doc.innerHTML = html;
    doc.querySelectorAll('img').forEach(function (img) {
        let src;
        if ((src = img.getAttribute('src'))) {
            if (!atom.config.get('markdown-preview-plus.enablePandoc')) {
                src = markdownIt.decode(src);
            }
            if (src.match(/^(https?|atom|data):/)) {
                return;
            }
            if (src.startsWith(process.resourcesPath)) {
                return;
            }
            if (src.startsWith(resourcePath)) {
                return;
            }
            if (src.startsWith(packagePath)) {
                return;
            }
            if (src[0] === '/') {
                if (!fs.isFileSync(src)) {
                    try {
                        src = path.join(rootDirectory, src.substring(1));
                    }
                    catch (e) { }
                }
            }
            else if (filePath) {
                src = path.resolve(path.dirname(filePath), src);
            }
            if (!copyHTMLFlag) {
                const v = imageWatcher.getVersion(src, filePath);
                if (v) {
                    src = `${src}?v=${v}`;
                }
            }
            return (img.src = src);
        }
        return;
    });
    return doc.innerHTML;
}
function convertCodeBlocksToAtomEditors(domFragment, defaultLanguage) {
    let fontFamily;
    if (defaultLanguage == null) {
        defaultLanguage = 'text';
    }
    if ((fontFamily = atom.config.get('editor.fontFamily'))) {
        for (let codeElement of Array.from(domFragment.querySelectorAll('code'))) {
            codeElement.style.fontFamily = fontFamily;
        }
    }
    for (let preElement of Array.from(domFragment.querySelectorAll('pre'))) {
        const codeBlock = preElement.firstElementChild != null
            ? preElement.firstElementChild
            : preElement;
        const cbClass = codeBlock.className;
        const fenceName = cbClass
            ? cbClass.replace(/^(lang-|sourceCode )/, '')
            : defaultLanguage;
        const editorElement = document.createElement('atom-text-editor');
        editorElement.setAttributeNode(document.createAttribute('gutter-hidden'));
        editorElement.removeAttribute('tabindex');
        preElement.parentElement.replaceChild(editorElement, preElement);
        const editor = editorElement.getModel();
        if (editor.cursorLineDecorations != null) {
            for (let cursorLineDecoration of editor.cursorLineDecorations) {
                cursorLineDecoration.destroy();
            }
        }
        editor.setText(codeBlock.textContent.replace(/\n$/, ''));
        const grammar = atom.grammars.grammarForScopeName(extension_helper_1.scopeForFenceName(fenceName));
        if (grammar)
            editor.setGrammar(grammar);
    }
    return domFragment;
}
exports.convertCodeBlocksToAtomEditors = convertCodeBlocksToAtomEditors;
function tokenizeCodeBlocks(html, defaultLanguage = 'text') {
    let fontFamily;
    const doc = document.createElement('div');
    doc.innerHTML = html;
    if ((fontFamily = atom.config.get('editor.fontFamily'))) {
        doc
            .querySelectorAll('code')
            .forEach((code) => (code.style.fontFamily = fontFamily || null));
    }
    doc.querySelectorAll('pre').forEach(function (preElement) {
        let left;
        const codeBlock = preElement.firstElementChild;
        const fenceName = (left = codeBlock.className.replace(/^(lang-|sourceCode )/, '')) != null
            ? left
            : defaultLanguage;
        const highlightedHtml = highlight({
            fileContents: codeBlock.innerText,
            scopeName: extension_helper_1.scopeForFenceName(fenceName),
            nbsp: false,
            lineDivs: false,
            editorDiv: true,
            editorDivTag: 'pre',
            editorDivClass: fenceName
                ? `editor-colors lang-${fenceName}`
                : 'editor-colors',
        });
        return (preElement.outerHTML = highlightedHtml);
    });
    return doc.innerHTML;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVuZGVyZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcmVuZGVyZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFTQSw2QkFBNkI7QUFDN0IsOEJBQThCO0FBQzlCLDRDQUE0QztBQUM1QyxnREFBZ0Q7QUFDaEQsbURBQW1EO0FBQ25ELHlEQUFzRDtBQUN0RCxxREFBcUQ7QUFHckQsTUFBTSxFQUFFLFlBQVksRUFBRSxHQUFHLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQTtBQUMvQyxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFBO0FBRTNDLHVCQUNFLElBQVksRUFDWixRQUFhLEVBQ2IsUUFBYSxFQUNiLFdBQW9CLEVBQ3BCLFFBQTZEO0lBRTdELEVBQUUsQ0FBQyxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ2pCLElBQUksR0FBRyxFQUFFLENBQUE7SUFDWCxDQUFDO0lBQ0QsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsUUFBUSxFQUFFLFdBQVcsRUFBRSxLQUFLLEVBQUUsVUFDaEQsS0FBbUIsRUFDbkIsSUFBYTtRQUViLEVBQUUsQ0FBQyxDQUFDLEtBQUssSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ2xCLE1BQU0sQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUE7UUFDeEIsQ0FBQztRQUVELE1BQU0sUUFBUSxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLENBQUE7UUFDbkQsUUFBUSxDQUFDLFNBQVMsR0FBRyxJQUFLLENBQUE7UUFDMUIsTUFBTSxXQUFXLEdBQUcsUUFBUSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUE7UUFFcEQsTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsV0FBVyxDQUFDLENBQUE7SUFDcEMsQ0FBQyxDQUFDLENBQUE7QUFDSixDQUFDO0FBeEJELHNDQXdCQztB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LEVBQUUsRUFBRSxDQUFDLENBQUMsSUFBSSxJQUFJO1lBQ3RFLENBQUMsQ0FBQyxJQUFJO1lBQ04sQ0FBQyxDQUFDLGVBQWUsQ0FBQTtRQUVyQixNQUFNLGVBQWUsR0FBRyxTQUFTLENBQUM7WUFDaEMsWUFBWSxFQUFFLFNBQVMsQ0FBQyxTQUFTO1lBQ2pDLFNBQVMsRUFBRSxvQ0FBaUIsQ0FBQyxTQUFTLENBQUM7WUFDdkMsSUFBSSxFQUFFLEtBQUs7WUFDWCxRQUFRLEVBQUUsS0FBSztZQUNmLFNBQVMsRUFBRSxJQUFJO1lBQ2YsWUFBWSxFQUFFLEtBQUs7WUFFbkIsY0FBYyxFQUFFLFNBQVM7Z0JBQ3ZCLENBQUMsQ0FBQyxzQkFBc0IsU0FBUyxFQUFFO2dCQUNuQyxDQUFDLENBQUMsZUFBZTtTQUNwQixDQUFDLENBQUE7UUFFRixNQUFNLENBQUMsQ0FBQyxVQUFVLENBQUMsU0FBUyxHQUFHLGVBQWUsQ0FBQyxDQUFBO0lBQ2pELENBQUMsQ0FBQyxDQUFBO0lBRUYsTUFBTSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUE7QUFDdEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBkZWNhZmZlaW5hdGUgc3VnZ2VzdGlvbnM6XG4gKiBEUzEwMTogUmVtb3ZlIHVubmVjZXNzYXJ5IHVzZSBvZiBBcnJheS5mcmNvbnN0IGNiQ2xhc3MgPSBjb2RlQmxvY2suY2xhc3NOYW1lXG4gKiBEUzEwMjogUmVtb3ZlIHVubmVjZXNzYXJ5IGNvZGUgY3JlYXRlZCBiZWNhdXNlIG9mIGltcGxpY2l0IHJldHVybnNcbiAqIERTMTAzOiBSZXdyaXRlIGNvZGUgdG8gbm8gbG9uZ2VyIHVzZSBfX2d1YXJkX19cbiAqIERTMTA0OiBBdm9pZCBpbmxpbmUgYXNzaWdubWVudHNcbiAqIERTMjA3OiBDb25zaWRlciBzaG9ydGVyIHZhcmlhdGlvbnMgb2YgbnVsbCBjaGVja3NcbiAqIEZ1bGwgZG9jczogaHR0cHM6Ly9naXRodWIuY29tL2RlY2FmZmVpbmF0ZS9kZWNhZmZlaW5hdGUvYmxvYi9tYXN0ZXIvZG9jcy9zdWdnZXN0aW9ucy5tZFxuICovXG5pbXBvcnQgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKVxuaW1wb3J0IGZzID0gcmVxdWlyZSgnZnMtcGx1cycpXG5pbXBvcnQgaGlnaGxpZ2h0ID0gcmVxdWlyZSgnYXRvbS1oaWdobGlnaHQnKVxuaW1wb3J0IHBhbmRvY0hlbHBlciA9IHJlcXVpcmUoJy4vcGFuZG9jLWhlbHBlcicpXG5pbXBvcnQgbWFya2Rvd25JdCA9IHJlcXVpcmUoJy4vbWFya2Rvd24taXQtaGVscGVyJykgLy8gRGVmZXIgdW50aWwgdXNlZFxuaW1wb3J0IHsgc2NvcGVGb3JGZW5jZU5hbWUgfSBmcm9tICcuL2V4dGVuc2lvbi1oZWxwZXInXG5pbXBvcnQgaW1hZ2VXYXRjaGVyID0gcmVxdWlyZSgnLi9pbWFnZS13YXRjaC1oZWxwZXInKVxuaW1wb3J0IHsgR3JhbW1hciwgVGV4dEVkaXRvckVsZW1lbnQgfSBmcm9tICdhdG9tJ1xuXG5jb25zdCB7IHJlc291cmNlUGF0aCB9ID0gYXRvbS5nZXRMb2FkU2V0dGluZ3MoKVxuY29uc3QgcGFja2FnZVBhdGggPSBwYXRoLmRpcm5hbWUoX19kaXJuYW1lKVxuXG5leHBvcnQgZnVuY3Rpb24gdG9ET01GcmFnbWVudChcbiAgdGV4dDogc3RyaW5nLFxuICBmaWxlUGF0aDogYW55LFxuICBfZ3JhbW1hcjogYW55LFxuICByZW5kZXJMYVRlWDogYm9vbGVhbixcbiAgY2FsbGJhY2s6IChlcnJvcjogRXJyb3IgfCBudWxsLCBkb21GcmFnbWVudD86IE5vZGUpID0+IHN0cmluZyxcbik6IHN0cmluZyB7XG4gIGlmICh0ZXh0ID09IG51bGwpIHtcbiAgICB0ZXh0ID0gJydcbiAgfVxuICByZXR1cm4gcmVuZGVyKHRleHQsIGZpbGVQYXRoLCByZW5kZXJMYVRlWCwgZmFsc2UsIGZ1bmN0aW9uKFxuICAgIGVycm9yOiBFcnJvciB8IG51bGwsXG4gICAgaHRtbD86IHN0cmluZyxcbiAgKSB7XG4gICAgaWYgKGVycm9yICE9IG51bGwpIHtcbiAgICAgIHJldHVybiBjYWxsYmFjayhlcnJvcilcbiAgICB9XG5cbiAgICBjb25zdCB0ZW1wbGF0ZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RlbXBsYXRlJylcbiAgICB0ZW1wbGF0ZS5pbm5lckhUTUwgPSBodG1sIVxuICAgIGNvbnN0IGRvbUZyYWdtZW50ID0gdGVtcGxhdGUuY29udGVudC5jbG9uZU5vZGUodHJ1ZSlcblxuICAgIHJldHVybiBjYWxsYmFjayhudWxsLCBkb21GcmFnbWVudClcbiAgfSlcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHRvSFRNTChcbiAgdGV4dDogc3RyaW5nIHwgbnVsbCxcbiAgZmlsZVBhdGg6IHN0cmluZyB8IHVuZGVmaW5lZCxcbiAgZ3JhbW1hcjogR3JhbW1hciB8IG51bGwsXG4gIHJlbmRlckxhVGVYOiBib29sZWFuLFxuICBjb3B5SFRNTEZsYWc6IGJvb2xlYW4sXG4gIGNhbGxiYWNrOiAoZXJyb3I6IEVycm9yIHwgbnVsbCwgaHRtbDogc3RyaW5nKSA9PiBzdHJpbmcsXG4pOiBzdHJpbmcge1xuICBpZiAodGV4dCA9PSBudWxsKSB7XG4gICAgdGV4dCA9ICcnXG4gIH1cbiAgcmV0dXJuIHJlbmRlcih0ZXh0LCBmaWxlUGF0aCwgcmVuZGVyTGFUZVgsIGNvcHlIVE1MRmxhZywgZnVuY3Rpb24oXG4gICAgZXJyb3IsXG4gICAgaHRtbCxcbiAgKSB7XG4gICAgbGV0IGRlZmF1bHRDb2RlTGFuZ3VhZ2U6IHN0cmluZyB8IHVuZGVmaW5lZFxuICAgIGlmIChlcnJvciAhPSBudWxsKSB7XG4gICAgICByZXR1cm4gY2FsbGJhY2soZXJyb3IsICcnKVxuICAgIH1cbiAgICAvLyBEZWZhdWx0IGNvZGUgYmxvY2tzIHRvIGJlIGNvZmZlZSBpbiBMaXRlcmF0ZSBDb2ZmZWVTY3JpcHQgZmlsZXNcbiAgICBpZiAoKGdyYW1tYXIgJiYgZ3JhbW1hci5zY29wZU5hbWUpID09PSAnc291cmNlLmxpdGNvZmZlZScpIHtcbiAgICAgIGRlZmF1bHRDb2RlTGFuZ3VhZ2UgPSAnY29mZmVlJ1xuICAgIH1cbiAgICBpZiAoXG4gICAgICAhYXRvbS5jb25maWcuZ2V0KCdtYXJrZG93bi1wcmV2aWV3LXBsdXMuZW5hYmxlUGFuZG9jJykgfHxcbiAgICAgICFhdG9tLmNvbmZpZy5nZXQoJ21hcmtkb3duLXByZXZpZXctcGx1cy51c2VOYXRpdmVQYW5kb2NDb2RlU3R5bGVzJylcbiAgICApIHtcbiAgICAgIGh0bWwgPSB0b2tlbml6ZUNvZGVCbG9ja3MoaHRtbCwgZGVmYXVsdENvZGVMYW5ndWFnZSlcbiAgICB9XG4gICAgcmV0dXJuIGNhbGxiYWNrKG51bGwsIGh0bWwpXG4gIH0pXG59XG5cbmZ1bmN0aW9uIHJlbmRlcihcbiAgdGV4dDogc3RyaW5nLFxuICBmaWxlUGF0aDogc3RyaW5nIHwgdW5kZWZpbmVkLFxuICByZW5kZXJMYVRlWDogYm9vbGVhbixcbiAgY29weUhUTUxGbGFnOiBib29sZWFuLFxuICBjYWxsYmFjazogKGVycm9yOiBFcnJvciB8IG51bGwsIGh0bWw6IHN0cmluZykgPT4gc3RyaW5nLFxuKTogc3RyaW5nIHtcbiAgLy8gUmVtb3ZlIHRoZSA8IWRvY3R5cGU+IHNpbmNlIG90aGVyd2lzZSBtYXJrZWQgd2lsbCBlc2NhcGUgaXRcbiAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2NoamovbWFya2VkL2lzc3Vlcy8zNTRcbiAgdGV4dCA9IHRleHQucmVwbGFjZSgvXlxccyo8IWRvY3R5cGUoXFxzKy4qKT8+XFxzKi9pLCAnJylcblxuICBjb25zdCBjYWxsYmFja0Z1bmN0aW9uID0gZnVuY3Rpb24oZXJyb3I6IEVycm9yIHwgbnVsbCwgaHRtbDogc3RyaW5nKSB7XG4gICAgaWYgKGVycm9yICE9IG51bGwpIHtcbiAgICAgIHJldHVybiBjYWxsYmFjayhlcnJvciwgJycpXG4gICAgfVxuICAgIGh0bWwgPSBzYW5pdGl6ZShodG1sKVxuICAgIGh0bWwgPSByZXNvbHZlSW1hZ2VQYXRocyhodG1sLCBmaWxlUGF0aCwgY29weUhUTUxGbGFnKVxuICAgIHJldHVybiBjYWxsYmFjayhudWxsLCBodG1sLnRyaW0oKSlcbiAgfVxuXG4gIGlmIChhdG9tLmNvbmZpZy5nZXQoJ21hcmtkb3duLXByZXZpZXctcGx1cy5lbmFibGVQYW5kb2MnKSkge1xuICAgIHJldHVybiBwYW5kb2NIZWxwZXIucmVuZGVyUGFuZG9jKFxuICAgICAgdGV4dCxcbiAgICAgIGZpbGVQYXRoLFxuICAgICAgcmVuZGVyTGFUZVgsXG4gICAgICBjYWxsYmFja0Z1bmN0aW9uLFxuICAgIClcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gY2FsbGJhY2tGdW5jdGlvbihudWxsLCBtYXJrZG93bkl0LnJlbmRlcih0ZXh0LCByZW5kZXJMYVRlWCkpXG4gIH1cbn1cblxuZnVuY3Rpb24gc2FuaXRpemUoaHRtbDogc3RyaW5nKSB7XG4gIGNvbnN0IGRvYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpXG4gIGRvYy5pbm5lckhUTUwgPSBodG1sXG4gIC8vIERvIG5vdCByZW1vdmUgTWF0aEpheCBzY3JpcHQgZGVsaW1pdGVkIGJsb2Nrc1xuICBkb2NcbiAgICAucXVlcnlTZWxlY3RvckFsbChcInNjcmlwdDpub3QoW3R5cGVePSdtYXRoL3RleCddKVwiKVxuICAgIC5mb3JFYWNoKChlbGVtKSA9PiBlbGVtLnJlbW92ZSgpKVxuICBjb25zdCBhdHRyaWJ1dGVzVG9SZW1vdmUgPSBbXG4gICAgJ29uYWJvcnQnLFxuICAgICdvbmJsdXInLFxuICAgICdvbmNoYW5nZScsXG4gICAgJ29uY2xpY2snLFxuICAgICdvbmRiY2xpY2snLFxuICAgICdvbmVycm9yJyxcbiAgICAnb25mb2N1cycsXG4gICAgJ29ua2V5ZG93bicsXG4gICAgJ29ua2V5cHJlc3MnLFxuICAgICdvbmtleXVwJyxcbiAgICAnb25sb2FkJyxcbiAgICAnb25tb3VzZWRvd24nLFxuICAgICdvbm1vdXNlbW92ZScsXG4gICAgJ29ubW91c2VvdmVyJyxcbiAgICAnb25tb3VzZW91dCcsXG4gICAgJ29ubW91c2V1cCcsXG4gICAgJ29ucmVzZXQnLFxuICAgICdvbnJlc2l6ZScsXG4gICAgJ29uc2Nyb2xsJyxcbiAgICAnb25zZWxlY3QnLFxuICAgICdvbnN1Ym1pdCcsXG4gICAgJ29udW5sb2FkJyxcbiAgXVxuICBkb2NcbiAgICAucXVlcnlTZWxlY3RvckFsbCgnKicpXG4gICAgLmZvckVhY2goKGVsZW0pID0+XG4gICAgICBBcnJheS5mcm9tKGF0dHJpYnV0ZXNUb1JlbW92ZSkubWFwKChhdHRyaWJ1dGUpID0+XG4gICAgICAgIGVsZW0ucmVtb3ZlQXR0cmlidXRlKGF0dHJpYnV0ZSksXG4gICAgICApLFxuICAgIClcbiAgcmV0dXJuIGRvYy5pbm5lckhUTUxcbn1cblxuZnVuY3Rpb24gcmVzb2x2ZUltYWdlUGF0aHMoXG4gIGh0bWw6IHN0cmluZyxcbiAgZmlsZVBhdGg6IHN0cmluZyB8IHVuZGVmaW5lZCxcbiAgY29weUhUTUxGbGFnOiBib29sZWFuLFxuKSB7XG4gIGxldCByb290RGlyZWN0b3J5OiBzdHJpbmdcbiAgaWYgKGF0b20ucHJvamVjdCAhPSBudWxsKSB7XG4gICAgO1tyb290RGlyZWN0b3J5XSA9IEFycmF5LmZyb20oYXRvbS5wcm9qZWN0LnJlbGF0aXZpemVQYXRoKGZpbGVQYXRoIHx8ICcnKSlcbiAgfVxuICBjb25zdCBkb2MgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKVxuICBkb2MuaW5uZXJIVE1MID0gaHRtbFxuICBkb2MucXVlcnlTZWxlY3RvckFsbCgnaW1nJykuZm9yRWFjaChmdW5jdGlvbihpbWcpIHtcbiAgICBsZXQgc3JjXG4gICAgaWYgKChzcmMgPSBpbWcuZ2V0QXR0cmlidXRlKCdzcmMnKSkpIHtcbiAgICAgIGlmICghYXRvbS5jb25maWcuZ2V0KCdtYXJrZG93bi1wcmV2aWV3LXBsdXMuZW5hYmxlUGFuZG9jJykpIHtcbiAgICAgICAgc3JjID0gbWFya2Rvd25JdC5kZWNvZGUoc3JjKVxuICAgICAgfVxuXG4gICAgICBpZiAoc3JjLm1hdGNoKC9eKGh0dHBzP3xhdG9tfGRhdGEpOi8pKSB7XG4gICAgICAgIHJldHVyblxuICAgICAgfVxuICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgaWYgKHNyYy5zdGFydHNXaXRoKHByb2Nlc3MucmVzb3VyY2VzUGF0aCkpIHtcbiAgICAgICAgcmV0dXJuXG4gICAgICB9XG4gICAgICBpZiAoc3JjLnN0YXJ0c1dpdGgocmVzb3VyY2VQYXRoKSkge1xuICAgICAgICByZXR1cm5cbiAgICAgIH1cbiAgICAgIGlmIChzcmMuc3RhcnRzV2l0aChwYWNrYWdlUGF0aCkpIHtcbiAgICAgICAgcmV0dXJuXG4gICAgICB9XG5cbiAgICAgIGlmIChzcmNbMF0gPT09ICcvJykge1xuICAgICAgICBpZiAoIWZzLmlzRmlsZVN5bmMoc3JjKSkge1xuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICBzcmMgPSBwYXRoLmpvaW4ocm9vdERpcmVjdG9yeSwgc3JjLnN1YnN0cmluZygxKSlcbiAgICAgICAgICB9IGNhdGNoIChlKSB7fVxuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKGZpbGVQYXRoKSB7XG4gICAgICAgIHNyYyA9IHBhdGgucmVzb2x2ZShwYXRoLmRpcm5hbWUoZmlsZVBhdGgpLCBzcmMpXG4gICAgICB9XG5cbiAgICAgIC8vIFVzZSBtb3N0IHJlY2VudCB2ZXJzaW9uIG9mIGltYWdlXG4gICAgICBpZiAoIWNvcHlIVE1MRmxhZykge1xuICAgICAgICBjb25zdCB2ID0gaW1hZ2VXYXRjaGVyLmdldFZlcnNpb24oc3JjLCBmaWxlUGF0aClcbiAgICAgICAgaWYgKHYpIHtcbiAgICAgICAgICBzcmMgPSBgJHtzcmN9P3Y9JHt2fWBcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gKGltZy5zcmMgPSBzcmMpXG4gICAgfVxuICAgIHJldHVyblxuICB9KVxuXG4gIHJldHVybiBkb2MuaW5uZXJIVE1MXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjb252ZXJ0Q29kZUJsb2Nrc1RvQXRvbUVkaXRvcnMoXG4gIGRvbUZyYWdtZW50OiBIVE1MRWxlbWVudCxcbiAgZGVmYXVsdExhbmd1YWdlOiBzdHJpbmcsXG4pIHtcbiAgbGV0IGZvbnRGYW1pbHlcbiAgaWYgKGRlZmF1bHRMYW5ndWFnZSA9PSBudWxsKSB7XG4gICAgZGVmYXVsdExhbmd1YWdlID0gJ3RleHQnXG4gIH1cbiAgaWYgKChmb250RmFtaWx5ID0gYXRvbS5jb25maWcuZ2V0KCdlZGl0b3IuZm9udEZhbWlseScpKSkge1xuICAgIGZvciAobGV0IGNvZGVFbGVtZW50IG9mIEFycmF5LmZyb20oZG9tRnJhZ21lbnQucXVlcnlTZWxlY3RvckFsbCgnY29kZScpKSkge1xuICAgICAgY29kZUVsZW1lbnQuc3R5bGUuZm9udEZhbWlseSA9IGZvbnRGYW1pbHlcbiAgICB9XG4gIH1cblxuICBmb3IgKGxldCBwcmVFbGVtZW50IG9mIEFycmF5LmZyb20oZG9tRnJhZ21lbnQucXVlcnlTZWxlY3RvckFsbCgncHJlJykpKSB7XG4gICAgY29uc3QgY29kZUJsb2NrID1cbiAgICAgIHByZUVsZW1lbnQuZmlyc3RFbGVtZW50Q2hpbGQgIT0gbnVsbFxuICAgICAgICA/IHByZUVsZW1lbnQuZmlyc3RFbGVtZW50Q2hpbGRcbiAgICAgICAgOiBwcmVFbGVtZW50XG4gICAgY29uc3QgY2JDbGFzcyA9IGNvZGVCbG9jay5jbGFzc05hbWVcbiAgICBjb25zdCBmZW5jZU5hbWUgPSBjYkNsYXNzXG4gICAgICA/IGNiQ2xhc3MucmVwbGFjZSgvXihsYW5nLXxzb3VyY2VDb2RlICkvLCAnJylcbiAgICAgIDogZGVmYXVsdExhbmd1YWdlXG5cbiAgICBjb25zdCBlZGl0b3JFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcbiAgICAgICdhdG9tLXRleHQtZWRpdG9yJyxcbiAgICApIGFzIFRleHRFZGl0b3JFbGVtZW50XG4gICAgZWRpdG9yRWxlbWVudC5zZXRBdHRyaWJ1dGVOb2RlKGRvY3VtZW50LmNyZWF0ZUF0dHJpYnV0ZSgnZ3V0dGVyLWhpZGRlbicpKVxuICAgIGVkaXRvckVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKCd0YWJpbmRleCcpIC8vIG1ha2UgcmVhZC1vbmx5XG5cbiAgICBwcmVFbGVtZW50LnBhcmVudEVsZW1lbnQhLnJlcGxhY2VDaGlsZChlZGl0b3JFbGVtZW50LCBwcmVFbGVtZW50KVxuXG4gICAgY29uc3QgZWRpdG9yID0gZWRpdG9yRWxlbWVudC5nZXRNb2RlbCgpXG4gICAgLy8gcmVtb3ZlIHRoZSBkZWZhdWx0IHNlbGVjdGlvbiBvZiBhIGxpbmUgaW4gZWFjaCBlZGl0b3JcbiAgICBpZiAoZWRpdG9yLmN1cnNvckxpbmVEZWNvcmF0aW9ucyAhPSBudWxsKSB7XG4gICAgICBmb3IgKGxldCBjdXJzb3JMaW5lRGVjb3JhdGlvbiBvZiBlZGl0b3IuY3Vyc29yTGluZURlY29yYXRpb25zKSB7XG4gICAgICAgIGN1cnNvckxpbmVEZWNvcmF0aW9uLmRlc3Ryb3koKVxuICAgICAgfVxuICAgIH1cblxuICAgIGVkaXRvci5zZXRUZXh0KGNvZGVCbG9jay50ZXh0Q29udGVudCEucmVwbGFjZSgvXFxuJC8sICcnKSlcbiAgICBjb25zdCBncmFtbWFyID0gYXRvbS5ncmFtbWFycy5ncmFtbWFyRm9yU2NvcGVOYW1lKFxuICAgICAgc2NvcGVGb3JGZW5jZU5hbWUoZmVuY2VOYW1lKSxcbiAgICApXG4gICAgaWYgKGdyYW1tYXIpIGVkaXRvci5zZXRHcmFtbWFyKGdyYW1tYXIpXG4gIH1cblxuICByZXR1cm4gZG9tRnJhZ21lbnRcbn1cblxuZnVuY3Rpb24gdG9rZW5pemVDb2RlQmxvY2tzKGh0bWw6IHN0cmluZywgZGVmYXVsdExhbmd1YWdlOiBzdHJpbmcgPSAndGV4dCcpIHtcbiAgbGV0IGZvbnRGYW1pbHk6IHN0cmluZyB8IHVuZGVmaW5lZFxuICBjb25zdCBkb2MgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKVxuICBkb2MuaW5uZXJIVE1MID0gaHRtbFxuXG4gIGlmICgoZm9udEZhbWlseSA9IGF0b20uY29uZmlnLmdldCgnZWRpdG9yLmZvbnRGYW1pbHknKSkpIHtcbiAgICBkb2NcbiAgICAgIC5xdWVyeVNlbGVjdG9yQWxsKCdjb2RlJylcbiAgICAgIC5mb3JFYWNoKChjb2RlKSA9PiAoY29kZS5zdHlsZS5mb250RmFtaWx5ID0gZm9udEZhbWlseSB8fCBudWxsKSlcbiAgfVxuXG4gIGRvYy5xdWVyeVNlbGVjdG9yQWxsKCdwcmUnKS5mb3JFYWNoKGZ1bmN0aW9uKHByZUVsZW1lbnQpIHtcbiAgICBsZXQgbGVmdFxuICAgIGNvbnN0IGNvZGVCbG9jayA9IHByZUVsZW1lbnQuZmlyc3RFbGVtZW50Q2hpbGQgYXMgSFRNTEVsZW1lbnRcbiAgICBjb25zdCBmZW5jZU5hbWUgPVxuICAgICAgKGxlZnQgPSBjb2RlQmxvY2suY2xhc3NOYW1lLnJlcGxhY2UoL14obGFuZy18c291cmNlQ29kZSApLywgJycpKSAhPSBudWxsXG4gICAgICAgID8gbGVmdFxuICAgICAgICA6IGRlZmF1bHRMYW5ndWFnZVxuXG4gICAgY29uc3QgaGlnaGxpZ2h0ZWRIdG1sID0gaGlnaGxpZ2h0KHtcbiAgICAgIGZpbGVDb250ZW50czogY29kZUJsb2NrLmlubmVyVGV4dCxcbiAgICAgIHNjb3BlTmFtZTogc2NvcGVGb3JGZW5jZU5hbWUoZmVuY2VOYW1lKSxcbiAgICAgIG5ic3A6IGZhbHNlLFxuICAgICAgbGluZURpdnM6IGZhbHNlLFxuICAgICAgZWRpdG9yRGl2OiB0cnVlLFxuICAgICAgZWRpdG9yRGl2VGFnOiAncHJlJyxcbiAgICAgIC8vIFRoZSBgZWRpdG9yYCBjbGFzcyBtZXNzZXMgdGhpbmdzIHVwIGFzIGAuZWRpdG9yYCBoYXMgYWJzb2x1dGVseSBwb3NpdGlvbmVkIGxpbmVzXG4gICAgICBlZGl0b3JEaXZDbGFzczogZmVuY2VOYW1lXG4gICAgICAgID8gYGVkaXRvci1jb2xvcnMgbGFuZy0ke2ZlbmNlTmFtZX1gXG4gICAgICAgIDogJ2VkaXRvci1jb2xvcnMnLFxuICAgIH0pXG5cbiAgICByZXR1cm4gKHByZUVsZW1lbnQub3V0ZXJIVE1MID0gaGlnaGxpZ2h0ZWRIdG1sKVxuICB9KVxuXG4gIHJldHVybiBkb2MuaW5uZXJIVE1MXG59XG4iXX0=