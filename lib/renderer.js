"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const highlight = require("atom-highlight");
const pandocHelper = require("./pandoc-helper");
const markdownIt = require("./markdown-it-helper");
const extension_helper_1 = require("./extension-helper");
const imageWatcher = require("./image-watch-helper");
const util_1 = require("./util");
const { resourcePath } = atom.getLoadSettings();
const packagePath = path.dirname(__dirname);
async function toDOMFragment(text, filePath, _grammar, renderLaTeX) {
    const html = await render(text, filePath, renderLaTeX, false);
    const template = document.createElement('template');
    template.innerHTML = html;
    const domFragment = template.content.cloneNode(true);
    return domFragment;
}
exports.toDOMFragment = toDOMFragment;
async function toHTML(text, filePath, grammar, renderLaTeX, copyHTMLFlag) {
    if (text === null) {
        text = '';
    }
    let html = await render(text, filePath, renderLaTeX, copyHTMLFlag);
    let defaultCodeLanguage;
    if ((grammar && grammar.scopeName) === 'source.litcoffee') {
        defaultCodeLanguage = 'coffee';
    }
    if (!atom.config.get('markdown-preview-plus.enablePandoc') ||
        !atom.config.get('markdown-preview-plus.useNativePandocCodeStyles')) {
        html = tokenizeCodeBlocks(html, defaultCodeLanguage);
    }
    return html;
}
exports.toHTML = toHTML;
async function render(text, filePath, renderLaTeX, copyHTMLFlag) {
    text = text.replace(/^\s*<!doctype(\s+.*)?>\s*/i, '');
    let html;
    if (atom.config.get('markdown-preview-plus.enablePandoc')) {
        html = await pandocHelper.renderPandoc(text, filePath, renderLaTeX);
    }
    else {
        html = markdownIt.render(text, renderLaTeX);
    }
    html = sanitize(html);
    html = await resolveImagePaths(html, filePath, copyHTMLFlag);
    return html.trim();
}
function sanitize(html) {
    const doc = document.createElement('div');
    doc.innerHTML = html;
    doc.querySelectorAll("script:not([type^='math/tex'])").forEach((elem) => {
        elem.remove();
    });
    const attributesToRemove = [
        'onabort',
        'onblur',
        'onchange',
        'onclick',
        'ondbclick',
        'onerror',
        'onfocus',
        'onkeydown',
        'onkeypress',
        'onkeyup',
        'onload',
        'onmousedown',
        'onmousemove',
        'onmouseover',
        'onmouseout',
        'onmouseup',
        'onreset',
        'onresize',
        'onscroll',
        'onselect',
        'onsubmit',
        'onunload',
    ];
    doc.querySelectorAll('*').forEach((elem) => attributesToRemove.map((attribute) => {
        elem.removeAttribute(attribute);
    }));
    return doc.innerHTML;
}
async function resolveImagePaths(html, filePath, copyHTMLFlag) {
    const [rootDirectory] = atom.project.relativizePath(filePath || '');
    const doc = document.createElement('div');
    doc.innerHTML = html;
    await Promise.all(Array.from(doc.querySelectorAll('img')).map(async function (img) {
        let src = img.getAttribute('src');
        if (src) {
            if (!atom.config.get('markdown-preview-plus.enablePandoc')) {
                src = markdownIt.decode(src);
            }
            if (src.match(/^(https?|atom|data):/)) {
                return;
            }
            if (src.startsWith(process.resourcesPath)) {
                return;
            }
            if (src.startsWith(resourcePath)) {
                return;
            }
            if (src.startsWith(packagePath)) {
                return;
            }
            if (src[0] === '/') {
                if (!util_1.isFileSync(src)) {
                    try {
                        if (rootDirectory !== null) {
                            src = path.join(rootDirectory, src.substring(1));
                        }
                    }
                    catch (e) {
                    }
                }
            }
            else if (filePath) {
                src = path.resolve(path.dirname(filePath), src);
            }
            if (!copyHTMLFlag) {
                const v = await imageWatcher.getVersion(src, filePath);
                if (v) {
                    src = `${src}?v=${v}`;
                }
            }
            img.src = src;
        }
        return;
    }));
    return doc.innerHTML;
}
function highlightCodeBlocks(domFragment, defaultLanguage = 'text') {
    const fontFamily = atom.config.get('editor.fontFamily');
    if (fontFamily) {
        for (const codeElement of Array.from(domFragment.querySelectorAll('code'))) {
            codeElement.style.fontFamily = fontFamily;
        }
    }
    for (const preElement of Array.from(domFragment.querySelectorAll('pre'))) {
        const codeBlock = preElement.firstElementChild !== null
            ? preElement.firstElementChild
            : preElement;
        const cbClass = codeBlock.className;
        const fenceName = cbClass
            ? cbClass.replace(/^(lang-|sourceCode )/, '')
            : defaultLanguage;
        preElement.outerHTML = highlight({
            fileContents: codeBlock.textContent.replace(/\n$/, ''),
            scopeName: extension_helper_1.scopeForFenceName(fenceName),
            nbsp: false,
            lineDivs: false,
            editorDiv: true,
            editorDivTag: 'atom-text-editor',
            editorDivClass: fenceName ? `lang-${fenceName}` : '',
        });
    }
    return domFragment;
}
exports.highlightCodeBlocks = highlightCodeBlocks;
function tokenizeCodeBlocks(html, defaultLanguage = 'text') {
    const doc = document.createElement('div');
    doc.innerHTML = html;
    const fontFamily = atom.config.get('editor.fontFamily');
    if (fontFamily) {
        doc
            .querySelectorAll('code')
            .forEach((code) => (code.style.fontFamily = fontFamily || null));
    }
    doc.querySelectorAll('pre').forEach(function (preElement) {
        const codeBlock = preElement.firstElementChild;
        const fenceName = codeBlock.className.replace(/^(lang-|sourceCode )/, '') || defaultLanguage;
        const highlightedHtml = highlight({
            fileContents: codeBlock.innerText,
            scopeName: extension_helper_1.scopeForFenceName(fenceName),
            nbsp: false,
            lineDivs: false,
            editorDiv: true,
            editorDivTag: 'pre',
            editorDivClass: fenceName
                ? `editor-colors lang-${fenceName}`
                : 'editor-colors',
        });
        preElement.outerHTML = highlightedHtml;
    });
    return doc.innerHTML;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVuZGVyZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcmVuZGVyZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw2QkFBNkI7QUFDN0IsNENBQTRDO0FBQzVDLGdEQUFnRDtBQUNoRCxtREFBbUQ7QUFDbkQseURBQXNEO0FBQ3RELHFEQUFxRDtBQUVyRCxpQ0FBbUM7QUFFbkMsTUFBTSxFQUFFLFlBQVksRUFBRSxHQUFHLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQTtBQUMvQyxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFBO0FBRXBDLEtBQUssd0JBQ1YsSUFBWSxFQUNaLFFBQTRCLEVBQzVCLFFBQWEsRUFDYixXQUFvQjtJQUVwQixNQUFNLElBQUksR0FBRyxNQUFNLE1BQU0sQ0FBQyxJQUFJLEVBQUUsUUFBUSxFQUFFLFdBQVcsRUFBRSxLQUFLLENBQUMsQ0FBQTtJQUU3RCxNQUFNLFFBQVEsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxDQUFBO0lBQ25ELFFBQVEsQ0FBQyxTQUFTLEdBQUcsSUFBSyxDQUFBO0lBQzFCLE1BQU0sV0FBVyxHQUFHLFFBQVEsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFBO0lBRXBELE1BQU0sQ0FBQyxXQUFXLENBQUE7QUFDcEIsQ0FBQztBQWJELHNDQWFDO0FBRU0sS0FBSyxpQkFDVixJQUFtQixFQUNuQixRQUE0QixFQUM1QixPQUE0QixFQUM1QixXQUFvQixFQUNwQixZQUFxQjtJQUVyQixFQUFFLENBQUMsQ0FBQyxJQUFJLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FBQztRQUNsQixJQUFJLEdBQUcsRUFBRSxDQUFBO0lBQ1gsQ0FBQztJQUNELElBQUksSUFBSSxHQUFHLE1BQU0sTUFBTSxDQUFDLElBQUksRUFBRSxRQUFRLEVBQUUsV0FBVyxFQUFFLFlBQVksQ0FBQyxDQUFBO0lBQ2xFLElBQUks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U0FDcEIsQ0FBQyxDQUFBO1FBRUYsVUFBVSxDQUFDLFNBQVMsR0FBRyxlQUFlLENBQUE7SUFDeEMsQ0FBQyxDQUFDLENBQUE7SUFFRixNQUFNLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQTtBQUN0QixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHBhdGggPSByZXF1aXJlKCdwYXRoJylcbmltcG9ydCBoaWdobGlnaHQgPSByZXF1aXJlKCdhdG9tLWhpZ2hsaWdodCcpXG5pbXBvcnQgcGFuZG9jSGVscGVyID0gcmVxdWlyZSgnLi9wYW5kb2MtaGVscGVyJylcbmltcG9ydCBtYXJrZG93bkl0ID0gcmVxdWlyZSgnLi9tYXJrZG93bi1pdC1oZWxwZXInKSAvLyBEZWZlciB1bnRpbCB1c2VkXG5pbXBvcnQgeyBzY29wZUZvckZlbmNlTmFtZSB9IGZyb20gJy4vZXh0ZW5zaW9uLWhlbHBlcidcbmltcG9ydCBpbWFnZVdhdGNoZXIgPSByZXF1aXJlKCcuL2ltYWdlLXdhdGNoLWhlbHBlcicpXG5pbXBvcnQgeyBHcmFtbWFyIH0gZnJvbSAnYXRvbSdcbmltcG9ydCB7IGlzRmlsZVN5bmMgfSBmcm9tICcuL3V0aWwnXG5cbmNvbnN0IHsgcmVzb3VyY2VQYXRoIH0gPSBhdG9tLmdldExvYWRTZXR0aW5ncygpXG5jb25zdCBwYWNrYWdlUGF0aCA9IHBhdGguZGlybmFtZShfX2Rpcm5hbWUpXG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB0b0RPTUZyYWdtZW50KFxuICB0ZXh0OiBzdHJpbmcsXG4gIGZpbGVQYXRoOiBzdHJpbmcgfCB1bmRlZmluZWQsXG4gIF9ncmFtbWFyOiBhbnksXG4gIHJlbmRlckxhVGVYOiBib29sZWFuLFxuKTogUHJvbWlzZTxOb2RlPiB7XG4gIGNvbnN0IGh0bWwgPSBhd2FpdCByZW5kZXIodGV4dCwgZmlsZVBhdGgsIHJlbmRlckxhVGVYLCBmYWxzZSlcblxuICBjb25zdCB0ZW1wbGF0ZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RlbXBsYXRlJylcbiAgdGVtcGxhdGUuaW5uZXJIVE1MID0gaHRtbCFcbiAgY29uc3QgZG9tRnJhZ21lbnQgPSB0ZW1wbGF0ZS5jb250ZW50LmNsb25lTm9kZSh0cnVlKVxuXG4gIHJldHVybiBkb21GcmFnbWVudFxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdG9IVE1MKFxuICB0ZXh0OiBzdHJpbmcgfCBudWxsLFxuICBmaWxlUGF0aDogc3RyaW5nIHwgdW5kZWZpbmVkLFxuICBncmFtbWFyOiBHcmFtbWFyIHwgdW5kZWZpbmVkLFxuICByZW5kZXJMYVRlWDogYm9vbGVhbixcbiAgY29weUhUTUxGbGFnOiBib29sZWFuLFxuKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgaWYgKHRleHQgPT09IG51bGwpIHtcbiAgICB0ZXh0ID0gJydcbiAgfVxuICBsZXQgaHRtbCA9IGF3YWl0IHJlbmRlcih0ZXh0LCBmaWxlUGF0aCwgcmVuZGVyTGFUZVgsIGNvcHlIVE1MRmxhZylcbiAgbGV0IGRlZmF1bHRDb2RlTGFuZ3VhZ2U6IHN0cmluZyB8IHVuZGVmaW5lZFxuICAvLyBEZWZhdWx0IGNvZGUgYmxvY2tzIHRvIGJlIGNvZmZlZSBpbiBMaXRlcmF0ZSBDb2ZmZWVTY3JpcHQgZmlsZXNcbiAgaWYgKChncmFtbWFyICYmIGdyYW1tYXIuc2NvcGVOYW1lKSA9PT0gJ3NvdXJjZS5saXRjb2ZmZWUnKSB7XG4gICAgZGVmYXVsdENvZGVMYW5ndWFnZSA9ICdjb2ZmZWUnXG4gIH1cbiAgaWYgKFxuICAgICFhdG9tLmNvbmZpZy5nZXQoJ21hcmtkb3duLXByZXZpZXctcGx1cy5lbmFibGVQYW5kb2MnKSB8fFxuICAgICFhdG9tLmNvbmZpZy5nZXQoJ21hcmtkb3duLXByZXZpZXctcGx1cy51c2VOYXRpdmVQYW5kb2NDb2RlU3R5bGVzJylcbiAgKSB7XG4gICAgaHRtbCA9IHRva2VuaXplQ29kZUJsb2NrcyhodG1sLCBkZWZhdWx0Q29kZUxhbmd1YWdlKVxuICB9XG4gIHJldHVybiBodG1sXG59XG5cbmFzeW5jIGZ1bmN0aW9uIHJlbmRlcihcbiAgdGV4dDogc3RyaW5nLFxuICBmaWxlUGF0aDogc3RyaW5nIHwgdW5kZWZpbmVkLFxuICByZW5kZXJMYVRlWDogYm9vbGVhbixcbiAgY29weUhUTUxGbGFnOiBib29sZWFuLFxuKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgLy8gUmVtb3ZlIHRoZSA8IWRvY3R5cGU+IHNpbmNlIG90aGVyd2lzZSBtYXJrZWQgd2lsbCBlc2NhcGUgaXRcbiAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2NoamovbWFya2VkL2lzc3Vlcy8zNTRcbiAgdGV4dCA9IHRleHQucmVwbGFjZSgvXlxccyo8IWRvY3R5cGUoXFxzKy4qKT8+XFxzKi9pLCAnJylcblxuICBsZXQgaHRtbFxuICBpZiAoYXRvbS5jb25maWcuZ2V0KCdtYXJrZG93bi1wcmV2aWV3LXBsdXMuZW5hYmxlUGFuZG9jJykpIHtcbiAgICBodG1sID0gYXdhaXQgcGFuZG9jSGVscGVyLnJlbmRlclBhbmRvYyh0ZXh0LCBmaWxlUGF0aCwgcmVuZGVyTGFUZVgpXG4gIH0gZWxzZSB7XG4gICAgaHRtbCA9IG1hcmtkb3duSXQucmVuZGVyKHRleHQsIHJlbmRlckxhVGVYKVxuICB9XG4gIGh0bWwgPSBzYW5pdGl6ZShodG1sKVxuICBodG1sID0gYXdhaXQgcmVzb2x2ZUltYWdlUGF0aHMoaHRtbCwgZmlsZVBhdGgsIGNvcHlIVE1MRmxhZylcbiAgcmV0dXJuIGh0bWwudHJpbSgpXG59XG5cbmZ1bmN0aW9uIHNhbml0aXplKGh0bWw6IHN0cmluZykge1xuICBjb25zdCBkb2MgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKVxuICBkb2MuaW5uZXJIVE1MID0gaHRtbFxuICAvLyBEbyBub3QgcmVtb3ZlIE1hdGhKYXggc2NyaXB0IGRlbGltaXRlZCBibG9ja3NcbiAgZG9jLnF1ZXJ5U2VsZWN0b3JBbGwoXCJzY3JpcHQ6bm90KFt0eXBlXj0nbWF0aC90ZXgnXSlcIikuZm9yRWFjaCgoZWxlbSkgPT4ge1xuICAgIGVsZW0ucmVtb3ZlKClcbiAgfSlcbiAgY29uc3QgYXR0cmlidXRlc1RvUmVtb3ZlID0gW1xuICAgICdvbmFib3J0JyxcbiAgICAnb25ibHVyJyxcbiAgICAnb25jaGFuZ2UnLFxuICAgICdvbmNsaWNrJyxcbiAgICAnb25kYmNsaWNrJyxcbiAgICAnb25lcnJvcicsXG4gICAgJ29uZm9jdXMnLFxuICAgICdvbmtleWRvd24nLFxuICAgICdvbmtleXByZXNzJyxcbiAgICAnb25rZXl1cCcsXG4gICAgJ29ubG9hZCcsXG4gICAgJ29ubW91c2Vkb3duJyxcbiAgICAnb25tb3VzZW1vdmUnLFxuICAgICdvbm1vdXNlb3ZlcicsXG4gICAgJ29ubW91c2VvdXQnLFxuICAgICdvbm1vdXNldXAnLFxuICAgICdvbnJlc2V0JyxcbiAgICAnb25yZXNpemUnLFxuICAgICdvbnNjcm9sbCcsXG4gICAgJ29uc2VsZWN0JyxcbiAgICAnb25zdWJtaXQnLFxuICAgICdvbnVubG9hZCcsXG4gIF1cbiAgZG9jLnF1ZXJ5U2VsZWN0b3JBbGwoJyonKS5mb3JFYWNoKChlbGVtKSA9PlxuICAgIGF0dHJpYnV0ZXNUb1JlbW92ZS5tYXAoKGF0dHJpYnV0ZSkgPT4ge1xuICAgICAgZWxlbS5yZW1vdmVBdHRyaWJ1dGUoYXR0cmlidXRlKVxuICAgIH0pLFxuICApXG4gIHJldHVybiBkb2MuaW5uZXJIVE1MXG59XG5cbmFzeW5jIGZ1bmN0aW9uIHJlc29sdmVJbWFnZVBhdGhzKFxuICBodG1sOiBzdHJpbmcsXG4gIGZpbGVQYXRoOiBzdHJpbmcgfCB1bmRlZmluZWQsXG4gIGNvcHlIVE1MRmxhZzogYm9vbGVhbixcbikge1xuICBjb25zdCBbcm9vdERpcmVjdG9yeV0gPSBhdG9tLnByb2plY3QucmVsYXRpdml6ZVBhdGgoZmlsZVBhdGggfHwgJycpXG4gIGNvbnN0IGRvYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpXG4gIGRvYy5pbm5lckhUTUwgPSBodG1sXG4gIGF3YWl0IFByb21pc2UuYWxsKFxuICAgIEFycmF5LmZyb20oZG9jLnF1ZXJ5U2VsZWN0b3JBbGwoJ2ltZycpKS5tYXAoYXN5bmMgZnVuY3Rpb24oaW1nKSB7XG4gICAgICBsZXQgc3JjID0gaW1nLmdldEF0dHJpYnV0ZSgnc3JjJylcbiAgICAgIGlmIChzcmMpIHtcbiAgICAgICAgaWYgKCFhdG9tLmNvbmZpZy5nZXQoJ21hcmtkb3duLXByZXZpZXctcGx1cy5lbmFibGVQYW5kb2MnKSkge1xuICAgICAgICAgIHNyYyA9IG1hcmtkb3duSXQuZGVjb2RlKHNyYylcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChzcmMubWF0Y2goL14oaHR0cHM/fGF0b218ZGF0YSk6LykpIHtcbiAgICAgICAgICByZXR1cm5cbiAgICAgICAgfVxuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIGlmIChzcmMuc3RhcnRzV2l0aChwcm9jZXNzLnJlc291cmNlc1BhdGggYXMgc3RyaW5nKSkge1xuICAgICAgICAgIHJldHVyblxuICAgICAgICB9XG4gICAgICAgIGlmIChzcmMuc3RhcnRzV2l0aChyZXNvdXJjZVBhdGgpKSB7XG4gICAgICAgICAgcmV0dXJuXG4gICAgICAgIH1cbiAgICAgICAgaWYgKHNyYy5zdGFydHNXaXRoKHBhY2thZ2VQYXRoKSkge1xuICAgICAgICAgIHJldHVyblxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHNyY1swXSA9PT0gJy8nKSB7XG4gICAgICAgICAgaWYgKCFpc0ZpbGVTeW5jKHNyYykpIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgIGlmIChyb290RGlyZWN0b3J5ICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgc3JjID0gcGF0aC5qb2luKHJvb3REaXJlY3RvcnksIHNyYy5zdWJzdHJpbmcoMSkpXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgLy8gbm9vcFxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmIChmaWxlUGF0aCkge1xuICAgICAgICAgIHNyYyA9IHBhdGgucmVzb2x2ZShwYXRoLmRpcm5hbWUoZmlsZVBhdGgpLCBzcmMpXG4gICAgICAgIH1cblxuICAgICAgICAvLyBVc2UgbW9zdCByZWNlbnQgdmVyc2lvbiBvZiBpbWFnZVxuICAgICAgICBpZiAoIWNvcHlIVE1MRmxhZykge1xuICAgICAgICAgIGNvbnN0IHYgPSBhd2FpdCBpbWFnZVdhdGNoZXIuZ2V0VmVyc2lvbihzcmMsIGZpbGVQYXRoKVxuICAgICAgICAgIGlmICh2KSB7XG4gICAgICAgICAgICBzcmMgPSBgJHtzcmN9P3Y9JHt2fWBcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpbWcuc3JjID0gc3JjXG4gICAgICB9XG4gICAgICByZXR1cm5cbiAgICB9KSxcbiAgKVxuXG4gIHJldHVybiBkb2MuaW5uZXJIVE1MXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBoaWdobGlnaHRDb2RlQmxvY2tzKFxuICBkb21GcmFnbWVudDogRWxlbWVudCxcbiAgZGVmYXVsdExhbmd1YWdlOiBzdHJpbmcgPSAndGV4dCcsXG4pIHtcbiAgY29uc3QgZm9udEZhbWlseSA9IGF0b20uY29uZmlnLmdldCgnZWRpdG9yLmZvbnRGYW1pbHknKVxuICBpZiAoZm9udEZhbWlseSkge1xuICAgIGZvciAoY29uc3QgY29kZUVsZW1lbnQgb2YgQXJyYXkuZnJvbShcbiAgICAgIGRvbUZyYWdtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ2NvZGUnKSxcbiAgICApKSB7XG4gICAgICBjb2RlRWxlbWVudC5zdHlsZS5mb250RmFtaWx5ID0gZm9udEZhbWlseVxuICAgIH1cbiAgfVxuXG4gIGZvciAoY29uc3QgcHJlRWxlbWVudCBvZiBBcnJheS5mcm9tKGRvbUZyYWdtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ3ByZScpKSkge1xuICAgIGNvbnN0IGNvZGVCbG9jayA9XG4gICAgICBwcmVFbGVtZW50LmZpcnN0RWxlbWVudENoaWxkICE9PSBudWxsXG4gICAgICAgID8gcHJlRWxlbWVudC5maXJzdEVsZW1lbnRDaGlsZFxuICAgICAgICA6IHByZUVsZW1lbnRcbiAgICBjb25zdCBjYkNsYXNzID0gY29kZUJsb2NrLmNsYXNzTmFtZVxuICAgIGNvbnN0IGZlbmNlTmFtZSA9IGNiQ2xhc3NcbiAgICAgID8gY2JDbGFzcy5yZXBsYWNlKC9eKGxhbmctfHNvdXJjZUNvZGUgKS8sICcnKVxuICAgICAgOiBkZWZhdWx0TGFuZ3VhZ2VcblxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby11bnNhZmUtYW55XG4gICAgcHJlRWxlbWVudC5vdXRlckhUTUwgPSBoaWdobGlnaHQoe1xuICAgICAgZmlsZUNvbnRlbnRzOiBjb2RlQmxvY2sudGV4dENvbnRlbnQhLnJlcGxhY2UoL1xcbiQvLCAnJyksXG4gICAgICBzY29wZU5hbWU6IHNjb3BlRm9yRmVuY2VOYW1lKGZlbmNlTmFtZSksXG4gICAgICBuYnNwOiBmYWxzZSxcbiAgICAgIGxpbmVEaXZzOiBmYWxzZSxcbiAgICAgIGVkaXRvckRpdjogdHJ1ZSxcbiAgICAgIGVkaXRvckRpdlRhZzogJ2F0b20tdGV4dC1lZGl0b3InLFxuICAgICAgLy8gVGhlIGBlZGl0b3JgIGNsYXNzIG1lc3NlcyB0aGluZ3MgdXAgYXMgYC5lZGl0b3JgIGhhcyBhYnNvbHV0ZWx5IHBvc2l0aW9uZWQgbGluZXNcbiAgICAgIGVkaXRvckRpdkNsYXNzOiBmZW5jZU5hbWUgPyBgbGFuZy0ke2ZlbmNlTmFtZX1gIDogJycsXG4gICAgfSlcbiAgfVxuXG4gIHJldHVybiBkb21GcmFnbWVudFxufVxuXG5mdW5jdGlvbiB0b2tlbml6ZUNvZGVCbG9ja3MoaHRtbDogc3RyaW5nLCBkZWZhdWx0TGFuZ3VhZ2U6IHN0cmluZyA9ICd0ZXh0Jykge1xuICBjb25zdCBkb2MgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKVxuICBkb2MuaW5uZXJIVE1MID0gaHRtbFxuXG4gIGNvbnN0IGZvbnRGYW1pbHkgPSBhdG9tLmNvbmZpZy5nZXQoJ2VkaXRvci5mb250RmFtaWx5JylcbiAgaWYgKGZvbnRGYW1pbHkpIHtcbiAgICBkb2NcbiAgICAgIC5xdWVyeVNlbGVjdG9yQWxsKCdjb2RlJylcbiAgICAgIC5mb3JFYWNoKChjb2RlKSA9PiAoY29kZS5zdHlsZS5mb250RmFtaWx5ID0gZm9udEZhbWlseSB8fCBudWxsKSlcbiAgfVxuXG4gIGRvYy5xdWVyeVNlbGVjdG9yQWxsKCdwcmUnKS5mb3JFYWNoKGZ1bmN0aW9uKHByZUVsZW1lbnQpIHtcbiAgICBjb25zdCBjb2RlQmxvY2sgPSBwcmVFbGVtZW50LmZpcnN0RWxlbWVudENoaWxkIGFzIEhUTUxFbGVtZW50XG4gICAgY29uc3QgZmVuY2VOYW1lID1cbiAgICAgIGNvZGVCbG9jay5jbGFzc05hbWUucmVwbGFjZSgvXihsYW5nLXxzb3VyY2VDb2RlICkvLCAnJykgfHwgZGVmYXVsdExhbmd1YWdlXG5cbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tdW5zYWZlLWFueSAvLyBUT0RPOiB0c2xpbnQgYnVnP1xuICAgIGNvbnN0IGhpZ2hsaWdodGVkSHRtbDogc3RyaW5nID0gaGlnaGxpZ2h0KHtcbiAgICAgIGZpbGVDb250ZW50czogY29kZUJsb2NrLmlubmVyVGV4dCxcbiAgICAgIHNjb3BlTmFtZTogc2NvcGVGb3JGZW5jZU5hbWUoZmVuY2VOYW1lKSxcbiAgICAgIG5ic3A6IGZhbHNlLFxuICAgICAgbGluZURpdnM6IGZhbHNlLFxuICAgICAgZWRpdG9yRGl2OiB0cnVlLFxuICAgICAgZWRpdG9yRGl2VGFnOiAncHJlJyxcbiAgICAgIC8vIFRoZSBgZWRpdG9yYCBjbGFzcyBtZXNzZXMgdGhpbmdzIHVwIGFzIGAuZWRpdG9yYCBoYXMgYWJzb2x1dGVseSBwb3NpdGlvbmVkIGxpbmVzXG4gICAgICBlZGl0b3JEaXZDbGFzczogZmVuY2VOYW1lXG4gICAgICAgID8gYGVkaXRvci1jb2xvcnMgbGFuZy0ke2ZlbmNlTmFtZX1gXG4gICAgICAgIDogJ2VkaXRvci1jb2xvcnMnLFxuICAgIH0pXG5cbiAgICBwcmVFbGVtZW50Lm91dGVySFRNTCA9IGhpZ2hsaWdodGVkSHRtbFxuICB9KVxuXG4gIHJldHVybiBkb2MuaW5uZXJIVE1MXG59XG4iXX0=