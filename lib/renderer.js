"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const highlight = require("atom-highlight");
const pandocHelper = require("./pandoc-helper");
const markdownIt = require("./markdown-it-helper");
const extension_helper_1 = require("./extension-helper");
const imageWatcher = require("./image-watch-helper");
const util_1 = require("./util");
const util_common_1 = require("./util-common");
const { resourcePath } = atom.getLoadSettings();
const packagePath = path.dirname(__dirname);
async function render(text, filePath, grammar, renderLaTeX, mode, savePath) {
    text = text.replace(/^\s*<!doctype(\s+.*)?>\s*/i, '');
    let html;
    let error;
    if (util_1.atomConfig().renderer === 'pandoc') {
        try {
            html = await pandocHelper.renderPandoc(text, filePath, renderLaTeX);
        }
        catch (err) {
            const e = err;
            if (e.html === undefined)
                throw e;
            error = e.message;
            html = e.html;
        }
    }
    else {
        html = markdownIt.render(text, renderLaTeX);
    }
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    sanitize(doc);
    if (mode === 'normal') {
        await resolveImagePaths(doc, filePath, {
            version: true,
            relativize: false,
        });
    }
    else if (mode === 'save') {
        const saveBehaviour = util_1.atomConfig().saveConfig.mediaOnSaveAsHTMLBehaviour;
        const relativize = saveBehaviour === 'relativized';
        switch (saveBehaviour) {
            case 'relativized':
            case 'absolutized':
                await resolveImagePaths(doc, filePath, {
                    version: false,
                    relativize,
                }, savePath);
                break;
            case 'untouched':
        }
    }
    else if (mode === 'copy') {
    }
    let defaultCodeLanguage = 'text';
    if ((grammar && grammar.scopeName) === 'source.litcoffee') {
        defaultCodeLanguage = 'coffee';
    }
    if (!(util_1.atomConfig().renderer === 'pandoc' &&
        util_1.atomConfig().pandocConfig.useNativePandocCodeStyles)) {
        highlightCodeBlocks(doc, defaultCodeLanguage, mode !== 'normal');
    }
    if (error) {
        const errd = doc.createElement('div');
        const msgel = doc.createElement('code');
        msgel.innerText = error;
        errd.innerHTML = `<h1>Pandoc Error:</h1>${msgel.outerHTML}<hr>`;
        doc.body.insertBefore(errd, doc.body.firstElementChild);
    }
    return doc;
}
exports.render = render;
function sanitize(doc) {
    doc.querySelectorAll("script:not([type^='math/tex'])").forEach((elem) => {
        elem.remove();
    });
    const attributesToRemove = [
        'onabort',
        'onblur',
        'onchange',
        'onclick',
        'ondbclick',
        'onerror',
        'onfocus',
        'onkeydown',
        'onkeypress',
        'onkeyup',
        'onload',
        'onmousedown',
        'onmousemove',
        'onmouseover',
        'onmouseout',
        'onmouseup',
        'onreset',
        'onresize',
        'onscroll',
        'onselect',
        'onsubmit',
        'onunload',
    ];
    doc.querySelectorAll('*').forEach((elem) => attributesToRemove.map((attribute) => {
        elem.removeAttribute(attribute);
    }));
}
async function resolveImagePaths(doc, filePath, options, savePath) {
    const [rootDirectory] = atom.project.relativizePath(filePath || '');
    const media = util_common_1.getMedia(doc);
    await Promise.all(Array.from(media).map(async function (img) {
        let src = img.getAttribute('src');
        if (src) {
            if (util_1.atomConfig().renderer !== 'pandoc') {
                src = decodeURI(src);
            }
            if (src.match(/^(https?|atom|data):/)) {
                return;
            }
            if (process.resourcesPath && src.startsWith(process.resourcesPath)) {
                return;
            }
            if (src.startsWith(resourcePath)) {
                return;
            }
            if (src.startsWith(packagePath)) {
                return;
            }
            if (src[0] === '/') {
                if (!util_1.isFileSync(src)) {
                    try {
                        if (rootDirectory !== null) {
                            src = path.join(rootDirectory, src.substring(1));
                        }
                    }
                    catch (e) {
                    }
                }
            }
            else if (filePath) {
                src = path.resolve(path.dirname(filePath), src);
            }
            if (options.relativize &&
                (filePath !== undefined || savePath !== undefined)) {
                const fp = savePath !== undefined ? savePath : filePath;
                src = path.relative(path.dirname(fp), src);
            }
            if (options.version) {
                const v = await imageWatcher.getVersion(src, filePath);
                if (v) {
                    src = `${src}?v=${v}`;
                }
            }
            img.src = src;
        }
        return;
    }));
}
function highlightCodeBlocks(domFragment, defaultLanguage, copyHTML) {
    const fontFamily = atom.config.get('editor.fontFamily');
    if (fontFamily) {
        for (const codeElement of Array.from(domFragment.querySelectorAll('code'))) {
            codeElement.style.fontFamily = fontFamily;
        }
    }
    for (const preElement of Array.from(domFragment.querySelectorAll('pre'))) {
        const codeBlock = preElement.firstElementChild !== null
            ? preElement.firstElementChild
            : preElement;
        const cbClass = codeBlock.className;
        const fenceName = cbClass
            ? cbClass.replace(/^(lang-|sourceCode )/, '')
            : defaultLanguage;
        const addClass = copyHTML ? 'editor-colors ' : '';
        preElement.outerHTML = highlight({
            fileContents: codeBlock.textContent.replace(/\n$/, ''),
            scopeName: extension_helper_1.scopeForFenceName(fenceName),
            nbsp: false,
            lineDivs: copyHTML ? false : true,
            editorDiv: true,
            editorDivTag: copyHTML ? 'pre' : 'atom-text-editor',
            editorDivClass: fenceName ? `${addClass}lang-${fenceName}` : addClass,
        });
    }
    return domFragment;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVuZGVyZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcmVuZGVyZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw2QkFBNkI7QUFDN0IsNENBQTRDO0FBQzVDLGdEQUFnRDtBQUNoRCxtREFBbUQ7QUFDbkQseURBQXNEO0FBQ3RELHFEQUFxRDtBQUVyRCxpQ0FBK0M7QUFDL0MsK0NBQXdDO0FBRXhDLE1BQU0sRUFBRSxZQUFZLEVBQUUsR0FBRyxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUE7QUFDL0MsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQTtBQUlwQyxLQUFLLGlCQUNWLElBQVksRUFDWixRQUE0QixFQUM1QixPQUE0QixFQUM1QixXQUFvQixFQUNwQixJQUFnQixFQUNoQixRQUFpQjtJQUlqQixJQUFJLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyw0QkFBNEIsRUFBRSxFQUFFLENBQUMsQ0FBQTtJQUVyRCxJQUFJLElBQUksQ0FBQTtJQUNSLElBQUksS0FBSyxDQUFBO0lBQ1QsSUFBSSxpQkFBVSxFQUFFLENBQUMsUUFBUSxLQUFLLFFBQVEsRUFBRTtRQUN0QyxJQUFJO1lBQ0YsSUFBSSxHQUFHLE1BQU0sWUFBWSxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsUUFBUSxFQUFFLFdBQVcsQ0FBQyxDQUFBO1NBQ3BFO1FBQUMsT0FBTyxHQUFHLEVBQUU7WUFDWixNQUFNLENBQUMsR0FBRyxHQUFnQyxDQUFBO1lBQzFDLElBQUksQ0FBQyxDQUFDLElBQUksS0FBSyxTQUFTO2dCQUFFLE1BQU0sQ0FBQyxDQUFBO1lBQ2pDLEtBQUssR0FBRyxDQUFDLENBQUMsT0FBaUIsQ0FBQTtZQUMzQixJQUFJLEdBQUcsQ0FBQyxDQUFDLElBQWMsQ0FBQTtTQUN4QjtLQUNGO1NBQU07UUFDTCxJQUFJLEdBQUcsVUFBVSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsV0FBVyxDQUFDLENB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LENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLGtCQUFrQjtZQUVuRCxjQUFjLEVBQUUsU0FBUyxDQUFDLENBQUMsQ0FBQyxHQUFHLFFBQVEsUUFBUSxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUMsUUFBUTtTQUN0RSxDQUFDLENBQUE7S0FDSDtJQUVELE9BQU8sV0FBVyxDQUFBO0FBQ3BCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKVxuaW1wb3J0IGhpZ2hsaWdodCA9IHJlcXVpcmUoJ2F0b20taGlnaGxpZ2h0JylcbmltcG9ydCBwYW5kb2NIZWxwZXIgPSByZXF1aXJlKCcuL3BhbmRvYy1oZWxwZXInKVxuaW1wb3J0IG1hcmtkb3duSXQgPSByZXF1aXJlKCcuL21hcmtkb3duLWl0LWhlbHBlcicpIC8vIERlZmVyIHVudGlsIHVzZWRcbmltcG9ydCB7IHNjb3BlRm9yRmVuY2VOYW1lIH0gZnJvbSAnLi9leHRlbnNpb24taGVscGVyJ1xuaW1wb3J0IGltYWdlV2F0Y2hlciA9IHJlcXVpcmUoJy4vaW1hZ2Utd2F0Y2gtaGVscGVyJylcbmltcG9ydCB7IEdyYW1tYXIgfSBmcm9tICdhdG9tJ1xuaW1wb3J0IHsgaXNGaWxlU3luYywgYXRvbUNvbmZpZyB9IGZyb20gJy4vdXRpbCdcbmltcG9ydCB7IGdldE1lZGlhIH0gZnJvbSAnLi91dGlsLWNvbW1vbidcblxuY29uc3QgeyByZXNvdXJjZVBhdGggfSA9IGF0b20uZ2V0TG9hZFNldHRpbmdzKClcbmNvbnN0IHBhY2thZ2VQYXRoID0gcGF0aC5kaXJuYW1lKF9fZGlybmFtZSlcblxuZXhwb3J0IHR5cGUgUmVuZGVyTW9kZSA9ICdub3JtYWwnIHwgJ2NvcHknIHwgJ3NhdmUnXG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiByZW5kZXIoXG4gIHRleHQ6IHN0cmluZyxcbiAgZmlsZVBhdGg6IHN0cmluZyB8IHVuZGVmaW5lZCxcbiAgZ3JhbW1hcjogR3JhbW1hciB8IHVuZGVmaW5lZCxcbiAgcmVuZGVyTGFUZVg6IGJvb2xlYW4sXG4gIG1vZGU6IFJlbmRlck1vZGUsXG4gIHNhdmVQYXRoPzogc3RyaW5nLFxuKTogUHJvbWlzZTxIVE1MRG9jdW1lbnQ+IHtcbiAgLy8gUmVtb3ZlIHRoZSA8IWRvY3R5cGU+IHNpbmNlIG90aGVyd2lzZSBtYXJrZWQgd2lsbCBlc2NhcGUgaXRcbiAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2NoamovbWFya2VkL2lzc3Vlcy8zNTRcbiAgdGV4dCA9IHRleHQucmVwbGFjZSgvXlxccyo8IWRvY3R5cGUoXFxzKy4qKT8+XFxzKi9pLCAnJylcblxuICBsZXQgaHRtbFxuICBsZXQgZXJyb3JcbiAgaWYgKGF0b21Db25maWcoKS5yZW5kZXJlciA9PT0gJ3BhbmRvYycpIHtcbiAgICB0cnkge1xuICAgICAgaHRtbCA9IGF3YWl0IHBhbmRvY0hlbHBlci5yZW5kZXJQYW5kb2ModGV4dCwgZmlsZVBhdGgsIHJlbmRlckxhVGVYKVxuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgY29uc3QgZSA9IGVyciBhcyBFcnJvciAmIHsgaHRtbD86IHN0cmluZyB9XG4gICAgICBpZiAoZS5odG1sID09PSB1bmRlZmluZWQpIHRocm93IGVcbiAgICAgIGVycm9yID0gZS5tZXNzYWdlIGFzIHN0cmluZ1xuICAgICAgaHRtbCA9IGUuaHRtbCBhcyBzdHJpbmdcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgaHRtbCA9IG1hcmtkb3duSXQucmVuZGVyKHRleHQsIHJlbmRlckxhVGVYKVxuICB9XG4gIGNvbnN0IHBhcnNlciA9IG5ldyBET01QYXJzZXIoKVxuICBjb25zdCBkb2MgPSBwYXJzZXIucGFyc2VGcm9tU3RyaW5nKGh0bWwsICd0ZXh0L2h0bWwnKVxuICBzYW5pdGl6ZShkb2MpXG4gIGlmIChtb2RlID09PSAnbm9ybWFsJykge1xuICAgIGF3YWl0IHJlc29sdmVJbWFnZVBhdGhzKGRvYywgZmlsZVBhdGgsIHtcbiAgICAgIHZlcnNpb246IHRydWUsXG4gICAgICByZWxhdGl2aXplOiBmYWxzZSxcbiAgICB9KVxuICB9IGVsc2UgaWYgKG1vZGUgPT09ICdzYXZlJykge1xuICAgIGNvbnN0IHNhdmVCZWhhdmlvdXIgPSBhdG9tQ29uZmlnKCkuc2F2ZUNvbmZpZy5tZWRpYU9uU2F2ZUFzSFRNTEJlaGF2aW91clxuICAgIGNvbnN0IHJlbGF0aXZpemUgPSBzYXZlQmVoYXZpb3VyID09PSAncmVsYXRpdml6ZWQnXG4gICAgc3dpdGNoIChzYXZlQmVoYXZpb3VyKSB7XG4gICAgICBjYXNlICdyZWxhdGl2aXplZCc6XG4gICAgICBjYXNlICdhYnNvbHV0aXplZCc6XG4gICAgICAgIGF3YWl0IHJlc29sdmVJbWFnZVBhdGhzKFxuICAgICAgICAgIGRvYyxcbiAgICAgICAgICBmaWxlUGF0aCxcbiAgICAgICAgICB7XG4gICAgICAgICAgICB2ZXJzaW9uOiBmYWxzZSxcbiAgICAgICAgICAgIHJlbGF0aXZpemUsXG4gICAgICAgICAgfSxcbiAgICAgICAgICBzYXZlUGF0aCxcbiAgICAgICAgKVxuICAgICAgICBicmVha1xuICAgICAgY2FzZSAndW50b3VjaGVkJzpcbiAgICAgIC8qIG5vb3AgKi9cbiAgICB9XG4gIH0gZWxzZSBpZiAobW9kZSA9PT0gJ2NvcHknKSB7XG4gICAgLyogbm9vcCAqL1xuICB9XG4gIGxldCBkZWZhdWx0Q29kZUxhbmd1YWdlOiBzdHJpbmcgPSAndGV4dCdcbiAgLy8gRGVmYXVsdCBjb2RlIGJsb2NrcyB0byBiZSBjb2ZmZWUgaW4gTGl0ZXJhdGUgQ29mZmVlU2NyaXB0IGZpbGVzXG4gIGlmICgoZ3JhbW1hciAmJiBncmFtbWFyLnNjb3BlTmFtZSkgPT09ICdzb3VyY2UubGl0Y29mZmVlJykge1xuICAgIGRlZmF1bHRDb2RlTGFuZ3VhZ2UgPSAnY29mZmVlJ1xuICB9XG4gIGlmIChcbiAgICAhKFxuICAgICAgYXRvbUNvbmZpZygpLnJlbmRlcmVyID09PSAncGFuZG9jJyAmJlxuICAgICAgYXRvbUNvbmZpZygpLnBhbmRvY0NvbmZpZy51c2VOYXRpdmVQYW5kb2NDb2RlU3R5bGVzXG4gICAgKVxuICApIHtcbiAgICBoaWdobGlnaHRDb2RlQmxvY2tzKGRvYywgZGVmYXVsdENvZGVMYW5ndWFnZSwgbW9kZSAhPT0gJ25vcm1hbCcpXG4gIH1cbiAgaWYgKGVycm9yKSB7XG4gICAgY29uc3QgZXJyZCA9IGRvYy5jcmVhdGVFbGVtZW50KCdkaXYnKVxuICAgIGNvbnN0IG1zZ2VsID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ2NvZGUnKVxuICAgIG1zZ2VsLmlubmVyVGV4dCA9IGVycm9yXG4gICAgZXJyZC5pbm5lckhUTUwgPSBgPGgxPlBhbmRvYyBFcnJvcjo8L2gxPiR7bXNnZWwub3V0ZXJIVE1MfTxocj5gXG4gICAgZG9jLmJvZHkuaW5zZXJ0QmVmb3JlKGVycmQsIGRvYy5ib2R5LmZpcnN0RWxlbWVudENoaWxkKVxuICB9XG4gIHJldHVybiBkb2Ncbn1cblxuZnVuY3Rpb24gc2FuaXRpemUoZG9jOiBIVE1MRG9jdW1lbnQpIHtcbiAgLy8gRG8gbm90IHJlbW92ZSBNYXRoSmF4IHNjcmlwdCBkZWxpbWl0ZWQgYmxvY2tzXG4gIGRvYy5xdWVyeVNlbGVjdG9yQWxsKFwic2NyaXB0Om5vdChbdHlwZV49J21hdGgvdGV4J10pXCIpLmZvckVhY2goKGVsZW0pID0+IHtcbiAgICBlbGVtLnJlbW92ZSgpXG4gIH0pXG4gIGNvbnN0IGF0dHJpYnV0ZXNUb1JlbW92ZSA9IFtcbiAgICAnb25hYm9ydCcsXG4gICAgJ29uYmx1cicsXG4gICAgJ29uY2hhbmdlJyxcbiAgICAnb25jbGljaycsXG4gICAgJ29uZGJjbGljaycsXG4gICAgJ29uZXJyb3InLFxuICAgICdvbmZvY3VzJyxcbiAgICAnb25rZXlkb3duJyxcbiAgICAnb25rZXlwcmVzcycsXG4gICAgJ29ua2V5dXAnLFxuICAgICdvbmxvYWQnLFxuICAgICdvbm1vdXNlZG93bicsXG4gICAgJ29ubW91c2Vtb3ZlJyxcbiAgICAnb25tb3VzZW92ZXInLFxuICAgICdvbm1vdXNlb3V0JyxcbiAgICAnb25tb3VzZXVwJyxcbiAgICAnb25yZXNldCcsXG4gICAgJ29ucmVzaXplJyxcbiAgICAnb25zY3JvbGwnLFxuICAgICdvbnNlbGVjdCcsXG4gICAgJ29uc3VibWl0JyxcbiAgICAnb251bmxvYWQnLFxuICBdXG4gIGRvYy5xdWVyeVNlbGVjdG9yQWxsKCcqJykuZm9yRWFjaCgoZWxlbSkgPT5cbiAgICBhdHRyaWJ1dGVzVG9SZW1vdmUubWFwKChhdHRyaWJ1dGUpID0+IHtcbiAgICAgIGVsZW0ucmVtb3ZlQXR0cmlidXRlKGF0dHJpYnV0ZSlcbiAgICB9KSxcbiAgKVxufVxuXG5hc3luYyBmdW5jdGlvbiByZXNvbHZlSW1hZ2VQYXRocyhcbiAgZG9jOiBIVE1MRG9jdW1lbnQsXG4gIGZpbGVQYXRoOiBzdHJpbmcgfCB1bmRlZmluZWQsXG4gIG9wdGlvbnM6IFJlY29yZDwndmVyc2lvbicgfCAncmVsYXRpdml6ZScsIGJvb2xlYW4+LFxuICBzYXZlUGF0aD86IHN0cmluZyxcbikge1xuICBjb25zdCBbcm9vdERpcmVjdG9yeV0gPSBhdG9tLnByb2plY3QucmVsYXRpdml6ZVBhdGgoZmlsZVBhdGggfHwgJycpXG4gIGNvbnN0IG1lZGlhID0gZ2V0TWVkaWEoZG9jKVxuICBhd2FpdCBQcm9taXNlLmFsbChcbiAgICBBcnJheS5mcm9tKG1lZGlhKS5tYXAoYXN5bmMgZnVuY3Rpb24oaW1nKSB7XG4gICAgICBsZXQgc3JjID0gaW1nLmdldEF0dHJpYnV0ZSgnc3JjJylcbiAgICAgIGlmIChzcmMpIHtcbiAgICAgICAgaWYgKGF0b21Db25maWcoKS5yZW5kZXJlciAhPT0gJ3BhbmRvYycpIHtcbiAgICAgICAgICBzcmMgPSBkZWNvZGVVUkkoc3JjKVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHNyYy5tYXRjaCgvXihodHRwcz98YXRvbXxkYXRhKTovKSkge1xuICAgICAgICAgIHJldHVyblxuICAgICAgICB9XG4gICAgICAgIGlmIChwcm9jZXNzLnJlc291cmNlc1BhdGggJiYgc3JjLnN0YXJ0c1dpdGgocHJvY2Vzcy5yZXNvdXJjZXNQYXRoKSkge1xuICAgICAgICAgIHJldHVyblxuICAgICAgICB9XG4gICAgICAgIGlmIChzcmMuc3RhcnRzV2l0aChyZXNvdXJjZVBhdGgpKSB7XG4gICAgICAgICAgcmV0dXJuXG4gICAgICAgIH1cbiAgICAgICAgaWYgKHNyYy5zdGFydHNXaXRoKHBhY2thZ2VQYXRoKSkge1xuICAgICAgICAgIHJldHVyblxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHNyY1swXSA9PT0gJy8nKSB7XG4gICAgICAgICAgaWYgKCFpc0ZpbGVTeW5jKHNyYykpIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgIGlmIChyb290RGlyZWN0b3J5ICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgc3JjID0gcGF0aC5qb2luKHJvb3REaXJlY3RvcnksIHNyYy5zdWJzdHJpbmcoMSkpXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgLy8gbm9vcFxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmIChmaWxlUGF0aCkge1xuICAgICAgICAgIHNyYyA9IHBhdGgucmVzb2x2ZShwYXRoLmRpcm5hbWUoZmlsZVBhdGgpLCBzcmMpXG4gICAgICAgIH1cblxuICAgICAgICBpZiAoXG4gICAgICAgICAgb3B0aW9ucy5yZWxhdGl2aXplICYmXG4gICAgICAgICAgKGZpbGVQYXRoICE9PSB1bmRlZmluZWQgfHwgc2F2ZVBhdGggIT09IHVuZGVmaW5lZClcbiAgICAgICAgKSB7XG4gICAgICAgICAgY29uc3QgZnAgPSBzYXZlUGF0aCAhPT0gdW5kZWZpbmVkID8gc2F2ZVBhdGggOiBmaWxlUGF0aCFcbiAgICAgICAgICBzcmMgPSBwYXRoLnJlbGF0aXZlKHBhdGguZGlybmFtZShmcCksIHNyYylcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFVzZSBtb3N0IHJlY2VudCB2ZXJzaW9uIG9mIGltYWdlXG4gICAgICAgIGlmIChvcHRpb25zLnZlcnNpb24pIHtcbiAgICAgICAgICBjb25zdCB2ID0gYXdhaXQgaW1hZ2VXYXRjaGVyLmdldFZlcnNpb24oc3JjLCBmaWxlUGF0aClcbiAgICAgICAgICBpZiAodikge1xuICAgICAgICAgICAgc3JjID0gYCR7c3JjfT92PSR7dn1gXG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaW1nLnNyYyA9IHNyY1xuICAgICAgfVxuICAgICAgcmV0dXJuXG4gICAgfSksXG4gIClcbn1cblxuZnVuY3Rpb24gaGlnaGxpZ2h0Q29kZUJsb2NrcyhcbiAgZG9tRnJhZ21lbnQ6IERvY3VtZW50LFxuICBkZWZhdWx0TGFuZ3VhZ2U6IHN0cmluZyxcbiAgY29weUhUTUw6IGJvb2xlYW4sXG4pIHtcbiAgY29uc3QgZm9udEZhbWlseSA9IGF0b20uY29uZmlnLmdldCgnZWRpdG9yLmZvbnRGYW1pbHknKVxuICBpZiAoZm9udEZhbWlseSkge1xuICAgIGZvciAoY29uc3QgY29kZUVsZW1lbnQgb2YgQXJyYXkuZnJvbShcbiAgICAgIGRvbUZyYWdtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ2NvZGUnKSxcbiAgICApKSB7XG4gICAgICBjb2RlRWxlbWVudC5zdHlsZS5mb250RmFtaWx5ID0gZm9udEZhbWlseVxuICAgIH1cbiAgfVxuXG4gIGZvciAoY29uc3QgcHJlRWxlbWVudCBvZiBBcnJheS5mcm9tKGRvbUZyYWdtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ3ByZScpKSkge1xuICAgIGNvbnN0IGNvZGVCbG9jayA9XG4gICAgICBwcmVFbGVtZW50LmZpcnN0RWxlbWVudENoaWxkICE9PSBudWxsXG4gICAgICAgID8gcHJlRWxlbWVudC5maXJzdEVsZW1lbnRDaGlsZFxuICAgICAgICA6IHByZUVsZW1lbnRcbiAgICBjb25zdCBjYkNsYXNzID0gY29kZUJsb2NrLmNsYXNzTmFtZVxuICAgIGNvbnN0IGZlbmNlTmFtZSA9IGNiQ2xhc3NcbiAgICAgID8gY2JDbGFzcy5yZXBsYWNlKC9eKGxhbmctfHNvdXJjZUNvZGUgKS8sICcnKVxuICAgICAgOiBkZWZhdWx0TGFuZ3VhZ2VcblxuICAgIGNvbnN0IGFkZENsYXNzID0gY29weUhUTUwgPyAnZWRpdG9yLWNvbG9ycyAnIDogJydcbiAgICBwcmVFbGVtZW50Lm91dGVySFRNTCA9IGhpZ2hsaWdodCh7XG4gICAgICBmaWxlQ29udGVudHM6IGNvZGVCbG9jay50ZXh0Q29udGVudCEucmVwbGFjZSgvXFxuJC8sICcnKSxcbiAgICAgIHNjb3BlTmFtZTogc2NvcGVGb3JGZW5jZU5hbWUoZmVuY2VOYW1lKSxcbiAgICAgIG5ic3A6IGZhbHNlLFxuICAgICAgbGluZURpdnM6IGNvcHlIVE1MID8gZmFsc2UgOiB0cnVlLFxuICAgICAgZWRpdG9yRGl2OiB0cnVlLFxuICAgICAgZWRpdG9yRGl2VGFnOiBjb3B5SFRNTCA/ICdwcmUnIDogJ2F0b20tdGV4dC1lZGl0b3InLFxuICAgICAgLy8gVGhlIGBlZGl0b3JgIGNsYXNzIG1lc3NlcyB0aGluZ3MgdXAgYXMgYC5lZGl0b3JgIGhhcyBhYnNvbHV0ZWx5IHBvc2l0aW9uZWQgbGluZXNcbiAgICAgIGVkaXRvckRpdkNsYXNzOiBmZW5jZU5hbWUgPyBgJHthZGRDbGFzc31sYW5nLSR7ZmVuY2VOYW1lfWAgOiBhZGRDbGFzcyxcbiAgICB9KVxuICB9XG5cbiAgcmV0dXJuIGRvbUZyYWdtZW50XG59XG4iXX0=