"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const pandocHelper = require("./pandoc-helper");
const markdownIt = require("./markdown-it-helper");
const extension_helper_1 = require("./extension-helper");
const atom_1 = require("atom");
const util_1 = require("./util");
const util_common_1 = require("./util-common");
const { resourcePath } = atom.getLoadSettings();
const packagePath = path.dirname(__dirname);
async function render(options) {
    const text = options.text.replace(/^\s*<!doctype(\s+.*)?>\s*/i, '');
    let html;
    let error;
    if (util_1.atomConfig().renderer === 'pandoc') {
        try {
            html = await pandocHelper.renderPandoc(text, options.filePath, options.renderLaTeX);
        }
        catch (err) {
            const e = err;
            if (e.html === undefined)
                throw e;
            error = e.message;
            html = e.html;
        }
    }
    else {
        html = markdownIt.render(text, options.renderLaTeX);
    }
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    sanitize(doc);
    if (options.mode === 'normal') {
        options.imageWatcher.clear();
        resolveImagePaths(doc, options.filePath, false, undefined, options.imageWatcher);
    }
    else {
        switch (options.mode) {
            case 'save':
                handleImages({
                    doc,
                    filePath: options.filePath,
                    savePath: options.savePath,
                    behaviour: util_1.atomConfig().saveConfig.mediaOnSaveAsHTMLBehaviour,
                });
                break;
            case 'copy':
                handleImages({
                    doc,
                    filePath: options.filePath,
                    behaviour: util_1.atomConfig().saveConfig.mediaOnCopyAsHTMLBehaviour,
                });
                break;
            default:
                throw invalidMode(options.mode);
        }
    }
    let defaultCodeLanguage = 'text';
    if ((options.grammar && options.grammar.scopeName) === 'source.litcoffee') {
        defaultCodeLanguage = 'coffee';
    }
    if (!(util_1.atomConfig().renderer === 'pandoc' &&
        util_1.atomConfig().pandocConfig.useNativePandocCodeStyles)) {
        await highlightCodeBlocks(doc, defaultCodeLanguage, options.mode !== 'normal');
    }
    if (error) {
        const errd = doc.createElement('div');
        const msgel = doc.createElement('code');
        msgel.innerText = error;
        errd.innerHTML = `<h1>Pandoc Error:</h1>${msgel.outerHTML}<hr>`;
        doc.body.insertBefore(errd, doc.body.firstElementChild);
    }
    return doc;
}
exports.render = render;
function invalidMode(mode) {
    return new Error(`Invalid render mode ${JSON.stringify(mode)}`);
}
function sanitize(doc) {
    doc.querySelectorAll("script:not([type^='math/tex'])").forEach((elem) => {
        elem.remove();
    });
    const attributesToRemove = [
        'onabort',
        'onblur',
        'onchange',
        'onclick',
        'ondbclick',
        'onerror',
        'onfocus',
        'onkeydown',
        'onkeypress',
        'onkeyup',
        'onload',
        'onmousedown',
        'onmousemove',
        'onmouseover',
        'onmouseout',
        'onmouseup',
        'onreset',
        'onresize',
        'onscroll',
        'onselect',
        'onsubmit',
        'onunload',
    ];
    doc.querySelectorAll('*').forEach((elem) => attributesToRemove.map((attribute) => {
        elem.removeAttribute(attribute);
    }));
}
function handleImages(opts) {
    const relativize = opts.behaviour === 'relativized';
    switch (opts.behaviour) {
        case 'relativized':
        case 'absolutized':
            resolveImagePaths(opts.doc, opts.filePath, relativize, opts.savePath);
            break;
        case 'untouched':
    }
}
function resolveImagePaths(doc, filePath, relativize, savePath, imageWatcher) {
    const [rootDirectory] = atom.project.relativizePath(filePath || '');
    const media = util_common_1.getMedia(doc);
    Array.from(media).map(function (img) {
        let src = img.getAttribute('src');
        if (src) {
            if (util_1.atomConfig().renderer !== 'pandoc') {
                src = decodeURI(src);
            }
            if (src.match(/^(https?|atom|data):/)) {
                return;
            }
            if (process.resourcesPath && src.startsWith(process.resourcesPath)) {
                return;
            }
            if (src.startsWith(resourcePath)) {
                return;
            }
            if (src.startsWith(packagePath)) {
                return;
            }
            if (src[0] === '/') {
                if (!util_1.isFileSync(src)) {
                    try {
                        if (rootDirectory !== null) {
                            src = path.join(rootDirectory, src.substring(1));
                        }
                    }
                    catch (e) {
                    }
                }
            }
            else if (filePath) {
                src = path.resolve(path.dirname(filePath), src);
            }
            if (relativize && (filePath !== undefined || savePath !== undefined)) {
                const fp = savePath !== undefined ? savePath : filePath;
                src = path.relative(path.dirname(fp), src);
            }
            if (imageWatcher) {
                const v = imageWatcher.watch(src);
                if (v !== undefined)
                    src = `${src}?v=${v}`;
            }
            img.src = src;
        }
    });
}
async function highlightCodeBlocks(domFragment, defaultLanguage, copyHTML) {
    const fontFamily = atom.config.get('editor.fontFamily');
    if (fontFamily) {
        for (const codeElement of Array.from(domFragment.querySelectorAll('code'))) {
            codeElement.style.fontFamily = fontFamily;
        }
    }
    await Promise.all(Array.from(domFragment.querySelectorAll('pre')).map(async (preElement) => {
        const codeBlock = preElement.firstElementChild !== null
            ? preElement.firstElementChild
            : preElement;
        const cbClass = codeBlock.className;
        const fenceName = cbClass
            ? cbClass.replace(/^(lang-|sourceCode )/, '')
            : defaultLanguage;
        const ed = new atom_1.TextEditor({
            readonly: true,
            keyboardInputEnabled: false,
            showInvisibles: false,
        });
        const el = atom.views.getView(ed);
        try {
            el.setUpdatedSynchronously(true);
            el.style.pointerEvents = 'none';
            el.style.position = 'absolute';
            el.style.width = '0px';
            el.style.height = '1px';
            atom.views.getView(atom.workspace).appendChild(el);
            atom.grammars.assignLanguageMode(ed.getBuffer(), extension_helper_1.scopeForFenceName(fenceName));
            ed.setText(codeBlock.textContent.replace(/\r?\n$/, ''));
            await editorTokenized(ed);
            const html = Array.from(el.querySelectorAll('.line:not(.dummy)'));
            if (copyHTML) {
                preElement.classList.add('editor-colors');
                preElement.innerHTML = html.map((x) => x.innerHTML).join('\n');
                if (fenceName)
                    preElement.classList.add(`lang-${fenceName}`);
            }
            else {
                const cls = fenceName ? ` class="lang-${fenceName}"` : '';
                preElement.outerHTML = `<atom-text-editor${cls}>${html
                    .map((x) => `<div class="line">${x.innerHTML}</div>`)
                    .join('\n')}</atom-text-editor>`;
            }
        }
        finally {
            el.remove();
        }
    }));
    return domFragment;
}
async function editorTokenized(editor) {
    return new Promise((resolve) => {
        if (editor.getBuffer().getLanguageMode().fullyTokenized) {
            resolve();
        }
        else {
            const disp = editor.onDidTokenize(() => {
                disp.dispose();
                resolve();
            });
        }
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVuZGVyZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcmVuZGVyZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw2QkFBNkI7QUFDN0IsZ0RBQWdEO0FBQ2hELG1EQUFtRDtBQUNuRCx5REFBc0Q7QUFDdEQsK0JBQTBDO0FBQzFDLGlDQUErQztBQUMvQywrQ0FBd0M7QUFHeEMsTUFBTSxFQUFFLFlBQVksRUFBRSxHQUFHLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQTtBQUMvQyxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFBO0FBaUJwQyxLQUFLLFVBQVUsTUFBTSxDQUFDLE9BQXNCO0lBR2pELE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLDRCQUE0QixFQUFFLEVBQUUsQ0FBQyxDQUFBO0lBRW5FLElBQUksSUFBSSxDQUFBO0lBQ1IsSUFBSSxLQUFLLENBQUE7SUFDVCxJQUFJLGlCQUFVLEVBQUUsQ0FBQyxRQUFRLEtBQUssUUFBUSxFQUFFO1FBQ3RDLElBQUk7WUFDRixJQUFJLEdBQUcsTUFBTSxZQUFZLENBQUMsWUFBWSxDQUNwQyxJQUFJLEVBQ0osT0FBTyxDQUFDLFFBQVEsRUFDaEIsT0FBTyxDQUFDLFdBQVcsQ0FDcEIsQ0FBQTtTQUNGO1FBQUMsT0FBTyxHQUFHLEVBQUU7WUFDWixNQUFNLENBQUMsR0FBRyxHQUFnQyxDQUFBO1lBQzFDLElBQUksQ0FBQyxDQUFDLElBQUksS0FBSyxTQUFTO2dCQUFFLE1BQU0sQ0FBQyxDQUFBO1lBQ2pDLEtBQUssR0FBRyxDQUFDLENBQUMsT0FBaUIsQ0FBQTtZQUMzQixJQUFJLEdBQUcsQ0FBQyxDQUFDLElBQWMsQ0FBQTtTQUN4QjtLQUNGO1NBQU07UUFDTCxJQUFJLEdBQUcsVUFBVSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFBO0tBQ3BEO0lBQ0QsTUFBTSxNQUFNLEdBQUcsSUFBSSxTQUFTLEVBQUUsQ0FBQTtJQUM5QixNQUFNLEdBQUcsR0FBRyxNQUFNLENBQUMsZUFBZSxDQUFDLElBQUksRUFBRSxXQUFXLENBQUMsQ0FBQTtJQUNyRCxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUE7SUFDYixJQUFJLE9BQU8sQ0FBQyxJQUFJLEtBQUssUUFBUSxFQUFFO1FBQzdCLE9BQU8sQ0FBQyxZQUFZLENBQUMsS0FBSyxFQUFFLENBQUE7UUFDNUIsaUJBQWlCLENBQ2YsR0FBRyxFQUNILE9BQU8sQ0FBQyxRQUFRLEVBQ2hCLEtBQUssRUFDTCxTQUFTLEVBQ1QsT0FBTyxDQUFDLFlBQVksQ0FDckIsQ0FBQTtLQUNGO1NBQU07UUFDTCxRQUFRLE9BQU8sQ0FBQyxJQUFJLEVBQUU7WUFDcEIsS0FBSyxNQUFNO2dCQUNULFlBQVksQ0FBQztvQkFDWCxHQUFHO29CQUNILFFBQVEsRUFBRSxPQUFPLENBQUMsUUFBUTtvQkFDMUIsUUFBUSxFQUFFLE9BQU8sQ0FBQyxRQUFRO29CQUMxQixTQUFTLEVBQUUsaUJBQVUsRUFBRSxDQUFDLFVBQVUsQ0FBQywwQkFBMEI7aUJBQzlELENBQUMsQ0FBQTtnQkFDRixNQUFLO1lBQ1AsS0FBSyxNQUFNO2dCQUNULFlBQVksQ0FBQztvQkFDWCxHQUFHO29CQUNILFFBQVEsRUFBRSxPQUFPLENBQUMsUUFBUTtvQkFDMUIsU0FBUyxFQUFFLGlCQUFVLEVBQUUsQ0FBQyxVQUFVLENBQUMsMEJBQTBCO2lCQUM5RCxDQUFDLENBQUE7Z0JBQ0YsTUFBSztZQUNQO2dCQUNFLE1BQU0sV0FBVyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQTtTQUNsQztLQUNGO0lBQ0QsSUFBSSxtQkFBbUIsR0FBVyxNQUFNLENBQUE7SUFFeEMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsS0FBSyxrQkFBa0IsRUFBRTtRQUN6RSxtQkFBbUIsR0FBRyxRQUFRLENBQUE7S0FDL0I7SUFDRCxJQUNFLENBQUMsQ0FDQyxpQkFBVSxFQUFFLENBQUMsUUFBUSxLQUFLLFFBQVE7UUFDbEMsaUJBQVUsRUFBRSxDQUFDLFlBQVksQ0FBQyx5QkFBeUIsQ0FDcEQsRUFDRDtRQUNBLE1BQU0sbUJBQW1CLENBQ3ZCLEdBQUcsRUFDSCxtQkFBbUIsRUFDbkIsT0FBTyxDQUFDLElBQUksS0FBSyxRQUFRLENBQzFCLENBQUE7S0FDRjtJQUNELElBQUksS0FBSyxFQUFFO1FBQ1QsTUFBTSxJQUFJLEdBQUcsR0FBRyxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUNyQyxNQUFNLEtBQUssR0FBRyxHQUFHLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBQ3ZDLEtBQUssQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFBO1FBQ3ZCLElBQUksQ0FBQyxTQUFTLEdBQUcseUJBQXlCLEtBQUssQ0FBQyxTQUFTLE1BQU0sQ0FBQTtRQUMvRCxHQUFHLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFBO0tBQ3hEO0lBQ0QsT0FBTyxHQUFHLENBQUE7QUFDWixDQUFDO0FBakZELHdCQWlGQztBQUVELFNBQVMsV0FBVyxDQUFDLElBQVc7SUFDOUIsT0FBTyxJQUFJLEtBQUssQ0FBQyx1QkFBdUIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUE7QUFDakUsQ0FBQztBQUVELFNBQVMsUUFBUSxDQUFDLEdBQWlCO0lBRWpDLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFO1FBQ3RFLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQTtJQUNmLENBQUMsQ0FBQyxDQUFBO0lBQ0YsTUFBTSxrQkFBa0IsR0FBRztRQUN6QixTQUFTO1FBQ1QsUUFBUTtRQUNSLFVBQVU7UUFDVixTQUFTO1FBQ1QsV0FBVztRQUNYLFNBQVM7UUFDVCxTQUFTO1FBQ1QsV0FBVztRQUNYLFlBQVk7UUFDWixTQUFTO1FBQ1QsUUFBUTtRQUNSLGFBQWE7UUFDYixhQUFhO1FBQ2IsYUFBYTtRQUNiLFlBQVk7UUFDWixXQUFXO1FBQ1gsU0FBUztRQUNULFVBQVU7UUFDVixVQUFVO1FBQ1YsVUFBVTtRQUNWLFVBQVU7UUFDVixVQUFVO0tBQ1gsQ0FBQTtJQUNELEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUN6QyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsQ0FBQyxTQUFTLEVBQUUsRUFBRTtRQUNuQyxJQUFJLENBQUMsZUFBZSxDQUFDLFNBQVMsQ0FBQyxDQUFBO0lBQ2pDLENBQUMsQ0FBQyxDQUNILENBQUE7QUFDSCxDQUFDO0FBRUQsU0FBUyxZQUFZLENBQUMsSUFLckI7SUFDQyxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsU0FBUyxLQUFLLGFBQWEsQ0FBQTtJQUNuRCxRQUFRLElBQUksQ0FBQyxTQUFTLEVBQUU7UUFDdEIsS0FBSyxhQUFhLENBQUM7UUFDbkIsS0FBSyxhQUFhO1lBQ2hCLGlCQUFpQixDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLFFBQVEsRUFBRSxVQUFVLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFBO1lBQ3JFLE1BQUs7UUFDUCxLQUFLLFdBQVcsQ0FBQztLQUVsQjtBQUNILENBQUM7QUFFRCxTQUFTLGlCQUFpQixDQUN4QixHQUFpQixFQUNqQixRQUE0QixFQUM1QixVQUFtQixFQUNuQixRQUFpQixFQUNqQixZQUEyQjtJQUUzQixNQUFNLENBQUMsYUFBYSxDQUFDLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsUUFBUSxJQUFJLEVBQUUsQ0FBQyxDQUFBO0lBQ25FLE1BQU0sS0FBSyxHQUFHLHNCQUFRLENBQUMsR0FBRyxDQUFDLENBQUE7SUFDM0IsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBUyxHQUFHO1FBQ2hDLElBQUksR0FBRyxHQUFHLEdBQUcsQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUE7UUFDakMsSUFBSSxHQUFHLEVBQUU7WUFDUCxJQUFJLGlCQUFVLEVBQUUsQ0FBQyxRQUFRLEtBQUssUUFBUSxFQUFFO2dCQUN0QyxHQUFHLEdBQUcsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFBO2FBQ3JCO1lBRUQsSUFBSSxHQUFHLENBQUMsS0FBSyxDQUFDLHNCQUFzQixDQUFDLEVBQUU7Z0JBQ3JDLE9BQU07YUFDUDtZQUNELElBQUksT0FBTyxDQUFDLGFBQWEsSUFBSSxHQUFHLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsRUFBRTtnQkFDbEUsT0FBTTthQUNQO1lBQ0QsSUFBSSxHQUFHLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQyxFQUFFO2dCQUNoQyxPQUFNO2FBQ1A7WUFDRCxJQUFJLEdBQUcsQ0FBQyxVQUFVLENBQUMsV0FBVyxDQUFDLEVBQUU7Z0JBQy9CLE9BQU07YUFDUDtZQUVELElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsRUFBRTtnQkFDbEIsSUFBSSxDQUFDLGlCQUFVLENBQUMsR0FBRyxDQUFDLEVBQUU7b0JBQ3BCLElBQUk7d0JBQ0YsSUFBSSxhQUFhLEtBQUssSUFBSSxFQUFFOzRCQUMxQixHQUFHLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO3lCQUNqRDtxQkFDRjtvQkFBQyxPQUFPLENBQUMsRUFBRTtxQkFFWDtpQkFDRjthQUNGO2lCQUFNLElBQUksUUFBUSxFQUFFO2dCQUNuQixHQUFHLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFBO2FBQ2hEO1lBRUQsSUFBSSxVQUFVLElBQUksQ0FBQyxRQUFRLEtBQUssU0FBUyxJQUFJLFFBQVEsS0FBSyxTQUFTLENBQUMsRUFBRTtnQkFDcEUsTUFBTSxFQUFFLEdBQUcsUUFBUSxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxRQUFTLENBQUE7Z0JBQ3hELEdBQUcsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUE7YUFDM0M7WUFHRCxJQUFJLFlBQVksRUFBRTtnQkFDaEIsTUFBTSxDQUFDLEdBQUcsWUFBWSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQTtnQkFDakMsSUFBSSxDQUFDLEtBQUssU0FBUztvQkFBRSxHQUFHLEdBQUcsR0FBRyxHQUFHLE1BQU0sQ0FBQyxFQUFFLENBQUE7YUFDM0M7WUFFRCxHQUFHLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQTtTQUNkO0lBQ0gsQ0FBQyxDQUFDLENBQUE7QUFDSixDQUFDO0FBRUQsS0FBSyxVQUFVLG1CQUFtQixDQUNoQyxXQUFxQixFQUNyQixlQUF1QixFQUN2QixRQUFpQjtJQUVqQixNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFBO0lBQ3ZELElBQUksVUFBVSxFQUFFO1FBQ2QsS0FBSyxNQUFNLFdBQVcsSUFBSSxLQUFLLENBQUMsSUFBSSxDQUNsQyxXQUFXLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLENBQ3JDLEVBQUU7WUFDRCxXQUFXLENBQUMsS0FBSyxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUE7U0FDMUM7S0FDRjtJQUVELE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FDZixLQUFLLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsVUFBVSxFQUFFLEVBQUU7UUFDdkUsTUFBTSxTQUFTLEdBQ2IsVUFBVSxDQUFDLGlCQUFpQixLQUFLLElBQUk7WUFDbkMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxpQkFBaUI7WUFDOUIsQ0FBQyxDQUFDLFVBQVUsQ0FBQTtRQUNoQixNQUFNLE9BQU8sR0FBRyxTQUFTLENBQUMsU0FBUyxDQUFBO1FBQ25DLE1BQU0sU0FBUyxHQUFHLE9BQU87WUFDdkIsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsc0JBQXNCLEVBQUUsRUFBRSxDQUFDO1lBQzdDLENBQUMsQ0FBQyxlQUFlLENBQUE7UUFFbkIsTUFBTSxFQUFFLEdBQUcsSUFBSSxpQkFBVSxDQUFDO1lBQ3hCLFFBQVEsRUFBRSxJQUFJO1lBQ2Qsb0JBQW9CLEVBQUUsS0FBSztZQUMzQixjQUFjLEVBQUUsS0FBSztTQUN0QixDQUFDLENBQUE7UUFDRixNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQTtRQUNqQyxJQUFJO1lBQ0YsRUFBRSxDQUFDLHVCQUF1QixDQUFDLElBQUksQ0FBQyxDQUFBO1lBQ2hDLEVBQUUsQ0FBQyxLQUFLLENBQUMsYUFBYSxHQUFHLE1BQU0sQ0FBQTtZQUMvQixFQUFFLENBQUMsS0FBSyxDQUFDLFFBQVEsR0FBRyxVQUFVLENBQUE7WUFDOUIsRUFBRSxDQUFDLEtBQUssQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFBO1lBQ3RCLEVBQUUsQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQTtZQUN2QixJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxDQUFBO1lBQ2xELElBQUksQ0FBQyxRQUFRLENBQUMsa0JBQWtCLENBQzlCLEVBQUUsQ0FBQyxTQUFTLEVBQUUsRUFDZCxvQ0FBaUIsQ0FBQyxTQUFTLENBQUMsQ0FDN0IsQ0FBQTtZQUNELEVBQUUsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLFdBQVksQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUE7WUFDeEQsTUFBTSxlQUFlLENBQUMsRUFBRSxDQUFDLENBQUE7WUFDekIsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsZ0JBQWdCLENBQUMsbUJBQW1CLENBQUMsQ0FBQyxDQUFBO1lBQ2pFLElBQUksUUFBUSxFQUFFO2dCQUNaLFVBQVUsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLGVBQWUsQ0FBQyxDQUFBO2dCQUN6QyxVQUFVLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7Z0JBQzlELElBQUksU0FBUztvQkFBRSxVQUFVLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxRQUFRLFNBQVMsRUFBRSxDQUFDLENBQUE7YUFDN0Q7aUJBQU07Z0JBQ0wsTUFBTSxHQUFHLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQyxnQkFBZ0IsU0FBUyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQTtnQkFDekQsVUFBVSxDQUFDLFNBQVMsR0FBRyxvQkFBb0IsR0FBRyxJQUFJLElBQUk7cUJBQ25ELEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMscUJBQXFCLENBQUMsQ0FBQyxTQUFTLFFBQVEsQ0FBQztxQkFDcEQsSUFBSSxDQUFDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQTthQUNuQztTQUNGO2dCQUFTO1lBQ1IsRUFBRSxDQUFDLE1BQU0sRUFBRSxDQUFBO1NBQ1o7SUFDSCxDQUFDLENBQUMsQ0FDSCxDQUFBO0lBRUQsT0FBTyxXQUFXLENBQUE7QUFDcEIsQ0FBQztBQUVELEtBQUssVUFBVSxlQUFlLENBQUMsTUFBa0I7SUFDL0MsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFO1FBQzdCLElBQUksTUFBTSxDQUFDLFNBQVMsRUFBRSxDQUFDLGVBQWUsRUFBRSxDQUFDLGNBQWMsRUFBRTtZQUN2RCxPQUFPLEVBQUUsQ0FBQTtTQUNWO2FBQU07WUFDTCxNQUFNLElBQUksR0FBRyxNQUFNLENBQUMsYUFBYSxDQUFDLEdBQUcsRUFBRTtnQkFDckMsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFBO2dCQUNkLE9BQU8sRUFBRSxDQUFBO1lBQ1gsQ0FBQyxDQUFDLENBQUE7U0FDSDtJQUNILENBQUMsQ0FBQyxDQUFBO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBwYXRoID0gcmVxdWlyZSgncGF0aCcpXG5pbXBvcnQgcGFuZG9jSGVscGVyID0gcmVxdWlyZSgnLi9wYW5kb2MtaGVscGVyJylcbmltcG9ydCBtYXJrZG93bkl0ID0gcmVxdWlyZSgnLi9tYXJrZG93bi1pdC1oZWxwZXInKSAvLyBEZWZlciB1bnRpbCB1c2VkXG5pbXBvcnQgeyBzY29wZUZvckZlbmNlTmFtZSB9IGZyb20gJy4vZXh0ZW5zaW9uLWhlbHBlcidcbmltcG9ydCB7IEdyYW1tYXIsIFRleHRFZGl0b3IgfSBmcm9tICdhdG9tJ1xuaW1wb3J0IHsgaXNGaWxlU3luYywgYXRvbUNvbmZpZyB9IGZyb20gJy4vdXRpbCdcbmltcG9ydCB7IGdldE1lZGlhIH0gZnJvbSAnLi91dGlsLWNvbW1vbidcbmltcG9ydCB7IEltYWdlV2F0Y2hlciB9IGZyb20gJy4vaW1hZ2Utd2F0Y2gtaGVscGVyJ1xuXG5jb25zdCB7IHJlc291cmNlUGF0aCB9ID0gYXRvbS5nZXRMb2FkU2V0dGluZ3MoKVxuY29uc3QgcGFja2FnZVBhdGggPSBwYXRoLmRpcm5hbWUoX19kaXJuYW1lKVxuXG5leHBvcnQgdHlwZSBSZW5kZXJNb2RlID0gJ25vcm1hbCcgfCAnY29weScgfCAnc2F2ZSdcblxuZXhwb3J0IGludGVyZmFjZSBDb21tb25SZW5kZXJPcHRpb25zPFQgZXh0ZW5kcyBSZW5kZXJNb2RlPiB7XG4gIHRleHQ6IHN0cmluZ1xuICBmaWxlUGF0aDogc3RyaW5nIHwgdW5kZWZpbmVkXG4gIGdyYW1tYXI/OiBHcmFtbWFyXG4gIHJlbmRlckxhVGVYOiBib29sZWFuXG4gIG1vZGU6IFRcbn1cblxuZXhwb3J0IHR5cGUgUmVuZGVyT3B0aW9ucyA9XG4gIHwgKENvbW1vblJlbmRlck9wdGlvbnM8J25vcm1hbCcgfCAnY29weSc+ICYgeyBpbWFnZVdhdGNoZXI6IEltYWdlV2F0Y2hlciB9KVxuICB8IChDb21tb25SZW5kZXJPcHRpb25zPCdzYXZlJz4gJiB7IHNhdmVQYXRoOiBzdHJpbmcgfSlcbiAgfCAoQ29tbW9uUmVuZGVyT3B0aW9uczwnY29weSc+KVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcmVuZGVyKG9wdGlvbnM6IFJlbmRlck9wdGlvbnMpOiBQcm9taXNlPEhUTUxEb2N1bWVudD4ge1xuICAvLyBSZW1vdmUgdGhlIDwhZG9jdHlwZT4gc2luY2Ugb3RoZXJ3aXNlIG1hcmtlZCB3aWxsIGVzY2FwZSBpdFxuICAvLyBodHRwczovL2dpdGh1Yi5jb20vY2hqai9tYXJrZWQvaXNzdWVzLzM1NFxuICBjb25zdCB0ZXh0ID0gb3B0aW9ucy50ZXh0LnJlcGxhY2UoL15cXHMqPCFkb2N0eXBlKFxccysuKik/PlxccyovaSwgJycpXG5cbiAgbGV0IGh0bWxcbiAgbGV0IGVycm9yXG4gIGlmIChhdG9tQ29uZmlnKCkucmVuZGVyZXIgPT09ICdwYW5kb2MnKSB7XG4gICAgdHJ5IHtcbiAgICAgIGh0bWwgPSBhd2FpdCBwYW5kb2NIZWxwZXIucmVuZGVyUGFuZG9jKFxuICAgICAgICB0ZXh0LFxuICAgICAgICBvcHRpb25zLmZpbGVQYXRoLFxuICAgICAgICBvcHRpb25zLnJlbmRlckxhVGVYLFxuICAgICAgKVxuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgY29uc3QgZSA9IGVyciBhcyBFcnJvciAmIHsgaHRtbD86IHN0cmluZyB9XG4gICAgICBpZiAoZS5odG1sID09PSB1bmRlZmluZWQpIHRocm93IGVcbiAgICAgIGVycm9yID0gZS5tZXNzYWdlIGFzIHN0cmluZ1xuICAgICAgaHRtbCA9IGUuaHRtbCBhcyBzdHJpbmdcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgaHRtbCA9IG1hcmtkb3duSXQucmVuZGVyKHRleHQsIG9wdGlvbnMucmVuZGVyTGFUZVgpXG4gIH1cbiAgY29uc3QgcGFyc2VyID0gbmV3IERPTVBhcnNlcigpXG4gIGNvbnN0IGRvYyA9IHBhcnNlci5wYXJzZUZyb21TdHJpbmcoaHRtbCwgJ3RleHQvaHRtbCcpXG4gIHNhbml0aXplKGRvYylcbiAgaWYgKG9wdGlvbnMubW9kZSA9PT0gJ25vcm1hbCcpIHtcbiAgICBvcHRpb25zLmltYWdlV2F0Y2hlci5jbGVhcigpXG4gICAgcmVzb2x2ZUltYWdlUGF0aHMoXG4gICAgICBkb2MsXG4gICAgICBvcHRpb25zLmZpbGVQYXRoLFxuICAgICAgZmFsc2UsXG4gICAgICB1bmRlZmluZWQsXG4gICAgICBvcHRpb25zLmltYWdlV2F0Y2hlcixcbiAgICApXG4gIH0gZWxzZSB7XG4gICAgc3dpdGNoIChvcHRpb25zLm1vZGUpIHtcbiAgICAgIGNhc2UgJ3NhdmUnOlxuICAgICAgICBoYW5kbGVJbWFnZXMoe1xuICAgICAgICAgIGRvYyxcbiAgICAgICAgICBmaWxlUGF0aDogb3B0aW9ucy5maWxlUGF0aCxcbiAgICAgICAgICBzYXZlUGF0aDogb3B0aW9ucy5zYXZlUGF0aCxcbiAgICAgICAgICBiZWhhdmlvdXI6IGF0b21Db25maWcoKS5zYXZlQ29uZmlnLm1lZGlhT25TYXZlQXNIVE1MQmVoYXZpb3VyLFxuICAgICAgICB9KVxuICAgICAgICBicmVha1xuICAgICAgY2FzZSAnY29weSc6XG4gICAgICAgIGhhbmRsZUltYWdlcyh7XG4gICAgICAgICAgZG9jLFxuICAgICAgICAgIGZpbGVQYXRoOiBvcHRpb25zLmZpbGVQYXRoLFxuICAgICAgICAgIGJlaGF2aW91cjogYXRvbUNvbmZpZygpLnNhdmVDb25maWcubWVkaWFPbkNvcHlBc0hUTUxCZWhhdmlvdXIsXG4gICAgICAgIH0pXG4gICAgICAgIGJyZWFrXG4gICAgICBkZWZhdWx0OlxuICAgICAgICB0aHJvdyBpbnZhbGlkTW9kZShvcHRpb25zLm1vZGUpXG4gICAgfVxuICB9XG4gIGxldCBkZWZhdWx0Q29kZUxhbmd1YWdlOiBzdHJpbmcgPSAndGV4dCdcbiAgLy8gRGVmYXVsdCBjb2RlIGJsb2NrcyB0byBiZSBjb2ZmZWUgaW4gTGl0ZXJhdGUgQ29mZmVlU2NyaXB0IGZpbGVzXG4gIGlmICgob3B0aW9ucy5ncmFtbWFyICYmIG9wdGlvbnMuZ3JhbW1hci5zY29wZU5hbWUpID09PSAnc291cmNlLmxpdGNvZmZlZScpIHtcbiAgICBkZWZhdWx0Q29kZUxhbmd1YWdlID0gJ2NvZmZlZSdcbiAgfVxuICBpZiAoXG4gICAgIShcbiAgICAgIGF0b21Db25maWcoKS5yZW5kZXJlciA9PT0gJ3BhbmRvYycgJiZcbiAgICAgIGF0b21Db25maWcoKS5wYW5kb2NDb25maWcudXNlTmF0aXZlUGFuZG9jQ29kZVN0eWxlc1xuICAgIClcbiAgKSB7XG4gICAgYXdhaXQgaGlnaGxpZ2h0Q29kZUJsb2NrcyhcbiAgICAgIGRvYyxcbiAgICAgIGRlZmF1bHRDb2RlTGFuZ3VhZ2UsXG4gICAgICBvcHRpb25zLm1vZGUgIT09ICdub3JtYWwnLFxuICAgIClcbiAgfVxuICBpZiAoZXJyb3IpIHtcbiAgICBjb25zdCBlcnJkID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ2RpdicpXG4gICAgY29uc3QgbXNnZWwgPSBkb2MuY3JlYXRlRWxlbWVudCgnY29kZScpXG4gICAgbXNnZWwuaW5uZXJUZXh0ID0gZXJyb3JcbiAgICBlcnJkLmlubmVySFRNTCA9IGA8aDE+UGFuZG9jIEVycm9yOjwvaDE+JHttc2dlbC5vdXRlckhUTUx9PGhyPmBcbiAgICBkb2MuYm9keS5pbnNlcnRCZWZvcmUoZXJyZCwgZG9jLmJvZHkuZmlyc3RFbGVtZW50Q2hpbGQpXG4gIH1cbiAgcmV0dXJuIGRvY1xufVxuXG5mdW5jdGlvbiBpbnZhbGlkTW9kZShtb2RlOiBuZXZlcikge1xuICByZXR1cm4gbmV3IEVycm9yKGBJbnZhbGlkIHJlbmRlciBtb2RlICR7SlNPTi5zdHJpbmdpZnkobW9kZSl9YClcbn1cblxuZnVuY3Rpb24gc2FuaXRpemUoZG9jOiBIVE1MRG9jdW1lbnQpIHtcbiAgLy8gRG8gbm90IHJlbW92ZSBNYXRoSmF4IHNjcmlwdCBkZWxpbWl0ZWQgYmxvY2tzXG4gIGRvYy5xdWVyeVNlbGVjdG9yQWxsKFwic2NyaXB0Om5vdChbdHlwZV49J21hdGgvdGV4J10pXCIpLmZvckVhY2goKGVsZW0pID0+IHtcbiAgICBlbGVtLnJlbW92ZSgpXG4gIH0pXG4gIGNvbnN0IGF0dHJpYnV0ZXNUb1JlbW92ZSA9IFtcbiAgICAnb25hYm9ydCcsXG4gICAgJ29uYmx1cicsXG4gICAgJ29uY2hhbmdlJyxcbiAgICAnb25jbGljaycsXG4gICAgJ29uZGJjbGljaycsXG4gICAgJ29uZXJyb3InLFxuICAgICdvbmZvY3VzJyxcbiAgICAnb25rZXlkb3duJyxcbiAgICAnb25rZXlwcmVzcycsXG4gICAgJ29ua2V5dXAnLFxuICAgICdvbmxvYWQnLFxuICAgICdvbm1vdXNlZG93bicsXG4gICAgJ29ubW91c2Vtb3ZlJyxcbiAgICAnb25tb3VzZW92ZXInLFxuICAgICdvbm1vdXNlb3V0JyxcbiAgICAnb25tb3VzZXVwJyxcbiAgICAnb25yZXNldCcsXG4gICAgJ29ucmVzaXplJyxcbiAgICAnb25zY3JvbGwnLFxuICAgICdvbnNlbGVjdCcsXG4gICAgJ29uc3VibWl0JyxcbiAgICAnb251bmxvYWQnLFxuICBdXG4gIGRvYy5xdWVyeVNlbGVjdG9yQWxsKCcqJykuZm9yRWFjaCgoZWxlbSkgPT5cbiAgICBhdHRyaWJ1dGVzVG9SZW1vdmUubWFwKChhdHRyaWJ1dGUpID0+IHtcbiAgICAgIGVsZW0ucmVtb3ZlQXR0cmlidXRlKGF0dHJpYnV0ZSlcbiAgICB9KSxcbiAgKVxufVxuXG5mdW5jdGlvbiBoYW5kbGVJbWFnZXMob3B0czoge1xuICBiZWhhdmlvdXI6ICdyZWxhdGl2aXplZCcgfCAnYWJzb2x1dGl6ZWQnIHwgJ3VudG91Y2hlZCdcbiAgZG9jOiBIVE1MRG9jdW1lbnRcbiAgZmlsZVBhdGg/OiBzdHJpbmdcbiAgc2F2ZVBhdGg/OiBzdHJpbmdcbn0pIHtcbiAgY29uc3QgcmVsYXRpdml6ZSA9IG9wdHMuYmVoYXZpb3VyID09PSAncmVsYXRpdml6ZWQnXG4gIHN3aXRjaCAob3B0cy5iZWhhdmlvdXIpIHtcbiAgICBjYXNlICdyZWxhdGl2aXplZCc6XG4gICAgY2FzZSAnYWJzb2x1dGl6ZWQnOlxuICAgICAgcmVzb2x2ZUltYWdlUGF0aHMob3B0cy5kb2MsIG9wdHMuZmlsZVBhdGgsIHJlbGF0aXZpemUsIG9wdHMuc2F2ZVBhdGgpXG4gICAgICBicmVha1xuICAgIGNhc2UgJ3VudG91Y2hlZCc6XG4gICAgLyogbm9vcCAqL1xuICB9XG59XG5cbmZ1bmN0aW9uIHJlc29sdmVJbWFnZVBhdGhzKFxuICBkb2M6IEhUTUxEb2N1bWVudCxcbiAgZmlsZVBhdGg6IHN0cmluZyB8IHVuZGVmaW5lZCxcbiAgcmVsYXRpdml6ZTogYm9vbGVhbixcbiAgc2F2ZVBhdGg/OiBzdHJpbmcsXG4gIGltYWdlV2F0Y2hlcj86IEltYWdlV2F0Y2hlcixcbikge1xuICBjb25zdCBbcm9vdERpcmVjdG9yeV0gPSBhdG9tLnByb2plY3QucmVsYXRpdml6ZVBhdGgoZmlsZVBhdGggfHwgJycpXG4gIGNvbnN0IG1lZGlhID0gZ2V0TWVkaWEoZG9jKVxuICBBcnJheS5mcm9tKG1lZGlhKS5tYXAoZnVuY3Rpb24oaW1nKSB7XG4gICAgbGV0IHNyYyA9IGltZy5nZXRBdHRyaWJ1dGUoJ3NyYycpXG4gICAgaWYgKHNyYykge1xuICAgICAgaWYgKGF0b21Db25maWcoKS5yZW5kZXJlciAhPT0gJ3BhbmRvYycpIHtcbiAgICAgICAgc3JjID0gZGVjb2RlVVJJKHNyYylcbiAgICAgIH1cblxuICAgICAgaWYgKHNyYy5tYXRjaCgvXihodHRwcz98YXRvbXxkYXRhKTovKSkge1xuICAgICAgICByZXR1cm5cbiAgICAgIH1cbiAgICAgIGlmIChwcm9jZXNzLnJlc291cmNlc1BhdGggJiYgc3JjLnN0YXJ0c1dpdGgocHJvY2Vzcy5yZXNvdXJjZXNQYXRoKSkge1xuICAgICAgICByZXR1cm5cbiAgICAgIH1cbiAgICAgIGlmIChzcmMuc3RhcnRzV2l0aChyZXNvdXJjZVBhdGgpKSB7XG4gICAgICAgIHJldHVyblxuICAgICAgfVxuICAgICAgaWYgKHNyYy5zdGFydHNXaXRoKHBhY2thZ2VQYXRoKSkge1xuICAgICAgICByZXR1cm5cbiAgICAgIH1cblxuICAgICAgaWYgKHNyY1swXSA9PT0gJy8nKSB7XG4gICAgICAgIGlmICghaXNGaWxlU3luYyhzcmMpKSB7XG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGlmIChyb290RGlyZWN0b3J5ICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgIHNyYyA9IHBhdGguam9pbihyb290RGlyZWN0b3J5LCBzcmMuc3Vic3RyaW5nKDEpKVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIC8vIG5vb3BcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAoZmlsZVBhdGgpIHtcbiAgICAgICAgc3JjID0gcGF0aC5yZXNvbHZlKHBhdGguZGlybmFtZShmaWxlUGF0aCksIHNyYylcbiAgICAgIH1cblxuICAgICAgaWYgKHJlbGF0aXZpemUgJiYgKGZpbGVQYXRoICE9PSB1bmRlZmluZWQgfHwgc2F2ZVBhdGggIT09IHVuZGVmaW5lZCkpIHtcbiAgICAgICAgY29uc3QgZnAgPSBzYXZlUGF0aCAhPT0gdW5kZWZpbmVkID8gc2F2ZVBhdGggOiBmaWxlUGF0aCFcbiAgICAgICAgc3JjID0gcGF0aC5yZWxhdGl2ZShwYXRoLmRpcm5hbWUoZnApLCBzcmMpXG4gICAgICB9XG5cbiAgICAgIC8vIFdhdGNoIGltYWdlIGZvciBjaGFuZ2VzXG4gICAgICBpZiAoaW1hZ2VXYXRjaGVyKSB7XG4gICAgICAgIGNvbnN0IHYgPSBpbWFnZVdhdGNoZXIud2F0Y2goc3JjKVxuICAgICAgICBpZiAodiAhPT0gdW5kZWZpbmVkKSBzcmMgPSBgJHtzcmN9P3Y9JHt2fWBcbiAgICAgIH1cblxuICAgICAgaW1nLnNyYyA9IHNyY1xuICAgIH1cbiAgfSlcbn1cblxuYXN5bmMgZnVuY3Rpb24gaGlnaGxpZ2h0Q29kZUJsb2NrcyhcbiAgZG9tRnJhZ21lbnQ6IERvY3VtZW50LFxuICBkZWZhdWx0TGFuZ3VhZ2U6IHN0cmluZyxcbiAgY29weUhUTUw6IGJvb2xlYW4sXG4pIHtcbiAgY29uc3QgZm9udEZhbWlseSA9IGF0b20uY29uZmlnLmdldCgnZWRpdG9yLmZvbnRGYW1pbHknKVxuICBpZiAoZm9udEZhbWlseSkge1xuICAgIGZvciAoY29uc3QgY29kZUVsZW1lbnQgb2YgQXJyYXkuZnJvbShcbiAgICAgIGRvbUZyYWdtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ2NvZGUnKSxcbiAgICApKSB7XG4gICAgICBjb2RlRWxlbWVudC5zdHlsZS5mb250RmFtaWx5ID0gZm9udEZhbWlseVxuICAgIH1cbiAgfVxuXG4gIGF3YWl0IFByb21pc2UuYWxsKFxuICAgIEFycmF5LmZyb20oZG9tRnJhZ21lbnQucXVlcnlTZWxlY3RvckFsbCgncHJlJykpLm1hcChhc3luYyAocHJlRWxlbWVudCkgPT4ge1xuICAgICAgY29uc3QgY29kZUJsb2NrID1cbiAgICAgICAgcHJlRWxlbWVudC5maXJzdEVsZW1lbnRDaGlsZCAhPT0gbnVsbFxuICAgICAgICAgID8gcHJlRWxlbWVudC5maXJzdEVsZW1lbnRDaGlsZFxuICAgICAgICAgIDogcHJlRWxlbWVudFxuICAgICAgY29uc3QgY2JDbGFzcyA9IGNvZGVCbG9jay5jbGFzc05hbWVcbiAgICAgIGNvbnN0IGZlbmNlTmFtZSA9IGNiQ2xhc3NcbiAgICAgICAgPyBjYkNsYXNzLnJlcGxhY2UoL14obGFuZy18c291cmNlQ29kZSApLywgJycpXG4gICAgICAgIDogZGVmYXVsdExhbmd1YWdlXG5cbiAgICAgIGNvbnN0IGVkID0gbmV3IFRleHRFZGl0b3Ioe1xuICAgICAgICByZWFkb25seTogdHJ1ZSxcbiAgICAgICAga2V5Ym9hcmRJbnB1dEVuYWJsZWQ6IGZhbHNlLFxuICAgICAgICBzaG93SW52aXNpYmxlczogZmFsc2UsXG4gICAgICB9KVxuICAgICAgY29uc3QgZWwgPSBhdG9tLnZpZXdzLmdldFZpZXcoZWQpXG4gICAgICB0cnkge1xuICAgICAgICBlbC5zZXRVcGRhdGVkU3luY2hyb25vdXNseSh0cnVlKVxuICAgICAgICBlbC5zdHlsZS5wb2ludGVyRXZlbnRzID0gJ25vbmUnXG4gICAgICAgIGVsLnN0eWxlLnBvc2l0aW9uID0gJ2Fic29sdXRlJ1xuICAgICAgICBlbC5zdHlsZS53aWR0aCA9ICcwcHgnXG4gICAgICAgIGVsLnN0eWxlLmhlaWdodCA9ICcxcHgnXG4gICAgICAgIGF0b20udmlld3MuZ2V0VmlldyhhdG9tLndvcmtzcGFjZSkuYXBwZW5kQ2hpbGQoZWwpXG4gICAgICAgIGF0b20uZ3JhbW1hcnMuYXNzaWduTGFuZ3VhZ2VNb2RlKFxuICAgICAgICAgIGVkLmdldEJ1ZmZlcigpLFxuICAgICAgICAgIHNjb3BlRm9yRmVuY2VOYW1lKGZlbmNlTmFtZSksXG4gICAgICAgIClcbiAgICAgICAgZWQuc2V0VGV4dChjb2RlQmxvY2sudGV4dENvbnRlbnQhLnJlcGxhY2UoL1xccj9cXG4kLywgJycpKVxuICAgICAgICBhd2FpdCBlZGl0b3JUb2tlbml6ZWQoZWQpXG4gICAgICAgIGNvbnN0IGh0bWwgPSBBcnJheS5mcm9tKGVsLnF1ZXJ5U2VsZWN0b3JBbGwoJy5saW5lOm5vdCguZHVtbXkpJykpXG4gICAgICAgIGlmIChjb3B5SFRNTCkge1xuICAgICAgICAgIHByZUVsZW1lbnQuY2xhc3NMaXN0LmFkZCgnZWRpdG9yLWNvbG9ycycpXG4gICAgICAgICAgcHJlRWxlbWVudC5pbm5lckhUTUwgPSBodG1sLm1hcCgoeCkgPT4geC5pbm5lckhUTUwpLmpvaW4oJ1xcbicpXG4gICAgICAgICAgaWYgKGZlbmNlTmFtZSkgcHJlRWxlbWVudC5jbGFzc0xpc3QuYWRkKGBsYW5nLSR7ZmVuY2VOYW1lfWApXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc3QgY2xzID0gZmVuY2VOYW1lID8gYCBjbGFzcz1cImxhbmctJHtmZW5jZU5hbWV9XCJgIDogJydcbiAgICAgICAgICBwcmVFbGVtZW50Lm91dGVySFRNTCA9IGA8YXRvbS10ZXh0LWVkaXRvciR7Y2xzfT4ke2h0bWxcbiAgICAgICAgICAgIC5tYXAoKHgpID0+IGA8ZGl2IGNsYXNzPVwibGluZVwiPiR7eC5pbm5lckhUTUx9PC9kaXY+YClcbiAgICAgICAgICAgIC5qb2luKCdcXG4nKX08L2F0b20tdGV4dC1lZGl0b3I+YFxuICAgICAgICB9XG4gICAgICB9IGZpbmFsbHkge1xuICAgICAgICBlbC5yZW1vdmUoKVxuICAgICAgfVxuICAgIH0pLFxuICApXG5cbiAgcmV0dXJuIGRvbUZyYWdtZW50XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGVkaXRvclRva2VuaXplZChlZGl0b3I6IFRleHRFZGl0b3IpIHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgaWYgKGVkaXRvci5nZXRCdWZmZXIoKS5nZXRMYW5ndWFnZU1vZGUoKS5mdWxseVRva2VuaXplZCkge1xuICAgICAgcmVzb2x2ZSgpXG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGRpc3AgPSBlZGl0b3Iub25EaWRUb2tlbml6ZSgoKSA9PiB7XG4gICAgICAgIGRpc3AuZGlzcG9zZSgpXG4gICAgICAgIHJlc29sdmUoKVxuICAgICAgfSlcbiAgICB9XG4gIH0pXG59XG4iXX0=