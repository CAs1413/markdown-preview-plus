"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const fs = require("fs-plus");
const highlight = require("atom-highlight");
const pandocHelper = require("./pandoc-helper");
const markdownIt = require("./markdown-it-helper");
const extension_helper_1 = require("./extension-helper");
const imageWatcher = require("./image-watch-helper");
const { resourcePath } = atom.getLoadSettings();
const packagePath = path.dirname(__dirname);
function toDOMFragment(text, filePath, _grammar, renderLaTeX, callback) {
    render(text, filePath, renderLaTeX, false, function (error, html) {
        if (error != null) {
            return callback(error);
        }
        const template = document.createElement('template');
        template.innerHTML = html;
        const domFragment = template.content.cloneNode(true);
        return callback(null, domFragment);
    });
}
exports.toDOMFragment = toDOMFragment;
function toHTML(text, filePath, grammar, renderLaTeX, copyHTMLFlag, callback) {
    if (text == null) {
        text = '';
    }
    render(text, filePath, renderLaTeX, copyHTMLFlag, function (error, html) {
        let defaultCodeLanguage;
        if (error != null) {
            callback(error, '');
        }
        if ((grammar && grammar.scopeName) === 'source.litcoffee') {
            defaultCodeLanguage = 'coffee';
        }
        if (!atom.config.get('markdown-preview-plus.enablePandoc') ||
            !atom.config.get('markdown-preview-plus.useNativePandocCodeStyles')) {
            html = tokenizeCodeBlocks(html, defaultCodeLanguage);
        }
        callback(null, html);
    });
}
exports.toHTML = toHTML;
function render(text, filePath, renderLaTeX, copyHTMLFlag, callback) {
    text = text.replace(/^\s*<!doctype(\s+.*)?>\s*/i, '');
    const callbackFunction = function (error, html) {
        if (error != null) {
            callback(error, '');
        }
        html = sanitize(html);
        html = resolveImagePaths(html, filePath, copyHTMLFlag);
        callback(null, html.trim());
    };
    if (atom.config.get('markdown-preview-plus.enablePandoc')) {
        pandocHelper.renderPandoc(text, filePath, renderLaTeX, callbackFunction);
    }
    else {
        callbackFunction(null, markdownIt.render(text, renderLaTeX));
    }
}
function sanitize(html) {
    const doc = document.createElement('div');
    doc.innerHTML = html;
    doc
        .querySelectorAll("script:not([type^='math/tex'])")
        .forEach((elem) => { elem.remove(); });
    const attributesToRemove = [
        'onabort',
        'onblur',
        'onchange',
        'onclick',
        'ondbclick',
        'onerror',
        'onfocus',
        'onkeydown',
        'onkeypress',
        'onkeyup',
        'onload',
        'onmousedown',
        'onmousemove',
        'onmouseover',
        'onmouseout',
        'onmouseup',
        'onreset',
        'onresize',
        'onscroll',
        'onselect',
        'onsubmit',
        'onunload',
    ];
    doc
        .querySelectorAll('*')
        .forEach((elem) => Array.from(attributesToRemove).map((attribute) => {
        elem.removeAttribute(attribute);
    }));
    return doc.innerHTML;
}
function resolveImagePaths(html, filePath, copyHTMLFlag) {
    const [rootDirectory] = Array.from(atom.project.relativizePath(filePath || ''));
    const doc = document.createElement('div');
    doc.innerHTML = html;
    doc.querySelectorAll('img').forEach(function (img) {
        let src = img.getAttribute('src');
        if (src) {
            if (!atom.config.get('markdown-preview-plus.enablePandoc')) {
                src = markdownIt.decode(src);
            }
            if (src.match(/^(https?|atom|data):/)) {
                return;
            }
            if (src.startsWith(process.resourcesPath)) {
                return;
            }
            if (src.startsWith(resourcePath)) {
                return;
            }
            if (src.startsWith(packagePath)) {
                return;
            }
            if (src[0] === '/') {
                if (!fs.isFileSync(src)) {
                    try {
                        src = path.join(rootDirectory, src.substring(1));
                    }
                    catch (e) {
                    }
                }
            }
            else if (filePath) {
                src = path.resolve(path.dirname(filePath), src);
            }
            if (!copyHTMLFlag) {
                const v = imageWatcher.getVersion(src, filePath);
                if (v) {
                    src = `${src}?v=${v}`;
                }
            }
            return (img.src = src);
        }
        return;
    });
    return doc.innerHTML;
}
function convertCodeBlocksToAtomEditors(domFragment, defaultLanguage = 'text') {
    const fontFamily = atom.config.get('editor.fontFamily');
    if (fontFamily) {
        for (const codeElement of Array.from(domFragment.querySelectorAll('code'))) {
            codeElement.style.fontFamily = fontFamily;
        }
    }
    for (const preElement of Array.from(domFragment.querySelectorAll('pre'))) {
        const codeBlock = preElement.firstElementChild !== null
            ? preElement.firstElementChild
            : preElement;
        const cbClass = codeBlock.className;
        const fenceName = cbClass
            ? cbClass.replace(/^(lang-|sourceCode )/, '')
            : defaultLanguage;
        const editorElement = document.createElement('atom-text-editor');
        editorElement.setAttributeNode(document.createAttribute('gutter-hidden'));
        editorElement.removeAttribute('tabindex');
        preElement.parentElement.replaceChild(editorElement, preElement);
        const editor = editorElement.getModel();
        if (editor.cursorLineDecorations != null) {
            for (const cursorLineDecoration of editor.cursorLineDecorations) {
                cursorLineDecoration.destroy();
            }
        }
        editor.setText(codeBlock.textContent.replace(/\n$/, ''));
        const grammar = atom.grammars.grammarForScopeName(extension_helper_1.scopeForFenceName(fenceName));
        if (grammar)
            editor.setGrammar(grammar);
    }
    return domFragment;
}
exports.convertCodeBlocksToAtomEditors = convertCodeBlocksToAtomEditors;
function tokenizeCodeBlocks(html, defaultLanguage = 'text') {
    const doc = document.createElement('div');
    doc.innerHTML = html;
    const fontFamily = atom.config.get('editor.fontFamily');
    if (fontFamily) {
        doc
            .querySelectorAll('code')
            .forEach((code) => (code.style.fontFamily = fontFamily || null));
    }
    doc.querySelectorAll('pre').forEach(function (preElement) {
        const codeBlock = preElement.firstElementChild;
        const fenceName = codeBlock.className.replace(/^(lang-|sourceCode )/, '') || defaultLanguage;
        const highlightedHtml = highlight({
            fileContents: codeBlock.innerText,
            scopeName: extension_helper_1.scopeForFenceName(fenceName),
            nbsp: false,
            lineDivs: false,
            editorDiv: true,
            editorDivTag: 'pre',
            editorDivClass: fenceName
                ? `editor-colors lang-${fenceName}`
                : 'editor-colors',
        });
        return (preElement.outerHTML = highlightedHtml);
    });
    return doc.innerHTML;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVuZGVyZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcmVuZGVyZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFTQSw2QkFBNkI7QUFDN0IsOEJBQThCO0FBQzlCLDRDQUE0QztBQUM1QyxnREFBZ0Q7QUFDaEQsbURBQW1EO0FBQ25ELHlEQUFzRDtBQUN0RCxxREFBcUQ7QUFHckQsTUFBTSxFQUFFLFlBQVksRUFBRSxHQUFHLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQTtBQUMvQyxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFBO0FBRTNDLHVCQUNFLElBQVksRUFDWixRQUFhLEVBQ2IsUUFBYSxFQUNiLFdBQW9CLEVBQ3BCLFFBQTZEO0lBRTdELE1BQU0sQ0FBQyxJQUFJLEVBQUUsUUFBUSxFQUFFLFdBQVcsRUFBRSxLQUFLLEVBQUUsVUFDekMsS0FBbUIsRUFDbkIsSUFBYTtRQUViLEVBQUUsQ0FBQyxDQUFDLEtBQUssSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ2xCLE1BQU0sQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUE7UUFDeEIsQ0FBQztRQUVELE1BQU0sUUFBUSxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLENBQUE7UUFDbkQsUUFBUSxDQUFDLFNBQVMsR0FBRyxJQUFLLENBQUE7UUFDMUIsTUFBTSxXQUFXLEdBQUcsUUFBUSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUE7UUFFcEQsTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsV0FBVyxDQUFDLENBQUE7SUFDcEMsQ0FBQyxDQUFDLENBQUE7QUFDSixDQUFDO0FBckJELHNDQXFCQztBQUVELGdCQUNFLElBQW1CLEVBQ25CLFFBQTRCLEVBQzVCLE9BQXVCLEVBQ3ZCLFdBQW9CLEVBQ3BCLFlBQXFCLEVBQ3JCLFFBQXFEO0lBRXJELEVBQUUsQ0FBQyxDQUFD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SUFFRixNQUFNLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQTtBQUN0QixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIGRlY2FmZmVpbmF0ZSBzdWdnZXN0aW9uczpcbiAqIERTMTAxOiBSZW1vdmUgdW5uZWNlc3NhcnkgdXNlIG9mIEFycmF5LmZyY29uc3QgY2JDbGFzcyA9IGNvZGVCbG9jay5jbGFzc05hbWVcbiAqIERTMTAyOiBSZW1vdmUgdW5uZWNlc3NhcnkgY29kZSBjcmVhdGVkIGJlY2F1c2Ugb2YgaW1wbGljaXQgcmV0dXJuc1xuICogRFMxMDM6IFJld3JpdGUgY29kZSB0byBubyBsb25nZXIgdXNlIF9fZ3VhcmRfX1xuICogRFMxMDQ6IEF2b2lkIGlubGluZSBhc3NpZ25tZW50c1xuICogRFMyMDc6IENvbnNpZGVyIHNob3J0ZXIgdmFyaWF0aW9ucyBvZiBudWxsIGNoZWNrc1xuICogRnVsbCBkb2NzOiBodHRwczovL2dpdGh1Yi5jb20vZGVjYWZmZWluYXRlL2RlY2FmZmVpbmF0ZS9ibG9iL21hc3Rlci9kb2NzL3N1Z2dlc3Rpb25zLm1kXG4gKi9cbmltcG9ydCBwYXRoID0gcmVxdWlyZSgncGF0aCcpXG5pbXBvcnQgZnMgPSByZXF1aXJlKCdmcy1wbHVzJylcbmltcG9ydCBoaWdobGlnaHQgPSByZXF1aXJlKCdhdG9tLWhpZ2hsaWdodCcpXG5pbXBvcnQgcGFuZG9jSGVscGVyID0gcmVxdWlyZSgnLi9wYW5kb2MtaGVscGVyJylcbmltcG9ydCBtYXJrZG93bkl0ID0gcmVxdWlyZSgnLi9tYXJrZG93bi1pdC1oZWxwZXInKSAvLyBEZWZlciB1bnRpbCB1c2VkXG5pbXBvcnQgeyBzY29wZUZvckZlbmNlTmFtZSB9IGZyb20gJy4vZXh0ZW5zaW9uLWhlbHBlcidcbmltcG9ydCBpbWFnZVdhdGNoZXIgPSByZXF1aXJlKCcuL2ltYWdlLXdhdGNoLWhlbHBlcicpXG5pbXBvcnQgeyBHcmFtbWFyLCBUZXh0RWRpdG9yRWxlbWVudCB9IGZyb20gJ2F0b20nXG5cbmNvbnN0IHsgcmVzb3VyY2VQYXRoIH0gPSBhdG9tLmdldExvYWRTZXR0aW5ncygpXG5jb25zdCBwYWNrYWdlUGF0aCA9IHBhdGguZGlybmFtZShfX2Rpcm5hbWUpXG5cbmV4cG9ydCBmdW5jdGlvbiB0b0RPTUZyYWdtZW50KFxuICB0ZXh0OiBzdHJpbmcsXG4gIGZpbGVQYXRoOiBhbnksXG4gIF9ncmFtbWFyOiBhbnksXG4gIHJlbmRlckxhVGVYOiBib29sZWFuLFxuICBjYWxsYmFjazogKGVycm9yOiBFcnJvciB8IG51bGwsIGRvbUZyYWdtZW50PzogTm9kZSkgPT4gc3RyaW5nLFxuKTogdm9pZCB7XG4gIHJlbmRlcih0ZXh0LCBmaWxlUGF0aCwgcmVuZGVyTGFUZVgsIGZhbHNlLCBmdW5jdGlvbihcbiAgICBlcnJvcjogRXJyb3IgfCBudWxsLFxuICAgIGh0bWw/OiBzdHJpbmcsXG4gICkge1xuICAgIGlmIChlcnJvciAhPSBudWxsKSB7XG4gICAgICByZXR1cm4gY2FsbGJhY2soZXJyb3IpXG4gICAgfVxuXG4gICAgY29uc3QgdGVtcGxhdGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0ZW1wbGF0ZScpXG4gICAgdGVtcGxhdGUuaW5uZXJIVE1MID0gaHRtbCFcbiAgICBjb25zdCBkb21GcmFnbWVudCA9IHRlbXBsYXRlLmNvbnRlbnQuY2xvbmVOb2RlKHRydWUpXG5cbiAgICByZXR1cm4gY2FsbGJhY2sobnVsbCwgZG9tRnJhZ21lbnQpXG4gIH0pXG59XG5cbmV4cG9ydCBmdW5jdGlvbiB0b0hUTUwoXG4gIHRleHQ6IHN0cmluZyB8IG51bGwsXG4gIGZpbGVQYXRoOiBzdHJpbmcgfCB1bmRlZmluZWQsXG4gIGdyYW1tYXI6IEdyYW1tYXIgfCBudWxsLFxuICByZW5kZXJMYVRlWDogYm9vbGVhbixcbiAgY29weUhUTUxGbGFnOiBib29sZWFuLFxuICBjYWxsYmFjazogKGVycm9yOiBFcnJvciB8IG51bGwsIGh0bWw6IHN0cmluZykgPT4gdm9pZCxcbik6IHZvaWQge1xuICBpZiAodGV4dCA9PSBudWxsKSB7XG4gICAgdGV4dCA9ICcnXG4gIH1cbiAgcmVuZGVyKHRleHQsIGZpbGVQYXRoLCByZW5kZXJMYVRlWCwgY29weUhUTUxGbGFnLCBmdW5jdGlvbihlcnJvciwgaHRtbCkge1xuICAgIGxldCBkZWZhdWx0Q29kZUxhbmd1YWdlOiBzdHJpbmcgfCB1bmRlZmluZWRcbiAgICBpZiAoZXJyb3IgIT0gbnVsbCkge1xuICAgICAgY2FsbGJhY2soZXJyb3IsICcnKVxuICAgIH1cbiAgICAvLyBEZWZhdWx0IGNvZGUgYmxvY2tzIHRvIGJlIGNvZmZlZSBpbiBMaXRlcmF0ZSBDb2ZmZWVTY3JpcHQgZmlsZXNcbiAgICBpZiAoKGdyYW1tYXIgJiYgZ3JhbW1hci5zY29wZU5hbWUpID09PSAnc291cmNlLmxpdGNvZmZlZScpIHtcbiAgICAgIGRlZmF1bHRDb2RlTGFuZ3VhZ2UgPSAnY29mZmVlJ1xuICAgIH1cbiAgICBpZiAoXG4gICAgICAhYXRvbS5jb25maWcuZ2V0KCdtYXJrZG93bi1wcmV2aWV3LXBsdXMuZW5hYmxlUGFuZG9jJykgfHxcbiAgICAgICFhdG9tLmNvbmZpZy5nZXQoJ21hcmtkb3duLXByZXZpZXctcGx1cy51c2VOYXRpdmVQYW5kb2NDb2RlU3R5bGVzJylcbiAgICApIHtcbiAgICAgIGh0bWwgPSB0b2tlbml6ZUNvZGVCbG9ja3MoaHRtbCwgZGVmYXVsdENvZGVMYW5ndWFnZSlcbiAgICB9XG4gICAgY2FsbGJhY2sobnVsbCwgaHRtbClcbiAgfSlcbn1cblxuZnVuY3Rpb24gcmVuZGVyKFxuICB0ZXh0OiBzdHJpbmcsXG4gIGZpbGVQYXRoOiBzdHJpbmcgfCB1bmRlZmluZWQsXG4gIHJlbmRlckxhVGVYOiBib29sZWFuLFxuICBjb3B5SFRNTEZsYWc6IGJvb2xlYW4sXG4gIGNhbGxiYWNrOiAoZXJyb3I6IEVycm9yIHwgbnVsbCwgaHRtbDogc3RyaW5nKSA9PiB2b2lkLFxuKTogdm9pZCB7XG4gIC8vIFJlbW92ZSB0aGUgPCFkb2N0eXBlPiBzaW5jZSBvdGhlcndpc2UgbWFya2VkIHdpbGwgZXNjYXBlIGl0XG4gIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9jaGpqL21hcmtlZC9pc3N1ZXMvMzU0XG4gIHRleHQgPSB0ZXh0LnJlcGxhY2UoL15cXHMqPCFkb2N0eXBlKFxccysuKik/PlxccyovaSwgJycpXG5cbiAgY29uc3QgY2FsbGJhY2tGdW5jdGlvbiA9IGZ1bmN0aW9uKGVycm9yOiBFcnJvciB8IG51bGwsIGh0bWw6IHN0cmluZykge1xuICAgIGlmIChlcnJvciAhPSBudWxsKSB7XG4gICAgICBjYWxsYmFjayhlcnJvciwgJycpXG4gICAgfVxuICAgIGh0bWwgPSBzYW5pdGl6ZShodG1sKVxuICAgIGh0bWwgPSByZXNvbHZlSW1hZ2VQYXRocyhodG1sLCBmaWxlUGF0aCwgY29weUhUTUxGbGFnKVxuICAgIGNhbGxiYWNrKG51bGwsIGh0bWwudHJpbSgpKVxuICB9XG5cbiAgaWYgKGF0b20uY29uZmlnLmdldCgnbWFya2Rvd24tcHJldmlldy1wbHVzLmVuYWJsZVBhbmRvYycpKSB7XG4gICAgcGFuZG9jSGVscGVyLnJlbmRlclBhbmRvYyh0ZXh0LCBmaWxlUGF0aCwgcmVuZGVyTGFUZVgsIGNhbGxiYWNrRnVuY3Rpb24pXG4gIH0gZWxzZSB7XG4gICAgY2FsbGJhY2tGdW5jdGlvbihudWxsLCBtYXJrZG93bkl0LnJlbmRlcih0ZXh0LCByZW5kZXJMYVRlWCkpXG4gIH1cbn1cblxuZnVuY3Rpb24gc2FuaXRpemUoaHRtbDogc3RyaW5nKSB7XG4gIGNvbnN0IGRvYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpXG4gIGRvYy5pbm5lckhUTUwgPSBodG1sXG4gIC8vIERvIG5vdCByZW1vdmUgTWF0aEpheCBzY3JpcHQgZGVsaW1pdGVkIGJsb2Nrc1xuICBkb2NcbiAgICAucXVlcnlTZWxlY3RvckFsbChcInNjcmlwdDpub3QoW3R5cGVePSdtYXRoL3RleCddKVwiKVxuICAgIC5mb3JFYWNoKChlbGVtKSA9PiB7IGVsZW0ucmVtb3ZlKCkgfSlcbiAgY29uc3QgYXR0cmlidXRlc1RvUmVtb3ZlID0gW1xuICAgICdvbmFib3J0JyxcbiAgICAnb25ibHVyJyxcbiAgICAnb25jaGFuZ2UnLFxuICAgICdvbmNsaWNrJyxcbiAgICAnb25kYmNsaWNrJyxcbiAgICAnb25lcnJvcicsXG4gICAgJ29uZm9jdXMnLFxuICAgICdvbmtleWRvd24nLFxuICAgICdvbmtleXByZXNzJyxcbiAgICAnb25rZXl1cCcsXG4gICAgJ29ubG9hZCcsXG4gICAgJ29ubW91c2Vkb3duJyxcbiAgICAnb25tb3VzZW1vdmUnLFxuICAgICdvbm1vdXNlb3ZlcicsXG4gICAgJ29ubW91c2VvdXQnLFxuICAgICdvbm1vdXNldXAnLFxuICAgICdvbnJlc2V0JyxcbiAgICAnb25yZXNpemUnLFxuICAgICdvbnNjcm9sbCcsXG4gICAgJ29uc2VsZWN0JyxcbiAgICAnb25zdWJtaXQnLFxuICAgICdvbnVubG9hZCcsXG4gIF1cbiAgZG9jXG4gICAgLnF1ZXJ5U2VsZWN0b3JBbGwoJyonKVxuICAgIC5mb3JFYWNoKChlbGVtKSA9PlxuICAgICAgQXJyYXkuZnJvbShhdHRyaWJ1dGVzVG9SZW1vdmUpLm1hcCgoYXR0cmlidXRlKSA9PiB7XG4gICAgICAgIGVsZW0ucmVtb3ZlQXR0cmlidXRlKGF0dHJpYnV0ZSlcbiAgICAgIH0pLFxuICAgIClcbiAgcmV0dXJuIGRvYy5pbm5lckhUTUxcbn1cblxuZnVuY3Rpb24gcmVzb2x2ZUltYWdlUGF0aHMoXG4gIGh0bWw6IHN0cmluZyxcbiAgZmlsZVBhdGg6IHN0cmluZyB8IHVuZGVmaW5lZCxcbiAgY29weUhUTUxGbGFnOiBib29sZWFuLFxuKSB7XG4gIGNvbnN0IFtyb290RGlyZWN0b3J5XSA9IEFycmF5LmZyb20oXG4gICAgYXRvbS5wcm9qZWN0LnJlbGF0aXZpemVQYXRoKGZpbGVQYXRoIHx8ICcnKSxcbiAgKVxuICBjb25zdCBkb2MgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKVxuICBkb2MuaW5uZXJIVE1MID0gaHRtbFxuICBkb2MucXVlcnlTZWxlY3RvckFsbCgnaW1nJykuZm9yRWFjaChmdW5jdGlvbihpbWcpIHtcbiAgICBsZXQgc3JjID0gaW1nLmdldEF0dHJpYnV0ZSgnc3JjJylcbiAgICBpZiAoc3JjKSB7XG4gICAgICBpZiAoIWF0b20uY29uZmlnLmdldCgnbWFya2Rvd24tcHJldmlldy1wbHVzLmVuYWJsZVBhbmRvYycpKSB7XG4gICAgICAgIHNyYyA9IG1hcmtkb3duSXQuZGVjb2RlKHNyYylcbiAgICAgIH1cblxuICAgICAgaWYgKHNyYy5tYXRjaCgvXihodHRwcz98YXRvbXxkYXRhKTovKSkge1xuICAgICAgICByZXR1cm5cbiAgICAgIH1cbiAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgIGlmIChzcmMuc3RhcnRzV2l0aChwcm9jZXNzLnJlc291cmNlc1BhdGgpKSB7XG4gICAgICAgIHJldHVyblxuICAgICAgfVxuICAgICAgaWYgKHNyYy5zdGFydHNXaXRoKHJlc291cmNlUGF0aCkpIHtcbiAgICAgICAgcmV0dXJuXG4gICAgICB9XG4gICAgICBpZiAoc3JjLnN0YXJ0c1dpdGgocGFja2FnZVBhdGgpKSB7XG4gICAgICAgIHJldHVyblxuICAgICAgfVxuXG4gICAgICBpZiAoc3JjWzBdID09PSAnLycpIHtcbiAgICAgICAgaWYgKCFmcy5pc0ZpbGVTeW5jKHNyYykpIHtcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgc3JjID0gcGF0aC5qb2luKHJvb3REaXJlY3RvcnksIHNyYy5zdWJzdHJpbmcoMSkpXG4gICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgLy8gbm9vcFxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmIChmaWxlUGF0aCkge1xuICAgICAgICBzcmMgPSBwYXRoLnJlc29sdmUocGF0aC5kaXJuYW1lKGZpbGVQYXRoKSwgc3JjKVxuICAgICAgfVxuXG4gICAgICAvLyBVc2UgbW9zdCByZWNlbnQgdmVyc2lvbiBvZiBpbWFnZVxuICAgICAgaWYgKCFjb3B5SFRNTEZsYWcpIHtcbiAgICAgICAgY29uc3QgdiA9IGltYWdlV2F0Y2hlci5nZXRWZXJzaW9uKHNyYywgZmlsZVBhdGgpXG4gICAgICAgIGlmICh2KSB7XG4gICAgICAgICAgc3JjID0gYCR7c3JjfT92PSR7dn1gXG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgcmV0dXJuIChpbWcuc3JjID0gc3JjKVxuICAgIH1cbiAgICByZXR1cm5cbiAgfSlcblxuICByZXR1cm4gZG9jLmlubmVySFRNTFxufVxuXG5leHBvcnQgZnVuY3Rpb24gY29udmVydENvZGVCbG9ja3NUb0F0b21FZGl0b3JzKFxuICBkb21GcmFnbWVudDogRWxlbWVudCxcbiAgZGVmYXVsdExhbmd1YWdlOiBzdHJpbmcgPSAndGV4dCcsXG4pIHtcbiAgY29uc3QgZm9udEZhbWlseSA9IGF0b20uY29uZmlnLmdldCgnZWRpdG9yLmZvbnRGYW1pbHknKVxuICBpZiAoZm9udEZhbWlseSkge1xuICAgIGZvciAoY29uc3QgY29kZUVsZW1lbnQgb2YgQXJyYXkuZnJvbShcbiAgICAgIGRvbUZyYWdtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ2NvZGUnKSxcbiAgICApKSB7XG4gICAgICBjb2RlRWxlbWVudC5zdHlsZS5mb250RmFtaWx5ID0gZm9udEZhbWlseVxuICAgIH1cbiAgfVxuXG4gIGZvciAoY29uc3QgcHJlRWxlbWVudCBvZiBBcnJheS5mcm9tKGRvbUZyYWdtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ3ByZScpKSkge1xuICAgIGNvbnN0IGNvZGVCbG9jayA9XG4gICAgICBwcmVFbGVtZW50LmZpcnN0RWxlbWVudENoaWxkICE9PSBudWxsXG4gICAgICAgID8gcHJlRWxlbWVudC5maXJzdEVsZW1lbnRDaGlsZFxuICAgICAgICA6IHByZUVsZW1lbnRcbiAgICBjb25zdCBjYkNsYXNzID0gY29kZUJsb2NrLmNsYXNzTmFtZVxuICAgIGNvbnN0IGZlbmNlTmFtZSA9IGNiQ2xhc3NcbiAgICAgID8gY2JDbGFzcy5yZXBsYWNlKC9eKGxhbmctfHNvdXJjZUNvZGUgKS8sICcnKVxuICAgICAgOiBkZWZhdWx0TGFuZ3VhZ2VcblxuICAgIGNvbnN0IGVkaXRvckVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFxuICAgICAgJ2F0b20tdGV4dC1lZGl0b3InLFxuICAgICkgYXMgVGV4dEVkaXRvckVsZW1lbnRcbiAgICBlZGl0b3JFbGVtZW50LnNldEF0dHJpYnV0ZU5vZGUoZG9jdW1lbnQuY3JlYXRlQXR0cmlidXRlKCdndXR0ZXItaGlkZGVuJykpXG4gICAgZWRpdG9yRWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUoJ3RhYmluZGV4JykgLy8gbWFrZSByZWFkLW9ubHlcblxuICAgIHByZUVsZW1lbnQucGFyZW50RWxlbWVudCEucmVwbGFjZUNoaWxkKGVkaXRvckVsZW1lbnQsIHByZUVsZW1lbnQpXG5cbiAgICBjb25zdCBlZGl0b3IgPSBlZGl0b3JFbGVtZW50LmdldE1vZGVsKClcbiAgICAvLyByZW1vdmUgdGhlIGRlZmF1bHQgc2VsZWN0aW9uIG9mIGEgbGluZSBpbiBlYWNoIGVkaXRvclxuICAgIGlmIChlZGl0b3IuY3Vyc29yTGluZURlY29yYXRpb25zICE9IG51bGwpIHtcbiAgICAgIGZvciAoY29uc3QgY3Vyc29yTGluZURlY29yYXRpb24gb2YgZWRpdG9yLmN1cnNvckxpbmVEZWNvcmF0aW9ucykge1xuICAgICAgICBjdXJzb3JMaW5lRGVjb3JhdGlvbi5kZXN0cm95KClcbiAgICAgIH1cbiAgICB9XG5cbiAgICBlZGl0b3Iuc2V0VGV4dChjb2RlQmxvY2sudGV4dENvbnRlbnQhLnJlcGxhY2UoL1xcbiQvLCAnJykpXG4gICAgY29uc3QgZ3JhbW1hciA9IGF0b20uZ3JhbW1hcnMuZ3JhbW1hckZvclNjb3BlTmFtZShcbiAgICAgIHNjb3BlRm9yRmVuY2VOYW1lKGZlbmNlTmFtZSksXG4gICAgKVxuICAgIGlmIChncmFtbWFyKSBlZGl0b3Iuc2V0R3JhbW1hcihncmFtbWFyKVxuICB9XG5cbiAgcmV0dXJuIGRvbUZyYWdtZW50XG59XG5cbmZ1bmN0aW9uIHRva2VuaXplQ29kZUJsb2NrcyhodG1sOiBzdHJpbmcsIGRlZmF1bHRMYW5ndWFnZTogc3RyaW5nID0gJ3RleHQnKSB7XG4gIGNvbnN0IGRvYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpXG4gIGRvYy5pbm5lckhUTUwgPSBodG1sXG5cbiAgY29uc3QgZm9udEZhbWlseSA9IGF0b20uY29uZmlnLmdldCgnZWRpdG9yLmZvbnRGYW1pbHknKVxuICBpZiAoZm9udEZhbWlseSkge1xuICAgIGRvY1xuICAgICAgLnF1ZXJ5U2VsZWN0b3JBbGwoJ2NvZGUnKVxuICAgICAgLmZvckVhY2goKGNvZGUpID0+IChjb2RlLnN0eWxlLmZvbnRGYW1pbHkgPSBmb250RmFtaWx5IHx8IG51bGwpKVxuICB9XG5cbiAgZG9jLnF1ZXJ5U2VsZWN0b3JBbGwoJ3ByZScpLmZvckVhY2goZnVuY3Rpb24ocHJlRWxlbWVudCkge1xuICAgIGNvbnN0IGNvZGVCbG9jayA9IHByZUVsZW1lbnQuZmlyc3RFbGVtZW50Q2hpbGQgYXMgSFRNTEVsZW1lbnRcbiAgICBjb25zdCBmZW5jZU5hbWUgPVxuICAgICAgY29kZUJsb2NrLmNsYXNzTmFtZS5yZXBsYWNlKC9eKGxhbmctfHNvdXJjZUNvZGUgKS8sICcnKSB8fCBkZWZhdWx0TGFuZ3VhZ2VcblxuICAgIGNvbnN0IGhpZ2hsaWdodGVkSHRtbCA9IGhpZ2hsaWdodCh7XG4gICAgICBmaWxlQ29udGVudHM6IGNvZGVCbG9jay5pbm5lclRleHQsXG4gICAgICBzY29wZU5hbWU6IHNjb3BlRm9yRmVuY2VOYW1lKGZlbmNlTmFtZSksXG4gICAgICBuYnNwOiBmYWxzZSxcbiAgICAgIGxpbmVEaXZzOiBmYWxzZSxcbiAgICAgIGVkaXRvckRpdjogdHJ1ZSxcbiAgICAgIGVkaXRvckRpdlRhZzogJ3ByZScsXG4gICAgICAvLyBUaGUgYGVkaXRvcmAgY2xhc3MgbWVzc2VzIHRoaW5ncyB1cCBhcyBgLmVkaXRvcmAgaGFzIGFic29sdXRlbHkgcG9zaXRpb25lZCBsaW5lc1xuICAgICAgZWRpdG9yRGl2Q2xhc3M6IGZlbmNlTmFtZVxuICAgICAgICA/IGBlZGl0b3ItY29sb3JzIGxhbmctJHtmZW5jZU5hbWV9YFxuICAgICAgICA6ICdlZGl0b3ItY29sb3JzJyxcbiAgICB9KVxuXG4gICAgcmV0dXJuIChwcmVFbGVtZW50Lm91dGVySFRNTCA9IGhpZ2hsaWdodGVkSHRtbClcbiAgfSlcblxuICByZXR1cm4gZG9jLmlubmVySFRNTFxufVxuIl19