"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const fs = require("fs-plus");
const highlight = require("atom-highlight");
const pandocHelper = require("./pandoc-helper");
const markdownIt = require("./markdown-it-helper");
const extension_helper_1 = require("./extension-helper");
const imageWatcher = require("./image-watch-helper");
const { resourcePath } = atom.getLoadSettings();
const packagePath = path.dirname(__dirname);
function toDOMFragment(text, filePath, grammar, renderLaTeX, callback) {
    if (text == null) {
        text = "";
    }
    return render(text, filePath, renderLaTeX, false, function (error, html) {
        if (error != null) {
            return callback(error);
        }
        const template = document.createElement("template");
        template.innerHTML = html;
        const domFragment = template.content.cloneNode(true);
        return callback(null, domFragment);
    });
}
exports.toDOMFragment = toDOMFragment;
function toHTML(text, filePath, grammar, renderLaTeX, copyHTMLFlag, callback) {
    if (text == null) {
        text = "";
    }
    return render(text, filePath, renderLaTeX, copyHTMLFlag, function (error, html) {
        let defaultCodeLanguage;
        if (error != null) {
            return callback(error);
        }
        if ((grammar != null ? grammar.scopeName : undefined) === "source.litcoffee") {
            defaultCodeLanguage = "coffee";
        }
        if (!atom.config.get("markdown-preview-plus.enablePandoc") ||
            !atom.config.get("markdown-preview-plus.useNativePandocCodeStyles")) {
            html = tokenizeCodeBlocks(html, defaultCodeLanguage);
        }
        return callback(null, html);
    });
}
exports.toHTML = toHTML;
function render(text, filePath, renderLaTeX, copyHTMLFlag, callback) {
    text = text.replace(/^\s*<!doctype(\s+.*)?>\s*/i, "");
    const callbackFunction = function (error, html) {
        if (error != null) {
            return callback(error);
        }
        html = sanitize(html);
        html = resolveImagePaths(html, filePath, copyHTMLFlag);
        return callback(null, html.trim());
    };
    if (atom.config.get("markdown-preview-plus.enablePandoc")) {
        return pandocHelper.renderPandoc(text, filePath, renderLaTeX, callbackFunction);
    }
    else {
        if (markdownIt == null) {
            markdownIt = require("./markdown-it-helper");
        }
        return callbackFunction(null, markdownIt.render(text, renderLaTeX));
    }
}
function sanitize(html) {
    const doc = document.createElement("div");
    doc.innerHTML = html;
    doc
        .querySelectorAll("script:not([type^='math/tex'])")
        .forEach(elem => elem.remove());
    const attributesToRemove = [
        "onabort",
        "onblur",
        "onchange",
        "onclick",
        "ondbclick",
        "onerror",
        "onfocus",
        "onkeydown",
        "onkeypress",
        "onkeyup",
        "onload",
        "onmousedown",
        "onmousemove",
        "onmouseover",
        "onmouseout",
        "onmouseup",
        "onreset",
        "onresize",
        "onscroll",
        "onselect",
        "onsubmit",
        "onunload"
    ];
    doc
        .querySelectorAll("*")
        .forEach(elem => Array.from(attributesToRemove).map(attribute => elem.removeAttribute(attribute)));
    return doc.innerHTML;
}
function resolveImagePaths(html, filePath, copyHTMLFlag) {
    let rootDirectory;
    if (atom.project != null) {
        ;
        [rootDirectory] = Array.from(atom.project.relativizePath(filePath));
    }
    const doc = document.createElement("div");
    doc.innerHTML = html;
    doc.querySelectorAll("img").forEach(function (img) {
        let src;
        if ((src = img.getAttribute("src"))) {
            if (!atom.config.get("markdown-preview-plus.enablePandoc")) {
                if (markdownIt == null) {
                    markdownIt = require("./markdown-it-helper");
                }
                src = markdownIt.decode(src);
            }
            if (src.match(/^(https?|atom|data):/)) {
                return;
            }
            if (src.startsWith(process.resourcesPath)) {
                return;
            }
            if (src.startsWith(resourcePath)) {
                return;
            }
            if (src.startsWith(packagePath)) {
                return;
            }
            if (src[0] === "/") {
                if (!fs.isFileSync(src)) {
                    try {
                        src = path.join(rootDirectory, src.substring(1));
                    }
                    catch (e) { }
                }
            }
            else {
                src = path.resolve(path.dirname(filePath), src);
            }
            if (!copyHTMLFlag) {
                const v = imageWatcher.getVersion(src, filePath);
                if (v) {
                    src = `${src}?v=${v}`;
                }
            }
            return (img.src = src);
        }
    });
    return doc.innerHTML;
}
function convertCodeBlocksToAtomEditors(domFragment, defaultLanguage) {
    let fontFamily;
    if (defaultLanguage == null) {
        defaultLanguage = "text";
    }
    if ((fontFamily = atom.config.get("editor.fontFamily"))) {
        for (let codeElement of Array.from(domFragment.querySelectorAll("code"))) {
            codeElement.style.fontFamily = fontFamily;
        }
    }
    for (let preElement of Array.from(domFragment.querySelectorAll("pre"))) {
        var grammar, left;
        const codeBlock = preElement.firstElementChild != null
            ? preElement.firstElementChild
            : preElement;
        const fenceName = (left = __guard__(codeBlock.getAttribute("class"), x => x.replace(/^(lang-|sourceCode )/, ""))) != null
            ? left
            : defaultLanguage;
        const editorElement = document.createElement("atom-text-editor");
        editorElement.setAttributeNode(document.createAttribute("gutter-hidden"));
        editorElement.removeAttribute("tabindex");
        preElement.parentNode.insertBefore(editorElement, preElement);
        preElement.remove();
        const editor = editorElement.getModel();
        if (editor.cursorLineDecorations != null) {
            for (let cursorLineDecoration of Array.from(editor.cursorLineDecorations)) {
                cursorLineDecoration.destroy();
            }
        }
        else {
            editor.getDecorations({ class: "cursor-line", type: "line" })[0].destroy();
        }
        editor.setText(codeBlock.textContent.replace(/\n$/, ""));
        if ((grammar = atom.grammars.grammarForScopeName(extension_helper_1.scopeForFenceName(fenceName)))) {
            editor.setGrammar(grammar);
        }
    }
    return domFragment;
}
exports.convertCodeBlocksToAtomEditors = convertCodeBlocksToAtomEditors;
function tokenizeCodeBlocks(html, defaultLanguage) {
    let fontFamily;
    if (defaultLanguage == null) {
        defaultLanguage = "text";
    }
    const doc = document.createElement("div");
    doc.innerHTML = html;
    if ((fontFamily = atom.config.get("editor.fontFamily"))) {
        doc
            .querySelectorAll("code")
            .forEach(code => (code.style.fontFamily = fontFamily));
    }
    doc.querySelectorAll("pre").forEach(function (preElement) {
        let left;
        const codeBlock = preElement.firstElementChild;
        const fenceName = (left = codeBlock.className.replace(/^(lang-|sourceCode )/, "")) != null
            ? left
            : defaultLanguage;
        const highlightedHtml = highlight({
            fileContents: codeBlock.innerText,
            scopeName: extension_helper_1.scopeForFenceName(fenceName),
            nbsp: false,
            lineDivs: false,
            editorDiv: true,
            editorDivTag: "pre",
            editorDivClass: fenceName
                ? `editor-colors lang-${fenceName}`
                : "editor-colors"
        });
        return (preElement.outerHTML = highlightedHtml);
    });
    return doc.innerHTML;
}
function __guard__(value, transform) {
    return typeof value !== "undefined" && value !== null
        ? transform(value)
        : undefined;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVuZGVyZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcmVuZGVyZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFTQSw2QkFBNkI7QUFDN0IsOEJBQThCO0FBQzlCLDRDQUE0QztBQUM1QyxnREFBZ0Q7QUFDaEQsbURBQW1EO0FBQ25ELHlEQUFzRDtBQUN0RCxxREFBcUQ7QUFFckQsTUFBTSxFQUFFLFlBQVksRUFBRSxHQUFHLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQTtBQUMvQyxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFBO0FBRTNDLHVCQUNFLElBQVksRUFDWixRQUFhLEVBQ2IsT0FBWSxFQUNaLFdBQWdCLEVBQ2hCLFFBQStDO0lBRS9DLEVBQUUsQ0FBQyxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ2pCLElBQUksR0FBRyxFQUFFLENBQUE7SUFDWCxDQUFDO0lBQ0QsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsUUFBUSxFQUFFLFdBQVcsRUFBRSxLQUFLLEVBQUUsVUFBUyxLQUFLLEVBQUUsSUFBSTtRQUNwRSxFQUFFLENBQUMsQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQztZQUNsQixNQUFNLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFBO1FBQ3hCLENBQUM7UUFFRCxNQUFNLFFBQVEsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxDQUFBO1FBQ25ELFFBQVEsQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFBO1FBQ3pCLE1BQU0sV0FBVyxHQUFHLFFBQVEsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFBO1FBRXBELE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLFdBQVcsQ0FBQyxDQUFBO0lBQ3BDLENBQUMsQ0FBQyxDQUFBO0FBQ0osQ0FBQztBQXJCRCxzQ0FxQkM7QUFF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Q2pELENBQUMsQ0FBQyxDQUFBO0lBRUYsTUFBTSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUE7QUFDdEIsQ0FBQztBQUVELG1CQUFtQixLQUFLLEVBQUUsU0FBUztJQUNqQyxNQUFNLENBQUMsT0FBTyxLQUFLLEtBQUssV0FBVyxJQUFJLEtBQUssS0FBSyxJQUFJO1FBQ25ELENBQUMsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDO1FBQ2xCLENBQUMsQ0FBQyxTQUFTLENBQUE7QUFDZixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIGRlY2FmZmVpbmF0ZSBzdWdnZXN0aW9uczpcbiAqIERTMTAxOiBSZW1vdmUgdW5uZWNlc3NhcnkgdXNlIG9mIEFycmF5LmZyb21cbiAqIERTMTAyOiBSZW1vdmUgdW5uZWNlc3NhcnkgY29kZSBjcmVhdGVkIGJlY2F1c2Ugb2YgaW1wbGljaXQgcmV0dXJuc1xuICogRFMxMDM6IFJld3JpdGUgY29kZSB0byBubyBsb25nZXIgdXNlIF9fZ3VhcmRfX1xuICogRFMxMDQ6IEF2b2lkIGlubGluZSBhc3NpZ25tZW50c1xuICogRFMyMDc6IENvbnNpZGVyIHNob3J0ZXIgdmFyaWF0aW9ucyBvZiBudWxsIGNoZWNrc1xuICogRnVsbCBkb2NzOiBodHRwczovL2dpdGh1Yi5jb20vZGVjYWZmZWluYXRlL2RlY2FmZmVpbmF0ZS9ibG9iL21hc3Rlci9kb2NzL3N1Z2dlc3Rpb25zLm1kXG4gKi9cbmltcG9ydCBwYXRoID0gcmVxdWlyZShcInBhdGhcIilcbmltcG9ydCBmcyA9IHJlcXVpcmUoXCJmcy1wbHVzXCIpXG5pbXBvcnQgaGlnaGxpZ2h0ID0gcmVxdWlyZShcImF0b20taGlnaGxpZ2h0XCIpXG5pbXBvcnQgcGFuZG9jSGVscGVyID0gcmVxdWlyZShcIi4vcGFuZG9jLWhlbHBlclwiKVxuaW1wb3J0IG1hcmtkb3duSXQgPSByZXF1aXJlKFwiLi9tYXJrZG93bi1pdC1oZWxwZXJcIikgLy8gRGVmZXIgdW50aWwgdXNlZFxuaW1wb3J0IHsgc2NvcGVGb3JGZW5jZU5hbWUgfSBmcm9tIFwiLi9leHRlbnNpb24taGVscGVyXCJcbmltcG9ydCBpbWFnZVdhdGNoZXIgPSByZXF1aXJlKFwiLi9pbWFnZS13YXRjaC1oZWxwZXJcIilcblxuY29uc3QgeyByZXNvdXJjZVBhdGggfSA9IGF0b20uZ2V0TG9hZFNldHRpbmdzKClcbmNvbnN0IHBhY2thZ2VQYXRoID0gcGF0aC5kaXJuYW1lKF9fZGlybmFtZSlcblxuZXhwb3J0IGZ1bmN0aW9uIHRvRE9NRnJhZ21lbnQoXG4gIHRleHQ6IHN0cmluZyxcbiAgZmlsZVBhdGg6IGFueSxcbiAgZ3JhbW1hcjogYW55LFxuICByZW5kZXJMYVRlWDogYW55LFxuICBjYWxsYmFjazogKGVycm9yOiBhbnksIGRvbUZyYWdtZW50OiBhbnkpID0+IGFueVxuKSB7XG4gIGlmICh0ZXh0ID09IG51bGwpIHtcbiAgICB0ZXh0ID0gXCJcIlxuICB9XG4gIHJldHVybiByZW5kZXIodGV4dCwgZmlsZVBhdGgsIHJlbmRlckxhVGVYLCBmYWxzZSwgZnVuY3Rpb24oZXJyb3IsIGh0bWwpIHtcbiAgICBpZiAoZXJyb3IgIT0gbnVsbCkge1xuICAgICAgcmV0dXJuIGNhbGxiYWNrKGVycm9yKVxuICAgIH1cblxuICAgIGNvbnN0IHRlbXBsYXRlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcInRlbXBsYXRlXCIpXG4gICAgdGVtcGxhdGUuaW5uZXJIVE1MID0gaHRtbFxuICAgIGNvbnN0IGRvbUZyYWdtZW50ID0gdGVtcGxhdGUuY29udGVudC5jbG9uZU5vZGUodHJ1ZSlcblxuICAgIHJldHVybiBjYWxsYmFjayhudWxsLCBkb21GcmFnbWVudClcbiAgfSlcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHRvSFRNTChcbiAgdGV4dCxcbiAgZmlsZVBhdGgsXG4gIGdyYW1tYXIsXG4gIHJlbmRlckxhVGVYLFxuICBjb3B5SFRNTEZsYWcsXG4gIGNhbGxiYWNrXG4pIHtcbiAgaWYgKHRleHQgPT0gbnVsbCkge1xuICAgIHRleHQgPSBcIlwiXG4gIH1cbiAgcmV0dXJuIHJlbmRlcih0ZXh0LCBmaWxlUGF0aCwgcmVuZGVyTGFUZVgsIGNvcHlIVE1MRmxhZywgZnVuY3Rpb24oXG4gICAgZXJyb3IsXG4gICAgaHRtbFxuICApIHtcbiAgICBsZXQgZGVmYXVsdENvZGVMYW5ndWFnZVxuICAgIGlmIChlcnJvciAhPSBudWxsKSB7XG4gICAgICByZXR1cm4gY2FsbGJhY2soZXJyb3IpXG4gICAgfVxuICAgIC8vIERlZmF1bHQgY29kZSBibG9ja3MgdG8gYmUgY29mZmVlIGluIExpdGVyYXRlIENvZmZlZVNjcmlwdCBmaWxlc1xuICAgIGlmIChcbiAgICAgIChncmFtbWFyICE9IG51bGwgPyBncmFtbWFyLnNjb3BlTmFtZSA6IHVuZGVmaW5lZCkgPT09IFwic291cmNlLmxpdGNvZmZlZVwiXG4gICAgKSB7XG4gICAgICBkZWZhdWx0Q29kZUxhbmd1YWdlID0gXCJjb2ZmZWVcIlxuICAgIH1cbiAgICBpZiAoXG4gICAgICAhYXRvbS5jb25maWcuZ2V0KFwibWFya2Rvd24tcHJldmlldy1wbHVzLmVuYWJsZVBhbmRvY1wiKSB8fFxuICAgICAgIWF0b20uY29uZmlnLmdldChcIm1hcmtkb3duLXByZXZpZXctcGx1cy51c2VOYXRpdmVQYW5kb2NDb2RlU3R5bGVzXCIpXG4gICAgKSB7XG4gICAgICBodG1sID0gdG9rZW5pemVDb2RlQmxvY2tzKGh0bWwsIGRlZmF1bHRDb2RlTGFuZ3VhZ2UpXG4gICAgfVxuICAgIHJldHVybiBjYWxsYmFjayhudWxsLCBodG1sKVxuICB9KVxufVxuXG5mdW5jdGlvbiByZW5kZXIodGV4dCwgZmlsZVBhdGgsIHJlbmRlckxhVGVYLCBjb3B5SFRNTEZsYWcsIGNhbGxiYWNrKSB7XG4gIC8vIFJlbW92ZSB0aGUgPCFkb2N0eXBlPiBzaW5jZSBvdGhlcndpc2UgbWFya2VkIHdpbGwgZXNjYXBlIGl0XG4gIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9jaGpqL21hcmtlZC9pc3N1ZXMvMzU0XG4gIHRleHQgPSB0ZXh0LnJlcGxhY2UoL15cXHMqPCFkb2N0eXBlKFxccysuKik/PlxccyovaSwgXCJcIilcblxuICBjb25zdCBjYWxsYmFja0Z1bmN0aW9uID0gZnVuY3Rpb24oZXJyb3IsIGh0bWwpIHtcbiAgICBpZiAoZXJyb3IgIT0gbnVsbCkge1xuICAgICAgcmV0dXJuIGNhbGxiYWNrKGVycm9yKVxuICAgIH1cbiAgICBodG1sID0gc2FuaXRpemUoaHRtbClcbiAgICBodG1sID0gcmVzb2x2ZUltYWdlUGF0aHMoaHRtbCwgZmlsZVBhdGgsIGNvcHlIVE1MRmxhZylcbiAgICByZXR1cm4gY2FsbGJhY2sobnVsbCwgaHRtbC50cmltKCkpXG4gIH1cblxuICBpZiAoYXRvbS5jb25maWcuZ2V0KFwibWFya2Rvd24tcHJldmlldy1wbHVzLmVuYWJsZVBhbmRvY1wiKSkge1xuICAgIHJldHVybiBwYW5kb2NIZWxwZXIucmVuZGVyUGFuZG9jKFxuICAgICAgdGV4dCxcbiAgICAgIGZpbGVQYXRoLFxuICAgICAgcmVuZGVyTGFUZVgsXG4gICAgICBjYWxsYmFja0Z1bmN0aW9uXG4gICAgKVxuICB9IGVsc2Uge1xuICAgIGlmIChtYXJrZG93bkl0ID09IG51bGwpIHtcbiAgICAgIG1hcmtkb3duSXQgPSByZXF1aXJlKFwiLi9tYXJrZG93bi1pdC1oZWxwZXJcIilcbiAgICB9XG5cbiAgICByZXR1cm4gY2FsbGJhY2tGdW5jdGlvbihudWxsLCBtYXJrZG93bkl0LnJlbmRlcih0ZXh0LCByZW5kZXJMYVRlWCkpXG4gIH1cbn1cblxuZnVuY3Rpb24gc2FuaXRpemUoaHRtbCkge1xuICBjb25zdCBkb2MgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpXG4gIGRvYy5pbm5lckhUTUwgPSBodG1sXG4gIC8vIERvIG5vdCByZW1vdmUgTWF0aEpheCBzY3JpcHQgZGVsaW1pdGVkIGJsb2Nrc1xuICBkb2NcbiAgICAucXVlcnlTZWxlY3RvckFsbChcInNjcmlwdDpub3QoW3R5cGVePSdtYXRoL3RleCddKVwiKVxuICAgIC5mb3JFYWNoKGVsZW0gPT4gZWxlbS5yZW1vdmUoKSlcbiAgY29uc3QgYXR0cmlidXRlc1RvUmVtb3ZlID0gW1xuICAgIFwib25hYm9ydFwiLFxuICAgIFwib25ibHVyXCIsXG4gICAgXCJvbmNoYW5nZVwiLFxuICAgIFwib25jbGlja1wiLFxuICAgIFwib25kYmNsaWNrXCIsXG4gICAgXCJvbmVycm9yXCIsXG4gICAgXCJvbmZvY3VzXCIsXG4gICAgXCJvbmtleWRvd25cIixcbiAgICBcIm9ua2V5cHJlc3NcIixcbiAgICBcIm9ua2V5dXBcIixcbiAgICBcIm9ubG9hZFwiLFxuICAgIFwib25tb3VzZWRvd25cIixcbiAgICBcIm9ubW91c2Vtb3ZlXCIsXG4gICAgXCJvbm1vdXNlb3ZlclwiLFxuICAgIFwib25tb3VzZW91dFwiLFxuICAgIFwib25tb3VzZXVwXCIsXG4gICAgXCJvbnJlc2V0XCIsXG4gICAgXCJvbnJlc2l6ZVwiLFxuICAgIFwib25zY3JvbGxcIixcbiAgICBcIm9uc2VsZWN0XCIsXG4gICAgXCJvbnN1Ym1pdFwiLFxuICAgIFwib251bmxvYWRcIlxuICBdXG4gIGRvY1xuICAgIC5xdWVyeVNlbGVjdG9yQWxsKFwiKlwiKVxuICAgIC5mb3JFYWNoKGVsZW0gPT5cbiAgICAgIEFycmF5LmZyb20oYXR0cmlidXRlc1RvUmVtb3ZlKS5tYXAoYXR0cmlidXRlID0+XG4gICAgICAgIGVsZW0ucmVtb3ZlQXR0cmlidXRlKGF0dHJpYnV0ZSlcbiAgICAgIClcbiAgICApXG4gIHJldHVybiBkb2MuaW5uZXJIVE1MXG59XG5cbmZ1bmN0aW9uIHJlc29sdmVJbWFnZVBhdGhzKGh0bWwsIGZpbGVQYXRoLCBjb3B5SFRNTEZsYWcpIHtcbiAgbGV0IHJvb3REaXJlY3RvcnlcbiAgaWYgKGF0b20ucHJvamVjdCAhPSBudWxsKSB7XG4gICAgO1tyb290RGlyZWN0b3J5XSA9IEFycmF5LmZyb20oYXRvbS5wcm9qZWN0LnJlbGF0aXZpemVQYXRoKGZpbGVQYXRoKSlcbiAgfVxuICBjb25zdCBkb2MgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpXG4gIGRvYy5pbm5lckhUTUwgPSBodG1sXG4gIGRvYy5xdWVyeVNlbGVjdG9yQWxsKFwiaW1nXCIpLmZvckVhY2goZnVuY3Rpb24oaW1nKSB7XG4gICAgbGV0IHNyY1xuICAgIGlmICgoc3JjID0gaW1nLmdldEF0dHJpYnV0ZShcInNyY1wiKSkpIHtcbiAgICAgIGlmICghYXRvbS5jb25maWcuZ2V0KFwibWFya2Rvd24tcHJldmlldy1wbHVzLmVuYWJsZVBhbmRvY1wiKSkge1xuICAgICAgICBpZiAobWFya2Rvd25JdCA9PSBudWxsKSB7XG4gICAgICAgICAgbWFya2Rvd25JdCA9IHJlcXVpcmUoXCIuL21hcmtkb3duLWl0LWhlbHBlclwiKVxuICAgICAgICB9XG4gICAgICAgIHNyYyA9IG1hcmtkb3duSXQuZGVjb2RlKHNyYylcbiAgICAgIH1cblxuICAgICAgaWYgKHNyYy5tYXRjaCgvXihodHRwcz98YXRvbXxkYXRhKTovKSkge1xuICAgICAgICByZXR1cm5cbiAgICAgIH1cbiAgICAgIGlmIChzcmMuc3RhcnRzV2l0aChwcm9jZXNzLnJlc291cmNlc1BhdGgpKSB7XG4gICAgICAgIHJldHVyblxuICAgICAgfVxuICAgICAgaWYgKHNyYy5zdGFydHNXaXRoKHJlc291cmNlUGF0aCkpIHtcbiAgICAgICAgcmV0dXJuXG4gICAgICB9XG4gICAgICBpZiAoc3JjLnN0YXJ0c1dpdGgocGFja2FnZVBhdGgpKSB7XG4gICAgICAgIHJldHVyblxuICAgICAgfVxuXG4gICAgICBpZiAoc3JjWzBdID09PSBcIi9cIikge1xuICAgICAgICBpZiAoIWZzLmlzRmlsZVN5bmMoc3JjKSkge1xuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICBzcmMgPSBwYXRoLmpvaW4ocm9vdERpcmVjdG9yeSwgc3JjLnN1YnN0cmluZygxKSlcbiAgICAgICAgICB9IGNhdGNoIChlKSB7fVxuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBzcmMgPSBwYXRoLnJlc29sdmUocGF0aC5kaXJuYW1lKGZpbGVQYXRoKSwgc3JjKVxuICAgICAgfVxuXG4gICAgICAvLyBVc2UgbW9zdCByZWNlbnQgdmVyc2lvbiBvZiBpbWFnZVxuICAgICAgaWYgKCFjb3B5SFRNTEZsYWcpIHtcbiAgICAgICAgY29uc3QgdiA9IGltYWdlV2F0Y2hlci5nZXRWZXJzaW9uKHNyYywgZmlsZVBhdGgpXG4gICAgICAgIGlmICh2KSB7XG4gICAgICAgICAgc3JjID0gYCR7c3JjfT92PSR7dn1gXG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgcmV0dXJuIChpbWcuc3JjID0gc3JjKVxuICAgIH1cbiAgfSlcblxuICByZXR1cm4gZG9jLmlubmVySFRNTFxufVxuXG5leHBvcnQgZnVuY3Rpb24gY29udmVydENvZGVCbG9ja3NUb0F0b21FZGl0b3JzKGRvbUZyYWdtZW50LCBkZWZhdWx0TGFuZ3VhZ2UpIHtcbiAgbGV0IGZvbnRGYW1pbHlcbiAgaWYgKGRlZmF1bHRMYW5ndWFnZSA9PSBudWxsKSB7XG4gICAgZGVmYXVsdExhbmd1YWdlID0gXCJ0ZXh0XCJcbiAgfVxuICBpZiAoKGZvbnRGYW1pbHkgPSBhdG9tLmNvbmZpZy5nZXQoXCJlZGl0b3IuZm9udEZhbWlseVwiKSkpIHtcbiAgICBmb3IgKGxldCBjb2RlRWxlbWVudCBvZiBBcnJheS5mcm9tKGRvbUZyYWdtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoXCJjb2RlXCIpKSkge1xuICAgICAgY29kZUVsZW1lbnQuc3R5bGUuZm9udEZhbWlseSA9IGZvbnRGYW1pbHlcbiAgICB9XG4gIH1cblxuICBmb3IgKGxldCBwcmVFbGVtZW50IG9mIEFycmF5LmZyb20oZG9tRnJhZ21lbnQucXVlcnlTZWxlY3RvckFsbChcInByZVwiKSkpIHtcbiAgICB2YXIgZ3JhbW1hciwgbGVmdFxuICAgIGNvbnN0IGNvZGVCbG9jayA9XG4gICAgICBwcmVFbGVtZW50LmZpcnN0RWxlbWVudENoaWxkICE9IG51bGxcbiAgICAgICAgPyBwcmVFbGVtZW50LmZpcnN0RWxlbWVudENoaWxkXG4gICAgICAgIDogcHJlRWxlbWVudFxuICAgIGNvbnN0IGZlbmNlTmFtZSA9XG4gICAgICAobGVmdCA9IF9fZ3VhcmRfXyhjb2RlQmxvY2suZ2V0QXR0cmlidXRlKFwiY2xhc3NcIiksIHggPT5cbiAgICAgICAgeC5yZXBsYWNlKC9eKGxhbmctfHNvdXJjZUNvZGUgKS8sIFwiXCIpXG4gICAgICApKSAhPSBudWxsXG4gICAgICAgID8gbGVmdFxuICAgICAgICA6IGRlZmF1bHRMYW5ndWFnZVxuXG4gICAgY29uc3QgZWRpdG9yRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJhdG9tLXRleHQtZWRpdG9yXCIpXG4gICAgZWRpdG9yRWxlbWVudC5zZXRBdHRyaWJ1dGVOb2RlKGRvY3VtZW50LmNyZWF0ZUF0dHJpYnV0ZShcImd1dHRlci1oaWRkZW5cIikpXG4gICAgZWRpdG9yRWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUoXCJ0YWJpbmRleFwiKSAvLyBtYWtlIHJlYWQtb25seVxuXG4gICAgcHJlRWxlbWVudC5wYXJlbnROb2RlLmluc2VydEJlZm9yZShlZGl0b3JFbGVtZW50LCBwcmVFbGVtZW50KVxuICAgIHByZUVsZW1lbnQucmVtb3ZlKClcblxuICAgIGNvbnN0IGVkaXRvciA9IGVkaXRvckVsZW1lbnQuZ2V0TW9kZWwoKVxuICAgIC8vIHJlbW92ZSB0aGUgZGVmYXVsdCBzZWxlY3Rpb24gb2YgYSBsaW5lIGluIGVhY2ggZWRpdG9yXG4gICAgaWYgKGVkaXRvci5jdXJzb3JMaW5lRGVjb3JhdGlvbnMgIT0gbnVsbCkge1xuICAgICAgZm9yIChsZXQgY3Vyc29yTGluZURlY29yYXRpb24gb2YgQXJyYXkuZnJvbShcbiAgICAgICAgZWRpdG9yLmN1cnNvckxpbmVEZWNvcmF0aW9uc1xuICAgICAgKSkge1xuICAgICAgICBjdXJzb3JMaW5lRGVjb3JhdGlvbi5kZXN0cm95KClcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgZWRpdG9yLmdldERlY29yYXRpb25zKHsgY2xhc3M6IFwiY3Vyc29yLWxpbmVcIiwgdHlwZTogXCJsaW5lXCIgfSlbMF0uZGVzdHJveSgpXG4gICAgfVxuICAgIGVkaXRvci5zZXRUZXh0KGNvZGVCbG9jay50ZXh0Q29udGVudC5yZXBsYWNlKC9cXG4kLywgXCJcIikpXG4gICAgaWYgKFxuICAgICAgKGdyYW1tYXIgPSBhdG9tLmdyYW1tYXJzLmdyYW1tYXJGb3JTY29wZU5hbWUoXG4gICAgICAgIHNjb3BlRm9yRmVuY2VOYW1lKGZlbmNlTmFtZSlcbiAgICAgICkpXG4gICAgKSB7XG4gICAgICBlZGl0b3Iuc2V0R3JhbW1hcihncmFtbWFyKVxuICAgIH1cbiAgfVxuXG4gIHJldHVybiBkb21GcmFnbWVudFxufVxuXG5mdW5jdGlvbiB0b2tlbml6ZUNvZGVCbG9ja3MoaHRtbCwgZGVmYXVsdExhbmd1YWdlKSB7XG4gIGxldCBmb250RmFtaWx5XG4gIGlmIChkZWZhdWx0TGFuZ3VhZ2UgPT0gbnVsbCkge1xuICAgIGRlZmF1bHRMYW5ndWFnZSA9IFwidGV4dFwiXG4gIH1cbiAgY29uc3QgZG9jID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKVxuICBkb2MuaW5uZXJIVE1MID0gaHRtbFxuXG4gIGlmICgoZm9udEZhbWlseSA9IGF0b20uY29uZmlnLmdldChcImVkaXRvci5mb250RmFtaWx5XCIpKSkge1xuICAgIGRvY1xuICAgICAgLnF1ZXJ5U2VsZWN0b3JBbGwoXCJjb2RlXCIpXG4gICAgICAuZm9yRWFjaChjb2RlID0+IChjb2RlLnN0eWxlLmZvbnRGYW1pbHkgPSBmb250RmFtaWx5KSlcbiAgfVxuXG4gIGRvYy5xdWVyeVNlbGVjdG9yQWxsKFwicHJlXCIpLmZvckVhY2goZnVuY3Rpb24ocHJlRWxlbWVudCkge1xuICAgIGxldCBsZWZ0XG4gICAgY29uc3QgY29kZUJsb2NrID0gcHJlRWxlbWVudC5maXJzdEVsZW1lbnRDaGlsZFxuICAgIGNvbnN0IGZlbmNlTmFtZSA9XG4gICAgICAobGVmdCA9IGNvZGVCbG9jay5jbGFzc05hbWUucmVwbGFjZSgvXihsYW5nLXxzb3VyY2VDb2RlICkvLCBcIlwiKSkgIT0gbnVsbFxuICAgICAgICA/IGxlZnRcbiAgICAgICAgOiBkZWZhdWx0TGFuZ3VhZ2VcblxuICAgIGNvbnN0IGhpZ2hsaWdodGVkSHRtbCA9IGhpZ2hsaWdodCh7XG4gICAgICBmaWxlQ29udGVudHM6IGNvZGVCbG9jay5pbm5lclRleHQsXG4gICAgICBzY29wZU5hbWU6IHNjb3BlRm9yRmVuY2VOYW1lKGZlbmNlTmFtZSksXG4gICAgICBuYnNwOiBmYWxzZSxcbiAgICAgIGxpbmVEaXZzOiBmYWxzZSxcbiAgICAgIGVkaXRvckRpdjogdHJ1ZSxcbiAgICAgIGVkaXRvckRpdlRhZzogXCJwcmVcIixcbiAgICAgIC8vIFRoZSBgZWRpdG9yYCBjbGFzcyBtZXNzZXMgdGhpbmdzIHVwIGFzIGAuZWRpdG9yYCBoYXMgYWJzb2x1dGVseSBwb3NpdGlvbmVkIGxpbmVzXG4gICAgICBlZGl0b3JEaXZDbGFzczogZmVuY2VOYW1lXG4gICAgICAgID8gYGVkaXRvci1jb2xvcnMgbGFuZy0ke2ZlbmNlTmFtZX1gXG4gICAgICAgIDogXCJlZGl0b3ItY29sb3JzXCJcbiAgICB9KVxuXG4gICAgcmV0dXJuIChwcmVFbGVtZW50Lm91dGVySFRNTCA9IGhpZ2hsaWdodGVkSHRtbClcbiAgfSlcblxuICByZXR1cm4gZG9jLmlubmVySFRNTFxufVxuXG5mdW5jdGlvbiBfX2d1YXJkX18odmFsdWUsIHRyYW5zZm9ybSkge1xuICByZXR1cm4gdHlwZW9mIHZhbHVlICE9PSBcInVuZGVmaW5lZFwiICYmIHZhbHVlICE9PSBudWxsXG4gICAgPyB0cmFuc2Zvcm0odmFsdWUpXG4gICAgOiB1bmRlZmluZWRcbn1cbiJdfQ==