"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const WrappedDomTree = require('./wrapped-dom-tree');
const MathJaxHelper = require('./mathjax-helper');
const renderer = require('./renderer');
class UpdatePreview {
    constructor(dom) {
        this.tree = new WrappedDomTree(dom, true);
        this.domFragment = document.createDocumentFragment();
    }
    update(domFragment, renderLaTeX) {
        prepareCodeBlocksForAtomEditors(domFragment);
        if (domFragment.isEqualNode(this.domFragment)) {
            return;
        }
        const firstTime = this.domFragment.childElementCount === 0;
        this.domFragment = domFragment.cloneNode(true);
        const newDom = document.createElement("div");
        newDom.className = "update-preview";
        newDom.appendChild(domFragment);
        const newTree = new WrappedDomTree(newDom);
        const r = this.tree.diffTo(newTree);
        newTree.removeSelf();
        if (firstTime) {
            r.possibleReplace = null;
            r.last = null;
        }
        if (renderLaTeX) {
            r.inserted = r.inserted.map(function (elm) {
                while (elm && !elm.innerHTML) {
                    elm = elm.parentElement;
                }
                return elm;
            });
            r.inserted = r.inserted.filter(elm => !!elm);
            MathJaxHelper.mathProcessor(r.inserted);
        }
        if (!atom.config.get('markdown-preview-plus.enablePandoc')
            || !atom.config.get('markdown-preview-plus.useNativePandocCodeStyles')) {
            for (let elm of Array.from(r.inserted)) {
                if (elm instanceof Element) {
                    renderer.convertCodeBlocksToAtomEditors(elm);
                }
            }
        }
        this.updateOrderedListsStart();
        return r;
    }
    updateOrderedListsStart() {
        const previewOLs = this.tree.shownTree.dom.querySelectorAll('ol');
        const parsedOLs = this.domFragment.querySelectorAll('ol');
        for (let i = 0, end = parsedOLs.length - 1; i <= end; i++) {
            const previewStart = previewOLs[i].getAttribute('start');
            const parsedStart = parsedOLs[i].getAttribute('start');
            if (previewStart === parsedStart) {
                continue;
            }
            else if (parsedStart != null) {
                previewOLs[i].setAttribute('start', parsedStart);
            }
            else {
                previewOLs[i].removeAttribute('start');
            }
        }
    }
}
exports.UpdatePreview = UpdatePreview;
function prepareCodeBlocksForAtomEditors(domFragment) {
    for (let preElement of Array.from(domFragment.querySelectorAll('pre'))) {
        const preWrapper = document.createElement('span');
        preWrapper.className = 'atom-text-editor';
        preElement.parentNode.insertBefore(preWrapper, preElement);
        preWrapper.appendChild(preElement);
    }
    return domFragment;
}
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBkYXRlLXByZXZpZXcuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvdXBkYXRlLXByZXZpZXcudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBNkJBLFlBQVksQ0FBQzs7QUFFYixNQUFNLGNBQWMsR0FBSSxPQUFPLENBQUMsb0JBQW9CLENBQUMsQ0FBQztBQUN0RCxNQUFNLGFBQWEsR0FBSyxPQUFPLENBQUMsa0JBQWtCLENBQUMsQ0FBQztBQUNwRCxNQUFNLFFBQVEsR0FBVSxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7QUFFOUM7SUFHRSxZQUFZLEdBQUc7UUFDYixJQUFJLENBQUMsSUFBSSxHQUFXLElBQUksY0FBYyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUNsRCxJQUFJLENBQUMsV0FBVyxHQUFJLFFBQVEsQ0FBQyxzQkFBc0IsRUFBRSxDQUFDO0lBQ3hELENBQUM7SUFFRCxNQUFNLENBQUMsV0FBVyxFQUFFLFdBQVc7UUFDN0IsK0JBQStCLENBQUMsV0FBVyxDQUFDLENBQUM7UUFFN0MsRUFBRSxDQUFDLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzlDLE1BQU0sQ0FBQztRQUNULENBQUM7UUFFRCxNQUFNLFNBQVMsR0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDLGlCQUFpQixLQUFLLENBQUMsQ0FBQztRQUMvRCxJQUFJLENBQUMsV0FBVyxHQUFJLFdBQVcsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFaEQsTUFBTSxNQUFNLEdBQWMsUUFBUSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN4RCxNQUFNLENBQUMsU0FBUyxHQUFJLGdCQUFnQixDQUFDO1FBQ3JDLE1BQU0sQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDaEMsTUFBTSxPQUFPLEdBQWEsSUFBSSxjQUFjLENBQUMsTUFBTSxDQUFDLENBQUM7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LENBQUM7SUFFSCxDQUFDO0NBQ0Y7QUExRUQsc0NBMEVDO0FBRUQseUNBQXlDLFdBQVc7SUFDbEQsR0FBRyxDQUFDLENBQUMsSUFBSSxVQUFVLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDdkUsTUFBTSxVQUFVLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUNsRCxVQUFVLENBQUMsU0FBUyxHQUFHLGtCQUFrQixDQUFDO1FBQzFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDLFVBQVUsRUFBRSxVQUFVLENBQUMsQ0FBQztRQUMzRCxVQUFVLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ3JDLENBQUM7SUFDRCxNQUFNLENBQUMsV0FBVyxDQUFDO0FBQ3JCLENBQUM7QUFBQSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIGRlY2FmZmVpbmF0ZSBzdWdnZXN0aW9uczpcbiAqIERTMTAxOiBSZW1vdmUgdW5uZWNlc3NhcnkgdXNlIG9mIEFycmF5LmZyb21cbiAqIERTMTAyOiBSZW1vdmUgdW5uZWNlc3NhcnkgY29kZSBjcmVhdGVkIGJlY2F1c2Ugb2YgaW1wbGljaXQgcmV0dXJuc1xuICogRFMyMDc6IENvbnNpZGVyIHNob3J0ZXIgdmFyaWF0aW9ucyBvZiBudWxsIGNoZWNrc1xuICogRnVsbCBkb2NzOiBodHRwczovL2dpdGh1Yi5jb20vZGVjYWZmZWluYXRlL2RlY2FmZmVpbmF0ZS9ibG9iL21hc3Rlci9kb2NzL3N1Z2dlc3Rpb25zLm1kXG4gKi9cbi8vIFRoaXMgZmlsZSBpbmNvcnBvcmF0ZXMgY29kZSBmcm9tIFttYXJrbW9uXShodHRwczovL2dpdGh1Yi5jb20veXlqaGFvL21hcmttb24pXG4vLyBjb3ZlcmVkIGJ5IHRoZSBmb2xsb3dpbmcgdGVybXM6XG4vL1xuLy8gQ29weXJpZ2h0IChjKSAyMDE0LCBZYW8gWXVqaWFuLCBodHRwOi8veWp5YW8uY29tXG4vL1xuLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weVxuLy8gb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgXCJTb2Z0d2FyZVwiKSwgdG8gZGVhbFxuLy8gaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0c1xuLy8gdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbFxuLy8gY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzXG4vLyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOlxuLy9cbi8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluXG4vLyBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS5cbi8vXG4vLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgXCJBUyBJU1wiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SXG4vLyBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSxcbi8vIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRVxuLy8gQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUlxuLy8gTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSxcbi8vIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU5cbi8vIFRIRSBTT0ZUV0FSRS5cblwidXNlIHN0cmljdFwiO1xuXG5jb25zdCBXcmFwcGVkRG9tVHJlZSAgPSByZXF1aXJlKCcuL3dyYXBwZWQtZG9tLXRyZWUnKTtcbmNvbnN0IE1hdGhKYXhIZWxwZXIgICA9IHJlcXVpcmUoJy4vbWF0aGpheC1oZWxwZXInKTtcbmNvbnN0IHJlbmRlcmVyICAgICAgICA9IHJlcXVpcmUoJy4vcmVuZGVyZXInKTtcblxuZXhwb3J0IGNsYXNzIFVwZGF0ZVByZXZpZXcge1xuICAvLyBAcGFyYW0gZG9tIEEgRE9NIGVsZW1lbnQgb2JqZWN0XG4gIC8vICAgIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0FQSS9lbGVtZW50XG4gIGNvbnN0cnVjdG9yKGRvbSkge1xuICAgIHRoaXMudHJlZSAgICAgICAgID0gbmV3IFdyYXBwZWREb21UcmVlKGRvbSwgdHJ1ZSk7XG4gICAgdGhpcy5kb21GcmFnbWVudCAgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7XG4gIH1cblxuICB1cGRhdGUoZG9tRnJhZ21lbnQsIHJlbmRlckxhVGVYKSB7XG4gICAgcHJlcGFyZUNvZGVCbG9ja3NGb3JBdG9tRWRpdG9ycyhkb21GcmFnbWVudCk7XG5cbiAgICBpZiAoZG9tRnJhZ21lbnQuaXNFcXVhbE5vZGUodGhpcy5kb21GcmFnbWVudCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBmaXJzdFRpbWUgICAgID0gdGhpcy5kb21GcmFnbWVudC5jaGlsZEVsZW1lbnRDb3VudCA9PT0gMDtcbiAgICB0aGlzLmRvbUZyYWdtZW50ICA9IGRvbUZyYWdtZW50LmNsb25lTm9kZSh0cnVlKTtcblxuICAgIGNvbnN0IG5ld0RvbSAgICAgICAgICAgID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcbiAgICBuZXdEb20uY2xhc3NOYW1lICA9IFwidXBkYXRlLXByZXZpZXdcIjtcbiAgICBuZXdEb20uYXBwZW5kQ2hpbGQoZG9tRnJhZ21lbnQpO1xuICAgIGNvbnN0IG5ld1RyZWUgICAgICAgICAgID0gbmV3IFdyYXBwZWREb21UcmVlKG5ld0RvbSk7XG5cbiAgICBjb25zdCByID0gdGhpcy50cmVlLmRpZmZUbyhuZXdUcmVlKTtcbiAgICBuZXdUcmVlLnJlbW92ZVNlbGYoKTtcblxuICAgIGlmIChmaXJzdFRpbWUpIHtcbiAgICAgIHIucG9zc2libGVSZXBsYWNlID0gbnVsbDtcbiAgICAgIHIubGFzdCAgICAgICAgICAgID0gbnVsbDtcbiAgICB9XG5cbiAgICBpZiAocmVuZGVyTGFUZVgpIHtcbiAgICAgIHIuaW5zZXJ0ZWQgPSByLmluc2VydGVkLm1hcChmdW5jdGlvbihlbG0pIHtcbiAgICAgICAgd2hpbGUgKGVsbSAmJiAhZWxtLmlubmVySFRNTCkge1xuICAgICAgICAgIGVsbSA9IGVsbS5wYXJlbnRFbGVtZW50O1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBlbG07XG4gICAgICB9KTtcbiAgICAgIHIuaW5zZXJ0ZWQgPSByLmluc2VydGVkLmZpbHRlcihlbG0gPT4gISFlbG0pO1xuICAgICAgTWF0aEpheEhlbHBlci5tYXRoUHJvY2Vzc29yKHIuaW5zZXJ0ZWQpO1xuICAgIH1cblxuICAgIGlmICghYXRvbS5jb25maWcuZ2V0KCdtYXJrZG93bi1wcmV2aWV3LXBsdXMuZW5hYmxlUGFuZG9jJylcbiAgICAgICAgfHwgIWF0b20uY29uZmlnLmdldCgnbWFya2Rvd24tcHJldmlldy1wbHVzLnVzZU5hdGl2ZVBhbmRvY0NvZGVTdHlsZXMnKSkge1xuICAgICAgZm9yIChsZXQgZWxtIG9mIEFycmF5LmZyb20oci5pbnNlcnRlZCkpIHtcbiAgICAgICAgaWYgKGVsbSBpbnN0YW5jZW9mIEVsZW1lbnQpIHtcbiAgICAgICAgICByZW5kZXJlci5jb252ZXJ0Q29kZUJsb2Nrc1RvQXRvbUVkaXRvcnMoZWxtKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIHRoaXMudXBkYXRlT3JkZXJlZExpc3RzU3RhcnQoKTtcblxuICAgIHJldHVybiByO1xuICB9XG5cbiAgdXBkYXRlT3JkZXJlZExpc3RzU3RhcnQoKSB7XG4gICAgY29uc3QgcHJldmlld09McyA9IHRoaXMudHJlZS5zaG93blRyZWUuZG9tLnF1ZXJ5U2VsZWN0b3JBbGwoJ29sJyk7XG4gICAgY29uc3QgcGFyc2VkT0xzICA9IHRoaXMuZG9tRnJhZ21lbnQucXVlcnlTZWxlY3RvckFsbCgnb2wnKTtcblxuICAgIGZvciAobGV0IGkgPSAwLCBlbmQgPSBwYXJzZWRPTHMubGVuZ3RoLTE7IGkgPD0gZW5kOyBpKyspIHtcbiAgICAgIGNvbnN0IHByZXZpZXdTdGFydCAgPSBwcmV2aWV3T0xzW2ldLmdldEF0dHJpYnV0ZSgnc3RhcnQnKTtcbiAgICAgIGNvbnN0IHBhcnNlZFN0YXJ0ICAgPSBwYXJzZWRPTHNbaV0uZ2V0QXR0cmlidXRlKCdzdGFydCcpO1xuXG4gICAgICBpZiAocHJldmlld1N0YXJ0ID09PSBwYXJzZWRTdGFydCkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH0gZWxzZSBpZiAocGFyc2VkU3RhcnQgIT0gbnVsbCkge1xuICAgICAgICBwcmV2aWV3T0xzW2ldLnNldEF0dHJpYnV0ZSgnc3RhcnQnLCBwYXJzZWRTdGFydCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBwcmV2aWV3T0xzW2ldLnJlbW92ZUF0dHJpYnV0ZSgnc3RhcnQnKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgfVxufVxuXG5mdW5jdGlvbiBwcmVwYXJlQ29kZUJsb2Nrc0ZvckF0b21FZGl0b3JzKGRvbUZyYWdtZW50KSB7XG4gIGZvciAobGV0IHByZUVsZW1lbnQgb2YgQXJyYXkuZnJvbShkb21GcmFnbWVudC5xdWVyeVNlbGVjdG9yQWxsKCdwcmUnKSkpIHtcbiAgICBjb25zdCBwcmVXcmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpO1xuICAgIHByZVdyYXBwZXIuY2xhc3NOYW1lID0gJ2F0b20tdGV4dC1lZGl0b3InO1xuICAgIHByZUVsZW1lbnQucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUocHJlV3JhcHBlciwgcHJlRWxlbWVudCk7XG4gICAgcHJlV3JhcHBlci5hcHBlbmRDaGlsZChwcmVFbGVtZW50KTtcbiAgfVxuICByZXR1cm4gZG9tRnJhZ21lbnQ7XG59O1xuIl19