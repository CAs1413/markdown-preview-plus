"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const wrapped_dom_tree_1 = require("./wrapped-dom-tree");
const MathJaxHelper = require("./mathjax-helper");
const renderer = require("./renderer");
const util_1 = require("./util");
class UpdatePreview {
    constructor(dom) {
        this.tree = new wrapped_dom_tree_1.WrappedDomTree(dom, true);
    }
    update(frame, domFragment, renderLaTeX) {
        prepareCodeBlocksForAtomEditors(frame.contentDocument, domFragment);
        if (this.domFragment && domFragment.isEqualNode(this.domFragment)) {
            return undefined;
        }
        const firstTime = this.domFragment === undefined;
        this.domFragment = domFragment.cloneNode(true);
        const newDom = frame.contentDocument.createElement('div');
        newDom.className = 'update-preview';
        newDom.appendChild(domFragment);
        const newTree = new wrapped_dom_tree_1.WrappedDomTree(newDom, false);
        const r = this.tree.diffTo(newTree);
        newTree.removeSelf();
        if (firstTime) {
            r.possibleReplace = undefined;
            r.last = undefined;
        }
        r.inserted = r.inserted.filter((elm) => elm.nodeType === Node.ELEMENT_NODE);
        if (renderLaTeX) {
            if (firstTime) {
                util_1.handlePromise(MathJaxHelper.mathProcessor(frame, [frame.contentDocument.body]));
            }
            else {
                util_1.handlePromise(MathJaxHelper.mathProcessor(frame, r.inserted));
            }
        }
        if (!atom.config.get('markdown-preview-plus.enablePandoc') ||
            !atom.config.get('markdown-preview-plus.useNativePandocCodeStyles')) {
            for (const elm of r.inserted) {
                renderer.highlightCodeBlocks(elm);
            }
        }
        this.updateOrderedListsStart(this.domFragment);
        return r;
    }
    updateOrderedListsStart(fragment) {
        if (this.tree.shownTree === undefined) {
            throw new Error('shownTree undefined in updateOrderedListsStart');
        }
        if (!util_1.isElement(this.tree.shownTree.dom)) {
            throw new Error('this.tree.shownTree.dom is not an Element in updateOrderedListsStart');
        }
        const previewOLs = this.tree.shownTree.dom.querySelectorAll('ol');
        const parsedOLs = fragment.querySelectorAll('ol');
        const end = parsedOLs.length - 1;
        for (let i = 0; i <= end; i++) {
            const previewStart = previewOLs[i].getAttribute('start');
            const parsedStart = parsedOLs[i].getAttribute('start');
            if (previewStart === parsedStart) {
                continue;
            }
            else if (parsedStart !== null) {
                previewOLs[i].setAttribute('start', parsedStart);
            }
            else {
                previewOLs[i].removeAttribute('start');
            }
        }
    }
}
exports.UpdatePreview = UpdatePreview;
function prepareCodeBlocksForAtomEditors(document, domFragment) {
    for (const preElement of Array.from(domFragment.querySelectorAll('pre'))) {
        const preWrapper = document.createElement('span');
        preWrapper.className = 'atom-text-editor';
        preElement.parentNode.insertBefore(preWrapper, preElement);
        preWrapper.appendChild(preElement);
    }
    return domFragment;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBkYXRlLXByZXZpZXcuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvdXBkYXRlLXByZXZpZXcudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFzQkEseURBQW1EO0FBQ25ELGtEQUFrRDtBQUNsRCx1Q0FBdUM7QUFDdkMsaUNBQWlEO0FBRWpEO0lBS0UsWUFBWSxHQUFZO1FBQ3RCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxpQ0FBYyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQTtJQUMzQyxDQUFDO0lBRU0sTUFBTSxDQUNYLEtBQXdCLEVBQ3hCLFdBQTZCLEVBQzdCLFdBQW9CO1FBRXBCLCtCQUErQixDQUFDLEtBQUssQ0FBQyxlQUFlLEVBQUUsV0FBVyxDQUFDLENBQUE7UUFFbkUsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsSUFBSSxXQUFXLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbEUsTUFBTSxDQUFDLFNBQVMsQ0FBQTtRQUNsQixDQUFDO1FBRUQsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLFdBQVcsS0FBSyxTQUFTLENBQUE7UUFDaEQsSUFBSSxDQUFDLFdBQVcsR0FBRyxXQUFXLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBcUIsQ0FBQTtRQUVsRSxNQUFNLE1BQU0sR0FBRyxLQUFLLENBQUMsZUFBZSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUN6RCxNQUFNLENBQUMsU0FBUyxHQUFHLGdCQUFnQixDQUFBO1FBQ25DLE1BQU0sQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLENBQUE7UUFDL0IsTUFBTSxPQUFPLEdBQUcsSUFBSSxpQ0FBYyxDQUFDLE1BQU0sRUFBRSxLQUFLLENBQUMsQ0FBQTtRQUVqRCxNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQTtRQUNuQyxPQUFPLENB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Q0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLE9BQU8sRUFBRSxXQUFXLENBQUMsQ0FBQTtZQUNsRCxDQUFDO1lBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ04sVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsQ0FBQTtZQUN4QyxDQUFDO1FBQ0gsQ0FBQztJQUNILENBQUM7Q0FDRjtBQXpGRCxzQ0F5RkM7QUFFRCx5Q0FDRSxRQUFzQixFQUN0QixXQUE2QjtJQUU3QixHQUFHLENBQUMsQ0FBQyxNQUFNLFVBQVUsSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN6RSxNQUFNLFVBQVUsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBQ2pELFVBQVUsQ0FBQyxTQUFTLEdBQUcsa0JBQWtCLENBQUE7UUFDekMsVUFBVSxDQUFDLFVBQVcsQ0FBQyxZQUFZLENBQUMsVUFBVSxFQUFFLFVBQVUsQ0FBQyxDQUFBO1FBQzNELFVBQVUsQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDLENBQUE7SUFDcEMsQ0FBQztJQUNELE1BQU0sQ0FBQyxXQUFXLENBQUE7QUFDcEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIFRoaXMgZmlsZSBpbmNvcnBvcmF0ZXMgY29kZSBmcm9tIFttYXJrbW9uXShodHRwczovL2dpdGh1Yi5jb20veXlqaGFvL21hcmttb24pXG4vLyBjb3ZlcmVkIGJ5IHRoZSBmb2xsb3dpbmcgdGVybXM6XG4vL1xuLy8gQ29weXJpZ2h0IChjKSAyMDE0LCBZYW8gWXVqaWFuLCBodHRwOi8veWp5YW8uY29tXG4vL1xuLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weVxuLy8gb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgXCJTb2Z0d2FyZVwiKSwgdG8gZGVhbFxuLy8gaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0c1xuLy8gdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbFxuLy8gY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzXG4vLyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOlxuLy9cbi8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluXG4vLyBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS5cbi8vXG4vLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgXCJBUyBJU1wiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SXG4vLyBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSxcbi8vIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRVxuLy8gQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUlxuLy8gTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSxcbi8vIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU5cbi8vIFRIRSBTT0ZUV0FSRS5cbmltcG9ydCB7IFdyYXBwZWREb21UcmVlIH0gZnJvbSAnLi93cmFwcGVkLWRvbS10cmVlJ1xuaW1wb3J0IE1hdGhKYXhIZWxwZXIgPSByZXF1aXJlKCcuL21hdGhqYXgtaGVscGVyJylcbmltcG9ydCByZW5kZXJlciA9IHJlcXVpcmUoJy4vcmVuZGVyZXInKVxuaW1wb3J0IHsgaGFuZGxlUHJvbWlzZSwgaXNFbGVtZW50IH0gZnJvbSAnLi91dGlsJ1xuXG5leHBvcnQgY2xhc3MgVXBkYXRlUHJldmlldyB7XG4gIHByaXZhdGUgZG9tRnJhZ21lbnQ/OiBEb2N1bWVudEZyYWdtZW50XG4gIHByaXZhdGUgdHJlZTogV3JhcHBlZERvbVRyZWVcbiAgLy8gQHBhcmFtIGRvbSBBIERPTSBlbGVtZW50IG9iamVjdFxuICAvLyAgICBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvZWxlbWVudFxuICBjb25zdHJ1Y3Rvcihkb206IEVsZW1lbnQpIHtcbiAgICB0aGlzLnRyZWUgPSBuZXcgV3JhcHBlZERvbVRyZWUoZG9tLCB0cnVlKVxuICB9XG5cbiAgcHVibGljIHVwZGF0ZShcbiAgICBmcmFtZTogSFRNTElGcmFtZUVsZW1lbnQsXG4gICAgZG9tRnJhZ21lbnQ6IERvY3VtZW50RnJhZ21lbnQsXG4gICAgcmVuZGVyTGFUZVg6IGJvb2xlYW4sXG4gICkge1xuICAgIHByZXBhcmVDb2RlQmxvY2tzRm9yQXRvbUVkaXRvcnMoZnJhbWUuY29udGVudERvY3VtZW50LCBkb21GcmFnbWVudClcblxuICAgIGlmICh0aGlzLmRvbUZyYWdtZW50ICYmIGRvbUZyYWdtZW50LmlzRXF1YWxOb2RlKHRoaXMuZG9tRnJhZ21lbnQpKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkXG4gICAgfVxuXG4gICAgY29uc3QgZmlyc3RUaW1lID0gdGhpcy5kb21GcmFnbWVudCA9PT0gdW5kZWZpbmVkXG4gICAgdGhpcy5kb21GcmFnbWVudCA9IGRvbUZyYWdtZW50LmNsb25lTm9kZSh0cnVlKSBhcyBEb2N1bWVudEZyYWdtZW50XG5cbiAgICBjb25zdCBuZXdEb20gPSBmcmFtZS5jb250ZW50RG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JylcbiAgICBuZXdEb20uY2xhc3NOYW1lID0gJ3VwZGF0ZS1wcmV2aWV3J1xuICAgIG5ld0RvbS5hcHBlbmRDaGlsZChkb21GcmFnbWVudClcbiAgICBjb25zdCBuZXdUcmVlID0gbmV3IFdyYXBwZWREb21UcmVlKG5ld0RvbSwgZmFsc2UpXG5cbiAgICBjb25zdCByID0gdGhpcy50cmVlLmRpZmZUbyhuZXdUcmVlKVxuICAgIG5ld1RyZWUucmVtb3ZlU2VsZigpXG5cbiAgICBpZiAoZmlyc3RUaW1lKSB7XG4gICAgICByLnBvc3NpYmxlUmVwbGFjZSA9IHVuZGVmaW5lZFxuICAgICAgci5sYXN0ID0gdW5kZWZpbmVkXG4gICAgfVxuXG4gICAgci5pbnNlcnRlZCA9IHIuaW5zZXJ0ZWQuZmlsdGVyKChlbG0pID0+IGVsbS5ub2RlVHlwZSA9PT0gTm9kZS5FTEVNRU5UX05PREUpXG5cbiAgICBpZiAocmVuZGVyTGFUZVgpIHtcbiAgICAgIGlmIChmaXJzdFRpbWUpIHtcbiAgICAgICAgaGFuZGxlUHJvbWlzZShcbiAgICAgICAgICBNYXRoSmF4SGVscGVyLm1hdGhQcm9jZXNzb3IoZnJhbWUsIFtmcmFtZS5jb250ZW50RG9jdW1lbnQuYm9keV0pLFxuICAgICAgICApXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBoYW5kbGVQcm9taXNlKE1hdGhKYXhIZWxwZXIubWF0aFByb2Nlc3NvcihmcmFtZSwgci5pbnNlcnRlZCkpXG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKFxuICAgICAgIWF0b20uY29uZmlnLmdldCgnbWFya2Rvd24tcHJldmlldy1wbHVzLmVuYWJsZVBhbmRvYycpIHx8XG4gICAgICAhYXRvbS5jb25maWcuZ2V0KCdtYXJrZG93bi1wcmV2aWV3LXBsdXMudXNlTmF0aXZlUGFuZG9jQ29kZVN0eWxlcycpXG4gICAgKSB7XG4gICAgICBmb3IgKGNvbnN0IGVsbSBvZiByLmluc2VydGVkKSB7XG4gICAgICAgIC8vIE5PVEU6IGZpbHRlcmVkIGFib3ZlXG4gICAgICAgIHJlbmRlcmVyLmhpZ2hsaWdodENvZGVCbG9ja3MoZWxtIGFzIEVsZW1lbnQpXG4gICAgICB9XG4gICAgfVxuXG4gICAgdGhpcy51cGRhdGVPcmRlcmVkTGlzdHNTdGFydCh0aGlzLmRvbUZyYWdtZW50KVxuXG4gICAgcmV0dXJuIHJcbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlT3JkZXJlZExpc3RzU3RhcnQoZnJhZ21lbnQ6IERvY3VtZW50RnJhZ21lbnQpIHtcbiAgICBpZiAodGhpcy50cmVlLnNob3duVHJlZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ3Nob3duVHJlZSB1bmRlZmluZWQgaW4gdXBkYXRlT3JkZXJlZExpc3RzU3RhcnQnKVxuICAgIH1cbiAgICBpZiAoIWlzRWxlbWVudCh0aGlzLnRyZWUuc2hvd25UcmVlLmRvbSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgJ3RoaXMudHJlZS5zaG93blRyZWUuZG9tIGlzIG5vdCBhbiBFbGVtZW50IGluIHVwZGF0ZU9yZGVyZWRMaXN0c1N0YXJ0JyxcbiAgICAgIClcbiAgICB9XG4gICAgY29uc3QgcHJldmlld09McyA9IHRoaXMudHJlZS5zaG93blRyZWUuZG9tLnF1ZXJ5U2VsZWN0b3JBbGwoJ29sJylcbiAgICBjb25zdCBwYXJzZWRPTHMgPSBmcmFnbWVudC5xdWVyeVNlbGVjdG9yQWxsKCdvbCcpXG5cbiAgICBjb25zdCBlbmQgPSBwYXJzZWRPTHMubGVuZ3RoIC0gMVxuICAgIGZvciAobGV0IGkgPSAwOyBpIDw9IGVuZDsgaSsrKSB7XG4gICAgICBjb25zdCBwcmV2aWV3U3RhcnQgPSBwcmV2aWV3T0xzW2ldLmdldEF0dHJpYnV0ZSgnc3RhcnQnKVxuICAgICAgY29uc3QgcGFyc2VkU3RhcnQgPSBwYXJzZWRPTHNbaV0uZ2V0QXR0cmlidXRlKCdzdGFydCcpXG5cbiAgICAgIGlmIChwcmV2aWV3U3RhcnQgPT09IHBhcnNlZFN0YXJ0KSB7XG4gICAgICAgIGNvbnRpbnVlXG4gICAgICB9IGVsc2UgaWYgKHBhcnNlZFN0YXJ0ICE9PSBudWxsKSB7XG4gICAgICAgIHByZXZpZXdPTHNbaV0uc2V0QXR0cmlidXRlKCdzdGFydCcsIHBhcnNlZFN0YXJ0KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcHJldmlld09Mc1tpXS5yZW1vdmVBdHRyaWJ1dGUoJ3N0YXJ0JylcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gcHJlcGFyZUNvZGVCbG9ja3NGb3JBdG9tRWRpdG9ycyhcbiAgZG9jdW1lbnQ6IEhUTUxEb2N1bWVudCxcbiAgZG9tRnJhZ21lbnQ6IERvY3VtZW50RnJhZ21lbnQsXG4pIHtcbiAgZm9yIChjb25zdCBwcmVFbGVtZW50IG9mIEFycmF5LmZyb20oZG9tRnJhZ21lbnQucXVlcnlTZWxlY3RvckFsbCgncHJlJykpKSB7XG4gICAgY29uc3QgcHJlV3JhcHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKVxuICAgIHByZVdyYXBwZXIuY2xhc3NOYW1lID0gJ2F0b20tdGV4dC1lZGl0b3InXG4gICAgcHJlRWxlbWVudC5wYXJlbnROb2RlIS5pbnNlcnRCZWZvcmUocHJlV3JhcHBlciwgcHJlRWxlbWVudClcbiAgICBwcmVXcmFwcGVyLmFwcGVuZENoaWxkKHByZUVsZW1lbnQpXG4gIH1cbiAgcmV0dXJuIGRvbUZyYWdtZW50XG59XG4iXX0=