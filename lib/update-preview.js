"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const WrappedDomTree = require("./wrapped-dom-tree");
const MathJaxHelper = require("./mathjax-helper");
const renderer = require("./renderer");
class UpdatePreview {
    constructor(dom) {
        this.tree = new WrappedDomTree(dom, true);
        this.domFragment = document.createDocumentFragment();
    }
    update(domFragment, renderLaTeX) {
        prepareCodeBlocksForAtomEditors(domFragment);
        if (domFragment.isEqualNode(this.domFragment)) {
            return;
        }
        const firstTime = this.domFragment.childElementCount === 0;
        this.domFragment = domFragment.cloneNode(true);
        const newDom = document.createElement("div");
        newDom.className = "update-preview";
        newDom.appendChild(domFragment);
        const newTree = new WrappedDomTree(newDom);
        const r = this.tree.diffTo(newTree);
        newTree.removeSelf();
        if (firstTime) {
            r.possibleReplace = null;
            r.last = null;
        }
        if (renderLaTeX) {
            r.inserted = r.inserted.map(function (elm) {
                while (elm && !elm.innerHTML) {
                    elm = elm.parentElement;
                }
                return elm;
            });
            r.inserted = r.inserted.filter(elm => !!elm);
            MathJaxHelper.mathProcessor(r.inserted);
        }
        if (!atom.config.get("markdown-preview-plus.enablePandoc") ||
            !atom.config.get("markdown-preview-plus.useNativePandocCodeStyles")) {
            for (let elm of Array.from(r.inserted)) {
                if (elm instanceof Element) {
                    renderer.convertCodeBlocksToAtomEditors(elm);
                }
            }
        }
        this.updateOrderedListsStart();
        return r;
    }
    updateOrderedListsStart() {
        const previewOLs = this.tree.shownTree.dom.querySelectorAll("ol");
        const parsedOLs = this.domFragment.querySelectorAll("ol");
        for (let i = 0, end = parsedOLs.length - 1; i <= end; i++) {
            const previewStart = previewOLs[i].getAttribute("start");
            const parsedStart = parsedOLs[i].getAttribute("start");
            if (previewStart === parsedStart) {
                continue;
            }
            else if (parsedStart != null) {
                previewOLs[i].setAttribute("start", parsedStart);
            }
            else {
                previewOLs[i].removeAttribute("start");
            }
        }
    }
}
exports.UpdatePreview = UpdatePreview;
function prepareCodeBlocksForAtomEditors(domFragment) {
    for (let preElement of Array.from(domFragment.querySelectorAll("pre"))) {
        const preWrapper = document.createElement("span");
        preWrapper.className = "atom-text-editor";
        preElement.parentNode.insertBefore(preWrapper, preElement);
        preWrapper.appendChild(preElement);
    }
    return domFragment;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBkYXRlLXByZXZpZXcuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvdXBkYXRlLXByZXZpZXcudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBNkJBLFlBQVksQ0FBQTs7QUFFWixNQUFNLGNBQWMsR0FBRyxPQUFPLENBQUMsb0JBQW9CLENBQUMsQ0FBQTtBQUNwRCxNQUFNLGFBQWEsR0FBRyxPQUFPLENBQUMsa0JBQWtCLENBQUMsQ0FBQTtBQUNqRCxNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUE7QUFFdEM7SUFHRSxZQUFZLEdBQUc7UUFDYixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksY0FBYyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQTtRQUN6QyxJQUFJLENBQUMsV0FBVyxHQUFHLFFBQVEsQ0FBQyxzQkFBc0IsRUFBRSxDQUFBO0lBQ3RELENBQUM7SUFFRCxNQUFNLENBQUMsV0FBVyxFQUFFLFdBQVc7UUFDN0IsK0JBQStCLENBQUMsV0FBVyxDQUFDLENBQUE7UUFFNUMsRUFBRSxDQUFDLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzlDLE1BQU0sQ0FBQTtRQUNSLENBQUM7UUFFRCxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLGlCQUFpQixLQUFLLENBQUMsQ0FBQTtRQUMxRCxJQUFJLENBQUMsV0FBVyxHQUFHLFdBQVcsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUE7UUFFOUMsTUFBTSxNQUFNLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUM1QyxNQUFNLENBQUMsU0FBUyxHQUFHLGdCQUFnQixDQUFBO1FBQ25DLE1BQU0sQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLENBQUE7UUFDL0IsTUFBTSxPQUFPLEdBQUcsSUFBSSxjQUFjLENBQUMsTUFBTSxDQUFDLENBQUE7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Q0FBQztJQUNILENBQUM7Q0FDRjtBQTNFRCxzQ0EyRUM7QUFFRCx5Q0FBeUMsV0FBVztJQUNsRCxHQUFHLENBQUMsQ0FBQyxJQUFJLFVBQVUsSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN2RSxNQUFNLFVBQVUsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBQ2pELFVBQVUsQ0FBQyxTQUFTLEdBQUcsa0JBQWtCLENBQUE7UUFDekMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsVUFBVSxFQUFFLFVBQVUsQ0FBQyxDQUFBO1FBQzFELFVBQVUsQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDLENBQUE7SUFDcEMsQ0FBQztJQUNELE1BQU0sQ0FBQyxXQUFXLENBQUE7QUFDcEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBkZWNhZmZlaW5hdGUgc3VnZ2VzdGlvbnM6XG4gKiBEUzEwMTogUmVtb3ZlIHVubmVjZXNzYXJ5IHVzZSBvZiBBcnJheS5mcm9tXG4gKiBEUzEwMjogUmVtb3ZlIHVubmVjZXNzYXJ5IGNvZGUgY3JlYXRlZCBiZWNhdXNlIG9mIGltcGxpY2l0IHJldHVybnNcbiAqIERTMjA3OiBDb25zaWRlciBzaG9ydGVyIHZhcmlhdGlvbnMgb2YgbnVsbCBjaGVja3NcbiAqIEZ1bGwgZG9jczogaHR0cHM6Ly9naXRodWIuY29tL2RlY2FmZmVpbmF0ZS9kZWNhZmZlaW5hdGUvYmxvYi9tYXN0ZXIvZG9jcy9zdWdnZXN0aW9ucy5tZFxuICovXG4vLyBUaGlzIGZpbGUgaW5jb3Jwb3JhdGVzIGNvZGUgZnJvbSBbbWFya21vbl0oaHR0cHM6Ly9naXRodWIuY29tL3l5amhhby9tYXJrbW9uKVxuLy8gY292ZXJlZCBieSB0aGUgZm9sbG93aW5nIHRlcm1zOlxuLy9cbi8vIENvcHlyaWdodCAoYykgMjAxNCwgWWFvIFl1amlhbiwgaHR0cDovL3lqeWFvLmNvbVxuLy9cbi8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcbi8vIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlIFwiU29mdHdhcmVcIiksIHRvIGRlYWxcbi8vIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHNcbi8vIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGxcbi8vIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpc1xuLy8gZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczpcbi8vXG4vLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpblxuLy8gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuXG4vL1xuLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEIFwiQVMgSVNcIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUlxuLy8gSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksXG4vLyBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEVcbi8vIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVJcbi8vIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sXG4vLyBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOXG4vLyBUSEUgU09GVFdBUkUuXG5cInVzZSBzdHJpY3RcIlxuXG5jb25zdCBXcmFwcGVkRG9tVHJlZSA9IHJlcXVpcmUoXCIuL3dyYXBwZWQtZG9tLXRyZWVcIilcbmNvbnN0IE1hdGhKYXhIZWxwZXIgPSByZXF1aXJlKFwiLi9tYXRoamF4LWhlbHBlclwiKVxuY29uc3QgcmVuZGVyZXIgPSByZXF1aXJlKFwiLi9yZW5kZXJlclwiKVxuXG5leHBvcnQgY2xhc3MgVXBkYXRlUHJldmlldyB7XG4gIC8vIEBwYXJhbSBkb20gQSBET00gZWxlbWVudCBvYmplY3RcbiAgLy8gICAgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL2VsZW1lbnRcbiAgY29uc3RydWN0b3IoZG9tKSB7XG4gICAgdGhpcy50cmVlID0gbmV3IFdyYXBwZWREb21UcmVlKGRvbSwgdHJ1ZSlcbiAgICB0aGlzLmRvbUZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpXG4gIH1cblxuICB1cGRhdGUoZG9tRnJhZ21lbnQsIHJlbmRlckxhVGVYKSB7XG4gICAgcHJlcGFyZUNvZGVCbG9ja3NGb3JBdG9tRWRpdG9ycyhkb21GcmFnbWVudClcblxuICAgIGlmIChkb21GcmFnbWVudC5pc0VxdWFsTm9kZSh0aGlzLmRvbUZyYWdtZW50KSkge1xuICAgICAgcmV0dXJuXG4gICAgfVxuXG4gICAgY29uc3QgZmlyc3RUaW1lID0gdGhpcy5kb21GcmFnbWVudC5jaGlsZEVsZW1lbnRDb3VudCA9PT0gMFxuICAgIHRoaXMuZG9tRnJhZ21lbnQgPSBkb21GcmFnbWVudC5jbG9uZU5vZGUodHJ1ZSlcblxuICAgIGNvbnN0IG5ld0RvbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIilcbiAgICBuZXdEb20uY2xhc3NOYW1lID0gXCJ1cGRhdGUtcHJldmlld1wiXG4gICAgbmV3RG9tLmFwcGVuZENoaWxkKGRvbUZyYWdtZW50KVxuICAgIGNvbnN0IG5ld1RyZWUgPSBuZXcgV3JhcHBlZERvbVRyZWUobmV3RG9tKVxuXG4gICAgY29uc3QgciA9IHRoaXMudHJlZS5kaWZmVG8obmV3VHJlZSlcbiAgICBuZXdUcmVlLnJlbW92ZVNlbGYoKVxuXG4gICAgaWYgKGZpcnN0VGltZSkge1xuICAgICAgci5wb3NzaWJsZVJlcGxhY2UgPSBudWxsXG4gICAgICByLmxhc3QgPSBudWxsXG4gICAgfVxuXG4gICAgaWYgKHJlbmRlckxhVGVYKSB7XG4gICAgICByLmluc2VydGVkID0gci5pbnNlcnRlZC5tYXAoZnVuY3Rpb24oZWxtKSB7XG4gICAgICAgIHdoaWxlIChlbG0gJiYgIWVsbS5pbm5lckhUTUwpIHtcbiAgICAgICAgICBlbG0gPSBlbG0ucGFyZW50RWxlbWVudFxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBlbG1cbiAgICAgIH0pXG4gICAgICByLmluc2VydGVkID0gci5pbnNlcnRlZC5maWx0ZXIoZWxtID0+ICEhZWxtKVxuICAgICAgTWF0aEpheEhlbHBlci5tYXRoUHJvY2Vzc29yKHIuaW5zZXJ0ZWQpXG4gICAgfVxuXG4gICAgaWYgKFxuICAgICAgIWF0b20uY29uZmlnLmdldChcIm1hcmtkb3duLXByZXZpZXctcGx1cy5lbmFibGVQYW5kb2NcIikgfHxcbiAgICAgICFhdG9tLmNvbmZpZy5nZXQoXCJtYXJrZG93bi1wcmV2aWV3LXBsdXMudXNlTmF0aXZlUGFuZG9jQ29kZVN0eWxlc1wiKVxuICAgICkge1xuICAgICAgZm9yIChsZXQgZWxtIG9mIEFycmF5LmZyb20oci5pbnNlcnRlZCkpIHtcbiAgICAgICAgaWYgKGVsbSBpbnN0YW5jZW9mIEVsZW1lbnQpIHtcbiAgICAgICAgICByZW5kZXJlci5jb252ZXJ0Q29kZUJsb2Nrc1RvQXRvbUVkaXRvcnMoZWxtKVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgdGhpcy51cGRhdGVPcmRlcmVkTGlzdHNTdGFydCgpXG5cbiAgICByZXR1cm4gclxuICB9XG5cbiAgdXBkYXRlT3JkZXJlZExpc3RzU3RhcnQoKSB7XG4gICAgY29uc3QgcHJldmlld09McyA9IHRoaXMudHJlZS5zaG93blRyZWUuZG9tLnF1ZXJ5U2VsZWN0b3JBbGwoXCJvbFwiKVxuICAgIGNvbnN0IHBhcnNlZE9McyA9IHRoaXMuZG9tRnJhZ21lbnQucXVlcnlTZWxlY3RvckFsbChcIm9sXCIpXG5cbiAgICBmb3IgKGxldCBpID0gMCwgZW5kID0gcGFyc2VkT0xzLmxlbmd0aCAtIDE7IGkgPD0gZW5kOyBpKyspIHtcbiAgICAgIGNvbnN0IHByZXZpZXdTdGFydCA9IHByZXZpZXdPTHNbaV0uZ2V0QXR0cmlidXRlKFwic3RhcnRcIilcbiAgICAgIGNvbnN0IHBhcnNlZFN0YXJ0ID0gcGFyc2VkT0xzW2ldLmdldEF0dHJpYnV0ZShcInN0YXJ0XCIpXG5cbiAgICAgIGlmIChwcmV2aWV3U3RhcnQgPT09IHBhcnNlZFN0YXJ0KSB7XG4gICAgICAgIGNvbnRpbnVlXG4gICAgICB9IGVsc2UgaWYgKHBhcnNlZFN0YXJ0ICE9IG51bGwpIHtcbiAgICAgICAgcHJldmlld09Mc1tpXS5zZXRBdHRyaWJ1dGUoXCJzdGFydFwiLCBwYXJzZWRTdGFydClcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHByZXZpZXdPTHNbaV0ucmVtb3ZlQXR0cmlidXRlKFwic3RhcnRcIilcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gcHJlcGFyZUNvZGVCbG9ja3NGb3JBdG9tRWRpdG9ycyhkb21GcmFnbWVudCkge1xuICBmb3IgKGxldCBwcmVFbGVtZW50IG9mIEFycmF5LmZyb20oZG9tRnJhZ21lbnQucXVlcnlTZWxlY3RvckFsbChcInByZVwiKSkpIHtcbiAgICBjb25zdCBwcmVXcmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcInNwYW5cIilcbiAgICBwcmVXcmFwcGVyLmNsYXNzTmFtZSA9IFwiYXRvbS10ZXh0LWVkaXRvclwiXG4gICAgcHJlRWxlbWVudC5wYXJlbnROb2RlLmluc2VydEJlZm9yZShwcmVXcmFwcGVyLCBwcmVFbGVtZW50KVxuICAgIHByZVdyYXBwZXIuYXBwZW5kQ2hpbGQocHJlRWxlbWVudClcbiAgfVxuICByZXR1cm4gZG9tRnJhZ21lbnRcbn1cbiJdfQ==