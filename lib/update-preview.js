'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
const wrapped_dom_tree_1 = require("./wrapped-dom-tree");
const MathJaxHelper = require("./mathjax-helper");
const renderer = require("./renderer");
class UpdatePreview {
    constructor(dom) {
        this.tree = new wrapped_dom_tree_1.WrappedDomTree(dom, true);
    }
    update(domFragment, renderLaTeX) {
        prepareCodeBlocksForAtomEditors(domFragment);
        if (this.domFragment && domFragment.isEqualNode(this.domFragment)) {
            return undefined;
        }
        const firstTime = this.domFragment === undefined;
        this.domFragment = domFragment.cloneNode(true);
        const newDom = document.createElement('div');
        newDom.className = 'update-preview';
        newDom.appendChild(domFragment);
        const newTree = new wrapped_dom_tree_1.WrappedDomTree(newDom, false);
        const r = this.tree.diffTo(newTree);
        newTree.removeSelf();
        if (firstTime) {
            r.possibleReplace = undefined;
            r.last = undefined;
        }
        if (renderLaTeX) {
            r.inserted = r.inserted.map(function (elm) {
                while (elm.parentElement && !elm.innerHTML) {
                    elm = elm.parentElement;
                }
                return elm;
            });
            r.inserted = r.inserted.filter((elm) => !!elm);
            MathJaxHelper.mathProcessor(r.inserted);
        }
        if (!atom.config.get('markdown-preview-plus.enablePandoc') ||
            !atom.config.get('markdown-preview-plus.useNativePandocCodeStyles')) {
            for (const elm of Array.from(r.inserted)) {
                if (elm instanceof Element) {
                    renderer.convertCodeBlocksToAtomEditors(elm);
                }
            }
        }
        this.updateOrderedListsStart(this.domFragment);
        return r;
    }
    updateOrderedListsStart(fragment) {
        if (this.tree.shownTree === undefined) {
            throw new Error('shownTree undefined in updateOrderedListsStart');
        }
        const previewOLs = this.tree.shownTree.dom.querySelectorAll('ol');
        const parsedOLs = fragment.querySelectorAll('ol');
        const end = parsedOLs.length - 1;
        for (let i = 0; i <= end; i++) {
            const previewStart = previewOLs[i].getAttribute('start');
            const parsedStart = parsedOLs[i].getAttribute('start');
            if (previewStart === parsedStart) {
                continue;
            }
            else if (parsedStart !== null) {
                previewOLs[i].setAttribute('start', parsedStart);
            }
            else {
                previewOLs[i].removeAttribute('start');
            }
        }
    }
}
exports.UpdatePreview = UpdatePreview;
function prepareCodeBlocksForAtomEditors(domFragment) {
    for (const preElement of Array.from(domFragment.querySelectorAll('pre'))) {
        const preWrapper = document.createElement('span');
        preWrapper.className = 'atom-text-editor';
        preElement.parentNode.insertBefore(preWrapper, preElement);
        preWrapper.appendChild(preElement);
    }
    return domFragment;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBkYXRlLXByZXZpZXcuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvdXBkYXRlLXByZXZpZXcudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBNkJBLFlBQVksQ0FBQTs7QUFFWix5REFBbUQ7QUFDbkQsa0RBQWtEO0FBQ2xELHVDQUF1QztBQUV2QztJQUtFLFlBQVksR0FBWTtRQUN0QixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksaUNBQWMsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUE7SUFDM0MsQ0FBQztJQUVNLE1BQU0sQ0FBQyxXQUFvQixFQUFFLFdBQW9CO1FBQ3RELCtCQUErQixDQUFDLFdBQVcsQ0FBQyxDQUFBO1FBRTVDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLElBQUksV0FBVyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2xFLE1BQU0sQ0FBQyxTQUFTLENBQUE7UUFDbEIsQ0FBQztRQUVELE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxXQUFXLEtBQUssU0FBUyxDQUFBO1FBQ2hELElBQUksQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQVksQ0FBQTtRQUV6RCxNQUFNLE1BQU0sR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFBO1FBQzVDLE1BQU0sQ0FBQyxTQUFTLEdBQUcsZ0JBQWdCLENBQUE7UUFDbkMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsQ0FBQTtRQUMvQixNQUFNLE9BQU8sR0FBRyxJQUFJLGlDQUFjLENBQUMsTUFBTSxFQUFFLEtBQUssQ0FBQyxDQUFBO1FBRWpELE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBQ25DLE9BQU8sQ0FBQyxVQUFVLEVBQUUsQ0FBQTtRQUVwQixFQUFFLENBQUMsQ0FBQyxTQUFT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Q0FBQyxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsQ0FBQTtZQUN4QyxDQUFDO1FBQ0gsQ0FBQztJQUNILENBQUM7Q0FDRjtBQWhGRCxzQ0FnRkM7QUFFRCx5Q0FBeUMsV0FBb0I7SUFDM0QsR0FBRyxDQUFDLENBQUMsTUFBTSxVQUFVLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDekUsTUFBTSxVQUFVLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQTtRQUNqRCxVQUFVLENBQUMsU0FBUyxHQUFHLGtCQUFrQixDQUFBO1FBQ3pDLFVBQVUsQ0FBQyxVQUFXLENBQUMsWUFBWSxDQUFDLFVBQVUsRUFBRSxVQUFVLENBQUMsQ0FBQTtRQUMzRCxVQUFVLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxDQUFBO0lBQ3BDLENBQUM7SUFDRCxNQUFNLENBQUMsV0FBVyxDQUFBO0FBQ3BCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogZGVjYWZmZWluYXRlIHN1Z2dlc3Rpb25zOlxuICogRFMxMDE6IFJlbW92ZSB1bm5lY2Vzc2FyeSB1c2Ugb2YgQXJyYXkuZnJvbVxuICogRFMxMDI6IFJlbW92ZSB1bm5lY2Vzc2FyeSBjb2RlIGNyZWF0ZWQgYmVjYXVzZSBvZiBpbXBsaWNpdCByZXR1cm5zXG4gKiBEUzIwNzogQ29uc2lkZXIgc2hvcnRlciB2YXJpYXRpb25zIG9mIG51bGwgY2hlY2tzXG4gKiBGdWxsIGRvY3M6IGh0dHBzOi8vZ2l0aHViLmNvbS9kZWNhZmZlaW5hdGUvZGVjYWZmZWluYXRlL2Jsb2IvbWFzdGVyL2RvY3Mvc3VnZ2VzdGlvbnMubWRcbiAqL1xuLy8gVGhpcyBmaWxlIGluY29ycG9yYXRlcyBjb2RlIGZyb20gW21hcmttb25dKGh0dHBzOi8vZ2l0aHViLmNvbS95eWpoYW8vbWFya21vbilcbi8vIGNvdmVyZWQgYnkgdGhlIGZvbGxvd2luZyB0ZXJtczpcbi8vXG4vLyBDb3B5cmlnaHQgKGMpIDIwMTQsIFlhbyBZdWppYW4sIGh0dHA6Ly95anlhby5jb21cbi8vXG4vLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5XG4vLyBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSBcIlNvZnR3YXJlXCIpLCB0byBkZWFsXG4vLyBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzXG4vLyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsXG4vLyBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXNcbi8vIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6XG4vL1xuLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW5cbi8vIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLlxuLy9cbi8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCBcIkFTIElTXCIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1Jcbi8vIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLFxuLy8gRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFXG4vLyBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSXG4vLyBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLFxuLy8gT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTlxuLy8gVEhFIFNPRlRXQVJFLlxuJ3VzZSBzdHJpY3QnXG5cbmltcG9ydCB7IFdyYXBwZWREb21UcmVlIH0gZnJvbSAnLi93cmFwcGVkLWRvbS10cmVlJ1xuaW1wb3J0IE1hdGhKYXhIZWxwZXIgPSByZXF1aXJlKCcuL21hdGhqYXgtaGVscGVyJylcbmltcG9ydCByZW5kZXJlciA9IHJlcXVpcmUoJy4vcmVuZGVyZXInKVxuXG5leHBvcnQgY2xhc3MgVXBkYXRlUHJldmlldyB7XG4gIHByaXZhdGUgZG9tRnJhZ21lbnQ/OiBFbGVtZW50XG4gIHByaXZhdGUgdHJlZTogV3JhcHBlZERvbVRyZWVcbiAgLy8gQHBhcmFtIGRvbSBBIERPTSBlbGVtZW50IG9iamVjdFxuICAvLyAgICBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvZWxlbWVudFxuICBjb25zdHJ1Y3Rvcihkb206IEVsZW1lbnQpIHtcbiAgICB0aGlzLnRyZWUgPSBuZXcgV3JhcHBlZERvbVRyZWUoZG9tLCB0cnVlKVxuICB9XG5cbiAgcHVibGljIHVwZGF0ZShkb21GcmFnbWVudDogRWxlbWVudCwgcmVuZGVyTGFUZVg6IGJvb2xlYW4pIHtcbiAgICBwcmVwYXJlQ29kZUJsb2Nrc0ZvckF0b21FZGl0b3JzKGRvbUZyYWdtZW50KVxuXG4gICAgaWYgKHRoaXMuZG9tRnJhZ21lbnQgJiYgZG9tRnJhZ21lbnQuaXNFcXVhbE5vZGUodGhpcy5kb21GcmFnbWVudCkpIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWRcbiAgICB9XG5cbiAgICBjb25zdCBmaXJzdFRpbWUgPSB0aGlzLmRvbUZyYWdtZW50ID09PSB1bmRlZmluZWRcbiAgICB0aGlzLmRvbUZyYWdtZW50ID0gZG9tRnJhZ21lbnQuY2xvbmVOb2RlKHRydWUpIGFzIEVsZW1lbnRcblxuICAgIGNvbnN0IG5ld0RvbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpXG4gICAgbmV3RG9tLmNsYXNzTmFtZSA9ICd1cGRhdGUtcHJldmlldydcbiAgICBuZXdEb20uYXBwZW5kQ2hpbGQoZG9tRnJhZ21lbnQpXG4gICAgY29uc3QgbmV3VHJlZSA9IG5ldyBXcmFwcGVkRG9tVHJlZShuZXdEb20sIGZhbHNlKVxuXG4gICAgY29uc3QgciA9IHRoaXMudHJlZS5kaWZmVG8obmV3VHJlZSlcbiAgICBuZXdUcmVlLnJlbW92ZVNlbGYoKVxuXG4gICAgaWYgKGZpcnN0VGltZSkge1xuICAgICAgci5wb3NzaWJsZVJlcGxhY2UgPSB1bmRlZmluZWRcbiAgICAgIHIubGFzdCA9IHVuZGVmaW5lZFxuICAgIH1cblxuICAgIGlmIChyZW5kZXJMYVRlWCkge1xuICAgICAgci5pbnNlcnRlZCA9IHIuaW5zZXJ0ZWQubWFwKGZ1bmN0aW9uKGVsbTogTm9kZSkge1xuICAgICAgICB3aGlsZSAoZWxtLnBhcmVudEVsZW1lbnQgJiYgIShlbG0gYXMgSFRNTEVsZW1lbnQpLmlubmVySFRNTCkge1xuICAgICAgICAgIGVsbSA9IGVsbS5wYXJlbnRFbGVtZW50XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGVsbVxuICAgICAgfSlcbiAgICAgIHIuaW5zZXJ0ZWQgPSByLmluc2VydGVkLmZpbHRlcigoZWxtKSA9PiAhIWVsbSlcbiAgICAgIE1hdGhKYXhIZWxwZXIubWF0aFByb2Nlc3NvcihyLmluc2VydGVkKVxuICAgIH1cblxuICAgIGlmIChcbiAgICAgICFhdG9tLmNvbmZpZy5nZXQoJ21hcmtkb3duLXByZXZpZXctcGx1cy5lbmFibGVQYW5kb2MnKSB8fFxuICAgICAgIWF0b20uY29uZmlnLmdldCgnbWFya2Rvd24tcHJldmlldy1wbHVzLnVzZU5hdGl2ZVBhbmRvY0NvZGVTdHlsZXMnKVxuICAgICkge1xuICAgICAgZm9yIChjb25zdCBlbG0gb2YgQXJyYXkuZnJvbShyLmluc2VydGVkKSkge1xuICAgICAgICBpZiAoZWxtIGluc3RhbmNlb2YgRWxlbWVudCkge1xuICAgICAgICAgIHJlbmRlcmVyLmNvbnZlcnRDb2RlQmxvY2tzVG9BdG9tRWRpdG9ycyhlbG0pXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aGlzLnVwZGF0ZU9yZGVyZWRMaXN0c1N0YXJ0KHRoaXMuZG9tRnJhZ21lbnQpXG5cbiAgICByZXR1cm4gclxuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVPcmRlcmVkTGlzdHNTdGFydChmcmFnbWVudDogRWxlbWVudCkge1xuICAgIGlmICh0aGlzLnRyZWUuc2hvd25UcmVlID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignc2hvd25UcmVlIHVuZGVmaW5lZCBpbiB1cGRhdGVPcmRlcmVkTGlzdHNTdGFydCcpXG4gICAgfVxuICAgIGNvbnN0IHByZXZpZXdPTHMgPSB0aGlzLnRyZWUuc2hvd25UcmVlLmRvbS5xdWVyeVNlbGVjdG9yQWxsKCdvbCcpXG4gICAgY29uc3QgcGFyc2VkT0xzID0gZnJhZ21lbnQucXVlcnlTZWxlY3RvckFsbCgnb2wnKVxuXG4gICAgY29uc3QgZW5kID0gcGFyc2VkT0xzLmxlbmd0aCAtIDFcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8PSBlbmQ7IGkrKykge1xuICAgICAgY29uc3QgcHJldmlld1N0YXJ0ID0gcHJldmlld09Mc1tpXS5nZXRBdHRyaWJ1dGUoJ3N0YXJ0JylcbiAgICAgIGNvbnN0IHBhcnNlZFN0YXJ0ID0gcGFyc2VkT0xzW2ldLmdldEF0dHJpYnV0ZSgnc3RhcnQnKVxuXG4gICAgICBpZiAocHJldmlld1N0YXJ0ID09PSBwYXJzZWRTdGFydCkge1xuICAgICAgICBjb250aW51ZVxuICAgICAgfSBlbHNlIGlmIChwYXJzZWRTdGFydCAhPT0gbnVsbCkge1xuICAgICAgICBwcmV2aWV3T0xzW2ldLnNldEF0dHJpYnV0ZSgnc3RhcnQnLCBwYXJzZWRTdGFydClcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHByZXZpZXdPTHNbaV0ucmVtb3ZlQXR0cmlidXRlKCdzdGFydCcpXG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIHByZXBhcmVDb2RlQmxvY2tzRm9yQXRvbUVkaXRvcnMoZG9tRnJhZ21lbnQ6IEVsZW1lbnQpIHtcbiAgZm9yIChjb25zdCBwcmVFbGVtZW50IG9mIEFycmF5LmZyb20oZG9tRnJhZ21lbnQucXVlcnlTZWxlY3RvckFsbCgncHJlJykpKSB7XG4gICAgY29uc3QgcHJlV3JhcHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKVxuICAgIHByZVdyYXBwZXIuY2xhc3NOYW1lID0gJ2F0b20tdGV4dC1lZGl0b3InXG4gICAgcHJlRWxlbWVudC5wYXJlbnROb2RlIS5pbnNlcnRCZWZvcmUocHJlV3JhcHBlciwgcHJlRWxlbWVudClcbiAgICBwcmVXcmFwcGVyLmFwcGVuZENoaWxkKHByZUVsZW1lbnQpXG4gIH1cbiAgcmV0dXJuIGRvbUZyYWdtZW50XG59XG4iXX0=