'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
const wrapped_dom_tree_1 = require("./wrapped-dom-tree");
const MathJaxHelper = require("./mathjax-helper");
const renderer = require("./renderer");
class UpdatePreview {
    constructor(dom) {
        this.tree = new wrapped_dom_tree_1.WrappedDomTree(dom, true);
    }
    update(domFragment, renderLaTeX) {
        prepareCodeBlocksForAtomEditors(domFragment);
        if (this.domFragment && domFragment.isEqualNode(this.domFragment)) {
            return undefined;
        }
        const firstTime = this.domFragment === undefined;
        this.domFragment = domFragment.cloneNode(true);
        const newDom = document.createElement('div');
        newDom.className = 'update-preview';
        newDom.appendChild(domFragment);
        const newTree = new wrapped_dom_tree_1.WrappedDomTree(newDom, false);
        const r = this.tree.diffTo(newTree);
        newTree.removeSelf();
        if (firstTime) {
            r.possibleReplace = undefined;
            r.last = undefined;
        }
        if (renderLaTeX) {
            r.inserted = r.inserted.map(function (elm) {
                while (elm.parentElement && !elm.innerHTML) {
                    elm = elm.parentElement;
                }
                return elm;
            });
            r.inserted = r.inserted.filter((elm) => !!elm);
            MathJaxHelper.mathProcessor(r.inserted);
        }
        if (!atom.config.get('markdown-preview-plus.enablePandoc') ||
            !atom.config.get('markdown-preview-plus.useNativePandocCodeStyles')) {
            for (const elm of r.inserted) {
                if (elm instanceof Element) {
                    renderer.convertCodeBlocksToAtomEditors(elm);
                }
            }
        }
        this.updateOrderedListsStart(this.domFragment);
        return r;
    }
    updateOrderedListsStart(fragment) {
        if (this.tree.shownTree === undefined) {
            throw new Error('shownTree undefined in updateOrderedListsStart');
        }
        const previewOLs = this.tree.shownTree.dom.querySelectorAll('ol');
        const parsedOLs = fragment.querySelectorAll('ol');
        const end = parsedOLs.length - 1;
        for (let i = 0; i <= end; i++) {
            const previewStart = previewOLs[i].getAttribute('start');
            const parsedStart = parsedOLs[i].getAttribute('start');
            if (previewStart === parsedStart) {
                continue;
            }
            else if (parsedStart !== null) {
                previewOLs[i].setAttribute('start', parsedStart);
            }
            else {
                previewOLs[i].removeAttribute('start');
            }
        }
    }
}
exports.UpdatePreview = UpdatePreview;
function prepareCodeBlocksForAtomEditors(domFragment) {
    for (const preElement of Array.from(domFragment.querySelectorAll('pre'))) {
        const preWrapper = document.createElement('span');
        preWrapper.className = 'atom-text-editor';
        preElement.parentNode.insertBefore(preWrapper, preElement);
        preWrapper.appendChild(preElement);
    }
    return domFragment;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBkYXRlLXByZXZpZXcuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvdXBkYXRlLXByZXZpZXcudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBNEJBLFlBQVksQ0FBQTs7QUFFWix5REFBbUQ7QUFDbkQsa0RBQWtEO0FBQ2xELHVDQUF1QztBQUV2QztJQUtFLFlBQVksR0FBWTtRQUN0QixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksaUNBQWMsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUE7SUFDM0MsQ0FBQztJQUVNLE1BQU0sQ0FBQyxXQUFvQixFQUFFLFdBQW9CO1FBQ3RELCtCQUErQixDQUFDLFdBQVcsQ0FBQyxDQUFBO1FBRTVDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLElBQUksV0FBVyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2xFLE1BQU0sQ0FBQyxTQUFTLENBQUE7UUFDbEIsQ0FBQztRQUVELE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxXQUFXLEtBQUssU0FBUyxDQUFBO1FBQ2hELElBQUksQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQVksQ0FBQTtRQUV6RCxNQUFNLE1BQU0sR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFBO1FBQzVDLE1BQU0sQ0FBQyxTQUFTLEdBQUcsZ0JBQWdCLENBQUE7UUFDbkMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsQ0FBQTtRQUMvQixNQUFNLE9BQU8sR0FBRyxJQUFJLGlDQUFjLENBQUMsTUFBTSxFQUFFLEtBQUssQ0FBQyxDQUFBO1FBRWpELE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBQ25DLE9BQU8sQ0FBQyxVQUFVLEVBQUUsQ0FBQTtRQUVwQixFQUFFLENBQUMsQ0FBQyxTQUFT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Q0FBQyxDQUFBO1lBQ3hDLENBQUM7UUFDSCxDQUFDO0lBQ0gsQ0FBQztDQUNGO0FBaEZELHNDQWdGQztBQUVELHlDQUF5QyxXQUFvQjtJQUMzRCxHQUFHLENBQUMsQ0FBQyxNQUFNLFVBQVUsSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN6RSxNQUFNLFVBQVUsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBQ2pELFVBQVUsQ0FBQyxTQUFTLEdBQUcsa0JBQWtCLENBQUE7UUFDekMsVUFBVSxDQUFDLFVBQVcsQ0FBQyxZQUFZLENBQUMsVUFBVSxFQUFFLFVBQVUsQ0FBQyxDQUFBO1FBQzNELFVBQVUsQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDLENBQUE7SUFDcEMsQ0FBQztJQUNELE1BQU0sQ0FBQyxXQUFXLENBQUE7QUFDcEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBkZWNhZmZlaW5hdGUgc3VnZ2VzdGlvbnM6XG4gKiBEUzEwMjogUmVtb3ZlIHVubmVjZXNzYXJ5IGNvZGUgY3JlYXRlZCBiZWNhdXNlIG9mIGltcGxpY2l0IHJldHVybnNcbiAqIERTMjA3OiBDb25zaWRlciBzaG9ydGVyIHZhcmlhdGlvbnMgb2YgbnVsbCBjaGVja3NcbiAqIEZ1bGwgZG9jczogaHR0cHM6Ly9naXRodWIuY29tL2RlY2FmZmVpbmF0ZS9kZWNhZmZlaW5hdGUvYmxvYi9tYXN0ZXIvZG9jcy9zdWdnZXN0aW9ucy5tZFxuICovXG4vLyBUaGlzIGZpbGUgaW5jb3Jwb3JhdGVzIGNvZGUgZnJvbSBbbWFya21vbl0oaHR0cHM6Ly9naXRodWIuY29tL3l5amhhby9tYXJrbW9uKVxuLy8gY292ZXJlZCBieSB0aGUgZm9sbG93aW5nIHRlcm1zOlxuLy9cbi8vIENvcHlyaWdodCAoYykgMjAxNCwgWWFvIFl1amlhbiwgaHR0cDovL3lqeWFvLmNvbVxuLy9cbi8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcbi8vIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlIFwiU29mdHdhcmVcIiksIHRvIGRlYWxcbi8vIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHNcbi8vIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGxcbi8vIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpc1xuLy8gZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczpcbi8vXG4vLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpblxuLy8gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuXG4vL1xuLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEIFwiQVMgSVNcIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUlxuLy8gSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksXG4vLyBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEVcbi8vIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVJcbi8vIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sXG4vLyBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOXG4vLyBUSEUgU09GVFdBUkUuXG4ndXNlIHN0cmljdCdcblxuaW1wb3J0IHsgV3JhcHBlZERvbVRyZWUgfSBmcm9tICcuL3dyYXBwZWQtZG9tLXRyZWUnXG5pbXBvcnQgTWF0aEpheEhlbHBlciA9IHJlcXVpcmUoJy4vbWF0aGpheC1oZWxwZXInKVxuaW1wb3J0IHJlbmRlcmVyID0gcmVxdWlyZSgnLi9yZW5kZXJlcicpXG5cbmV4cG9ydCBjbGFzcyBVcGRhdGVQcmV2aWV3IHtcbiAgcHJpdmF0ZSBkb21GcmFnbWVudD86IEVsZW1lbnRcbiAgcHJpdmF0ZSB0cmVlOiBXcmFwcGVkRG9tVHJlZVxuICAvLyBAcGFyYW0gZG9tIEEgRE9NIGVsZW1lbnQgb2JqZWN0XG4gIC8vICAgIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0FQSS9lbGVtZW50XG4gIGNvbnN0cnVjdG9yKGRvbTogRWxlbWVudCkge1xuICAgIHRoaXMudHJlZSA9IG5ldyBXcmFwcGVkRG9tVHJlZShkb20sIHRydWUpXG4gIH1cblxuICBwdWJsaWMgdXBkYXRlKGRvbUZyYWdtZW50OiBFbGVtZW50LCByZW5kZXJMYVRlWDogYm9vbGVhbikge1xuICAgIHByZXBhcmVDb2RlQmxvY2tzRm9yQXRvbUVkaXRvcnMoZG9tRnJhZ21lbnQpXG5cbiAgICBpZiAodGhpcy5kb21GcmFnbWVudCAmJiBkb21GcmFnbWVudC5pc0VxdWFsTm9kZSh0aGlzLmRvbUZyYWdtZW50KSkge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZFxuICAgIH1cblxuICAgIGNvbnN0IGZpcnN0VGltZSA9IHRoaXMuZG9tRnJhZ21lbnQgPT09IHVuZGVmaW5lZFxuICAgIHRoaXMuZG9tRnJhZ21lbnQgPSBkb21GcmFnbWVudC5jbG9uZU5vZGUodHJ1ZSkgYXMgRWxlbWVudFxuXG4gICAgY29uc3QgbmV3RG9tID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JylcbiAgICBuZXdEb20uY2xhc3NOYW1lID0gJ3VwZGF0ZS1wcmV2aWV3J1xuICAgIG5ld0RvbS5hcHBlbmRDaGlsZChkb21GcmFnbWVudClcbiAgICBjb25zdCBuZXdUcmVlID0gbmV3IFdyYXBwZWREb21UcmVlKG5ld0RvbSwgZmFsc2UpXG5cbiAgICBjb25zdCByID0gdGhpcy50cmVlLmRpZmZUbyhuZXdUcmVlKVxuICAgIG5ld1RyZWUucmVtb3ZlU2VsZigpXG5cbiAgICBpZiAoZmlyc3RUaW1lKSB7XG4gICAgICByLnBvc3NpYmxlUmVwbGFjZSA9IHVuZGVmaW5lZFxuICAgICAgci5sYXN0ID0gdW5kZWZpbmVkXG4gICAgfVxuXG4gICAgaWYgKHJlbmRlckxhVGVYKSB7XG4gICAgICByLmluc2VydGVkID0gci5pbnNlcnRlZC5tYXAoZnVuY3Rpb24oZWxtOiBOb2RlKSB7XG4gICAgICAgIHdoaWxlIChlbG0ucGFyZW50RWxlbWVudCAmJiAhKGVsbSBhcyBIVE1MRWxlbWVudCkuaW5uZXJIVE1MKSB7XG4gICAgICAgICAgZWxtID0gZWxtLnBhcmVudEVsZW1lbnRcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZWxtXG4gICAgICB9KVxuICAgICAgci5pbnNlcnRlZCA9IHIuaW5zZXJ0ZWQuZmlsdGVyKChlbG0pID0+ICEhZWxtKVxuICAgICAgTWF0aEpheEhlbHBlci5tYXRoUHJvY2Vzc29yKHIuaW5zZXJ0ZWQpXG4gICAgfVxuXG4gICAgaWYgKFxuICAgICAgIWF0b20uY29uZmlnLmdldCgnbWFya2Rvd24tcHJldmlldy1wbHVzLmVuYWJsZVBhbmRvYycpIHx8XG4gICAgICAhYXRvbS5jb25maWcuZ2V0KCdtYXJrZG93bi1wcmV2aWV3LXBsdXMudXNlTmF0aXZlUGFuZG9jQ29kZVN0eWxlcycpXG4gICAgKSB7XG4gICAgICBmb3IgKGNvbnN0IGVsbSBvZiByLmluc2VydGVkKSB7XG4gICAgICAgIGlmIChlbG0gaW5zdGFuY2VvZiBFbGVtZW50KSB7XG4gICAgICAgICAgcmVuZGVyZXIuY29udmVydENvZGVCbG9ja3NUb0F0b21FZGl0b3JzKGVsbSlcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIHRoaXMudXBkYXRlT3JkZXJlZExpc3RzU3RhcnQodGhpcy5kb21GcmFnbWVudClcblxuICAgIHJldHVybiByXG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZU9yZGVyZWRMaXN0c1N0YXJ0KGZyYWdtZW50OiBFbGVtZW50KSB7XG4gICAgaWYgKHRoaXMudHJlZS5zaG93blRyZWUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdzaG93blRyZWUgdW5kZWZpbmVkIGluIHVwZGF0ZU9yZGVyZWRMaXN0c1N0YXJ0JylcbiAgICB9XG4gICAgY29uc3QgcHJldmlld09McyA9IHRoaXMudHJlZS5zaG93blRyZWUuZG9tLnF1ZXJ5U2VsZWN0b3JBbGwoJ29sJylcbiAgICBjb25zdCBwYXJzZWRPTHMgPSBmcmFnbWVudC5xdWVyeVNlbGVjdG9yQWxsKCdvbCcpXG5cbiAgICBjb25zdCBlbmQgPSBwYXJzZWRPTHMubGVuZ3RoIC0gMVxuICAgIGZvciAobGV0IGkgPSAwOyBpIDw9IGVuZDsgaSsrKSB7XG4gICAgICBjb25zdCBwcmV2aWV3U3RhcnQgPSBwcmV2aWV3T0xzW2ldLmdldEF0dHJpYnV0ZSgnc3RhcnQnKVxuICAgICAgY29uc3QgcGFyc2VkU3RhcnQgPSBwYXJzZWRPTHNbaV0uZ2V0QXR0cmlidXRlKCdzdGFydCcpXG5cbiAgICAgIGlmIChwcmV2aWV3U3RhcnQgPT09IHBhcnNlZFN0YXJ0KSB7XG4gICAgICAgIGNvbnRpbnVlXG4gICAgICB9IGVsc2UgaWYgKHBhcnNlZFN0YXJ0ICE9PSBudWxsKSB7XG4gICAgICAgIHByZXZpZXdPTHNbaV0uc2V0QXR0cmlidXRlKCdzdGFydCcsIHBhcnNlZFN0YXJ0KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcHJldmlld09Mc1tpXS5yZW1vdmVBdHRyaWJ1dGUoJ3N0YXJ0JylcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gcHJlcGFyZUNvZGVCbG9ja3NGb3JBdG9tRWRpdG9ycyhkb21GcmFnbWVudDogRWxlbWVudCkge1xuICBmb3IgKGNvbnN0IHByZUVsZW1lbnQgb2YgQXJyYXkuZnJvbShkb21GcmFnbWVudC5xdWVyeVNlbGVjdG9yQWxsKCdwcmUnKSkpIHtcbiAgICBjb25zdCBwcmVXcmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpXG4gICAgcHJlV3JhcHBlci5jbGFzc05hbWUgPSAnYXRvbS10ZXh0LWVkaXRvcidcbiAgICBwcmVFbGVtZW50LnBhcmVudE5vZGUhLmluc2VydEJlZm9yZShwcmVXcmFwcGVyLCBwcmVFbGVtZW50KVxuICAgIHByZVdyYXBwZXIuYXBwZW5kQ2hpbGQocHJlRWxlbWVudClcbiAgfVxuICByZXR1cm4gZG9tRnJhZ21lbnRcbn1cbiJdfQ==