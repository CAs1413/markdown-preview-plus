"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const wrapped_dom_tree_1 = require("./wrapped-dom-tree");
const MathJaxHelper = require("./mathjax-helper");
const renderer = require("./renderer");
const util_1 = require("./util");
class UpdatePreview {
    constructor(dom) {
        this.tree = new wrapped_dom_tree_1.WrappedDomTree(dom, true);
    }
    update(frame, domFragment, renderLaTeX) {
        prepareCodeBlocksForAtomEditors(frame.contentDocument, domFragment);
        if (this.domFragment && domFragment.isEqualNode(this.domFragment)) {
            return undefined;
        }
        const firstTime = this.domFragment === undefined;
        this.domFragment = domFragment.cloneNode(true);
        const newDom = frame.contentDocument.createElement('div');
        newDom.className = 'update-preview';
        newDom.appendChild(domFragment);
        const newTree = new wrapped_dom_tree_1.WrappedDomTree(newDom, false);
        const r = this.tree.diffTo(newTree);
        newTree.removeSelf();
        if (firstTime) {
            r.possibleReplace = undefined;
            r.last = undefined;
        }
        if (renderLaTeX) {
            r.inserted = r.inserted.map(function (elm) {
                while (elm.parentElement && !elm.innerHTML) {
                    elm = elm.parentElement;
                }
                return elm;
            });
            r.inserted = r.inserted.filter((elm) => !!elm);
            util_1.handlePromise(MathJaxHelper.mathProcessor(frame, r.inserted));
        }
        if (!atom.config.get('markdown-preview-plus.enablePandoc') ||
            !atom.config.get('markdown-preview-plus.useNativePandocCodeStyles')) {
            for (const elm of r.inserted) {
                if (typeof elm.querySelectorAll === 'function') {
                    renderer.highlightCodeBlocks(elm);
                }
            }
        }
        this.updateOrderedListsStart(this.domFragment);
        return r;
    }
    updateOrderedListsStart(fragment) {
        if (this.tree.shownTree === undefined) {
            throw new Error('shownTree undefined in updateOrderedListsStart');
        }
        const previewOLs = this.tree.shownTree.dom.querySelectorAll('ol');
        const parsedOLs = fragment.querySelectorAll('ol');
        const end = parsedOLs.length - 1;
        for (let i = 0; i <= end; i++) {
            const previewStart = previewOLs[i].getAttribute('start');
            const parsedStart = parsedOLs[i].getAttribute('start');
            if (previewStart === parsedStart) {
                continue;
            }
            else if (parsedStart !== null) {
                previewOLs[i].setAttribute('start', parsedStart);
            }
            else {
                previewOLs[i].removeAttribute('start');
            }
        }
    }
}
exports.UpdatePreview = UpdatePreview;
function prepareCodeBlocksForAtomEditors(document, domFragment) {
    for (const preElement of Array.from(domFragment.querySelectorAll('pre'))) {
        const preWrapper = document.createElement('span');
        preWrapper.className = 'atom-text-editor';
        preElement.parentNode.insertBefore(preWrapper, preElement);
        preWrapper.appendChild(preElement);
    }
    return domFragment;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBkYXRlLXByZXZpZXcuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvdXBkYXRlLXByZXZpZXcudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFzQkEseURBQW1EO0FBQ25ELGtEQUFrRDtBQUNsRCx1Q0FBdUM7QUFDdkMsaUNBQXNDO0FBRXRDO0lBS0UsWUFBWSxHQUFZO1FBQ3RCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxpQ0FBYyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQTtJQUMzQyxDQUFDO0lBRU0sTUFBTSxDQUNYLEtBQXdCLEVBQ3hCLFdBQW9CLEVBQ3BCLFdBQW9CO1FBRXBCLCtCQUErQixDQUFDLEtBQUssQ0FBQyxlQUFlLEVBQUUsV0FBVyxDQUFDLENBQUE7UUFFbkUsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsSUFBSSxXQUFXLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbEUsTUFBTSxDQUFDLFNBQVMsQ0FBQTtRQUNsQixDQUFDO1FBRUQsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLFdBQVcsS0FBSyxTQUFTLENBQUE7UUFDaEQsSUFBSSxDQUFDLFdBQVcsR0FBRyxXQUFXLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBWSxDQUFBO1FBRXpELE1BQU0sTUFBTSxHQUFHLEtBQUssQ0FBQyxlQUFlLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFBO1FBQ3pELE1BQU0sQ0FBQyxTQUFTLEdBQUcsZ0JBQWdCLENBQUE7UUFDbkMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsQ0FBQTtRQUMvQixNQUFNLE9BQU8sR0FBRyxJQUFJLGlDQUFjLENBQUMsTUFBTSxFQUFFLEtBQUssQ0FBQyxDQUFBO1FBRWpELE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBQ25DLE9BQU8sQ0FBQyxVQUFVLEVBQUUsQ0FBQTtRQUVwQixFQUFFLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO1lBQ2QsQ0FBQyxDQUFDLGVBQWUsR0FBRyxTQUFTLENBQUE7WUFDN0IsQ0FBQyxDQUFDLElBQUksR0FBRyxTQUFTLENBQUE7UUFDcEIsQ0FBQztRQUVELEVBQUUsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUM7WUFDaEIsQ0FBQyxDQUFDLFFBQVEsR0FBRyxDQUFDLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxVQUFTLEdBQVM7Z0JBQzVDLE9BQU8sR0FBRyxDQUFDLGFBQWEsSUFBSSxDQUFFLEdBQW1CLENBQUMsU0FBUyxFQUFFLENBQUM7b0JBQzVELEdBQUcsR0FBRyxHQUFHLENBQUMsYUFBYSxDQUFBO2dCQUN6QixDQUFDO2dCQUNELE1BQU0sQ0FBQyxHQUFHLENBQUE7WUFDWixDQUFDLENBQUMsQ0FBQTtZQUNGLENBQUMsQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQTtZQUM5QyxvQkFBYSxDQUFDLGFBQWEsQ0FBQyxhQUFhLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFBO1FBQy9ELENBQUM7UUFFRCxFQUFFLENBQUMsQ0FDRCxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLG9DQUFvQyxDQUFDO1lBQ3RELENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsaURBQWlELENBQ3BFLENBQUMsQ0FBQyxDQUFDO1lBQ0QsR0FBRyxDQUFDLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7Z0JBQzdCLEVBQUUsQ0FBQyxDQUFDLE9BQVEsR0FBVyxDQUFDLGdCQUFnQixLQUFLLFVBQVUsQ0FBQyxDQUFDLENBQUM7b0JBQ3hELFFBQVEsQ0FBQyxtQkFBbUIsQ0FBQyxHQUFjLENBQUMsQ0FBQTtnQkFDOUMsQ0FBQztZQUNILENBQUM7UUFDSCxDQUFDO1FBRUQsSUFBSSxDQUFDLHVCQUF1QixDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQTtRQUU5QyxNQUFNLENBQUMsQ0FBQyxDQUFBO0lBQ1YsQ0FBQztJQUVPLHVCQUF1QixDQUFDLFFBQWlCO1FBQy9DLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDdEMsTUFBTSxJQUFJLEtBQUssQ0FBQyxnREFBZ0QsQ0FBQyxDQUFBO1FBQ25FLENBQUM7UUFDRCxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDakUsTUFBTSxTQUFTLEdBQUcsUUFBUSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxDQUFBO1FBRWpELE1BQU0sR0FBRyxHQUFHLFNBQVMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFBO1FBQ2hDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLElBQUksR0FBRyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7WUFDOUIsTUFBTSxZQUFZLEdBQUcsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsQ0FBQTtZQUN4RCxNQUFNLFdBQVcsR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1lBRXRELEVBQUUsQ0FBQyxDQUFDLFlBQVksS0FBSyxXQUFXLENBQUMsQ0FBQyxDQUFDO2dCQUNqQyxRQUFRLENBQUE7WUFDVixDQUFDO1lBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLFdBQVcsS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDO2dCQUNoQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLE9BQU8sRUFBRSxXQUFXLENBQUMsQ0FBQTtZQUNsRCxDQUFDO1lBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ04sVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsQ0FBQTtZQUN4QyxDQUFDO1FBQ0gsQ0FBQztJQUNILENBQUM7Q0FDRjtBQXBGRCxzQ0FvRkM7QUFFRCx5Q0FDRSxRQUFzQixFQUN0QixXQUFvQjtJQUVwQixHQUFHLENBQUMsQ0FBQyxNQUFNLFVBQVUsSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN6RSxNQUFNLFVBQVUsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBQ2pELFVBQVUsQ0FBQyxTQUFTLEdBQUcsa0JBQWtCLENBQUE7UUFDekMsVUFBVSxDQUFDLFVBQVcsQ0FBQyxZQUFZLENBQUMsVUFBVSxFQUFFLFVBQVUsQ0FBQyxDQUFBO1FBQzNELFVBQVUsQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDLENBQUE7SUFDcEMsQ0FBQztJQUNELE1BQU0sQ0FBQyxXQUFXLENBQUE7QUFDcEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIFRoaXMgZmlsZSBpbmNvcnBvcmF0ZXMgY29kZSBmcm9tIFttYXJrbW9uXShodHRwczovL2dpdGh1Yi5jb20veXlqaGFvL21hcmttb24pXG4vLyBjb3ZlcmVkIGJ5IHRoZSBmb2xsb3dpbmcgdGVybXM6XG4vL1xuLy8gQ29weXJpZ2h0IChjKSAyMDE0LCBZYW8gWXVqaWFuLCBodHRwOi8veWp5YW8uY29tXG4vL1xuLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weVxuLy8gb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgXCJTb2Z0d2FyZVwiKSwgdG8gZGVhbFxuLy8gaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0c1xuLy8gdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbFxuLy8gY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzXG4vLyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOlxuLy9cbi8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluXG4vLyBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS5cbi8vXG4vLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgXCJBUyBJU1wiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SXG4vLyBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSxcbi8vIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRVxuLy8gQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUlxuLy8gTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSxcbi8vIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU5cbi8vIFRIRSBTT0ZUV0FSRS5cbmltcG9ydCB7IFdyYXBwZWREb21UcmVlIH0gZnJvbSAnLi93cmFwcGVkLWRvbS10cmVlJ1xuaW1wb3J0IE1hdGhKYXhIZWxwZXIgPSByZXF1aXJlKCcuL21hdGhqYXgtaGVscGVyJylcbmltcG9ydCByZW5kZXJlciA9IHJlcXVpcmUoJy4vcmVuZGVyZXInKVxuaW1wb3J0IHsgaGFuZGxlUHJvbWlzZSB9IGZyb20gJy4vdXRpbCdcblxuZXhwb3J0IGNsYXNzIFVwZGF0ZVByZXZpZXcge1xuICBwcml2YXRlIGRvbUZyYWdtZW50PzogRWxlbWVudFxuICBwcml2YXRlIHRyZWU6IFdyYXBwZWREb21UcmVlXG4gIC8vIEBwYXJhbSBkb20gQSBET00gZWxlbWVudCBvYmplY3RcbiAgLy8gICAgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL2VsZW1lbnRcbiAgY29uc3RydWN0b3IoZG9tOiBFbGVtZW50KSB7XG4gICAgdGhpcy50cmVlID0gbmV3IFdyYXBwZWREb21UcmVlKGRvbSwgdHJ1ZSlcbiAgfVxuXG4gIHB1YmxpYyB1cGRhdGUoXG4gICAgZnJhbWU6IEhUTUxJRnJhbWVFbGVtZW50LFxuICAgIGRvbUZyYWdtZW50OiBFbGVtZW50LFxuICAgIHJlbmRlckxhVGVYOiBib29sZWFuLFxuICApIHtcbiAgICBwcmVwYXJlQ29kZUJsb2Nrc0ZvckF0b21FZGl0b3JzKGZyYW1lLmNvbnRlbnREb2N1bWVudCwgZG9tRnJhZ21lbnQpXG5cbiAgICBpZiAodGhpcy5kb21GcmFnbWVudCAmJiBkb21GcmFnbWVudC5pc0VxdWFsTm9kZSh0aGlzLmRvbUZyYWdtZW50KSkge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZFxuICAgIH1cblxuICAgIGNvbnN0IGZpcnN0VGltZSA9IHRoaXMuZG9tRnJhZ21lbnQgPT09IHVuZGVmaW5lZFxuICAgIHRoaXMuZG9tRnJhZ21lbnQgPSBkb21GcmFnbWVudC5jbG9uZU5vZGUodHJ1ZSkgYXMgRWxlbWVudFxuXG4gICAgY29uc3QgbmV3RG9tID0gZnJhbWUuY29udGVudERvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpXG4gICAgbmV3RG9tLmNsYXNzTmFtZSA9ICd1cGRhdGUtcHJldmlldydcbiAgICBuZXdEb20uYXBwZW5kQ2hpbGQoZG9tRnJhZ21lbnQpXG4gICAgY29uc3QgbmV3VHJlZSA9IG5ldyBXcmFwcGVkRG9tVHJlZShuZXdEb20sIGZhbHNlKVxuXG4gICAgY29uc3QgciA9IHRoaXMudHJlZS5kaWZmVG8obmV3VHJlZSlcbiAgICBuZXdUcmVlLnJlbW92ZVNlbGYoKVxuXG4gICAgaWYgKGZpcnN0VGltZSkge1xuICAgICAgci5wb3NzaWJsZVJlcGxhY2UgPSB1bmRlZmluZWRcbiAgICAgIHIubGFzdCA9IHVuZGVmaW5lZFxuICAgIH1cblxuICAgIGlmIChyZW5kZXJMYVRlWCkge1xuICAgICAgci5pbnNlcnRlZCA9IHIuaW5zZXJ0ZWQubWFwKGZ1bmN0aW9uKGVsbTogTm9kZSkge1xuICAgICAgICB3aGlsZSAoZWxtLnBhcmVudEVsZW1lbnQgJiYgIShlbG0gYXMgSFRNTEVsZW1lbnQpLmlubmVySFRNTCkge1xuICAgICAgICAgIGVsbSA9IGVsbS5wYXJlbnRFbGVtZW50XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGVsbVxuICAgICAgfSlcbiAgICAgIHIuaW5zZXJ0ZWQgPSByLmluc2VydGVkLmZpbHRlcigoZWxtKSA9PiAhIWVsbSlcbiAgICAgIGhhbmRsZVByb21pc2UoTWF0aEpheEhlbHBlci5tYXRoUHJvY2Vzc29yKGZyYW1lLCByLmluc2VydGVkKSlcbiAgICB9XG5cbiAgICBpZiAoXG4gICAgICAhYXRvbS5jb25maWcuZ2V0KCdtYXJrZG93bi1wcmV2aWV3LXBsdXMuZW5hYmxlUGFuZG9jJykgfHxcbiAgICAgICFhdG9tLmNvbmZpZy5nZXQoJ21hcmtkb3duLXByZXZpZXctcGx1cy51c2VOYXRpdmVQYW5kb2NDb2RlU3R5bGVzJylcbiAgICApIHtcbiAgICAgIGZvciAoY29uc3QgZWxtIG9mIHIuaW5zZXJ0ZWQpIHtcbiAgICAgICAgaWYgKHR5cGVvZiAoZWxtIGFzIGFueSkucXVlcnlTZWxlY3RvckFsbCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgIHJlbmRlcmVyLmhpZ2hsaWdodENvZGVCbG9ja3MoZWxtIGFzIEVsZW1lbnQpXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aGlzLnVwZGF0ZU9yZGVyZWRMaXN0c1N0YXJ0KHRoaXMuZG9tRnJhZ21lbnQpXG5cbiAgICByZXR1cm4gclxuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVPcmRlcmVkTGlzdHNTdGFydChmcmFnbWVudDogRWxlbWVudCkge1xuICAgIGlmICh0aGlzLnRyZWUuc2hvd25UcmVlID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignc2hvd25UcmVlIHVuZGVmaW5lZCBpbiB1cGRhdGVPcmRlcmVkTGlzdHNTdGFydCcpXG4gICAgfVxuICAgIGNvbnN0IHByZXZpZXdPTHMgPSB0aGlzLnRyZWUuc2hvd25UcmVlLmRvbS5xdWVyeVNlbGVjdG9yQWxsKCdvbCcpXG4gICAgY29uc3QgcGFyc2VkT0xzID0gZnJhZ21lbnQucXVlcnlTZWxlY3RvckFsbCgnb2wnKVxuXG4gICAgY29uc3QgZW5kID0gcGFyc2VkT0xzLmxlbmd0aCAtIDFcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8PSBlbmQ7IGkrKykge1xuICAgICAgY29uc3QgcHJldmlld1N0YXJ0ID0gcHJldmlld09Mc1tpXS5nZXRBdHRyaWJ1dGUoJ3N0YXJ0JylcbiAgICAgIGNvbnN0IHBhcnNlZFN0YXJ0ID0gcGFyc2VkT0xzW2ldLmdldEF0dHJpYnV0ZSgnc3RhcnQnKVxuXG4gICAgICBpZiAocHJldmlld1N0YXJ0ID09PSBwYXJzZWRTdGFydCkge1xuICAgICAgICBjb250aW51ZVxuICAgICAgfSBlbHNlIGlmIChwYXJzZWRTdGFydCAhPT0gbnVsbCkge1xuICAgICAgICBwcmV2aWV3T0xzW2ldLnNldEF0dHJpYnV0ZSgnc3RhcnQnLCBwYXJzZWRTdGFydClcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHByZXZpZXdPTHNbaV0ucmVtb3ZlQXR0cmlidXRlKCdzdGFydCcpXG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIHByZXBhcmVDb2RlQmxvY2tzRm9yQXRvbUVkaXRvcnMoXG4gIGRvY3VtZW50OiBIVE1MRG9jdW1lbnQsXG4gIGRvbUZyYWdtZW50OiBFbGVtZW50LFxuKSB7XG4gIGZvciAoY29uc3QgcHJlRWxlbWVudCBvZiBBcnJheS5mcm9tKGRvbUZyYWdtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ3ByZScpKSkge1xuICAgIGNvbnN0IHByZVdyYXBwZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJylcbiAgICBwcmVXcmFwcGVyLmNsYXNzTmFtZSA9ICdhdG9tLXRleHQtZWRpdG9yJ1xuICAgIHByZUVsZW1lbnQucGFyZW50Tm9kZSEuaW5zZXJ0QmVmb3JlKHByZVdyYXBwZXIsIHByZUVsZW1lbnQpXG4gICAgcHJlV3JhcHBlci5hcHBlbmRDaGlsZChwcmVFbGVtZW50KVxuICB9XG4gIHJldHVybiBkb21GcmFnbWVudFxufVxuIl19