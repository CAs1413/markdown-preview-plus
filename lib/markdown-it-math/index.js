"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const table_1 = require("./lib/table");
function scanDelims(state, start, delimLength) {
    let pos = start;
    let lastChar;
    let nextChar;
    let count;
    let canOpen;
    let canClose;
    let isLastWhiteSpace;
    let isLastPunctChar;
    let isNextWhiteSpace;
    let isNextPunctChar;
    let leftFlanking = true;
    let rightFlanking = true;
    const max = state.posMax;
    const isWhiteSpace = state.md.utils.isWhiteSpace;
    const isPunctChar = state.md.utils.isPunctChar;
    const isMdAsciiPunct = state.md.utils.isMdAsciiPunct;
    lastChar = start > 0 ? state.src.charCodeAt(start - 1) : 0x20;
    if (pos >= max) {
        canOpen = false;
    }
    pos += delimLength;
    count = pos - start;
    nextChar = pos < max ? state.src.charCodeAt(pos) : 0x20;
    isLastPunctChar =
        isMdAsciiPunct(lastChar) || isPunctChar(String.fromCharCode(lastChar));
    isNextPunctChar =
        isMdAsciiPunct(nextChar) || isPunctChar(String.fromCharCode(nextChar));
    isLastWhiteSpace = isWhiteSpace(lastChar);
    isNextWhiteSpace = isWhiteSpace(nextChar);
    if (isNextWhiteSpace) {
        leftFlanking = false;
    }
    else if (isNextPunctChar) {
        if (!(isLastWhiteSpace || isLastPunctChar)) {
            leftFlanking = false;
        }
    }
    if (isLastWhiteSpace) {
        rightFlanking = false;
    }
    else if (isLastPunctChar) {
        if (!(isNextWhiteSpace || isNextPunctChar)) {
            rightFlanking = false;
        }
    }
    canOpen = leftFlanking;
    canClose = rightFlanking;
    return {
        can_open: canOpen,
        can_close: canClose,
        delims: count,
    };
}
function makeMath_inline(delims) {
    return function math_inline(state, silent) {
        let startCount;
        let found;
        let res;
        let token;
        let closeDelim;
        const max = state.posMax;
        const start = state.pos;
        const foundDelims = delims.find(function (i) {
            const open = i[0];
            const openDelim = state.src.slice(start, start + open.length);
            return openDelim === open;
        });
        if (!foundDelims) {
            return false;
        }
        const open = foundDelims[0];
        const close = foundDelims[1];
        if (silent) {
            return false;
        }
        res = scanDelims(state, start, open.length);
        startCount = res.delims;
        if (!res.can_open) {
            state.pos += startCount;
            state.pending += state.src.slice(start, state.pos);
            return true;
        }
        state.pos = start + open.length;
        while (state.pos < max) {
            closeDelim = state.src.slice(state.pos, state.pos + close.length);
            if (closeDelim === close) {
                res = scanDelims(state, state.pos, close.length);
                if (res.can_close) {
                    found = true;
                    break;
                }
            }
            state.md.inline.skipToken(state);
        }
        if (!found) {
            state.pos = start;
            return false;
        }
        state.posMax = state.pos;
        state.pos = start + close.length;
        token = state.push('math_inline', 'math', 0);
        token.content = state.src.slice(state.pos, state.posMax);
        token.markup = open;
        state.pos = state.posMax + close.length;
        state.posMax = max;
        return true;
    };
}
function makeMath_block(delims) {
    return function math_block(state, startLine, endLine, silent) {
        let len;
        let nextLine;
        let token;
        let firstLine;
        let lastLine;
        let lastLinePos;
        let closeDelim;
        let haveEndMarker = false;
        let closeStartsAtNewline = false;
        let pos = state.bMarks[startLine] + state.tShift[startLine];
        let max = state.eMarks[startLine];
        const foundDelims = delims.find(function (i) {
            const open = i[0];
            const openDelim = state.src.slice(pos, pos + open.length);
            return openDelim === open;
        });
        if (!foundDelims) {
            return false;
        }
        const open = foundDelims[0];
        let close = foundDelims[1];
        if (close[0] === '\n') {
            closeStartsAtNewline = true;
            close = close.slice(1);
        }
        if (pos + open.length > max + 1) {
            return false;
        }
        pos += open.length;
        firstLine = state.src.slice(pos, max);
        if (silent) {
            return true;
        }
        if (firstLine.trim().slice(-close.length) === close) {
            firstLine = firstLine.trim().slice(0, -close.length);
            haveEndMarker = true;
        }
        nextLine = startLine;
        for (;;) {
            if (haveEndMarker) {
                break;
            }
            nextLine++;
            if (nextLine >= endLine) {
                break;
            }
            pos = state.bMarks[nextLine] + state.tShift[nextLine];
            max = state.eMarks[nextLine];
            if (pos < max && state.tShift[nextLine] < state.blkIndent) {
                break;
            }
            closeDelim = closeStartsAtNewline
                ? state.src.slice(pos, max).trim()
                : state.src
                    .slice(pos, max)
                    .trim()
                    .slice(-close.length);
            if (closeDelim !== close) {
                continue;
            }
            if (state.tShift[nextLine] - state.blkIndent >= 4) {
                continue;
            }
            lastLinePos = state.src.slice(0, max).lastIndexOf(close);
            lastLine = state.src.slice(pos, lastLinePos);
            pos += lastLine.length + close.length;
            pos = state.skipSpaces(pos);
            if (pos < max) {
                continue;
            }
            haveEndMarker = true;
        }
        len = state.tShift[startLine];
        state.line = nextLine + (haveEndMarker ? 1 : 0);
        token = state.push('math_block', 'math', 0);
        token.block = true;
        token.content =
            (firstLine && firstLine.trim() ? firstLine + '\n' : '') +
                state.getLines(startLine + 1, nextLine, len, true) +
                (lastLine && lastLine.trim() ? lastLine : '');
        token.map = [startLine, state.line];
        token.markup = open;
        return true;
    };
}
function makeMathRenderer(renderingOptions = {}) {
    return renderingOptions.display === 'block'
        ? function (tokens, idx) {
            return '<div class="math block">' + tokens[idx].content + '</div>\n';
        }
        : function (tokens, idx) {
            return '<span class="math inline">' + tokens[idx].content + '</span>';
        };
}
function math_plugin(md, options = {}) {
    const inlineDelim = options.inlineDelim || [['$$', '$$']];
    const blockDelim = options.blockDelim || [['$$$', '$$$']];
    const oInlineRenderer = options.inlineRenderer;
    const oBlockRenderer = options.blockRenderer;
    const inlineRenderer = oInlineRenderer
        ? function (tokens, idx) {
            return oInlineRenderer(tokens[idx].content);
        }
        : makeMathRenderer(options.renderingOptions);
    const blockRenderer = oBlockRenderer
        ? function (tokens, idx) {
            return oBlockRenderer(tokens[idx].content) + '\n';
        }
        : makeMathRenderer(Object.assign({ display: 'block' }, options.renderingOptions));
    const mathInline = makeMath_inline(inlineDelim);
    const mathBlock = makeMath_block(blockDelim);
    md.inline.ruler.before('escape', 'math_inline', mathInline);
    md.block.ruler.after('blockquote', 'math_block', mathBlock, {
        alt: ['paragraph', 'reference', 'blockquote', 'list'],
    });
    md.renderer.rules.math_inline = inlineRenderer;
    md.renderer.rules.math_block = blockRenderer;
    const tableBlock = table_1.makeTable({
        inlineDelim,
        blockDelim,
    });
    md.block.ruler.at('table', tableBlock, {
        alt: ['paragraph', 'reference'],
    });
}
exports.math_plugin = math_plugin;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvbWFya2Rvd24taXQtbWF0aC9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUlBLHVDQUF1QztBQUV2QyxvQkFBb0IsS0FBVSxFQUFFLEtBQWEsRUFBRSxXQUFtQjtJQUNoRSxJQUFJLEdBQUcsR0FBRyxLQUFLLENBQUE7SUFDZixJQUFJLFFBQVEsQ0FBQTtJQUNaLElBQUksUUFBUSxDQUFBO0lBQ1osSUFBSSxLQUFLLENBQUE7SUFDVCxJQUFJLE9BQU8sQ0FBQTtJQUNYLElBQUksUUFBUSxDQUFBO0lBQ1osSUFBSSxnQkFBZ0IsQ0FBQTtJQUNwQixJQUFJLGVBQWUsQ0FBQTtJQUNuQixJQUFJLGdCQUFnQixDQUFBO0lBQ3BCLElBQUksZUFBZSxDQUFBO0lBQ25CLElBQUksWUFBWSxHQUFHLElBQUksQ0FBQTtJQUN2QixJQUFJLGFBQWEsR0FBRyxJQUFJLENBQUE7SUFDeEIsTUFBTSxHQUFHLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQTtJQUN4QixNQUFNLFlBQVksR0FBRyxLQUFLLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUE7SUFDaEQsTUFBTSxXQUFXLEdBQUcsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFBO0lBQzlDLE1BQU0sY0FBYyxHQUFHLEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLGNBQWMsQ0FBQTtJQUdwRCxRQUFRLEdBQUcsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUE7SUFFN0QsSUFBSSxHQUFHLElBQUksR0FBRyxFQUFFO1FBQ2QsT0FBTyxHQUFHLEtBQUssQ0FBQTtLQUNoQjtJQUVELEdBQUcsSUFBSSxXQUFXLENBQUE7SUFFbEIsS0FBSyxHQUFH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RSxVQUFVLENBQUMsQ0FBQTtJQUMzRCxFQUFFLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsWUFBWSxFQUFFLFlBQVksRUFBRSxTQUFTLEVBQUU7UUFDMUQsR0FBRyxFQUFFLENBQUMsV0FBVyxFQUFFLFdBQVcsRUFBRSxZQUFZLEVBQUUsTUFBTSxDQUFDO0tBQ3RELENBQUMsQ0FBQTtJQUNGLEVBQUUsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLFdBQVcsR0FBRyxjQUFjLENBQUE7SUFDOUMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsVUFBVSxHQUFHLGFBQWEsQ0FBQTtJQUc1QyxNQUFNLFVBQVUsR0FBRyxpQkFBUyxDQUFDO1FBQzNCLFdBQVc7UUFDWCxVQUFVO0tBQ1gsQ0FBQyxDQUFBO0lBQ0YsRUFBRSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxVQUFVLEVBQUU7UUFDckMsR0FBRyxFQUFFLENBQUMsV0FBVyxFQUFFLFdBQVcsQ0FBQztLQUNoQyxDQUFDLENBQUE7QUFDSixDQUFDO0FBckNELGtDQXFDQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIFByb2Nlc3MgaW5saW5lIG1hdGggKi9cbi8vIHRzbGludDpkaXNhYmxlOm5vLXVuc2FmZS1hbnlcblxuaW1wb3J0ICogYXMgbWRJdCBmcm9tICdtYXJrZG93bi1pdCdcbmltcG9ydCB7IG1ha2VUYWJsZSB9IGZyb20gJy4vbGliL3RhYmxlJ1xuXG5mdW5jdGlvbiBzY2FuRGVsaW1zKHN0YXRlOiBhbnksIHN0YXJ0OiBudW1iZXIsIGRlbGltTGVuZ3RoOiBudW1iZXIpIHtcbiAgbGV0IHBvcyA9IHN0YXJ0XG4gIGxldCBsYXN0Q2hhclxuICBsZXQgbmV4dENoYXJcbiAgbGV0IGNvdW50XG4gIGxldCBjYW5PcGVuXG4gIGxldCBjYW5DbG9zZVxuICBsZXQgaXNMYXN0V2hpdGVTcGFjZVxuICBsZXQgaXNMYXN0UHVuY3RDaGFyXG4gIGxldCBpc05leHRXaGl0ZVNwYWNlXG4gIGxldCBpc05leHRQdW5jdENoYXJcbiAgbGV0IGxlZnRGbGFua2luZyA9IHRydWVcbiAgbGV0IHJpZ2h0RmxhbmtpbmcgPSB0cnVlXG4gIGNvbnN0IG1heCA9IHN0YXRlLnBvc01heFxuICBjb25zdCBpc1doaXRlU3BhY2UgPSBzdGF0ZS5tZC51dGlscy5pc1doaXRlU3BhY2VcbiAgY29uc3QgaXNQdW5jdENoYXIgPSBzdGF0ZS5tZC51dGlscy5pc1B1bmN0Q2hhclxuICBjb25zdCBpc01kQXNjaWlQdW5jdCA9IHN0YXRlLm1kLnV0aWxzLmlzTWRBc2NpaVB1bmN0XG5cbiAgLy8gdHJlYXQgYmVnaW5uaW5nIG9mIHRoZSBsaW5lIGFzIGEgd2hpdGVzcGFjZVxuICBsYXN0Q2hhciA9IHN0YXJ0ID4gMCA/IHN0YXRlLnNyYy5jaGFyQ29kZUF0KHN0YXJ0IC0gMSkgOiAweDIwXG5cbiAgaWYgKHBvcyA+PSBtYXgpIHtcbiAgICBjYW5PcGVuID0gZmFsc2VcbiAgfVxuXG4gIHBvcyArPSBkZWxpbUxlbmd0aFxuXG4gIGNvdW50ID0gcG9zIC0gc3RhcnRcblxuICAvLyB0cmVhdCBlbmQgb2YgdGhlIGxpbmUgYXMgYSB3aGl0ZXNwYWNlXG4gIG5leHRDaGFyID0gcG9zIDwgbWF4ID8gc3RhdGUuc3JjLmNoYXJDb2RlQXQocG9zKSA6IDB4MjBcblxuICBpc0xhc3RQdW5jdENoYXIgPVxuICAgIGlzTWRBc2NpaVB1bmN0KGxhc3RDaGFyKSB8fCBpc1B1bmN0Q2hhcihTdHJpbmcuZnJvbUNoYXJDb2RlKGxhc3RDaGFyKSlcbiAgaXNOZXh0UHVuY3RDaGFyID1cbiAgICBpc01kQXNjaWlQdW5jdChuZXh0Q2hhcikgfHwgaXNQdW5jdENoYXIoU3RyaW5nLmZyb21DaGFyQ29kZShuZXh0Q2hhcikpXG5cbiAgaXNMYXN0V2hpdGVTcGFjZSA9IGlzV2hpdGVTcGFjZShsYXN0Q2hhcilcbiAgaXNOZXh0V2hpdGVTcGFjZSA9IGlzV2hpdGVTcGFjZShuZXh0Q2hhcilcblxuICBpZiAoaXNOZXh0V2hpdGVTcGFjZSkge1xuICAgIGxlZnRGbGFua2luZyA9IGZhbHNlXG4gIH0gZWxzZSBpZiAoaXNOZXh0UHVuY3RDaGFyKSB7XG4gICAgaWYgKCEoaXNMYXN0V2hpdGVTcGFjZSB8fCBpc0xhc3RQdW5jdENoYXIpKSB7XG4gICAgICBsZWZ0RmxhbmtpbmcgPSBmYWxzZVxuICAgIH1cbiAgfVxuXG4gIGlmIChpc0xhc3RXaGl0ZVNwYWNlKSB7XG4gICAgcmlnaHRGbGFua2luZyA9IGZhbHNlXG4gIH0gZWxzZSBpZiAoaXNMYXN0UHVuY3RDaGFyKSB7XG4gICAgaWYgKCEoaXNOZXh0V2hpdGVTcGFjZSB8fCBpc05leHRQdW5jdENoYXIpKSB7XG4gICAgICByaWdodEZsYW5raW5nID0gZmFsc2VcbiAgICB9XG4gIH1cblxuICBjYW5PcGVuID0gbGVmdEZsYW5raW5nXG4gIGNhbkNsb3NlID0gcmlnaHRGbGFua2luZ1xuXG4gIHJldHVybiB7XG4gICAgY2FuX29wZW46IGNhbk9wZW4sXG4gICAgY2FuX2Nsb3NlOiBjYW5DbG9zZSxcbiAgICBkZWxpbXM6IGNvdW50LFxuICB9XG59XG5cbmZ1bmN0aW9uIG1ha2VNYXRoX2lubGluZShkZWxpbXM6IFtbc3RyaW5nLCBzdHJpbmddXSkge1xuICByZXR1cm4gZnVuY3Rpb24gbWF0aF9pbmxpbmUoc3RhdGU6IGFueSwgc2lsZW50OiBib29sZWFuKSB7XG4gICAgbGV0IHN0YXJ0Q291bnRcbiAgICBsZXQgZm91bmRcbiAgICBsZXQgcmVzXG4gICAgbGV0IHRva2VuXG4gICAgbGV0IGNsb3NlRGVsaW1cbiAgICBjb25zdCBtYXggPSBzdGF0ZS5wb3NNYXggYXMgbnVtYmVyXG4gICAgY29uc3Qgc3RhcnQgPSBzdGF0ZS5wb3MgYXMgbnVtYmVyXG4gICAgY29uc3QgZm91bmREZWxpbXMgPSBkZWxpbXMuZmluZChmdW5jdGlvbihpKSB7XG4gICAgICBjb25zdCBvcGVuID0gaVswXVxuICAgICAgY29uc3Qgb3BlbkRlbGltID0gc3RhdGUuc3JjLnNsaWNlKHN0YXJ0LCBzdGFydCArIG9wZW4ubGVuZ3RoKSBhcyBzdHJpbmdcbiAgICAgIHJldHVybiBvcGVuRGVsaW0gPT09IG9wZW5cbiAgICB9KVxuICAgIGlmICghZm91bmREZWxpbXMpIHtcbiAgICAgIHJldHVybiBmYWxzZVxuICAgIH1cbiAgICBjb25zdCBvcGVuID0gZm91bmREZWxpbXNbMF1cbiAgICBjb25zdCBjbG9zZSA9IGZvdW5kRGVsaW1zWzFdXG4gICAgaWYgKHNpbGVudCkge1xuICAgICAgcmV0dXJuIGZhbHNlXG4gICAgfSAvLyBEb27igJl0IHJ1biBhbnkgcGFpcnMgaW4gdmFsaWRhdGlvbiBtb2RlXG5cbiAgICByZXMgPSBzY2FuRGVsaW1zKHN0YXRlLCBzdGFydCwgb3Blbi5sZW5ndGgpXG4gICAgc3RhcnRDb3VudCA9IHJlcy5kZWxpbXNcblxuICAgIGlmICghcmVzLmNhbl9vcGVuKSB7XG4gICAgICBzdGF0ZS5wb3MgKz0gc3RhcnRDb3VudFxuICAgICAgLy8gRWFybGllciB3ZSBjaGVja2VkICFzaWxlbnQsIGJ1dCB0aGlzIGltcGxlbWVudGF0aW9uIGRvZXMgbm90IG5lZWQgaXRcbiAgICAgIHN0YXRlLnBlbmRpbmcgKz0gc3RhdGUuc3JjLnNsaWNlKHN0YXJ0LCBzdGF0ZS5wb3MpXG4gICAgICByZXR1cm4gdHJ1ZVxuICAgIH1cblxuICAgIHN0YXRlLnBvcyA9IHN0YXJ0ICsgb3Blbi5sZW5ndGhcblxuICAgIHdoaWxlIChzdGF0ZS5wb3MgPCBtYXgpIHtcbiAgICAgIGNsb3NlRGVsaW0gPSBzdGF0ZS5zcmMuc2xpY2Uoc3RhdGUucG9zLCBzdGF0ZS5wb3MgKyBjbG9zZS5sZW5ndGgpXG4gICAgICBpZiAoY2xvc2VEZWxpbSA9PT0gY2xvc2UpIHtcbiAgICAgICAgcmVzID0gc2NhbkRlbGltcyhzdGF0ZSwgc3RhdGUucG9zLCBjbG9zZS5sZW5ndGgpXG4gICAgICAgIGlmIChyZXMuY2FuX2Nsb3NlKSB7XG4gICAgICAgICAgZm91bmQgPSB0cnVlXG4gICAgICAgICAgYnJlYWtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBzdGF0ZS5tZC5pbmxpbmUuc2tpcFRva2VuKHN0YXRlKVxuICAgIH1cblxuICAgIGlmICghZm91bmQpIHtcbiAgICAgIC8vIFBhcnNlciBmYWlsZWQgdG8gZmluZCBlbmRpbmcgdGFnLCBzbyBpdCBpcyBub3QgYSB2YWxpZCBtYXRoXG4gICAgICBzdGF0ZS5wb3MgPSBzdGFydFxuICAgICAgcmV0dXJuIGZhbHNlXG4gICAgfVxuXG4gICAgLy8gRm91bmQhXG4gICAgc3RhdGUucG9zTWF4ID0gc3RhdGUucG9zXG4gICAgc3RhdGUucG9zID0gc3RhcnQgKyBjbG9zZS5sZW5ndGhcblxuICAgIC8vIEVhcmxpZXIgd2UgY2hlY2tlZCAhc2lsZW50LCBidXQgdGhpcyBpbXBsZW1lbnRhdGlvbiBkb2VzIG5vdCBuZWVkIGl0XG4gICAgdG9rZW4gPSBzdGF0ZS5wdXNoKCdtYXRoX2lubGluZScsICdtYXRoJywgMClcbiAgICB0b2tlbi5jb250ZW50ID0gc3RhdGUuc3JjLnNsaWNlKHN0YXRlLnBvcywgc3RhdGUucG9zTWF4KVxuICAgIHRva2VuLm1hcmt1cCA9IG9wZW5cblxuICAgIHN0YXRlLnBvcyA9IHN0YXRlLnBvc01heCArIGNsb3NlLmxlbmd0aFxuICAgIHN0YXRlLnBvc01heCA9IG1heFxuXG4gICAgcmV0dXJuIHRydWVcbiAgfVxufVxuXG5mdW5jdGlvbiBtYWtlTWF0aF9ibG9jayhkZWxpbXM6IFtbc3RyaW5nLCBzdHJpbmddXSkge1xuICByZXR1cm4gZnVuY3Rpb24gbWF0aF9ibG9jayhcbiAgICBzdGF0ZTogYW55LFxuICAgIHN0YXJ0TGluZTogbnVtYmVyLFxuICAgIGVuZExpbmU6IG51bWJlcixcbiAgICBzaWxlbnQ6IGJvb2xlYW4sXG4gICkge1xuICAgIGxldCBsZW5cbiAgICBsZXQgbmV4dExpbmVcbiAgICBsZXQgdG9rZW5cbiAgICBsZXQgZmlyc3RMaW5lOiBzdHJpbmdcbiAgICBsZXQgbGFzdExpbmVcbiAgICBsZXQgbGFzdExpbmVQb3NcbiAgICBsZXQgY2xvc2VEZWxpbVxuICAgIGxldCBoYXZlRW5kTWFya2VyID0gZmFsc2VcbiAgICBsZXQgY2xvc2VTdGFydHNBdE5ld2xpbmUgPSBmYWxzZVxuICAgIGxldCBwb3M6IG51bWJlciA9IHN0YXRlLmJNYXJrc1tzdGFydExpbmVdICsgc3RhdGUudFNoaWZ0W3N0YXJ0TGluZV1cbiAgICBsZXQgbWF4OiBudW1iZXIgPSBzdGF0ZS5lTWFya3Nbc3RhcnRMaW5lXVxuXG4gICAgY29uc3QgZm91bmREZWxpbXMgPSBkZWxpbXMuZmluZChmdW5jdGlvbihpKSB7XG4gICAgICBjb25zdCBvcGVuID0gaVswXVxuICAgICAgY29uc3Qgb3BlbkRlbGltID0gc3RhdGUuc3JjLnNsaWNlKHBvcywgcG9zICsgb3Blbi5sZW5ndGgpXG4gICAgICByZXR1cm4gb3BlbkRlbGltID09PSBvcGVuXG4gICAgfSlcbiAgICBpZiAoIWZvdW5kRGVsaW1zKSB7XG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG4gICAgY29uc3Qgb3BlbiA9IGZvdW5kRGVsaW1zWzBdXG4gICAgbGV0IGNsb3NlID0gZm91bmREZWxpbXNbMV1cblxuICAgIGlmIChjbG9zZVswXSA9PT0gJ1xcbicpIHtcbiAgICAgIGNsb3NlU3RhcnRzQXROZXdsaW5lID0gdHJ1ZVxuICAgICAgY2xvc2UgPSBjbG9zZS5zbGljZSgxKVxuICAgIH1cblxuICAgIGlmIChwb3MgKyBvcGVuLmxlbmd0aCA+IG1heCArIDEpIHtcbiAgICAgIHJldHVybiBmYWxzZVxuICAgIH1cblxuICAgIHBvcyArPSBvcGVuLmxlbmd0aFxuICAgIGZpcnN0TGluZSA9IHN0YXRlLnNyYy5zbGljZShwb3MsIG1heClcblxuICAgIC8vIFNpbmNlIHN0YXJ0IGlzIGZvdW5kLCB3ZSBjYW4gcmVwb3J0IHN1Y2Nlc3MgaGVyZSBpbiB2YWxpZGF0aW9uIG1vZGVcbiAgICBpZiAoc2lsZW50KSB7XG4gICAgICByZXR1cm4gdHJ1ZVxuICAgIH1cblxuICAgIGlmIChmaXJzdExpbmUudHJpbSgpLnNsaWNlKC1jbG9zZS5sZW5ndGgpID09PSBjbG9zZSkge1xuICAgICAgLy8gU2luZ2xlIGxpbmUgZXhwcmVzc2lvblxuICAgICAgZmlyc3RMaW5lID0gZmlyc3RMaW5lLnRyaW0oKS5zbGljZSgwLCAtY2xvc2UubGVuZ3RoKVxuICAgICAgaGF2ZUVuZE1hcmtlciA9IHRydWVcbiAgICB9XG5cbiAgICAvLyBzZWFyY2ggZW5kIG9mIGJsb2NrXG4gICAgbmV4dExpbmUgPSBzdGFydExpbmVcblxuICAgIGZvciAoOzspIHtcbiAgICAgIGlmIChoYXZlRW5kTWFya2VyKSB7XG4gICAgICAgIGJyZWFrXG4gICAgICB9XG5cbiAgICAgIG5leHRMaW5lKytcblxuICAgICAgaWYgKG5leHRMaW5lID49IGVuZExpbmUpIHtcbiAgICAgICAgLy8gdW5jbG9zZWQgYmxvY2sgc2hvdWxkIGJlIGF1dG9jbG9zZWQgYnkgZW5kIG9mIGRvY3VtZW50LlxuICAgICAgICAvLyBhbHNvIGJsb2NrIHNlZW1zIHRvIGJlIGF1dG9jbG9zZWQgYnkgZW5kIG9mIHBhcmVudFxuICAgICAgICBicmVha1xuICAgICAgfVxuXG4gICAgICBwb3MgPSBzdGF0ZS5iTWFya3NbbmV4dExpbmVdICsgc3RhdGUudFNoaWZ0W25leHRMaW5lXVxuICAgICAgbWF4ID0gc3RhdGUuZU1hcmtzW25leHRMaW5lXVxuXG4gICAgICBpZiAocG9zIDwgbWF4ICYmIHN0YXRlLnRTaGlmdFtuZXh0TGluZV0gPCBzdGF0ZS5ibGtJbmRlbnQpIHtcbiAgICAgICAgLy8gbm9uLWVtcHR5IGxpbmUgd2l0aCBuZWdhdGl2ZSBpbmRlbnQgc2hvdWxkIHN0b3AgdGhlIGxpc3Q6XG4gICAgICAgIGJyZWFrXG4gICAgICB9XG5cbiAgICAgIGNsb3NlRGVsaW0gPSBjbG9zZVN0YXJ0c0F0TmV3bGluZVxuICAgICAgICA/IHN0YXRlLnNyYy5zbGljZShwb3MsIG1heCkudHJpbSgpXG4gICAgICAgIDogc3RhdGUuc3JjXG4gICAgICAgICAgICAuc2xpY2UocG9zLCBtYXgpXG4gICAgICAgICAgICAudHJpbSgpXG4gICAgICAgICAgICAuc2xpY2UoLWNsb3NlLmxlbmd0aClcblxuICAgICAgaWYgKGNsb3NlRGVsaW0gIT09IGNsb3NlKSB7XG4gICAgICAgIGNvbnRpbnVlXG4gICAgICB9XG5cbiAgICAgIGlmIChzdGF0ZS50U2hpZnRbbmV4dExpbmVdIC0gc3RhdGUuYmxrSW5kZW50ID49IDQpIHtcbiAgICAgICAgLy8gY2xvc2luZyBibG9jayBtYXRoIHNob3VsZCBiZSBpbmRlbnRlZCBsZXNzIHRoZW4gNCBzcGFjZXNcbiAgICAgICAgY29udGludWVcbiAgICAgIH1cblxuICAgICAgbGFzdExpbmVQb3MgPSBzdGF0ZS5zcmMuc2xpY2UoMCwgbWF4KS5sYXN0SW5kZXhPZihjbG9zZSlcbiAgICAgIGxhc3RMaW5lID0gc3RhdGUuc3JjLnNsaWNlKHBvcywgbGFzdExpbmVQb3MpXG5cbiAgICAgIHBvcyArPSBsYXN0TGluZS5sZW5ndGggKyBjbG9zZS5sZW5ndGhcblxuICAgICAgLy8gbWFrZSBzdXJlIHRhaWwgaGFzIHNwYWNlcyBvbmx5XG4gICAgICBwb3MgPSBzdGF0ZS5za2lwU3BhY2VzKHBvcylcblxuICAgICAgaWYgKHBvcyA8IG1heCkge1xuICAgICAgICBjb250aW51ZVxuICAgICAgfVxuXG4gICAgICAvLyBmb3VuZCFcbiAgICAgIGhhdmVFbmRNYXJrZXIgPSB0cnVlXG4gICAgfVxuXG4gICAgLy8gSWYgbWF0aCBibG9jayBoYXMgaGVhZGluZyBzcGFjZXMsIHRoZXkgc2hvdWxkIGJlIHJlbW92ZWQgZnJvbSBpdHMgaW5uZXIgYmxvY2tcbiAgICBsZW4gPSBzdGF0ZS50U2hpZnRbc3RhcnRMaW5lXVxuXG4gICAgc3RhdGUubGluZSA9IG5leHRMaW5lICsgKGhhdmVFbmRNYXJrZXIgPyAxIDogMClcblxuICAgIHRva2VuID0gc3RhdGUucHVzaCgnbWF0aF9ibG9jaycsICdtYXRoJywgMClcbiAgICB0b2tlbi5ibG9jayA9IHRydWVcbiAgICB0b2tlbi5jb250ZW50ID1cbiAgICAgIChmaXJzdExpbmUgJiYgZmlyc3RMaW5lLnRyaW0oKSA/IGZpcnN0TGluZSArICdcXG4nIDogJycpICtcbiAgICAgIHN0YXRlLmdldExpbmVzKHN0YXJ0TGluZSArIDEsIG5leHRMaW5lLCBsZW4sIHRydWUpICtcbiAgICAgIChsYXN0TGluZSAmJiBsYXN0TGluZS50cmltKCkgPyBsYXN0TGluZSA6ICcnKVxuICAgIHRva2VuLm1hcCA9IFtzdGFydExpbmUsIHN0YXRlLmxpbmVdXG4gICAgdG9rZW4ubWFya3VwID0gb3BlblxuXG4gICAgcmV0dXJuIHRydWVcbiAgfVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIFJlbmRlcmluZ09wdGlvbnMge1xuICBkaXNwbGF5PzogJ2Jsb2NrJ1xufVxuXG5mdW5jdGlvbiBtYWtlTWF0aFJlbmRlcmVyKHJlbmRlcmluZ09wdGlvbnM6IFJlbmRlcmluZ09wdGlvbnMgPSB7fSkge1xuICByZXR1cm4gcmVuZGVyaW5nT3B0aW9ucy5kaXNwbGF5ID09PSAnYmxvY2snXG4gICAgPyBmdW5jdGlvbih0b2tlbnM6IG1kSXQuVG9rZW5bXSwgaWR4OiBudW1iZXIpIHtcbiAgICAgICAgcmV0dXJuICc8ZGl2IGNsYXNzPVwibWF0aCBibG9ja1wiPicgKyB0b2tlbnNbaWR4XS5jb250ZW50ICsgJzwvZGl2PlxcbidcbiAgICAgIH1cbiAgICA6IGZ1bmN0aW9uKHRva2VuczogbWRJdC5Ub2tlbltdLCBpZHg6IG51bWJlcikge1xuICAgICAgICByZXR1cm4gJzxzcGFuIGNsYXNzPVwibWF0aCBpbmxpbmVcIj4nICsgdG9rZW5zW2lkeF0uY29udGVudCArICc8L3NwYW4+J1xuICAgICAgfVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIFBsdWdpbk9wdGlvbnMge1xuICBpbmxpbmVEZWxpbT86IFtbc3RyaW5nLCBzdHJpbmddXVxuICBibG9ja0RlbGltPzogW1tzdHJpbmcsIHN0cmluZ11dXG4gIGlubGluZVJlbmRlcmVyPzogKGRhdGE6IHN0cmluZykgPT4gc3RyaW5nXG4gIGJsb2NrUmVuZGVyZXI/OiAoZGF0YTogc3RyaW5nKSA9PiBzdHJpbmdcbiAgcmVuZGVyaW5nT3B0aW9ucz86IFJlbmRlcmluZ09wdGlvbnNcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1hdGhfcGx1Z2luKG1kOiBtZEl0Lk1hcmtkb3duSXQsIG9wdGlvbnM6IFBsdWdpbk9wdGlvbnMgPSB7fSkge1xuICAvLyBEZWZhdWx0IG9wdGlvbnNcbiAgY29uc3QgaW5saW5lRGVsaW0gPSBvcHRpb25zLmlubGluZURlbGltIHx8IFtbJyQkJywgJyQkJ11dXG4gIGNvbnN0IGJsb2NrRGVsaW0gPSBvcHRpb25zLmJsb2NrRGVsaW0gfHwgW1snJCQkJywgJyQkJCddXVxuICBjb25zdCBvSW5saW5lUmVuZGVyZXIgPSBvcHRpb25zLmlubGluZVJlbmRlcmVyXG4gIGNvbnN0IG9CbG9ja1JlbmRlcmVyID0gb3B0aW9ucy5ibG9ja1JlbmRlcmVyXG4gIGNvbnN0IGlubGluZVJlbmRlcmVyID0gb0lubGluZVJlbmRlcmVyXG4gICAgPyBmdW5jdGlvbih0b2tlbnM6IG1kSXQuVG9rZW5bXSwgaWR4OiBudW1iZXIpIHtcbiAgICAgICAgcmV0dXJuIG9JbmxpbmVSZW5kZXJlcih0b2tlbnNbaWR4XS5jb250ZW50KVxuICAgICAgfVxuICAgIDogbWFrZU1hdGhSZW5kZXJlcihvcHRpb25zLnJlbmRlcmluZ09wdGlvbnMpXG4gIGNvbnN0IGJsb2NrUmVuZGVyZXIgPSBvQmxvY2tSZW5kZXJlclxuICAgID8gZnVuY3Rpb24odG9rZW5zOiBtZEl0LlRva2VuW10sIGlkeDogbnVtYmVyKSB7XG4gICAgICAgIHJldHVybiBvQmxvY2tSZW5kZXJlcih0b2tlbnNbaWR4XS5jb250ZW50KSArICdcXG4nXG4gICAgICB9XG4gICAgOiBtYWtlTWF0aFJlbmRlcmVyKFxuICAgICAgICBPYmplY3QuYXNzaWduKHsgZGlzcGxheTogJ2Jsb2NrJyB9LCBvcHRpb25zLnJlbmRlcmluZ09wdGlvbnMpLFxuICAgICAgKVxuXG4gIGNvbnN0IG1hdGhJbmxpbmUgPSAobWFrZU1hdGhfaW5saW5lKGlubGluZURlbGltKSBhcyBhbnkpIGFzIG1kSXQuUnVsZVxuICBjb25zdCBtYXRoQmxvY2sgPSAobWFrZU1hdGhfYmxvY2soYmxvY2tEZWxpbSkgYXMgYW55KSBhcyBtZEl0LlJ1bGVcblxuICBtZC5pbmxpbmUucnVsZXIuYmVmb3JlKCdlc2NhcGUnLCAnbWF0aF9pbmxpbmUnLCBtYXRoSW5saW5lKVxuICBtZC5ibG9jay5ydWxlci5hZnRlcignYmxvY2txdW90ZScsICdtYXRoX2Jsb2NrJywgbWF0aEJsb2NrLCB7XG4gICAgYWx0OiBbJ3BhcmFncmFwaCcsICdyZWZlcmVuY2UnLCAnYmxvY2txdW90ZScsICdsaXN0J10sXG4gIH0pXG4gIG1kLnJlbmRlcmVyLnJ1bGVzLm1hdGhfaW5saW5lID0gaW5saW5lUmVuZGVyZXJcbiAgbWQucmVuZGVyZXIucnVsZXMubWF0aF9ibG9jayA9IGJsb2NrUmVuZGVyZXJcblxuICAvLyBSZXBsYWNlIGV4aXN0aW5nIHRhYmxlIHBhcnNlciB3aXRoIHBhcnNlciB0aGF0IHJlc3BlY3RzIG5ldyBpbmxpbmUgZGVsaW1zXG4gIGNvbnN0IHRhYmxlQmxvY2sgPSBtYWtlVGFibGUoe1xuICAgIGlubGluZURlbGltLFxuICAgIGJsb2NrRGVsaW0sXG4gIH0pXG4gIG1kLmJsb2NrLnJ1bGVyLmF0KCd0YWJsZScsIHRhYmxlQmxvY2ssIHtcbiAgICBhbHQ6IFsncGFyYWdyYXBoJywgJ3JlZmVyZW5jZSddLFxuICB9KVxufVxuIl19