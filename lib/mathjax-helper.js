"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const CSON = require("season");
const fs = require("fs");
const util_1 = require("./util");
let isMathJaxDisabled = false;
function mathProcessor(domElements) {
    if (isMathJaxDisabled)
        return;
    if (window.MathJax) {
        window.MathJax.Hub.Queue(['Typeset', window.MathJax.Hub, domElements]);
    }
    else {
        loadMathJax(() => {
            MathJax.Hub.Queue(['Typeset', MathJax.Hub, domElements]);
        });
    }
}
exports.mathProcessor = mathProcessor;
function processHTMLString(html, callback) {
    if (isMathJaxDisabled) {
        callback(html);
        return;
    }
    const element = document.createElement('div');
    element.innerHTML = html;
    const compileProcessedHTMLString = function () {
        const msvgh = document.getElementById('MathJax_SVG_Hidden');
        const svgGlyphs = msvgh && msvgh.parentNode.cloneNode(true);
        if (svgGlyphs !== null) {
            element.insertBefore(svgGlyphs, element.firstChild);
        }
        return element.innerHTML;
    };
    const queueProcessHTMLString = () => {
        MathJax.Hub.Queue(['setRenderer', MathJax.Hub, 'SVG'], ['Typeset', MathJax.Hub, element], ['setRenderer', MathJax.Hub, 'HTML-CSS'], [
            () => {
                callback(compileProcessedHTMLString());
            },
        ]);
    };
    if (window.MathJax) {
        queueProcessHTMLString();
    }
    else {
        loadMathJax(queueProcessHTMLString);
    }
}
exports.processHTMLString = processHTMLString;
function disableMathJax(disable) {
    isMathJaxDisabled = disable;
}
function loadMathJax(listener) {
    const script = attachMathJax();
    if (listener) {
        script.addEventListener('load', () => {
            listener();
        });
    }
}
function attachMathJax() {
    if (!document.querySelector('script[src*="MathJax.js"]')) {
        return attachMathJaxInternal();
    }
    throw new Error('Duplicate attachMathJax call');
}
function resetMathJax() {
    for (const el of Array.from(document.querySelectorAll('script[src*="MathJax.js"]'))) {
        el.remove();
    }
    window.MathJax = undefined;
    delete window.MathJax;
}
exports.testing = {
    loadMathJax,
    resetMathJax,
    disableMathJax,
};
const namePattern = new RegExp(`\
^[^a-zA-Z\\d\\s]$\
|\
^[a-zA-Z]*$\
`);
function getUserMacrosPath() {
    const userMacrosPath = CSON.resolve(path.join(atom.getConfigDirPath(), 'markdown-preview-plus'));
    return userMacrosPath != null
        ? userMacrosPath
        : path.join(atom.getConfigDirPath(), 'markdown-preview-plus.cson');
}
function loadMacrosFile(filePath) {
    if (!CSON.isObjectPath(filePath)) {
        return {};
    }
    return CSON.readFileSync(filePath, function (error, object) {
        if (object === undefined) {
            object = {};
        }
        if (error !== undefined) {
            console.warn(`Error reading Latex Macros file '${filePath}': ${error.stack !== undefined ? error.stack : error}`);
            atom.notifications.addError(`Failed to load Latex Macros from '${filePath}'`, { detail: error.message, dismissable: true });
        }
        return object;
    });
}
function loadUserMacros() {
    const userMacrosPath = getUserMacrosPath();
    if (util_1.isFileSync(userMacrosPath)) {
        return loadMacrosFile(userMacrosPath);
    }
    else {
        console.debug('Creating markdown-preview-plus.cson, this is a one-time operation.');
        createMacrosTemplate(userMacrosPath);
        return loadMacrosFile(userMacrosPath);
    }
}
function createMacrosTemplate(filePath) {
    const templatePath = path.join(__dirname, '../assets/macros-template.cson');
    const templateFile = fs.readFileSync(templatePath, 'utf8');
    fs.writeFileSync(filePath, templateFile);
}
function checkMacros(macrosObject) {
    for (const name in macrosObject) {
        const value = macrosObject[name];
        if (!name.match(namePattern) || !valueMatchesPattern(value)) {
            delete macrosObject[name];
            atom.notifications.addError(`Failed to load LaTeX macro named '${name}'. Please see the [LaTeX guide](https://github.com/Galadirith/markdown-preview-plus/blob/master/LATEX.md#macro-names)`, { dismissable: true });
        }
    }
    return macrosObject;
}
function valueMatchesPattern(value) {
    if (Array.isArray(value)) {
        const macroDefinition = value[0];
        const numberOfArgs = value[1];
        if (typeof numberOfArgs === 'number') {
            return numberOfArgs % 1 === 0 && typeof macroDefinition === 'string';
        }
        else {
            return false;
        }
    }
    else if (typeof value === 'string') {
        return true;
    }
    else {
        return false;
    }
}
const configureMathJax = function () {
    let userMacros = loadUserMacros();
    if (userMacros) {
        userMacros = checkMacros(userMacros);
    }
    else {
        userMacros = {};
    }
    MathJax.Hub.Config({
        jax: ['input/TeX', 'output/HTML-CSS'],
        extensions: [],
        TeX: {
            extensions: [
                'AMSmath.js',
                'AMSsymbols.js',
                'noErrors.js',
                'noUndefined.js',
            ],
            Macros: userMacros,
        },
        'HTML-CSS': {
            availableFonts: [],
            webFont: 'TeX',
        },
        messageStyle: 'none',
        showMathMenu: false,
        skipStartupTypeset: true,
    });
    MathJax.Hub.Configured();
    if (atom.inDevMode()) {
        atom.notifications.addSuccess('Loaded maths rendering engine MathJax');
    }
};
function attachMathJaxInternal() {
    if (atom.inDevMode()) {
        atom.notifications.addInfo('Loading maths rendering engine MathJax');
    }
    const script = document.createElement('script');
    script.src = `${require.resolve('MathJax')}?delayStartupUntil=configured`;
    script.type = 'text/javascript';
    script.addEventListener('load', () => {
        configureMathJax();
    });
    document.getElementsByTagName('head')[0].appendChild(script);
    return script;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWF0aGpheC1oZWxwZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvbWF0aGpheC1oZWxwZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFhQSw2QkFBNkI7QUFDN0IsK0JBQStCO0FBQy9CLHlCQUF5QjtBQUN6QixpQ0FBbUM7QUFFbkMsSUFBSSxpQkFBaUIsR0FBRyxLQUFLLENBQUE7QUFTN0IsdUJBQThCLFdBQW1CO0lBQy9DLEVBQUUsQ0FBQyxDQUFDLGlCQUFpQixDQUFDO1FBQUMsTUFBTSxDQUFBO0lBQzdCLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1FBQ25CLE1BQU0sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLFNBQVMsRUFBRSxNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxXQUFXLENBQUMsQ0FBQyxDQUFBO0lBQ3hFLENBQUM7SUFBQyxJQUFJLENBQUMsQ0FBQztRQUNOLFdBQVcsQ0FBQyxHQUFHLEVBQUU7WUFDZixPQUFRLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLFNBQVMsRUFBRSxPQUFRLENBQUMsR0FBRyxFQUFFLFdBQVcsQ0FBQyxDQUFDLENBQUE7UUFDNUQsQ0FBQyxDQUFDLENBQUE7SUFDSixDQUFDO0FBQ0gsQ0FBQztBQVRELHNDQVNDO0FBU0QsMkJBQ0UsSUFBWSxFQUNaLFFBQWtDO0lBRWxDLEVBQUUsQ0FBQyxDQUFDLGlCQUFpQixDQUFDLENBQUMsQ0FBQztRQUN0QixRQUFRLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDZCxNQUFNLENBQUE7SUFDUixDQUFDO0lBQ0QsTUFBTSxPQUFPLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQTtJQUM3QyxPQUFPLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQTtJQUV4QixNQUFNLDBCQUEwQixHQUFHO1FBQ2pDLE1BQU0sS0FBSyxHQUFHLFFBQVEsQ0FB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LENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxDQUFBO0lBR3pCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDckIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsdUNBQXVDLENBQUMsQ0FBQTtJQUN4RSxDQUFDO0FBQ0gsQ0FBQyxDQUFBO0FBS0Q7SUFFRSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3JCLElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLHdDQUF3QyxDQUFDLENBQUE7SUFDdEUsQ0FBQztJQUdELE1BQU0sTUFBTSxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUE7SUFDL0MsTUFBTSxDQUFDLEdBQUcsR0FBRyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLCtCQUErQixDQUFBO0lBQ3pFLE1BQU0sQ0FBQyxJQUFJLEdBQUcsaUJBQWlCLENBQUE7SUFDL0IsTUFBTSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUU7UUFDbkMsZ0JBQWdCLEVBQUUsQ0FBQTtJQUNwQixDQUFDLENBQUMsQ0FBQTtJQUNGLFFBQVEsQ0FBQyxvQkFBb0IsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUE7SUFFNUQsTUFBTSxDQUFDLE1BQU0sQ0FBQTtBQUNmLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogZGVjYWZmZWluYXRlIHN1Z2dlc3Rpb25zOlxuICogRFMxMDI6IFJlbW92ZSB1bm5lY2Vzc2FyeSBjb2RlIGNyZWF0ZWQgYmVjYXVzZSBvZiBpbXBsaWNpdCByZXR1cm5zXG4gKiBEUzIwNzogQ29uc2lkZXIgc2hvcnRlciB2YXJpYXRpb25zIG9mIG51bGwgY2hlY2tzXG4gKiBGdWxsIGRvY3M6IGh0dHBzOi8vZ2l0aHViLmNvbS9kZWNhZmZlaW5hdGUvZGVjYWZmZWluYXRlL2Jsb2IvbWFzdGVyL2RvY3Mvc3VnZ2VzdGlvbnMubWRcbiAqL1xuLy9cbi8vIG1hdGhqYXgtaGVscGVyXG4vL1xuLy8gVGhpcyBtb2R1bGUgd2lsbCBoYW5kbGUgbG9hZGluZyB0aGUgTWF0aEpheCBlbnZpcm9ubWVudCBhbmQgcHJvdmlkZSBhIHdyYXBwZXJcbi8vIGZvciBjYWxscyB0byBNYXRoSmF4IHRvIHByb2Nlc3MgTGFUZVggZXF1YXRpb25zLlxuLy9cblxuaW1wb3J0IHBhdGggPSByZXF1aXJlKCdwYXRoJylcbmltcG9ydCBDU09OID0gcmVxdWlyZSgnc2Vhc29uJylcbmltcG9ydCBmcyA9IHJlcXVpcmUoJ2ZzJylcbmltcG9ydCB7IGlzRmlsZVN5bmMgfSBmcm9tICcuL3V0aWwnXG5cbmxldCBpc01hdGhKYXhEaXNhYmxlZCA9IGZhbHNlXG5cbi8vXG4vLyBQcm9jZXNzIERPTSBlbGVtZW50cyBmb3IgTGFUZVggZXF1YXRpb25zIHdpdGggTWF0aEpheFxuLy9cbi8vIEBwYXJhbSBkb21FbGVtZW50cyBBbiBhcnJheSBvZiBET00gZWxlbWVudHMgdG8gYmUgcHJvY2Vzc2VkIGJ5IE1hdGhKYXguIFNlZVxuLy8gICBbZWxlbWVudF0oaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL2VsZW1lbnQpIGZvclxuLy8gICBkZXRhaWxzIG9uIERPTSBlbGVtZW50cy5cbi8vXG5leHBvcnQgZnVuY3Rpb24gbWF0aFByb2Nlc3Nvcihkb21FbGVtZW50czogTm9kZVtdKSB7XG4gIGlmIChpc01hdGhKYXhEaXNhYmxlZCkgcmV0dXJuXG4gIGlmICh3aW5kb3cuTWF0aEpheCkge1xuICAgIHdpbmRvdy5NYXRoSmF4Lkh1Yi5RdWV1ZShbJ1R5cGVzZXQnLCB3aW5kb3cuTWF0aEpheC5IdWIsIGRvbUVsZW1lbnRzXSlcbiAgfSBlbHNlIHtcbiAgICBsb2FkTWF0aEpheCgoKSA9PiB7XG4gICAgICBNYXRoSmF4IS5IdWIuUXVldWUoWydUeXBlc2V0JywgTWF0aEpheCEuSHViLCBkb21FbGVtZW50c10pXG4gICAgfSlcbiAgfVxufVxuXG4vL1xuLy8gUHJvY2VzcyBtYXRocyBpbiBIVE1MIGZyYWdtZW50IHdpdGggTWF0aEpheFxuLy9cbi8vIEBwYXJhbSBodG1sIEEgSFRNTCBmcmFnbWVudCBzdHJpbmdcbi8vIEBwYXJhbSBjYWxsYmFjayBBIGNhbGxiYWNrIG1ldGhvZCB0aGF0IGFjY2VwdHMgYSBzaW5nbGUgcGFyYW1ldGVyLCBhIEhUTUxcbi8vICAgZnJhZ21lbnQgc3RyaW5nIHRoYXQgaXMgdGhlIHJlc3VsdCBvZiBodG1sIHByb2Nlc3NlZCBieSBNYXRoSmF4XG4vL1xuZXhwb3J0IGZ1bmN0aW9uIHByb2Nlc3NIVE1MU3RyaW5nKFxuICBodG1sOiBzdHJpbmcsXG4gIGNhbGxiYWNrOiAocHJvSFRNTDogc3RyaW5nKSA9PiBhbnksXG4pIHtcbiAgaWYgKGlzTWF0aEpheERpc2FibGVkKSB7XG4gICAgY2FsbGJhY2soaHRtbClcbiAgICByZXR1cm5cbiAgfVxuICBjb25zdCBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JylcbiAgZWxlbWVudC5pbm5lckhUTUwgPSBodG1sXG5cbiAgY29uc3QgY29tcGlsZVByb2Nlc3NlZEhUTUxTdHJpbmcgPSBmdW5jdGlvbigpIHtcbiAgICBjb25zdCBtc3ZnaCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdNYXRoSmF4X1NWR19IaWRkZW4nKVxuICAgIGNvbnN0IHN2Z0dseXBocyA9IG1zdmdoICYmIG1zdmdoLnBhcmVudE5vZGUhLmNsb25lTm9kZSh0cnVlKVxuICAgIGlmIChzdmdHbHlwaHMgIT09IG51bGwpIHtcbiAgICAgIGVsZW1lbnQuaW5zZXJ0QmVmb3JlKHN2Z0dseXBocywgZWxlbWVudC5maXJzdENoaWxkKVxuICAgIH1cbiAgICByZXR1cm4gZWxlbWVudC5pbm5lckhUTUxcbiAgfVxuXG4gIGNvbnN0IHF1ZXVlUHJvY2Vzc0hUTUxTdHJpbmcgPSAoKSA9PiB7XG4gICAgTWF0aEpheCEuSHViLlF1ZXVlKFxuICAgICAgWydzZXRSZW5kZXJlcicsIE1hdGhKYXghLkh1YiwgJ1NWRyddLFxuICAgICAgWydUeXBlc2V0JywgTWF0aEpheCEuSHViLCBlbGVtZW50XSxcbiAgICAgIFsnc2V0UmVuZGVyZXInLCBNYXRoSmF4IS5IdWIsICdIVE1MLUNTUyddLFxuICAgICAgW1xuICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgY2FsbGJhY2soY29tcGlsZVByb2Nlc3NlZEhUTUxTdHJpbmcoKSlcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgKVxuICB9XG5cbiAgaWYgKHdpbmRvdy5NYXRoSmF4KSB7XG4gICAgcXVldWVQcm9jZXNzSFRNTFN0cmluZygpXG4gIH0gZWxzZSB7XG4gICAgbG9hZE1hdGhKYXgocXVldWVQcm9jZXNzSFRNTFN0cmluZylcbiAgfVxufVxuXG4vLyBGb3IgdGVzdGluZ1xuZnVuY3Rpb24gZGlzYWJsZU1hdGhKYXgoZGlzYWJsZTogYm9vbGVhbikge1xuICBpc01hdGhKYXhEaXNhYmxlZCA9IGRpc2FibGVcbn1cblxuLy9cbi8vIExvYWQgTWF0aEpheCBlbnZpcm9ubWVudFxuLy9cbi8vIEBwYXJhbSBsaXN0ZW5lciBtZXRob2QgdG8gY2FsbCB3aGVuIHRoZSBNYXRoSmF4IHNjcmlwdCB3YXMgYmVlblxuLy8gICBsb2FkZWQgdG8gdGhlIHdpbmRvdy4gVGhlIG1ldGhvZCBpcyBwYXNzZWQgbm8gYXJndW1lbnRzLlxuLy9cbmZ1bmN0aW9uIGxvYWRNYXRoSmF4KGxpc3RlbmVyPzogKCkgPT4gYW55KSB7XG4gIGNvbnN0IHNjcmlwdCA9IGF0dGFjaE1hdGhKYXgoKVxuICBpZiAobGlzdGVuZXIpIHtcbiAgICBzY3JpcHQuYWRkRXZlbnRMaXN0ZW5lcignbG9hZCcsICgpID0+IHtcbiAgICAgIGxpc3RlbmVyKClcbiAgICB9KVxuICB9XG59XG5cbi8vXG4vLyBBdHRhY2ggbWFpbiBNYXRoSmF4IHNjcmlwdCB0byB0aGUgZG9jdW1lbnRcbi8vXG5mdW5jdGlvbiBhdHRhY2hNYXRoSmF4KCkge1xuICBpZiAoIWRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ3NjcmlwdFtzcmMqPVwiTWF0aEpheC5qc1wiXScpKSB7XG4gICAgcmV0dXJuIGF0dGFjaE1hdGhKYXhJbnRlcm5hbCgpXG4gIH1cbiAgdGhyb3cgbmV3IEVycm9yKCdEdXBsaWNhdGUgYXR0YWNoTWF0aEpheCBjYWxsJylcbn1cblxuLy9cbi8vIFJlbW92ZSBNYXRoSmF4IGZyb20gdGhlIGRvY3VtZW50IGFuZCByZXNldCBhdHRhY2ggbWV0aG9kXG4vL1xuZnVuY3Rpb24gcmVzZXRNYXRoSmF4KCkge1xuICAvLyBEZXRhY2ggTWF0aEpheCBmcm9tIHRoZSBkb2N1bWVudFxuICBmb3IgKGNvbnN0IGVsIG9mIEFycmF5LmZyb20oXG4gICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnc2NyaXB0W3NyYyo9XCJNYXRoSmF4LmpzXCJdJyksXG4gICkpIHtcbiAgICBlbC5yZW1vdmUoKVxuICB9XG4gIHdpbmRvdy5NYXRoSmF4ID0gdW5kZWZpbmVkXG5cbiAgLy8gUmVzZXQgYXR0YWNoIGZvciBhbnkgc3Vic2VxdWVudCBjYWxsc1xuICBkZWxldGUgd2luZG93Lk1hdGhKYXhcbn1cblxuZXhwb3J0IGNvbnN0IHRlc3RpbmcgPSB7XG4gIGxvYWRNYXRoSmF4LFxuICByZXNldE1hdGhKYXgsXG4gIGRpc2FibGVNYXRoSmF4LFxufVxuXG4vLyBwcml2YXRlXG5cbi8vXG4vLyBEZWZpbmUgc29tZSBmdW5jdGlvbnMgdG8gaGVscCBnZXQgYSBob2xkIG9mIHRoZSB1c2VyJ3MgTGF0ZXhcbi8vIE1hY3Jvcy5cbi8vXG5jb25zdCBuYW1lUGF0dGVybiA9IG5ldyBSZWdFeHAoYFxcXG5eW15hLXpBLVpcXFxcZFxcXFxzXSRcXFxufFxcXG5eW2EtekEtWl0qJFxcXG5gKSAvLyBsZXR0ZXJzLCBidXQgbm8gbnVtZXJhbHMuXG5cbmZ1bmN0aW9uIGdldFVzZXJNYWNyb3NQYXRoKCk6IHN0cmluZyB7XG4gIGNvbnN0IHVzZXJNYWNyb3NQYXRoOiBzdHJpbmcgfCB1bmRlZmluZWQgfCBudWxsID0gQ1NPTi5yZXNvbHZlKFxuICAgIHBhdGguam9pbihhdG9tLmdldENvbmZpZ0RpclBhdGgoKSwgJ21hcmtkb3duLXByZXZpZXctcGx1cycpLFxuICApXG4gIHJldHVybiB1c2VyTWFjcm9zUGF0aCAhPSBudWxsXG4gICAgPyB1c2VyTWFjcm9zUGF0aFxuICAgIDogcGF0aC5qb2luKGF0b20uZ2V0Q29uZmlnRGlyUGF0aCgpLCAnbWFya2Rvd24tcHJldmlldy1wbHVzLmNzb24nKVxufVxuXG5mdW5jdGlvbiBsb2FkTWFjcm9zRmlsZShmaWxlUGF0aDogc3RyaW5nKTogb2JqZWN0IHtcbiAgaWYgKCFDU09OLmlzT2JqZWN0UGF0aChmaWxlUGF0aCkpIHtcbiAgICByZXR1cm4ge31cbiAgfVxuICByZXR1cm4gQ1NPTi5yZWFkRmlsZVN5bmMoZmlsZVBhdGgsIGZ1bmN0aW9uKGVycm9yPzogRXJyb3IsIG9iamVjdD86IG9iamVjdCkge1xuICAgIGlmIChvYmplY3QgPT09IHVuZGVmaW5lZCkge1xuICAgICAgb2JqZWN0ID0ge31cbiAgICB9XG4gICAgaWYgKGVycm9yICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGNvbnNvbGUud2FybihcbiAgICAgICAgYEVycm9yIHJlYWRpbmcgTGF0ZXggTWFjcm9zIGZpbGUgJyR7ZmlsZVBhdGh9JzogJHtcbiAgICAgICAgICBlcnJvci5zdGFjayAhPT0gdW5kZWZpbmVkID8gZXJyb3Iuc3RhY2sgOiBlcnJvclxuICAgICAgICB9YCxcbiAgICAgIClcbiAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRFcnJvcihcbiAgICAgICAgYEZhaWxlZCB0byBsb2FkIExhdGV4IE1hY3JvcyBmcm9tICcke2ZpbGVQYXRofSdgLFxuICAgICAgICB7IGRldGFpbDogZXJyb3IubWVzc2FnZSwgZGlzbWlzc2FibGU6IHRydWUgfSxcbiAgICAgIClcbiAgICB9XG4gICAgcmV0dXJuIG9iamVjdFxuICB9KVxufVxuXG5mdW5jdGlvbiBsb2FkVXNlck1hY3JvcygpIHtcbiAgY29uc3QgdXNlck1hY3Jvc1BhdGggPSBnZXRVc2VyTWFjcm9zUGF0aCgpXG4gIGlmIChpc0ZpbGVTeW5jKHVzZXJNYWNyb3NQYXRoKSkge1xuICAgIHJldHVybiBsb2FkTWFjcm9zRmlsZSh1c2VyTWFjcm9zUGF0aClcbiAgfSBlbHNlIHtcbiAgICBjb25zb2xlLmRlYnVnKFxuICAgICAgJ0NyZWF0aW5nIG1hcmtkb3duLXByZXZpZXctcGx1cy5jc29uLCB0aGlzIGlzIGEgb25lLXRpbWUgb3BlcmF0aW9uLicsXG4gICAgKVxuICAgIGNyZWF0ZU1hY3Jvc1RlbXBsYXRlKHVzZXJNYWNyb3NQYXRoKVxuICAgIHJldHVybiBsb2FkTWFjcm9zRmlsZSh1c2VyTWFjcm9zUGF0aClcbiAgfVxufVxuXG5mdW5jdGlvbiBjcmVhdGVNYWNyb3NUZW1wbGF0ZShmaWxlUGF0aDogc3RyaW5nKSB7XG4gIGNvbnN0IHRlbXBsYXRlUGF0aCA9IHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi9hc3NldHMvbWFjcm9zLXRlbXBsYXRlLmNzb24nKVxuICBjb25zdCB0ZW1wbGF0ZUZpbGUgPSBmcy5yZWFkRmlsZVN5bmModGVtcGxhdGVQYXRoLCAndXRmOCcpXG4gIGZzLndyaXRlRmlsZVN5bmMoZmlsZVBhdGgsIHRlbXBsYXRlRmlsZSlcbn1cblxuZnVuY3Rpb24gY2hlY2tNYWNyb3MobWFjcm9zT2JqZWN0OiBvYmplY3QpIHtcbiAgZm9yIChjb25zdCBuYW1lIGluIG1hY3Jvc09iamVjdCkge1xuICAgIGNvbnN0IHZhbHVlID0gbWFjcm9zT2JqZWN0W25hbWVdXG4gICAgaWYgKCFuYW1lLm1hdGNoKG5hbWVQYXR0ZXJuKSB8fCAhdmFsdWVNYXRjaGVzUGF0dGVybih2YWx1ZSkpIHtcbiAgICAgIGRlbGV0ZSBtYWNyb3NPYmplY3RbbmFtZV1cbiAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRFcnJvcihcbiAgICAgICAgYEZhaWxlZCB0byBsb2FkIExhVGVYIG1hY3JvIG5hbWVkICcke25hbWV9Jy4gUGxlYXNlIHNlZSB0aGUgW0xhVGVYIGd1aWRlXShodHRwczovL2dpdGh1Yi5jb20vR2FsYWRpcml0aC9tYXJrZG93bi1wcmV2aWV3LXBsdXMvYmxvYi9tYXN0ZXIvTEFURVgubWQjbWFjcm8tbmFtZXMpYCxcbiAgICAgICAgeyBkaXNtaXNzYWJsZTogdHJ1ZSB9LFxuICAgICAgKVxuICAgIH1cbiAgfVxuICByZXR1cm4gbWFjcm9zT2JqZWN0XG59XG5cbmZ1bmN0aW9uIHZhbHVlTWF0Y2hlc1BhdHRlcm4odmFsdWU6IGFueSkge1xuICAvLyBEaWZmZXJlbnQgY2hlY2sgYmFzZWQgb24gd2hldGhlciB2YWx1ZSBpcyBzdHJpbmcgb3IgYXJyYXlcbiAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7XG4gICAgY29uc3QgbWFjcm9EZWZpbml0aW9uID0gdmFsdWVbMF1cbiAgICBjb25zdCBudW1iZXJPZkFyZ3MgPSB2YWx1ZVsxXVxuICAgIGlmICh0eXBlb2YgbnVtYmVyT2ZBcmdzID09PSAnbnVtYmVyJykge1xuICAgICAgcmV0dXJuIG51bWJlck9mQXJncyAlIDEgPT09IDAgJiYgdHlwZW9mIG1hY3JvRGVmaW5pdGlvbiA9PT0gJ3N0cmluZydcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIGZhbHNlXG4gICAgfVxuICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHtcbiAgICByZXR1cm4gdHJ1ZVxuICB9IGVsc2Uge1xuICAgIHJldHVybiBmYWxzZVxuICB9XG59XG5cbi8vIENvbmZpZ3VyZSBNYXRoSmF4IGVudmlyb25tZW50LiBTaW1pbGFyIHRvIHRoZSBUZVgtQU1TX0hUTUwgY29uZmlndXJhdGlvbiB3aXRoXG4vLyBhIGZldyB1bm5lY2Vzc2FyeSBmZWF0dXJlcyBzdHJpcHBlZCBhd2F5XG4vL1xuY29uc3QgY29uZmlndXJlTWF0aEpheCA9IGZ1bmN0aW9uKCkge1xuICBsZXQgdXNlck1hY3JvcyA9IGxvYWRVc2VyTWFjcm9zKClcbiAgaWYgKHVzZXJNYWNyb3MpIHtcbiAgICB1c2VyTWFjcm9zID0gY2hlY2tNYWNyb3ModXNlck1hY3JvcylcbiAgfSBlbHNlIHtcbiAgICB1c2VyTWFjcm9zID0ge31cbiAgfVxuXG4gIC8vIE5vdyBDb25maWd1cmUgTWF0aEpheFxuICBNYXRoSmF4IS5IdWIuQ29uZmlnKHtcbiAgICBqYXg6IFsnaW5wdXQvVGVYJywgJ291dHB1dC9IVE1MLUNTUyddLFxuICAgIGV4dGVuc2lvbnM6IFtdLFxuICAgIFRlWDoge1xuICAgICAgZXh0ZW5zaW9uczogW1xuICAgICAgICAnQU1TbWF0aC5qcycsXG4gICAgICAgICdBTVNzeW1ib2xzLmpzJyxcbiAgICAgICAgJ25vRXJyb3JzLmpzJyxcbiAgICAgICAgJ25vVW5kZWZpbmVkLmpzJyxcbiAgICAgIF0sXG4gICAgICBNYWNyb3M6IHVzZXJNYWNyb3MsXG4gICAgfSxcbiAgICAnSFRNTC1DU1MnOiB7XG4gICAgICBhdmFpbGFibGVGb250czogW10sXG4gICAgICB3ZWJGb250OiAnVGVYJyxcbiAgICB9LFxuICAgIG1lc3NhZ2VTdHlsZTogJ25vbmUnLFxuICAgIHNob3dNYXRoTWVudTogZmFsc2UsXG4gICAgc2tpcFN0YXJ0dXBUeXBlc2V0OiB0cnVlLFxuICB9KVxuICBNYXRoSmF4IS5IdWIuQ29uZmlndXJlZCgpXG5cbiAgLy8gTm90aWZ5IHVzZXIgTWF0aEpheCBoYXMgbG9hZGVkXG4gIGlmIChhdG9tLmluRGV2TW9kZSgpKSB7XG4gICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZFN1Y2Nlc3MoJ0xvYWRlZCBtYXRocyByZW5kZXJpbmcgZW5naW5lIE1hdGhKYXgnKVxuICB9XG59XG5cbi8vXG4vLyBBdHRhY2ggbWFpbiBNYXRoSmF4IHNjcmlwdCB0byB0aGUgZG9jdW1lbnRcbi8vXG5mdW5jdGlvbiBhdHRhY2hNYXRoSmF4SW50ZXJuYWwoKSB7XG4gIC8vIE5vdGlmeSB1c2VyIE1hdGhKYXggaXMgbG9hZGluZ1xuICBpZiAoYXRvbS5pbkRldk1vZGUoKSkge1xuICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRJbmZvKCdMb2FkaW5nIG1hdGhzIHJlbmRlcmluZyBlbmdpbmUgTWF0aEpheCcpXG4gIH1cblxuICAvLyBBdHRhY2ggTWF0aEpheCBzY3JpcHRcbiAgY29uc3Qgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0JylcbiAgc2NyaXB0LnNyYyA9IGAke3JlcXVpcmUucmVzb2x2ZSgnTWF0aEpheCcpfT9kZWxheVN0YXJ0dXBVbnRpbD1jb25maWd1cmVkYFxuICBzY3JpcHQudHlwZSA9ICd0ZXh0L2phdmFzY3JpcHQnXG4gIHNjcmlwdC5hZGRFdmVudExpc3RlbmVyKCdsb2FkJywgKCkgPT4ge1xuICAgIGNvbmZpZ3VyZU1hdGhKYXgoKVxuICB9KVxuICBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaGVhZCcpWzBdLmFwcGVuZENoaWxkKHNjcmlwdClcblxuICByZXR1cm4gc2NyaXB0XG59XG4iXX0=