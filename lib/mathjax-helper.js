"use strict";
const path = require("path");
const CSON = require('season');
const fs = require("fs-plus");
const namePattern = new RegExp(`\
^[^a-zA-Z\\d\\s]$\
|\
^[a-zA-Z]*$\
`);
function getUserMacrosPath() {
    const userMacrosPath = CSON.resolve(path.join(atom.getConfigDirPath(), 'markdown-preview-plus'));
    return userMacrosPath != null
        ? userMacrosPath
        : path.join(atom.getConfigDirPath(), 'markdown-preview-plus.cson');
}
function loadMacrosFile(filePath) {
    if (!CSON.isObjectPath(filePath)) {
        return {};
    }
    return CSON.readFileSync(filePath, function (error, object) {
        if (object === undefined) {
            object = {};
        }
        if (error !== undefined) {
            console.warn(`Error reading Latex Macros file '${filePath}': ${error.stack !== undefined ? error.stack : error}`);
            atom.notifications.addError(`Failed to load Latex Macros from '${filePath}'`, { detail: error.message, dismissable: true });
        }
        return object;
    });
}
function loadUserMacros() {
    const userMacrosPath = getUserMacrosPath();
    if (fs.isFileSync(userMacrosPath)) {
        return loadMacrosFile(userMacrosPath);
    }
    else {
        console.log('Creating markdown-preview-plus.cson, this is a one-time operation.');
        createMacrosTemplate(userMacrosPath);
        return loadMacrosFile(userMacrosPath);
    }
}
function createMacrosTemplate(filePath) {
    const templatePath = path.join(__dirname, '../assets/macros-template.cson');
    const templateFile = fs.readFileSync(templatePath, 'utf8');
    fs.writeFileSync(filePath, templateFile);
}
function checkMacros(macrosObject) {
    for (const name in macrosObject) {
        const value = macrosObject[name];
        if (!name.match(namePattern) || !valueMatchesPattern(value)) {
            delete macrosObject[name];
            atom.notifications.addError(`Failed to load LaTeX macro named '${name}'. Please see the [LaTeX guide](https://github.com/Galadirith/markdown-preview-plus/blob/master/LATEX.md#macro-names)`, { dismissable: true });
        }
    }
    return macrosObject;
}
function valueMatchesPattern(value) {
    if (Array.isArray(value)) {
        const macroDefinition = value[0];
        const numberOfArgs = value[1];
        if (typeof numberOfArgs === 'number') {
            return numberOfArgs % 1 === 0 && typeof macroDefinition === 'string';
        }
        else {
            return false;
        }
    }
    else if (typeof value === 'string') {
        return true;
    }
    else {
        return false;
    }
}
const configureMathJax = function () {
    let userMacros = loadUserMacros();
    if (userMacros) {
        userMacros = checkMacros(userMacros);
    }
    else {
        userMacros = {};
    }
    MathJax.Hub.Config({
        jax: ['input/TeX', 'output/HTML-CSS'],
        extensions: [],
        TeX: {
            extensions: [
                'AMSmath.js',
                'AMSsymbols.js',
                'noErrors.js',
                'noUndefined.js',
            ],
            Macros: userMacros,
        },
        'HTML-CSS': {
            availableFonts: [],
            webFont: 'TeX',
        },
        messageStyle: 'none',
        showMathMenu: false,
        skipStartupTypeset: true,
    });
    MathJax.Hub.Configured();
    if (atom.inDevMode()) {
        atom.notifications.addSuccess('Loaded maths rendering engine MathJax');
    }
};
function attachMathJax() {
    if (atom.inDevMode()) {
        atom.notifications.addInfo('Loading maths rendering engine MathJax');
    }
    const script = document.createElement('script');
    script.src = `${require.resolve('MathJax')}?delayStartupUntil=configured`;
    script.type = 'text/javascript';
    script.addEventListener('load', () => {
        configureMathJax();
    });
    document.getElementsByTagName('head')[0].appendChild(script);
    return script;
}
module.exports = {
    loadMathJax(listener) {
        const script = this.attachMathJax();
        if (listener)
            script.addEventListener('load', () => listener());
    },
    attachMathJax() {
        if (!document.querySelector('script[src*="MathJax.js"]')) {
            return attachMathJax();
        }
        throw new Error('Duplicate attachMathJax call');
    },
    resetMathJax() {
        for (const el of Array.from(document.querySelectorAll('script[src*="MathJax.js"]'))) {
            el.remove();
        }
        window.MathJax = undefined;
        delete window.MathJax;
    },
    mathProcessor(domElements) {
        if (window.MathJax) {
            window.MathJax.Hub.Queue(['Typeset', window.MathJax.Hub, domElements]);
        }
        else {
            this.loadMathJax(() => {
                MathJax.Hub.Queue(['Typeset', MathJax.Hub, domElements]);
            });
        }
    },
    processHTMLString(html, callback) {
        const element = document.createElement('div');
        element.innerHTML = html;
        const compileProcessedHTMLString = function () {
            const msvgh = document.getElementById('MathJax_SVG_Hidden');
            const svgGlyphs = msvgh && msvgh.parentNode.cloneNode(true);
            if (svgGlyphs !== null) {
                element.insertBefore(svgGlyphs, element.firstChild);
            }
            return element.innerHTML;
        };
        const queueProcessHTMLString = () => {
            MathJax.Hub.Queue(['setRenderer', MathJax.Hub, 'SVG'], ['Typeset', MathJax.Hub, element], ['setRenderer', MathJax.Hub, 'HTML-CSS'], [() => callback(compileProcessedHTMLString())]);
        };
        if (window.MathJax) {
            queueProcessHTMLString();
        }
        else {
            this.loadMathJax(queueProcessHTMLString);
        }
    },
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWF0aGpheC1oZWxwZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvbWF0aGpheC1oZWxwZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQWlCQSw2QkFBNkI7QUFFN0IsTUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFBO0FBQzlCLDhCQUE4QjtBQWtHOUIsTUFBTSxXQUFXLEdBQUcsSUFBSSxNQUFNLENBQUM7Ozs7Q0FJOUIsQ0FBQyxDQUFBO0FBRUY7SUFDRSxNQUFNLGNBQWMsR0FBOEIsSUFBSSxDQUFDLE9BQU8sQ0FDNUQsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsRUFBRSx1QkFBdUIsQ0FBQyxDQUM1RCxDQUFBO0lBQ0QsTUFBTSxDQUFDLGNBQWMsSUFBSSxJQUFJO1FBQzNCLENBQUMsQ0FBQyxjQUFjO1FBQ2hCLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxFQUFFLDRCQUE0QixDQUFDLENBQUE7QUFDdEUsQ0FBQztBQUVELHdCQUF3QixRQUFnQjtJQUN0QyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2pDLE1BQU0sQ0FBQyxFQUFFLENBQUE7SUFDWCxDQUFDO0lBQ0QsTUFBTSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxFQUFFLFVBQVMsS0FBYSxFQUFFLE1BQWU7UUFDeEUsRUFBRSxDQUFDLENBQUMsTUFBTSxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDekIsTUFBTSxHQUFHLEVBQUUsQ0FBQTtRQUNiLENBQUM7UUFDRCxFQUFFLENBQUMsQ0FBQyxLQUFLLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQztZQUN4QixPQUFPLENBQUMsSUFBSSxDQUNWLG9DQUFvQyxRQUFRLE1BQzFDLEtBQUssQ0FBQyxLQUFLLEtBQUssU0FB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LEVBQUUsT0FBUSxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsRUFDcEMsQ0FBQyxTQUFTLEVBQUUsT0FBUSxDQUFDLEdBQUcsRUFBRSxPQUFPLENBQUMsRUFDbEMsQ0FBQyxhQUFhLEVBQUUsT0FBUSxDQUFDLEdBQUcsRUFBRSxVQUFVLENBQUMsRUFDekMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxRQUFRLENBQUMsMEJBQTBCLEVBQUUsQ0FBQyxDQUFDLENBQy9DLENBQUE7UUFDSCxDQUFDLENBQUE7UUFFRCxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztZQUNuQixzQkFBc0IsRUFBRSxDQUFBO1FBQzFCLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLElBQUksQ0FBQyxXQUFXLENBQUMsc0JBQXNCLENBQUMsQ0FBQTtRQUMxQyxDQUFDO0lBQ0gsQ0FBQztDQUNGLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogZGVjYWZmZWluYXRlIHN1Z2dlc3Rpb25zOlxuICogRFMxMDI6IFJlbW92ZSB1bm5lY2Vzc2FyeSBjb2RlIGNyZWF0ZWQgYmVjYXVzZSBvZiBpbXBsaWNpdCByZXR1cm5zXG4gKiBEUzIwNzogQ29uc2lkZXIgc2hvcnRlciB2YXJpYXRpb25zIG9mIG51bGwgY2hlY2tzXG4gKiBGdWxsIGRvY3M6IGh0dHBzOi8vZ2l0aHViLmNvbS9kZWNhZmZlaW5hdGUvZGVjYWZmZWluYXRlL2Jsb2IvbWFzdGVyL2RvY3Mvc3VnZ2VzdGlvbnMubWRcbiAqL1xuLy9cbi8vIG1hdGhqYXgtaGVscGVyXG4vL1xuLy8gVGhpcyBtb2R1bGUgd2lsbCBoYW5kbGUgbG9hZGluZyB0aGUgTWF0aEpheCBlbnZpcm9ubWVudCBhbmQgcHJvdmlkZSBhIHdyYXBwZXJcbi8vIGZvciBjYWxscyB0byBNYXRoSmF4IHRvIHByb2Nlc3MgTGFUZVggZXF1YXRpb25zLlxuLy9cblxuLy8gVE9ETzogRml4IHRoaXNcbi8vIHRzbGludDpkaXNhYmxlOiBuby11bnNhZmUtYW55XG5cbi8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby12YXItcmVxdWlyZXNcbmltcG9ydCBwYXRoID0gcmVxdWlyZSgncGF0aCcpXG4vLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tdmFyLXJlcXVpcmVzXG5jb25zdCBDU09OID0gcmVxdWlyZSgnc2Vhc29uJylcbmltcG9ydCBmcyA9IHJlcXVpcmUoJ2ZzLXBsdXMnKVxuXG5leHBvcnQgPSB7XG4gIC8vXG4gIC8vIExvYWQgTWF0aEpheCBlbnZpcm9ubWVudFxuICAvL1xuICAvLyBAcGFyYW0gbGlzdGVuZXIgbWV0aG9kIHRvIGNhbGwgd2hlbiB0aGUgTWF0aEpheCBzY3JpcHQgd2FzIGJlZW5cbiAgLy8gICBsb2FkZWQgdG8gdGhlIHdpbmRvdy4gVGhlIG1ldGhvZCBpcyBwYXNzZWQgbm8gYXJndW1lbnRzLlxuICAvL1xuICBsb2FkTWF0aEpheChsaXN0ZW5lcj86ICgpID0+IGFueSkge1xuICAgIGNvbnN0IHNjcmlwdCA9IHRoaXMuYXR0YWNoTWF0aEpheCgpXG4gICAgaWYgKGxpc3RlbmVyKSBzY3JpcHQuYWRkRXZlbnRMaXN0ZW5lcignbG9hZCcsICgpID0+IGxpc3RlbmVyKCkpXG4gIH0sXG5cbiAgLy9cbiAgLy8gQXR0YWNoIG1haW4gTWF0aEpheCBzY3JpcHQgdG8gdGhlIGRvY3VtZW50XG4gIC8vXG4gIGF0dGFjaE1hdGhKYXgoKSB7XG4gICAgaWYgKCFkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdzY3JpcHRbc3JjKj1cIk1hdGhKYXguanNcIl0nKSkge1xuICAgICAgcmV0dXJuIGF0dGFjaE1hdGhKYXgoKVxuICAgIH1cbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0R1cGxpY2F0ZSBhdHRhY2hNYXRoSmF4IGNhbGwnKVxuICB9LFxuXG4gIC8vXG4gIC8vIFJlbW92ZSBNYXRoSmF4IGZyb20gdGhlIGRvY3VtZW50IGFuZCByZXNldCBhdHRhY2ggbWV0aG9kXG4gIC8vXG4gIHJlc2V0TWF0aEpheCgpIHtcbiAgICAvLyBEZXRhY2ggTWF0aEpheCBmcm9tIHRoZSBkb2N1bWVudFxuICAgIGZvciAoY29uc3QgZWwgb2YgQXJyYXkuZnJvbShcbiAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ3NjcmlwdFtzcmMqPVwiTWF0aEpheC5qc1wiXScpLFxuICAgICkpIHtcbiAgICAgIGVsLnJlbW92ZSgpXG4gICAgfVxuICAgIHdpbmRvdy5NYXRoSmF4ID0gdW5kZWZpbmVkXG5cbiAgICAvLyBSZXNldCBhdHRhY2ggZm9yIGFueSBzdWJzZXF1ZW50IGNhbGxzXG4gICAgZGVsZXRlIHdpbmRvdy5NYXRoSmF4XG4gIH0sXG5cbiAgLy9cbiAgLy8gUHJvY2VzcyBET00gZWxlbWVudHMgZm9yIExhVGVYIGVxdWF0aW9ucyB3aXRoIE1hdGhKYXhcbiAgLy9cbiAgLy8gQHBhcmFtIGRvbUVsZW1lbnRzIEFuIGFycmF5IG9mIERPTSBlbGVtZW50cyB0byBiZSBwcm9jZXNzZWQgYnkgTWF0aEpheC4gU2VlXG4gIC8vICAgW2VsZW1lbnRdKGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0FQSS9lbGVtZW50KSBmb3JcbiAgLy8gICBkZXRhaWxzIG9uIERPTSBlbGVtZW50cy5cbiAgLy9cbiAgbWF0aFByb2Nlc3Nvcihkb21FbGVtZW50czogTm9kZVtdKSB7XG4gICAgaWYgKHdpbmRvdy5NYXRoSmF4KSB7XG4gICAgICB3aW5kb3cuTWF0aEpheC5IdWIuUXVldWUoWydUeXBlc2V0Jywgd2luZG93Lk1hdGhKYXguSHViLCBkb21FbGVtZW50c10pXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMubG9hZE1hdGhKYXgoKCkgPT4ge1xuICAgICAgICBNYXRoSmF4IS5IdWIuUXVldWUoWydUeXBlc2V0JywgTWF0aEpheCEuSHViLCBkb21FbGVtZW50c10pXG4gICAgICB9KVxuICAgIH1cbiAgfSxcblxuICAvL1xuICAvLyBQcm9jZXNzIG1hdGhzIGluIEhUTUwgZnJhZ21lbnQgd2l0aCBNYXRoSmF4XG4gIC8vXG4gIC8vIEBwYXJhbSBodG1sIEEgSFRNTCBmcmFnbWVudCBzdHJpbmdcbiAgLy8gQHBhcmFtIGNhbGxiYWNrIEEgY2FsbGJhY2sgbWV0aG9kIHRoYXQgYWNjZXB0cyBhIHNpbmdsZSBwYXJhbWV0ZXIsIGEgSFRNTFxuICAvLyAgIGZyYWdtZW50IHN0cmluZyB0aGF0IGlzIHRoZSByZXN1bHQgb2YgaHRtbCBwcm9jZXNzZWQgYnkgTWF0aEpheFxuICAvL1xuICBwcm9jZXNzSFRNTFN0cmluZyhodG1sOiBzdHJpbmcsIGNhbGxiYWNrOiAocHJvSFRNTDogc3RyaW5nKSA9PiBhbnkpIHtcbiAgICBjb25zdCBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JylcbiAgICBlbGVtZW50LmlubmVySFRNTCA9IGh0bWxcblxuICAgIGNvbnN0IGNvbXBpbGVQcm9jZXNzZWRIVE1MU3RyaW5nID0gZnVuY3Rpb24oKSB7XG4gICAgICBjb25zdCBtc3ZnaCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdNYXRoSmF4X1NWR19IaWRkZW4nKVxuICAgICAgY29uc3Qgc3ZnR2x5cGhzID0gbXN2Z2ggJiYgbXN2Z2gucGFyZW50Tm9kZSEuY2xvbmVOb2RlKHRydWUpXG4gICAgICBpZiAoc3ZnR2x5cGhzICE9PSBudWxsKSB7XG4gICAgICAgIGVsZW1lbnQuaW5zZXJ0QmVmb3JlKHN2Z0dseXBocywgZWxlbWVudC5maXJzdENoaWxkKVxuICAgICAgfVxuICAgICAgcmV0dXJuIGVsZW1lbnQuaW5uZXJIVE1MXG4gICAgfVxuXG4gICAgY29uc3QgcXVldWVQcm9jZXNzSFRNTFN0cmluZyA9ICgpID0+IHtcbiAgICAgIE1hdGhKYXghLkh1Yi5RdWV1ZShcbiAgICAgICAgWydzZXRSZW5kZXJlcicsIE1hdGhKYXghLkh1YiwgJ1NWRyddLFxuICAgICAgICBbJ1R5cGVzZXQnLCBNYXRoSmF4IS5IdWIsIGVsZW1lbnRdLFxuICAgICAgICBbJ3NldFJlbmRlcmVyJywgTWF0aEpheCEuSHViLCAnSFRNTC1DU1MnXSxcbiAgICAgICAgWygpID0+IGNhbGxiYWNrKGNvbXBpbGVQcm9jZXNzZWRIVE1MU3RyaW5nKCkpXSxcbiAgICAgIClcbiAgICB9XG5cbiAgICBpZiAod2luZG93Lk1hdGhKYXgpIHtcbiAgICAgIHF1ZXVlUHJvY2Vzc0hUTUxTdHJpbmcoKVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmxvYWRNYXRoSmF4KHF1ZXVlUHJvY2Vzc0hUTUxTdHJpbmcpXG4gICAgfVxuICB9LFxufVxuXG4vL1xuLy8gRGVmaW5lIHNvbWUgZnVuY3Rpb25zIHRvIGhlbHAgZ2V0IGEgaG9sZCBvZiB0aGUgdXNlcidzIExhdGV4XG4vLyBNYWNyb3MuXG4vL1xuY29uc3QgbmFtZVBhdHRlcm4gPSBuZXcgUmVnRXhwKGBcXFxuXlteYS16QS1aXFxcXGRcXFxcc10kXFxcbnxcXFxuXlthLXpBLVpdKiRcXFxuYCkgLy8gbGV0dGVycywgYnV0IG5vIG51bWVyYWxzLlxuXG5mdW5jdGlvbiBnZXRVc2VyTWFjcm9zUGF0aCgpOiBzdHJpbmcge1xuICBjb25zdCB1c2VyTWFjcm9zUGF0aDogc3RyaW5nIHwgdW5kZWZpbmVkIHwgbnVsbCA9IENTT04ucmVzb2x2ZShcbiAgICBwYXRoLmpvaW4oYXRvbS5nZXRDb25maWdEaXJQYXRoKCksICdtYXJrZG93bi1wcmV2aWV3LXBsdXMnKSxcbiAgKVxuICByZXR1cm4gdXNlck1hY3Jvc1BhdGggIT0gbnVsbFxuICAgID8gdXNlck1hY3Jvc1BhdGhcbiAgICA6IHBhdGguam9pbihhdG9tLmdldENvbmZpZ0RpclBhdGgoKSwgJ21hcmtkb3duLXByZXZpZXctcGx1cy5jc29uJylcbn1cblxuZnVuY3Rpb24gbG9hZE1hY3Jvc0ZpbGUoZmlsZVBhdGg6IHN0cmluZyk6IG9iamVjdCB7XG4gIGlmICghQ1NPTi5pc09iamVjdFBhdGgoZmlsZVBhdGgpKSB7XG4gICAgcmV0dXJuIHt9XG4gIH1cbiAgcmV0dXJuIENTT04ucmVhZEZpbGVTeW5jKGZpbGVQYXRoLCBmdW5jdGlvbihlcnJvcj86IEVycm9yLCBvYmplY3Q/OiBvYmplY3QpIHtcbiAgICBpZiAob2JqZWN0ID09PSB1bmRlZmluZWQpIHtcbiAgICAgIG9iamVjdCA9IHt9XG4gICAgfVxuICAgIGlmIChlcnJvciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBjb25zb2xlLndhcm4oXG4gICAgICAgIGBFcnJvciByZWFkaW5nIExhdGV4IE1hY3JvcyBmaWxlICcke2ZpbGVQYXRofSc6ICR7XG4gICAgICAgICAgZXJyb3Iuc3RhY2sgIT09IHVuZGVmaW5lZCA/IGVycm9yLnN0YWNrIDogZXJyb3JcbiAgICAgICAgfWAsXG4gICAgICApXG4gICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkRXJyb3IoXG4gICAgICAgIGBGYWlsZWQgdG8gbG9hZCBMYXRleCBNYWNyb3MgZnJvbSAnJHtmaWxlUGF0aH0nYCxcbiAgICAgICAgeyBkZXRhaWw6IGVycm9yLm1lc3NhZ2UsIGRpc21pc3NhYmxlOiB0cnVlIH0sXG4gICAgICApXG4gICAgfVxuICAgIHJldHVybiBvYmplY3RcbiAgfSlcbn1cblxuZnVuY3Rpb24gbG9hZFVzZXJNYWNyb3MoKSB7XG4gIGNvbnN0IHVzZXJNYWNyb3NQYXRoID0gZ2V0VXNlck1hY3Jvc1BhdGgoKVxuICBpZiAoZnMuaXNGaWxlU3luYyh1c2VyTWFjcm9zUGF0aCkpIHtcbiAgICByZXR1cm4gbG9hZE1hY3Jvc0ZpbGUodXNlck1hY3Jvc1BhdGgpXG4gIH0gZWxzZSB7XG4gICAgY29uc29sZS5sb2coXG4gICAgICAnQ3JlYXRpbmcgbWFya2Rvd24tcHJldmlldy1wbHVzLmNzb24sIHRoaXMgaXMgYSBvbmUtdGltZSBvcGVyYXRpb24uJyxcbiAgICApXG4gICAgY3JlYXRlTWFjcm9zVGVtcGxhdGUodXNlck1hY3Jvc1BhdGgpXG4gICAgcmV0dXJuIGxvYWRNYWNyb3NGaWxlKHVzZXJNYWNyb3NQYXRoKVxuICB9XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZU1hY3Jvc1RlbXBsYXRlKGZpbGVQYXRoOiBzdHJpbmcpIHtcbiAgY29uc3QgdGVtcGxhdGVQYXRoID0gcGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL2Fzc2V0cy9tYWNyb3MtdGVtcGxhdGUuY3NvbicpXG4gIGNvbnN0IHRlbXBsYXRlRmlsZSA9IGZzLnJlYWRGaWxlU3luYyh0ZW1wbGF0ZVBhdGgsICd1dGY4JylcbiAgZnMud3JpdGVGaWxlU3luYyhmaWxlUGF0aCwgdGVtcGxhdGVGaWxlKVxufVxuXG5mdW5jdGlvbiBjaGVja01hY3JvcyhtYWNyb3NPYmplY3Q6IG9iamVjdCkge1xuICBmb3IgKGNvbnN0IG5hbWUgaW4gbWFjcm9zT2JqZWN0KSB7XG4gICAgY29uc3QgdmFsdWUgPSBtYWNyb3NPYmplY3RbbmFtZV1cbiAgICBpZiAoIW5hbWUubWF0Y2gobmFtZVBhdHRlcm4pIHx8ICF2YWx1ZU1hdGNoZXNQYXR0ZXJuKHZhbHVlKSkge1xuICAgICAgZGVsZXRlIG1hY3Jvc09iamVjdFtuYW1lXVxuICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEVycm9yKFxuICAgICAgICBgRmFpbGVkIHRvIGxvYWQgTGFUZVggbWFjcm8gbmFtZWQgJyR7bmFtZX0nLiBQbGVhc2Ugc2VlIHRoZSBbTGFUZVggZ3VpZGVdKGh0dHBzOi8vZ2l0aHViLmNvbS9HYWxhZGlyaXRoL21hcmtkb3duLXByZXZpZXctcGx1cy9ibG9iL21hc3Rlci9MQVRFWC5tZCNtYWNyby1uYW1lcylgLFxuICAgICAgICB7IGRpc21pc3NhYmxlOiB0cnVlIH0sXG4gICAgICApXG4gICAgfVxuICB9XG4gIHJldHVybiBtYWNyb3NPYmplY3Rcbn1cblxuZnVuY3Rpb24gdmFsdWVNYXRjaGVzUGF0dGVybih2YWx1ZTogYW55KSB7XG4gIC8vIERpZmZlcmVudCBjaGVjayBiYXNlZCBvbiB3aGV0aGVyIHZhbHVlIGlzIHN0cmluZyBvciBhcnJheVxuICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcbiAgICBjb25zdCBtYWNyb0RlZmluaXRpb24gPSB2YWx1ZVswXVxuICAgIGNvbnN0IG51bWJlck9mQXJncyA9IHZhbHVlWzFdXG4gICAgaWYgKHR5cGVvZiBudW1iZXJPZkFyZ3MgPT09ICdudW1iZXInKSB7XG4gICAgICByZXR1cm4gbnVtYmVyT2ZBcmdzICUgMSA9PT0gMCAmJiB0eXBlb2YgbWFjcm9EZWZpbml0aW9uID09PSAnc3RyaW5nJ1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG4gIH0gZWxzZSBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykge1xuICAgIHJldHVybiB0cnVlXG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGZhbHNlXG4gIH1cbn1cblxuLy8gQ29uZmlndXJlIE1hdGhKYXggZW52aXJvbm1lbnQuIFNpbWlsYXIgdG8gdGhlIFRlWC1BTVNfSFRNTCBjb25maWd1cmF0aW9uIHdpdGhcbi8vIGEgZmV3IHVubmVjZXNzYXJ5IGZlYXR1cmVzIHN0cmlwcGVkIGF3YXlcbi8vXG5jb25zdCBjb25maWd1cmVNYXRoSmF4ID0gZnVuY3Rpb24oKSB7XG4gIGxldCB1c2VyTWFjcm9zID0gbG9hZFVzZXJNYWNyb3MoKVxuICBpZiAodXNlck1hY3Jvcykge1xuICAgIHVzZXJNYWNyb3MgPSBjaGVja01hY3Jvcyh1c2VyTWFjcm9zKVxuICB9IGVsc2Uge1xuICAgIHVzZXJNYWNyb3MgPSB7fVxuICB9XG5cbiAgLy8gTm93IENvbmZpZ3VyZSBNYXRoSmF4XG4gIE1hdGhKYXghLkh1Yi5Db25maWcoe1xuICAgIGpheDogWydpbnB1dC9UZVgnLCAnb3V0cHV0L0hUTUwtQ1NTJ10sXG4gICAgZXh0ZW5zaW9uczogW10sXG4gICAgVGVYOiB7XG4gICAgICBleHRlbnNpb25zOiBbXG4gICAgICAgICdBTVNtYXRoLmpzJyxcbiAgICAgICAgJ0FNU3N5bWJvbHMuanMnLFxuICAgICAgICAnbm9FcnJvcnMuanMnLFxuICAgICAgICAnbm9VbmRlZmluZWQuanMnLFxuICAgICAgXSxcbiAgICAgIE1hY3JvczogdXNlck1hY3JvcyxcbiAgICB9LFxuICAgICdIVE1MLUNTUyc6IHtcbiAgICAgIGF2YWlsYWJsZUZvbnRzOiBbXSxcbiAgICAgIHdlYkZvbnQ6ICdUZVgnLFxuICAgIH0sXG4gICAgbWVzc2FnZVN0eWxlOiAnbm9uZScsXG4gICAgc2hvd01hdGhNZW51OiBmYWxzZSxcbiAgICBza2lwU3RhcnR1cFR5cGVzZXQ6IHRydWUsXG4gIH0pXG4gIE1hdGhKYXghLkh1Yi5Db25maWd1cmVkKClcblxuICAvLyBOb3RpZnkgdXNlciBNYXRoSmF4IGhhcyBsb2FkZWRcbiAgaWYgKGF0b20uaW5EZXZNb2RlKCkpIHtcbiAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkU3VjY2VzcygnTG9hZGVkIG1hdGhzIHJlbmRlcmluZyBlbmdpbmUgTWF0aEpheCcpXG4gIH1cbn1cblxuLy9cbi8vIEF0dGFjaCBtYWluIE1hdGhKYXggc2NyaXB0IHRvIHRoZSBkb2N1bWVudFxuLy9cbmZ1bmN0aW9uIGF0dGFjaE1hdGhKYXgoKSB7XG4gIC8vIE5vdGlmeSB1c2VyIE1hdGhKYXggaXMgbG9hZGluZ1xuICBpZiAoYXRvbS5pbkRldk1vZGUoKSkge1xuICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRJbmZvKCdMb2FkaW5nIG1hdGhzIHJlbmRlcmluZyBlbmdpbmUgTWF0aEpheCcpXG4gIH1cblxuICAvLyBBdHRhY2ggTWF0aEpheCBzY3JpcHRcbiAgY29uc3Qgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0JylcbiAgc2NyaXB0LnNyYyA9IGAke3JlcXVpcmUucmVzb2x2ZSgnTWF0aEpheCcpfT9kZWxheVN0YXJ0dXBVbnRpbD1jb25maWd1cmVkYFxuICBzY3JpcHQudHlwZSA9ICd0ZXh0L2phdmFzY3JpcHQnXG4gIHNjcmlwdC5hZGRFdmVudExpc3RlbmVyKCdsb2FkJywgKCkgPT4ge1xuICAgIGNvbmZpZ3VyZU1hdGhKYXgoKVxuICB9KVxuICBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaGVhZCcpWzBdLmFwcGVuZENoaWxkKHNjcmlwdClcblxuICByZXR1cm4gc2NyaXB0XG59XG4iXX0=