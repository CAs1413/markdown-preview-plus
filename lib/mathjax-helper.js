"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const CSON = require("season");
const fs = require("fs");
const util_1 = require("./util");
let isMathJaxDisabled = false;
async function mathProcessor(frame, domElements) {
    if (isMathJaxDisabled)
        return;
    const jax = await loadMathJax(frame);
    jax.queueTypeset(domElements);
}
exports.mathProcessor = mathProcessor;
async function processHTMLString(frame, html) {
    if (isMathJaxDisabled) {
        return html;
    }
    const element = document.createElement('div');
    element.innerHTML = html;
    const jax = await loadMathJax(frame);
    await new Promise((resolve) => {
        jax.queueProcessHTMLString(element, resolve);
    });
    const msvgh = document.getElementById('MathJax_SVG_Hidden');
    const svgGlyphs = msvgh && msvgh.parentNode.cloneNode(true);
    if (svgGlyphs !== null) {
        element.insertBefore(svgGlyphs, element.firstChild);
    }
    return element.innerHTML;
}
exports.processHTMLString = processHTMLString;
function disableMathJax(disable) {
    isMathJaxDisabled = disable;
}
async function loadMathJax(frame) {
    if (frame.contentWindow.mathJaxStub)
        return frame.contentWindow.mathJaxStub;
    if (frame.contentDocument.querySelector('head')) {
        return attachMathJax(frame);
    }
    else {
        return new Promise((resolve) => {
            const onload = () => {
                frame.removeEventListener('load', onload);
                resolve(loadMathJax(frame));
            };
            frame.addEventListener('load', onload);
        });
    }
}
async function attachMathJax(frame) {
    if (!frame.contentDocument.querySelector('script[src*="MathJax.js"]')) {
        return attachMathJaxInternal(frame);
    }
    throw new Error('Duplicate attachMathJax call');
}
exports.testing = {
    loadMathJax,
    disableMathJax,
};
const namePattern = new RegExp(`\
^[^a-zA-Z\\d\\s]$\
|\
^[a-zA-Z]*$\
`);
function getUserMacrosPath() {
    const userMacrosPath = CSON.resolve(path.join(atom.getConfigDirPath(), 'markdown-preview-plus'));
    return userMacrosPath != null
        ? userMacrosPath
        : path.join(atom.getConfigDirPath(), 'markdown-preview-plus.cson');
}
function loadMacrosFile(filePath) {
    if (!CSON.isObjectPath(filePath)) {
        return {};
    }
    return CSON.readFileSync(filePath, function (error, object) {
        if (object === undefined) {
            object = {};
        }
        if (error !== undefined) {
            console.warn(`Error reading Latex Macros file '${filePath}': ${error.stack !== undefined ? error.stack : error}`);
            atom.notifications.addError(`Failed to load Latex Macros from '${filePath}'`, { detail: error.message, dismissable: true });
        }
        return object;
    });
}
function loadUserMacros() {
    const userMacrosPath = getUserMacrosPath();
    if (util_1.isFileSync(userMacrosPath)) {
        return loadMacrosFile(userMacrosPath);
    }
    else {
        console.debug('Creating markdown-preview-plus.cson, this is a one-time operation.');
        createMacrosTemplate(userMacrosPath);
        return loadMacrosFile(userMacrosPath);
    }
}
function createMacrosTemplate(filePath) {
    const templatePath = path.join(__dirname, '../assets/macros-template.cson');
    const templateFile = fs.readFileSync(templatePath, 'utf8');
    fs.writeFileSync(filePath, templateFile);
}
function checkMacros(macrosObject) {
    for (const name in macrosObject) {
        const value = macrosObject[name];
        if (!name.match(namePattern) || !valueMatchesPattern(value)) {
            delete macrosObject[name];
            atom.notifications.addError(`Failed to load LaTeX macro named '${name}'. Please see the [LaTeX guide](https://github.com/Galadirith/markdown-preview-plus/blob/master/LATEX.md#macro-names)`, { dismissable: true });
        }
    }
    return macrosObject;
}
function valueMatchesPattern(value) {
    if (Array.isArray(value)) {
        const macroDefinition = value[0];
        const numberOfArgs = value[1];
        if (typeof numberOfArgs === 'number') {
            return numberOfArgs % 1 === 0 && typeof macroDefinition === 'string';
        }
        else {
            return false;
        }
    }
    else if (typeof value === 'string') {
        return true;
    }
    else {
        return false;
    }
}
const configureMathJax = function (jax) {
    let userMacros = loadUserMacros();
    if (userMacros) {
        userMacros = checkMacros(userMacros);
    }
    else {
        userMacros = {};
    }
    jax.jaxConfigure(userMacros);
    if (atom.inDevMode()) {
        atom.notifications.addSuccess('Loaded maths rendering engine MathJax');
    }
};
async function attachMathJaxInternal(frame) {
    if (atom.inDevMode()) {
        atom.notifications.addInfo('Loading maths rendering engine MathJax');
    }
    await Promise.all([
        injectScript(frame.contentDocument, `${require.resolve('MathJax')}?delayStartupUntil=configured`),
        injectScript(frame.contentDocument, require.resolve('./mathjax-stub')),
    ]);
    configureMathJax(frame.contentWindow.mathJaxStub);
    return frame.contentWindow.mathJaxStub;
}
async function injectScript(doc, scriptSrc) {
    const script = doc.createElement('script');
    script.src = scriptSrc;
    script.type = 'text/javascript';
    doc.querySelector('head').appendChild(script);
    return new Promise((resolve) => {
        script.addEventListener('load', () => resolve());
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWF0aGpheC1oZWxwZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvbWF0aGpheC1oZWxwZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFPQSw2QkFBNkI7QUFDN0IsK0JBQStCO0FBQy9CLHlCQUF5QjtBQUN6QixpQ0FBbUM7QUFFbkMsSUFBSSxpQkFBaUIsR0FBRyxLQUFLLENBQUE7QUFTdEIsS0FBSyx3QkFDVixLQUF3QixFQUN4QixXQUFtQjtJQUVuQixFQUFFLENBQUMsQ0FBQyxpQkFBaUIsQ0FBQztRQUFDLE1BQU0sQ0FBQTtJQUM3QixNQUFNLEdBQUcsR0FBRyxNQUFNLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQTtJQUNwQyxHQUFHLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxDQUFBO0FBQy9CLENBQUM7QUFQRCxzQ0FPQztBQVNNLEtBQUssNEJBQ1YsS0FBd0IsRUFDeEIsSUFBWTtJQUVaLEVBQUUsQ0FBQyxDQUFDLGlCQUFpQixDQUFDLENBQUMsQ0FBQztRQUN0QixNQUFNLENBQUMsSUFBSSxDQUFBO0lBQ2IsQ0FBQztJQUNELE1BQU0sT0FBTyxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUE7SUFDN0MsT0FBTyxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUE7SUFFeEIsTUFBTSxHQUFHLEdBQUcsTUFBTSxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUE7SUFFcEMsTUFBTSxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFO1FBQzVCLEdBQUcsQ0FBQyxzQkFBc0IsQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUE7SUFDOUMsQ0FBQyxDQUFDLENBQUE7SUFFRixNQUFNLEtBQUssR0FBRyxRQUFRLENBQUMsY0FBYyxDQUFDLG9CQUFvQixDQUFDLENBQUE7SUFDM0QsTUFBTSxTQUFTLEdBQUcsS0FBSyxJQUFJLEtBQUssQ0FBQyxVQUFXLENBQUMsU0FBUyxDQUFDLElBQUksQ0FB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SUFBSSxHQUFHLGlCQUFpQixDQUFBO0lBQy9CLEdBQUcsQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFFLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFBO0lBQzlDLE1BQU0sQ0FBQyxJQUFJLE9BQU8sQ0FBTyxDQUFDLE9BQU8sRUFBRSxFQUFFO1FBQ25DLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsR0FBRyxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQTtJQUNsRCxDQUFDLENBQUMsQ0FBQTtBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvL1xuLy8gbWF0aGpheC1oZWxwZXJcbi8vXG4vLyBUaGlzIG1vZHVsZSB3aWxsIGhhbmRsZSBsb2FkaW5nIHRoZSBNYXRoSmF4IGVudmlyb25tZW50IGFuZCBwcm92aWRlIGEgd3JhcHBlclxuLy8gZm9yIGNhbGxzIHRvIE1hdGhKYXggdG8gcHJvY2VzcyBMYVRlWCBlcXVhdGlvbnMuXG4vL1xuXG5pbXBvcnQgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKVxuaW1wb3J0IENTT04gPSByZXF1aXJlKCdzZWFzb24nKVxuaW1wb3J0IGZzID0gcmVxdWlyZSgnZnMnKVxuaW1wb3J0IHsgaXNGaWxlU3luYyB9IGZyb20gJy4vdXRpbCdcblxubGV0IGlzTWF0aEpheERpc2FibGVkID0gZmFsc2VcblxuLy9cbi8vIFByb2Nlc3MgRE9NIGVsZW1lbnRzIGZvciBMYVRlWCBlcXVhdGlvbnMgd2l0aCBNYXRoSmF4XG4vL1xuLy8gQHBhcmFtIGRvbUVsZW1lbnRzIEFuIGFycmF5IG9mIERPTSBlbGVtZW50cyB0byBiZSBwcm9jZXNzZWQgYnkgTWF0aEpheC4gU2VlXG4vLyAgIFtlbGVtZW50XShodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvZWxlbWVudCkgZm9yXG4vLyAgIGRldGFpbHMgb24gRE9NIGVsZW1lbnRzLlxuLy9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBtYXRoUHJvY2Vzc29yKFxuICBmcmFtZTogSFRNTElGcmFtZUVsZW1lbnQsXG4gIGRvbUVsZW1lbnRzOiBOb2RlW10sXG4pIHtcbiAgaWYgKGlzTWF0aEpheERpc2FibGVkKSByZXR1cm5cbiAgY29uc3QgamF4ID0gYXdhaXQgbG9hZE1hdGhKYXgoZnJhbWUpXG4gIGpheC5xdWV1ZVR5cGVzZXQoZG9tRWxlbWVudHMpXG59XG5cbi8vXG4vLyBQcm9jZXNzIG1hdGhzIGluIEhUTUwgZnJhZ21lbnQgd2l0aCBNYXRoSmF4XG4vL1xuLy8gQHBhcmFtIGh0bWwgQSBIVE1MIGZyYWdtZW50IHN0cmluZ1xuLy8gQHBhcmFtIGNhbGxiYWNrIEEgY2FsbGJhY2sgbWV0aG9kIHRoYXQgYWNjZXB0cyBhIHNpbmdsZSBwYXJhbWV0ZXIsIGEgSFRNTFxuLy8gICBmcmFnbWVudCBzdHJpbmcgdGhhdCBpcyB0aGUgcmVzdWx0IG9mIGh0bWwgcHJvY2Vzc2VkIGJ5IE1hdGhKYXhcbi8vXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcHJvY2Vzc0hUTUxTdHJpbmcoXG4gIGZyYW1lOiBIVE1MSUZyYW1lRWxlbWVudCxcbiAgaHRtbDogc3RyaW5nLFxuKSB7XG4gIGlmIChpc01hdGhKYXhEaXNhYmxlZCkge1xuICAgIHJldHVybiBodG1sXG4gIH1cbiAgY29uc3QgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpXG4gIGVsZW1lbnQuaW5uZXJIVE1MID0gaHRtbFxuXG4gIGNvbnN0IGpheCA9IGF3YWl0IGxvYWRNYXRoSmF4KGZyYW1lKVxuXG4gIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgamF4LnF1ZXVlUHJvY2Vzc0hUTUxTdHJpbmcoZWxlbWVudCwgcmVzb2x2ZSlcbiAgfSlcblxuICBjb25zdCBtc3ZnaCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdNYXRoSmF4X1NWR19IaWRkZW4nKVxuICBjb25zdCBzdmdHbHlwaHMgPSBtc3ZnaCAmJiBtc3ZnaC5wYXJlbnROb2RlIS5jbG9uZU5vZGUodHJ1ZSlcbiAgaWYgKHN2Z0dseXBocyAhPT0gbnVsbCkge1xuICAgIGVsZW1lbnQuaW5zZXJ0QmVmb3JlKHN2Z0dseXBocywgZWxlbWVudC5maXJzdENoaWxkKVxuICB9XG4gIHJldHVybiBlbGVtZW50LmlubmVySFRNTFxufVxuXG4vLyBGb3IgdGVzdGluZ1xuZnVuY3Rpb24gZGlzYWJsZU1hdGhKYXgoZGlzYWJsZTogYm9vbGVhbikge1xuICBpc01hdGhKYXhEaXNhYmxlZCA9IGRpc2FibGVcbn1cblxuLy9cbi8vIExvYWQgTWF0aEpheCBlbnZpcm9ubWVudFxuLy9cbi8vIEBwYXJhbSBsaXN0ZW5lciBtZXRob2QgdG8gY2FsbCB3aGVuIHRoZSBNYXRoSmF4IHNjcmlwdCB3YXMgYmVlblxuLy8gICBsb2FkZWQgdG8gdGhlIHdpbmRvdy4gVGhlIG1ldGhvZCBpcyBwYXNzZWQgbm8gYXJndW1lbnRzLlxuLy9cbmFzeW5jIGZ1bmN0aW9uIGxvYWRNYXRoSmF4KGZyYW1lOiBIVE1MSUZyYW1lRWxlbWVudCk6IFByb21pc2U8TWF0aEpheFN0dWI+IHtcbiAgaWYgKGZyYW1lLmNvbnRlbnRXaW5kb3cubWF0aEpheFN0dWIpIHJldHVybiBmcmFtZS5jb250ZW50V2luZG93Lm1hdGhKYXhTdHViXG4gIGlmIChmcmFtZS5jb250ZW50RG9jdW1lbnQucXVlcnlTZWxlY3RvcignaGVhZCcpKSB7XG4gICAgcmV0dXJuIGF0dGFjaE1hdGhKYXgoZnJhbWUpXG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPE1hdGhKYXhTdHViPigocmVzb2x2ZSkgPT4ge1xuICAgICAgY29uc3Qgb25sb2FkID0gKCkgPT4ge1xuICAgICAgICBmcmFtZS5yZW1vdmVFdmVudExpc3RlbmVyKCdsb2FkJywgb25sb2FkKVxuICAgICAgICByZXNvbHZlKGxvYWRNYXRoSmF4KGZyYW1lKSlcbiAgICAgIH1cbiAgICAgIGZyYW1lLmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCBvbmxvYWQpXG4gICAgfSlcbiAgfVxufVxuXG4vL1xuLy8gQXR0YWNoIG1haW4gTWF0aEpheCBzY3JpcHQgdG8gdGhlIGRvY3VtZW50XG4vL1xuYXN5bmMgZnVuY3Rpb24gYXR0YWNoTWF0aEpheChmcmFtZTogSFRNTElGcmFtZUVsZW1lbnQpOiBQcm9taXNlPE1hdGhKYXhTdHViPiB7XG4gIGlmICghZnJhbWUuY29udGVudERvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ3NjcmlwdFtzcmMqPVwiTWF0aEpheC5qc1wiXScpKSB7XG4gICAgcmV0dXJuIGF0dGFjaE1hdGhKYXhJbnRlcm5hbChmcmFtZSlcbiAgfVxuICB0aHJvdyBuZXcgRXJyb3IoJ0R1cGxpY2F0ZSBhdHRhY2hNYXRoSmF4IGNhbGwnKVxufVxuXG5leHBvcnQgY29uc3QgdGVzdGluZyA9IHtcbiAgbG9hZE1hdGhKYXgsXG4gIGRpc2FibGVNYXRoSmF4LFxufVxuXG4vLyBwcml2YXRlXG5cbi8vXG4vLyBEZWZpbmUgc29tZSBmdW5jdGlvbnMgdG8gaGVscCBnZXQgYSBob2xkIG9mIHRoZSB1c2VyJ3MgTGF0ZXhcbi8vIE1hY3Jvcy5cbi8vXG5jb25zdCBuYW1lUGF0dGVybiA9IG5ldyBSZWdFeHAoYFxcXG5eW15hLXpBLVpcXFxcZFxcXFxzXSRcXFxufFxcXG5eW2EtekEtWl0qJFxcXG5gKSAvLyBsZXR0ZXJzLCBidXQgbm8gbnVtZXJhbHMuXG5cbmZ1bmN0aW9uIGdldFVzZXJNYWNyb3NQYXRoKCk6IHN0cmluZyB7XG4gIGNvbnN0IHVzZXJNYWNyb3NQYXRoOiBzdHJpbmcgfCB1bmRlZmluZWQgfCBudWxsID0gQ1NPTi5yZXNvbHZlKFxuICAgIHBhdGguam9pbihhdG9tLmdldENvbmZpZ0RpclBhdGgoKSwgJ21hcmtkb3duLXByZXZpZXctcGx1cycpLFxuICApXG4gIHJldHVybiB1c2VyTWFjcm9zUGF0aCAhPSBudWxsXG4gICAgPyB1c2VyTWFjcm9zUGF0aFxuICAgIDogcGF0aC5qb2luKGF0b20uZ2V0Q29uZmlnRGlyUGF0aCgpLCAnbWFya2Rvd24tcHJldmlldy1wbHVzLmNzb24nKVxufVxuXG5mdW5jdGlvbiBsb2FkTWFjcm9zRmlsZShmaWxlUGF0aDogc3RyaW5nKTogb2JqZWN0IHtcbiAgaWYgKCFDU09OLmlzT2JqZWN0UGF0aChmaWxlUGF0aCkpIHtcbiAgICByZXR1cm4ge31cbiAgfVxuICByZXR1cm4gQ1NPTi5yZWFkRmlsZVN5bmMoZmlsZVBhdGgsIGZ1bmN0aW9uKGVycm9yPzogRXJyb3IsIG9iamVjdD86IG9iamVjdCkge1xuICAgIGlmIChvYmplY3QgPT09IHVuZGVmaW5lZCkge1xuICAgICAgb2JqZWN0ID0ge31cbiAgICB9XG4gICAgaWYgKGVycm9yICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGNvbnNvbGUud2FybihcbiAgICAgICAgYEVycm9yIHJlYWRpbmcgTGF0ZXggTWFjcm9zIGZpbGUgJyR7ZmlsZVBhdGh9JzogJHtcbiAgICAgICAgICBlcnJvci5zdGFjayAhPT0gdW5kZWZpbmVkID8gZXJyb3Iuc3RhY2sgOiBlcnJvclxuICAgICAgICB9YCxcbiAgICAgIClcbiAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRFcnJvcihcbiAgICAgICAgYEZhaWxlZCB0byBsb2FkIExhdGV4IE1hY3JvcyBmcm9tICcke2ZpbGVQYXRofSdgLFxuICAgICAgICB7IGRldGFpbDogZXJyb3IubWVzc2FnZSwgZGlzbWlzc2FibGU6IHRydWUgfSxcbiAgICAgIClcbiAgICB9XG4gICAgcmV0dXJuIG9iamVjdFxuICB9KVxufVxuXG5mdW5jdGlvbiBsb2FkVXNlck1hY3JvcygpIHtcbiAgY29uc3QgdXNlck1hY3Jvc1BhdGggPSBnZXRVc2VyTWFjcm9zUGF0aCgpXG4gIGlmIChpc0ZpbGVTeW5jKHVzZXJNYWNyb3NQYXRoKSkge1xuICAgIHJldHVybiBsb2FkTWFjcm9zRmlsZSh1c2VyTWFjcm9zUGF0aClcbiAgfSBlbHNlIHtcbiAgICBjb25zb2xlLmRlYnVnKFxuICAgICAgJ0NyZWF0aW5nIG1hcmtkb3duLXByZXZpZXctcGx1cy5jc29uLCB0aGlzIGlzIGEgb25lLXRpbWUgb3BlcmF0aW9uLicsXG4gICAgKVxuICAgIGNyZWF0ZU1hY3Jvc1RlbXBsYXRlKHVzZXJNYWNyb3NQYXRoKVxuICAgIHJldHVybiBsb2FkTWFjcm9zRmlsZSh1c2VyTWFjcm9zUGF0aClcbiAgfVxufVxuXG5mdW5jdGlvbiBjcmVhdGVNYWNyb3NUZW1wbGF0ZShmaWxlUGF0aDogc3RyaW5nKSB7XG4gIGNvbnN0IHRlbXBsYXRlUGF0aCA9IHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi9hc3NldHMvbWFjcm9zLXRlbXBsYXRlLmNzb24nKVxuICBjb25zdCB0ZW1wbGF0ZUZpbGUgPSBmcy5yZWFkRmlsZVN5bmModGVtcGxhdGVQYXRoLCAndXRmOCcpXG4gIGZzLndyaXRlRmlsZVN5bmMoZmlsZVBhdGgsIHRlbXBsYXRlRmlsZSlcbn1cblxuZnVuY3Rpb24gY2hlY2tNYWNyb3MobWFjcm9zT2JqZWN0OiBvYmplY3QpIHtcbiAgZm9yIChjb25zdCBuYW1lIGluIG1hY3Jvc09iamVjdCkge1xuICAgIGNvbnN0IHZhbHVlID0gbWFjcm9zT2JqZWN0W25hbWVdXG4gICAgaWYgKCFuYW1lLm1hdGNoKG5hbWVQYXR0ZXJuKSB8fCAhdmFsdWVNYXRjaGVzUGF0dGVybih2YWx1ZSkpIHtcbiAgICAgIGRlbGV0ZSBtYWNyb3NPYmplY3RbbmFtZV1cbiAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRFcnJvcihcbiAgICAgICAgYEZhaWxlZCB0byBsb2FkIExhVGVYIG1hY3JvIG5hbWVkICcke25hbWV9Jy4gUGxlYXNlIHNlZSB0aGUgW0xhVGVYIGd1aWRlXShodHRwczovL2dpdGh1Yi5jb20vR2FsYWRpcml0aC9tYXJrZG93bi1wcmV2aWV3LXBsdXMvYmxvYi9tYXN0ZXIvTEFURVgubWQjbWFjcm8tbmFtZXMpYCxcbiAgICAgICAgeyBkaXNtaXNzYWJsZTogdHJ1ZSB9LFxuICAgICAgKVxuICAgIH1cbiAgfVxuICByZXR1cm4gbWFjcm9zT2JqZWN0XG59XG5cbmZ1bmN0aW9uIHZhbHVlTWF0Y2hlc1BhdHRlcm4odmFsdWU6IGFueSkge1xuICAvLyBEaWZmZXJlbnQgY2hlY2sgYmFzZWQgb24gd2hldGhlciB2YWx1ZSBpcyBzdHJpbmcgb3IgYXJyYXlcbiAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7XG4gICAgY29uc3QgbWFjcm9EZWZpbml0aW9uID0gdmFsdWVbMF1cbiAgICBjb25zdCBudW1iZXJPZkFyZ3MgPSB2YWx1ZVsxXVxuICAgIGlmICh0eXBlb2YgbnVtYmVyT2ZBcmdzID09PSAnbnVtYmVyJykge1xuICAgICAgcmV0dXJuIG51bWJlck9mQXJncyAlIDEgPT09IDAgJiYgdHlwZW9mIG1hY3JvRGVmaW5pdGlvbiA9PT0gJ3N0cmluZydcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIGZhbHNlXG4gICAgfVxuICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHtcbiAgICByZXR1cm4gdHJ1ZVxuICB9IGVsc2Uge1xuICAgIHJldHVybiBmYWxzZVxuICB9XG59XG5cbi8vIENvbmZpZ3VyZSBNYXRoSmF4IGVudmlyb25tZW50LiBTaW1pbGFyIHRvIHRoZSBUZVgtQU1TX0hUTUwgY29uZmlndXJhdGlvbiB3aXRoXG4vLyBhIGZldyB1bm5lY2Vzc2FyeSBmZWF0dXJlcyBzdHJpcHBlZCBhd2F5XG4vL1xuY29uc3QgY29uZmlndXJlTWF0aEpheCA9IGZ1bmN0aW9uKGpheDogTWF0aEpheFN0dWIpIHtcbiAgbGV0IHVzZXJNYWNyb3MgPSBsb2FkVXNlck1hY3JvcygpXG4gIGlmICh1c2VyTWFjcm9zKSB7XG4gICAgdXNlck1hY3JvcyA9IGNoZWNrTWFjcm9zKHVzZXJNYWNyb3MpXG4gIH0gZWxzZSB7XG4gICAgdXNlck1hY3JvcyA9IHt9XG4gIH1cblxuICBqYXguamF4Q29uZmlndXJlKHVzZXJNYWNyb3MpXG5cbiAgLy8gTm90aWZ5IHVzZXIgTWF0aEpheCBoYXMgbG9hZGVkXG4gIGlmIChhdG9tLmluRGV2TW9kZSgpKSB7XG4gICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZFN1Y2Nlc3MoJ0xvYWRlZCBtYXRocyByZW5kZXJpbmcgZW5naW5lIE1hdGhKYXgnKVxuICB9XG59XG5cbi8vXG4vLyBBdHRhY2ggbWFpbiBNYXRoSmF4IHNjcmlwdCB0byB0aGUgZG9jdW1lbnRcbi8vXG5hc3luYyBmdW5jdGlvbiBhdHRhY2hNYXRoSmF4SW50ZXJuYWwoXG4gIGZyYW1lOiBIVE1MSUZyYW1lRWxlbWVudCxcbik6IFByb21pc2U8TWF0aEpheFN0dWI+IHtcbiAgLy8gTm90aWZ5IHVzZXIgTWF0aEpheCBpcyBsb2FkaW5nXG4gIGlmIChhdG9tLmluRGV2TW9kZSgpKSB7XG4gICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEluZm8oJ0xvYWRpbmcgbWF0aHMgcmVuZGVyaW5nIGVuZ2luZSBNYXRoSmF4JylcbiAgfVxuXG4gIC8vIEF0dGFjaCBNYXRoSmF4IHNjcmlwdFxuICBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgaW5qZWN0U2NyaXB0KFxuICAgICAgZnJhbWUuY29udGVudERvY3VtZW50LFxuICAgICAgYCR7cmVxdWlyZS5yZXNvbHZlKCdNYXRoSmF4Jyl9P2RlbGF5U3RhcnR1cFVudGlsPWNvbmZpZ3VyZWRgLFxuICAgICksXG4gICAgaW5qZWN0U2NyaXB0KGZyYW1lLmNvbnRlbnREb2N1bWVudCwgcmVxdWlyZS5yZXNvbHZlKCcuL21hdGhqYXgtc3R1YicpKSxcbiAgXSlcbiAgY29uZmlndXJlTWF0aEpheChmcmFtZS5jb250ZW50V2luZG93Lm1hdGhKYXhTdHViKVxuICByZXR1cm4gZnJhbWUuY29udGVudFdpbmRvdy5tYXRoSmF4U3R1YlxufVxuXG5hc3luYyBmdW5jdGlvbiBpbmplY3RTY3JpcHQoZG9jOiBIVE1MRG9jdW1lbnQsIHNjcmlwdFNyYzogc3RyaW5nKSB7XG4gIGNvbnN0IHNjcmlwdCA9IGRvYy5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKVxuICBzY3JpcHQuc3JjID0gc2NyaXB0U3JjXG4gIHNjcmlwdC50eXBlID0gJ3RleHQvamF2YXNjcmlwdCdcbiAgZG9jLnF1ZXJ5U2VsZWN0b3IoJ2hlYWQnKSEuYXBwZW5kQ2hpbGQoc2NyaXB0KVxuICByZXR1cm4gbmV3IFByb21pc2U8dm9pZD4oKHJlc29sdmUpID0+IHtcbiAgICBzY3JpcHQuYWRkRXZlbnRMaXN0ZW5lcignbG9hZCcsICgpID0+IHJlc29sdmUoKSlcbiAgfSlcbn1cbiJdfQ==