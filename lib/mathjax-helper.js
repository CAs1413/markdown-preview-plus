"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const CSON = require("season");
const fs = require("fs");
const util_1 = require("./util");
let isMathJaxDisabled = false;
async function mathProcessor(frame, domElements) {
    if (isMathJaxDisabled)
        return;
    const jax = await loadMathJax(frame);
    jax.queueTypeset(domElements);
}
exports.mathProcessor = mathProcessor;
async function processHTMLString(frame, html) {
    if (isMathJaxDisabled) {
        return html;
    }
    const element = document.createElement('div');
    element.innerHTML = html;
    const jax = await loadMathJax(frame);
    await new Promise((resolve) => {
        jax.queueProcessHTMLString(element, resolve);
    });
    const msvgh = frame.contentDocument.getElementById('MathJax_SVG_Hidden');
    const svgGlyphs = msvgh && msvgh.parentNode.cloneNode(true);
    if (svgGlyphs !== null) {
        element.insertBefore(svgGlyphs, element.firstChild);
    }
    return element.innerHTML;
}
exports.processHTMLString = processHTMLString;
function disableMathJax(disable) {
    isMathJaxDisabled = disable;
}
async function loadMathJax(frame) {
    if (frame.contentWindow.mathJaxStub)
        return frame.contentWindow.mathJaxStub;
    if (frame.contentDocument.querySelector('head')) {
        return attachMathJax(frame);
    }
    else {
        return new Promise((resolve) => {
            const onload = () => {
                frame.removeEventListener('load', onload);
                resolve(loadMathJax(frame));
            };
            frame.addEventListener('load', onload);
        });
    }
}
async function attachMathJax(frame) {
    if (!frame.contentDocument.querySelector('script[src*="MathJax.js"]')) {
        return attachMathJaxInternal(frame);
    }
    throw new Error('Duplicate attachMathJax call');
}
exports.testing = {
    loadMathJax,
    disableMathJax,
};
const namePattern = new RegExp(`\
^[^a-zA-Z\\d\\s]$\
|\
^[a-zA-Z]*$\
`);
function getUserMacrosPath() {
    const userMacrosPath = CSON.resolve(path.join(atom.getConfigDirPath(), 'markdown-preview-plus'));
    return userMacrosPath != null
        ? userMacrosPath
        : path.join(atom.getConfigDirPath(), 'markdown-preview-plus.cson');
}
function loadMacrosFile(filePath) {
    if (!CSON.isObjectPath(filePath)) {
        return {};
    }
    return CSON.readFileSync(filePath, function (error, object) {
        if (object === undefined) {
            object = {};
        }
        if (error !== undefined) {
            console.warn(`Error reading Latex Macros file '${filePath}': ${error.stack !== undefined ? error.stack : error}`);
            atom.notifications.addError(`Failed to load Latex Macros from '${filePath}'`, { detail: error.message, dismissable: true });
        }
        return object;
    });
}
function loadUserMacros() {
    const userMacrosPath = getUserMacrosPath();
    if (util_1.isFileSync(userMacrosPath)) {
        return loadMacrosFile(userMacrosPath);
    }
    else {
        console.debug('Creating markdown-preview-plus.cson, this is a one-time operation.');
        createMacrosTemplate(userMacrosPath);
        return loadMacrosFile(userMacrosPath);
    }
}
function createMacrosTemplate(filePath) {
    const templatePath = path.join(__dirname, '../assets/macros-template.cson');
    const templateFile = fs.readFileSync(templatePath, 'utf8');
    fs.writeFileSync(filePath, templateFile);
}
function checkMacros(macrosObject) {
    for (const name in macrosObject) {
        const value = macrosObject[name];
        if (!name.match(namePattern) || !valueMatchesPattern(value)) {
            delete macrosObject[name];
            atom.notifications.addError(`Failed to load LaTeX macro named '${name}'. Please see the [LaTeX guide](https://github.com/Galadirith/markdown-preview-plus/blob/master/LATEX.md#macro-names)`, { dismissable: true });
        }
    }
    return macrosObject;
}
function valueMatchesPattern(value) {
    if (Array.isArray(value)) {
        const macroDefinition = value[0];
        const numberOfArgs = value[1];
        if (typeof numberOfArgs === 'number') {
            return numberOfArgs % 1 === 0 && typeof macroDefinition === 'string';
        }
        else {
            return false;
        }
    }
    else if (typeof value === 'string') {
        return true;
    }
    else {
        return false;
    }
}
const configureMathJax = function (jax) {
    let userMacros = loadUserMacros();
    if (userMacros) {
        userMacros = checkMacros(userMacros);
    }
    else {
        userMacros = {};
    }
    jax.jaxConfigure(userMacros);
    if (atom.inDevMode()) {
        atom.notifications.addSuccess('Loaded maths rendering engine MathJax');
    }
};
async function attachMathJaxInternal(frame) {
    if (atom.inDevMode()) {
        atom.notifications.addInfo('Loading maths rendering engine MathJax');
    }
    await Promise.all([
        injectScript(frame.contentDocument, `${require.resolve('MathJax')}?delayStartupUntil=configured`),
        injectScript(frame.contentDocument, require.resolve('./mathjax-stub')),
    ]);
    configureMathJax(frame.contentWindow.mathJaxStub);
    return frame.contentWindow.mathJaxStub;
}
async function injectScript(doc, scriptSrc) {
    const script = doc.createElement('script');
    script.src = scriptSrc;
    script.type = 'text/javascript';
    doc.querySelector('head').appendChild(script);
    return new Promise((resolve) => {
        script.addEventListener('load', () => resolve());
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWF0aGpheC1oZWxwZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvbWF0aGpheC1oZWxwZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFPQSw2QkFBNkI7QUFDN0IsK0JBQStCO0FBQy9CLHlCQUF5QjtBQUN6QixpQ0FBbUM7QUFFbkMsSUFBSSxpQkFBaUIsR0FBRyxLQUFLLENBQUE7QUFTdEIsS0FBSyx3QkFDVixLQUF3QixFQUN4QixXQUFtQjtJQUVuQixFQUFFLENBQUMsQ0FBQyxpQkFBaUIsQ0FBQztRQUFDLE1BQU0sQ0FBQTtJQUM3QixNQUFNLEdBQUcsR0FBRyxNQUFNLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQTtJQUNwQyxHQUFHLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxDQUFBO0FBQy9CLENBQUM7QUFQRCxzQ0FPQztBQVNNLEtBQUssNEJBQ1YsS0FBd0IsRUFDeEIsSUFBWTtJQUVaLEVBQUUsQ0FBQyxDQUFDLGlCQUFpQixDQUFDLENBQUMsQ0FBQztRQUN0QixNQUFNLENBQUMsSUFBSSxDQUFBO0lBQ2IsQ0FBQztJQUNELE1BQU0sT0FBTyxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUE7SUFDN0MsT0FBTyxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUE7SUFFeEIsTUFBTSxHQUFHLEdBQUcsTUFBTSxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUE7SUFFcEMsTUFBTSxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFO1FBQzVCLEdBQUcsQ0FBQyxzQkFBc0IsQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUE7SUFDOUMsQ0FBQyxDQUFDLENBQUE7SUFFRixNQUFNLEtBQUssR0FBRyxLQUFLLENBQUMsZUFBZSxDQUFDLGNBQWMsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFBO0lBQ3hFLE1BQU0sU0FBUyxHQUFHLEtBQUssSUFBSSxLQUFLLENBQUMsVUFBVyxDQUFDLFNBQVMsQ0FB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TUFBTSxDQUFDLElBQUksR0FBRyxpQkFBaUIsQ0FBQTtJQUMvQixHQUFHLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBRSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQTtJQUM5QyxNQUFNLENBQUMsSUFBSSxPQUFPLENBQU8sQ0FBQyxPQUFPLEVBQUUsRUFBRTtRQUNuQyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUE7SUFDbEQsQ0FBQyxDQUFDLENBQUE7QUFDSixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy9cbi8vIG1hdGhqYXgtaGVscGVyXG4vL1xuLy8gVGhpcyBtb2R1bGUgd2lsbCBoYW5kbGUgbG9hZGluZyB0aGUgTWF0aEpheCBlbnZpcm9ubWVudCBhbmQgcHJvdmlkZSBhIHdyYXBwZXJcbi8vIGZvciBjYWxscyB0byBNYXRoSmF4IHRvIHByb2Nlc3MgTGFUZVggZXF1YXRpb25zLlxuLy9cblxuaW1wb3J0IHBhdGggPSByZXF1aXJlKCdwYXRoJylcbmltcG9ydCBDU09OID0gcmVxdWlyZSgnc2Vhc29uJylcbmltcG9ydCBmcyA9IHJlcXVpcmUoJ2ZzJylcbmltcG9ydCB7IGlzRmlsZVN5bmMgfSBmcm9tICcuL3V0aWwnXG5cbmxldCBpc01hdGhKYXhEaXNhYmxlZCA9IGZhbHNlXG5cbi8vXG4vLyBQcm9jZXNzIERPTSBlbGVtZW50cyBmb3IgTGFUZVggZXF1YXRpb25zIHdpdGggTWF0aEpheFxuLy9cbi8vIEBwYXJhbSBkb21FbGVtZW50cyBBbiBhcnJheSBvZiBET00gZWxlbWVudHMgdG8gYmUgcHJvY2Vzc2VkIGJ5IE1hdGhKYXguIFNlZVxuLy8gICBbZWxlbWVudF0oaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL2VsZW1lbnQpIGZvclxuLy8gICBkZXRhaWxzIG9uIERPTSBlbGVtZW50cy5cbi8vXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gbWF0aFByb2Nlc3NvcihcbiAgZnJhbWU6IEhUTUxJRnJhbWVFbGVtZW50LFxuICBkb21FbGVtZW50czogTm9kZVtdLFxuKSB7XG4gIGlmIChpc01hdGhKYXhEaXNhYmxlZCkgcmV0dXJuXG4gIGNvbnN0IGpheCA9IGF3YWl0IGxvYWRNYXRoSmF4KGZyYW1lKVxuICBqYXgucXVldWVUeXBlc2V0KGRvbUVsZW1lbnRzKVxufVxuXG4vL1xuLy8gUHJvY2VzcyBtYXRocyBpbiBIVE1MIGZyYWdtZW50IHdpdGggTWF0aEpheFxuLy9cbi8vIEBwYXJhbSBodG1sIEEgSFRNTCBmcmFnbWVudCBzdHJpbmdcbi8vIEBwYXJhbSBjYWxsYmFjayBBIGNhbGxiYWNrIG1ldGhvZCB0aGF0IGFjY2VwdHMgYSBzaW5nbGUgcGFyYW1ldGVyLCBhIEhUTUxcbi8vICAgZnJhZ21lbnQgc3RyaW5nIHRoYXQgaXMgdGhlIHJlc3VsdCBvZiBodG1sIHByb2Nlc3NlZCBieSBNYXRoSmF4XG4vL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHByb2Nlc3NIVE1MU3RyaW5nKFxuICBmcmFtZTogSFRNTElGcmFtZUVsZW1lbnQsXG4gIGh0bWw6IHN0cmluZyxcbikge1xuICBpZiAoaXNNYXRoSmF4RGlzYWJsZWQpIHtcbiAgICByZXR1cm4gaHRtbFxuICB9XG4gIGNvbnN0IGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKVxuICBlbGVtZW50LmlubmVySFRNTCA9IGh0bWxcblxuICBjb25zdCBqYXggPSBhd2FpdCBsb2FkTWF0aEpheChmcmFtZSlcblxuICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgIGpheC5xdWV1ZVByb2Nlc3NIVE1MU3RyaW5nKGVsZW1lbnQsIHJlc29sdmUpXG4gIH0pXG5cbiAgY29uc3QgbXN2Z2ggPSBmcmFtZS5jb250ZW50RG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ01hdGhKYXhfU1ZHX0hpZGRlbicpXG4gIGNvbnN0IHN2Z0dseXBocyA9IG1zdmdoICYmIG1zdmdoLnBhcmVudE5vZGUhLmNsb25lTm9kZSh0cnVlKVxuICBpZiAoc3ZnR2x5cGhzICE9PSBudWxsKSB7XG4gICAgZWxlbWVudC5pbnNlcnRCZWZvcmUoc3ZnR2x5cGhzLCBlbGVtZW50LmZpcnN0Q2hpbGQpXG4gIH1cbiAgcmV0dXJuIGVsZW1lbnQuaW5uZXJIVE1MXG59XG5cbi8vIEZvciB0ZXN0aW5nXG5mdW5jdGlvbiBkaXNhYmxlTWF0aEpheChkaXNhYmxlOiBib29sZWFuKSB7XG4gIGlzTWF0aEpheERpc2FibGVkID0gZGlzYWJsZVxufVxuXG4vL1xuLy8gTG9hZCBNYXRoSmF4IGVudmlyb25tZW50XG4vL1xuLy8gQHBhcmFtIGxpc3RlbmVyIG1ldGhvZCB0byBjYWxsIHdoZW4gdGhlIE1hdGhKYXggc2NyaXB0IHdhcyBiZWVuXG4vLyAgIGxvYWRlZCB0byB0aGUgd2luZG93LiBUaGUgbWV0aG9kIGlzIHBhc3NlZCBubyBhcmd1bWVudHMuXG4vL1xuYXN5bmMgZnVuY3Rpb24gbG9hZE1hdGhKYXgoZnJhbWU6IEhUTUxJRnJhbWVFbGVtZW50KTogUHJvbWlzZTxNYXRoSmF4U3R1Yj4ge1xuICBpZiAoZnJhbWUuY29udGVudFdpbmRvdy5tYXRoSmF4U3R1YikgcmV0dXJuIGZyYW1lLmNvbnRlbnRXaW5kb3cubWF0aEpheFN0dWJcbiAgaWYgKGZyYW1lLmNvbnRlbnREb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdoZWFkJykpIHtcbiAgICByZXR1cm4gYXR0YWNoTWF0aEpheChmcmFtZSlcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8TWF0aEpheFN0dWI+KChyZXNvbHZlKSA9PiB7XG4gICAgICBjb25zdCBvbmxvYWQgPSAoKSA9PiB7XG4gICAgICAgIGZyYW1lLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2xvYWQnLCBvbmxvYWQpXG4gICAgICAgIHJlc29sdmUobG9hZE1hdGhKYXgoZnJhbWUpKVxuICAgICAgfVxuICAgICAgZnJhbWUuYWRkRXZlbnRMaXN0ZW5lcignbG9hZCcsIG9ubG9hZClcbiAgICB9KVxuICB9XG59XG5cbi8vXG4vLyBBdHRhY2ggbWFpbiBNYXRoSmF4IHNjcmlwdCB0byB0aGUgZG9jdW1lbnRcbi8vXG5hc3luYyBmdW5jdGlvbiBhdHRhY2hNYXRoSmF4KGZyYW1lOiBIVE1MSUZyYW1lRWxlbWVudCk6IFByb21pc2U8TWF0aEpheFN0dWI+IHtcbiAgaWYgKCFmcmFtZS5jb250ZW50RG9jdW1lbnQucXVlcnlTZWxlY3Rvcignc2NyaXB0W3NyYyo9XCJNYXRoSmF4LmpzXCJdJykpIHtcbiAgICByZXR1cm4gYXR0YWNoTWF0aEpheEludGVybmFsKGZyYW1lKVxuICB9XG4gIHRocm93IG5ldyBFcnJvcignRHVwbGljYXRlIGF0dGFjaE1hdGhKYXggY2FsbCcpXG59XG5cbmV4cG9ydCBjb25zdCB0ZXN0aW5nID0ge1xuICBsb2FkTWF0aEpheCxcbiAgZGlzYWJsZU1hdGhKYXgsXG59XG5cbi8vIHByaXZhdGVcblxuLy9cbi8vIERlZmluZSBzb21lIGZ1bmN0aW9ucyB0byBoZWxwIGdldCBhIGhvbGQgb2YgdGhlIHVzZXIncyBMYXRleFxuLy8gTWFjcm9zLlxuLy9cbmNvbnN0IG5hbWVQYXR0ZXJuID0gbmV3IFJlZ0V4cChgXFxcbl5bXmEtekEtWlxcXFxkXFxcXHNdJFxcXG58XFxcbl5bYS16QS1aXSokXFxcbmApIC8vIGxldHRlcnMsIGJ1dCBubyBudW1lcmFscy5cblxuZnVuY3Rpb24gZ2V0VXNlck1hY3Jvc1BhdGgoKTogc3RyaW5nIHtcbiAgY29uc3QgdXNlck1hY3Jvc1BhdGg6IHN0cmluZyB8IHVuZGVmaW5lZCB8IG51bGwgPSBDU09OLnJlc29sdmUoXG4gICAgcGF0aC5qb2luKGF0b20uZ2V0Q29uZmlnRGlyUGF0aCgpLCAnbWFya2Rvd24tcHJldmlldy1wbHVzJyksXG4gIClcbiAgcmV0dXJuIHVzZXJNYWNyb3NQYXRoICE9IG51bGxcbiAgICA/IHVzZXJNYWNyb3NQYXRoXG4gICAgOiBwYXRoLmpvaW4oYXRvbS5nZXRDb25maWdEaXJQYXRoKCksICdtYXJrZG93bi1wcmV2aWV3LXBsdXMuY3NvbicpXG59XG5cbmZ1bmN0aW9uIGxvYWRNYWNyb3NGaWxlKGZpbGVQYXRoOiBzdHJpbmcpOiBvYmplY3Qge1xuICBpZiAoIUNTT04uaXNPYmplY3RQYXRoKGZpbGVQYXRoKSkge1xuICAgIHJldHVybiB7fVxuICB9XG4gIHJldHVybiBDU09OLnJlYWRGaWxlU3luYyhmaWxlUGF0aCwgZnVuY3Rpb24oZXJyb3I/OiBFcnJvciwgb2JqZWN0Pzogb2JqZWN0KSB7XG4gICAgaWYgKG9iamVjdCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBvYmplY3QgPSB7fVxuICAgIH1cbiAgICBpZiAoZXJyb3IgIT09IHVuZGVmaW5lZCkge1xuICAgICAgY29uc29sZS53YXJuKFxuICAgICAgICBgRXJyb3IgcmVhZGluZyBMYXRleCBNYWNyb3MgZmlsZSAnJHtmaWxlUGF0aH0nOiAke1xuICAgICAgICAgIGVycm9yLnN0YWNrICE9PSB1bmRlZmluZWQgPyBlcnJvci5zdGFjayA6IGVycm9yXG4gICAgICAgIH1gLFxuICAgICAgKVxuICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEVycm9yKFxuICAgICAgICBgRmFpbGVkIHRvIGxvYWQgTGF0ZXggTWFjcm9zIGZyb20gJyR7ZmlsZVBhdGh9J2AsXG4gICAgICAgIHsgZGV0YWlsOiBlcnJvci5tZXNzYWdlLCBkaXNtaXNzYWJsZTogdHJ1ZSB9LFxuICAgICAgKVxuICAgIH1cbiAgICByZXR1cm4gb2JqZWN0XG4gIH0pXG59XG5cbmZ1bmN0aW9uIGxvYWRVc2VyTWFjcm9zKCkge1xuICBjb25zdCB1c2VyTWFjcm9zUGF0aCA9IGdldFVzZXJNYWNyb3NQYXRoKClcbiAgaWYgKGlzRmlsZVN5bmModXNlck1hY3Jvc1BhdGgpKSB7XG4gICAgcmV0dXJuIGxvYWRNYWNyb3NGaWxlKHVzZXJNYWNyb3NQYXRoKVxuICB9IGVsc2Uge1xuICAgIGNvbnNvbGUuZGVidWcoXG4gICAgICAnQ3JlYXRpbmcgbWFya2Rvd24tcHJldmlldy1wbHVzLmNzb24sIHRoaXMgaXMgYSBvbmUtdGltZSBvcGVyYXRpb24uJyxcbiAgICApXG4gICAgY3JlYXRlTWFjcm9zVGVtcGxhdGUodXNlck1hY3Jvc1BhdGgpXG4gICAgcmV0dXJuIGxvYWRNYWNyb3NGaWxlKHVzZXJNYWNyb3NQYXRoKVxuICB9XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZU1hY3Jvc1RlbXBsYXRlKGZpbGVQYXRoOiBzdHJpbmcpIHtcbiAgY29uc3QgdGVtcGxhdGVQYXRoID0gcGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL2Fzc2V0cy9tYWNyb3MtdGVtcGxhdGUuY3NvbicpXG4gIGNvbnN0IHRlbXBsYXRlRmlsZSA9IGZzLnJlYWRGaWxlU3luYyh0ZW1wbGF0ZVBhdGgsICd1dGY4JylcbiAgZnMud3JpdGVGaWxlU3luYyhmaWxlUGF0aCwgdGVtcGxhdGVGaWxlKVxufVxuXG5mdW5jdGlvbiBjaGVja01hY3JvcyhtYWNyb3NPYmplY3Q6IG9iamVjdCkge1xuICBmb3IgKGNvbnN0IG5hbWUgaW4gbWFjcm9zT2JqZWN0KSB7XG4gICAgY29uc3QgdmFsdWUgPSBtYWNyb3NPYmplY3RbbmFtZV1cbiAgICBpZiAoIW5hbWUubWF0Y2gobmFtZVBhdHRlcm4pIHx8ICF2YWx1ZU1hdGNoZXNQYXR0ZXJuKHZhbHVlKSkge1xuICAgICAgZGVsZXRlIG1hY3Jvc09iamVjdFtuYW1lXVxuICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEVycm9yKFxuICAgICAgICBgRmFpbGVkIHRvIGxvYWQgTGFUZVggbWFjcm8gbmFtZWQgJyR7bmFtZX0nLiBQbGVhc2Ugc2VlIHRoZSBbTGFUZVggZ3VpZGVdKGh0dHBzOi8vZ2l0aHViLmNvbS9HYWxhZGlyaXRoL21hcmtkb3duLXByZXZpZXctcGx1cy9ibG9iL21hc3Rlci9MQVRFWC5tZCNtYWNyby1uYW1lcylgLFxuICAgICAgICB7IGRpc21pc3NhYmxlOiB0cnVlIH0sXG4gICAgICApXG4gICAgfVxuICB9XG4gIHJldHVybiBtYWNyb3NPYmplY3Rcbn1cblxuZnVuY3Rpb24gdmFsdWVNYXRjaGVzUGF0dGVybih2YWx1ZTogYW55KSB7XG4gIC8vIERpZmZlcmVudCBjaGVjayBiYXNlZCBvbiB3aGV0aGVyIHZhbHVlIGlzIHN0cmluZyBvciBhcnJheVxuICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcbiAgICBjb25zdCBtYWNyb0RlZmluaXRpb24gPSB2YWx1ZVswXVxuICAgIGNvbnN0IG51bWJlck9mQXJncyA9IHZhbHVlWzFdXG4gICAgaWYgKHR5cGVvZiBudW1iZXJPZkFyZ3MgPT09ICdudW1iZXInKSB7XG4gICAgICByZXR1cm4gbnVtYmVyT2ZBcmdzICUgMSA9PT0gMCAmJiB0eXBlb2YgbWFjcm9EZWZpbml0aW9uID09PSAnc3RyaW5nJ1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG4gIH0gZWxzZSBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykge1xuICAgIHJldHVybiB0cnVlXG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGZhbHNlXG4gIH1cbn1cblxuLy8gQ29uZmlndXJlIE1hdGhKYXggZW52aXJvbm1lbnQuIFNpbWlsYXIgdG8gdGhlIFRlWC1BTVNfSFRNTCBjb25maWd1cmF0aW9uIHdpdGhcbi8vIGEgZmV3IHVubmVjZXNzYXJ5IGZlYXR1cmVzIHN0cmlwcGVkIGF3YXlcbi8vXG5jb25zdCBjb25maWd1cmVNYXRoSmF4ID0gZnVuY3Rpb24oamF4OiBNYXRoSmF4U3R1Yikge1xuICBsZXQgdXNlck1hY3JvcyA9IGxvYWRVc2VyTWFjcm9zKClcbiAgaWYgKHVzZXJNYWNyb3MpIHtcbiAgICB1c2VyTWFjcm9zID0gY2hlY2tNYWNyb3ModXNlck1hY3JvcylcbiAgfSBlbHNlIHtcbiAgICB1c2VyTWFjcm9zID0ge31cbiAgfVxuXG4gIGpheC5qYXhDb25maWd1cmUodXNlck1hY3JvcylcblxuICAvLyBOb3RpZnkgdXNlciBNYXRoSmF4IGhhcyBsb2FkZWRcbiAgaWYgKGF0b20uaW5EZXZNb2RlKCkpIHtcbiAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkU3VjY2VzcygnTG9hZGVkIG1hdGhzIHJlbmRlcmluZyBlbmdpbmUgTWF0aEpheCcpXG4gIH1cbn1cblxuLy9cbi8vIEF0dGFjaCBtYWluIE1hdGhKYXggc2NyaXB0IHRvIHRoZSBkb2N1bWVudFxuLy9cbmFzeW5jIGZ1bmN0aW9uIGF0dGFjaE1hdGhKYXhJbnRlcm5hbChcbiAgZnJhbWU6IEhUTUxJRnJhbWVFbGVtZW50LFxuKTogUHJvbWlzZTxNYXRoSmF4U3R1Yj4ge1xuICAvLyBOb3RpZnkgdXNlciBNYXRoSmF4IGlzIGxvYWRpbmdcbiAgaWYgKGF0b20uaW5EZXZNb2RlKCkpIHtcbiAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkSW5mbygnTG9hZGluZyBtYXRocyByZW5kZXJpbmcgZW5naW5lIE1hdGhKYXgnKVxuICB9XG5cbiAgLy8gQXR0YWNoIE1hdGhKYXggc2NyaXB0XG4gIGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICBpbmplY3RTY3JpcHQoXG4gICAgICBmcmFtZS5jb250ZW50RG9jdW1lbnQsXG4gICAgICBgJHtyZXF1aXJlLnJlc29sdmUoJ01hdGhKYXgnKX0/ZGVsYXlTdGFydHVwVW50aWw9Y29uZmlndXJlZGAsXG4gICAgKSxcbiAgICBpbmplY3RTY3JpcHQoZnJhbWUuY29udGVudERvY3VtZW50LCByZXF1aXJlLnJlc29sdmUoJy4vbWF0aGpheC1zdHViJykpLFxuICBdKVxuICBjb25maWd1cmVNYXRoSmF4KGZyYW1lLmNvbnRlbnRXaW5kb3cubWF0aEpheFN0dWIpXG4gIHJldHVybiBmcmFtZS5jb250ZW50V2luZG93Lm1hdGhKYXhTdHViXG59XG5cbmFzeW5jIGZ1bmN0aW9uIGluamVjdFNjcmlwdChkb2M6IEhUTUxEb2N1bWVudCwgc2NyaXB0U3JjOiBzdHJpbmcpIHtcbiAgY29uc3Qgc2NyaXB0ID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpXG4gIHNjcmlwdC5zcmMgPSBzY3JpcHRTcmNcbiAgc2NyaXB0LnR5cGUgPSAndGV4dC9qYXZhc2NyaXB0J1xuICBkb2MucXVlcnlTZWxlY3RvcignaGVhZCcpIS5hcHBlbmRDaGlsZChzY3JpcHQpXG4gIHJldHVybiBuZXcgUHJvbWlzZTx2b2lkPigocmVzb2x2ZSkgPT4ge1xuICAgIHNjcmlwdC5hZGRFdmVudExpc3RlbmVyKCdsb2FkJywgKCkgPT4gcmVzb2x2ZSgpKVxuICB9KVxufVxuIl19