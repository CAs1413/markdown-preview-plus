"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const CSON = require("season");
const fs = require("fs");
const util_1 = require("./util");
let isMathJaxDisabled = false;
function mathProcessor(frame, domElements) {
    if (isMathJaxDisabled)
        return;
    if (frame.contentWindow.queueTypeset) {
        frame.contentWindow.queueTypeset(domElements);
    }
    else {
        loadMathJax(frame, () => {
            frame.contentWindow.queueTypeset(domElements);
        });
    }
}
exports.mathProcessor = mathProcessor;
function processHTMLString(frame, html, callback) {
    if (isMathJaxDisabled) {
        callback(html);
        return;
    }
    const element = document.createElement('div');
    element.innerHTML = html;
    const compileProcessedHTMLString = function () {
        const msvgh = document.getElementById('MathJax_SVG_Hidden');
        const svgGlyphs = msvgh && msvgh.parentNode.cloneNode(true);
        if (svgGlyphs !== null) {
            element.insertBefore(svgGlyphs, element.firstChild);
        }
        return element.innerHTML;
    };
    const queueProcessHTMLString = (jax) => {
        jax.Hub.Queue(['setRenderer', jax.Hub, 'SVG'], ['Typeset', jax.Hub, element], ['setRenderer', jax.Hub, 'HTML-CSS'], [
            () => {
                callback(compileProcessedHTMLString());
            },
        ]);
    };
    if (frame.contentWindow.MathJax) {
        queueProcessHTMLString(frame.contentWindow.MathJax);
    }
    else {
        loadMathJax(frame, queueProcessHTMLString);
    }
}
exports.processHTMLString = processHTMLString;
function disableMathJax(disable) {
    isMathJaxDisabled = disable;
}
function loadMathJax(frame, listener) {
    if (frame.contentDocument.querySelector('head')) {
        const script = attachMathJax(frame);
        if (listener) {
            script.addEventListener('load', () => {
                listener(frame.contentWindow.MathJax);
            });
        }
    }
    else {
        const onload = () => {
            frame.removeEventListener('load', onload);
            loadMathJax(frame, listener);
        };
        frame.addEventListener('load', onload);
    }
}
function attachMathJax(frame) {
    if (!frame.contentDocument.querySelector('script[src*="MathJax.js"]')) {
        return attachMathJaxInternal(frame);
    }
    throw new Error('Duplicate attachMathJax call');
}
function resetMathJax() {
    for (const el of Array.from(document.querySelectorAll('script[src*="MathJax.js"]'))) {
        el.remove();
    }
    window.MathJax = undefined;
    delete window.MathJax;
}
exports.testing = {
    loadMathJax,
    resetMathJax,
    disableMathJax,
};
const namePattern = new RegExp(`\
^[^a-zA-Z\\d\\s]$\
|\
^[a-zA-Z]*$\
`);
function getUserMacrosPath() {
    const userMacrosPath = CSON.resolve(path.join(atom.getConfigDirPath(), 'markdown-preview-plus'));
    return userMacrosPath != null
        ? userMacrosPath
        : path.join(atom.getConfigDirPath(), 'markdown-preview-plus.cson');
}
function loadMacrosFile(filePath) {
    if (!CSON.isObjectPath(filePath)) {
        return {};
    }
    return CSON.readFileSync(filePath, function (error, object) {
        if (object === undefined) {
            object = {};
        }
        if (error !== undefined) {
            console.warn(`Error reading Latex Macros file '${filePath}': ${error.stack !== undefined ? error.stack : error}`);
            atom.notifications.addError(`Failed to load Latex Macros from '${filePath}'`, { detail: error.message, dismissable: true });
        }
        return object;
    });
}
function loadUserMacros() {
    const userMacrosPath = getUserMacrosPath();
    if (util_1.isFileSync(userMacrosPath)) {
        return loadMacrosFile(userMacrosPath);
    }
    else {
        console.debug('Creating markdown-preview-plus.cson, this is a one-time operation.');
        createMacrosTemplate(userMacrosPath);
        return loadMacrosFile(userMacrosPath);
    }
}
function createMacrosTemplate(filePath) {
    const templatePath = path.join(__dirname, '../assets/macros-template.cson');
    const templateFile = fs.readFileSync(templatePath, 'utf8');
    fs.writeFileSync(filePath, templateFile);
}
function checkMacros(macrosObject) {
    for (const name in macrosObject) {
        const value = macrosObject[name];
        if (!name.match(namePattern) || !valueMatchesPattern(value)) {
            delete macrosObject[name];
            atom.notifications.addError(`Failed to load LaTeX macro named '${name}'. Please see the [LaTeX guide](https://github.com/Galadirith/markdown-preview-plus/blob/master/LATEX.md#macro-names)`, { dismissable: true });
        }
    }
    return macrosObject;
}
function valueMatchesPattern(value) {
    if (Array.isArray(value)) {
        const macroDefinition = value[0];
        const numberOfArgs = value[1];
        if (typeof numberOfArgs === 'number') {
            return numberOfArgs % 1 === 0 && typeof macroDefinition === 'string';
        }
        else {
            return false;
        }
    }
    else if (typeof value === 'string') {
        return true;
    }
    else {
        return false;
    }
}
const configureMathJax = function (jax) {
    let userMacros = loadUserMacros();
    if (userMacros) {
        userMacros = checkMacros(userMacros);
    }
    else {
        userMacros = {};
    }
    jax.jaxConfigure(userMacros);
    if (atom.inDevMode()) {
        atom.notifications.addSuccess('Loaded maths rendering engine MathJax');
    }
};
function attachMathJaxInternal(frame) {
    if (atom.inDevMode()) {
        atom.notifications.addInfo('Loading maths rendering engine MathJax');
    }
    const jaxScript = injectScript(frame.contentDocument, `${require.resolve('MathJax')}?delayStartupUntil=configured`);
    const myScript = injectScript(frame.contentDocument, require.resolve('./mathjax-stub'), () => {
        configureMathJax(frame.contentWindow);
    });
    return myScript;
}
function injectScript(doc, scriptSrc, callback) {
    const script = doc.createElement('script');
    script.src = scriptSrc;
    script.type = 'text/javascript';
    if (callback)
        script.addEventListener('load', callback);
    doc.querySelector('head').appendChild(script);
    return script;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWF0aGpheC1oZWxwZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvbWF0aGpheC1oZWxwZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFPQSw2QkFBNkI7QUFDN0IsK0JBQStCO0FBQy9CLHlCQUF5QjtBQUN6QixpQ0FBbUM7QUFFbkMsSUFBSSxpQkFBaUIsR0FBRyxLQUFLLENBQUE7QUFTN0IsdUJBQThCLEtBQXdCLEVBQUUsV0FBbUI7SUFDekUsRUFBRSxDQUFDLENBQUMsaUJBQWlCLENBQUM7UUFBQyxNQUFNLENBQUE7SUFDN0IsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO1FBQ3JDLEtBQUssQ0FBQyxhQUFhLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxDQUFBO0lBQy9DLENBQUM7SUFBQyxJQUFJLENBQUMsQ0FBQztRQUNOLFdBQVcsQ0FBQyxLQUFLLEVBQUUsR0FBRyxFQUFFO1lBQ3RCLEtBQUssQ0FBQyxhQUFhLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxDQUFBO1FBQy9DLENBQUMsQ0FBQyxDQUFBO0lBQ0osQ0FBQztBQUNILENBQUM7QUFURCxzQ0FTQztBQVNELDJCQUNFLEtBQXdCLEVBQ3hCLElBQVksRUFDWixRQUFrQztJQUVsQyxFQUFFLENBQUMsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLENBQUM7UUFDdEIsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQ2QsTUFBTSxDQUFBO0lBQ1IsQ0FBQztJQUNELE1BQU0sT0FBTyxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUE7SUFDN0MsT0FBTyxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUE7SUFFeEIsTUFBTSwwQkFBMEIsR0FBRztRQUNqQyxNQUFNLEtBQUssR0FBRyxRQUFRLENBQUMsY0FBYyxDQUFDLG9CQUFvQixDQUFDLENBQUE7UUFDM0QsTUFBTSxTQUFTLEdBQUcsS0FBSyxJ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QUFNLEVBQUUsUUFBUSxDQUFDLENBQUE7SUFDdkQsR0FBRyxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUUsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUE7SUFDOUMsTUFBTSxDQUFDLE1BQU0sQ0FBQTtBQUNmLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvL1xuLy8gbWF0aGpheC1oZWxwZXJcbi8vXG4vLyBUaGlzIG1vZHVsZSB3aWxsIGhhbmRsZSBsb2FkaW5nIHRoZSBNYXRoSmF4IGVudmlyb25tZW50IGFuZCBwcm92aWRlIGEgd3JhcHBlclxuLy8gZm9yIGNhbGxzIHRvIE1hdGhKYXggdG8gcHJvY2VzcyBMYVRlWCBlcXVhdGlvbnMuXG4vL1xuXG5pbXBvcnQgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKVxuaW1wb3J0IENTT04gPSByZXF1aXJlKCdzZWFzb24nKVxuaW1wb3J0IGZzID0gcmVxdWlyZSgnZnMnKVxuaW1wb3J0IHsgaXNGaWxlU3luYyB9IGZyb20gJy4vdXRpbCdcblxubGV0IGlzTWF0aEpheERpc2FibGVkID0gZmFsc2VcblxuLy9cbi8vIFByb2Nlc3MgRE9NIGVsZW1lbnRzIGZvciBMYVRlWCBlcXVhdGlvbnMgd2l0aCBNYXRoSmF4XG4vL1xuLy8gQHBhcmFtIGRvbUVsZW1lbnRzIEFuIGFycmF5IG9mIERPTSBlbGVtZW50cyB0byBiZSBwcm9jZXNzZWQgYnkgTWF0aEpheC4gU2VlXG4vLyAgIFtlbGVtZW50XShodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvZWxlbWVudCkgZm9yXG4vLyAgIGRldGFpbHMgb24gRE9NIGVsZW1lbnRzLlxuLy9cbmV4cG9ydCBmdW5jdGlvbiBtYXRoUHJvY2Vzc29yKGZyYW1lOiBIVE1MSUZyYW1lRWxlbWVudCwgZG9tRWxlbWVudHM6IE5vZGVbXSkge1xuICBpZiAoaXNNYXRoSmF4RGlzYWJsZWQpIHJldHVyblxuICBpZiAoZnJhbWUuY29udGVudFdpbmRvdy5xdWV1ZVR5cGVzZXQpIHtcbiAgICBmcmFtZS5jb250ZW50V2luZG93LnF1ZXVlVHlwZXNldChkb21FbGVtZW50cylcbiAgfSBlbHNlIHtcbiAgICBsb2FkTWF0aEpheChmcmFtZSwgKCkgPT4ge1xuICAgICAgZnJhbWUuY29udGVudFdpbmRvdy5xdWV1ZVR5cGVzZXQoZG9tRWxlbWVudHMpXG4gICAgfSlcbiAgfVxufVxuXG4vL1xuLy8gUHJvY2VzcyBtYXRocyBpbiBIVE1MIGZyYWdtZW50IHdpdGggTWF0aEpheFxuLy9cbi8vIEBwYXJhbSBodG1sIEEgSFRNTCBmcmFnbWVudCBzdHJpbmdcbi8vIEBwYXJhbSBjYWxsYmFjayBBIGNhbGxiYWNrIG1ldGhvZCB0aGF0IGFjY2VwdHMgYSBzaW5nbGUgcGFyYW1ldGVyLCBhIEhUTUxcbi8vICAgZnJhZ21lbnQgc3RyaW5nIHRoYXQgaXMgdGhlIHJlc3VsdCBvZiBodG1sIHByb2Nlc3NlZCBieSBNYXRoSmF4XG4vL1xuZXhwb3J0IGZ1bmN0aW9uIHByb2Nlc3NIVE1MU3RyaW5nKFxuICBmcmFtZTogSFRNTElGcmFtZUVsZW1lbnQsXG4gIGh0bWw6IHN0cmluZyxcbiAgY2FsbGJhY2s6IChwcm9IVE1MOiBzdHJpbmcpID0+IGFueSxcbikge1xuICBpZiAoaXNNYXRoSmF4RGlzYWJsZWQpIHtcbiAgICBjYWxsYmFjayhodG1sKVxuICAgIHJldHVyblxuICB9XG4gIGNvbnN0IGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKVxuICBlbGVtZW50LmlubmVySFRNTCA9IGh0bWxcblxuICBjb25zdCBjb21waWxlUHJvY2Vzc2VkSFRNTFN0cmluZyA9IGZ1bmN0aW9uKCkge1xuICAgIGNvbnN0IG1zdmdoID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ01hdGhKYXhfU1ZHX0hpZGRlbicpXG4gICAgY29uc3Qgc3ZnR2x5cGhzID0gbXN2Z2ggJiYgbXN2Z2gucGFyZW50Tm9kZSEuY2xvbmVOb2RlKHRydWUpXG4gICAgaWYgKHN2Z0dseXBocyAhPT0gbnVsbCkge1xuICAgICAgZWxlbWVudC5pbnNlcnRCZWZvcmUoc3ZnR2x5cGhzLCBlbGVtZW50LmZpcnN0Q2hpbGQpXG4gICAgfVxuICAgIHJldHVybiBlbGVtZW50LmlubmVySFRNTFxuICB9XG5cbiAgY29uc3QgcXVldWVQcm9jZXNzSFRNTFN0cmluZyA9IChqYXg6IHR5cGVvZiBNYXRoSmF4KSA9PiB7XG4gICAgamF4Lkh1Yi5RdWV1ZShcbiAgICAgIFsnc2V0UmVuZGVyZXInLCBqYXguSHViLCAnU1ZHJ10sXG4gICAgICBbJ1R5cGVzZXQnLCBqYXguSHViLCBlbGVtZW50XSxcbiAgICAgIFsnc2V0UmVuZGVyZXInLCBqYXguSHViLCAnSFRNTC1DU1MnXSxcbiAgICAgIFtcbiAgICAgICAgKCkgPT4ge1xuICAgICAgICAgIGNhbGxiYWNrKGNvbXBpbGVQcm9jZXNzZWRIVE1MU3RyaW5nKCkpXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgIClcbiAgfVxuXG4gIGlmIChmcmFtZS5jb250ZW50V2luZG93Lk1hdGhKYXgpIHtcbiAgICBxdWV1ZVByb2Nlc3NIVE1MU3RyaW5nKGZyYW1lLmNvbnRlbnRXaW5kb3cuTWF0aEpheClcbiAgfSBlbHNlIHtcbiAgICBsb2FkTWF0aEpheChmcmFtZSwgcXVldWVQcm9jZXNzSFRNTFN0cmluZylcbiAgfVxufVxuXG4vLyBGb3IgdGVzdGluZ1xuZnVuY3Rpb24gZGlzYWJsZU1hdGhKYXgoZGlzYWJsZTogYm9vbGVhbikge1xuICBpc01hdGhKYXhEaXNhYmxlZCA9IGRpc2FibGVcbn1cblxuLy9cbi8vIExvYWQgTWF0aEpheCBlbnZpcm9ubWVudFxuLy9cbi8vIEBwYXJhbSBsaXN0ZW5lciBtZXRob2QgdG8gY2FsbCB3aGVuIHRoZSBNYXRoSmF4IHNjcmlwdCB3YXMgYmVlblxuLy8gICBsb2FkZWQgdG8gdGhlIHdpbmRvdy4gVGhlIG1ldGhvZCBpcyBwYXNzZWQgbm8gYXJndW1lbnRzLlxuLy9cbmZ1bmN0aW9uIGxvYWRNYXRoSmF4KFxuICBmcmFtZTogSFRNTElGcmFtZUVsZW1lbnQsXG4gIGxpc3RlbmVyPzogKGpheDogdHlwZW9mIE1hdGhKYXgpID0+IGFueSxcbikge1xuICBpZiAoZnJhbWUuY29udGVudERvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2hlYWQnKSkge1xuICAgIGNvbnN0IHNjcmlwdCA9IGF0dGFjaE1hdGhKYXgoZnJhbWUpXG4gICAgaWYgKGxpc3RlbmVyKSB7XG4gICAgICBzY3JpcHQuYWRkRXZlbnRMaXN0ZW5lcignbG9hZCcsICgpID0+IHtcbiAgICAgICAgbGlzdGVuZXIoZnJhbWUuY29udGVudFdpbmRvdy5NYXRoSmF4ISlcbiAgICAgIH0pXG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGNvbnN0IG9ubG9hZCA9ICgpID0+IHtcbiAgICAgIGZyYW1lLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2xvYWQnLCBvbmxvYWQpXG4gICAgICBsb2FkTWF0aEpheChmcmFtZSwgbGlzdGVuZXIpXG4gICAgfVxuICAgIGZyYW1lLmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCBvbmxvYWQpXG4gIH1cbn1cblxuLy9cbi8vIEF0dGFjaCBtYWluIE1hdGhKYXggc2NyaXB0IHRvIHRoZSBkb2N1bWVudFxuLy9cbmZ1bmN0aW9uIGF0dGFjaE1hdGhKYXgoZnJhbWU6IEhUTUxJRnJhbWVFbGVtZW50KSB7XG4gIGlmICghZnJhbWUuY29udGVudERvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ3NjcmlwdFtzcmMqPVwiTWF0aEpheC5qc1wiXScpKSB7XG4gICAgcmV0dXJuIGF0dGFjaE1hdGhKYXhJbnRlcm5hbChmcmFtZSlcbiAgfVxuICB0aHJvdyBuZXcgRXJyb3IoJ0R1cGxpY2F0ZSBhdHRhY2hNYXRoSmF4IGNhbGwnKVxufVxuXG4vL1xuLy8gUmVtb3ZlIE1hdGhKYXggZnJvbSB0aGUgZG9jdW1lbnQgYW5kIHJlc2V0IGF0dGFjaCBtZXRob2Rcbi8vXG5mdW5jdGlvbiByZXNldE1hdGhKYXgoKSB7XG4gIC8vIERldGFjaCBNYXRoSmF4IGZyb20gdGhlIGRvY3VtZW50XG4gIGZvciAoY29uc3QgZWwgb2YgQXJyYXkuZnJvbShcbiAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdzY3JpcHRbc3JjKj1cIk1hdGhKYXguanNcIl0nKSxcbiAgKSkge1xuICAgIGVsLnJlbW92ZSgpXG4gIH1cbiAgd2luZG93Lk1hdGhKYXggPSB1bmRlZmluZWRcblxuICAvLyBSZXNldCBhdHRhY2ggZm9yIGFueSBzdWJzZXF1ZW50IGNhbGxzXG4gIGRlbGV0ZSB3aW5kb3cuTWF0aEpheFxufVxuXG5leHBvcnQgY29uc3QgdGVzdGluZyA9IHtcbiAgbG9hZE1hdGhKYXgsXG4gIHJlc2V0TWF0aEpheCxcbiAgZGlzYWJsZU1hdGhKYXgsXG59XG5cbi8vIHByaXZhdGVcblxuLy9cbi8vIERlZmluZSBzb21lIGZ1bmN0aW9ucyB0byBoZWxwIGdldCBhIGhvbGQgb2YgdGhlIHVzZXIncyBMYXRleFxuLy8gTWFjcm9zLlxuLy9cbmNvbnN0IG5hbWVQYXR0ZXJuID0gbmV3IFJlZ0V4cChgXFxcbl5bXmEtekEtWlxcXFxkXFxcXHNdJFxcXG58XFxcbl5bYS16QS1aXSokXFxcbmApIC8vIGxldHRlcnMsIGJ1dCBubyBudW1lcmFscy5cblxuZnVuY3Rpb24gZ2V0VXNlck1hY3Jvc1BhdGgoKTogc3RyaW5nIHtcbiAgY29uc3QgdXNlck1hY3Jvc1BhdGg6IHN0cmluZyB8IHVuZGVmaW5lZCB8IG51bGwgPSBDU09OLnJlc29sdmUoXG4gICAgcGF0aC5qb2luKGF0b20uZ2V0Q29uZmlnRGlyUGF0aCgpLCAnbWFya2Rvd24tcHJldmlldy1wbHVzJyksXG4gIClcbiAgcmV0dXJuIHVzZXJNYWNyb3NQYXRoICE9IG51bGxcbiAgICA/IHVzZXJNYWNyb3NQYXRoXG4gICAgOiBwYXRoLmpvaW4oYXRvbS5nZXRDb25maWdEaXJQYXRoKCksICdtYXJrZG93bi1wcmV2aWV3LXBsdXMuY3NvbicpXG59XG5cbmZ1bmN0aW9uIGxvYWRNYWNyb3NGaWxlKGZpbGVQYXRoOiBzdHJpbmcpOiBvYmplY3Qge1xuICBpZiAoIUNTT04uaXNPYmplY3RQYXRoKGZpbGVQYXRoKSkge1xuICAgIHJldHVybiB7fVxuICB9XG4gIHJldHVybiBDU09OLnJlYWRGaWxlU3luYyhmaWxlUGF0aCwgZnVuY3Rpb24oZXJyb3I/OiBFcnJvciwgb2JqZWN0Pzogb2JqZWN0KSB7XG4gICAgaWYgKG9iamVjdCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBvYmplY3QgPSB7fVxuICAgIH1cbiAgICBpZiAoZXJyb3IgIT09IHVuZGVmaW5lZCkge1xuICAgICAgY29uc29sZS53YXJuKFxuICAgICAgICBgRXJyb3IgcmVhZGluZyBMYXRleCBNYWNyb3MgZmlsZSAnJHtmaWxlUGF0aH0nOiAke1xuICAgICAgICAgIGVycm9yLnN0YWNrICE9PSB1bmRlZmluZWQgPyBlcnJvci5zdGFjayA6IGVycm9yXG4gICAgICAgIH1gLFxuICAgICAgKVxuICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEVycm9yKFxuICAgICAgICBgRmFpbGVkIHRvIGxvYWQgTGF0ZXggTWFjcm9zIGZyb20gJyR7ZmlsZVBhdGh9J2AsXG4gICAgICAgIHsgZGV0YWlsOiBlcnJvci5tZXNzYWdlLCBkaXNtaXNzYWJsZTogdHJ1ZSB9LFxuICAgICAgKVxuICAgIH1cbiAgICByZXR1cm4gb2JqZWN0XG4gIH0pXG59XG5cbmZ1bmN0aW9uIGxvYWRVc2VyTWFjcm9zKCkge1xuICBjb25zdCB1c2VyTWFjcm9zUGF0aCA9IGdldFVzZXJNYWNyb3NQYXRoKClcbiAgaWYgKGlzRmlsZVN5bmModXNlck1hY3Jvc1BhdGgpKSB7XG4gICAgcmV0dXJuIGxvYWRNYWNyb3NGaWxlKHVzZXJNYWNyb3NQYXRoKVxuICB9IGVsc2Uge1xuICAgIGNvbnNvbGUuZGVidWcoXG4gICAgICAnQ3JlYXRpbmcgbWFya2Rvd24tcHJldmlldy1wbHVzLmNzb24sIHRoaXMgaXMgYSBvbmUtdGltZSBvcGVyYXRpb24uJyxcbiAgICApXG4gICAgY3JlYXRlTWFjcm9zVGVtcGxhdGUodXNlck1hY3Jvc1BhdGgpXG4gICAgcmV0dXJuIGxvYWRNYWNyb3NGaWxlKHVzZXJNYWNyb3NQYXRoKVxuICB9XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZU1hY3Jvc1RlbXBsYXRlKGZpbGVQYXRoOiBzdHJpbmcpIHtcbiAgY29uc3QgdGVtcGxhdGVQYXRoID0gcGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL2Fzc2V0cy9tYWNyb3MtdGVtcGxhdGUuY3NvbicpXG4gIGNvbnN0IHRlbXBsYXRlRmlsZSA9IGZzLnJlYWRGaWxlU3luYyh0ZW1wbGF0ZVBhdGgsICd1dGY4JylcbiAgZnMud3JpdGVGaWxlU3luYyhmaWxlUGF0aCwgdGVtcGxhdGVGaWxlKVxufVxuXG5mdW5jdGlvbiBjaGVja01hY3JvcyhtYWNyb3NPYmplY3Q6IG9iamVjdCkge1xuICBmb3IgKGNvbnN0IG5hbWUgaW4gbWFjcm9zT2JqZWN0KSB7XG4gICAgY29uc3QgdmFsdWUgPSBtYWNyb3NPYmplY3RbbmFtZV1cbiAgICBpZiAoIW5hbWUubWF0Y2gobmFtZVBhdHRlcm4pIHx8ICF2YWx1ZU1hdGNoZXNQYXR0ZXJuKHZhbHVlKSkge1xuICAgICAgZGVsZXRlIG1hY3Jvc09iamVjdFtuYW1lXVxuICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEVycm9yKFxuICAgICAgICBgRmFpbGVkIHRvIGxvYWQgTGFUZVggbWFjcm8gbmFtZWQgJyR7bmFtZX0nLiBQbGVhc2Ugc2VlIHRoZSBbTGFUZVggZ3VpZGVdKGh0dHBzOi8vZ2l0aHViLmNvbS9HYWxhZGlyaXRoL21hcmtkb3duLXByZXZpZXctcGx1cy9ibG9iL21hc3Rlci9MQVRFWC5tZCNtYWNyby1uYW1lcylgLFxuICAgICAgICB7IGRpc21pc3NhYmxlOiB0cnVlIH0sXG4gICAgICApXG4gICAgfVxuICB9XG4gIHJldHVybiBtYWNyb3NPYmplY3Rcbn1cblxuZnVuY3Rpb24gdmFsdWVNYXRjaGVzUGF0dGVybih2YWx1ZTogYW55KSB7XG4gIC8vIERpZmZlcmVudCBjaGVjayBiYXNlZCBvbiB3aGV0aGVyIHZhbHVlIGlzIHN0cmluZyBvciBhcnJheVxuICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcbiAgICBjb25zdCBtYWNyb0RlZmluaXRpb24gPSB2YWx1ZVswXVxuICAgIGNvbnN0IG51bWJlck9mQXJncyA9IHZhbHVlWzFdXG4gICAgaWYgKHR5cGVvZiBudW1iZXJPZkFyZ3MgPT09ICdudW1iZXInKSB7XG4gICAgICByZXR1cm4gbnVtYmVyT2ZBcmdzICUgMSA9PT0gMCAmJiB0eXBlb2YgbWFjcm9EZWZpbml0aW9uID09PSAnc3RyaW5nJ1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG4gIH0gZWxzZSBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykge1xuICAgIHJldHVybiB0cnVlXG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGZhbHNlXG4gIH1cbn1cblxuLy8gQ29uZmlndXJlIE1hdGhKYXggZW52aXJvbm1lbnQuIFNpbWlsYXIgdG8gdGhlIFRlWC1BTVNfSFRNTCBjb25maWd1cmF0aW9uIHdpdGhcbi8vIGEgZmV3IHVubmVjZXNzYXJ5IGZlYXR1cmVzIHN0cmlwcGVkIGF3YXlcbi8vXG5jb25zdCBjb25maWd1cmVNYXRoSmF4ID0gZnVuY3Rpb24oamF4OiBhbnkpIHtcbiAgbGV0IHVzZXJNYWNyb3MgPSBsb2FkVXNlck1hY3JvcygpXG4gIGlmICh1c2VyTWFjcm9zKSB7XG4gICAgdXNlck1hY3JvcyA9IGNoZWNrTWFjcm9zKHVzZXJNYWNyb3MpXG4gIH0gZWxzZSB7XG4gICAgdXNlck1hY3JvcyA9IHt9XG4gIH1cblxuICBqYXguamF4Q29uZmlndXJlKHVzZXJNYWNyb3MpXG5cbiAgLy8gTm90aWZ5IHVzZXIgTWF0aEpheCBoYXMgbG9hZGVkXG4gIGlmIChhdG9tLmluRGV2TW9kZSgpKSB7XG4gICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZFN1Y2Nlc3MoJ0xvYWRlZCBtYXRocyByZW5kZXJpbmcgZW5naW5lIE1hdGhKYXgnKVxuICB9XG59XG5cbi8vXG4vLyBBdHRhY2ggbWFpbiBNYXRoSmF4IHNjcmlwdCB0byB0aGUgZG9jdW1lbnRcbi8vXG5mdW5jdGlvbiBhdHRhY2hNYXRoSmF4SW50ZXJuYWwoZnJhbWU6IEhUTUxJRnJhbWVFbGVtZW50KSB7XG4gIC8vIE5vdGlmeSB1c2VyIE1hdGhKYXggaXMgbG9hZGluZ1xuICBpZiAoYXRvbS5pbkRldk1vZGUoKSkge1xuICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRJbmZvKCdMb2FkaW5nIG1hdGhzIHJlbmRlcmluZyBlbmdpbmUgTWF0aEpheCcpXG4gIH1cblxuICAvLyBBdHRhY2ggTWF0aEpheCBzY3JpcHRcbiAgY29uc3QgamF4U2NyaXB0ID0gaW5qZWN0U2NyaXB0KFxuICAgIGZyYW1lLmNvbnRlbnREb2N1bWVudCxcbiAgICBgJHtyZXF1aXJlLnJlc29sdmUoJ01hdGhKYXgnKX0/ZGVsYXlTdGFydHVwVW50aWw9Y29uZmlndXJlZGAsXG4gIClcbiAgY29uc3QgbXlTY3JpcHQgPSBpbmplY3RTY3JpcHQoXG4gICAgZnJhbWUuY29udGVudERvY3VtZW50LFxuICAgIHJlcXVpcmUucmVzb2x2ZSgnLi9tYXRoamF4LXN0dWInKSxcbiAgICAoKSA9PiB7XG4gICAgICBjb25maWd1cmVNYXRoSmF4KGZyYW1lLmNvbnRlbnRXaW5kb3cpXG4gICAgfSxcbiAgKVxuXG4gIHJldHVybiBteVNjcmlwdFxufVxuXG5mdW5jdGlvbiBpbmplY3RTY3JpcHQoXG4gIGRvYzogSFRNTERvY3VtZW50LFxuICBzY3JpcHRTcmM6IHN0cmluZyxcbiAgY2FsbGJhY2s/OiAoKSA9PiB2b2lkLFxuKSB7XG4gIGNvbnN0IHNjcmlwdCA9IGRvYy5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKVxuICBzY3JpcHQuc3JjID0gc2NyaXB0U3JjXG4gIHNjcmlwdC50eXBlID0gJ3RleHQvamF2YXNjcmlwdCdcbiAgaWYgKGNhbGxiYWNrKSBzY3JpcHQuYWRkRXZlbnRMaXN0ZW5lcignbG9hZCcsIGNhbGxiYWNrKVxuICBkb2MucXVlcnlTZWxlY3RvcignaGVhZCcpIS5hcHBlbmRDaGlsZChzY3JpcHQpXG4gIHJldHVybiBzY3JpcHRcbn1cbiJdfQ==