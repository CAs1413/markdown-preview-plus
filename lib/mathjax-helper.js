"use strict";
const { $ } = require("atom-space-pen-views");
const path = require("path");
const CSON = require("season");
const fs = require("fs-plus");
const _ = require("lodash");
const namePattern = new RegExp(`\
^[^a-zA-Z\\d\\s]$\
|\
^[a-zA-Z]*$\
`);
const getUserMacrosPath = function () {
    const userMacrosPath = CSON.resolve(path.join(atom.getConfigDirPath(), "markdown-preview-plus"));
    return userMacrosPath != null
        ? userMacrosPath
        : path.join(atom.getConfigDirPath(), "markdown-preview-plus.cson");
};
const loadMacrosFile = function (filePath) {
    if (!CSON.isObjectPath(filePath)) {
        return {};
    }
    return CSON.readFileSync(filePath, function (error, object) {
        if (object == null) {
            object = {};
        }
        if (error != null) {
            console.warn(`Error reading Latex Macros file '${filePath}': ${error.stack != null ? error.stack : error}`);
            if (atom.notifications != null) {
                atom.notifications.addError(`Failed to load Latex Macros from '${filePath}'`, { detail: error.message, dismissable: true });
            }
        }
        return object;
    });
};
const loadUserMacros = function () {
    let result;
    const userMacrosPath = getUserMacrosPath();
    if (fs.isFileSync(userMacrosPath)) {
        return (result = loadMacrosFile(userMacrosPath));
    }
    else {
        console.log("Creating markdown-preview-plus.cson, this is a one-time operation.");
        createMacrosTemplate(userMacrosPath);
        return (result = loadMacrosFile(userMacrosPath));
    }
};
var createMacrosTemplate = function (filePath) {
    const templatePath = path.join(__dirname, "../assets/macros-template.cson");
    const templateFile = fs.readFileSync(templatePath, "utf8");
    return fs.writeFileSync(filePath, templateFile);
};
const checkMacros = function (macrosObject) {
    for (let name in macrosObject) {
        const value = macrosObject[name];
        if (!name.match(namePattern) || !valueMatchesPattern(value)) {
            delete macrosObject[name];
            if (atom.notifications != null) {
                atom.notifications.addError(`Failed to load LaTeX macro named '${name}'. Please see the [LaTeX guide](https://github.com/Galadirith/markdown-preview-plus/blob/master/LATEX.md#macro-names)`, { dismissable: true });
            }
        }
    }
    return macrosObject;
};
var valueMatchesPattern = function (value) {
    switch (false) {
        case Object.prototype.toString.call(value) !== "[object Array]":
            var macroDefinition = value[0];
            var numberOfArgs = value[1];
            if (typeof numberOfArgs === "number") {
                return numberOfArgs % 1 === 0 && typeof macroDefinition === "string";
            }
            else {
                return false;
            }
        case typeof value !== "string":
            return true;
        default:
            return false;
    }
};
const configureMathJax = function () {
    let userMacros = loadUserMacros();
    if (userMacros) {
        userMacros = checkMacros(userMacros);
    }
    else {
        userMacros = {};
    }
    MathJax.Hub.Config({
        jax: ["input/TeX", "output/HTML-CSS"],
        extensions: [],
        TeX: {
            extensions: [
                "AMSmath.js",
                "AMSsymbols.js",
                "noErrors.js",
                "noUndefined.js"
            ],
            Macros: userMacros
        },
        "HTML-CSS": {
            availableFonts: [],
            webFont: "TeX"
        },
        messageStyle: "none",
        showMathMenu: false,
        skipStartupTypeset: true
    });
    MathJax.Hub.Configured();
    if (atom.inDevMode()) {
        atom.notifications.addSuccess("Loaded maths rendering engine MathJax");
    }
};
var attachMathJax = function () {
    if (atom.inDevMode()) {
        atom.notifications.addInfo("Loading maths rendering engine MathJax");
    }
    const script = document.createElement("script");
    script.src = `${require.resolve("MathJax")}?delayStartupUntil=configured`;
    script.type = "text/javascript";
    script.addEventListener("load", () => configureMathJax());
    document.getElementsByTagName("head")[0].appendChild(script);
    return script;
};
function __guard__(value, transform) {
    return typeof value !== "undefined" && value !== null
        ? transform(value)
        : undefined;
}
module.exports = {
    loadMathJax(listener) {
        const script = this.attachMathJax();
        if (listener != null) {
            script.addEventListener("load", () => listener());
        }
    },
    attachMathJax: _.once(() => attachMathJax()),
    resetMathJax() {
        $('script[src*="MathJax.js"]').remove();
        window.MathJax = undefined;
        return (this.attachMathJax = _.once(() => attachMathJax()));
    },
    mathProcessor(domElements) {
        if (typeof MathJax !== "undefined" && MathJax !== null) {
            MathJax.Hub.Queue(["Typeset", MathJax.Hub, domElements]);
        }
        else {
            this.loadMathJax(() => MathJax.Hub.Queue(["Typeset", MathJax.Hub, domElements]));
        }
    },
    processHTMLString(html, callback) {
        const element = document.createElement("div");
        element.innerHTML = html;
        const compileProcessedHTMLString = function () {
            const svgGlyphs = __guard__(document.getElementById("MathJax_SVG_Hidden"), x => x.parentNode.cloneNode(true));
            if (svgGlyphs != null) {
                element.insertBefore(svgGlyphs, element.firstChild);
            }
            return element.innerHTML;
        };
        const queueProcessHTMLString = () => MathJax.Hub.Queue(["setRenderer", MathJax.Hub, "SVG"], ["Typeset", MathJax.Hub, element], ["setRenderer", MathJax.Hub, "HTML-CSS"], [() => callback(compileProcessedHTMLString())]);
        if (typeof MathJax !== "undefined" && MathJax !== null) {
            queueProcessHTMLString();
        }
        else {
            this.loadMathJax(queueProcessHTMLString);
        }
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWF0aGpheC1oZWxwZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvbWF0aGpheC1oZWxwZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQWNBLE1BQU0sRUFBRSxDQUFDLEVBQUUsR0FBRyxPQUFPLENBQUMsc0JBQXNCLENBQUMsQ0FBQTtBQUM3QyxNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUE7QUFDNUIsTUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFBO0FBQzlCLE1BQU0sRUFBRSxHQUFHLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQTtBQUM3QixNQUFNLENBQUMsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUE7QUE0RjNCLE1BQU0sV0FBVyxHQUFHLElBQUksTUFBTSxDQUFDOzs7O0NBSTlCLENBQUMsQ0FBQTtBQUVGLE1BQU0saUJBQWlCLEdBQUc7SUFDeEIsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FDakMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsRUFBRSx1QkFBdUIsQ0FBQyxDQUM1RCxDQUFBO0lBQ0QsTUFBTSxDQUFDLGNBQWMsSUFBSSxJQUFJO1FBQzNCLENBQUMsQ0FBQyxjQUFjO1FBQ2hCLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxFQUFFLDRCQUE0QixDQUFDLENBQUE7QUFDdEUsQ0FBQyxDQUFBO0FBRUQsTUFBTSxjQUFjLEdBQUcsVUFBUyxRQUFRO0lBQ3RDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDakMsTUFBTSxDQUFDLEVBQUUsQ0FBQTtJQUNYLENBQUM7SUFDRCxNQUFNLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLEVBQUUsVUFBUyxLQUFLLEVBQUUsTUFBTTtR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LENBQUM7SUFDSCxDQUFDO0NBQ0YsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBkZWNhZmZlaW5hdGUgc3VnZ2VzdGlvbnM6XG4gKiBEUzEwMjogUmVtb3ZlIHVubmVjZXNzYXJ5IGNvZGUgY3JlYXRlZCBiZWNhdXNlIG9mIGltcGxpY2l0IHJldHVybnNcbiAqIERTMTAzOiBSZXdyaXRlIGNvZGUgdG8gbm8gbG9uZ2VyIHVzZSBfX2d1YXJkX19cbiAqIERTMjA3OiBDb25zaWRlciBzaG9ydGVyIHZhcmlhdGlvbnMgb2YgbnVsbCBjaGVja3NcbiAqIEZ1bGwgZG9jczogaHR0cHM6Ly9naXRodWIuY29tL2RlY2FmZmVpbmF0ZS9kZWNhZmZlaW5hdGUvYmxvYi9tYXN0ZXIvZG9jcy9zdWdnZXN0aW9ucy5tZFxuICovXG4vL1xuLy8gbWF0aGpheC1oZWxwZXJcbi8vXG4vLyBUaGlzIG1vZHVsZSB3aWxsIGhhbmRsZSBsb2FkaW5nIHRoZSBNYXRoSmF4IGVudmlyb25tZW50IGFuZCBwcm92aWRlIGEgd3JhcHBlclxuLy8gZm9yIGNhbGxzIHRvIE1hdGhKYXggdG8gcHJvY2VzcyBMYVRlWCBlcXVhdGlvbnMuXG4vL1xuXG5jb25zdCB7ICQgfSA9IHJlcXVpcmUoXCJhdG9tLXNwYWNlLXBlbi12aWV3c1wiKVxuY29uc3QgcGF0aCA9IHJlcXVpcmUoXCJwYXRoXCIpXG5jb25zdCBDU09OID0gcmVxdWlyZShcInNlYXNvblwiKVxuY29uc3QgZnMgPSByZXF1aXJlKFwiZnMtcGx1c1wiKVxuY29uc3QgXyA9IHJlcXVpcmUoXCJsb2Rhc2hcIilcblxuZXhwb3J0ID0ge1xuICAvL1xuICAvLyBMb2FkIE1hdGhKYXggZW52aXJvbm1lbnRcbiAgLy9cbiAgLy8gQHBhcmFtIGxpc3RlbmVyIE9wdGlvbmFsIG1ldGhvZCB0byBjYWxsIHdoZW4gdGhlIE1hdGhKYXggc2NyaXB0IHdhcyBiZWVuXG4gIC8vICAgbG9hZGVkIHRvIHRoZSB3aW5kb3cuIFRoZSBtZXRob2QgaXMgcGFzc2VkIG5vIGFyZ3VtZW50cy5cbiAgLy9cbiAgbG9hZE1hdGhKYXgobGlzdGVuZXIpIHtcbiAgICBjb25zdCBzY3JpcHQgPSB0aGlzLmF0dGFjaE1hdGhKYXgoKVxuICAgIGlmIChsaXN0ZW5lciAhPSBudWxsKSB7XG4gICAgICBzY3JpcHQuYWRkRXZlbnRMaXN0ZW5lcihcImxvYWRcIiwgKCkgPT4gbGlzdGVuZXIoKSlcbiAgICB9XG4gIH0sXG5cbiAgLy9cbiAgLy8gQXR0YWNoIG1haW4gTWF0aEpheCBzY3JpcHQgdG8gdGhlIGRvY3VtZW50XG4gIC8vXG4gIGF0dGFjaE1hdGhKYXg6IF8ub25jZSgoKSA9PiBhdHRhY2hNYXRoSmF4KCkpLFxuXG4gIC8vXG4gIC8vIFJlbW92ZSBNYXRoSmF4IGZyb20gdGhlIGRvY3VtZW50IGFuZCByZXNldCBhdHRhY2ggbWV0aG9kXG4gIC8vXG4gIHJlc2V0TWF0aEpheCgpIHtcbiAgICAvLyBEZXRhY2ggTWF0aEpheCBmcm9tIHRoZSBkb2N1bWVudFxuICAgICQoJ3NjcmlwdFtzcmMqPVwiTWF0aEpheC5qc1wiXScpLnJlbW92ZSgpXG4gICAgd2luZG93Lk1hdGhKYXggPSB1bmRlZmluZWRcblxuICAgIC8vIFJlc2V0IGF0dGFjaCBmb3IgYW55IHN1YnNlcXVlbnQgY2FsbHNcbiAgICByZXR1cm4gKHRoaXMuYXR0YWNoTWF0aEpheCA9IF8ub25jZSgoKSA9PiBhdHRhY2hNYXRoSmF4KCkpKVxuICB9LFxuXG4gIC8vXG4gIC8vIFByb2Nlc3MgRE9NIGVsZW1lbnRzIGZvciBMYVRlWCBlcXVhdGlvbnMgd2l0aCBNYXRoSmF4XG4gIC8vXG4gIC8vIEBwYXJhbSBkb21FbGVtZW50cyBBbiBhcnJheSBvZiBET00gZWxlbWVudHMgdG8gYmUgcHJvY2Vzc2VkIGJ5IE1hdGhKYXguIFNlZVxuICAvLyAgIFtlbGVtZW50XShodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvZWxlbWVudCkgZm9yXG4gIC8vICAgZGV0YWlscyBvbiBET00gZWxlbWVudHMuXG4gIC8vXG4gIG1hdGhQcm9jZXNzb3IoZG9tRWxlbWVudHMpIHtcbiAgICBpZiAodHlwZW9mIE1hdGhKYXggIT09IFwidW5kZWZpbmVkXCIgJiYgTWF0aEpheCAhPT0gbnVsbCkge1xuICAgICAgTWF0aEpheC5IdWIuUXVldWUoW1wiVHlwZXNldFwiLCBNYXRoSmF4Lkh1YiwgZG9tRWxlbWVudHNdKVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmxvYWRNYXRoSmF4KCgpID0+XG4gICAgICAgIE1hdGhKYXguSHViLlF1ZXVlKFtcIlR5cGVzZXRcIiwgTWF0aEpheC5IdWIsIGRvbUVsZW1lbnRzXSlcbiAgICAgIClcbiAgICB9XG4gIH0sXG5cbiAgLy9cbiAgLy8gUHJvY2VzcyBtYXRocyBpbiBIVE1MIGZyYWdtZW50IHdpdGggTWF0aEpheFxuICAvL1xuICAvLyBAcGFyYW0gaHRtbCBBIEhUTUwgZnJhZ21lbnQgc3RyaW5nXG4gIC8vIEBwYXJhbSBjYWxsYmFjayBBIGNhbGxiYWNrIG1ldGhvZCB0aGF0IGFjY2VwdHMgYSBzaW5nbGUgcGFyYW1ldGVyLCBhIEhUTUxcbiAgLy8gICBmcmFnbWVudCBzdHJpbmcgdGhhdCBpcyB0aGUgcmVzdWx0IG9mIGh0bWwgcHJvY2Vzc2VkIGJ5IE1hdGhKYXhcbiAgLy9cbiAgcHJvY2Vzc0hUTUxTdHJpbmcoaHRtbCwgY2FsbGJhY2spIHtcbiAgICBjb25zdCBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKVxuICAgIGVsZW1lbnQuaW5uZXJIVE1MID0gaHRtbFxuXG4gICAgY29uc3QgY29tcGlsZVByb2Nlc3NlZEhUTUxTdHJpbmcgPSBmdW5jdGlvbigpIHtcbiAgICAgIGNvbnN0IHN2Z0dseXBocyA9IF9fZ3VhcmRfXyhcbiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJNYXRoSmF4X1NWR19IaWRkZW5cIiksXG4gICAgICAgIHggPT4geC5wYXJlbnROb2RlLmNsb25lTm9kZSh0cnVlKVxuICAgICAgKVxuICAgICAgaWYgKHN2Z0dseXBocyAhPSBudWxsKSB7XG4gICAgICAgIGVsZW1lbnQuaW5zZXJ0QmVmb3JlKHN2Z0dseXBocywgZWxlbWVudC5maXJzdENoaWxkKVxuICAgICAgfVxuICAgICAgcmV0dXJuIGVsZW1lbnQuaW5uZXJIVE1MXG4gICAgfVxuXG4gICAgY29uc3QgcXVldWVQcm9jZXNzSFRNTFN0cmluZyA9ICgpID0+XG4gICAgICBNYXRoSmF4Lkh1Yi5RdWV1ZShcbiAgICAgICAgW1wic2V0UmVuZGVyZXJcIiwgTWF0aEpheC5IdWIsIFwiU1ZHXCJdLFxuICAgICAgICBbXCJUeXBlc2V0XCIsIE1hdGhKYXguSHViLCBlbGVtZW50XSxcbiAgICAgICAgW1wic2V0UmVuZGVyZXJcIiwgTWF0aEpheC5IdWIsIFwiSFRNTC1DU1NcIl0sXG4gICAgICAgIFsoKSA9PiBjYWxsYmFjayhjb21waWxlUHJvY2Vzc2VkSFRNTFN0cmluZygpKV1cbiAgICAgIClcblxuICAgIGlmICh0eXBlb2YgTWF0aEpheCAhPT0gXCJ1bmRlZmluZWRcIiAmJiBNYXRoSmF4ICE9PSBudWxsKSB7XG4gICAgICBxdWV1ZVByb2Nlc3NIVE1MU3RyaW5nKClcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5sb2FkTWF0aEpheChxdWV1ZVByb2Nlc3NIVE1MU3RyaW5nKVxuICAgIH1cbiAgfVxufVxuXG4vL1xuLy8gRGVmaW5lIHNvbWUgZnVuY3Rpb25zIHRvIGhlbHAgZ2V0IGEgaG9sZCBvZiB0aGUgdXNlcidzIExhdGV4XG4vLyBNYWNyb3MuXG4vL1xuY29uc3QgbmFtZVBhdHRlcm4gPSBuZXcgUmVnRXhwKGBcXFxuXlteYS16QS1aXFxcXGRcXFxcc10kXFxcbnxcXFxuXlthLXpBLVpdKiRcXFxuYCkgLy8gbGV0dGVycywgYnV0IG5vIG51bWVyYWxzLlxuXG5jb25zdCBnZXRVc2VyTWFjcm9zUGF0aCA9IGZ1bmN0aW9uKCkge1xuICBjb25zdCB1c2VyTWFjcm9zUGF0aCA9IENTT04ucmVzb2x2ZShcbiAgICBwYXRoLmpvaW4oYXRvbS5nZXRDb25maWdEaXJQYXRoKCksIFwibWFya2Rvd24tcHJldmlldy1wbHVzXCIpXG4gIClcbiAgcmV0dXJuIHVzZXJNYWNyb3NQYXRoICE9IG51bGxcbiAgICA/IHVzZXJNYWNyb3NQYXRoXG4gICAgOiBwYXRoLmpvaW4oYXRvbS5nZXRDb25maWdEaXJQYXRoKCksIFwibWFya2Rvd24tcHJldmlldy1wbHVzLmNzb25cIilcbn1cblxuY29uc3QgbG9hZE1hY3Jvc0ZpbGUgPSBmdW5jdGlvbihmaWxlUGF0aCkge1xuICBpZiAoIUNTT04uaXNPYmplY3RQYXRoKGZpbGVQYXRoKSkge1xuICAgIHJldHVybiB7fVxuICB9XG4gIHJldHVybiBDU09OLnJlYWRGaWxlU3luYyhmaWxlUGF0aCwgZnVuY3Rpb24oZXJyb3IsIG9iamVjdCkge1xuICAgIGlmIChvYmplY3QgPT0gbnVsbCkge1xuICAgICAgb2JqZWN0ID0ge31cbiAgICB9XG4gICAgaWYgKGVycm9yICE9IG51bGwpIHtcbiAgICAgIGNvbnNvbGUud2FybihcbiAgICAgICAgYEVycm9yIHJlYWRpbmcgTGF0ZXggTWFjcm9zIGZpbGUgJyR7ZmlsZVBhdGh9JzogJHtcbiAgICAgICAgICBlcnJvci5zdGFjayAhPSBudWxsID8gZXJyb3Iuc3RhY2sgOiBlcnJvclxuICAgICAgICB9YFxuICAgICAgKVxuICAgICAgaWYgKGF0b20ubm90aWZpY2F0aW9ucyAhPSBudWxsKSB7XG4gICAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRFcnJvcihcbiAgICAgICAgICBgRmFpbGVkIHRvIGxvYWQgTGF0ZXggTWFjcm9zIGZyb20gJyR7ZmlsZVBhdGh9J2AsXG4gICAgICAgICAgeyBkZXRhaWw6IGVycm9yLm1lc3NhZ2UsIGRpc21pc3NhYmxlOiB0cnVlIH1cbiAgICAgICAgKVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gb2JqZWN0XG4gIH0pXG59XG5cbmNvbnN0IGxvYWRVc2VyTWFjcm9zID0gZnVuY3Rpb24oKSB7XG4gIGxldCByZXN1bHRcbiAgY29uc3QgdXNlck1hY3Jvc1BhdGggPSBnZXRVc2VyTWFjcm9zUGF0aCgpXG4gIGlmIChmcy5pc0ZpbGVTeW5jKHVzZXJNYWNyb3NQYXRoKSkge1xuICAgIHJldHVybiAocmVzdWx0ID0gbG9hZE1hY3Jvc0ZpbGUodXNlck1hY3Jvc1BhdGgpKVxuICB9IGVsc2Uge1xuICAgIGNvbnNvbGUubG9nKFxuICAgICAgXCJDcmVhdGluZyBtYXJrZG93bi1wcmV2aWV3LXBsdXMuY3NvbiwgdGhpcyBpcyBhIG9uZS10aW1lIG9wZXJhdGlvbi5cIlxuICAgIClcbiAgICBjcmVhdGVNYWNyb3NUZW1wbGF0ZSh1c2VyTWFjcm9zUGF0aClcbiAgICByZXR1cm4gKHJlc3VsdCA9IGxvYWRNYWNyb3NGaWxlKHVzZXJNYWNyb3NQYXRoKSlcbiAgfVxufVxuXG52YXIgY3JlYXRlTWFjcm9zVGVtcGxhdGUgPSBmdW5jdGlvbihmaWxlUGF0aCkge1xuICBjb25zdCB0ZW1wbGF0ZVBhdGggPSBwYXRoLmpvaW4oX19kaXJuYW1lLCBcIi4uL2Fzc2V0cy9tYWNyb3MtdGVtcGxhdGUuY3NvblwiKVxuICBjb25zdCB0ZW1wbGF0ZUZpbGUgPSBmcy5yZWFkRmlsZVN5bmModGVtcGxhdGVQYXRoLCBcInV0ZjhcIilcbiAgcmV0dXJuIGZzLndyaXRlRmlsZVN5bmMoZmlsZVBhdGgsIHRlbXBsYXRlRmlsZSlcbn1cblxuY29uc3QgY2hlY2tNYWNyb3MgPSBmdW5jdGlvbihtYWNyb3NPYmplY3QpIHtcbiAgZm9yIChsZXQgbmFtZSBpbiBtYWNyb3NPYmplY3QpIHtcbiAgICBjb25zdCB2YWx1ZSA9IG1hY3Jvc09iamVjdFtuYW1lXVxuICAgIGlmICghbmFtZS5tYXRjaChuYW1lUGF0dGVybikgfHwgIXZhbHVlTWF0Y2hlc1BhdHRlcm4odmFsdWUpKSB7XG4gICAgICBkZWxldGUgbWFjcm9zT2JqZWN0W25hbWVdXG4gICAgICBpZiAoYXRvbS5ub3RpZmljYXRpb25zICE9IG51bGwpIHtcbiAgICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEVycm9yKFxuICAgICAgICAgIGBGYWlsZWQgdG8gbG9hZCBMYVRlWCBtYWNybyBuYW1lZCAnJHtuYW1lfScuIFBsZWFzZSBzZWUgdGhlIFtMYVRlWCBndWlkZV0oaHR0cHM6Ly9naXRodWIuY29tL0dhbGFkaXJpdGgvbWFya2Rvd24tcHJldmlldy1wbHVzL2Jsb2IvbWFzdGVyL0xBVEVYLm1kI21hY3JvLW5hbWVzKWAsXG4gICAgICAgICAgeyBkaXNtaXNzYWJsZTogdHJ1ZSB9XG4gICAgICAgIClcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgcmV0dXJuIG1hY3Jvc09iamVjdFxufVxuXG52YXIgdmFsdWVNYXRjaGVzUGF0dGVybiA9IGZ1bmN0aW9uKHZhbHVlKSB7XG4gIC8vIERpZmZlcmVudCBjaGVjayBiYXNlZCBvbiB3aGV0aGVyIHZhbHVlIGlzIHN0cmluZyBvciBhcnJheVxuICBzd2l0Y2ggKGZhbHNlKSB7XG4gICAgLy8gSWYgaXQgaXMgYW4gYXJyYXkgdGhlbiBpdCBzaG91bGQgYmUgW3N0cmluZywgaW50ZWdlcl1cbiAgICBjYXNlIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YWx1ZSkgIT09IFwiW29iamVjdCBBcnJheV1cIjpcbiAgICAgIHZhciBtYWNyb0RlZmluaXRpb24gPSB2YWx1ZVswXVxuICAgICAgdmFyIG51bWJlck9mQXJncyA9IHZhbHVlWzFdXG4gICAgICBpZiAodHlwZW9mIG51bWJlck9mQXJncyA9PT0gXCJudW1iZXJcIikge1xuICAgICAgICByZXR1cm4gbnVtYmVyT2ZBcmdzICUgMSA9PT0gMCAmJiB0eXBlb2YgbWFjcm9EZWZpbml0aW9uID09PSBcInN0cmluZ1wiXG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgIH1cbiAgICAvLyBJZiBpdCBpcyBqdXN0IGEgc3RyaW5nIHRoZW4gdGhhdCdzIE9LLCBhbnkgc3RyaW5nIGlzIGFjY2VwdGFibGVcbiAgICBjYXNlIHR5cGVvZiB2YWx1ZSAhPT0gXCJzdHJpbmdcIjpcbiAgICAgIHJldHVybiB0cnVlXG4gICAgZGVmYXVsdDpcbiAgICAgIHJldHVybiBmYWxzZVxuICB9XG59XG5cbi8vIENvbmZpZ3VyZSBNYXRoSmF4IGVudmlyb25tZW50LiBTaW1pbGFyIHRvIHRoZSBUZVgtQU1TX0hUTUwgY29uZmlndXJhdGlvbiB3aXRoXG4vLyBhIGZldyB1bm5lY2Vzc2FyeSBmZWF0dXJlcyBzdHJpcHBlZCBhd2F5XG4vL1xuY29uc3QgY29uZmlndXJlTWF0aEpheCA9IGZ1bmN0aW9uKCkge1xuICBsZXQgdXNlck1hY3JvcyA9IGxvYWRVc2VyTWFjcm9zKClcbiAgaWYgKHVzZXJNYWNyb3MpIHtcbiAgICB1c2VyTWFjcm9zID0gY2hlY2tNYWNyb3ModXNlck1hY3JvcylcbiAgfSBlbHNlIHtcbiAgICB1c2VyTWFjcm9zID0ge31cbiAgfVxuXG4gIC8vTm93IENvbmZpZ3VyZSBNYXRoSmF4XG4gIE1hdGhKYXguSHViLkNvbmZpZyh7XG4gICAgamF4OiBbXCJpbnB1dC9UZVhcIiwgXCJvdXRwdXQvSFRNTC1DU1NcIl0sXG4gICAgZXh0ZW5zaW9uczogW10sXG4gICAgVGVYOiB7XG4gICAgICBleHRlbnNpb25zOiBbXG4gICAgICAgIFwiQU1TbWF0aC5qc1wiLFxuICAgICAgICBcIkFNU3N5bWJvbHMuanNcIixcbiAgICAgICAgXCJub0Vycm9ycy5qc1wiLFxuICAgICAgICBcIm5vVW5kZWZpbmVkLmpzXCJcbiAgICAgIF0sXG4gICAgICBNYWNyb3M6IHVzZXJNYWNyb3NcbiAgICB9LFxuICAgIFwiSFRNTC1DU1NcIjoge1xuICAgICAgYXZhaWxhYmxlRm9udHM6IFtdLFxuICAgICAgd2ViRm9udDogXCJUZVhcIlxuICAgIH0sXG4gICAgbWVzc2FnZVN0eWxlOiBcIm5vbmVcIixcbiAgICBzaG93TWF0aE1lbnU6IGZhbHNlLFxuICAgIHNraXBTdGFydHVwVHlwZXNldDogdHJ1ZVxuICB9KVxuICBNYXRoSmF4Lkh1Yi5Db25maWd1cmVkKClcblxuICAvLyBOb3RpZnkgdXNlciBNYXRoSmF4IGhhcyBsb2FkZWRcbiAgaWYgKGF0b20uaW5EZXZNb2RlKCkpIHtcbiAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkU3VjY2VzcyhcIkxvYWRlZCBtYXRocyByZW5kZXJpbmcgZW5naW5lIE1hdGhKYXhcIilcbiAgfVxufVxuXG4vL1xuLy8gQXR0YWNoIG1haW4gTWF0aEpheCBzY3JpcHQgdG8gdGhlIGRvY3VtZW50XG4vL1xudmFyIGF0dGFjaE1hdGhKYXggPSBmdW5jdGlvbigpIHtcbiAgLy8gTm90aWZ5IHVzZXIgTWF0aEpheCBpcyBsb2FkaW5nXG4gIGlmIChhdG9tLmluRGV2TW9kZSgpKSB7XG4gICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEluZm8oXCJMb2FkaW5nIG1hdGhzIHJlbmRlcmluZyBlbmdpbmUgTWF0aEpheFwiKVxuICB9XG5cbiAgLy8gQXR0YWNoIE1hdGhKYXggc2NyaXB0XG4gIGNvbnN0IHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJzY3JpcHRcIilcbiAgc2NyaXB0LnNyYyA9IGAke3JlcXVpcmUucmVzb2x2ZShcIk1hdGhKYXhcIil9P2RlbGF5U3RhcnR1cFVudGlsPWNvbmZpZ3VyZWRgXG4gIHNjcmlwdC50eXBlID0gXCJ0ZXh0L2phdmFzY3JpcHRcIlxuICBzY3JpcHQuYWRkRXZlbnRMaXN0ZW5lcihcImxvYWRcIiwgKCkgPT4gY29uZmlndXJlTWF0aEpheCgpKVxuICBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZShcImhlYWRcIilbMF0uYXBwZW5kQ2hpbGQoc2NyaXB0KVxuXG4gIHJldHVybiBzY3JpcHRcbn1cblxuZnVuY3Rpb24gX19ndWFyZF9fKHZhbHVlLCB0cmFuc2Zvcm0pIHtcbiAgcmV0dXJuIHR5cGVvZiB2YWx1ZSAhPT0gXCJ1bmRlZmluZWRcIiAmJiB2YWx1ZSAhPT0gbnVsbFxuICAgID8gdHJhbnNmb3JtKHZhbHVlKVxuICAgIDogdW5kZWZpbmVkXG59XG4iXX0=