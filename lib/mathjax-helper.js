"use strict";
const { $ } = require('atom-space-pen-views');
const path = require("path");
const CSON = require('season');
const fs = require("fs-plus");
const _ = require("lodash");
const namePattern = new RegExp(`\
^[^a-zA-Z\\d\\s]$\
|\
^[a-zA-Z]*$\
`);
const getUserMacrosPath = function () {
    const userMacrosPath = CSON.resolve(path.join(atom.getConfigDirPath(), 'markdown-preview-plus'));
    return userMacrosPath != null
        ? userMacrosPath
        : path.join(atom.getConfigDirPath(), 'markdown-preview-plus.cson');
};
function loadMacrosFile(filePath) {
    if (!CSON.isObjectPath(filePath)) {
        return {};
    }
    return CSON.readFileSync(filePath, function (error, object) {
        if (object == null) {
            object = {};
        }
        if (error != null) {
            console.warn(`Error reading Latex Macros file '${filePath}': ${error.stack != null ? error.stack : error}`);
            if (atom.notifications != null) {
                atom.notifications.addError(`Failed to load Latex Macros from '${filePath}'`, { detail: error.message, dismissable: true });
            }
        }
        return object;
    });
}
const loadUserMacros = function () {
    let result;
    const userMacrosPath = getUserMacrosPath();
    if (fs.isFileSync(userMacrosPath)) {
        return (result = loadMacrosFile(userMacrosPath));
    }
    else {
        console.log('Creating markdown-preview-plus.cson, this is a one-time operation.');
        createMacrosTemplate(userMacrosPath);
        return (result = loadMacrosFile(userMacrosPath));
    }
};
function createMacrosTemplate(filePath) {
    const templatePath = path.join(__dirname, '../assets/macros-template.cson');
    const templateFile = fs.readFileSync(templatePath, 'utf8');
    return fs.writeFileSync(filePath, templateFile);
}
function checkMacros(macrosObject) {
    for (let name in macrosObject) {
        const value = macrosObject[name];
        if (!name.match(namePattern) || !valueMatchesPattern(value)) {
            delete macrosObject[name];
            if (atom.notifications != null) {
                atom.notifications.addError(`Failed to load LaTeX macro named '${name}'. Please see the [LaTeX guide](https://github.com/Galadirith/markdown-preview-plus/blob/master/LATEX.md#macro-names)`, { dismissable: true });
            }
        }
    }
    return macrosObject;
}
function valueMatchesPattern(value) {
    if (Array.isArray(value)) {
        var macroDefinition = value[0];
        var numberOfArgs = value[1];
        if (typeof numberOfArgs === 'number') {
            return numberOfArgs % 1 === 0 && typeof macroDefinition === 'string';
        }
        else {
            return false;
        }
    }
    else if (typeof value == 'string') {
        return true;
    }
    else {
        return false;
    }
}
const configureMathJax = function () {
    let userMacros = loadUserMacros();
    if (userMacros) {
        userMacros = checkMacros(userMacros);
    }
    else {
        userMacros = {};
    }
    MathJax.Hub.Config({
        jax: ['input/TeX', 'output/HTML-CSS'],
        extensions: [],
        TeX: {
            extensions: [
                'AMSmath.js',
                'AMSsymbols.js',
                'noErrors.js',
                'noUndefined.js',
            ],
            Macros: userMacros,
        },
        'HTML-CSS': {
            availableFonts: [],
            webFont: 'TeX',
        },
        messageStyle: 'none',
        showMathMenu: false,
        skipStartupTypeset: true,
    });
    MathJax.Hub.Configured();
    if (atom.inDevMode()) {
        atom.notifications.addSuccess('Loaded maths rendering engine MathJax');
    }
};
function attachMathJax() {
    if (atom.inDevMode()) {
        atom.notifications.addInfo('Loading maths rendering engine MathJax');
    }
    const script = document.createElement('script');
    script.src = `${require.resolve('MathJax')}?delayStartupUntil=configured`;
    script.type = 'text/javascript';
    script.addEventListener('load', () => configureMathJax());
    document.getElementsByTagName('head')[0].appendChild(script);
    return script;
}
module.exports = {
    loadMathJax(listener) {
        const script = this.attachMathJax();
        if (listener != null) {
            script.addEventListener('load', () => listener());
        }
    },
    attachMathJax: _.once(() => attachMathJax()),
    resetMathJax() {
        $('script[src*="MathJax.js"]').remove();
        window.MathJax = undefined;
        return (this.attachMathJax = _.once(() => attachMathJax()));
    },
    mathProcessor(domElements) {
        if (MathJax) {
            MathJax.Hub.Queue(['Typeset', MathJax.Hub, domElements]);
        }
        else {
            this.loadMathJax(() => MathJax.Hub.Queue(['Typeset', MathJax.Hub, domElements]));
        }
    },
    processHTMLString(html, callback) {
        const element = document.createElement('div');
        element.innerHTML = html;
        const compileProcessedHTMLString = function () {
            const msvgh = document.getElementById('MathJax_SVG_Hidden');
            const svgGlyphs = msvgh && msvgh.parentNode.cloneNode(true);
            if (svgGlyphs != null) {
                element.insertBefore(svgGlyphs, element.firstChild);
            }
            return element.innerHTML;
        };
        const queueProcessHTMLString = () => MathJax.Hub.Queue(['setRenderer', MathJax.Hub, 'SVG'], ['Typeset', MathJax.Hub, element], ['setRenderer', MathJax.Hub, 'HTML-CSS'], [() => callback(compileProcessedHTMLString())]);
        if (window.MathJax) {
            queueProcessHTMLString();
        }
        else {
            this.loadMathJax(queueProcessHTMLString);
        }
    },
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWF0aGpheC1oZWxwZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvbWF0aGpheC1oZWxwZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQWFBLE1BQU0sRUFBRSxDQUFDLEVBQUUsR0FBRyxPQUFPLENBQUMsc0JBQXNCLENBQUMsQ0FBQTtBQUM3Qyw2QkFBNkI7QUFDN0IsTUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFBO0FBQzlCLDhCQUE4QjtBQUM5Qiw0QkFBNEI7QUEwRjVCLE1BQU0sV0FBVyxHQUFHLElBQUksTUFBTSxDQUFDOzs7O0NBSTlCLENBQUMsQ0FBQTtBQUVGLE1BQU0saUJBQWlCLEdBQUc7SUFDeEIsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FDakMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsRUFBRSx1QkFBdUIsQ0FBQyxDQUM1RCxDQUFBO0lBQ0QsTUFBTSxDQUFDLGNBQWMsSUFBSSxJQUFJO1FBQzNCLENBQUMsQ0FBQyxjQUFjO1FBQ2hCLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxFQUFFLDRCQUE0QixDQUFDLENBQUE7QUFDdEUsQ0FBQyxDQUFBO0FBRUQsd0JBQXdCLFFBQWdCO0lBQ3RDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDakMsTUFBTSxDQUFDLEVBQUUsQ0FBQTtJQUNYLENBQUM7SUFDRCxNQUFNLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLEVBQUUsVUFBUyxLQUFhLEVBQUUsTUFBZTtRQUN4RSxFQUFFLENBQUMsQ0FBQyxNQUFNLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQztZQUNuQixNQUFNLEdBQUcsRUFBRSxDQUFBO1FBQ2IsQ0FBQztRQUNELEVBQUUsQ0FBQyxDQUFDLEtBQUssSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ2xCLE9BQU8sQ0FBQyxJQUFJLENBQ1Ysb0NBQW9DLFFBQVEsTUFDMUMsS0FBSyxDQUFDLEtBQUssSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQ3RDLEVBQUUsQ0FDSCxDQUFBO1lBQ0QsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLGFBQWEsSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDO2dCQUMvQixJQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FDekIscUNBQXFDLFFBQVEsR0FBRyxFQUNoRCxFQUFFLE1BQU0sRUFBRSxLQUFLLENBQUMsT0FBTyxFQUFFLFdBQVcsRUFBRSxJQUFJLEVBQUUsQ0FDN0MsQ0FBQTtZQUNILENBQUM7UUFDSCxDQUFDO1FBQ0QsTUFBTSxDQUFDLE1BQU0sQ0FBQTtJQUNmLENBQUMsQ0FBQyxDQUFBO0FBQ0osQ0FBQztBQUVELE1BQU0sY0FBYyxHQUFHO0lBQ3JCLElBQUksTUFBTSxDQUFBO0lBQ1YsTUFBTSxjQUFjLEdBQUcsaUJBQWlCLEVBQUUsQ0FBQTtJQUMxQyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNsQyxNQUFNLENBQUMsQ0FBQyxNQUFNLEdBQUcsY0FBYyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUE7SUFDbEQsQ0FBQztJQUFDLElBQUksQ0FBQyxDQUFDO1FBQ04sT0FBTyxDQUFDLEdBQUcsQ0FDVCxvRUFBb0UsQ0FDckUsQ0FBQTtRQUNELG9CQUFvQixDQUFDLGNBQWMsQ0FBQyxDQUFBO1FBQ3BDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sR0FBRyxjQUFjLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQTtJQUNsRCxDQUFDO0FBQ0gsQ0FBQyxDQUFBO0FBRUQsOEJBQThCLFFBQWdCO0lBQzVDLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLGdDQUFnQyxDQUFDLENBQUE7SUFDM0UsTUFBTSxZQUFZLEdBQUcsRUFBRSxDQUFDLFlBQVksQ0FBQyxZQUFZLEVBQUUsTUFBTSxDQUFDLENBQUE7SUFDMUQsTUFBTSxDQUFDLEVBQUUsQ0FBQyxhQUFhLENBQUMsUUFBUSxFQUFFLFlBQVksQ0FBQyxDQUFBO0FBQ2pELENBQUM7QUFFRCxxQkFBcUIsWUFBb0I7SUFDdkMsR0FBRyxDQUFDLENBQUMsSUFBSSxJQUFJLElBQUksWUFBWSxDQUFDLENBQUMsQ0FBQztRQUM5QixNQUFNLEtBQUssR0FBRyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDaEMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzVELE9BQU8sWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFBO1lBQ3pCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxhQUFhLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQztnQkFDL0IsSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQ3pCLHFDQUFxQyxJQUFJLHVIQUF1SCxFQUNoSyxFQUFFLFdBQVcsRUFBRSxJQUFJLEVBQUUsQ0FDdEIsQ0FBQTtZQUNILENBQUM7UUFDSCxDQUFDO0lBQ0gsQ0FBQztJQUNELE1BQU0sQ0FBQyxZQUFZLENBQUE7QUFDckIsQ0FBQztBQUVELDZCQUE2QixLQUFVO0lBRXJDLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3pCLElBQUksZUFBZSxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQTtRQUM5QixJQUFJLFlBQVksR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUE7UUFDM0IsRUFBRSxDQUFDLENBQUMsT0FBTyxZQUFZLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQztZQUNyQyxNQUFNLENBQUMsWUFBWSxHQUFHLENBQUMsS0FBSyxDQUFDLElBQUksT0FBTyxlQUFlLEtBQUssUUFBUSxDQUFBO1FBQ3RFLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLE1BQU0sQ0FBQyxLQUFLLENBQUE7UUFDZCxDQUFDO0lBQ0gsQ0FBQztJQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxPQUFPLEtBQUssSUFBSSxRQUFRLENBQUMsQ0FBQyxDQUFDO1FBQ2xDLE1BQU0sQ0FBQyxJQUFJLENBQUE7SUFDZixDQUFDO0lBQUMsSUFBSSxDQUFDLENBQUM7UUFDSixNQUFNLENBQUMsS0FBSyxDQUFBO0lBQ2hCLENBQUM7QUFDSCxDQUFDO0FBS0QsTUFBTSxnQkFBZ0IsR0FBRztJQUN2QixJQUFJLFVBQVUsR0FBRyxjQUFjLEVBQUUsQ0FBQTtJQUNqQyxFQUFFLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO1FBQ2YsVUFBVSxHQUFHLFdBQVcsQ0FBQyxVQUFVLENBQUMsQ0FBQTtJQUN0QyxDQUFDO0lBQUMsSUFBSSxDQUFDLENBQUM7UUFDTixVQUFVLEdBQUcsRUFBRSxDQUFBO0lBQ2pCLENBQUM7SUFHRCxPQUFRLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQztRQUNsQixHQUFHLEVBQUUsQ0FBQyxXQUFXLEVBQUUsaUJBQWlCLENBQUM7UUFDckMsVUFBVSxFQUFFLEVBQUU7UUFDZCxHQUFHLEVBQUU7WUFDSCxVQUFVLEVBQUU7Z0JBQ1YsWUFBWTtnQkFDWixlQUFlO2dCQUNmLGFBQWE7Z0JBQ2IsZ0JBQWdCO2FBQ2pCO1lBQ0QsTUFBTSxFQUFFLFVBQVU7U0FDbkI7UUFDRCxVQUFVLEVBQUU7WUFDVixjQUFjLEVBQUUsRUFBRTtZQUNsQixPQUFPLEVBQUUsS0FBSztTQUNmO1FBQ0QsWUFBWSxFQUFFLE1BQU07UUFDcEIsWUFBWSxFQUFFLEtBQUs7UUFDbkIsa0JBQWtCLEVBQUUsSUFBSTtLQUN6QixDQUFDLENBQUE7SUFDRixPQUFRLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxDQUFBO0lBR3pCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDckIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsdUNBQXVDLENBQUMsQ0FBQTtJQUN4RSxDQUFDO0FBQ0gsQ0FBQyxDQUFBO0FBS0Q7SUFFRSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3JCLElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLHdDQUF3QyxDQUFDLENBQUE7SUFDdEUsQ0FBQztJQUdELE1BQU0sTUFBTSxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUE7SUFDL0MsTUFBTSxDQUFDLEdBQUcsR0FBRyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLCtCQUErQixDQUFBO0lBQ3pFLE1BQU0sQ0FBQyxJQUFJLEdBQUcsaUJBQWlCLENBQUE7SUFDL0IsTUFBTSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDLENBQUE7SUFDekQsUUFBUSxDQUFDLG9CQUFvQixDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQTtJQUU1RCxNQUFNLENBQUMsTUFBTSxDQUFBO0FBQ2YsQ0FBQztBQTlPRCxpQkFBUztJQU9QLFdBQVcsQ0FBQyxRQUFtQjtRQUM3QixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUE7UUFDbkMsRUFBRSxDQUFDLENBQUMsUUFBUSxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDckIsTUFBTSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFBO1FBQ25ELENBQUM7SUFDSCxDQUFDO0lBS0QsYUFBYSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUMsYUFBYSxFQUFFLENBQUM7SUFLNUMsWUFBWTtRQUVWLENBQUMsQ0FBQywyQkFBMkIsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFBO1FBQ3ZDLE1BQU0sQ0FBQyxPQUFPLEdBQUcsU0FBUyxDQUFBO1FBRzFCLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxhQUFhLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxhQUFhLEVBQUUsQ0FBQyxDQUFDLENBQUE7SUFDN0QsQ0FBQztJQVNELGFBQWEsQ0FBQyxXQUFtQjtRQUMvQixFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1lBQ1osT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxTQUFTLEVBQUUsT0FBTyxDQUFDLEdBQUcsRUFBRSxXQUFXLENBQUMsQ0FBQyxDQUFBO1FBQzFELENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxFQUFFLENBQ3BCLE9BQVEsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsU0FBUyxFQUFFLE9BQVEsQ0FBQyxHQUFHLEVBQUUsV0FBVyxDQUFDLENBQUMsQ0FDM0QsQ0FBQTtRQUNILENBQUM7SUFDSCxDQUFDO0lBU0QsaUJBQWlCLENBQUMsSUFBWSxFQUFFLFFBQWtDO1FBQ2hFLE1BQU0sT0FBTyxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUE7UUFDN0MsT0FBTyxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUE7UUFFeEIsTUFBTSwwQkFBMEIsR0FBRztZQUNqQyxNQUFNLEtBQUssR0FBRyxRQUFRLENBQUMsY0FBYyxDQUFDLG9CQUFvQixDQUFDLENBQUE7WUFDM0QsTUFBTSxTQUFTLEdBQUcsS0FBSyxJQUFJLEtBQUssQ0FBQyxVQUFXLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFBO1lBQzVELEVBQUUsQ0FBQyxDQUFDLFNBQVMsSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDO2dCQUN0QixPQUFPLENBQUMsWUFBWSxDQUFDLFNBQVMsRUFBRSxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUE7WUFDckQsQ0FBQztZQUNELE1BQU0sQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFBO1FBQzFCLENBQUMsQ0FBQTtRQUVELE1BQU0sc0JBQXNCLEdBQUcsR0FBRyxFQUFFLENBQ2xDLE9BQVEsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUNoQixDQUFDLGFBQWEsRUFBRSxPQUFRLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxFQUNwQyxDQUFDLFNBQVMsRUFBRSxPQUFRLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxFQUNsQyxDQUFDLGFBQWEsRUFBRSxPQUFRLENBQUMsR0FBRyxFQUFFLFVBQVUsQ0FBQyxFQUN6QyxDQUFDLEdBQUcsRUFBRSxDQUFDLFFBQVEsQ0FBQywwQkFBMEIsRUFBRSxDQUFDLENBQUMsQ0FDL0MsQ0FBQTtRQUVILEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1lBQ25CLHNCQUFzQixFQUFFLENBQUE7UUFDMUIsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ04sSUFBSSxDQUFDLFdBQVcsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFBO1FBQzFDLENBQUM7SUFDSCxDQUFDO0NBQ0YsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBkZWNhZmZlaW5hdGUgc3VnZ2VzdGlvbnM6XG4gKiBEUzEwMjogUmVtb3ZlIHVubmVjZXNzYXJ5IGNvZGUgY3JlYXRlZCBiZWNhdXNlIG9mIGltcGxpY2l0IHJldHVybnNcbiAqIERTMjA3OiBDb25zaWRlciBzaG9ydGVyIHZhcmlhdGlvbnMgb2YgbnVsbCBjaGVja3NcbiAqIEZ1bGwgZG9jczogaHR0cHM6Ly9naXRodWIuY29tL2RlY2FmZmVpbmF0ZS9kZWNhZmZlaW5hdGUvYmxvYi9tYXN0ZXIvZG9jcy9zdWdnZXN0aW9ucy5tZFxuICovXG4vL1xuLy8gbWF0aGpheC1oZWxwZXJcbi8vXG4vLyBUaGlzIG1vZHVsZSB3aWxsIGhhbmRsZSBsb2FkaW5nIHRoZSBNYXRoSmF4IGVudmlyb25tZW50IGFuZCBwcm92aWRlIGEgd3JhcHBlclxuLy8gZm9yIGNhbGxzIHRvIE1hdGhKYXggdG8gcHJvY2VzcyBMYVRlWCBlcXVhdGlvbnMuXG4vL1xuXG5jb25zdCB7ICQgfSA9IHJlcXVpcmUoJ2F0b20tc3BhY2UtcGVuLXZpZXdzJylcbmltcG9ydCBwYXRoID0gcmVxdWlyZSgncGF0aCcpXG5jb25zdCBDU09OID0gcmVxdWlyZSgnc2Vhc29uJylcbmltcG9ydCBmcyA9IHJlcXVpcmUoJ2ZzLXBsdXMnKVxuaW1wb3J0IF8gPSByZXF1aXJlKCdsb2Rhc2gnKVxuXG5leHBvcnQgPSB7XG4gIC8vXG4gIC8vIExvYWQgTWF0aEpheCBlbnZpcm9ubWVudFxuICAvL1xuICAvLyBAcGFyYW0gbGlzdGVuZXIgT3B0aW9uYWwgbWV0aG9kIHRvIGNhbGwgd2hlbiB0aGUgTWF0aEpheCBzY3JpcHQgd2FzIGJlZW5cbiAgLy8gICBsb2FkZWQgdG8gdGhlIHdpbmRvdy4gVGhlIG1ldGhvZCBpcyBwYXNzZWQgbm8gYXJndW1lbnRzLlxuICAvL1xuICBsb2FkTWF0aEpheChsaXN0ZW5lcjogKCkgPT4gYW55KSB7XG4gICAgY29uc3Qgc2NyaXB0ID0gdGhpcy5hdHRhY2hNYXRoSmF4KClcbiAgICBpZiAobGlzdGVuZXIgIT0gbnVsbCkge1xuICAgICAgc2NyaXB0LmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCAoKSA9PiBsaXN0ZW5lcigpKVxuICAgIH1cbiAgfSxcblxuICAvL1xuICAvLyBBdHRhY2ggbWFpbiBNYXRoSmF4IHNjcmlwdCB0byB0aGUgZG9jdW1lbnRcbiAgLy9cbiAgYXR0YWNoTWF0aEpheDogXy5vbmNlKCgpID0+IGF0dGFjaE1hdGhKYXgoKSksXG5cbiAgLy9cbiAgLy8gUmVtb3ZlIE1hdGhKYXggZnJvbSB0aGUgZG9jdW1lbnQgYW5kIHJlc2V0IGF0dGFjaCBtZXRob2RcbiAgLy9cbiAgcmVzZXRNYXRoSmF4KCkge1xuICAgIC8vIERldGFjaCBNYXRoSmF4IGZyb20gdGhlIGRvY3VtZW50XG4gICAgJCgnc2NyaXB0W3NyYyo9XCJNYXRoSmF4LmpzXCJdJykucmVtb3ZlKClcbiAgICB3aW5kb3cuTWF0aEpheCA9IHVuZGVmaW5lZFxuXG4gICAgLy8gUmVzZXQgYXR0YWNoIGZvciBhbnkgc3Vic2VxdWVudCBjYWxsc1xuICAgIHJldHVybiAodGhpcy5hdHRhY2hNYXRoSmF4ID0gXy5vbmNlKCgpID0+IGF0dGFjaE1hdGhKYXgoKSkpXG4gIH0sXG5cbiAgLy9cbiAgLy8gUHJvY2VzcyBET00gZWxlbWVudHMgZm9yIExhVGVYIGVxdWF0aW9ucyB3aXRoIE1hdGhKYXhcbiAgLy9cbiAgLy8gQHBhcmFtIGRvbUVsZW1lbnRzIEFuIGFycmF5IG9mIERPTSBlbGVtZW50cyB0byBiZSBwcm9jZXNzZWQgYnkgTWF0aEpheC4gU2VlXG4gIC8vICAgW2VsZW1lbnRdKGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0FQSS9lbGVtZW50KSBmb3JcbiAgLy8gICBkZXRhaWxzIG9uIERPTSBlbGVtZW50cy5cbiAgLy9cbiAgbWF0aFByb2Nlc3Nvcihkb21FbGVtZW50czogTm9kZVtdKSB7XG4gICAgaWYgKE1hdGhKYXgpIHtcbiAgICAgIE1hdGhKYXguSHViLlF1ZXVlKFsnVHlwZXNldCcsIE1hdGhKYXguSHViLCBkb21FbGVtZW50c10pXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMubG9hZE1hdGhKYXgoKCkgPT5cbiAgICAgICAgTWF0aEpheCEuSHViLlF1ZXVlKFsnVHlwZXNldCcsIE1hdGhKYXghLkh1YiwgZG9tRWxlbWVudHNdKSxcbiAgICAgIClcbiAgICB9XG4gIH0sXG5cbiAgLy9cbiAgLy8gUHJvY2VzcyBtYXRocyBpbiBIVE1MIGZyYWdtZW50IHdpdGggTWF0aEpheFxuICAvL1xuICAvLyBAcGFyYW0gaHRtbCBBIEhUTUwgZnJhZ21lbnQgc3RyaW5nXG4gIC8vIEBwYXJhbSBjYWxsYmFjayBBIGNhbGxiYWNrIG1ldGhvZCB0aGF0IGFjY2VwdHMgYSBzaW5nbGUgcGFyYW1ldGVyLCBhIEhUTUxcbiAgLy8gICBmcmFnbWVudCBzdHJpbmcgdGhhdCBpcyB0aGUgcmVzdWx0IG9mIGh0bWwgcHJvY2Vzc2VkIGJ5IE1hdGhKYXhcbiAgLy9cbiAgcHJvY2Vzc0hUTUxTdHJpbmcoaHRtbDogc3RyaW5nLCBjYWxsYmFjazogKHByb0hUTUw6IHN0cmluZykgPT4gYW55KSB7XG4gICAgY29uc3QgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpXG4gICAgZWxlbWVudC5pbm5lckhUTUwgPSBodG1sXG5cbiAgICBjb25zdCBjb21waWxlUHJvY2Vzc2VkSFRNTFN0cmluZyA9IGZ1bmN0aW9uKCkge1xuICAgICAgY29uc3QgbXN2Z2ggPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnTWF0aEpheF9TVkdfSGlkZGVuJylcbiAgICAgIGNvbnN0IHN2Z0dseXBocyA9IG1zdmdoICYmIG1zdmdoLnBhcmVudE5vZGUhLmNsb25lTm9kZSh0cnVlKVxuICAgICAgaWYgKHN2Z0dseXBocyAhPSBudWxsKSB7XG4gICAgICAgIGVsZW1lbnQuaW5zZXJ0QmVmb3JlKHN2Z0dseXBocywgZWxlbWVudC5maXJzdENoaWxkKVxuICAgICAgfVxuICAgICAgcmV0dXJuIGVsZW1lbnQuaW5uZXJIVE1MXG4gICAgfVxuXG4gICAgY29uc3QgcXVldWVQcm9jZXNzSFRNTFN0cmluZyA9ICgpID0+XG4gICAgICBNYXRoSmF4IS5IdWIuUXVldWUoXG4gICAgICAgIFsnc2V0UmVuZGVyZXInLCBNYXRoSmF4IS5IdWIsICdTVkcnXSxcbiAgICAgICAgWydUeXBlc2V0JywgTWF0aEpheCEuSHViLCBlbGVtZW50XSxcbiAgICAgICAgWydzZXRSZW5kZXJlcicsIE1hdGhKYXghLkh1YiwgJ0hUTUwtQ1NTJ10sXG4gICAgICAgIFsoKSA9PiBjYWxsYmFjayhjb21waWxlUHJvY2Vzc2VkSFRNTFN0cmluZygpKV0sXG4gICAgICApXG5cbiAgICBpZiAod2luZG93Lk1hdGhKYXgpIHtcbiAgICAgIHF1ZXVlUHJvY2Vzc0hUTUxTdHJpbmcoKVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmxvYWRNYXRoSmF4KHF1ZXVlUHJvY2Vzc0hUTUxTdHJpbmcpXG4gICAgfVxuICB9LFxufVxuXG4vL1xuLy8gRGVmaW5lIHNvbWUgZnVuY3Rpb25zIHRvIGhlbHAgZ2V0IGEgaG9sZCBvZiB0aGUgdXNlcidzIExhdGV4XG4vLyBNYWNyb3MuXG4vL1xuY29uc3QgbmFtZVBhdHRlcm4gPSBuZXcgUmVnRXhwKGBcXFxuXlteYS16QS1aXFxcXGRcXFxcc10kXFxcbnxcXFxuXlthLXpBLVpdKiRcXFxuYCkgLy8gbGV0dGVycywgYnV0IG5vIG51bWVyYWxzLlxuXG5jb25zdCBnZXRVc2VyTWFjcm9zUGF0aCA9IGZ1bmN0aW9uKCkge1xuICBjb25zdCB1c2VyTWFjcm9zUGF0aCA9IENTT04ucmVzb2x2ZShcbiAgICBwYXRoLmpvaW4oYXRvbS5nZXRDb25maWdEaXJQYXRoKCksICdtYXJrZG93bi1wcmV2aWV3LXBsdXMnKSxcbiAgKVxuICByZXR1cm4gdXNlck1hY3Jvc1BhdGggIT0gbnVsbFxuICAgID8gdXNlck1hY3Jvc1BhdGhcbiAgICA6IHBhdGguam9pbihhdG9tLmdldENvbmZpZ0RpclBhdGgoKSwgJ21hcmtkb3duLXByZXZpZXctcGx1cy5jc29uJylcbn1cblxuZnVuY3Rpb24gbG9hZE1hY3Jvc0ZpbGUoZmlsZVBhdGg6IHN0cmluZykge1xuICBpZiAoIUNTT04uaXNPYmplY3RQYXRoKGZpbGVQYXRoKSkge1xuICAgIHJldHVybiB7fVxuICB9XG4gIHJldHVybiBDU09OLnJlYWRGaWxlU3luYyhmaWxlUGF0aCwgZnVuY3Rpb24oZXJyb3I/OiBFcnJvciwgb2JqZWN0Pzogb2JqZWN0KSB7XG4gICAgaWYgKG9iamVjdCA9PSBudWxsKSB7XG4gICAgICBvYmplY3QgPSB7fVxuICAgIH1cbiAgICBpZiAoZXJyb3IgIT0gbnVsbCkge1xuICAgICAgY29uc29sZS53YXJuKFxuICAgICAgICBgRXJyb3IgcmVhZGluZyBMYXRleCBNYWNyb3MgZmlsZSAnJHtmaWxlUGF0aH0nOiAke1xuICAgICAgICAgIGVycm9yLnN0YWNrICE9IG51bGwgPyBlcnJvci5zdGFjayA6IGVycm9yXG4gICAgICAgIH1gLFxuICAgICAgKVxuICAgICAgaWYgKGF0b20ubm90aWZpY2F0aW9ucyAhPSBudWxsKSB7XG4gICAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRFcnJvcihcbiAgICAgICAgICBgRmFpbGVkIHRvIGxvYWQgTGF0ZXggTWFjcm9zIGZyb20gJyR7ZmlsZVBhdGh9J2AsXG4gICAgICAgICAgeyBkZXRhaWw6IGVycm9yLm1lc3NhZ2UsIGRpc21pc3NhYmxlOiB0cnVlIH0sXG4gICAgICAgIClcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIG9iamVjdFxuICB9KVxufVxuXG5jb25zdCBsb2FkVXNlck1hY3JvcyA9IGZ1bmN0aW9uKCkge1xuICBsZXQgcmVzdWx0XG4gIGNvbnN0IHVzZXJNYWNyb3NQYXRoID0gZ2V0VXNlck1hY3Jvc1BhdGgoKVxuICBpZiAoZnMuaXNGaWxlU3luYyh1c2VyTWFjcm9zUGF0aCkpIHtcbiAgICByZXR1cm4gKHJlc3VsdCA9IGxvYWRNYWNyb3NGaWxlKHVzZXJNYWNyb3NQYXRoKSlcbiAgfSBlbHNlIHtcbiAgICBjb25zb2xlLmxvZyhcbiAgICAgICdDcmVhdGluZyBtYXJrZG93bi1wcmV2aWV3LXBsdXMuY3NvbiwgdGhpcyBpcyBhIG9uZS10aW1lIG9wZXJhdGlvbi4nLFxuICAgIClcbiAgICBjcmVhdGVNYWNyb3NUZW1wbGF0ZSh1c2VyTWFjcm9zUGF0aClcbiAgICByZXR1cm4gKHJlc3VsdCA9IGxvYWRNYWNyb3NGaWxlKHVzZXJNYWNyb3NQYXRoKSlcbiAgfVxufVxuXG5mdW5jdGlvbiBjcmVhdGVNYWNyb3NUZW1wbGF0ZShmaWxlUGF0aDogc3RyaW5nKSB7XG4gIGNvbnN0IHRlbXBsYXRlUGF0aCA9IHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi9hc3NldHMvbWFjcm9zLXRlbXBsYXRlLmNzb24nKVxuICBjb25zdCB0ZW1wbGF0ZUZpbGUgPSBmcy5yZWFkRmlsZVN5bmModGVtcGxhdGVQYXRoLCAndXRmOCcpXG4gIHJldHVybiBmcy53cml0ZUZpbGVTeW5jKGZpbGVQYXRoLCB0ZW1wbGF0ZUZpbGUpXG59XG5cbmZ1bmN0aW9uIGNoZWNrTWFjcm9zKG1hY3Jvc09iamVjdDogb2JqZWN0KSB7XG4gIGZvciAobGV0IG5hbWUgaW4gbWFjcm9zT2JqZWN0KSB7XG4gICAgY29uc3QgdmFsdWUgPSBtYWNyb3NPYmplY3RbbmFtZV1cbiAgICBpZiAoIW5hbWUubWF0Y2gobmFtZVBhdHRlcm4pIHx8ICF2YWx1ZU1hdGNoZXNQYXR0ZXJuKHZhbHVlKSkge1xuICAgICAgZGVsZXRlIG1hY3Jvc09iamVjdFtuYW1lXVxuICAgICAgaWYgKGF0b20ubm90aWZpY2F0aW9ucyAhPSBudWxsKSB7XG4gICAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRFcnJvcihcbiAgICAgICAgICBgRmFpbGVkIHRvIGxvYWQgTGFUZVggbWFjcm8gbmFtZWQgJyR7bmFtZX0nLiBQbGVhc2Ugc2VlIHRoZSBbTGFUZVggZ3VpZGVdKGh0dHBzOi8vZ2l0aHViLmNvbS9HYWxhZGlyaXRoL21hcmtkb3duLXByZXZpZXctcGx1cy9ibG9iL21hc3Rlci9MQVRFWC5tZCNtYWNyby1uYW1lcylgLFxuICAgICAgICAgIHsgZGlzbWlzc2FibGU6IHRydWUgfSxcbiAgICAgICAgKVxuICAgICAgfVxuICAgIH1cbiAgfVxuICByZXR1cm4gbWFjcm9zT2JqZWN0XG59XG5cbmZ1bmN0aW9uIHZhbHVlTWF0Y2hlc1BhdHRlcm4odmFsdWU6IGFueSkge1xuICAvLyBEaWZmZXJlbnQgY2hlY2sgYmFzZWQgb24gd2hldGhlciB2YWx1ZSBpcyBzdHJpbmcgb3IgYXJyYXlcbiAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7XG4gICAgdmFyIG1hY3JvRGVmaW5pdGlvbiA9IHZhbHVlWzBdXG4gICAgdmFyIG51bWJlck9mQXJncyA9IHZhbHVlWzFdXG4gICAgaWYgKHR5cGVvZiBudW1iZXJPZkFyZ3MgPT09ICdudW1iZXInKSB7XG4gICAgICByZXR1cm4gbnVtYmVyT2ZBcmdzICUgMSA9PT0gMCAmJiB0eXBlb2YgbWFjcm9EZWZpbml0aW9uID09PSAnc3RyaW5nJ1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG4gIH0gZWxzZSBpZiAodHlwZW9mIHZhbHVlID09ICdzdHJpbmcnKSB7XG4gICAgICByZXR1cm4gdHJ1ZVxuICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIGZhbHNlXG4gIH1cbn1cblxuLy8gQ29uZmlndXJlIE1hdGhKYXggZW52aXJvbm1lbnQuIFNpbWlsYXIgdG8gdGhlIFRlWC1BTVNfSFRNTCBjb25maWd1cmF0aW9uIHdpdGhcbi8vIGEgZmV3IHVubmVjZXNzYXJ5IGZlYXR1cmVzIHN0cmlwcGVkIGF3YXlcbi8vXG5jb25zdCBjb25maWd1cmVNYXRoSmF4ID0gZnVuY3Rpb24oKSB7XG4gIGxldCB1c2VyTWFjcm9zID0gbG9hZFVzZXJNYWNyb3MoKVxuICBpZiAodXNlck1hY3Jvcykge1xuICAgIHVzZXJNYWNyb3MgPSBjaGVja01hY3Jvcyh1c2VyTWFjcm9zKVxuICB9IGVsc2Uge1xuICAgIHVzZXJNYWNyb3MgPSB7fVxuICB9XG5cbiAgLy9Ob3cgQ29uZmlndXJlIE1hdGhKYXhcbiAgTWF0aEpheCEuSHViLkNvbmZpZyh7XG4gICAgamF4OiBbJ2lucHV0L1RlWCcsICdvdXRwdXQvSFRNTC1DU1MnXSxcbiAgICBleHRlbnNpb25zOiBbXSxcbiAgICBUZVg6IHtcbiAgICAgIGV4dGVuc2lvbnM6IFtcbiAgICAgICAgJ0FNU21hdGguanMnLFxuICAgICAgICAnQU1Tc3ltYm9scy5qcycsXG4gICAgICAgICdub0Vycm9ycy5qcycsXG4gICAgICAgICdub1VuZGVmaW5lZC5qcycsXG4gICAgICBdLFxuICAgICAgTWFjcm9zOiB1c2VyTWFjcm9zLFxuICAgIH0sXG4gICAgJ0hUTUwtQ1NTJzoge1xuICAgICAgYXZhaWxhYmxlRm9udHM6IFtdLFxuICAgICAgd2ViRm9udDogJ1RlWCcsXG4gICAgfSxcbiAgICBtZXNzYWdlU3R5bGU6ICdub25lJyxcbiAgICBzaG93TWF0aE1lbnU6IGZhbHNlLFxuICAgIHNraXBTdGFydHVwVHlwZXNldDogdHJ1ZSxcbiAgfSlcbiAgTWF0aEpheCEuSHViLkNvbmZpZ3VyZWQoKVxuXG4gIC8vIE5vdGlmeSB1c2VyIE1hdGhKYXggaGFzIGxvYWRlZFxuICBpZiAoYXRvbS5pbkRldk1vZGUoKSkge1xuICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRTdWNjZXNzKCdMb2FkZWQgbWF0aHMgcmVuZGVyaW5nIGVuZ2luZSBNYXRoSmF4JylcbiAgfVxufVxuXG4vL1xuLy8gQXR0YWNoIG1haW4gTWF0aEpheCBzY3JpcHQgdG8gdGhlIGRvY3VtZW50XG4vL1xuZnVuY3Rpb24gYXR0YWNoTWF0aEpheCgpIHtcbiAgLy8gTm90aWZ5IHVzZXIgTWF0aEpheCBpcyBsb2FkaW5nXG4gIGlmIChhdG9tLmluRGV2TW9kZSgpKSB7XG4gICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEluZm8oJ0xvYWRpbmcgbWF0aHMgcmVuZGVyaW5nIGVuZ2luZSBNYXRoSmF4JylcbiAgfVxuXG4gIC8vIEF0dGFjaCBNYXRoSmF4IHNjcmlwdFxuICBjb25zdCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKVxuICBzY3JpcHQuc3JjID0gYCR7cmVxdWlyZS5yZXNvbHZlKCdNYXRoSmF4Jyl9P2RlbGF5U3RhcnR1cFVudGlsPWNvbmZpZ3VyZWRgXG4gIHNjcmlwdC50eXBlID0gJ3RleHQvamF2YXNjcmlwdCdcbiAgc2NyaXB0LmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCAoKSA9PiBjb25maWd1cmVNYXRoSmF4KCkpXG4gIGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdoZWFkJylbMF0uYXBwZW5kQ2hpbGQoc2NyaXB0KVxuXG4gIHJldHVybiBzY3JpcHRcbn1cbiJdfQ==