"use strict";
const { $ } = require('atom-space-pen-views');
const path = require("path");
const CSON = require('season');
const fs = require("fs-plus");
const _ = require("lodash");
const namePattern = new RegExp(`\
^[^a-zA-Z\\d\\s]$\
|\
^[a-zA-Z]*$\
`);
const getUserMacrosPath = function () {
    const userMacrosPath = CSON.resolve(path.join(atom.getConfigDirPath(), 'markdown-preview-plus'));
    return userMacrosPath != null
        ? userMacrosPath
        : path.join(atom.getConfigDirPath(), 'markdown-preview-plus.cson');
};
function loadMacrosFile(filePath) {
    if (!CSON.isObjectPath(filePath)) {
        return {};
    }
    return CSON.readFileSync(filePath, function (error, object) {
        if (object == null) {
            object = {};
        }
        if (error != null) {
            console.warn(`Error reading Latex Macros file '${filePath}': ${error.stack != null ? error.stack : error}`);
            atom.notifications.addError(`Failed to load Latex Macros from '${filePath}'`, { detail: error.message, dismissable: true });
        }
        return object;
    });
}
const loadUserMacros = function () {
    let result;
    const userMacrosPath = getUserMacrosPath();
    if (fs.isFileSync(userMacrosPath)) {
        return (result = loadMacrosFile(userMacrosPath));
    }
    else {
        console.log('Creating markdown-preview-plus.cson, this is a one-time operation.');
        createMacrosTemplate(userMacrosPath);
        return (result = loadMacrosFile(userMacrosPath));
    }
};
function createMacrosTemplate(filePath) {
    const templatePath = path.join(__dirname, '../assets/macros-template.cson');
    const templateFile = fs.readFileSync(templatePath, 'utf8');
    fs.writeFileSync(filePath, templateFile);
}
function checkMacros(macrosObject) {
    for (const name in macrosObject) {
        const value = macrosObject[name];
        if (!name.match(namePattern) || !valueMatchesPattern(value)) {
            delete macrosObject[name];
            atom.notifications.addError(`Failed to load LaTeX macro named '${name}'. Please see the [LaTeX guide](https://github.com/Galadirith/markdown-preview-plus/blob/master/LATEX.md#macro-names)`, { dismissable: true });
        }
    }
    return macrosObject;
}
function valueMatchesPattern(value) {
    if (Array.isArray(value)) {
        const macroDefinition = value[0];
        const numberOfArgs = value[1];
        if (typeof numberOfArgs === 'number') {
            return numberOfArgs % 1 === 0 && typeof macroDefinition === 'string';
        }
        else {
            return false;
        }
    }
    else if (typeof value === 'string') {
        return true;
    }
    else {
        return false;
    }
}
const configureMathJax = function () {
    let userMacros = loadUserMacros();
    if (userMacros) {
        userMacros = checkMacros(userMacros);
    }
    else {
        userMacros = {};
    }
    MathJax.Hub.Config({
        jax: ['input/TeX', 'output/HTML-CSS'],
        extensions: [],
        TeX: {
            extensions: [
                'AMSmath.js',
                'AMSsymbols.js',
                'noErrors.js',
                'noUndefined.js',
            ],
            Macros: userMacros,
        },
        'HTML-CSS': {
            availableFonts: [],
            webFont: 'TeX',
        },
        messageStyle: 'none',
        showMathMenu: false,
        skipStartupTypeset: true,
    });
    MathJax.Hub.Configured();
    if (atom.inDevMode()) {
        atom.notifications.addSuccess('Loaded maths rendering engine MathJax');
    }
};
function attachMathJax() {
    if (atom.inDevMode()) {
        atom.notifications.addInfo('Loading maths rendering engine MathJax');
    }
    const script = document.createElement('script');
    script.src = `${require.resolve('MathJax')}?delayStartupUntil=configured`;
    script.type = 'text/javascript';
    script.addEventListener('load', () => {
        configureMathJax();
    });
    document.getElementsByTagName('head')[0].appendChild(script);
    return script;
}
module.exports = {
    loadMathJax(listener) {
        const script = this.attachMathJax();
        if (listener)
            script.addEventListener('load', () => listener());
    },
    attachMathJax: _.once(() => attachMathJax()),
    resetMathJax() {
        $('script[src*="MathJax.js"]').remove();
        window.MathJax = undefined;
        return (this.attachMathJax = _.once(() => attachMathJax()));
    },
    mathProcessor(domElements) {
        if (MathJax) {
            MathJax.Hub.Queue(['Typeset', MathJax.Hub, domElements]);
        }
        else {
            this.loadMathJax(() => {
                MathJax.Hub.Queue(['Typeset', MathJax.Hub, domElements]);
            });
        }
    },
    processHTMLString(html, callback) {
        const element = document.createElement('div');
        element.innerHTML = html;
        const compileProcessedHTMLString = function () {
            const msvgh = document.getElementById('MathJax_SVG_Hidden');
            const svgGlyphs = msvgh && msvgh.parentNode.cloneNode(true);
            if (svgGlyphs != null) {
                element.insertBefore(svgGlyphs, element.firstChild);
            }
            return element.innerHTML;
        };
        const queueProcessHTMLString = () => {
            MathJax.Hub.Queue(['setRenderer', MathJax.Hub, 'SVG'], ['Typeset', MathJax.Hub, element], ['setRenderer', MathJax.Hub, 'HTML-CSS'], [() => callback(compileProcessedHTMLString())]);
        };
        if (window.MathJax) {
            queueProcessHTMLString();
        }
        else {
            this.loadMathJax(queueProcessHTMLString);
        }
    },
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWF0aGpheC1oZWxwZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvbWF0aGpheC1oZWxwZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQWNBLE1BQU0sRUFBRSxDQUFDLEVBQUUsR0FBRyxPQUFPLENBQUMsc0JBQXNCLENBQUMsQ0FBQTtBQUM3Qyw2QkFBNkI7QUFFN0IsTUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFBO0FBQzlCLDhCQUE4QjtBQUM5Qiw0QkFBNEI7QUF5RjVCLE1BQU0sV0FBVyxHQUFHLElBQUksTUFBTSxDQUFDOzs7O0NBSTlCLENBQUMsQ0FBQTtBQUVGLE1BQU0saUJBQWlCLEdBQUc7SUFDeEIsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FDakMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsRUFBRSx1QkFBdUIsQ0FBQyxDQUM1RCxDQUFBO0lBQ0QsTUFBTSxDQUFDLGNBQWMsSUFBSSxJQUFJO1FBQzNCLENBQUMsQ0FBQyxjQUFjO1FBQ2hCLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxFQUFFLDRCQUE0QixDQUFDLENBQUE7QUFDdEUsQ0FBQyxDQUFBO0FBRUQsd0JBQXdCLFFBQWdCO0lBQ3RDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDakMsTUFBTSxDQUFDLEVBQUUsQ0FBQTtJQUNYLENBQUM7SUFDRCxNQUFNLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLEVBQUUsVUFBUyxLQUFhLEVBQUUsTUFBZTtRQUN4RSxFQUFFLENBQUMsQ0FBQyxNQUFNLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQztZQUNuQixNQUFNLEdBQUcsRUFBRSxDQUFBO1FBQ2IsQ0FBQztRQUNELEVBQUUsQ0FBQyxDQUFDLEtBQUss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QUFFLE9BQVEsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLEVBQ3BDLENBQUMsU0FBUyxFQUFFLE9BQVEsQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLEVBQ2xDLENBQUMsYUFBYSxFQUFFLE9BQVEsQ0FBQyxHQUFHLEVBQUUsVUFBVSxDQUFDLEVBQ3pDLENBQUMsR0FBRyxFQUFFLENBQUMsUUFBUSxDQUFDLDBCQUEwQixFQUFFLENBQUMsQ0FBQyxDQUMvQyxDQUFBO1FBQ0gsQ0FBQyxDQUFBO1FBRUQsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7WUFDbkIsc0JBQXNCLEVBQUUsQ0FBQTtRQUMxQixDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDTixJQUFJLENBQUMsV0FBVyxDQUFDLHNCQUFzQixDQUFDLENBQUE7UUFDMUMsQ0FBQztJQUNILENBQUM7Q0FDRixDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIGRlY2FmZmVpbmF0ZSBzdWdnZXN0aW9uczpcbiAqIERTMTAyOiBSZW1vdmUgdW5uZWNlc3NhcnkgY29kZSBjcmVhdGVkIGJlY2F1c2Ugb2YgaW1wbGljaXQgcmV0dXJuc1xuICogRFMyMDc6IENvbnNpZGVyIHNob3J0ZXIgdmFyaWF0aW9ucyBvZiBudWxsIGNoZWNrc1xuICogRnVsbCBkb2NzOiBodHRwczovL2dpdGh1Yi5jb20vZGVjYWZmZWluYXRlL2RlY2FmZmVpbmF0ZS9ibG9iL21hc3Rlci9kb2NzL3N1Z2dlc3Rpb25zLm1kXG4gKi9cbi8vXG4vLyBtYXRoamF4LWhlbHBlclxuLy9cbi8vIFRoaXMgbW9kdWxlIHdpbGwgaGFuZGxlIGxvYWRpbmcgdGhlIE1hdGhKYXggZW52aXJvbm1lbnQgYW5kIHByb3ZpZGUgYSB3cmFwcGVyXG4vLyBmb3IgY2FsbHMgdG8gTWF0aEpheCB0byBwcm9jZXNzIExhVGVYIGVxdWF0aW9ucy5cbi8vXG5cbi8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby12YXItcmVxdWlyZXNcbmNvbnN0IHsgJCB9ID0gcmVxdWlyZSgnYXRvbS1zcGFjZS1wZW4tdmlld3MnKVxuaW1wb3J0IHBhdGggPSByZXF1aXJlKCdwYXRoJylcbi8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby12YXItcmVxdWlyZXNcbmNvbnN0IENTT04gPSByZXF1aXJlKCdzZWFzb24nKVxuaW1wb3J0IGZzID0gcmVxdWlyZSgnZnMtcGx1cycpXG5pbXBvcnQgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpXG5cbmV4cG9ydCA9IHtcbiAgLy9cbiAgLy8gTG9hZCBNYXRoSmF4IGVudmlyb25tZW50XG4gIC8vXG4gIC8vIEBwYXJhbSBsaXN0ZW5lciBtZXRob2QgdG8gY2FsbCB3aGVuIHRoZSBNYXRoSmF4IHNjcmlwdCB3YXMgYmVlblxuICAvLyAgIGxvYWRlZCB0byB0aGUgd2luZG93LiBUaGUgbWV0aG9kIGlzIHBhc3NlZCBubyBhcmd1bWVudHMuXG4gIC8vXG4gIGxvYWRNYXRoSmF4KGxpc3RlbmVyPzogKCkgPT4gYW55KSB7XG4gICAgY29uc3Qgc2NyaXB0ID0gdGhpcy5hdHRhY2hNYXRoSmF4KClcbiAgICBpZiAobGlzdGVuZXIpIHNjcmlwdC5hZGRFdmVudExpc3RlbmVyKCdsb2FkJywgKCkgPT4gbGlzdGVuZXIoKSlcbiAgfSxcblxuICAvL1xuICAvLyBBdHRhY2ggbWFpbiBNYXRoSmF4IHNjcmlwdCB0byB0aGUgZG9jdW1lbnRcbiAgLy9cbiAgYXR0YWNoTWF0aEpheDogXy5vbmNlKCgpID0+IGF0dGFjaE1hdGhKYXgoKSksXG5cbiAgLy9cbiAgLy8gUmVtb3ZlIE1hdGhKYXggZnJvbSB0aGUgZG9jdW1lbnQgYW5kIHJlc2V0IGF0dGFjaCBtZXRob2RcbiAgLy9cbiAgcmVzZXRNYXRoSmF4KCkge1xuICAgIC8vIERldGFjaCBNYXRoSmF4IGZyb20gdGhlIGRvY3VtZW50XG4gICAgJCgnc2NyaXB0W3NyYyo9XCJNYXRoSmF4LmpzXCJdJykucmVtb3ZlKClcbiAgICB3aW5kb3cuTWF0aEpheCA9IHVuZGVmaW5lZFxuXG4gICAgLy8gUmVzZXQgYXR0YWNoIGZvciBhbnkgc3Vic2VxdWVudCBjYWxsc1xuICAgIHJldHVybiAodGhpcy5hdHRhY2hNYXRoSmF4ID0gXy5vbmNlKCgpID0+IGF0dGFjaE1hdGhKYXgoKSkpXG4gIH0sXG5cbiAgLy9cbiAgLy8gUHJvY2VzcyBET00gZWxlbWVudHMgZm9yIExhVGVYIGVxdWF0aW9ucyB3aXRoIE1hdGhKYXhcbiAgLy9cbiAgLy8gQHBhcmFtIGRvbUVsZW1lbnRzIEFuIGFycmF5IG9mIERPTSBlbGVtZW50cyB0byBiZSBwcm9jZXNzZWQgYnkgTWF0aEpheC4gU2VlXG4gIC8vICAgW2VsZW1lbnRdKGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0FQSS9lbGVtZW50KSBmb3JcbiAgLy8gICBkZXRhaWxzIG9uIERPTSBlbGVtZW50cy5cbiAgLy9cbiAgbWF0aFByb2Nlc3Nvcihkb21FbGVtZW50czogTm9kZVtdKSB7XG4gICAgaWYgKE1hdGhKYXgpIHtcbiAgICAgIE1hdGhKYXguSHViLlF1ZXVlKFsnVHlwZXNldCcsIE1hdGhKYXguSHViLCBkb21FbGVtZW50c10pXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMubG9hZE1hdGhKYXgoKCkgPT4ge1xuICAgICAgICBNYXRoSmF4IS5IdWIuUXVldWUoWydUeXBlc2V0JywgTWF0aEpheCEuSHViLCBkb21FbGVtZW50c10pXG4gICAgICB9KVxuICAgIH1cbiAgfSxcblxuICAvL1xuICAvLyBQcm9jZXNzIG1hdGhzIGluIEhUTUwgZnJhZ21lbnQgd2l0aCBNYXRoSmF4XG4gIC8vXG4gIC8vIEBwYXJhbSBodG1sIEEgSFRNTCBmcmFnbWVudCBzdHJpbmdcbiAgLy8gQHBhcmFtIGNhbGxiYWNrIEEgY2FsbGJhY2sgbWV0aG9kIHRoYXQgYWNjZXB0cyBhIHNpbmdsZSBwYXJhbWV0ZXIsIGEgSFRNTFxuICAvLyAgIGZyYWdtZW50IHN0cmluZyB0aGF0IGlzIHRoZSByZXN1bHQgb2YgaHRtbCBwcm9jZXNzZWQgYnkgTWF0aEpheFxuICAvL1xuICBwcm9jZXNzSFRNTFN0cmluZyhodG1sOiBzdHJpbmcsIGNhbGxiYWNrOiAocHJvSFRNTDogc3RyaW5nKSA9PiBhbnkpIHtcbiAgICBjb25zdCBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JylcbiAgICBlbGVtZW50LmlubmVySFRNTCA9IGh0bWxcblxuICAgIGNvbnN0IGNvbXBpbGVQcm9jZXNzZWRIVE1MU3RyaW5nID0gZnVuY3Rpb24oKSB7XG4gICAgICBjb25zdCBtc3ZnaCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdNYXRoSmF4X1NWR19IaWRkZW4nKVxuICAgICAgY29uc3Qgc3ZnR2x5cGhzID0gbXN2Z2ggJiYgbXN2Z2gucGFyZW50Tm9kZSEuY2xvbmVOb2RlKHRydWUpXG4gICAgICBpZiAoc3ZnR2x5cGhzICE9IG51bGwpIHtcbiAgICAgICAgZWxlbWVudC5pbnNlcnRCZWZvcmUoc3ZnR2x5cGhzLCBlbGVtZW50LmZpcnN0Q2hpbGQpXG4gICAgICB9XG4gICAgICByZXR1cm4gZWxlbWVudC5pbm5lckhUTUxcbiAgICB9XG5cbiAgICBjb25zdCBxdWV1ZVByb2Nlc3NIVE1MU3RyaW5nID0gKCkgPT4ge1xuICAgICAgTWF0aEpheCEuSHViLlF1ZXVlKFxuICAgICAgICBbJ3NldFJlbmRlcmVyJywgTWF0aEpheCEuSHViLCAnU1ZHJ10sXG4gICAgICAgIFsnVHlwZXNldCcsIE1hdGhKYXghLkh1YiwgZWxlbWVudF0sXG4gICAgICAgIFsnc2V0UmVuZGVyZXInLCBNYXRoSmF4IS5IdWIsICdIVE1MLUNTUyddLFxuICAgICAgICBbKCkgPT4gY2FsbGJhY2soY29tcGlsZVByb2Nlc3NlZEhUTUxTdHJpbmcoKSldLFxuICAgICAgKVxuICAgIH1cblxuICAgIGlmICh3aW5kb3cuTWF0aEpheCkge1xuICAgICAgcXVldWVQcm9jZXNzSFRNTFN0cmluZygpXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMubG9hZE1hdGhKYXgocXVldWVQcm9jZXNzSFRNTFN0cmluZylcbiAgICB9XG4gIH0sXG59XG5cbi8vXG4vLyBEZWZpbmUgc29tZSBmdW5jdGlvbnMgdG8gaGVscCBnZXQgYSBob2xkIG9mIHRoZSB1c2VyJ3MgTGF0ZXhcbi8vIE1hY3Jvcy5cbi8vXG5jb25zdCBuYW1lUGF0dGVybiA9IG5ldyBSZWdFeHAoYFxcXG5eW15hLXpBLVpcXFxcZFxcXFxzXSRcXFxufFxcXG5eW2EtekEtWl0qJFxcXG5gKSAvLyBsZXR0ZXJzLCBidXQgbm8gbnVtZXJhbHMuXG5cbmNvbnN0IGdldFVzZXJNYWNyb3NQYXRoID0gZnVuY3Rpb24oKSB7XG4gIGNvbnN0IHVzZXJNYWNyb3NQYXRoID0gQ1NPTi5yZXNvbHZlKFxuICAgIHBhdGguam9pbihhdG9tLmdldENvbmZpZ0RpclBhdGgoKSwgJ21hcmtkb3duLXByZXZpZXctcGx1cycpLFxuICApXG4gIHJldHVybiB1c2VyTWFjcm9zUGF0aCAhPSBudWxsXG4gICAgPyB1c2VyTWFjcm9zUGF0aFxuICAgIDogcGF0aC5qb2luKGF0b20uZ2V0Q29uZmlnRGlyUGF0aCgpLCAnbWFya2Rvd24tcHJldmlldy1wbHVzLmNzb24nKVxufVxuXG5mdW5jdGlvbiBsb2FkTWFjcm9zRmlsZShmaWxlUGF0aDogc3RyaW5nKSB7XG4gIGlmICghQ1NPTi5pc09iamVjdFBhdGgoZmlsZVBhdGgpKSB7XG4gICAgcmV0dXJuIHt9XG4gIH1cbiAgcmV0dXJuIENTT04ucmVhZEZpbGVTeW5jKGZpbGVQYXRoLCBmdW5jdGlvbihlcnJvcj86IEVycm9yLCBvYmplY3Q/OiBvYmplY3QpIHtcbiAgICBpZiAob2JqZWN0ID09IG51bGwpIHtcbiAgICAgIG9iamVjdCA9IHt9XG4gICAgfVxuICAgIGlmIChlcnJvciAhPSBudWxsKSB7XG4gICAgICBjb25zb2xlLndhcm4oXG4gICAgICAgIGBFcnJvciByZWFkaW5nIExhdGV4IE1hY3JvcyBmaWxlICcke2ZpbGVQYXRofSc6ICR7XG4gICAgICAgICAgZXJyb3Iuc3RhY2sgIT0gbnVsbCA/IGVycm9yLnN0YWNrIDogZXJyb3JcbiAgICAgICAgfWAsXG4gICAgICApXG4gICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkRXJyb3IoXG4gICAgICAgIGBGYWlsZWQgdG8gbG9hZCBMYXRleCBNYWNyb3MgZnJvbSAnJHtmaWxlUGF0aH0nYCxcbiAgICAgICAgeyBkZXRhaWw6IGVycm9yLm1lc3NhZ2UsIGRpc21pc3NhYmxlOiB0cnVlIH0sXG4gICAgICApXG4gICAgfVxuICAgIHJldHVybiBvYmplY3RcbiAgfSlcbn1cblxuY29uc3QgbG9hZFVzZXJNYWNyb3MgPSBmdW5jdGlvbigpIHtcbiAgbGV0IHJlc3VsdFxuICBjb25zdCB1c2VyTWFjcm9zUGF0aCA9IGdldFVzZXJNYWNyb3NQYXRoKClcbiAgaWYgKGZzLmlzRmlsZVN5bmModXNlck1hY3Jvc1BhdGgpKSB7XG4gICAgcmV0dXJuIChyZXN1bHQgPSBsb2FkTWFjcm9zRmlsZSh1c2VyTWFjcm9zUGF0aCkpXG4gIH0gZWxzZSB7XG4gICAgY29uc29sZS5sb2coXG4gICAgICAnQ3JlYXRpbmcgbWFya2Rvd24tcHJldmlldy1wbHVzLmNzb24sIHRoaXMgaXMgYSBvbmUtdGltZSBvcGVyYXRpb24uJyxcbiAgICApXG4gICAgY3JlYXRlTWFjcm9zVGVtcGxhdGUodXNlck1hY3Jvc1BhdGgpXG4gICAgcmV0dXJuIChyZXN1bHQgPSBsb2FkTWFjcm9zRmlsZSh1c2VyTWFjcm9zUGF0aCkpXG4gIH1cbn1cblxuZnVuY3Rpb24gY3JlYXRlTWFjcm9zVGVtcGxhdGUoZmlsZVBhdGg6IHN0cmluZykge1xuICBjb25zdCB0ZW1wbGF0ZVBhdGggPSBwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vYXNzZXRzL21hY3Jvcy10ZW1wbGF0ZS5jc29uJylcbiAgY29uc3QgdGVtcGxhdGVGaWxlID0gZnMucmVhZEZpbGVTeW5jKHRlbXBsYXRlUGF0aCwgJ3V0ZjgnKVxuICBmcy53cml0ZUZpbGVTeW5jKGZpbGVQYXRoLCB0ZW1wbGF0ZUZpbGUpXG59XG5cbmZ1bmN0aW9uIGNoZWNrTWFjcm9zKG1hY3Jvc09iamVjdDogb2JqZWN0KSB7XG4gIGZvciAoY29uc3QgbmFtZSBpbiBtYWNyb3NPYmplY3QpIHtcbiAgICBjb25zdCB2YWx1ZSA9IG1hY3Jvc09iamVjdFtuYW1lXVxuICAgIGlmICghbmFtZS5tYXRjaChuYW1lUGF0dGVybikgfHwgIXZhbHVlTWF0Y2hlc1BhdHRlcm4odmFsdWUpKSB7XG4gICAgICBkZWxldGUgbWFjcm9zT2JqZWN0W25hbWVdXG4gICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkRXJyb3IoXG4gICAgICAgIGBGYWlsZWQgdG8gbG9hZCBMYVRlWCBtYWNybyBuYW1lZCAnJHtuYW1lfScuIFBsZWFzZSBzZWUgdGhlIFtMYVRlWCBndWlkZV0oaHR0cHM6Ly9naXRodWIuY29tL0dhbGFkaXJpdGgvbWFya2Rvd24tcHJldmlldy1wbHVzL2Jsb2IvbWFzdGVyL0xBVEVYLm1kI21hY3JvLW5hbWVzKWAsXG4gICAgICAgIHsgZGlzbWlzc2FibGU6IHRydWUgfSxcbiAgICAgIClcbiAgICB9XG4gIH1cbiAgcmV0dXJuIG1hY3Jvc09iamVjdFxufVxuXG5mdW5jdGlvbiB2YWx1ZU1hdGNoZXNQYXR0ZXJuKHZhbHVlOiBhbnkpIHtcbiAgLy8gRGlmZmVyZW50IGNoZWNrIGJhc2VkIG9uIHdoZXRoZXIgdmFsdWUgaXMgc3RyaW5nIG9yIGFycmF5XG4gIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkge1xuICAgIGNvbnN0IG1hY3JvRGVmaW5pdGlvbiA9IHZhbHVlWzBdXG4gICAgY29uc3QgbnVtYmVyT2ZBcmdzID0gdmFsdWVbMV1cbiAgICBpZiAodHlwZW9mIG51bWJlck9mQXJncyA9PT0gJ251bWJlcicpIHtcbiAgICAgIHJldHVybiBudW1iZXJPZkFyZ3MgJSAxID09PSAwICYmIHR5cGVvZiBtYWNyb0RlZmluaXRpb24gPT09ICdzdHJpbmcnXG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBmYWxzZVxuICAgIH1cbiAgfSBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSB7XG4gICAgcmV0dXJuIHRydWVcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gZmFsc2VcbiAgfVxufVxuXG4vLyBDb25maWd1cmUgTWF0aEpheCBlbnZpcm9ubWVudC4gU2ltaWxhciB0byB0aGUgVGVYLUFNU19IVE1MIGNvbmZpZ3VyYXRpb24gd2l0aFxuLy8gYSBmZXcgdW5uZWNlc3NhcnkgZmVhdHVyZXMgc3RyaXBwZWQgYXdheVxuLy9cbmNvbnN0IGNvbmZpZ3VyZU1hdGhKYXggPSBmdW5jdGlvbigpIHtcbiAgbGV0IHVzZXJNYWNyb3MgPSBsb2FkVXNlck1hY3JvcygpXG4gIGlmICh1c2VyTWFjcm9zKSB7XG4gICAgdXNlck1hY3JvcyA9IGNoZWNrTWFjcm9zKHVzZXJNYWNyb3MpXG4gIH0gZWxzZSB7XG4gICAgdXNlck1hY3JvcyA9IHt9XG4gIH1cblxuICAvLyBOb3cgQ29uZmlndXJlIE1hdGhKYXhcbiAgTWF0aEpheCEuSHViLkNvbmZpZyh7XG4gICAgamF4OiBbJ2lucHV0L1RlWCcsICdvdXRwdXQvSFRNTC1DU1MnXSxcbiAgICBleHRlbnNpb25zOiBbXSxcbiAgICBUZVg6IHtcbiAgICAgIGV4dGVuc2lvbnM6IFtcbiAgICAgICAgJ0FNU21hdGguanMnLFxuICAgICAgICAnQU1Tc3ltYm9scy5qcycsXG4gICAgICAgICdub0Vycm9ycy5qcycsXG4gICAgICAgICdub1VuZGVmaW5lZC5qcycsXG4gICAgICBdLFxuICAgICAgTWFjcm9zOiB1c2VyTWFjcm9zLFxuICAgIH0sXG4gICAgJ0hUTUwtQ1NTJzoge1xuICAgICAgYXZhaWxhYmxlRm9udHM6IFtdLFxuICAgICAgd2ViRm9udDogJ1RlWCcsXG4gICAgfSxcbiAgICBtZXNzYWdlU3R5bGU6ICdub25lJyxcbiAgICBzaG93TWF0aE1lbnU6IGZhbHNlLFxuICAgIHNraXBTdGFydHVwVHlwZXNldDogdHJ1ZSxcbiAgfSlcbiAgTWF0aEpheCEuSHViLkNvbmZpZ3VyZWQoKVxuXG4gIC8vIE5vdGlmeSB1c2VyIE1hdGhKYXggaGFzIGxvYWRlZFxuICBpZiAoYXRvbS5pbkRldk1vZGUoKSkge1xuICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRTdWNjZXNzKCdMb2FkZWQgbWF0aHMgcmVuZGVyaW5nIGVuZ2luZSBNYXRoSmF4JylcbiAgfVxufVxuXG4vL1xuLy8gQXR0YWNoIG1haW4gTWF0aEpheCBzY3JpcHQgdG8gdGhlIGRvY3VtZW50XG4vL1xuZnVuY3Rpb24gYXR0YWNoTWF0aEpheCgpIHtcbiAgLy8gTm90aWZ5IHVzZXIgTWF0aEpheCBpcyBsb2FkaW5nXG4gIGlmIChhdG9tLmluRGV2TW9kZSgpKSB7XG4gICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEluZm8oJ0xvYWRpbmcgbWF0aHMgcmVuZGVyaW5nIGVuZ2luZSBNYXRoSmF4JylcbiAgfVxuXG4gIC8vIEF0dGFjaCBNYXRoSmF4IHNjcmlwdFxuICBjb25zdCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKVxuICBzY3JpcHQuc3JjID0gYCR7cmVxdWlyZS5yZXNvbHZlKCdNYXRoSmF4Jyl9P2RlbGF5U3RhcnR1cFVudGlsPWNvbmZpZ3VyZWRgXG4gIHNjcmlwdC50eXBlID0gJ3RleHQvamF2YXNjcmlwdCdcbiAgc2NyaXB0LmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCAoKSA9PiB7XG4gICAgY29uZmlndXJlTWF0aEpheCgpXG4gIH0pXG4gIGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdoZWFkJylbMF0uYXBwZW5kQ2hpbGQoc2NyaXB0KVxuXG4gIHJldHVybiBzY3JpcHRcbn1cbiJdfQ==